/******/ (function(modules) { // webpackBootstrap
/******/ 	// The module cache
/******/ 	var installedModules = {};

/******/ 	// The require function
/******/ 	function __webpack_require__(moduleId) {

/******/ 		// Check if module is in cache
/******/ 		if(installedModules[moduleId])
/******/ 			return installedModules[moduleId].exports;

/******/ 		// Create a new module (and put it into the cache)
/******/ 		var module = installedModules[moduleId] = {
/******/ 			i: moduleId,
/******/ 			l: false,
/******/ 			exports: {}
/******/ 		};

/******/ 		// Execute the module function
/******/ 		modules[moduleId].call(module.exports, module, module.exports, __webpack_require__);

/******/ 		// Flag the module as loaded
/******/ 		module.l = true;

/******/ 		// Return the exports of the module
/******/ 		return module.exports;
/******/ 	}


/******/ 	// expose the modules object (__webpack_modules__)
/******/ 	__webpack_require__.m = modules;

/******/ 	// expose the module cache
/******/ 	__webpack_require__.c = installedModules;

/******/ 	// identity function for calling harmony imports with the correct context
/******/ 	__webpack_require__.i = function(value) { return value; };

/******/ 	// define getter function for harmony exports
/******/ 	__webpack_require__.d = function(exports, name, getter) {
/******/ 		if(!__webpack_require__.o(exports, name)) {
/******/ 			Object.defineProperty(exports, name, {
/******/ 				configurable: false,
/******/ 				enumerable: true,
/******/ 				get: getter
/******/ 			});
/******/ 		}
/******/ 	};

/******/ 	// getDefaultExport function for compatibility with non-harmony modules
/******/ 	__webpack_require__.n = function(module) {
/******/ 		var getter = module && module.__esModule ?
/******/ 			function getDefault() { return module['default']; } :
/******/ 			function getModuleExports() { return module; };
/******/ 		__webpack_require__.d(getter, 'a', getter);
/******/ 		return getter;
/******/ 	};

/******/ 	// Object.prototype.hasOwnProperty.call
/******/ 	__webpack_require__.o = function(object, property) { return Object.prototype.hasOwnProperty.call(object, property); };

/******/ 	// __webpack_public_path__
/******/ 	__webpack_require__.p = "./";

/******/ 	// Load entry module and return exports
/******/ 	return __webpack_require__(__webpack_require__.s = 44);
/******/ })
/************************************************************************/
/******/ ([
/* 0 */,
/* 1 */
/***/ (function(module, exports, __webpack_require__) {

var __WEBPACK_AMD_DEFINE_ARRAY__, __WEBPACK_AMD_DEFINE_RESULT__;/*!
 * jQuery JavaScript Library v3.1.1
 * https://jquery.com/
 *
 * Includes Sizzle.js
 * https://sizzlejs.com/
 *
 * Copyright jQuery Foundation and other contributors
 * Released under the MIT license
 * https://jquery.org/license
 *
 * Date: 2016-09-22T22:30Z
 */
( function( global, factory ) {

	"use strict";

	if ( typeof module === "object" && typeof module.exports === "object" ) {

		// For CommonJS and CommonJS-like environments where a proper `window`
		// is present, execute the factory and get jQuery.
		// For environments that do not have a `window` with a `document`
		// (such as Node.js), expose a factory as module.exports.
		// This accentuates the need for the creation of a real `window`.
		// e.g. var jQuery = require("jquery")(window);
		// See ticket #14549 for more info.
		module.exports = global.document ?
			factory( global, true ) :
			function( w ) {
				if ( !w.document ) {
					throw new Error( "jQuery requires a window with a document" );
				}
				return factory( w );
			};
	} else {
		factory( global );
	}

// Pass this if window is not defined yet
} )( typeof window !== "undefined" ? window : this, function( window, noGlobal ) {

// Edge <= 12 - 13+, Firefox <=18 - 45+, IE 10 - 11, Safari 5.1 - 9+, iOS 6 - 9.1
// throw exceptions when non-strict code (e.g., ASP.NET 4.5) accesses strict mode
// arguments.callee.caller (trac-13335). But as of jQuery 3.0 (2016), strict mode should be common
// enough that all such attempts are guarded in a try block.
"use strict";

var arr = [];

var document = window.document;

var getProto = Object.getPrototypeOf;

var slice = arr.slice;

var concat = arr.concat;

var push = arr.push;

var indexOf = arr.indexOf;

var class2type = {};

var toString = class2type.toString;

var hasOwn = class2type.hasOwnProperty;

var fnToString = hasOwn.toString;

var ObjectFunctionString = fnToString.call( Object );

var support = {};



	function DOMEval( code, doc ) {
		doc = doc || document;

		var script = doc.createElement( "script" );

		script.text = code;
		doc.head.appendChild( script ).parentNode.removeChild( script );
	}
/* global Symbol */
// Defining this global in .eslintrc.json would create a danger of using the global
// unguarded in another place, it seems safer to define global only for this module



var
	version = "3.1.1",

	// Define a local copy of jQuery
	jQuery = function( selector, context ) {

		// The jQuery object is actually just the init constructor 'enhanced'
		// Need init if jQuery is called (just allow error to be thrown if not included)
		return new jQuery.fn.init( selector, context );
	},

	// Support: Android <=4.0 only
	// Make sure we trim BOM and NBSP
	rtrim = /^[\s\uFEFF\xA0]+|[\s\uFEFF\xA0]+$/g,

	// Matches dashed string for camelizing
	rmsPrefix = /^-ms-/,
	rdashAlpha = /-([a-z])/g,

	// Used by jQuery.camelCase as callback to replace()
	fcamelCase = function( all, letter ) {
		return letter.toUpperCase();
	};

jQuery.fn = jQuery.prototype = {

	// The current version of jQuery being used
	jquery: version,

	constructor: jQuery,

	// The default length of a jQuery object is 0
	length: 0,

	toArray: function() {
		return slice.call( this );
	},

	// Get the Nth element in the matched element set OR
	// Get the whole matched element set as a clean array
	get: function( num ) {

		// Return all the elements in a clean array
		if ( num == null ) {
			return slice.call( this );
		}

		// Return just the one element from the set
		return num < 0 ? this[ num + this.length ] : this[ num ];
	},

	// Take an array of elements and push it onto the stack
	// (returning the new matched element set)
	pushStack: function( elems ) {

		// Build a new jQuery matched element set
		var ret = jQuery.merge( this.constructor(), elems );

		// Add the old object onto the stack (as a reference)
		ret.prevObject = this;

		// Return the newly-formed element set
		return ret;
	},

	// Execute a callback for every element in the matched set.
	each: function( callback ) {
		return jQuery.each( this, callback );
	},

	map: function( callback ) {
		return this.pushStack( jQuery.map( this, function( elem, i ) {
			return callback.call( elem, i, elem );
		} ) );
	},

	slice: function() {
		return this.pushStack( slice.apply( this, arguments ) );
	},

	first: function() {
		return this.eq( 0 );
	},

	last: function() {
		return this.eq( -1 );
	},

	eq: function( i ) {
		var len = this.length,
			j = +i + ( i < 0 ? len : 0 );
		return this.pushStack( j >= 0 && j < len ? [ this[ j ] ] : [] );
	},

	end: function() {
		return this.prevObject || this.constructor();
	},

	// For internal use only.
	// Behaves like an Array's method, not like a jQuery method.
	push: push,
	sort: arr.sort,
	splice: arr.splice
};

jQuery.extend = jQuery.fn.extend = function() {
	var options, name, src, copy, copyIsArray, clone,
		target = arguments[ 0 ] || {},
		i = 1,
		length = arguments.length,
		deep = false;

	// Handle a deep copy situation
	if ( typeof target === "boolean" ) {
		deep = target;

		// Skip the boolean and the target
		target = arguments[ i ] || {};
		i++;
	}

	// Handle case when target is a string or something (possible in deep copy)
	if ( typeof target !== "object" && !jQuery.isFunction( target ) ) {
		target = {};
	}

	// Extend jQuery itself if only one argument is passed
	if ( i === length ) {
		target = this;
		i--;
	}

	for ( ; i < length; i++ ) {

		// Only deal with non-null/undefined values
		if ( ( options = arguments[ i ] ) != null ) {

			// Extend the base object
			for ( name in options ) {
				src = target[ name ];
				copy = options[ name ];

				// Prevent never-ending loop
				if ( target === copy ) {
					continue;
				}

				// Recurse if we're merging plain objects or arrays
				if ( deep && copy && ( jQuery.isPlainObject( copy ) ||
					( copyIsArray = jQuery.isArray( copy ) ) ) ) {

					if ( copyIsArray ) {
						copyIsArray = false;
						clone = src && jQuery.isArray( src ) ? src : [];

					} else {
						clone = src && jQuery.isPlainObject( src ) ? src : {};
					}

					// Never move original objects, clone them
					target[ name ] = jQuery.extend( deep, clone, copy );

				// Don't bring in undefined values
				} else if ( copy !== undefined ) {
					target[ name ] = copy;
				}
			}
		}
	}

	// Return the modified object
	return target;
};

jQuery.extend( {

	// Unique for each copy of jQuery on the page
	expando: "jQuery" + ( version + Math.random() ).replace( /\D/g, "" ),

	// Assume jQuery is ready without the ready module
	isReady: true,

	error: function( msg ) {
		throw new Error( msg );
	},

	noop: function() {},

	isFunction: function( obj ) {
		return jQuery.type( obj ) === "function";
	},

	isArray: Array.isArray,

	isWindow: function( obj ) {
		return obj != null && obj === obj.window;
	},

	isNumeric: function( obj ) {

		// As of jQuery 3.0, isNumeric is limited to
		// strings and numbers (primitives or objects)
		// that can be coerced to finite numbers (gh-2662)
		var type = jQuery.type( obj );
		return ( type === "number" || type === "string" ) &&

			// parseFloat NaNs numeric-cast false positives ("")
			// ...but misinterprets leading-number strings, particularly hex literals ("0x...")
			// subtraction forces infinities to NaN
			!isNaN( obj - parseFloat( obj ) );
	},

	isPlainObject: function( obj ) {
		var proto, Ctor;

		// Detect obvious negatives
		// Use toString instead of jQuery.type to catch host objects
		if ( !obj || toString.call( obj ) !== "[object Object]" ) {
			return false;
		}

		proto = getProto( obj );

		// Objects with no prototype (e.g., `Object.create( null )`) are plain
		if ( !proto ) {
			return true;
		}

		// Objects with prototype are plain iff they were constructed by a global Object function
		Ctor = hasOwn.call( proto, "constructor" ) && proto.constructor;
		return typeof Ctor === "function" && fnToString.call( Ctor ) === ObjectFunctionString;
	},

	isEmptyObject: function( obj ) {

		/* eslint-disable no-unused-vars */
		// See https://github.com/eslint/eslint/issues/6125
		var name;

		for ( name in obj ) {
			return false;
		}
		return true;
	},

	type: function( obj ) {
		if ( obj == null ) {
			return obj + "";
		}

		// Support: Android <=2.3 only (functionish RegExp)
		return typeof obj === "object" || typeof obj === "function" ?
			class2type[ toString.call( obj ) ] || "object" :
			typeof obj;
	},

	// Evaluates a script in a global context
	globalEval: function( code ) {
		DOMEval( code );
	},

	// Convert dashed to camelCase; used by the css and data modules
	// Support: IE <=9 - 11, Edge 12 - 13
	// Microsoft forgot to hump their vendor prefix (#9572)
	camelCase: function( string ) {
		return string.replace( rmsPrefix, "ms-" ).replace( rdashAlpha, fcamelCase );
	},

	nodeName: function( elem, name ) {
		return elem.nodeName && elem.nodeName.toLowerCase() === name.toLowerCase();
	},

	each: function( obj, callback ) {
		var length, i = 0;

		if ( isArrayLike( obj ) ) {
			length = obj.length;
			for ( ; i < length; i++ ) {
				if ( callback.call( obj[ i ], i, obj[ i ] ) === false ) {
					break;
				}
			}
		} else {
			for ( i in obj ) {
				if ( callback.call( obj[ i ], i, obj[ i ] ) === false ) {
					break;
				}
			}
		}

		return obj;
	},

	// Support: Android <=4.0 only
	trim: function( text ) {
		return text == null ?
			"" :
			( text + "" ).replace( rtrim, "" );
	},

	// results is for internal usage only
	makeArray: function( arr, results ) {
		var ret = results || [];

		if ( arr != null ) {
			if ( isArrayLike( Object( arr ) ) ) {
				jQuery.merge( ret,
					typeof arr === "string" ?
					[ arr ] : arr
				);
			} else {
				push.call( ret, arr );
			}
		}

		return ret;
	},

	inArray: function( elem, arr, i ) {
		return arr == null ? -1 : indexOf.call( arr, elem, i );
	},

	// Support: Android <=4.0 only, PhantomJS 1 only
	// push.apply(_, arraylike) throws on ancient WebKit
	merge: function( first, second ) {
		var len = +second.length,
			j = 0,
			i = first.length;

		for ( ; j < len; j++ ) {
			first[ i++ ] = second[ j ];
		}

		first.length = i;

		return first;
	},

	grep: function( elems, callback, invert ) {
		var callbackInverse,
			matches = [],
			i = 0,
			length = elems.length,
			callbackExpect = !invert;

		// Go through the array, only saving the items
		// that pass the validator function
		for ( ; i < length; i++ ) {
			callbackInverse = !callback( elems[ i ], i );
			if ( callbackInverse !== callbackExpect ) {
				matches.push( elems[ i ] );
			}
		}

		return matches;
	},

	// arg is for internal usage only
	map: function( elems, callback, arg ) {
		var length, value,
			i = 0,
			ret = [];

		// Go through the array, translating each of the items to their new values
		if ( isArrayLike( elems ) ) {
			length = elems.length;
			for ( ; i < length; i++ ) {
				value = callback( elems[ i ], i, arg );

				if ( value != null ) {
					ret.push( value );
				}
			}

		// Go through every key on the object,
		} else {
			for ( i in elems ) {
				value = callback( elems[ i ], i, arg );

				if ( value != null ) {
					ret.push( value );
				}
			}
		}

		// Flatten any nested arrays
		return concat.apply( [], ret );
	},

	// A global GUID counter for objects
	guid: 1,

	// Bind a function to a context, optionally partially applying any
	// arguments.
	proxy: function( fn, context ) {
		var tmp, args, proxy;

		if ( typeof context === "string" ) {
			tmp = fn[ context ];
			context = fn;
			fn = tmp;
		}

		// Quick check to determine if target is callable, in the spec
		// this throws a TypeError, but we will just return undefined.
		if ( !jQuery.isFunction( fn ) ) {
			return undefined;
		}

		// Simulated bind
		args = slice.call( arguments, 2 );
		proxy = function() {
			return fn.apply( context || this, args.concat( slice.call( arguments ) ) );
		};

		// Set the guid of unique handler to the same of original handler, so it can be removed
		proxy.guid = fn.guid = fn.guid || jQuery.guid++;

		return proxy;
	},

	now: Date.now,

	// jQuery.support is not used in Core but other projects attach their
	// properties to it so it needs to exist.
	support: support
} );

if ( typeof Symbol === "function" ) {
	jQuery.fn[ Symbol.iterator ] = arr[ Symbol.iterator ];
}

// Populate the class2type map
jQuery.each( "Boolean Number String Function Array Date RegExp Object Error Symbol".split( " " ),
function( i, name ) {
	class2type[ "[object " + name + "]" ] = name.toLowerCase();
} );

function isArrayLike( obj ) {

	// Support: real iOS 8.2 only (not reproducible in simulator)
	// `in` check used to prevent JIT error (gh-2145)
	// hasOwn isn't used here due to false negatives
	// regarding Nodelist length in IE
	var length = !!obj && "length" in obj && obj.length,
		type = jQuery.type( obj );

	if ( type === "function" || jQuery.isWindow( obj ) ) {
		return false;
	}

	return type === "array" || length === 0 ||
		typeof length === "number" && length > 0 && ( length - 1 ) in obj;
}
var Sizzle =
/*!
 * Sizzle CSS Selector Engine v2.3.3
 * https://sizzlejs.com/
 *
 * Copyright jQuery Foundation and other contributors
 * Released under the MIT license
 * http://jquery.org/license
 *
 * Date: 2016-08-08
 */
(function( window ) {

var i,
	support,
	Expr,
	getText,
	isXML,
	tokenize,
	compile,
	select,
	outermostContext,
	sortInput,
	hasDuplicate,

	// Local document vars
	setDocument,
	document,
	docElem,
	documentIsHTML,
	rbuggyQSA,
	rbuggyMatches,
	matches,
	contains,

	// Instance-specific data
	expando = "sizzle" + 1 * new Date(),
	preferredDoc = window.document,
	dirruns = 0,
	done = 0,
	classCache = createCache(),
	tokenCache = createCache(),
	compilerCache = createCache(),
	sortOrder = function( a, b ) {
		if ( a === b ) {
			hasDuplicate = true;
		}
		return 0;
	},

	// Instance methods
	hasOwn = ({}).hasOwnProperty,
	arr = [],
	pop = arr.pop,
	push_native = arr.push,
	push = arr.push,
	slice = arr.slice,
	// Use a stripped-down indexOf as it's faster than native
	// https://jsperf.com/thor-indexof-vs-for/5
	indexOf = function( list, elem ) {
		var i = 0,
			len = list.length;
		for ( ; i < len; i++ ) {
			if ( list[i] === elem ) {
				return i;
			}
		}
		return -1;
	},

	booleans = "checked|selected|async|autofocus|autoplay|controls|defer|disabled|hidden|ismap|loop|multiple|open|readonly|required|scoped",

	// Regular expressions

	// http://www.w3.org/TR/css3-selectors/#whitespace
	whitespace = "[\\x20\\t\\r\\n\\f]",

	// http://www.w3.org/TR/CSS21/syndata.html#value-def-identifier
	identifier = "(?:\\\\.|[\\w-]|[^\0-\\xa0])+",

	// Attribute selectors: http://www.w3.org/TR/selectors/#attribute-selectors
	attributes = "\\[" + whitespace + "*(" + identifier + ")(?:" + whitespace +
		// Operator (capture 2)
		"*([*^$|!~]?=)" + whitespace +
		// "Attribute values must be CSS identifiers [capture 5] or strings [capture 3 or capture 4]"
		"*(?:'((?:\\\\.|[^\\\\'])*)'|\"((?:\\\\.|[^\\\\\"])*)\"|(" + identifier + "))|)" + whitespace +
		"*\\]",

	pseudos = ":(" + identifier + ")(?:\\((" +
		// To reduce the number of selectors needing tokenize in the preFilter, prefer arguments:
		// 1. quoted (capture 3; capture 4 or capture 5)
		"('((?:\\\\.|[^\\\\'])*)'|\"((?:\\\\.|[^\\\\\"])*)\")|" +
		// 2. simple (capture 6)
		"((?:\\\\.|[^\\\\()[\\]]|" + attributes + ")*)|" +
		// 3. anything else (capture 2)
		".*" +
		")\\)|)",

	// Leading and non-escaped trailing whitespace, capturing some non-whitespace characters preceding the latter
	rwhitespace = new RegExp( whitespace + "+", "g" ),
	rtrim = new RegExp( "^" + whitespace + "+|((?:^|[^\\\\])(?:\\\\.)*)" + whitespace + "+$", "g" ),

	rcomma = new RegExp( "^" + whitespace + "*," + whitespace + "*" ),
	rcombinators = new RegExp( "^" + whitespace + "*([>+~]|" + whitespace + ")" + whitespace + "*" ),

	rattributeQuotes = new RegExp( "=" + whitespace + "*([^\\]'\"]*?)" + whitespace + "*\\]", "g" ),

	rpseudo = new RegExp( pseudos ),
	ridentifier = new RegExp( "^" + identifier + "$" ),

	matchExpr = {
		"ID": new RegExp( "^#(" + identifier + ")" ),
		"CLASS": new RegExp( "^\\.(" + identifier + ")" ),
		"TAG": new RegExp( "^(" + identifier + "|[*])" ),
		"ATTR": new RegExp( "^" + attributes ),
		"PSEUDO": new RegExp( "^" + pseudos ),
		"CHILD": new RegExp( "^:(only|first|last|nth|nth-last)-(child|of-type)(?:\\(" + whitespace +
			"*(even|odd|(([+-]|)(\\d*)n|)" + whitespace + "*(?:([+-]|)" + whitespace +
			"*(\\d+)|))" + whitespace + "*\\)|)", "i" ),
		"bool": new RegExp( "^(?:" + booleans + ")$", "i" ),
		// For use in libraries implementing .is()
		// We use this for POS matching in `select`
		"needsContext": new RegExp( "^" + whitespace + "*[>+~]|:(even|odd|eq|gt|lt|nth|first|last)(?:\\(" +
			whitespace + "*((?:-\\d)?\\d*)" + whitespace + "*\\)|)(?=[^-]|$)", "i" )
	},

	rinputs = /^(?:input|select|textarea|button)$/i,
	rheader = /^h\d$/i,

	rnative = /^[^{]+\{\s*\[native \w/,

	// Easily-parseable/retrievable ID or TAG or CLASS selectors
	rquickExpr = /^(?:#([\w-]+)|(\w+)|\.([\w-]+))$/,

	rsibling = /[+~]/,

	// CSS escapes
	// http://www.w3.org/TR/CSS21/syndata.html#escaped-characters
	runescape = new RegExp( "\\\\([\\da-f]{1,6}" + whitespace + "?|(" + whitespace + ")|.)", "ig" ),
	funescape = function( _, escaped, escapedWhitespace ) {
		var high = "0x" + escaped - 0x10000;
		// NaN means non-codepoint
		// Support: Firefox<24
		// Workaround erroneous numeric interpretation of +"0x"
		return high !== high || escapedWhitespace ?
			escaped :
			high < 0 ?
				// BMP codepoint
				String.fromCharCode( high + 0x10000 ) :
				// Supplemental Plane codepoint (surrogate pair)
				String.fromCharCode( high >> 10 | 0xD800, high & 0x3FF | 0xDC00 );
	},

	// CSS string/identifier serialization
	// https://drafts.csswg.org/cssom/#common-serializing-idioms
	rcssescape = /([\0-\x1f\x7f]|^-?\d)|^-$|[^\0-\x1f\x7f-\uFFFF\w-]/g,
	fcssescape = function( ch, asCodePoint ) {
		if ( asCodePoint ) {

			// U+0000 NULL becomes U+FFFD REPLACEMENT CHARACTER
			if ( ch === "\0" ) {
				return "\uFFFD";
			}

			// Control characters and (dependent upon position) numbers get escaped as code points
			return ch.slice( 0, -1 ) + "\\" + ch.charCodeAt( ch.length - 1 ).toString( 16 ) + " ";
		}

		// Other potentially-special ASCII characters get backslash-escaped
		return "\\" + ch;
	},

	// Used for iframes
	// See setDocument()
	// Removing the function wrapper causes a "Permission Denied"
	// error in IE
	unloadHandler = function() {
		setDocument();
	},

	disabledAncestor = addCombinator(
		function( elem ) {
			return elem.disabled === true && ("form" in elem || "label" in elem);
		},
		{ dir: "parentNode", next: "legend" }
	);

// Optimize for push.apply( _, NodeList )
try {
	push.apply(
		(arr = slice.call( preferredDoc.childNodes )),
		preferredDoc.childNodes
	);
	// Support: Android<4.0
	// Detect silently failing push.apply
	arr[ preferredDoc.childNodes.length ].nodeType;
} catch ( e ) {
	push = { apply: arr.length ?

		// Leverage slice if possible
		function( target, els ) {
			push_native.apply( target, slice.call(els) );
		} :

		// Support: IE<9
		// Otherwise append directly
		function( target, els ) {
			var j = target.length,
				i = 0;
			// Can't trust NodeList.length
			while ( (target[j++] = els[i++]) ) {}
			target.length = j - 1;
		}
	};
}

function Sizzle( selector, context, results, seed ) {
	var m, i, elem, nid, match, groups, newSelector,
		newContext = context && context.ownerDocument,

		// nodeType defaults to 9, since context defaults to document
		nodeType = context ? context.nodeType : 9;

	results = results || [];

	// Return early from calls with invalid selector or context
	if ( typeof selector !== "string" || !selector ||
		nodeType !== 1 && nodeType !== 9 && nodeType !== 11 ) {

		return results;
	}

	// Try to shortcut find operations (as opposed to filters) in HTML documents
	if ( !seed ) {

		if ( ( context ? context.ownerDocument || context : preferredDoc ) !== document ) {
			setDocument( context );
		}
		context = context || document;

		if ( documentIsHTML ) {

			// If the selector is sufficiently simple, try using a "get*By*" DOM method
			// (excepting DocumentFragment context, where the methods don't exist)
			if ( nodeType !== 11 && (match = rquickExpr.exec( selector )) ) {

				// ID selector
				if ( (m = match[1]) ) {

					// Document context
					if ( nodeType === 9 ) {
						if ( (elem = context.getElementById( m )) ) {

							// Support: IE, Opera, Webkit
							// TODO: identify versions
							// getElementById can match elements by name instead of ID
							if ( elem.id === m ) {
								results.push( elem );
								return results;
							}
						} else {
							return results;
						}

					// Element context
					} else {

						// Support: IE, Opera, Webkit
						// TODO: identify versions
						// getElementById can match elements by name instead of ID
						if ( newContext && (elem = newContext.getElementById( m )) &&
							contains( context, elem ) &&
							elem.id === m ) {

							results.push( elem );
							return results;
						}
					}

				// Type selector
				} else if ( match[2] ) {
					push.apply( results, context.getElementsByTagName( selector ) );
					return results;

				// Class selector
				} else if ( (m = match[3]) && support.getElementsByClassName &&
					context.getElementsByClassName ) {

					push.apply( results, context.getElementsByClassName( m ) );
					return results;
				}
			}

			// Take advantage of querySelectorAll
			if ( support.qsa &&
				!compilerCache[ selector + " " ] &&
				(!rbuggyQSA || !rbuggyQSA.test( selector )) ) {

				if ( nodeType !== 1 ) {
					newContext = context;
					newSelector = selector;

				// qSA looks outside Element context, which is not what we want
				// Thanks to Andrew Dupont for this workaround technique
				// Support: IE <=8
				// Exclude object elements
				} else if ( context.nodeName.toLowerCase() !== "object" ) {

					// Capture the context ID, setting it first if necessary
					if ( (nid = context.getAttribute( "id" )) ) {
						nid = nid.replace( rcssescape, fcssescape );
					} else {
						context.setAttribute( "id", (nid = expando) );
					}

					// Prefix every selector in the list
					groups = tokenize( selector );
					i = groups.length;
					while ( i-- ) {
						groups[i] = "#" + nid + " " + toSelector( groups[i] );
					}
					newSelector = groups.join( "," );

					// Expand context for sibling selectors
					newContext = rsibling.test( selector ) && testContext( context.parentNode ) ||
						context;
				}

				if ( newSelector ) {
					try {
						push.apply( results,
							newContext.querySelectorAll( newSelector )
						);
						return results;
					} catch ( qsaError ) {
					} finally {
						if ( nid === expando ) {
							context.removeAttribute( "id" );
						}
					}
				}
			}
		}
	}

	// All others
	return select( selector.replace( rtrim, "$1" ), context, results, seed );
}

/**
 * Create key-value caches of limited size
 * @returns {function(string, object)} Returns the Object data after storing it on itself with
 *	property name the (space-suffixed) string and (if the cache is larger than Expr.cacheLength)
 *	deleting the oldest entry
 */
function createCache() {
	var keys = [];

	function cache( key, value ) {
		// Use (key + " ") to avoid collision with native prototype properties (see Issue #157)
		if ( keys.push( key + " " ) > Expr.cacheLength ) {
			// Only keep the most recent entries
			delete cache[ keys.shift() ];
		}
		return (cache[ key + " " ] = value);
	}
	return cache;
}

/**
 * Mark a function for special use by Sizzle
 * @param {Function} fn The function to mark
 */
function markFunction( fn ) {
	fn[ expando ] = true;
	return fn;
}

/**
 * Support testing using an element
 * @param {Function} fn Passed the created element and returns a boolean result
 */
function assert( fn ) {
	var el = document.createElement("fieldset");

	try {
		return !!fn( el );
	} catch (e) {
		return false;
	} finally {
		// Remove from its parent by default
		if ( el.parentNode ) {
			el.parentNode.removeChild( el );
		}
		// release memory in IE
		el = null;
	}
}

/**
 * Adds the same handler for all of the specified attrs
 * @param {String} attrs Pipe-separated list of attributes
 * @param {Function} handler The method that will be applied
 */
function addHandle( attrs, handler ) {
	var arr = attrs.split("|"),
		i = arr.length;

	while ( i-- ) {
		Expr.attrHandle[ arr[i] ] = handler;
	}
}

/**
 * Checks document order of two siblings
 * @param {Element} a
 * @param {Element} b
 * @returns {Number} Returns less than 0 if a precedes b, greater than 0 if a follows b
 */
function siblingCheck( a, b ) {
	var cur = b && a,
		diff = cur && a.nodeType === 1 && b.nodeType === 1 &&
			a.sourceIndex - b.sourceIndex;

	// Use IE sourceIndex if available on both nodes
	if ( diff ) {
		return diff;
	}

	// Check if b follows a
	if ( cur ) {
		while ( (cur = cur.nextSibling) ) {
			if ( cur === b ) {
				return -1;
			}
		}
	}

	return a ? 1 : -1;
}

/**
 * Returns a function to use in pseudos for input types
 * @param {String} type
 */
function createInputPseudo( type ) {
	return function( elem ) {
		var name = elem.nodeName.toLowerCase();
		return name === "input" && elem.type === type;
	};
}

/**
 * Returns a function to use in pseudos for buttons
 * @param {String} type
 */
function createButtonPseudo( type ) {
	return function( elem ) {
		var name = elem.nodeName.toLowerCase();
		return (name === "input" || name === "button") && elem.type === type;
	};
}

/**
 * Returns a function to use in pseudos for :enabled/:disabled
 * @param {Boolean} disabled true for :disabled; false for :enabled
 */
function createDisabledPseudo( disabled ) {

	// Known :disabled false positives: fieldset[disabled] > legend:nth-of-type(n+2) :can-disable
	return function( elem ) {

		// Only certain elements can match :enabled or :disabled
		// https://html.spec.whatwg.org/multipage/scripting.html#selector-enabled
		// https://html.spec.whatwg.org/multipage/scripting.html#selector-disabled
		if ( "form" in elem ) {

			// Check for inherited disabledness on relevant non-disabled elements:
			// * listed form-associated elements in a disabled fieldset
			//   https://html.spec.whatwg.org/multipage/forms.html#category-listed
			//   https://html.spec.whatwg.org/multipage/forms.html#concept-fe-disabled
			// * option elements in a disabled optgroup
			//   https://html.spec.whatwg.org/multipage/forms.html#concept-option-disabled
			// All such elements have a "form" property.
			if ( elem.parentNode && elem.disabled === false ) {

				// Option elements defer to a parent optgroup if present
				if ( "label" in elem ) {
					if ( "label" in elem.parentNode ) {
						return elem.parentNode.disabled === disabled;
					} else {
						return elem.disabled === disabled;
					}
				}

				// Support: IE 6 - 11
				// Use the isDisabled shortcut property to check for disabled fieldset ancestors
				return elem.isDisabled === disabled ||

					// Where there is no isDisabled, check manually
					/* jshint -W018 */
					elem.isDisabled !== !disabled &&
						disabledAncestor( elem ) === disabled;
			}

			return elem.disabled === disabled;

		// Try to winnow out elements that can't be disabled before trusting the disabled property.
		// Some victims get caught in our net (label, legend, menu, track), but it shouldn't
		// even exist on them, let alone have a boolean value.
		} else if ( "label" in elem ) {
			return elem.disabled === disabled;
		}

		// Remaining elements are neither :enabled nor :disabled
		return false;
	};
}

/**
 * Returns a function to use in pseudos for positionals
 * @param {Function} fn
 */
function createPositionalPseudo( fn ) {
	return markFunction(function( argument ) {
		argument = +argument;
		return markFunction(function( seed, matches ) {
			var j,
				matchIndexes = fn( [], seed.length, argument ),
				i = matchIndexes.length;

			// Match elements found at the specified indexes
			while ( i-- ) {
				if ( seed[ (j = matchIndexes[i]) ] ) {
					seed[j] = !(matches[j] = seed[j]);
				}
			}
		});
	});
}

/**
 * Checks a node for validity as a Sizzle context
 * @param {Element|Object=} context
 * @returns {Element|Object|Boolean} The input node if acceptable, otherwise a falsy value
 */
function testContext( context ) {
	return context && typeof context.getElementsByTagName !== "undefined" && context;
}

// Expose support vars for convenience
support = Sizzle.support = {};

/**
 * Detects XML nodes
 * @param {Element|Object} elem An element or a document
 * @returns {Boolean} True iff elem is a non-HTML XML node
 */
isXML = Sizzle.isXML = function( elem ) {
	// documentElement is verified for cases where it doesn't yet exist
	// (such as loading iframes in IE - #4833)
	var documentElement = elem && (elem.ownerDocument || elem).documentElement;
	return documentElement ? documentElement.nodeName !== "HTML" : false;
};

/**
 * Sets document-related variables once based on the current document
 * @param {Element|Object} [doc] An element or document object to use to set the document
 * @returns {Object} Returns the current document
 */
setDocument = Sizzle.setDocument = function( node ) {
	var hasCompare, subWindow,
		doc = node ? node.ownerDocument || node : preferredDoc;

	// Return early if doc is invalid or already selected
	if ( doc === document || doc.nodeType !== 9 || !doc.documentElement ) {
		return document;
	}

	// Update global variables
	document = doc;
	docElem = document.documentElement;
	documentIsHTML = !isXML( document );

	// Support: IE 9-11, Edge
	// Accessing iframe documents after unload throws "permission denied" errors (jQuery #13936)
	if ( preferredDoc !== document &&
		(subWindow = document.defaultView) && subWindow.top !== subWindow ) {

		// Support: IE 11, Edge
		if ( subWindow.addEventListener ) {
			subWindow.addEventListener( "unload", unloadHandler, false );

		// Support: IE 9 - 10 only
		} else if ( subWindow.attachEvent ) {
			subWindow.attachEvent( "onunload", unloadHandler );
		}
	}

	/* Attributes
	---------------------------------------------------------------------- */

	// Support: IE<8
	// Verify that getAttribute really returns attributes and not properties
	// (excepting IE8 booleans)
	support.attributes = assert(function( el ) {
		el.className = "i";
		return !el.getAttribute("className");
	});

	/* getElement(s)By*
	---------------------------------------------------------------------- */

	// Check if getElementsByTagName("*") returns only elements
	support.getElementsByTagName = assert(function( el ) {
		el.appendChild( document.createComment("") );
		return !el.getElementsByTagName("*").length;
	});

	// Support: IE<9
	support.getElementsByClassName = rnative.test( document.getElementsByClassName );

	// Support: IE<10
	// Check if getElementById returns elements by name
	// The broken getElementById methods don't pick up programmatically-set names,
	// so use a roundabout getElementsByName test
	support.getById = assert(function( el ) {
		docElem.appendChild( el ).id = expando;
		return !document.getElementsByName || !document.getElementsByName( expando ).length;
	});

	// ID filter and find
	if ( support.getById ) {
		Expr.filter["ID"] = function( id ) {
			var attrId = id.replace( runescape, funescape );
			return function( elem ) {
				return elem.getAttribute("id") === attrId;
			};
		};
		Expr.find["ID"] = function( id, context ) {
			if ( typeof context.getElementById !== "undefined" && documentIsHTML ) {
				var elem = context.getElementById( id );
				return elem ? [ elem ] : [];
			}
		};
	} else {
		Expr.filter["ID"] =  function( id ) {
			var attrId = id.replace( runescape, funescape );
			return function( elem ) {
				var node = typeof elem.getAttributeNode !== "undefined" &&
					elem.getAttributeNode("id");
				return node && node.value === attrId;
			};
		};

		// Support: IE 6 - 7 only
		// getElementById is not reliable as a find shortcut
		Expr.find["ID"] = function( id, context ) {
			if ( typeof context.getElementById !== "undefined" && documentIsHTML ) {
				var node, i, elems,
					elem = context.getElementById( id );

				if ( elem ) {

					// Verify the id attribute
					node = elem.getAttributeNode("id");
					if ( node && node.value === id ) {
						return [ elem ];
					}

					// Fall back on getElementsByName
					elems = context.getElementsByName( id );
					i = 0;
					while ( (elem = elems[i++]) ) {
						node = elem.getAttributeNode("id");
						if ( node && node.value === id ) {
							return [ elem ];
						}
					}
				}

				return [];
			}
		};
	}

	// Tag
	Expr.find["TAG"] = support.getElementsByTagName ?
		function( tag, context ) {
			if ( typeof context.getElementsByTagName !== "undefined" ) {
				return context.getElementsByTagName( tag );

			// DocumentFragment nodes don't have gEBTN
			} else if ( support.qsa ) {
				return context.querySelectorAll( tag );
			}
		} :

		function( tag, context ) {
			var elem,
				tmp = [],
				i = 0,
				// By happy coincidence, a (broken) gEBTN appears on DocumentFragment nodes too
				results = context.getElementsByTagName( tag );

			// Filter out possible comments
			if ( tag === "*" ) {
				while ( (elem = results[i++]) ) {
					if ( elem.nodeType === 1 ) {
						tmp.push( elem );
					}
				}

				return tmp;
			}
			return results;
		};

	// Class
	Expr.find["CLASS"] = support.getElementsByClassName && function( className, context ) {
		if ( typeof context.getElementsByClassName !== "undefined" && documentIsHTML ) {
			return context.getElementsByClassName( className );
		}
	};

	/* QSA/matchesSelector
	---------------------------------------------------------------------- */

	// QSA and matchesSelector support

	// matchesSelector(:active) reports false when true (IE9/Opera 11.5)
	rbuggyMatches = [];

	// qSa(:focus) reports false when true (Chrome 21)
	// We allow this because of a bug in IE8/9 that throws an error
	// whenever `document.activeElement` is accessed on an iframe
	// So, we allow :focus to pass through QSA all the time to avoid the IE error
	// See https://bugs.jquery.com/ticket/13378
	rbuggyQSA = [];

	if ( (support.qsa = rnative.test( document.querySelectorAll )) ) {
		// Build QSA regex
		// Regex strategy adopted from Diego Perini
		assert(function( el ) {
			// Select is set to empty string on purpose
			// This is to test IE's treatment of not explicitly
			// setting a boolean content attribute,
			// since its presence should be enough
			// https://bugs.jquery.com/ticket/12359
			docElem.appendChild( el ).innerHTML = "<a id='" + expando + "'></a>" +
				"<select id='" + expando + "-\r\\' msallowcapture=''>" +
				"<option selected=''></option></select>";

			// Support: IE8, Opera 11-12.16
			// Nothing should be selected when empty strings follow ^= or $= or *=
			// The test attribute must be unknown in Opera but "safe" for WinRT
			// https://msdn.microsoft.com/en-us/library/ie/hh465388.aspx#attribute_section
			if ( el.querySelectorAll("[msallowcapture^='']").length ) {
				rbuggyQSA.push( "[*^$]=" + whitespace + "*(?:''|\"\")" );
			}

			// Support: IE8
			// Boolean attributes and "value" are not treated correctly
			if ( !el.querySelectorAll("[selected]").length ) {
				rbuggyQSA.push( "\\[" + whitespace + "*(?:value|" + booleans + ")" );
			}

			// Support: Chrome<29, Android<4.4, Safari<7.0+, iOS<7.0+, PhantomJS<1.9.8+
			if ( !el.querySelectorAll( "[id~=" + expando + "-]" ).length ) {
				rbuggyQSA.push("~=");
			}

			// Webkit/Opera - :checked should return selected option elements
			// http://www.w3.org/TR/2011/REC-css3-selectors-20110929/#checked
			// IE8 throws error here and will not see later tests
			if ( !el.querySelectorAll(":checked").length ) {
				rbuggyQSA.push(":checked");
			}

			// Support: Safari 8+, iOS 8+
			// https://bugs.webkit.org/show_bug.cgi?id=136851
			// In-page `selector#id sibling-combinator selector` fails
			if ( !el.querySelectorAll( "a#" + expando + "+*" ).length ) {
				rbuggyQSA.push(".#.+[+~]");
			}
		});

		assert(function( el ) {
			el.innerHTML = "<a href='' disabled='disabled'></a>" +
				"<select disabled='disabled'><option/></select>";

			// Support: Windows 8 Native Apps
			// The type and name attributes are restricted during .innerHTML assignment
			var input = document.createElement("input");
			input.setAttribute( "type", "hidden" );
			el.appendChild( input ).setAttribute( "name", "D" );

			// Support: IE8
			// Enforce case-sensitivity of name attribute
			if ( el.querySelectorAll("[name=d]").length ) {
				rbuggyQSA.push( "name" + whitespace + "*[*^$|!~]?=" );
			}

			// FF 3.5 - :enabled/:disabled and hidden elements (hidden elements are still enabled)
			// IE8 throws error here and will not see later tests
			if ( el.querySelectorAll(":enabled").length !== 2 ) {
				rbuggyQSA.push( ":enabled", ":disabled" );
			}

			// Support: IE9-11+
			// IE's :disabled selector does not pick up the children of disabled fieldsets
			docElem.appendChild( el ).disabled = true;
			if ( el.querySelectorAll(":disabled").length !== 2 ) {
				rbuggyQSA.push( ":enabled", ":disabled" );
			}

			// Opera 10-11 does not throw on post-comma invalid pseudos
			el.querySelectorAll("*,:x");
			rbuggyQSA.push(",.*:");
		});
	}

	if ( (support.matchesSelector = rnative.test( (matches = docElem.matches ||
		docElem.webkitMatchesSelector ||
		docElem.mozMatchesSelector ||
		docElem.oMatchesSelector ||
		docElem.msMatchesSelector) )) ) {

		assert(function( el ) {
			// Check to see if it's possible to do matchesSelector
			// on a disconnected node (IE 9)
			support.disconnectedMatch = matches.call( el, "*" );

			// This should fail with an exception
			// Gecko does not error, returns false instead
			matches.call( el, "[s!='']:x" );
			rbuggyMatches.push( "!=", pseudos );
		});
	}

	rbuggyQSA = rbuggyQSA.length && new RegExp( rbuggyQSA.join("|") );
	rbuggyMatches = rbuggyMatches.length && new RegExp( rbuggyMatches.join("|") );

	/* Contains
	---------------------------------------------------------------------- */
	hasCompare = rnative.test( docElem.compareDocumentPosition );

	// Element contains another
	// Purposefully self-exclusive
	// As in, an element does not contain itself
	contains = hasCompare || rnative.test( docElem.contains ) ?
		function( a, b ) {
			var adown = a.nodeType === 9 ? a.documentElement : a,
				bup = b && b.parentNode;
			return a === bup || !!( bup && bup.nodeType === 1 && (
				adown.contains ?
					adown.contains( bup ) :
					a.compareDocumentPosition && a.compareDocumentPosition( bup ) & 16
			));
		} :
		function( a, b ) {
			if ( b ) {
				while ( (b = b.parentNode) ) {
					if ( b === a ) {
						return true;
					}
				}
			}
			return false;
		};

	/* Sorting
	---------------------------------------------------------------------- */

	// Document order sorting
	sortOrder = hasCompare ?
	function( a, b ) {

		// Flag for duplicate removal
		if ( a === b ) {
			hasDuplicate = true;
			return 0;
		}

		// Sort on method existence if only one input has compareDocumentPosition
		var compare = !a.compareDocumentPosition - !b.compareDocumentPosition;
		if ( compare ) {
			return compare;
		}

		// Calculate position if both inputs belong to the same document
		compare = ( a.ownerDocument || a ) === ( b.ownerDocument || b ) ?
			a.compareDocumentPosition( b ) :

			// Otherwise we know they are disconnected
			1;

		// Disconnected nodes
		if ( compare & 1 ||
			(!support.sortDetached && b.compareDocumentPosition( a ) === compare) ) {

			// Choose the first element that is related to our preferred document
			if ( a === document || a.ownerDocument === preferredDoc && contains(preferredDoc, a) ) {
				return -1;
			}
			if ( b === document || b.ownerDocument === preferredDoc && contains(preferredDoc, b) ) {
				return 1;
			}

			// Maintain original order
			return sortInput ?
				( indexOf( sortInput, a ) - indexOf( sortInput, b ) ) :
				0;
		}

		return compare & 4 ? -1 : 1;
	} :
	function( a, b ) {
		// Exit early if the nodes are identical
		if ( a === b ) {
			hasDuplicate = true;
			return 0;
		}

		var cur,
			i = 0,
			aup = a.parentNode,
			bup = b.parentNode,
			ap = [ a ],
			bp = [ b ];

		// Parentless nodes are either documents or disconnected
		if ( !aup || !bup ) {
			return a === document ? -1 :
				b === document ? 1 :
				aup ? -1 :
				bup ? 1 :
				sortInput ?
				( indexOf( sortInput, a ) - indexOf( sortInput, b ) ) :
				0;

		// If the nodes are siblings, we can do a quick check
		} else if ( aup === bup ) {
			return siblingCheck( a, b );
		}

		// Otherwise we need full lists of their ancestors for comparison
		cur = a;
		while ( (cur = cur.parentNode) ) {
			ap.unshift( cur );
		}
		cur = b;
		while ( (cur = cur.parentNode) ) {
			bp.unshift( cur );
		}

		// Walk down the tree looking for a discrepancy
		while ( ap[i] === bp[i] ) {
			i++;
		}

		return i ?
			// Do a sibling check if the nodes have a common ancestor
			siblingCheck( ap[i], bp[i] ) :

			// Otherwise nodes in our document sort first
			ap[i] === preferredDoc ? -1 :
			bp[i] === preferredDoc ? 1 :
			0;
	};

	return document;
};

Sizzle.matches = function( expr, elements ) {
	return Sizzle( expr, null, null, elements );
};

Sizzle.matchesSelector = function( elem, expr ) {
	// Set document vars if needed
	if ( ( elem.ownerDocument || elem ) !== document ) {
		setDocument( elem );
	}

	// Make sure that attribute selectors are quoted
	expr = expr.replace( rattributeQuotes, "='$1']" );

	if ( support.matchesSelector && documentIsHTML &&
		!compilerCache[ expr + " " ] &&
		( !rbuggyMatches || !rbuggyMatches.test( expr ) ) &&
		( !rbuggyQSA     || !rbuggyQSA.test( expr ) ) ) {

		try {
			var ret = matches.call( elem, expr );

			// IE 9's matchesSelector returns false on disconnected nodes
			if ( ret || support.disconnectedMatch ||
					// As well, disconnected nodes are said to be in a document
					// fragment in IE 9
					elem.document && elem.document.nodeType !== 11 ) {
				return ret;
			}
		} catch (e) {}
	}

	return Sizzle( expr, document, null, [ elem ] ).length > 0;
};

Sizzle.contains = function( context, elem ) {
	// Set document vars if needed
	if ( ( context.ownerDocument || context ) !== document ) {
		setDocument( context );
	}
	return contains( context, elem );
};

Sizzle.attr = function( elem, name ) {
	// Set document vars if needed
	if ( ( elem.ownerDocument || elem ) !== document ) {
		setDocument( elem );
	}

	var fn = Expr.attrHandle[ name.toLowerCase() ],
		// Don't get fooled by Object.prototype properties (jQuery #13807)
		val = fn && hasOwn.call( Expr.attrHandle, name.toLowerCase() ) ?
			fn( elem, name, !documentIsHTML ) :
			undefined;

	return val !== undefined ?
		val :
		support.attributes || !documentIsHTML ?
			elem.getAttribute( name ) :
			(val = elem.getAttributeNode(name)) && val.specified ?
				val.value :
				null;
};

Sizzle.escape = function( sel ) {
	return (sel + "").replace( rcssescape, fcssescape );
};

Sizzle.error = function( msg ) {
	throw new Error( "Syntax error, unrecognized expression: " + msg );
};

/**
 * Document sorting and removing duplicates
 * @param {ArrayLike} results
 */
Sizzle.uniqueSort = function( results ) {
	var elem,
		duplicates = [],
		j = 0,
		i = 0;

	// Unless we *know* we can detect duplicates, assume their presence
	hasDuplicate = !support.detectDuplicates;
	sortInput = !support.sortStable && results.slice( 0 );
	results.sort( sortOrder );

	if ( hasDuplicate ) {
		while ( (elem = results[i++]) ) {
			if ( elem === results[ i ] ) {
				j = duplicates.push( i );
			}
		}
		while ( j-- ) {
			results.splice( duplicates[ j ], 1 );
		}
	}

	// Clear input after sorting to release objects
	// See https://github.com/jquery/sizzle/pull/225
	sortInput = null;

	return results;
};

/**
 * Utility function for retrieving the text value of an array of DOM nodes
 * @param {Array|Element} elem
 */
getText = Sizzle.getText = function( elem ) {
	var node,
		ret = "",
		i = 0,
		nodeType = elem.nodeType;

	if ( !nodeType ) {
		// If no nodeType, this is expected to be an array
		while ( (node = elem[i++]) ) {
			// Do not traverse comment nodes
			ret += getText( node );
		}
	} else if ( nodeType === 1 || nodeType === 9 || nodeType === 11 ) {
		// Use textContent for elements
		// innerText usage removed for consistency of new lines (jQuery #11153)
		if ( typeof elem.textContent === "string" ) {
			return elem.textContent;
		} else {
			// Traverse its children
			for ( elem = elem.firstChild; elem; elem = elem.nextSibling ) {
				ret += getText( elem );
			}
		}
	} else if ( nodeType === 3 || nodeType === 4 ) {
		return elem.nodeValue;
	}
	// Do not include comment or processing instruction nodes

	return ret;
};

Expr = Sizzle.selectors = {

	// Can be adjusted by the user
	cacheLength: 50,

	createPseudo: markFunction,

	match: matchExpr,

	attrHandle: {},

	find: {},

	relative: {
		">": { dir: "parentNode", first: true },
		" ": { dir: "parentNode" },
		"+": { dir: "previousSibling", first: true },
		"~": { dir: "previousSibling" }
	},

	preFilter: {
		"ATTR": function( match ) {
			match[1] = match[1].replace( runescape, funescape );

			// Move the given value to match[3] whether quoted or unquoted
			match[3] = ( match[3] || match[4] || match[5] || "" ).replace( runescape, funescape );

			if ( match[2] === "~=" ) {
				match[3] = " " + match[3] + " ";
			}

			return match.slice( 0, 4 );
		},

		"CHILD": function( match ) {
			/* matches from matchExpr["CHILD"]
				1 type (only|nth|...)
				2 what (child|of-type)
				3 argument (even|odd|\d*|\d*n([+-]\d+)?|...)
				4 xn-component of xn+y argument ([+-]?\d*n|)
				5 sign of xn-component
				6 x of xn-component
				7 sign of y-component
				8 y of y-component
			*/
			match[1] = match[1].toLowerCase();

			if ( match[1].slice( 0, 3 ) === "nth" ) {
				// nth-* requires argument
				if ( !match[3] ) {
					Sizzle.error( match[0] );
				}

				// numeric x and y parameters for Expr.filter.CHILD
				// remember that false/true cast respectively to 0/1
				match[4] = +( match[4] ? match[5] + (match[6] || 1) : 2 * ( match[3] === "even" || match[3] === "odd" ) );
				match[5] = +( ( match[7] + match[8] ) || match[3] === "odd" );

			// other types prohibit arguments
			} else if ( match[3] ) {
				Sizzle.error( match[0] );
			}

			return match;
		},

		"PSEUDO": function( match ) {
			var excess,
				unquoted = !match[6] && match[2];

			if ( matchExpr["CHILD"].test( match[0] ) ) {
				return null;
			}

			// Accept quoted arguments as-is
			if ( match[3] ) {
				match[2] = match[4] || match[5] || "";

			// Strip excess characters from unquoted arguments
			} else if ( unquoted && rpseudo.test( unquoted ) &&
				// Get excess from tokenize (recursively)
				(excess = tokenize( unquoted, true )) &&
				// advance to the next closing parenthesis
				(excess = unquoted.indexOf( ")", unquoted.length - excess ) - unquoted.length) ) {

				// excess is a negative index
				match[0] = match[0].slice( 0, excess );
				match[2] = unquoted.slice( 0, excess );
			}

			// Return only captures needed by the pseudo filter method (type and argument)
			return match.slice( 0, 3 );
		}
	},

	filter: {

		"TAG": function( nodeNameSelector ) {
			var nodeName = nodeNameSelector.replace( runescape, funescape ).toLowerCase();
			return nodeNameSelector === "*" ?
				function() { return true; } :
				function( elem ) {
					return elem.nodeName && elem.nodeName.toLowerCase() === nodeName;
				};
		},

		"CLASS": function( className ) {
			var pattern = classCache[ className + " " ];

			return pattern ||
				(pattern = new RegExp( "(^|" + whitespace + ")" + className + "(" + whitespace + "|$)" )) &&
				classCache( className, function( elem ) {
					return pattern.test( typeof elem.className === "string" && elem.className || typeof elem.getAttribute !== "undefined" && elem.getAttribute("class") || "" );
				});
		},

		"ATTR": function( name, operator, check ) {
			return function( elem ) {
				var result = Sizzle.attr( elem, name );

				if ( result == null ) {
					return operator === "!=";
				}
				if ( !operator ) {
					return true;
				}

				result += "";

				return operator === "=" ? result === check :
					operator === "!=" ? result !== check :
					operator === "^=" ? check && result.indexOf( check ) === 0 :
					operator === "*=" ? check && result.indexOf( check ) > -1 :
					operator === "$=" ? check && result.slice( -check.length ) === check :
					operator === "~=" ? ( " " + result.replace( rwhitespace, " " ) + " " ).indexOf( check ) > -1 :
					operator === "|=" ? result === check || result.slice( 0, check.length + 1 ) === check + "-" :
					false;
			};
		},

		"CHILD": function( type, what, argument, first, last ) {
			var simple = type.slice( 0, 3 ) !== "nth",
				forward = type.slice( -4 ) !== "last",
				ofType = what === "of-type";

			return first === 1 && last === 0 ?

				// Shortcut for :nth-*(n)
				function( elem ) {
					return !!elem.parentNode;
				} :

				function( elem, context, xml ) {
					var cache, uniqueCache, outerCache, node, nodeIndex, start,
						dir = simple !== forward ? "nextSibling" : "previousSibling",
						parent = elem.parentNode,
						name = ofType && elem.nodeName.toLowerCase(),
						useCache = !xml && !ofType,
						diff = false;

					if ( parent ) {

						// :(first|last|only)-(child|of-type)
						if ( simple ) {
							while ( dir ) {
								node = elem;
								while ( (node = node[ dir ]) ) {
									if ( ofType ?
										node.nodeName.toLowerCase() === name :
										node.nodeType === 1 ) {

										return false;
									}
								}
								// Reverse direction for :only-* (if we haven't yet done so)
								start = dir = type === "only" && !start && "nextSibling";
							}
							return true;
						}

						start = [ forward ? parent.firstChild : parent.lastChild ];

						// non-xml :nth-child(...) stores cache data on `parent`
						if ( forward && useCache ) {

							// Seek `elem` from a previously-cached index

							// ...in a gzip-friendly way
							node = parent;
							outerCache = node[ expando ] || (node[ expando ] = {});

							// Support: IE <9 only
							// Defend against cloned attroperties (jQuery gh-1709)
							uniqueCache = outerCache[ node.uniqueID ] ||
								(outerCache[ node.uniqueID ] = {});

							cache = uniqueCache[ type ] || [];
							nodeIndex = cache[ 0 ] === dirruns && cache[ 1 ];
							diff = nodeIndex && cache[ 2 ];
							node = nodeIndex && parent.childNodes[ nodeIndex ];

							while ( (node = ++nodeIndex && node && node[ dir ] ||

								// Fallback to seeking `elem` from the start
								(diff = nodeIndex = 0) || start.pop()) ) {

								// When found, cache indexes on `parent` and break
								if ( node.nodeType === 1 && ++diff && node === elem ) {
									uniqueCache[ type ] = [ dirruns, nodeIndex, diff ];
									break;
								}
							}

						} else {
							// Use previously-cached element index if available
							if ( useCache ) {
								// ...in a gzip-friendly way
								node = elem;
								outerCache = node[ expando ] || (node[ expando ] = {});

								// Support: IE <9 only
								// Defend against cloned attroperties (jQuery gh-1709)
								uniqueCache = outerCache[ node.uniqueID ] ||
									(outerCache[ node.uniqueID ] = {});

								cache = uniqueCache[ type ] || [];
								nodeIndex = cache[ 0 ] === dirruns && cache[ 1 ];
								diff = nodeIndex;
							}

							// xml :nth-child(...)
							// or :nth-last-child(...) or :nth(-last)?-of-type(...)
							if ( diff === false ) {
								// Use the same loop as above to seek `elem` from the start
								while ( (node = ++nodeIndex && node && node[ dir ] ||
									(diff = nodeIndex = 0) || start.pop()) ) {

									if ( ( ofType ?
										node.nodeName.toLowerCase() === name :
										node.nodeType === 1 ) &&
										++diff ) {

										// Cache the index of each encountered element
										if ( useCache ) {
											outerCache = node[ expando ] || (node[ expando ] = {});

											// Support: IE <9 only
											// Defend against cloned attroperties (jQuery gh-1709)
											uniqueCache = outerCache[ node.uniqueID ] ||
												(outerCache[ node.uniqueID ] = {});

											uniqueCache[ type ] = [ dirruns, diff ];
										}

										if ( node === elem ) {
											break;
										}
									}
								}
							}
						}

						// Incorporate the offset, then check against cycle size
						diff -= last;
						return diff === first || ( diff % first === 0 && diff / first >= 0 );
					}
				};
		},

		"PSEUDO": function( pseudo, argument ) {
			// pseudo-class names are case-insensitive
			// http://www.w3.org/TR/selectors/#pseudo-classes
			// Prioritize by case sensitivity in case custom pseudos are added with uppercase letters
			// Remember that setFilters inherits from pseudos
			var args,
				fn = Expr.pseudos[ pseudo ] || Expr.setFilters[ pseudo.toLowerCase() ] ||
					Sizzle.error( "unsupported pseudo: " + pseudo );

			// The user may use createPseudo to indicate that
			// arguments are needed to create the filter function
			// just as Sizzle does
			if ( fn[ expando ] ) {
				return fn( argument );
			}

			// But maintain support for old signatures
			if ( fn.length > 1 ) {
				args = [ pseudo, pseudo, "", argument ];
				return Expr.setFilters.hasOwnProperty( pseudo.toLowerCase() ) ?
					markFunction(function( seed, matches ) {
						var idx,
							matched = fn( seed, argument ),
							i = matched.length;
						while ( i-- ) {
							idx = indexOf( seed, matched[i] );
							seed[ idx ] = !( matches[ idx ] = matched[i] );
						}
					}) :
					function( elem ) {
						return fn( elem, 0, args );
					};
			}

			return fn;
		}
	},

	pseudos: {
		// Potentially complex pseudos
		"not": markFunction(function( selector ) {
			// Trim the selector passed to compile
			// to avoid treating leading and trailing
			// spaces as combinators
			var input = [],
				results = [],
				matcher = compile( selector.replace( rtrim, "$1" ) );

			return matcher[ expando ] ?
				markFunction(function( seed, matches, context, xml ) {
					var elem,
						unmatched = matcher( seed, null, xml, [] ),
						i = seed.length;

					// Match elements unmatched by `matcher`
					while ( i-- ) {
						if ( (elem = unmatched[i]) ) {
							seed[i] = !(matches[i] = elem);
						}
					}
				}) :
				function( elem, context, xml ) {
					input[0] = elem;
					matcher( input, null, xml, results );
					// Don't keep the element (issue #299)
					input[0] = null;
					return !results.pop();
				};
		}),

		"has": markFunction(function( selector ) {
			return function( elem ) {
				return Sizzle( selector, elem ).length > 0;
			};
		}),

		"contains": markFunction(function( text ) {
			text = text.replace( runescape, funescape );
			return function( elem ) {
				return ( elem.textContent || elem.innerText || getText( elem ) ).indexOf( text ) > -1;
			};
		}),

		// "Whether an element is represented by a :lang() selector
		// is based solely on the element's language value
		// being equal to the identifier C,
		// or beginning with the identifier C immediately followed by "-".
		// The matching of C against the element's language value is performed case-insensitively.
		// The identifier C does not have to be a valid language name."
		// http://www.w3.org/TR/selectors/#lang-pseudo
		"lang": markFunction( function( lang ) {
			// lang value must be a valid identifier
			if ( !ridentifier.test(lang || "") ) {
				Sizzle.error( "unsupported lang: " + lang );
			}
			lang = lang.replace( runescape, funescape ).toLowerCase();
			return function( elem ) {
				var elemLang;
				do {
					if ( (elemLang = documentIsHTML ?
						elem.lang :
						elem.getAttribute("xml:lang") || elem.getAttribute("lang")) ) {

						elemLang = elemLang.toLowerCase();
						return elemLang === lang || elemLang.indexOf( lang + "-" ) === 0;
					}
				} while ( (elem = elem.parentNode) && elem.nodeType === 1 );
				return false;
			};
		}),

		// Miscellaneous
		"target": function( elem ) {
			var hash = window.location && window.location.hash;
			return hash && hash.slice( 1 ) === elem.id;
		},

		"root": function( elem ) {
			return elem === docElem;
		},

		"focus": function( elem ) {
			return elem === document.activeElement && (!document.hasFocus || document.hasFocus()) && !!(elem.type || elem.href || ~elem.tabIndex);
		},

		// Boolean properties
		"enabled": createDisabledPseudo( false ),
		"disabled": createDisabledPseudo( true ),

		"checked": function( elem ) {
			// In CSS3, :checked should return both checked and selected elements
			// http://www.w3.org/TR/2011/REC-css3-selectors-20110929/#checked
			var nodeName = elem.nodeName.toLowerCase();
			return (nodeName === "input" && !!elem.checked) || (nodeName === "option" && !!elem.selected);
		},

		"selected": function( elem ) {
			// Accessing this property makes selected-by-default
			// options in Safari work properly
			if ( elem.parentNode ) {
				elem.parentNode.selectedIndex;
			}

			return elem.selected === true;
		},

		// Contents
		"empty": function( elem ) {
			// http://www.w3.org/TR/selectors/#empty-pseudo
			// :empty is negated by element (1) or content nodes (text: 3; cdata: 4; entity ref: 5),
			//   but not by others (comment: 8; processing instruction: 7; etc.)
			// nodeType < 6 works because attributes (2) do not appear as children
			for ( elem = elem.firstChild; elem; elem = elem.nextSibling ) {
				if ( elem.nodeType < 6 ) {
					return false;
				}
			}
			return true;
		},

		"parent": function( elem ) {
			return !Expr.pseudos["empty"]( elem );
		},

		// Element/input types
		"header": function( elem ) {
			return rheader.test( elem.nodeName );
		},

		"input": function( elem ) {
			return rinputs.test( elem.nodeName );
		},

		"button": function( elem ) {
			var name = elem.nodeName.toLowerCase();
			return name === "input" && elem.type === "button" || name === "button";
		},

		"text": function( elem ) {
			var attr;
			return elem.nodeName.toLowerCase() === "input" &&
				elem.type === "text" &&

				// Support: IE<8
				// New HTML5 attribute values (e.g., "search") appear with elem.type === "text"
				( (attr = elem.getAttribute("type")) == null || attr.toLowerCase() === "text" );
		},

		// Position-in-collection
		"first": createPositionalPseudo(function() {
			return [ 0 ];
		}),

		"last": createPositionalPseudo(function( matchIndexes, length ) {
			return [ length - 1 ];
		}),

		"eq": createPositionalPseudo(function( matchIndexes, length, argument ) {
			return [ argument < 0 ? argument + length : argument ];
		}),

		"even": createPositionalPseudo(function( matchIndexes, length ) {
			var i = 0;
			for ( ; i < length; i += 2 ) {
				matchIndexes.push( i );
			}
			return matchIndexes;
		}),

		"odd": createPositionalPseudo(function( matchIndexes, length ) {
			var i = 1;
			for ( ; i < length; i += 2 ) {
				matchIndexes.push( i );
			}
			return matchIndexes;
		}),

		"lt": createPositionalPseudo(function( matchIndexes, length, argument ) {
			var i = argument < 0 ? argument + length : argument;
			for ( ; --i >= 0; ) {
				matchIndexes.push( i );
			}
			return matchIndexes;
		}),

		"gt": createPositionalPseudo(function( matchIndexes, length, argument ) {
			var i = argument < 0 ? argument + length : argument;
			for ( ; ++i < length; ) {
				matchIndexes.push( i );
			}
			return matchIndexes;
		})
	}
};

Expr.pseudos["nth"] = Expr.pseudos["eq"];

// Add button/input type pseudos
for ( i in { radio: true, checkbox: true, file: true, password: true, image: true } ) {
	Expr.pseudos[ i ] = createInputPseudo( i );
}
for ( i in { submit: true, reset: true } ) {
	Expr.pseudos[ i ] = createButtonPseudo( i );
}

// Easy API for creating new setFilters
function setFilters() {}
setFilters.prototype = Expr.filters = Expr.pseudos;
Expr.setFilters = new setFilters();

tokenize = Sizzle.tokenize = function( selector, parseOnly ) {
	var matched, match, tokens, type,
		soFar, groups, preFilters,
		cached = tokenCache[ selector + " " ];

	if ( cached ) {
		return parseOnly ? 0 : cached.slice( 0 );
	}

	soFar = selector;
	groups = [];
	preFilters = Expr.preFilter;

	while ( soFar ) {

		// Comma and first run
		if ( !matched || (match = rcomma.exec( soFar )) ) {
			if ( match ) {
				// Don't consume trailing commas as valid
				soFar = soFar.slice( match[0].length ) || soFar;
			}
			groups.push( (tokens = []) );
		}

		matched = false;

		// Combinators
		if ( (match = rcombinators.exec( soFar )) ) {
			matched = match.shift();
			tokens.push({
				value: matched,
				// Cast descendant combinators to space
				type: match[0].replace( rtrim, " " )
			});
			soFar = soFar.slice( matched.length );
		}

		// Filters
		for ( type in Expr.filter ) {
			if ( (match = matchExpr[ type ].exec( soFar )) && (!preFilters[ type ] ||
				(match = preFilters[ type ]( match ))) ) {
				matched = match.shift();
				tokens.push({
					value: matched,
					type: type,
					matches: match
				});
				soFar = soFar.slice( matched.length );
			}
		}

		if ( !matched ) {
			break;
		}
	}

	// Return the length of the invalid excess
	// if we're just parsing
	// Otherwise, throw an error or return tokens
	return parseOnly ?
		soFar.length :
		soFar ?
			Sizzle.error( selector ) :
			// Cache the tokens
			tokenCache( selector, groups ).slice( 0 );
};

function toSelector( tokens ) {
	var i = 0,
		len = tokens.length,
		selector = "";
	for ( ; i < len; i++ ) {
		selector += tokens[i].value;
	}
	return selector;
}

function addCombinator( matcher, combinator, base ) {
	var dir = combinator.dir,
		skip = combinator.next,
		key = skip || dir,
		checkNonElements = base && key === "parentNode",
		doneName = done++;

	return combinator.first ?
		// Check against closest ancestor/preceding element
		function( elem, context, xml ) {
			while ( (elem = elem[ dir ]) ) {
				if ( elem.nodeType === 1 || checkNonElements ) {
					return matcher( elem, context, xml );
				}
			}
			return false;
		} :

		// Check against all ancestor/preceding elements
		function( elem, context, xml ) {
			var oldCache, uniqueCache, outerCache,
				newCache = [ dirruns, doneName ];

			// We can't set arbitrary data on XML nodes, so they don't benefit from combinator caching
			if ( xml ) {
				while ( (elem = elem[ dir ]) ) {
					if ( elem.nodeType === 1 || checkNonElements ) {
						if ( matcher( elem, context, xml ) ) {
							return true;
						}
					}
				}
			} else {
				while ( (elem = elem[ dir ]) ) {
					if ( elem.nodeType === 1 || checkNonElements ) {
						outerCache = elem[ expando ] || (elem[ expando ] = {});

						// Support: IE <9 only
						// Defend against cloned attroperties (jQuery gh-1709)
						uniqueCache = outerCache[ elem.uniqueID ] || (outerCache[ elem.uniqueID ] = {});

						if ( skip && skip === elem.nodeName.toLowerCase() ) {
							elem = elem[ dir ] || elem;
						} else if ( (oldCache = uniqueCache[ key ]) &&
							oldCache[ 0 ] === dirruns && oldCache[ 1 ] === doneName ) {

							// Assign to newCache so results back-propagate to previous elements
							return (newCache[ 2 ] = oldCache[ 2 ]);
						} else {
							// Reuse newcache so results back-propagate to previous elements
							uniqueCache[ key ] = newCache;

							// A match means we're done; a fail means we have to keep checking
							if ( (newCache[ 2 ] = matcher( elem, context, xml )) ) {
								return true;
							}
						}
					}
				}
			}
			return false;
		};
}

function elementMatcher( matchers ) {
	return matchers.length > 1 ?
		function( elem, context, xml ) {
			var i = matchers.length;
			while ( i-- ) {
				if ( !matchers[i]( elem, context, xml ) ) {
					return false;
				}
			}
			return true;
		} :
		matchers[0];
}

function multipleContexts( selector, contexts, results ) {
	var i = 0,
		len = contexts.length;
	for ( ; i < len; i++ ) {
		Sizzle( selector, contexts[i], results );
	}
	return results;
}

function condense( unmatched, map, filter, context, xml ) {
	var elem,
		newUnmatched = [],
		i = 0,
		len = unmatched.length,
		mapped = map != null;

	for ( ; i < len; i++ ) {
		if ( (elem = unmatched[i]) ) {
			if ( !filter || filter( elem, context, xml ) ) {
				newUnmatched.push( elem );
				if ( mapped ) {
					map.push( i );
				}
			}
		}
	}

	return newUnmatched;
}

function setMatcher( preFilter, selector, matcher, postFilter, postFinder, postSelector ) {
	if ( postFilter && !postFilter[ expando ] ) {
		postFilter = setMatcher( postFilter );
	}
	if ( postFinder && !postFinder[ expando ] ) {
		postFinder = setMatcher( postFinder, postSelector );
	}
	return markFunction(function( seed, results, context, xml ) {
		var temp, i, elem,
			preMap = [],
			postMap = [],
			preexisting = results.length,

			// Get initial elements from seed or context
			elems = seed || multipleContexts( selector || "*", context.nodeType ? [ context ] : context, [] ),

			// Prefilter to get matcher input, preserving a map for seed-results synchronization
			matcherIn = preFilter && ( seed || !selector ) ?
				condense( elems, preMap, preFilter, context, xml ) :
				elems,

			matcherOut = matcher ?
				// If we have a postFinder, or filtered seed, or non-seed postFilter or preexisting results,
				postFinder || ( seed ? preFilter : preexisting || postFilter ) ?

					// ...intermediate processing is necessary
					[] :

					// ...otherwise use results directly
					results :
				matcherIn;

		// Find primary matches
		if ( matcher ) {
			matcher( matcherIn, matcherOut, context, xml );
		}

		// Apply postFilter
		if ( postFilter ) {
			temp = condense( matcherOut, postMap );
			postFilter( temp, [], context, xml );

			// Un-match failing elements by moving them back to matcherIn
			i = temp.length;
			while ( i-- ) {
				if ( (elem = temp[i]) ) {
					matcherOut[ postMap[i] ] = !(matcherIn[ postMap[i] ] = elem);
				}
			}
		}

		if ( seed ) {
			if ( postFinder || preFilter ) {
				if ( postFinder ) {
					// Get the final matcherOut by condensing this intermediate into postFinder contexts
					temp = [];
					i = matcherOut.length;
					while ( i-- ) {
						if ( (elem = matcherOut[i]) ) {
							// Restore matcherIn since elem is not yet a final match
							temp.push( (matcherIn[i] = elem) );
						}
					}
					postFinder( null, (matcherOut = []), temp, xml );
				}

				// Move matched elements from seed to results to keep them synchronized
				i = matcherOut.length;
				while ( i-- ) {
					if ( (elem = matcherOut[i]) &&
						(temp = postFinder ? indexOf( seed, elem ) : preMap[i]) > -1 ) {

						seed[temp] = !(results[temp] = elem);
					}
				}
			}

		// Add elements to results, through postFinder if defined
		} else {
			matcherOut = condense(
				matcherOut === results ?
					matcherOut.splice( preexisting, matcherOut.length ) :
					matcherOut
			);
			if ( postFinder ) {
				postFinder( null, results, matcherOut, xml );
			} else {
				push.apply( results, matcherOut );
			}
		}
	});
}

function matcherFromTokens( tokens ) {
	var checkContext, matcher, j,
		len = tokens.length,
		leadingRelative = Expr.relative[ tokens[0].type ],
		implicitRelative = leadingRelative || Expr.relative[" "],
		i = leadingRelative ? 1 : 0,

		// The foundational matcher ensures that elements are reachable from top-level context(s)
		matchContext = addCombinator( function( elem ) {
			return elem === checkContext;
		}, implicitRelative, true ),
		matchAnyContext = addCombinator( function( elem ) {
			return indexOf( checkContext, elem ) > -1;
		}, implicitRelative, true ),
		matchers = [ function( elem, context, xml ) {
			var ret = ( !leadingRelative && ( xml || context !== outermostContext ) ) || (
				(checkContext = context).nodeType ?
					matchContext( elem, context, xml ) :
					matchAnyContext( elem, context, xml ) );
			// Avoid hanging onto element (issue #299)
			checkContext = null;
			return ret;
		} ];

	for ( ; i < len; i++ ) {
		if ( (matcher = Expr.relative[ tokens[i].type ]) ) {
			matchers = [ addCombinator(elementMatcher( matchers ), matcher) ];
		} else {
			matcher = Expr.filter[ tokens[i].type ].apply( null, tokens[i].matches );

			// Return special upon seeing a positional matcher
			if ( matcher[ expando ] ) {
				// Find the next relative operator (if any) for proper handling
				j = ++i;
				for ( ; j < len; j++ ) {
					if ( Expr.relative[ tokens[j].type ] ) {
						break;
					}
				}
				return setMatcher(
					i > 1 && elementMatcher( matchers ),
					i > 1 && toSelector(
						// If the preceding token was a descendant combinator, insert an implicit any-element `*`
						tokens.slice( 0, i - 1 ).concat({ value: tokens[ i - 2 ].type === " " ? "*" : "" })
					).replace( rtrim, "$1" ),
					matcher,
					i < j && matcherFromTokens( tokens.slice( i, j ) ),
					j < len && matcherFromTokens( (tokens = tokens.slice( j )) ),
					j < len && toSelector( tokens )
				);
			}
			matchers.push( matcher );
		}
	}

	return elementMatcher( matchers );
}

function matcherFromGroupMatchers( elementMatchers, setMatchers ) {
	var bySet = setMatchers.length > 0,
		byElement = elementMatchers.length > 0,
		superMatcher = function( seed, context, xml, results, outermost ) {
			var elem, j, matcher,
				matchedCount = 0,
				i = "0",
				unmatched = seed && [],
				setMatched = [],
				contextBackup = outermostContext,
				// We must always have either seed elements or outermost context
				elems = seed || byElement && Expr.find["TAG"]( "*", outermost ),
				// Use integer dirruns iff this is the outermost matcher
				dirrunsUnique = (dirruns += contextBackup == null ? 1 : Math.random() || 0.1),
				len = elems.length;

			if ( outermost ) {
				outermostContext = context === document || context || outermost;
			}

			// Add elements passing elementMatchers directly to results
			// Support: IE<9, Safari
			// Tolerate NodeList properties (IE: "length"; Safari: <number>) matching elements by id
			for ( ; i !== len && (elem = elems[i]) != null; i++ ) {
				if ( byElement && elem ) {
					j = 0;
					if ( !context && elem.ownerDocument !== document ) {
						setDocument( elem );
						xml = !documentIsHTML;
					}
					while ( (matcher = elementMatchers[j++]) ) {
						if ( matcher( elem, context || document, xml) ) {
							results.push( elem );
							break;
						}
					}
					if ( outermost ) {
						dirruns = dirrunsUnique;
					}
				}

				// Track unmatched elements for set filters
				if ( bySet ) {
					// They will have gone through all possible matchers
					if ( (elem = !matcher && elem) ) {
						matchedCount--;
					}

					// Lengthen the array for every element, matched or not
					if ( seed ) {
						unmatched.push( elem );
					}
				}
			}

			// `i` is now the count of elements visited above, and adding it to `matchedCount`
			// makes the latter nonnegative.
			matchedCount += i;

			// Apply set filters to unmatched elements
			// NOTE: This can be skipped if there are no unmatched elements (i.e., `matchedCount`
			// equals `i`), unless we didn't visit _any_ elements in the above loop because we have
			// no element matchers and no seed.
			// Incrementing an initially-string "0" `i` allows `i` to remain a string only in that
			// case, which will result in a "00" `matchedCount` that differs from `i` but is also
			// numerically zero.
			if ( bySet && i !== matchedCount ) {
				j = 0;
				while ( (matcher = setMatchers[j++]) ) {
					matcher( unmatched, setMatched, context, xml );
				}

				if ( seed ) {
					// Reintegrate element matches to eliminate the need for sorting
					if ( matchedCount > 0 ) {
						while ( i-- ) {
							if ( !(unmatched[i] || setMatched[i]) ) {
								setMatched[i] = pop.call( results );
							}
						}
					}

					// Discard index placeholder values to get only actual matches
					setMatched = condense( setMatched );
				}

				// Add matches to results
				push.apply( results, setMatched );

				// Seedless set matches succeeding multiple successful matchers stipulate sorting
				if ( outermost && !seed && setMatched.length > 0 &&
					( matchedCount + setMatchers.length ) > 1 ) {

					Sizzle.uniqueSort( results );
				}
			}

			// Override manipulation of globals by nested matchers
			if ( outermost ) {
				dirruns = dirrunsUnique;
				outermostContext = contextBackup;
			}

			return unmatched;
		};

	return bySet ?
		markFunction( superMatcher ) :
		superMatcher;
}

compile = Sizzle.compile = function( selector, match /* Internal Use Only */ ) {
	var i,
		setMatchers = [],
		elementMatchers = [],
		cached = compilerCache[ selector + " " ];

	if ( !cached ) {
		// Generate a function of recursive functions that can be used to check each element
		if ( !match ) {
			match = tokenize( selector );
		}
		i = match.length;
		while ( i-- ) {
			cached = matcherFromTokens( match[i] );
			if ( cached[ expando ] ) {
				setMatchers.push( cached );
			} else {
				elementMatchers.push( cached );
			}
		}

		// Cache the compiled function
		cached = compilerCache( selector, matcherFromGroupMatchers( elementMatchers, setMatchers ) );

		// Save selector and tokenization
		cached.selector = selector;
	}
	return cached;
};

/**
 * A low-level selection function that works with Sizzle's compiled
 *  selector functions
 * @param {String|Function} selector A selector or a pre-compiled
 *  selector function built with Sizzle.compile
 * @param {Element} context
 * @param {Array} [results]
 * @param {Array} [seed] A set of elements to match against
 */
select = Sizzle.select = function( selector, context, results, seed ) {
	var i, tokens, token, type, find,
		compiled = typeof selector === "function" && selector,
		match = !seed && tokenize( (selector = compiled.selector || selector) );

	results = results || [];

	// Try to minimize operations if there is only one selector in the list and no seed
	// (the latter of which guarantees us context)
	if ( match.length === 1 ) {

		// Reduce context if the leading compound selector is an ID
		tokens = match[0] = match[0].slice( 0 );
		if ( tokens.length > 2 && (token = tokens[0]).type === "ID" &&
				context.nodeType === 9 && documentIsHTML && Expr.relative[ tokens[1].type ] ) {

			context = ( Expr.find["ID"]( token.matches[0].replace(runescape, funescape), context ) || [] )[0];
			if ( !context ) {
				return results;

			// Precompiled matchers will still verify ancestry, so step up a level
			} else if ( compiled ) {
				context = context.parentNode;
			}

			selector = selector.slice( tokens.shift().value.length );
		}

		// Fetch a seed set for right-to-left matching
		i = matchExpr["needsContext"].test( selector ) ? 0 : tokens.length;
		while ( i-- ) {
			token = tokens[i];

			// Abort if we hit a combinator
			if ( Expr.relative[ (type = token.type) ] ) {
				break;
			}
			if ( (find = Expr.find[ type ]) ) {
				// Search, expanding context for leading sibling combinators
				if ( (seed = find(
					token.matches[0].replace( runescape, funescape ),
					rsibling.test( tokens[0].type ) && testContext( context.parentNode ) || context
				)) ) {

					// If seed is empty or no tokens remain, we can return early
					tokens.splice( i, 1 );
					selector = seed.length && toSelector( tokens );
					if ( !selector ) {
						push.apply( results, seed );
						return results;
					}

					break;
				}
			}
		}
	}

	// Compile and execute a filtering function if one is not provided
	// Provide `match` to avoid retokenization if we modified the selector above
	( compiled || compile( selector, match ) )(
		seed,
		context,
		!documentIsHTML,
		results,
		!context || rsibling.test( selector ) && testContext( context.parentNode ) || context
	);
	return results;
};

// One-time assignments

// Sort stability
support.sortStable = expando.split("").sort( sortOrder ).join("") === expando;

// Support: Chrome 14-35+
// Always assume duplicates if they aren't passed to the comparison function
support.detectDuplicates = !!hasDuplicate;

// Initialize against the default document
setDocument();

// Support: Webkit<537.32 - Safari 6.0.3/Chrome 25 (fixed in Chrome 27)
// Detached nodes confoundingly follow *each other*
support.sortDetached = assert(function( el ) {
	// Should return 1, but returns 4 (following)
	return el.compareDocumentPosition( document.createElement("fieldset") ) & 1;
});

// Support: IE<8
// Prevent attribute/property "interpolation"
// https://msdn.microsoft.com/en-us/library/ms536429%28VS.85%29.aspx
if ( !assert(function( el ) {
	el.innerHTML = "<a href='#'></a>";
	return el.firstChild.getAttribute("href") === "#" ;
}) ) {
	addHandle( "type|href|height|width", function( elem, name, isXML ) {
		if ( !isXML ) {
			return elem.getAttribute( name, name.toLowerCase() === "type" ? 1 : 2 );
		}
	});
}

// Support: IE<9
// Use defaultValue in place of getAttribute("value")
if ( !support.attributes || !assert(function( el ) {
	el.innerHTML = "<input/>";
	el.firstChild.setAttribute( "value", "" );
	return el.firstChild.getAttribute( "value" ) === "";
}) ) {
	addHandle( "value", function( elem, name, isXML ) {
		if ( !isXML && elem.nodeName.toLowerCase() === "input" ) {
			return elem.defaultValue;
		}
	});
}

// Support: IE<9
// Use getAttributeNode to fetch booleans when getAttribute lies
if ( !assert(function( el ) {
	return el.getAttribute("disabled") == null;
}) ) {
	addHandle( booleans, function( elem, name, isXML ) {
		var val;
		if ( !isXML ) {
			return elem[ name ] === true ? name.toLowerCase() :
					(val = elem.getAttributeNode( name )) && val.specified ?
					val.value :
				null;
		}
	});
}

return Sizzle;

})( window );



jQuery.find = Sizzle;
jQuery.expr = Sizzle.selectors;

// Deprecated
jQuery.expr[ ":" ] = jQuery.expr.pseudos;
jQuery.uniqueSort = jQuery.unique = Sizzle.uniqueSort;
jQuery.text = Sizzle.getText;
jQuery.isXMLDoc = Sizzle.isXML;
jQuery.contains = Sizzle.contains;
jQuery.escapeSelector = Sizzle.escape;




var dir = function( elem, dir, until ) {
	var matched = [],
		truncate = until !== undefined;

	while ( ( elem = elem[ dir ] ) && elem.nodeType !== 9 ) {
		if ( elem.nodeType === 1 ) {
			if ( truncate && jQuery( elem ).is( until ) ) {
				break;
			}
			matched.push( elem );
		}
	}
	return matched;
};


var siblings = function( n, elem ) {
	var matched = [];

	for ( ; n; n = n.nextSibling ) {
		if ( n.nodeType === 1 && n !== elem ) {
			matched.push( n );
		}
	}

	return matched;
};


var rneedsContext = jQuery.expr.match.needsContext;

var rsingleTag = ( /^<([a-z][^\/\0>:\x20\t\r\n\f]*)[\x20\t\r\n\f]*\/?>(?:<\/\1>|)$/i );



var risSimple = /^.[^:#\[\.,]*$/;

// Implement the identical functionality for filter and not
function winnow( elements, qualifier, not ) {
	if ( jQuery.isFunction( qualifier ) ) {
		return jQuery.grep( elements, function( elem, i ) {
			return !!qualifier.call( elem, i, elem ) !== not;
		} );
	}

	// Single element
	if ( qualifier.nodeType ) {
		return jQuery.grep( elements, function( elem ) {
			return ( elem === qualifier ) !== not;
		} );
	}

	// Arraylike of elements (jQuery, arguments, Array)
	if ( typeof qualifier !== "string" ) {
		return jQuery.grep( elements, function( elem ) {
			return ( indexOf.call( qualifier, elem ) > -1 ) !== not;
		} );
	}

	// Simple selector that can be filtered directly, removing non-Elements
	if ( risSimple.test( qualifier ) ) {
		return jQuery.filter( qualifier, elements, not );
	}

	// Complex selector, compare the two sets, removing non-Elements
	qualifier = jQuery.filter( qualifier, elements );
	return jQuery.grep( elements, function( elem ) {
		return ( indexOf.call( qualifier, elem ) > -1 ) !== not && elem.nodeType === 1;
	} );
}

jQuery.filter = function( expr, elems, not ) {
	var elem = elems[ 0 ];

	if ( not ) {
		expr = ":not(" + expr + ")";
	}

	if ( elems.length === 1 && elem.nodeType === 1 ) {
		return jQuery.find.matchesSelector( elem, expr ) ? [ elem ] : [];
	}

	return jQuery.find.matches( expr, jQuery.grep( elems, function( elem ) {
		return elem.nodeType === 1;
	} ) );
};

jQuery.fn.extend( {
	find: function( selector ) {
		var i, ret,
			len = this.length,
			self = this;

		if ( typeof selector !== "string" ) {
			return this.pushStack( jQuery( selector ).filter( function() {
				for ( i = 0; i < len; i++ ) {
					if ( jQuery.contains( self[ i ], this ) ) {
						return true;
					}
				}
			} ) );
		}

		ret = this.pushStack( [] );

		for ( i = 0; i < len; i++ ) {
			jQuery.find( selector, self[ i ], ret );
		}

		return len > 1 ? jQuery.uniqueSort( ret ) : ret;
	},
	filter: function( selector ) {
		return this.pushStack( winnow( this, selector || [], false ) );
	},
	not: function( selector ) {
		return this.pushStack( winnow( this, selector || [], true ) );
	},
	is: function( selector ) {
		return !!winnow(
			this,

			// If this is a positional/relative selector, check membership in the returned set
			// so $("p:first").is("p:last") won't return true for a doc with two "p".
			typeof selector === "string" && rneedsContext.test( selector ) ?
				jQuery( selector ) :
				selector || [],
			false
		).length;
	}
} );


// Initialize a jQuery object


// A central reference to the root jQuery(document)
var rootjQuery,

	// A simple way to check for HTML strings
	// Prioritize #id over <tag> to avoid XSS via location.hash (#9521)
	// Strict HTML recognition (#11290: must start with <)
	// Shortcut simple #id case for speed
	rquickExpr = /^(?:\s*(<[\w\W]+>)[^>]*|#([\w-]+))$/,

	init = jQuery.fn.init = function( selector, context, root ) {
		var match, elem;

		// HANDLE: $(""), $(null), $(undefined), $(false)
		if ( !selector ) {
			return this;
		}

		// Method init() accepts an alternate rootjQuery
		// so migrate can support jQuery.sub (gh-2101)
		root = root || rootjQuery;

		// Handle HTML strings
		if ( typeof selector === "string" ) {
			if ( selector[ 0 ] === "<" &&
				selector[ selector.length - 1 ] === ">" &&
				selector.length >= 3 ) {

				// Assume that strings that start and end with <> are HTML and skip the regex check
				match = [ null, selector, null ];

			} else {
				match = rquickExpr.exec( selector );
			}

			// Match html or make sure no context is specified for #id
			if ( match && ( match[ 1 ] || !context ) ) {

				// HANDLE: $(html) -> $(array)
				if ( match[ 1 ] ) {
					context = context instanceof jQuery ? context[ 0 ] : context;

					// Option to run scripts is true for back-compat
					// Intentionally let the error be thrown if parseHTML is not present
					jQuery.merge( this, jQuery.parseHTML(
						match[ 1 ],
						context && context.nodeType ? context.ownerDocument || context : document,
						true
					) );

					// HANDLE: $(html, props)
					if ( rsingleTag.test( match[ 1 ] ) && jQuery.isPlainObject( context ) ) {
						for ( match in context ) {

							// Properties of context are called as methods if possible
							if ( jQuery.isFunction( this[ match ] ) ) {
								this[ match ]( context[ match ] );

							// ...and otherwise set as attributes
							} else {
								this.attr( match, context[ match ] );
							}
						}
					}

					return this;

				// HANDLE: $(#id)
				} else {
					elem = document.getElementById( match[ 2 ] );

					if ( elem ) {

						// Inject the element directly into the jQuery object
						this[ 0 ] = elem;
						this.length = 1;
					}
					return this;
				}

			// HANDLE: $(expr, $(...))
			} else if ( !context || context.jquery ) {
				return ( context || root ).find( selector );

			// HANDLE: $(expr, context)
			// (which is just equivalent to: $(context).find(expr)
			} else {
				return this.constructor( context ).find( selector );
			}

		// HANDLE: $(DOMElement)
		} else if ( selector.nodeType ) {
			this[ 0 ] = selector;
			this.length = 1;
			return this;

		// HANDLE: $(function)
		// Shortcut for document ready
		} else if ( jQuery.isFunction( selector ) ) {
			return root.ready !== undefined ?
				root.ready( selector ) :

				// Execute immediately if ready is not present
				selector( jQuery );
		}

		return jQuery.makeArray( selector, this );
	};

// Give the init function the jQuery prototype for later instantiation
init.prototype = jQuery.fn;

// Initialize central reference
rootjQuery = jQuery( document );


var rparentsprev = /^(?:parents|prev(?:Until|All))/,

	// Methods guaranteed to produce a unique set when starting from a unique set
	guaranteedUnique = {
		children: true,
		contents: true,
		next: true,
		prev: true
	};

jQuery.fn.extend( {
	has: function( target ) {
		var targets = jQuery( target, this ),
			l = targets.length;

		return this.filter( function() {
			var i = 0;
			for ( ; i < l; i++ ) {
				if ( jQuery.contains( this, targets[ i ] ) ) {
					return true;
				}
			}
		} );
	},

	closest: function( selectors, context ) {
		var cur,
			i = 0,
			l = this.length,
			matched = [],
			targets = typeof selectors !== "string" && jQuery( selectors );

		// Positional selectors never match, since there's no _selection_ context
		if ( !rneedsContext.test( selectors ) ) {
			for ( ; i < l; i++ ) {
				for ( cur = this[ i ]; cur && cur !== context; cur = cur.parentNode ) {

					// Always skip document fragments
					if ( cur.nodeType < 11 && ( targets ?
						targets.index( cur ) > -1 :

						// Don't pass non-elements to Sizzle
						cur.nodeType === 1 &&
							jQuery.find.matchesSelector( cur, selectors ) ) ) {

						matched.push( cur );
						break;
					}
				}
			}
		}

		return this.pushStack( matched.length > 1 ? jQuery.uniqueSort( matched ) : matched );
	},

	// Determine the position of an element within the set
	index: function( elem ) {

		// No argument, return index in parent
		if ( !elem ) {
			return ( this[ 0 ] && this[ 0 ].parentNode ) ? this.first().prevAll().length : -1;
		}

		// Index in selector
		if ( typeof elem === "string" ) {
			return indexOf.call( jQuery( elem ), this[ 0 ] );
		}

		// Locate the position of the desired element
		return indexOf.call( this,

			// If it receives a jQuery object, the first element is used
			elem.jquery ? elem[ 0 ] : elem
		);
	},

	add: function( selector, context ) {
		return this.pushStack(
			jQuery.uniqueSort(
				jQuery.merge( this.get(), jQuery( selector, context ) )
			)
		);
	},

	addBack: function( selector ) {
		return this.add( selector == null ?
			this.prevObject : this.prevObject.filter( selector )
		);
	}
} );

function sibling( cur, dir ) {
	while ( ( cur = cur[ dir ] ) && cur.nodeType !== 1 ) {}
	return cur;
}

jQuery.each( {
	parent: function( elem ) {
		var parent = elem.parentNode;
		return parent && parent.nodeType !== 11 ? parent : null;
	},
	parents: function( elem ) {
		return dir( elem, "parentNode" );
	},
	parentsUntil: function( elem, i, until ) {
		return dir( elem, "parentNode", until );
	},
	next: function( elem ) {
		return sibling( elem, "nextSibling" );
	},
	prev: function( elem ) {
		return sibling( elem, "previousSibling" );
	},
	nextAll: function( elem ) {
		return dir( elem, "nextSibling" );
	},
	prevAll: function( elem ) {
		return dir( elem, "previousSibling" );
	},
	nextUntil: function( elem, i, until ) {
		return dir( elem, "nextSibling", until );
	},
	prevUntil: function( elem, i, until ) {
		return dir( elem, "previousSibling", until );
	},
	siblings: function( elem ) {
		return siblings( ( elem.parentNode || {} ).firstChild, elem );
	},
	children: function( elem ) {
		return siblings( elem.firstChild );
	},
	contents: function( elem ) {
		return elem.contentDocument || jQuery.merge( [], elem.childNodes );
	}
}, function( name, fn ) {
	jQuery.fn[ name ] = function( until, selector ) {
		var matched = jQuery.map( this, fn, until );

		if ( name.slice( -5 ) !== "Until" ) {
			selector = until;
		}

		if ( selector && typeof selector === "string" ) {
			matched = jQuery.filter( selector, matched );
		}

		if ( this.length > 1 ) {

			// Remove duplicates
			if ( !guaranteedUnique[ name ] ) {
				jQuery.uniqueSort( matched );
			}

			// Reverse order for parents* and prev-derivatives
			if ( rparentsprev.test( name ) ) {
				matched.reverse();
			}
		}

		return this.pushStack( matched );
	};
} );
var rnothtmlwhite = ( /[^\x20\t\r\n\f]+/g );



// Convert String-formatted options into Object-formatted ones
function createOptions( options ) {
	var object = {};
	jQuery.each( options.match( rnothtmlwhite ) || [], function( _, flag ) {
		object[ flag ] = true;
	} );
	return object;
}

/*
 * Create a callback list using the following parameters:
 *
 *	options: an optional list of space-separated options that will change how
 *			the callback list behaves or a more traditional option object
 *
 * By default a callback list will act like an event callback list and can be
 * "fired" multiple times.
 *
 * Possible options:
 *
 *	once:			will ensure the callback list can only be fired once (like a Deferred)
 *
 *	memory:			will keep track of previous values and will call any callback added
 *					after the list has been fired right away with the latest "memorized"
 *					values (like a Deferred)
 *
 *	unique:			will ensure a callback can only be added once (no duplicate in the list)
 *
 *	stopOnFalse:	interrupt callings when a callback returns false
 *
 */
jQuery.Callbacks = function( options ) {

	// Convert options from String-formatted to Object-formatted if needed
	// (we check in cache first)
	options = typeof options === "string" ?
		createOptions( options ) :
		jQuery.extend( {}, options );

	var // Flag to know if list is currently firing
		firing,

		// Last fire value for non-forgettable lists
		memory,

		// Flag to know if list was already fired
		fired,

		// Flag to prevent firing
		locked,

		// Actual callback list
		list = [],

		// Queue of execution data for repeatable lists
		queue = [],

		// Index of currently firing callback (modified by add/remove as needed)
		firingIndex = -1,

		// Fire callbacks
		fire = function() {

			// Enforce single-firing
			locked = options.once;

			// Execute callbacks for all pending executions,
			// respecting firingIndex overrides and runtime changes
			fired = firing = true;
			for ( ; queue.length; firingIndex = -1 ) {
				memory = queue.shift();
				while ( ++firingIndex < list.length ) {

					// Run callback and check for early termination
					if ( list[ firingIndex ].apply( memory[ 0 ], memory[ 1 ] ) === false &&
						options.stopOnFalse ) {

						// Jump to end and forget the data so .add doesn't re-fire
						firingIndex = list.length;
						memory = false;
					}
				}
			}

			// Forget the data if we're done with it
			if ( !options.memory ) {
				memory = false;
			}

			firing = false;

			// Clean up if we're done firing for good
			if ( locked ) {

				// Keep an empty list if we have data for future add calls
				if ( memory ) {
					list = [];

				// Otherwise, this object is spent
				} else {
					list = "";
				}
			}
		},

		// Actual Callbacks object
		self = {

			// Add a callback or a collection of callbacks to the list
			add: function() {
				if ( list ) {

					// If we have memory from a past run, we should fire after adding
					if ( memory && !firing ) {
						firingIndex = list.length - 1;
						queue.push( memory );
					}

					( function add( args ) {
						jQuery.each( args, function( _, arg ) {
							if ( jQuery.isFunction( arg ) ) {
								if ( !options.unique || !self.has( arg ) ) {
									list.push( arg );
								}
							} else if ( arg && arg.length && jQuery.type( arg ) !== "string" ) {

								// Inspect recursively
								add( arg );
							}
						} );
					} )( arguments );

					if ( memory && !firing ) {
						fire();
					}
				}
				return this;
			},

			// Remove a callback from the list
			remove: function() {
				jQuery.each( arguments, function( _, arg ) {
					var index;
					while ( ( index = jQuery.inArray( arg, list, index ) ) > -1 ) {
						list.splice( index, 1 );

						// Handle firing indexes
						if ( index <= firingIndex ) {
							firingIndex--;
						}
					}
				} );
				return this;
			},

			// Check if a given callback is in the list.
			// If no argument is given, return whether or not list has callbacks attached.
			has: function( fn ) {
				return fn ?
					jQuery.inArray( fn, list ) > -1 :
					list.length > 0;
			},

			// Remove all callbacks from the list
			empty: function() {
				if ( list ) {
					list = [];
				}
				return this;
			},

			// Disable .fire and .add
			// Abort any current/pending executions
			// Clear all callbacks and values
			disable: function() {
				locked = queue = [];
				list = memory = "";
				return this;
			},
			disabled: function() {
				return !list;
			},

			// Disable .fire
			// Also disable .add unless we have memory (since it would have no effect)
			// Abort any pending executions
			lock: function() {
				locked = queue = [];
				if ( !memory && !firing ) {
					list = memory = "";
				}
				return this;
			},
			locked: function() {
				return !!locked;
			},

			// Call all callbacks with the given context and arguments
			fireWith: function( context, args ) {
				if ( !locked ) {
					args = args || [];
					args = [ context, args.slice ? args.slice() : args ];
					queue.push( args );
					if ( !firing ) {
						fire();
					}
				}
				return this;
			},

			// Call all the callbacks with the given arguments
			fire: function() {
				self.fireWith( this, arguments );
				return this;
			},

			// To know if the callbacks have already been called at least once
			fired: function() {
				return !!fired;
			}
		};

	return self;
};


function Identity( v ) {
	return v;
}
function Thrower( ex ) {
	throw ex;
}

function adoptValue( value, resolve, reject ) {
	var method;

	try {

		// Check for promise aspect first to privilege synchronous behavior
		if ( value && jQuery.isFunction( ( method = value.promise ) ) ) {
			method.call( value ).done( resolve ).fail( reject );

		// Other thenables
		} else if ( value && jQuery.isFunction( ( method = value.then ) ) ) {
			method.call( value, resolve, reject );

		// Other non-thenables
		} else {

			// Support: Android 4.0 only
			// Strict mode functions invoked without .call/.apply get global-object context
			resolve.call( undefined, value );
		}

	// For Promises/A+, convert exceptions into rejections
	// Since jQuery.when doesn't unwrap thenables, we can skip the extra checks appearing in
	// Deferred#then to conditionally suppress rejection.
	} catch ( value ) {

		// Support: Android 4.0 only
		// Strict mode functions invoked without .call/.apply get global-object context
		reject.call( undefined, value );
	}
}

jQuery.extend( {

	Deferred: function( func ) {
		var tuples = [

				// action, add listener, callbacks,
				// ... .then handlers, argument index, [final state]
				[ "notify", "progress", jQuery.Callbacks( "memory" ),
					jQuery.Callbacks( "memory" ), 2 ],
				[ "resolve", "done", jQuery.Callbacks( "once memory" ),
					jQuery.Callbacks( "once memory" ), 0, "resolved" ],
				[ "reject", "fail", jQuery.Callbacks( "once memory" ),
					jQuery.Callbacks( "once memory" ), 1, "rejected" ]
			],
			state = "pending",
			promise = {
				state: function() {
					return state;
				},
				always: function() {
					deferred.done( arguments ).fail( arguments );
					return this;
				},
				"catch": function( fn ) {
					return promise.then( null, fn );
				},

				// Keep pipe for back-compat
				pipe: function( /* fnDone, fnFail, fnProgress */ ) {
					var fns = arguments;

					return jQuery.Deferred( function( newDefer ) {
						jQuery.each( tuples, function( i, tuple ) {

							// Map tuples (progress, done, fail) to arguments (done, fail, progress)
							var fn = jQuery.isFunction( fns[ tuple[ 4 ] ] ) && fns[ tuple[ 4 ] ];

							// deferred.progress(function() { bind to newDefer or newDefer.notify })
							// deferred.done(function() { bind to newDefer or newDefer.resolve })
							// deferred.fail(function() { bind to newDefer or newDefer.reject })
							deferred[ tuple[ 1 ] ]( function() {
								var returned = fn && fn.apply( this, arguments );
								if ( returned && jQuery.isFunction( returned.promise ) ) {
									returned.promise()
										.progress( newDefer.notify )
										.done( newDefer.resolve )
										.fail( newDefer.reject );
								} else {
									newDefer[ tuple[ 0 ] + "With" ](
										this,
										fn ? [ returned ] : arguments
									);
								}
							} );
						} );
						fns = null;
					} ).promise();
				},
				then: function( onFulfilled, onRejected, onProgress ) {
					var maxDepth = 0;
					function resolve( depth, deferred, handler, special ) {
						return function() {
							var that = this,
								args = arguments,
								mightThrow = function() {
									var returned, then;

									// Support: Promises/A+ section 2.3.3.3.3
									// https://promisesaplus.com/#point-59
									// Ignore double-resolution attempts
									if ( depth < maxDepth ) {
										return;
									}

									returned = handler.apply( that, args );

									// Support: Promises/A+ section 2.3.1
									// https://promisesaplus.com/#point-48
									if ( returned === deferred.promise() ) {
										throw new TypeError( "Thenable self-resolution" );
									}

									// Support: Promises/A+ sections 2.3.3.1, 3.5
									// https://promisesaplus.com/#point-54
									// https://promisesaplus.com/#point-75
									// Retrieve `then` only once
									then = returned &&

										// Support: Promises/A+ section 2.3.4
										// https://promisesaplus.com/#point-64
										// Only check objects and functions for thenability
										( typeof returned === "object" ||
											typeof returned === "function" ) &&
										returned.then;

									// Handle a returned thenable
									if ( jQuery.isFunction( then ) ) {

										// Special processors (notify) just wait for resolution
										if ( special ) {
											then.call(
												returned,
												resolve( maxDepth, deferred, Identity, special ),
												resolve( maxDepth, deferred, Thrower, special )
											);

										// Normal processors (resolve) also hook into progress
										} else {

											// ...and disregard older resolution values
											maxDepth++;

											then.call(
												returned,
												resolve( maxDepth, deferred, Identity, special ),
												resolve( maxDepth, deferred, Thrower, special ),
												resolve( maxDepth, deferred, Identity,
													deferred.notifyWith )
											);
										}

									// Handle all other returned values
									} else {

										// Only substitute handlers pass on context
										// and multiple values (non-spec behavior)
										if ( handler !== Identity ) {
											that = undefined;
											args = [ returned ];
										}

										// Process the value(s)
										// Default process is resolve
										( special || deferred.resolveWith )( that, args );
									}
								},

								// Only normal processors (resolve) catch and reject exceptions
								process = special ?
									mightThrow :
									function() {
										try {
											mightThrow();
										} catch ( e ) {

											if ( jQuery.Deferred.exceptionHook ) {
												jQuery.Deferred.exceptionHook( e,
													process.stackTrace );
											}

											// Support: Promises/A+ section 2.3.3.3.4.1
											// https://promisesaplus.com/#point-61
											// Ignore post-resolution exceptions
											if ( depth + 1 >= maxDepth ) {

												// Only substitute handlers pass on context
												// and multiple values (non-spec behavior)
												if ( handler !== Thrower ) {
													that = undefined;
													args = [ e ];
												}

												deferred.rejectWith( that, args );
											}
										}
									};

							// Support: Promises/A+ section 2.3.3.3.1
							// https://promisesaplus.com/#point-57
							// Re-resolve promises immediately to dodge false rejection from
							// subsequent errors
							if ( depth ) {
								process();
							} else {

								// Call an optional hook to record the stack, in case of exception
								// since it's otherwise lost when execution goes async
								if ( jQuery.Deferred.getStackHook ) {
									process.stackTrace = jQuery.Deferred.getStackHook();
								}
								window.setTimeout( process );
							}
						};
					}

					return jQuery.Deferred( function( newDefer ) {

						// progress_handlers.add( ... )
						tuples[ 0 ][ 3 ].add(
							resolve(
								0,
								newDefer,
								jQuery.isFunction( onProgress ) ?
									onProgress :
									Identity,
								newDefer.notifyWith
							)
						);

						// fulfilled_handlers.add( ... )
						tuples[ 1 ][ 3 ].add(
							resolve(
								0,
								newDefer,
								jQuery.isFunction( onFulfilled ) ?
									onFulfilled :
									Identity
							)
						);

						// rejected_handlers.add( ... )
						tuples[ 2 ][ 3 ].add(
							resolve(
								0,
								newDefer,
								jQuery.isFunction( onRejected ) ?
									onRejected :
									Thrower
							)
						);
					} ).promise();
				},

				// Get a promise for this deferred
				// If obj is provided, the promise aspect is added to the object
				promise: function( obj ) {
					return obj != null ? jQuery.extend( obj, promise ) : promise;
				}
			},
			deferred = {};

		// Add list-specific methods
		jQuery.each( tuples, function( i, tuple ) {
			var list = tuple[ 2 ],
				stateString = tuple[ 5 ];

			// promise.progress = list.add
			// promise.done = list.add
			// promise.fail = list.add
			promise[ tuple[ 1 ] ] = list.add;

			// Handle state
			if ( stateString ) {
				list.add(
					function() {

						// state = "resolved" (i.e., fulfilled)
						// state = "rejected"
						state = stateString;
					},

					// rejected_callbacks.disable
					// fulfilled_callbacks.disable
					tuples[ 3 - i ][ 2 ].disable,

					// progress_callbacks.lock
					tuples[ 0 ][ 2 ].lock
				);
			}

			// progress_handlers.fire
			// fulfilled_handlers.fire
			// rejected_handlers.fire
			list.add( tuple[ 3 ].fire );

			// deferred.notify = function() { deferred.notifyWith(...) }
			// deferred.resolve = function() { deferred.resolveWith(...) }
			// deferred.reject = function() { deferred.rejectWith(...) }
			deferred[ tuple[ 0 ] ] = function() {
				deferred[ tuple[ 0 ] + "With" ]( this === deferred ? undefined : this, arguments );
				return this;
			};

			// deferred.notifyWith = list.fireWith
			// deferred.resolveWith = list.fireWith
			// deferred.rejectWith = list.fireWith
			deferred[ tuple[ 0 ] + "With" ] = list.fireWith;
		} );

		// Make the deferred a promise
		promise.promise( deferred );

		// Call given func if any
		if ( func ) {
			func.call( deferred, deferred );
		}

		// All done!
		return deferred;
	},

	// Deferred helper
	when: function( singleValue ) {
		var

			// count of uncompleted subordinates
			remaining = arguments.length,

			// count of unprocessed arguments
			i = remaining,

			// subordinate fulfillment data
			resolveContexts = Array( i ),
			resolveValues = slice.call( arguments ),

			// the master Deferred
			master = jQuery.Deferred(),

			// subordinate callback factory
			updateFunc = function( i ) {
				return function( value ) {
					resolveContexts[ i ] = this;
					resolveValues[ i ] = arguments.length > 1 ? slice.call( arguments ) : value;
					if ( !( --remaining ) ) {
						master.resolveWith( resolveContexts, resolveValues );
					}
				};
			};

		// Single- and empty arguments are adopted like Promise.resolve
		if ( remaining <= 1 ) {
			adoptValue( singleValue, master.done( updateFunc( i ) ).resolve, master.reject );

			// Use .then() to unwrap secondary thenables (cf. gh-3000)
			if ( master.state() === "pending" ||
				jQuery.isFunction( resolveValues[ i ] && resolveValues[ i ].then ) ) {

				return master.then();
			}
		}

		// Multiple arguments are aggregated like Promise.all array elements
		while ( i-- ) {
			adoptValue( resolveValues[ i ], updateFunc( i ), master.reject );
		}

		return master.promise();
	}
} );


// These usually indicate a programmer mistake during development,
// warn about them ASAP rather than swallowing them by default.
var rerrorNames = /^(Eval|Internal|Range|Reference|Syntax|Type|URI)Error$/;

jQuery.Deferred.exceptionHook = function( error, stack ) {

	// Support: IE 8 - 9 only
	// Console exists when dev tools are open, which can happen at any time
	if ( window.console && window.console.warn && error && rerrorNames.test( error.name ) ) {
		window.console.warn( "jQuery.Deferred exception: " + error.message, error.stack, stack );
	}
};




jQuery.readyException = function( error ) {
	window.setTimeout( function() {
		throw error;
	} );
};




// The deferred used on DOM ready
var readyList = jQuery.Deferred();

jQuery.fn.ready = function( fn ) {

	readyList
		.then( fn )

		// Wrap jQuery.readyException in a function so that the lookup
		// happens at the time of error handling instead of callback
		// registration.
		.catch( function( error ) {
			jQuery.readyException( error );
		} );

	return this;
};

jQuery.extend( {

	// Is the DOM ready to be used? Set to true once it occurs.
	isReady: false,

	// A counter to track how many items to wait for before
	// the ready event fires. See #6781
	readyWait: 1,

	// Hold (or release) the ready event
	holdReady: function( hold ) {
		if ( hold ) {
			jQuery.readyWait++;
		} else {
			jQuery.ready( true );
		}
	},

	// Handle when the DOM is ready
	ready: function( wait ) {

		// Abort if there are pending holds or we're already ready
		if ( wait === true ? --jQuery.readyWait : jQuery.isReady ) {
			return;
		}

		// Remember that the DOM is ready
		jQuery.isReady = true;

		// If a normal DOM Ready event fired, decrement, and wait if need be
		if ( wait !== true && --jQuery.readyWait > 0 ) {
			return;
		}

		// If there are functions bound, to execute
		readyList.resolveWith( document, [ jQuery ] );
	}
} );

jQuery.ready.then = readyList.then;

// The ready event handler and self cleanup method
function completed() {
	document.removeEventListener( "DOMContentLoaded", completed );
	window.removeEventListener( "load", completed );
	jQuery.ready();
}

// Catch cases where $(document).ready() is called
// after the browser event has already occurred.
// Support: IE <=9 - 10 only
// Older IE sometimes signals "interactive" too soon
if ( document.readyState === "complete" ||
	( document.readyState !== "loading" && !document.documentElement.doScroll ) ) {

	// Handle it asynchronously to allow scripts the opportunity to delay ready
	window.setTimeout( jQuery.ready );

} else {

	// Use the handy event callback
	document.addEventListener( "DOMContentLoaded", completed );

	// A fallback to window.onload, that will always work
	window.addEventListener( "load", completed );
}




// Multifunctional method to get and set values of a collection
// The value/s can optionally be executed if it's a function
var access = function( elems, fn, key, value, chainable, emptyGet, raw ) {
	var i = 0,
		len = elems.length,
		bulk = key == null;

	// Sets many values
	if ( jQuery.type( key ) === "object" ) {
		chainable = true;
		for ( i in key ) {
			access( elems, fn, i, key[ i ], true, emptyGet, raw );
		}

	// Sets one value
	} else if ( value !== undefined ) {
		chainable = true;

		if ( !jQuery.isFunction( value ) ) {
			raw = true;
		}

		if ( bulk ) {

			// Bulk operations run against the entire set
			if ( raw ) {
				fn.call( elems, value );
				fn = null;

			// ...except when executing function values
			} else {
				bulk = fn;
				fn = function( elem, key, value ) {
					return bulk.call( jQuery( elem ), value );
				};
			}
		}

		if ( fn ) {
			for ( ; i < len; i++ ) {
				fn(
					elems[ i ], key, raw ?
					value :
					value.call( elems[ i ], i, fn( elems[ i ], key ) )
				);
			}
		}
	}

	if ( chainable ) {
		return elems;
	}

	// Gets
	if ( bulk ) {
		return fn.call( elems );
	}

	return len ? fn( elems[ 0 ], key ) : emptyGet;
};
var acceptData = function( owner ) {

	// Accepts only:
	//  - Node
	//    - Node.ELEMENT_NODE
	//    - Node.DOCUMENT_NODE
	//  - Object
	//    - Any
	return owner.nodeType === 1 || owner.nodeType === 9 || !( +owner.nodeType );
};




function Data() {
	this.expando = jQuery.expando + Data.uid++;
}

Data.uid = 1;

Data.prototype = {

	cache: function( owner ) {

		// Check if the owner object already has a cache
		var value = owner[ this.expando ];

		// If not, create one
		if ( !value ) {
			value = {};

			// We can accept data for non-element nodes in modern browsers,
			// but we should not, see #8335.
			// Always return an empty object.
			if ( acceptData( owner ) ) {

				// If it is a node unlikely to be stringify-ed or looped over
				// use plain assignment
				if ( owner.nodeType ) {
					owner[ this.expando ] = value;

				// Otherwise secure it in a non-enumerable property
				// configurable must be true to allow the property to be
				// deleted when data is removed
				} else {
					Object.defineProperty( owner, this.expando, {
						value: value,
						configurable: true
					} );
				}
			}
		}

		return value;
	},
	set: function( owner, data, value ) {
		var prop,
			cache = this.cache( owner );

		// Handle: [ owner, key, value ] args
		// Always use camelCase key (gh-2257)
		if ( typeof data === "string" ) {
			cache[ jQuery.camelCase( data ) ] = value;

		// Handle: [ owner, { properties } ] args
		} else {

			// Copy the properties one-by-one to the cache object
			for ( prop in data ) {
				cache[ jQuery.camelCase( prop ) ] = data[ prop ];
			}
		}
		return cache;
	},
	get: function( owner, key ) {
		return key === undefined ?
			this.cache( owner ) :

			// Always use camelCase key (gh-2257)
			owner[ this.expando ] && owner[ this.expando ][ jQuery.camelCase( key ) ];
	},
	access: function( owner, key, value ) {

		// In cases where either:
		//
		//   1. No key was specified
		//   2. A string key was specified, but no value provided
		//
		// Take the "read" path and allow the get method to determine
		// which value to return, respectively either:
		//
		//   1. The entire cache object
		//   2. The data stored at the key
		//
		if ( key === undefined ||
				( ( key && typeof key === "string" ) && value === undefined ) ) {

			return this.get( owner, key );
		}

		// When the key is not a string, or both a key and value
		// are specified, set or extend (existing objects) with either:
		//
		//   1. An object of properties
		//   2. A key and value
		//
		this.set( owner, key, value );

		// Since the "set" path can have two possible entry points
		// return the expected data based on which path was taken[*]
		return value !== undefined ? value : key;
	},
	remove: function( owner, key ) {
		var i,
			cache = owner[ this.expando ];

		if ( cache === undefined ) {
			return;
		}

		if ( key !== undefined ) {

			// Support array or space separated string of keys
			if ( jQuery.isArray( key ) ) {

				// If key is an array of keys...
				// We always set camelCase keys, so remove that.
				key = key.map( jQuery.camelCase );
			} else {
				key = jQuery.camelCase( key );

				// If a key with the spaces exists, use it.
				// Otherwise, create an array by matching non-whitespace
				key = key in cache ?
					[ key ] :
					( key.match( rnothtmlwhite ) || [] );
			}

			i = key.length;

			while ( i-- ) {
				delete cache[ key[ i ] ];
			}
		}

		// Remove the expando if there's no more data
		if ( key === undefined || jQuery.isEmptyObject( cache ) ) {

			// Support: Chrome <=35 - 45
			// Webkit & Blink performance suffers when deleting properties
			// from DOM nodes, so set to undefined instead
			// https://bugs.chromium.org/p/chromium/issues/detail?id=378607 (bug restricted)
			if ( owner.nodeType ) {
				owner[ this.expando ] = undefined;
			} else {
				delete owner[ this.expando ];
			}
		}
	},
	hasData: function( owner ) {
		var cache = owner[ this.expando ];
		return cache !== undefined && !jQuery.isEmptyObject( cache );
	}
};
var dataPriv = new Data();

var dataUser = new Data();



//	Implementation Summary
//
//	1. Enforce API surface and semantic compatibility with 1.9.x branch
//	2. Improve the module's maintainability by reducing the storage
//		paths to a single mechanism.
//	3. Use the same single mechanism to support "private" and "user" data.
//	4. _Never_ expose "private" data to user code (TODO: Drop _data, _removeData)
//	5. Avoid exposing implementation details on user objects (eg. expando properties)
//	6. Provide a clear path for implementation upgrade to WeakMap in 2014

var rbrace = /^(?:\{[\w\W]*\}|\[[\w\W]*\])$/,
	rmultiDash = /[A-Z]/g;

function getData( data ) {
	if ( data === "true" ) {
		return true;
	}

	if ( data === "false" ) {
		return false;
	}

	if ( data === "null" ) {
		return null;
	}

	// Only convert to a number if it doesn't change the string
	if ( data === +data + "" ) {
		return +data;
	}

	if ( rbrace.test( data ) ) {
		return JSON.parse( data );
	}

	return data;
}

function dataAttr( elem, key, data ) {
	var name;

	// If nothing was found internally, try to fetch any
	// data from the HTML5 data-* attribute
	if ( data === undefined && elem.nodeType === 1 ) {
		name = "data-" + key.replace( rmultiDash, "-$&" ).toLowerCase();
		data = elem.getAttribute( name );

		if ( typeof data === "string" ) {
			try {
				data = getData( data );
			} catch ( e ) {}

			// Make sure we set the data so it isn't changed later
			dataUser.set( elem, key, data );
		} else {
			data = undefined;
		}
	}
	return data;
}

jQuery.extend( {
	hasData: function( elem ) {
		return dataUser.hasData( elem ) || dataPriv.hasData( elem );
	},

	data: function( elem, name, data ) {
		return dataUser.access( elem, name, data );
	},

	removeData: function( elem, name ) {
		dataUser.remove( elem, name );
	},

	// TODO: Now that all calls to _data and _removeData have been replaced
	// with direct calls to dataPriv methods, these can be deprecated.
	_data: function( elem, name, data ) {
		return dataPriv.access( elem, name, data );
	},

	_removeData: function( elem, name ) {
		dataPriv.remove( elem, name );
	}
} );

jQuery.fn.extend( {
	data: function( key, value ) {
		var i, name, data,
			elem = this[ 0 ],
			attrs = elem && elem.attributes;

		// Gets all values
		if ( key === undefined ) {
			if ( this.length ) {
				data = dataUser.get( elem );

				if ( elem.nodeType === 1 && !dataPriv.get( elem, "hasDataAttrs" ) ) {
					i = attrs.length;
					while ( i-- ) {

						// Support: IE 11 only
						// The attrs elements can be null (#14894)
						if ( attrs[ i ] ) {
							name = attrs[ i ].name;
							if ( name.indexOf( "data-" ) === 0 ) {
								name = jQuery.camelCase( name.slice( 5 ) );
								dataAttr( elem, name, data[ name ] );
							}
						}
					}
					dataPriv.set( elem, "hasDataAttrs", true );
				}
			}

			return data;
		}

		// Sets multiple values
		if ( typeof key === "object" ) {
			return this.each( function() {
				dataUser.set( this, key );
			} );
		}

		return access( this, function( value ) {
			var data;

			// The calling jQuery object (element matches) is not empty
			// (and therefore has an element appears at this[ 0 ]) and the
			// `value` parameter was not undefined. An empty jQuery object
			// will result in `undefined` for elem = this[ 0 ] which will
			// throw an exception if an attempt to read a data cache is made.
			if ( elem && value === undefined ) {

				// Attempt to get data from the cache
				// The key will always be camelCased in Data
				data = dataUser.get( elem, key );
				if ( data !== undefined ) {
					return data;
				}

				// Attempt to "discover" the data in
				// HTML5 custom data-* attrs
				data = dataAttr( elem, key );
				if ( data !== undefined ) {
					return data;
				}

				// We tried really hard, but the data doesn't exist.
				return;
			}

			// Set the data...
			this.each( function() {

				// We always store the camelCased key
				dataUser.set( this, key, value );
			} );
		}, null, value, arguments.length > 1, null, true );
	},

	removeData: function( key ) {
		return this.each( function() {
			dataUser.remove( this, key );
		} );
	}
} );


jQuery.extend( {
	queue: function( elem, type, data ) {
		var queue;

		if ( elem ) {
			type = ( type || "fx" ) + "queue";
			queue = dataPriv.get( elem, type );

			// Speed up dequeue by getting out quickly if this is just a lookup
			if ( data ) {
				if ( !queue || jQuery.isArray( data ) ) {
					queue = dataPriv.access( elem, type, jQuery.makeArray( data ) );
				} else {
					queue.push( data );
				}
			}
			return queue || [];
		}
	},

	dequeue: function( elem, type ) {
		type = type || "fx";

		var queue = jQuery.queue( elem, type ),
			startLength = queue.length,
			fn = queue.shift(),
			hooks = jQuery._queueHooks( elem, type ),
			next = function() {
				jQuery.dequeue( elem, type );
			};

		// If the fx queue is dequeued, always remove the progress sentinel
		if ( fn === "inprogress" ) {
			fn = queue.shift();
			startLength--;
		}

		if ( fn ) {

			// Add a progress sentinel to prevent the fx queue from being
			// automatically dequeued
			if ( type === "fx" ) {
				queue.unshift( "inprogress" );
			}

			// Clear up the last queue stop function
			delete hooks.stop;
			fn.call( elem, next, hooks );
		}

		if ( !startLength && hooks ) {
			hooks.empty.fire();
		}
	},

	// Not public - generate a queueHooks object, or return the current one
	_queueHooks: function( elem, type ) {
		var key = type + "queueHooks";
		return dataPriv.get( elem, key ) || dataPriv.access( elem, key, {
			empty: jQuery.Callbacks( "once memory" ).add( function() {
				dataPriv.remove( elem, [ type + "queue", key ] );
			} )
		} );
	}
} );

jQuery.fn.extend( {
	queue: function( type, data ) {
		var setter = 2;

		if ( typeof type !== "string" ) {
			data = type;
			type = "fx";
			setter--;
		}

		if ( arguments.length < setter ) {
			return jQuery.queue( this[ 0 ], type );
		}

		return data === undefined ?
			this :
			this.each( function() {
				var queue = jQuery.queue( this, type, data );

				// Ensure a hooks for this queue
				jQuery._queueHooks( this, type );

				if ( type === "fx" && queue[ 0 ] !== "inprogress" ) {
					jQuery.dequeue( this, type );
				}
			} );
	},
	dequeue: function( type ) {
		return this.each( function() {
			jQuery.dequeue( this, type );
		} );
	},
	clearQueue: function( type ) {
		return this.queue( type || "fx", [] );
	},

	// Get a promise resolved when queues of a certain type
	// are emptied (fx is the type by default)
	promise: function( type, obj ) {
		var tmp,
			count = 1,
			defer = jQuery.Deferred(),
			elements = this,
			i = this.length,
			resolve = function() {
				if ( !( --count ) ) {
					defer.resolveWith( elements, [ elements ] );
				}
			};

		if ( typeof type !== "string" ) {
			obj = type;
			type = undefined;
		}
		type = type || "fx";

		while ( i-- ) {
			tmp = dataPriv.get( elements[ i ], type + "queueHooks" );
			if ( tmp && tmp.empty ) {
				count++;
				tmp.empty.add( resolve );
			}
		}
		resolve();
		return defer.promise( obj );
	}
} );
var pnum = ( /[+-]?(?:\d*\.|)\d+(?:[eE][+-]?\d+|)/ ).source;

var rcssNum = new RegExp( "^(?:([+-])=|)(" + pnum + ")([a-z%]*)$", "i" );


var cssExpand = [ "Top", "Right", "Bottom", "Left" ];

var isHiddenWithinTree = function( elem, el ) {

		// isHiddenWithinTree might be called from jQuery#filter function;
		// in that case, element will be second argument
		elem = el || elem;

		// Inline style trumps all
		return elem.style.display === "none" ||
			elem.style.display === "" &&

			// Otherwise, check computed style
			// Support: Firefox <=43 - 45
			// Disconnected elements can have computed display: none, so first confirm that elem is
			// in the document.
			jQuery.contains( elem.ownerDocument, elem ) &&

			jQuery.css( elem, "display" ) === "none";
	};

var swap = function( elem, options, callback, args ) {
	var ret, name,
		old = {};

	// Remember the old values, and insert the new ones
	for ( name in options ) {
		old[ name ] = elem.style[ name ];
		elem.style[ name ] = options[ name ];
	}

	ret = callback.apply( elem, args || [] );

	// Revert the old values
	for ( name in options ) {
		elem.style[ name ] = old[ name ];
	}

	return ret;
};




function adjustCSS( elem, prop, valueParts, tween ) {
	var adjusted,
		scale = 1,
		maxIterations = 20,
		currentValue = tween ?
			function() {
				return tween.cur();
			} :
			function() {
				return jQuery.css( elem, prop, "" );
			},
		initial = currentValue(),
		unit = valueParts && valueParts[ 3 ] || ( jQuery.cssNumber[ prop ] ? "" : "px" ),

		// Starting value computation is required for potential unit mismatches
		initialInUnit = ( jQuery.cssNumber[ prop ] || unit !== "px" && +initial ) &&
			rcssNum.exec( jQuery.css( elem, prop ) );

	if ( initialInUnit && initialInUnit[ 3 ] !== unit ) {

		// Trust units reported by jQuery.css
		unit = unit || initialInUnit[ 3 ];

		// Make sure we update the tween properties later on
		valueParts = valueParts || [];

		// Iteratively approximate from a nonzero starting point
		initialInUnit = +initial || 1;

		do {

			// If previous iteration zeroed out, double until we get *something*.
			// Use string for doubling so we don't accidentally see scale as unchanged below
			scale = scale || ".5";

			// Adjust and apply
			initialInUnit = initialInUnit / scale;
			jQuery.style( elem, prop, initialInUnit + unit );

		// Update scale, tolerating zero or NaN from tween.cur()
		// Break the loop if scale is unchanged or perfect, or if we've just had enough.
		} while (
			scale !== ( scale = currentValue() / initial ) && scale !== 1 && --maxIterations
		);
	}

	if ( valueParts ) {
		initialInUnit = +initialInUnit || +initial || 0;

		// Apply relative offset (+=/-=) if specified
		adjusted = valueParts[ 1 ] ?
			initialInUnit + ( valueParts[ 1 ] + 1 ) * valueParts[ 2 ] :
			+valueParts[ 2 ];
		if ( tween ) {
			tween.unit = unit;
			tween.start = initialInUnit;
			tween.end = adjusted;
		}
	}
	return adjusted;
}


var defaultDisplayMap = {};

function getDefaultDisplay( elem ) {
	var temp,
		doc = elem.ownerDocument,
		nodeName = elem.nodeName,
		display = defaultDisplayMap[ nodeName ];

	if ( display ) {
		return display;
	}

	temp = doc.body.appendChild( doc.createElement( nodeName ) );
	display = jQuery.css( temp, "display" );

	temp.parentNode.removeChild( temp );

	if ( display === "none" ) {
		display = "block";
	}
	defaultDisplayMap[ nodeName ] = display;

	return display;
}

function showHide( elements, show ) {
	var display, elem,
		values = [],
		index = 0,
		length = elements.length;

	// Determine new display value for elements that need to change
	for ( ; index < length; index++ ) {
		elem = elements[ index ];
		if ( !elem.style ) {
			continue;
		}

		display = elem.style.display;
		if ( show ) {

			// Since we force visibility upon cascade-hidden elements, an immediate (and slow)
			// check is required in this first loop unless we have a nonempty display value (either
			// inline or about-to-be-restored)
			if ( display === "none" ) {
				values[ index ] = dataPriv.get( elem, "display" ) || null;
				if ( !values[ index ] ) {
					elem.style.display = "";
				}
			}
			if ( elem.style.display === "" && isHiddenWithinTree( elem ) ) {
				values[ index ] = getDefaultDisplay( elem );
			}
		} else {
			if ( display !== "none" ) {
				values[ index ] = "none";

				// Remember what we're overwriting
				dataPriv.set( elem, "display", display );
			}
		}
	}

	// Set the display of the elements in a second loop to avoid constant reflow
	for ( index = 0; index < length; index++ ) {
		if ( values[ index ] != null ) {
			elements[ index ].style.display = values[ index ];
		}
	}

	return elements;
}

jQuery.fn.extend( {
	show: function() {
		return showHide( this, true );
	},
	hide: function() {
		return showHide( this );
	},
	toggle: function( state ) {
		if ( typeof state === "boolean" ) {
			return state ? this.show() : this.hide();
		}

		return this.each( function() {
			if ( isHiddenWithinTree( this ) ) {
				jQuery( this ).show();
			} else {
				jQuery( this ).hide();
			}
		} );
	}
} );
var rcheckableType = ( /^(?:checkbox|radio)$/i );

var rtagName = ( /<([a-z][^\/\0>\x20\t\r\n\f]+)/i );

var rscriptType = ( /^$|\/(?:java|ecma)script/i );



// We have to close these tags to support XHTML (#13200)
var wrapMap = {

	// Support: IE <=9 only
	option: [ 1, "<select multiple='multiple'>", "</select>" ],

	// XHTML parsers do not magically insert elements in the
	// same way that tag soup parsers do. So we cannot shorten
	// this by omitting <tbody> or other required elements.
	thead: [ 1, "<table>", "</table>" ],
	col: [ 2, "<table><colgroup>", "</colgroup></table>" ],
	tr: [ 2, "<table><tbody>", "</tbody></table>" ],
	td: [ 3, "<table><tbody><tr>", "</tr></tbody></table>" ],

	_default: [ 0, "", "" ]
};

// Support: IE <=9 only
wrapMap.optgroup = wrapMap.option;

wrapMap.tbody = wrapMap.tfoot = wrapMap.colgroup = wrapMap.caption = wrapMap.thead;
wrapMap.th = wrapMap.td;


function getAll( context, tag ) {

	// Support: IE <=9 - 11 only
	// Use typeof to avoid zero-argument method invocation on host objects (#15151)
	var ret;

	if ( typeof context.getElementsByTagName !== "undefined" ) {
		ret = context.getElementsByTagName( tag || "*" );

	} else if ( typeof context.querySelectorAll !== "undefined" ) {
		ret = context.querySelectorAll( tag || "*" );

	} else {
		ret = [];
	}

	if ( tag === undefined || tag && jQuery.nodeName( context, tag ) ) {
		return jQuery.merge( [ context ], ret );
	}

	return ret;
}


// Mark scripts as having already been evaluated
function setGlobalEval( elems, refElements ) {
	var i = 0,
		l = elems.length;

	for ( ; i < l; i++ ) {
		dataPriv.set(
			elems[ i ],
			"globalEval",
			!refElements || dataPriv.get( refElements[ i ], "globalEval" )
		);
	}
}


var rhtml = /<|&#?\w+;/;

function buildFragment( elems, context, scripts, selection, ignored ) {
	var elem, tmp, tag, wrap, contains, j,
		fragment = context.createDocumentFragment(),
		nodes = [],
		i = 0,
		l = elems.length;

	for ( ; i < l; i++ ) {
		elem = elems[ i ];

		if ( elem || elem === 0 ) {

			// Add nodes directly
			if ( jQuery.type( elem ) === "object" ) {

				// Support: Android <=4.0 only, PhantomJS 1 only
				// push.apply(_, arraylike) throws on ancient WebKit
				jQuery.merge( nodes, elem.nodeType ? [ elem ] : elem );

			// Convert non-html into a text node
			} else if ( !rhtml.test( elem ) ) {
				nodes.push( context.createTextNode( elem ) );

			// Convert html into DOM nodes
			} else {
				tmp = tmp || fragment.appendChild( context.createElement( "div" ) );

				// Deserialize a standard representation
				tag = ( rtagName.exec( elem ) || [ "", "" ] )[ 1 ].toLowerCase();
				wrap = wrapMap[ tag ] || wrapMap._default;
				tmp.innerHTML = wrap[ 1 ] + jQuery.htmlPrefilter( elem ) + wrap[ 2 ];

				// Descend through wrappers to the right content
				j = wrap[ 0 ];
				while ( j-- ) {
					tmp = tmp.lastChild;
				}

				// Support: Android <=4.0 only, PhantomJS 1 only
				// push.apply(_, arraylike) throws on ancient WebKit
				jQuery.merge( nodes, tmp.childNodes );

				// Remember the top-level container
				tmp = fragment.firstChild;

				// Ensure the created nodes are orphaned (#12392)
				tmp.textContent = "";
			}
		}
	}

	// Remove wrapper from fragment
	fragment.textContent = "";

	i = 0;
	while ( ( elem = nodes[ i++ ] ) ) {

		// Skip elements already in the context collection (trac-4087)
		if ( selection && jQuery.inArray( elem, selection ) > -1 ) {
			if ( ignored ) {
				ignored.push( elem );
			}
			continue;
		}

		contains = jQuery.contains( elem.ownerDocument, elem );

		// Append to fragment
		tmp = getAll( fragment.appendChild( elem ), "script" );

		// Preserve script evaluation history
		if ( contains ) {
			setGlobalEval( tmp );
		}

		// Capture executables
		if ( scripts ) {
			j = 0;
			while ( ( elem = tmp[ j++ ] ) ) {
				if ( rscriptType.test( elem.type || "" ) ) {
					scripts.push( elem );
				}
			}
		}
	}

	return fragment;
}


( function() {
	var fragment = document.createDocumentFragment(),
		div = fragment.appendChild( document.createElement( "div" ) ),
		input = document.createElement( "input" );

	// Support: Android 4.0 - 4.3 only
	// Check state lost if the name is set (#11217)
	// Support: Windows Web Apps (WWA)
	// `name` and `type` must use .setAttribute for WWA (#14901)
	input.setAttribute( "type", "radio" );
	input.setAttribute( "checked", "checked" );
	input.setAttribute( "name", "t" );

	div.appendChild( input );

	// Support: Android <=4.1 only
	// Older WebKit doesn't clone checked state correctly in fragments
	support.checkClone = div.cloneNode( true ).cloneNode( true ).lastChild.checked;

	// Support: IE <=11 only
	// Make sure textarea (and checkbox) defaultValue is properly cloned
	div.innerHTML = "<textarea>x</textarea>";
	support.noCloneChecked = !!div.cloneNode( true ).lastChild.defaultValue;
} )();
var documentElement = document.documentElement;



var
	rkeyEvent = /^key/,
	rmouseEvent = /^(?:mouse|pointer|contextmenu|drag|drop)|click/,
	rtypenamespace = /^([^.]*)(?:\.(.+)|)/;

function returnTrue() {
	return true;
}

function returnFalse() {
	return false;
}

// Support: IE <=9 only
// See #13393 for more info
function safeActiveElement() {
	try {
		return document.activeElement;
	} catch ( err ) { }
}

function on( elem, types, selector, data, fn, one ) {
	var origFn, type;

	// Types can be a map of types/handlers
	if ( typeof types === "object" ) {

		// ( types-Object, selector, data )
		if ( typeof selector !== "string" ) {

			// ( types-Object, data )
			data = data || selector;
			selector = undefined;
		}
		for ( type in types ) {
			on( elem, type, selector, data, types[ type ], one );
		}
		return elem;
	}

	if ( data == null && fn == null ) {

		// ( types, fn )
		fn = selector;
		data = selector = undefined;
	} else if ( fn == null ) {
		if ( typeof selector === "string" ) {

			// ( types, selector, fn )
			fn = data;
			data = undefined;
		} else {

			// ( types, data, fn )
			fn = data;
			data = selector;
			selector = undefined;
		}
	}
	if ( fn === false ) {
		fn = returnFalse;
	} else if ( !fn ) {
		return elem;
	}

	if ( one === 1 ) {
		origFn = fn;
		fn = function( event ) {

			// Can use an empty set, since event contains the info
			jQuery().off( event );
			return origFn.apply( this, arguments );
		};

		// Use same guid so caller can remove using origFn
		fn.guid = origFn.guid || ( origFn.guid = jQuery.guid++ );
	}
	return elem.each( function() {
		jQuery.event.add( this, types, fn, data, selector );
	} );
}

/*
 * Helper functions for managing events -- not part of the public interface.
 * Props to Dean Edwards' addEvent library for many of the ideas.
 */
jQuery.event = {

	global: {},

	add: function( elem, types, handler, data, selector ) {

		var handleObjIn, eventHandle, tmp,
			events, t, handleObj,
			special, handlers, type, namespaces, origType,
			elemData = dataPriv.get( elem );

		// Don't attach events to noData or text/comment nodes (but allow plain objects)
		if ( !elemData ) {
			return;
		}

		// Caller can pass in an object of custom data in lieu of the handler
		if ( handler.handler ) {
			handleObjIn = handler;
			handler = handleObjIn.handler;
			selector = handleObjIn.selector;
		}

		// Ensure that invalid selectors throw exceptions at attach time
		// Evaluate against documentElement in case elem is a non-element node (e.g., document)
		if ( selector ) {
			jQuery.find.matchesSelector( documentElement, selector );
		}

		// Make sure that the handler has a unique ID, used to find/remove it later
		if ( !handler.guid ) {
			handler.guid = jQuery.guid++;
		}

		// Init the element's event structure and main handler, if this is the first
		if ( !( events = elemData.events ) ) {
			events = elemData.events = {};
		}
		if ( !( eventHandle = elemData.handle ) ) {
			eventHandle = elemData.handle = function( e ) {

				// Discard the second event of a jQuery.event.trigger() and
				// when an event is called after a page has unloaded
				return typeof jQuery !== "undefined" && jQuery.event.triggered !== e.type ?
					jQuery.event.dispatch.apply( elem, arguments ) : undefined;
			};
		}

		// Handle multiple events separated by a space
		types = ( types || "" ).match( rnothtmlwhite ) || [ "" ];
		t = types.length;
		while ( t-- ) {
			tmp = rtypenamespace.exec( types[ t ] ) || [];
			type = origType = tmp[ 1 ];
			namespaces = ( tmp[ 2 ] || "" ).split( "." ).sort();

			// There *must* be a type, no attaching namespace-only handlers
			if ( !type ) {
				continue;
			}

			// If event changes its type, use the special event handlers for the changed type
			special = jQuery.event.special[ type ] || {};

			// If selector defined, determine special event api type, otherwise given type
			type = ( selector ? special.delegateType : special.bindType ) || type;

			// Update special based on newly reset type
			special = jQuery.event.special[ type ] || {};

			// handleObj is passed to all event handlers
			handleObj = jQuery.extend( {
				type: type,
				origType: origType,
				data: data,
				handler: handler,
				guid: handler.guid,
				selector: selector,
				needsContext: selector && jQuery.expr.match.needsContext.test( selector ),
				namespace: namespaces.join( "." )
			}, handleObjIn );

			// Init the event handler queue if we're the first
			if ( !( handlers = events[ type ] ) ) {
				handlers = events[ type ] = [];
				handlers.delegateCount = 0;

				// Only use addEventListener if the special events handler returns false
				if ( !special.setup ||
					special.setup.call( elem, data, namespaces, eventHandle ) === false ) {

					if ( elem.addEventListener ) {
						elem.addEventListener( type, eventHandle );
					}
				}
			}

			if ( special.add ) {
				special.add.call( elem, handleObj );

				if ( !handleObj.handler.guid ) {
					handleObj.handler.guid = handler.guid;
				}
			}

			// Add to the element's handler list, delegates in front
			if ( selector ) {
				handlers.splice( handlers.delegateCount++, 0, handleObj );
			} else {
				handlers.push( handleObj );
			}

			// Keep track of which events have ever been used, for event optimization
			jQuery.event.global[ type ] = true;
		}

	},

	// Detach an event or set of events from an element
	remove: function( elem, types, handler, selector, mappedTypes ) {

		var j, origCount, tmp,
			events, t, handleObj,
			special, handlers, type, namespaces, origType,
			elemData = dataPriv.hasData( elem ) && dataPriv.get( elem );

		if ( !elemData || !( events = elemData.events ) ) {
			return;
		}

		// Once for each type.namespace in types; type may be omitted
		types = ( types || "" ).match( rnothtmlwhite ) || [ "" ];
		t = types.length;
		while ( t-- ) {
			tmp = rtypenamespace.exec( types[ t ] ) || [];
			type = origType = tmp[ 1 ];
			namespaces = ( tmp[ 2 ] || "" ).split( "." ).sort();

			// Unbind all events (on this namespace, if provided) for the element
			if ( !type ) {
				for ( type in events ) {
					jQuery.event.remove( elem, type + types[ t ], handler, selector, true );
				}
				continue;
			}

			special = jQuery.event.special[ type ] || {};
			type = ( selector ? special.delegateType : special.bindType ) || type;
			handlers = events[ type ] || [];
			tmp = tmp[ 2 ] &&
				new RegExp( "(^|\\.)" + namespaces.join( "\\.(?:.*\\.|)" ) + "(\\.|$)" );

			// Remove matching events
			origCount = j = handlers.length;
			while ( j-- ) {
				handleObj = handlers[ j ];

				if ( ( mappedTypes || origType === handleObj.origType ) &&
					( !handler || handler.guid === handleObj.guid ) &&
					( !tmp || tmp.test( handleObj.namespace ) ) &&
					( !selector || selector === handleObj.selector ||
						selector === "**" && handleObj.selector ) ) {
					handlers.splice( j, 1 );

					if ( handleObj.selector ) {
						handlers.delegateCount--;
					}
					if ( special.remove ) {
						special.remove.call( elem, handleObj );
					}
				}
			}

			// Remove generic event handler if we removed something and no more handlers exist
			// (avoids potential for endless recursion during removal of special event handlers)
			if ( origCount && !handlers.length ) {
				if ( !special.teardown ||
					special.teardown.call( elem, namespaces, elemData.handle ) === false ) {

					jQuery.removeEvent( elem, type, elemData.handle );
				}

				delete events[ type ];
			}
		}

		// Remove data and the expando if it's no longer used
		if ( jQuery.isEmptyObject( events ) ) {
			dataPriv.remove( elem, "handle events" );
		}
	},

	dispatch: function( nativeEvent ) {

		// Make a writable jQuery.Event from the native event object
		var event = jQuery.event.fix( nativeEvent );

		var i, j, ret, matched, handleObj, handlerQueue,
			args = new Array( arguments.length ),
			handlers = ( dataPriv.get( this, "events" ) || {} )[ event.type ] || [],
			special = jQuery.event.special[ event.type ] || {};

		// Use the fix-ed jQuery.Event rather than the (read-only) native event
		args[ 0 ] = event;

		for ( i = 1; i < arguments.length; i++ ) {
			args[ i ] = arguments[ i ];
		}

		event.delegateTarget = this;

		// Call the preDispatch hook for the mapped type, and let it bail if desired
		if ( special.preDispatch && special.preDispatch.call( this, event ) === false ) {
			return;
		}

		// Determine handlers
		handlerQueue = jQuery.event.handlers.call( this, event, handlers );

		// Run delegates first; they may want to stop propagation beneath us
		i = 0;
		while ( ( matched = handlerQueue[ i++ ] ) && !event.isPropagationStopped() ) {
			event.currentTarget = matched.elem;

			j = 0;
			while ( ( handleObj = matched.handlers[ j++ ] ) &&
				!event.isImmediatePropagationStopped() ) {

				// Triggered event must either 1) have no namespace, or 2) have namespace(s)
				// a subset or equal to those in the bound event (both can have no namespace).
				if ( !event.rnamespace || event.rnamespace.test( handleObj.namespace ) ) {

					event.handleObj = handleObj;
					event.data = handleObj.data;

					ret = ( ( jQuery.event.special[ handleObj.origType ] || {} ).handle ||
						handleObj.handler ).apply( matched.elem, args );

					if ( ret !== undefined ) {
						if ( ( event.result = ret ) === false ) {
							event.preventDefault();
							event.stopPropagation();
						}
					}
				}
			}
		}

		// Call the postDispatch hook for the mapped type
		if ( special.postDispatch ) {
			special.postDispatch.call( this, event );
		}

		return event.result;
	},

	handlers: function( event, handlers ) {
		var i, handleObj, sel, matchedHandlers, matchedSelectors,
			handlerQueue = [],
			delegateCount = handlers.delegateCount,
			cur = event.target;

		// Find delegate handlers
		if ( delegateCount &&

			// Support: IE <=9
			// Black-hole SVG <use> instance trees (trac-13180)
			cur.nodeType &&

			// Support: Firefox <=42
			// Suppress spec-violating clicks indicating a non-primary pointer button (trac-3861)
			// https://www.w3.org/TR/DOM-Level-3-Events/#event-type-click
			// Support: IE 11 only
			// ...but not arrow key "clicks" of radio inputs, which can have `button` -1 (gh-2343)
			!( event.type === "click" && event.button >= 1 ) ) {

			for ( ; cur !== this; cur = cur.parentNode || this ) {

				// Don't check non-elements (#13208)
				// Don't process clicks on disabled elements (#6911, #8165, #11382, #11764)
				if ( cur.nodeType === 1 && !( event.type === "click" && cur.disabled === true ) ) {
					matchedHandlers = [];
					matchedSelectors = {};
					for ( i = 0; i < delegateCount; i++ ) {
						handleObj = handlers[ i ];

						// Don't conflict with Object.prototype properties (#13203)
						sel = handleObj.selector + " ";

						if ( matchedSelectors[ sel ] === undefined ) {
							matchedSelectors[ sel ] = handleObj.needsContext ?
								jQuery( sel, this ).index( cur ) > -1 :
								jQuery.find( sel, this, null, [ cur ] ).length;
						}
						if ( matchedSelectors[ sel ] ) {
							matchedHandlers.push( handleObj );
						}
					}
					if ( matchedHandlers.length ) {
						handlerQueue.push( { elem: cur, handlers: matchedHandlers } );
					}
				}
			}
		}

		// Add the remaining (directly-bound) handlers
		cur = this;
		if ( delegateCount < handlers.length ) {
			handlerQueue.push( { elem: cur, handlers: handlers.slice( delegateCount ) } );
		}

		return handlerQueue;
	},

	addProp: function( name, hook ) {
		Object.defineProperty( jQuery.Event.prototype, name, {
			enumerable: true,
			configurable: true,

			get: jQuery.isFunction( hook ) ?
				function() {
					if ( this.originalEvent ) {
							return hook( this.originalEvent );
					}
				} :
				function() {
					if ( this.originalEvent ) {
							return this.originalEvent[ name ];
					}
				},

			set: function( value ) {
				Object.defineProperty( this, name, {
					enumerable: true,
					configurable: true,
					writable: true,
					value: value
				} );
			}
		} );
	},

	fix: function( originalEvent ) {
		return originalEvent[ jQuery.expando ] ?
			originalEvent :
			new jQuery.Event( originalEvent );
	},

	special: {
		load: {

			// Prevent triggered image.load events from bubbling to window.load
			noBubble: true
		},
		focus: {

			// Fire native event if possible so blur/focus sequence is correct
			trigger: function() {
				if ( this !== safeActiveElement() && this.focus ) {
					this.focus();
					return false;
				}
			},
			delegateType: "focusin"
		},
		blur: {
			trigger: function() {
				if ( this === safeActiveElement() && this.blur ) {
					this.blur();
					return false;
				}
			},
			delegateType: "focusout"
		},
		click: {

			// For checkbox, fire native event so checked state will be right
			trigger: function() {
				if ( this.type === "checkbox" && this.click && jQuery.nodeName( this, "input" ) ) {
					this.click();
					return false;
				}
			},

			// For cross-browser consistency, don't fire native .click() on links
			_default: function( event ) {
				return jQuery.nodeName( event.target, "a" );
			}
		},

		beforeunload: {
			postDispatch: function( event ) {

				// Support: Firefox 20+
				// Firefox doesn't alert if the returnValue field is not set.
				if ( event.result !== undefined && event.originalEvent ) {
					event.originalEvent.returnValue = event.result;
				}
			}
		}
	}
};

jQuery.removeEvent = function( elem, type, handle ) {

	// This "if" is needed for plain objects
	if ( elem.removeEventListener ) {
		elem.removeEventListener( type, handle );
	}
};

jQuery.Event = function( src, props ) {

	// Allow instantiation without the 'new' keyword
	if ( !( this instanceof jQuery.Event ) ) {
		return new jQuery.Event( src, props );
	}

	// Event object
	if ( src && src.type ) {
		this.originalEvent = src;
		this.type = src.type;

		// Events bubbling up the document may have been marked as prevented
		// by a handler lower down the tree; reflect the correct value.
		this.isDefaultPrevented = src.defaultPrevented ||
				src.defaultPrevented === undefined &&

				// Support: Android <=2.3 only
				src.returnValue === false ?
			returnTrue :
			returnFalse;

		// Create target properties
		// Support: Safari <=6 - 7 only
		// Target should not be a text node (#504, #13143)
		this.target = ( src.target && src.target.nodeType === 3 ) ?
			src.target.parentNode :
			src.target;

		this.currentTarget = src.currentTarget;
		this.relatedTarget = src.relatedTarget;

	// Event type
	} else {
		this.type = src;
	}

	// Put explicitly provided properties onto the event object
	if ( props ) {
		jQuery.extend( this, props );
	}

	// Create a timestamp if incoming event doesn't have one
	this.timeStamp = src && src.timeStamp || jQuery.now();

	// Mark it as fixed
	this[ jQuery.expando ] = true;
};

// jQuery.Event is based on DOM3 Events as specified by the ECMAScript Language Binding
// https://www.w3.org/TR/2003/WD-DOM-Level-3-Events-20030331/ecma-script-binding.html
jQuery.Event.prototype = {
	constructor: jQuery.Event,
	isDefaultPrevented: returnFalse,
	isPropagationStopped: returnFalse,
	isImmediatePropagationStopped: returnFalse,
	isSimulated: false,

	preventDefault: function() {
		var e = this.originalEvent;

		this.isDefaultPrevented = returnTrue;

		if ( e && !this.isSimulated ) {
			e.preventDefault();
		}
	},
	stopPropagation: function() {
		var e = this.originalEvent;

		this.isPropagationStopped = returnTrue;

		if ( e && !this.isSimulated ) {
			e.stopPropagation();
		}
	},
	stopImmediatePropagation: function() {
		var e = this.originalEvent;

		this.isImmediatePropagationStopped = returnTrue;

		if ( e && !this.isSimulated ) {
			e.stopImmediatePropagation();
		}

		this.stopPropagation();
	}
};

// Includes all common event props including KeyEvent and MouseEvent specific props
jQuery.each( {
	altKey: true,
	bubbles: true,
	cancelable: true,
	changedTouches: true,
	ctrlKey: true,
	detail: true,
	eventPhase: true,
	metaKey: true,
	pageX: true,
	pageY: true,
	shiftKey: true,
	view: true,
	"char": true,
	charCode: true,
	key: true,
	keyCode: true,
	button: true,
	buttons: true,
	clientX: true,
	clientY: true,
	offsetX: true,
	offsetY: true,
	pointerId: true,
	pointerType: true,
	screenX: true,
	screenY: true,
	targetTouches: true,
	toElement: true,
	touches: true,

	which: function( event ) {
		var button = event.button;

		// Add which for key events
		if ( event.which == null && rkeyEvent.test( event.type ) ) {
			return event.charCode != null ? event.charCode : event.keyCode;
		}

		// Add which for click: 1 === left; 2 === middle; 3 === right
		if ( !event.which && button !== undefined && rmouseEvent.test( event.type ) ) {
			if ( button & 1 ) {
				return 1;
			}

			if ( button & 2 ) {
				return 3;
			}

			if ( button & 4 ) {
				return 2;
			}

			return 0;
		}

		return event.which;
	}
}, jQuery.event.addProp );

// Create mouseenter/leave events using mouseover/out and event-time checks
// so that event delegation works in jQuery.
// Do the same for pointerenter/pointerleave and pointerover/pointerout
//
// Support: Safari 7 only
// Safari sends mouseenter too often; see:
// https://bugs.chromium.org/p/chromium/issues/detail?id=470258
// for the description of the bug (it existed in older Chrome versions as well).
jQuery.each( {
	mouseenter: "mouseover",
	mouseleave: "mouseout",
	pointerenter: "pointerover",
	pointerleave: "pointerout"
}, function( orig, fix ) {
	jQuery.event.special[ orig ] = {
		delegateType: fix,
		bindType: fix,

		handle: function( event ) {
			var ret,
				target = this,
				related = event.relatedTarget,
				handleObj = event.handleObj;

			// For mouseenter/leave call the handler if related is outside the target.
			// NB: No relatedTarget if the mouse left/entered the browser window
			if ( !related || ( related !== target && !jQuery.contains( target, related ) ) ) {
				event.type = handleObj.origType;
				ret = handleObj.handler.apply( this, arguments );
				event.type = fix;
			}
			return ret;
		}
	};
} );

jQuery.fn.extend( {

	on: function( types, selector, data, fn ) {
		return on( this, types, selector, data, fn );
	},
	one: function( types, selector, data, fn ) {
		return on( this, types, selector, data, fn, 1 );
	},
	off: function( types, selector, fn ) {
		var handleObj, type;
		if ( types && types.preventDefault && types.handleObj ) {

			// ( event )  dispatched jQuery.Event
			handleObj = types.handleObj;
			jQuery( types.delegateTarget ).off(
				handleObj.namespace ?
					handleObj.origType + "." + handleObj.namespace :
					handleObj.origType,
				handleObj.selector,
				handleObj.handler
			);
			return this;
		}
		if ( typeof types === "object" ) {

			// ( types-object [, selector] )
			for ( type in types ) {
				this.off( type, selector, types[ type ] );
			}
			return this;
		}
		if ( selector === false || typeof selector === "function" ) {

			// ( types [, fn] )
			fn = selector;
			selector = undefined;
		}
		if ( fn === false ) {
			fn = returnFalse;
		}
		return this.each( function() {
			jQuery.event.remove( this, types, fn, selector );
		} );
	}
} );


var

	/* eslint-disable max-len */

	// See https://github.com/eslint/eslint/issues/3229
	rxhtmlTag = /<(?!area|br|col|embed|hr|img|input|link|meta|param)(([a-z][^\/\0>\x20\t\r\n\f]*)[^>]*)\/>/gi,

	/* eslint-enable */

	// Support: IE <=10 - 11, Edge 12 - 13
	// In IE/Edge using regex groups here causes severe slowdowns.
	// See https://connect.microsoft.com/IE/feedback/details/1736512/
	rnoInnerhtml = /<script|<style|<link/i,

	// checked="checked" or checked
	rchecked = /checked\s*(?:[^=]|=\s*.checked.)/i,
	rscriptTypeMasked = /^true\/(.*)/,
	rcleanScript = /^\s*<!(?:\[CDATA\[|--)|(?:\]\]|--)>\s*$/g;

function manipulationTarget( elem, content ) {
	if ( jQuery.nodeName( elem, "table" ) &&
		jQuery.nodeName( content.nodeType !== 11 ? content : content.firstChild, "tr" ) ) {

		return elem.getElementsByTagName( "tbody" )[ 0 ] || elem;
	}

	return elem;
}

// Replace/restore the type attribute of script elements for safe DOM manipulation
function disableScript( elem ) {
	elem.type = ( elem.getAttribute( "type" ) !== null ) + "/" + elem.type;
	return elem;
}
function restoreScript( elem ) {
	var match = rscriptTypeMasked.exec( elem.type );

	if ( match ) {
		elem.type = match[ 1 ];
	} else {
		elem.removeAttribute( "type" );
	}

	return elem;
}

function cloneCopyEvent( src, dest ) {
	var i, l, type, pdataOld, pdataCur, udataOld, udataCur, events;

	if ( dest.nodeType !== 1 ) {
		return;
	}

	// 1. Copy private data: events, handlers, etc.
	if ( dataPriv.hasData( src ) ) {
		pdataOld = dataPriv.access( src );
		pdataCur = dataPriv.set( dest, pdataOld );
		events = pdataOld.events;

		if ( events ) {
			delete pdataCur.handle;
			pdataCur.events = {};

			for ( type in events ) {
				for ( i = 0, l = events[ type ].length; i < l; i++ ) {
					jQuery.event.add( dest, type, events[ type ][ i ] );
				}
			}
		}
	}

	// 2. Copy user data
	if ( dataUser.hasData( src ) ) {
		udataOld = dataUser.access( src );
		udataCur = jQuery.extend( {}, udataOld );

		dataUser.set( dest, udataCur );
	}
}

// Fix IE bugs, see support tests
function fixInput( src, dest ) {
	var nodeName = dest.nodeName.toLowerCase();

	// Fails to persist the checked state of a cloned checkbox or radio button.
	if ( nodeName === "input" && rcheckableType.test( src.type ) ) {
		dest.checked = src.checked;

	// Fails to return the selected option to the default selected state when cloning options
	} else if ( nodeName === "input" || nodeName === "textarea" ) {
		dest.defaultValue = src.defaultValue;
	}
}

function domManip( collection, args, callback, ignored ) {

	// Flatten any nested arrays
	args = concat.apply( [], args );

	var fragment, first, scripts, hasScripts, node, doc,
		i = 0,
		l = collection.length,
		iNoClone = l - 1,
		value = args[ 0 ],
		isFunction = jQuery.isFunction( value );

	// We can't cloneNode fragments that contain checked, in WebKit
	if ( isFunction ||
			( l > 1 && typeof value === "string" &&
				!support.checkClone && rchecked.test( value ) ) ) {
		return collection.each( function( index ) {
			var self = collection.eq( index );
			if ( isFunction ) {
				args[ 0 ] = value.call( this, index, self.html() );
			}
			domManip( self, args, callback, ignored );
		} );
	}

	if ( l ) {
		fragment = buildFragment( args, collection[ 0 ].ownerDocument, false, collection, ignored );
		first = fragment.firstChild;

		if ( fragment.childNodes.length === 1 ) {
			fragment = first;
		}

		// Require either new content or an interest in ignored elements to invoke the callback
		if ( first || ignored ) {
			scripts = jQuery.map( getAll( fragment, "script" ), disableScript );
			hasScripts = scripts.length;

			// Use the original fragment for the last item
			// instead of the first because it can end up
			// being emptied incorrectly in certain situations (#8070).
			for ( ; i < l; i++ ) {
				node = fragment;

				if ( i !== iNoClone ) {
					node = jQuery.clone( node, true, true );

					// Keep references to cloned scripts for later restoration
					if ( hasScripts ) {

						// Support: Android <=4.0 only, PhantomJS 1 only
						// push.apply(_, arraylike) throws on ancient WebKit
						jQuery.merge( scripts, getAll( node, "script" ) );
					}
				}

				callback.call( collection[ i ], node, i );
			}

			if ( hasScripts ) {
				doc = scripts[ scripts.length - 1 ].ownerDocument;

				// Reenable scripts
				jQuery.map( scripts, restoreScript );

				// Evaluate executable scripts on first document insertion
				for ( i = 0; i < hasScripts; i++ ) {
					node = scripts[ i ];
					if ( rscriptType.test( node.type || "" ) &&
						!dataPriv.access( node, "globalEval" ) &&
						jQuery.contains( doc, node ) ) {

						if ( node.src ) {

							// Optional AJAX dependency, but won't run scripts if not present
							if ( jQuery._evalUrl ) {
								jQuery._evalUrl( node.src );
							}
						} else {
							DOMEval( node.textContent.replace( rcleanScript, "" ), doc );
						}
					}
				}
			}
		}
	}

	return collection;
}

function remove( elem, selector, keepData ) {
	var node,
		nodes = selector ? jQuery.filter( selector, elem ) : elem,
		i = 0;

	for ( ; ( node = nodes[ i ] ) != null; i++ ) {
		if ( !keepData && node.nodeType === 1 ) {
			jQuery.cleanData( getAll( node ) );
		}

		if ( node.parentNode ) {
			if ( keepData && jQuery.contains( node.ownerDocument, node ) ) {
				setGlobalEval( getAll( node, "script" ) );
			}
			node.parentNode.removeChild( node );
		}
	}

	return elem;
}

jQuery.extend( {
	htmlPrefilter: function( html ) {
		return html.replace( rxhtmlTag, "<$1></$2>" );
	},

	clone: function( elem, dataAndEvents, deepDataAndEvents ) {
		var i, l, srcElements, destElements,
			clone = elem.cloneNode( true ),
			inPage = jQuery.contains( elem.ownerDocument, elem );

		// Fix IE cloning issues
		if ( !support.noCloneChecked && ( elem.nodeType === 1 || elem.nodeType === 11 ) &&
				!jQuery.isXMLDoc( elem ) ) {

			// We eschew Sizzle here for performance reasons: https://jsperf.com/getall-vs-sizzle/2
			destElements = getAll( clone );
			srcElements = getAll( elem );

			for ( i = 0, l = srcElements.length; i < l; i++ ) {
				fixInput( srcElements[ i ], destElements[ i ] );
			}
		}

		// Copy the events from the original to the clone
		if ( dataAndEvents ) {
			if ( deepDataAndEvents ) {
				srcElements = srcElements || getAll( elem );
				destElements = destElements || getAll( clone );

				for ( i = 0, l = srcElements.length; i < l; i++ ) {
					cloneCopyEvent( srcElements[ i ], destElements[ i ] );
				}
			} else {
				cloneCopyEvent( elem, clone );
			}
		}

		// Preserve script evaluation history
		destElements = getAll( clone, "script" );
		if ( destElements.length > 0 ) {
			setGlobalEval( destElements, !inPage && getAll( elem, "script" ) );
		}

		// Return the cloned set
		return clone;
	},

	cleanData: function( elems ) {
		var data, elem, type,
			special = jQuery.event.special,
			i = 0;

		for ( ; ( elem = elems[ i ] ) !== undefined; i++ ) {
			if ( acceptData( elem ) ) {
				if ( ( data = elem[ dataPriv.expando ] ) ) {
					if ( data.events ) {
						for ( type in data.events ) {
							if ( special[ type ] ) {
								jQuery.event.remove( elem, type );

							// This is a shortcut to avoid jQuery.event.remove's overhead
							} else {
								jQuery.removeEvent( elem, type, data.handle );
							}
						}
					}

					// Support: Chrome <=35 - 45+
					// Assign undefined instead of using delete, see Data#remove
					elem[ dataPriv.expando ] = undefined;
				}
				if ( elem[ dataUser.expando ] ) {

					// Support: Chrome <=35 - 45+
					// Assign undefined instead of using delete, see Data#remove
					elem[ dataUser.expando ] = undefined;
				}
			}
		}
	}
} );

jQuery.fn.extend( {
	detach: function( selector ) {
		return remove( this, selector, true );
	},

	remove: function( selector ) {
		return remove( this, selector );
	},

	text: function( value ) {
		return access( this, function( value ) {
			return value === undefined ?
				jQuery.text( this ) :
				this.empty().each( function() {
					if ( this.nodeType === 1 || this.nodeType === 11 || this.nodeType === 9 ) {
						this.textContent = value;
					}
				} );
		}, null, value, arguments.length );
	},

	append: function() {
		return domManip( this, arguments, function( elem ) {
			if ( this.nodeType === 1 || this.nodeType === 11 || this.nodeType === 9 ) {
				var target = manipulationTarget( this, elem );
				target.appendChild( elem );
			}
		} );
	},

	prepend: function() {
		return domManip( this, arguments, function( elem ) {
			if ( this.nodeType === 1 || this.nodeType === 11 || this.nodeType === 9 ) {
				var target = manipulationTarget( this, elem );
				target.insertBefore( elem, target.firstChild );
			}
		} );
	},

	before: function() {
		return domManip( this, arguments, function( elem ) {
			if ( this.parentNode ) {
				this.parentNode.insertBefore( elem, this );
			}
		} );
	},

	after: function() {
		return domManip( this, arguments, function( elem ) {
			if ( this.parentNode ) {
				this.parentNode.insertBefore( elem, this.nextSibling );
			}
		} );
	},

	empty: function() {
		var elem,
			i = 0;

		for ( ; ( elem = this[ i ] ) != null; i++ ) {
			if ( elem.nodeType === 1 ) {

				// Prevent memory leaks
				jQuery.cleanData( getAll( elem, false ) );

				// Remove any remaining nodes
				elem.textContent = "";
			}
		}

		return this;
	},

	clone: function( dataAndEvents, deepDataAndEvents ) {
		dataAndEvents = dataAndEvents == null ? false : dataAndEvents;
		deepDataAndEvents = deepDataAndEvents == null ? dataAndEvents : deepDataAndEvents;

		return this.map( function() {
			return jQuery.clone( this, dataAndEvents, deepDataAndEvents );
		} );
	},

	html: function( value ) {
		return access( this, function( value ) {
			var elem = this[ 0 ] || {},
				i = 0,
				l = this.length;

			if ( value === undefined && elem.nodeType === 1 ) {
				return elem.innerHTML;
			}

			// See if we can take a shortcut and just use innerHTML
			if ( typeof value === "string" && !rnoInnerhtml.test( value ) &&
				!wrapMap[ ( rtagName.exec( value ) || [ "", "" ] )[ 1 ].toLowerCase() ] ) {

				value = jQuery.htmlPrefilter( value );

				try {
					for ( ; i < l; i++ ) {
						elem = this[ i ] || {};

						// Remove element nodes and prevent memory leaks
						if ( elem.nodeType === 1 ) {
							jQuery.cleanData( getAll( elem, false ) );
							elem.innerHTML = value;
						}
					}

					elem = 0;

				// If using innerHTML throws an exception, use the fallback method
				} catch ( e ) {}
			}

			if ( elem ) {
				this.empty().append( value );
			}
		}, null, value, arguments.length );
	},

	replaceWith: function() {
		var ignored = [];

		// Make the changes, replacing each non-ignored context element with the new content
		return domManip( this, arguments, function( elem ) {
			var parent = this.parentNode;

			if ( jQuery.inArray( this, ignored ) < 0 ) {
				jQuery.cleanData( getAll( this ) );
				if ( parent ) {
					parent.replaceChild( elem, this );
				}
			}

		// Force callback invocation
		}, ignored );
	}
} );

jQuery.each( {
	appendTo: "append",
	prependTo: "prepend",
	insertBefore: "before",
	insertAfter: "after",
	replaceAll: "replaceWith"
}, function( name, original ) {
	jQuery.fn[ name ] = function( selector ) {
		var elems,
			ret = [],
			insert = jQuery( selector ),
			last = insert.length - 1,
			i = 0;

		for ( ; i <= last; i++ ) {
			elems = i === last ? this : this.clone( true );
			jQuery( insert[ i ] )[ original ]( elems );

			// Support: Android <=4.0 only, PhantomJS 1 only
			// .get() because push.apply(_, arraylike) throws on ancient WebKit
			push.apply( ret, elems.get() );
		}

		return this.pushStack( ret );
	};
} );
var rmargin = ( /^margin/ );

var rnumnonpx = new RegExp( "^(" + pnum + ")(?!px)[a-z%]+$", "i" );

var getStyles = function( elem ) {

		// Support: IE <=11 only, Firefox <=30 (#15098, #14150)
		// IE throws on elements created in popups
		// FF meanwhile throws on frame elements through "defaultView.getComputedStyle"
		var view = elem.ownerDocument.defaultView;

		if ( !view || !view.opener ) {
			view = window;
		}

		return view.getComputedStyle( elem );
	};



( function() {

	// Executing both pixelPosition & boxSizingReliable tests require only one layout
	// so they're executed at the same time to save the second computation.
	function computeStyleTests() {

		// This is a singleton, we need to execute it only once
		if ( !div ) {
			return;
		}

		div.style.cssText =
			"box-sizing:border-box;" +
			"position:relative;display:block;" +
			"margin:auto;border:1px;padding:1px;" +
			"top:1%;width:50%";
		div.innerHTML = "";
		documentElement.appendChild( container );

		var divStyle = window.getComputedStyle( div );
		pixelPositionVal = divStyle.top !== "1%";

		// Support: Android 4.0 - 4.3 only, Firefox <=3 - 44
		reliableMarginLeftVal = divStyle.marginLeft === "2px";
		boxSizingReliableVal = divStyle.width === "4px";

		// Support: Android 4.0 - 4.3 only
		// Some styles come back with percentage values, even though they shouldn't
		div.style.marginRight = "50%";
		pixelMarginRightVal = divStyle.marginRight === "4px";

		documentElement.removeChild( container );

		// Nullify the div so it wouldn't be stored in the memory and
		// it will also be a sign that checks already performed
		div = null;
	}

	var pixelPositionVal, boxSizingReliableVal, pixelMarginRightVal, reliableMarginLeftVal,
		container = document.createElement( "div" ),
		div = document.createElement( "div" );

	// Finish early in limited (non-browser) environments
	if ( !div.style ) {
		return;
	}

	// Support: IE <=9 - 11 only
	// Style of cloned element affects source element cloned (#8908)
	div.style.backgroundClip = "content-box";
	div.cloneNode( true ).style.backgroundClip = "";
	support.clearCloneStyle = div.style.backgroundClip === "content-box";

	container.style.cssText = "border:0;width:8px;height:0;top:0;left:-9999px;" +
		"padding:0;margin-top:1px;position:absolute";
	container.appendChild( div );

	jQuery.extend( support, {
		pixelPosition: function() {
			computeStyleTests();
			return pixelPositionVal;
		},
		boxSizingReliable: function() {
			computeStyleTests();
			return boxSizingReliableVal;
		},
		pixelMarginRight: function() {
			computeStyleTests();
			return pixelMarginRightVal;
		},
		reliableMarginLeft: function() {
			computeStyleTests();
			return reliableMarginLeftVal;
		}
	} );
} )();


function curCSS( elem, name, computed ) {
	var width, minWidth, maxWidth, ret,
		style = elem.style;

	computed = computed || getStyles( elem );

	// Support: IE <=9 only
	// getPropertyValue is only needed for .css('filter') (#12537)
	if ( computed ) {
		ret = computed.getPropertyValue( name ) || computed[ name ];

		if ( ret === "" && !jQuery.contains( elem.ownerDocument, elem ) ) {
			ret = jQuery.style( elem, name );
		}

		// A tribute to the "awesome hack by Dean Edwards"
		// Android Browser returns percentage for some values,
		// but width seems to be reliably pixels.
		// This is against the CSSOM draft spec:
		// https://drafts.csswg.org/cssom/#resolved-values
		if ( !support.pixelMarginRight() && rnumnonpx.test( ret ) && rmargin.test( name ) ) {

			// Remember the original values
			width = style.width;
			minWidth = style.minWidth;
			maxWidth = style.maxWidth;

			// Put in the new values to get a computed value out
			style.minWidth = style.maxWidth = style.width = ret;
			ret = computed.width;

			// Revert the changed values
			style.width = width;
			style.minWidth = minWidth;
			style.maxWidth = maxWidth;
		}
	}

	return ret !== undefined ?

		// Support: IE <=9 - 11 only
		// IE returns zIndex value as an integer.
		ret + "" :
		ret;
}


function addGetHookIf( conditionFn, hookFn ) {

	// Define the hook, we'll check on the first run if it's really needed.
	return {
		get: function() {
			if ( conditionFn() ) {

				// Hook not needed (or it's not possible to use it due
				// to missing dependency), remove it.
				delete this.get;
				return;
			}

			// Hook needed; redefine it so that the support test is not executed again.
			return ( this.get = hookFn ).apply( this, arguments );
		}
	};
}


var

	// Swappable if display is none or starts with table
	// except "table", "table-cell", or "table-caption"
	// See here for display values: https://developer.mozilla.org/en-US/docs/CSS/display
	rdisplayswap = /^(none|table(?!-c[ea]).+)/,
	cssShow = { position: "absolute", visibility: "hidden", display: "block" },
	cssNormalTransform = {
		letterSpacing: "0",
		fontWeight: "400"
	},

	cssPrefixes = [ "Webkit", "Moz", "ms" ],
	emptyStyle = document.createElement( "div" ).style;

// Return a css property mapped to a potentially vendor prefixed property
function vendorPropName( name ) {

	// Shortcut for names that are not vendor prefixed
	if ( name in emptyStyle ) {
		return name;
	}

	// Check for vendor prefixed names
	var capName = name[ 0 ].toUpperCase() + name.slice( 1 ),
		i = cssPrefixes.length;

	while ( i-- ) {
		name = cssPrefixes[ i ] + capName;
		if ( name in emptyStyle ) {
			return name;
		}
	}
}

function setPositiveNumber( elem, value, subtract ) {

	// Any relative (+/-) values have already been
	// normalized at this point
	var matches = rcssNum.exec( value );
	return matches ?

		// Guard against undefined "subtract", e.g., when used as in cssHooks
		Math.max( 0, matches[ 2 ] - ( subtract || 0 ) ) + ( matches[ 3 ] || "px" ) :
		value;
}

function augmentWidthOrHeight( elem, name, extra, isBorderBox, styles ) {
	var i,
		val = 0;

	// If we already have the right measurement, avoid augmentation
	if ( extra === ( isBorderBox ? "border" : "content" ) ) {
		i = 4;

	// Otherwise initialize for horizontal or vertical properties
	} else {
		i = name === "width" ? 1 : 0;
	}

	for ( ; i < 4; i += 2 ) {

		// Both box models exclude margin, so add it if we want it
		if ( extra === "margin" ) {
			val += jQuery.css( elem, extra + cssExpand[ i ], true, styles );
		}

		if ( isBorderBox ) {

			// border-box includes padding, so remove it if we want content
			if ( extra === "content" ) {
				val -= jQuery.css( elem, "padding" + cssExpand[ i ], true, styles );
			}

			// At this point, extra isn't border nor margin, so remove border
			if ( extra !== "margin" ) {
				val -= jQuery.css( elem, "border" + cssExpand[ i ] + "Width", true, styles );
			}
		} else {

			// At this point, extra isn't content, so add padding
			val += jQuery.css( elem, "padding" + cssExpand[ i ], true, styles );

			// At this point, extra isn't content nor padding, so add border
			if ( extra !== "padding" ) {
				val += jQuery.css( elem, "border" + cssExpand[ i ] + "Width", true, styles );
			}
		}
	}

	return val;
}

function getWidthOrHeight( elem, name, extra ) {

	// Start with offset property, which is equivalent to the border-box value
	var val,
		valueIsBorderBox = true,
		styles = getStyles( elem ),
		isBorderBox = jQuery.css( elem, "boxSizing", false, styles ) === "border-box";

	// Support: IE <=11 only
	// Running getBoundingClientRect on a disconnected node
	// in IE throws an error.
	if ( elem.getClientRects().length ) {
		val = elem.getBoundingClientRect()[ name ];
	}

	// Some non-html elements return undefined for offsetWidth, so check for null/undefined
	// svg - https://bugzilla.mozilla.org/show_bug.cgi?id=649285
	// MathML - https://bugzilla.mozilla.org/show_bug.cgi?id=491668
	if ( val <= 0 || val == null ) {

		// Fall back to computed then uncomputed css if necessary
		val = curCSS( elem, name, styles );
		if ( val < 0 || val == null ) {
			val = elem.style[ name ];
		}

		// Computed unit is not pixels. Stop here and return.
		if ( rnumnonpx.test( val ) ) {
			return val;
		}

		// Check for style in case a browser which returns unreliable values
		// for getComputedStyle silently falls back to the reliable elem.style
		valueIsBorderBox = isBorderBox &&
			( support.boxSizingReliable() || val === elem.style[ name ] );

		// Normalize "", auto, and prepare for extra
		val = parseFloat( val ) || 0;
	}

	// Use the active box-sizing model to add/subtract irrelevant styles
	return ( val +
		augmentWidthOrHeight(
			elem,
			name,
			extra || ( isBorderBox ? "border" : "content" ),
			valueIsBorderBox,
			styles
		)
	) + "px";
}

jQuery.extend( {

	// Add in style property hooks for overriding the default
	// behavior of getting and setting a style property
	cssHooks: {
		opacity: {
			get: function( elem, computed ) {
				if ( computed ) {

					// We should always get a number back from opacity
					var ret = curCSS( elem, "opacity" );
					return ret === "" ? "1" : ret;
				}
			}
		}
	},

	// Don't automatically add "px" to these possibly-unitless properties
	cssNumber: {
		"animationIterationCount": true,
		"columnCount": true,
		"fillOpacity": true,
		"flexGrow": true,
		"flexShrink": true,
		"fontWeight": true,
		"lineHeight": true,
		"opacity": true,
		"order": true,
		"orphans": true,
		"widows": true,
		"zIndex": true,
		"zoom": true
	},

	// Add in properties whose names you wish to fix before
	// setting or getting the value
	cssProps: {
		"float": "cssFloat"
	},

	// Get and set the style property on a DOM Node
	style: function( elem, name, value, extra ) {

		// Don't set styles on text and comment nodes
		if ( !elem || elem.nodeType === 3 || elem.nodeType === 8 || !elem.style ) {
			return;
		}

		// Make sure that we're working with the right name
		var ret, type, hooks,
			origName = jQuery.camelCase( name ),
			style = elem.style;

		name = jQuery.cssProps[ origName ] ||
			( jQuery.cssProps[ origName ] = vendorPropName( origName ) || origName );

		// Gets hook for the prefixed version, then unprefixed version
		hooks = jQuery.cssHooks[ name ] || jQuery.cssHooks[ origName ];

		// Check if we're setting a value
		if ( value !== undefined ) {
			type = typeof value;

			// Convert "+=" or "-=" to relative numbers (#7345)
			if ( type === "string" && ( ret = rcssNum.exec( value ) ) && ret[ 1 ] ) {
				value = adjustCSS( elem, name, ret );

				// Fixes bug #9237
				type = "number";
			}

			// Make sure that null and NaN values aren't set (#7116)
			if ( value == null || value !== value ) {
				return;
			}

			// If a number was passed in, add the unit (except for certain CSS properties)
			if ( type === "number" ) {
				value += ret && ret[ 3 ] || ( jQuery.cssNumber[ origName ] ? "" : "px" );
			}

			// background-* props affect original clone's values
			if ( !support.clearCloneStyle && value === "" && name.indexOf( "background" ) === 0 ) {
				style[ name ] = "inherit";
			}

			// If a hook was provided, use that value, otherwise just set the specified value
			if ( !hooks || !( "set" in hooks ) ||
				( value = hooks.set( elem, value, extra ) ) !== undefined ) {

				style[ name ] = value;
			}

		} else {

			// If a hook was provided get the non-computed value from there
			if ( hooks && "get" in hooks &&
				( ret = hooks.get( elem, false, extra ) ) !== undefined ) {

				return ret;
			}

			// Otherwise just get the value from the style object
			return style[ name ];
		}
	},

	css: function( elem, name, extra, styles ) {
		var val, num, hooks,
			origName = jQuery.camelCase( name );

		// Make sure that we're working with the right name
		name = jQuery.cssProps[ origName ] ||
			( jQuery.cssProps[ origName ] = vendorPropName( origName ) || origName );

		// Try prefixed name followed by the unprefixed name
		hooks = jQuery.cssHooks[ name ] || jQuery.cssHooks[ origName ];

		// If a hook was provided get the computed value from there
		if ( hooks && "get" in hooks ) {
			val = hooks.get( elem, true, extra );
		}

		// Otherwise, if a way to get the computed value exists, use that
		if ( val === undefined ) {
			val = curCSS( elem, name, styles );
		}

		// Convert "normal" to computed value
		if ( val === "normal" && name in cssNormalTransform ) {
			val = cssNormalTransform[ name ];
		}

		// Make numeric if forced or a qualifier was provided and val looks numeric
		if ( extra === "" || extra ) {
			num = parseFloat( val );
			return extra === true || isFinite( num ) ? num || 0 : val;
		}
		return val;
	}
} );

jQuery.each( [ "height", "width" ], function( i, name ) {
	jQuery.cssHooks[ name ] = {
		get: function( elem, computed, extra ) {
			if ( computed ) {

				// Certain elements can have dimension info if we invisibly show them
				// but it must have a current display style that would benefit
				return rdisplayswap.test( jQuery.css( elem, "display" ) ) &&

					// Support: Safari 8+
					// Table columns in Safari have non-zero offsetWidth & zero
					// getBoundingClientRect().width unless display is changed.
					// Support: IE <=11 only
					// Running getBoundingClientRect on a disconnected node
					// in IE throws an error.
					( !elem.getClientRects().length || !elem.getBoundingClientRect().width ) ?
						swap( elem, cssShow, function() {
							return getWidthOrHeight( elem, name, extra );
						} ) :
						getWidthOrHeight( elem, name, extra );
			}
		},

		set: function( elem, value, extra ) {
			var matches,
				styles = extra && getStyles( elem ),
				subtract = extra && augmentWidthOrHeight(
					elem,
					name,
					extra,
					jQuery.css( elem, "boxSizing", false, styles ) === "border-box",
					styles
				);

			// Convert to pixels if value adjustment is needed
			if ( subtract && ( matches = rcssNum.exec( value ) ) &&
				( matches[ 3 ] || "px" ) !== "px" ) {

				elem.style[ name ] = value;
				value = jQuery.css( elem, name );
			}

			return setPositiveNumber( elem, value, subtract );
		}
	};
} );

jQuery.cssHooks.marginLeft = addGetHookIf( support.reliableMarginLeft,
	function( elem, computed ) {
		if ( computed ) {
			return ( parseFloat( curCSS( elem, "marginLeft" ) ) ||
				elem.getBoundingClientRect().left -
					swap( elem, { marginLeft: 0 }, function() {
						return elem.getBoundingClientRect().left;
					} )
				) + "px";
		}
	}
);

// These hooks are used by animate to expand properties
jQuery.each( {
	margin: "",
	padding: "",
	border: "Width"
}, function( prefix, suffix ) {
	jQuery.cssHooks[ prefix + suffix ] = {
		expand: function( value ) {
			var i = 0,
				expanded = {},

				// Assumes a single number if not a string
				parts = typeof value === "string" ? value.split( " " ) : [ value ];

			for ( ; i < 4; i++ ) {
				expanded[ prefix + cssExpand[ i ] + suffix ] =
					parts[ i ] || parts[ i - 2 ] || parts[ 0 ];
			}

			return expanded;
		}
	};

	if ( !rmargin.test( prefix ) ) {
		jQuery.cssHooks[ prefix + suffix ].set = setPositiveNumber;
	}
} );

jQuery.fn.extend( {
	css: function( name, value ) {
		return access( this, function( elem, name, value ) {
			var styles, len,
				map = {},
				i = 0;

			if ( jQuery.isArray( name ) ) {
				styles = getStyles( elem );
				len = name.length;

				for ( ; i < len; i++ ) {
					map[ name[ i ] ] = jQuery.css( elem, name[ i ], false, styles );
				}

				return map;
			}

			return value !== undefined ?
				jQuery.style( elem, name, value ) :
				jQuery.css( elem, name );
		}, name, value, arguments.length > 1 );
	}
} );


function Tween( elem, options, prop, end, easing ) {
	return new Tween.prototype.init( elem, options, prop, end, easing );
}
jQuery.Tween = Tween;

Tween.prototype = {
	constructor: Tween,
	init: function( elem, options, prop, end, easing, unit ) {
		this.elem = elem;
		this.prop = prop;
		this.easing = easing || jQuery.easing._default;
		this.options = options;
		this.start = this.now = this.cur();
		this.end = end;
		this.unit = unit || ( jQuery.cssNumber[ prop ] ? "" : "px" );
	},
	cur: function() {
		var hooks = Tween.propHooks[ this.prop ];

		return hooks && hooks.get ?
			hooks.get( this ) :
			Tween.propHooks._default.get( this );
	},
	run: function( percent ) {
		var eased,
			hooks = Tween.propHooks[ this.prop ];

		if ( this.options.duration ) {
			this.pos = eased = jQuery.easing[ this.easing ](
				percent, this.options.duration * percent, 0, 1, this.options.duration
			);
		} else {
			this.pos = eased = percent;
		}
		this.now = ( this.end - this.start ) * eased + this.start;

		if ( this.options.step ) {
			this.options.step.call( this.elem, this.now, this );
		}

		if ( hooks && hooks.set ) {
			hooks.set( this );
		} else {
			Tween.propHooks._default.set( this );
		}
		return this;
	}
};

Tween.prototype.init.prototype = Tween.prototype;

Tween.propHooks = {
	_default: {
		get: function( tween ) {
			var result;

			// Use a property on the element directly when it is not a DOM element,
			// or when there is no matching style property that exists.
			if ( tween.elem.nodeType !== 1 ||
				tween.elem[ tween.prop ] != null && tween.elem.style[ tween.prop ] == null ) {
				return tween.elem[ tween.prop ];
			}

			// Passing an empty string as a 3rd parameter to .css will automatically
			// attempt a parseFloat and fallback to a string if the parse fails.
			// Simple values such as "10px" are parsed to Float;
			// complex values such as "rotate(1rad)" are returned as-is.
			result = jQuery.css( tween.elem, tween.prop, "" );

			// Empty strings, null, undefined and "auto" are converted to 0.
			return !result || result === "auto" ? 0 : result;
		},
		set: function( tween ) {

			// Use step hook for back compat.
			// Use cssHook if its there.
			// Use .style if available and use plain properties where available.
			if ( jQuery.fx.step[ tween.prop ] ) {
				jQuery.fx.step[ tween.prop ]( tween );
			} else if ( tween.elem.nodeType === 1 &&
				( tween.elem.style[ jQuery.cssProps[ tween.prop ] ] != null ||
					jQuery.cssHooks[ tween.prop ] ) ) {
				jQuery.style( tween.elem, tween.prop, tween.now + tween.unit );
			} else {
				tween.elem[ tween.prop ] = tween.now;
			}
		}
	}
};

// Support: IE <=9 only
// Panic based approach to setting things on disconnected nodes
Tween.propHooks.scrollTop = Tween.propHooks.scrollLeft = {
	set: function( tween ) {
		if ( tween.elem.nodeType && tween.elem.parentNode ) {
			tween.elem[ tween.prop ] = tween.now;
		}
	}
};

jQuery.easing = {
	linear: function( p ) {
		return p;
	},
	swing: function( p ) {
		return 0.5 - Math.cos( p * Math.PI ) / 2;
	},
	_default: "swing"
};

jQuery.fx = Tween.prototype.init;

// Back compat <1.8 extension point
jQuery.fx.step = {};




var
	fxNow, timerId,
	rfxtypes = /^(?:toggle|show|hide)$/,
	rrun = /queueHooks$/;

function raf() {
	if ( timerId ) {
		window.requestAnimationFrame( raf );
		jQuery.fx.tick();
	}
}

// Animations created synchronously will run synchronously
function createFxNow() {
	window.setTimeout( function() {
		fxNow = undefined;
	} );
	return ( fxNow = jQuery.now() );
}

// Generate parameters to create a standard animation
function genFx( type, includeWidth ) {
	var which,
		i = 0,
		attrs = { height: type };

	// If we include width, step value is 1 to do all cssExpand values,
	// otherwise step value is 2 to skip over Left and Right
	includeWidth = includeWidth ? 1 : 0;
	for ( ; i < 4; i += 2 - includeWidth ) {
		which = cssExpand[ i ];
		attrs[ "margin" + which ] = attrs[ "padding" + which ] = type;
	}

	if ( includeWidth ) {
		attrs.opacity = attrs.width = type;
	}

	return attrs;
}

function createTween( value, prop, animation ) {
	var tween,
		collection = ( Animation.tweeners[ prop ] || [] ).concat( Animation.tweeners[ "*" ] ),
		index = 0,
		length = collection.length;
	for ( ; index < length; index++ ) {
		if ( ( tween = collection[ index ].call( animation, prop, value ) ) ) {

			// We're done with this property
			return tween;
		}
	}
}

function defaultPrefilter( elem, props, opts ) {
	var prop, value, toggle, hooks, oldfire, propTween, restoreDisplay, display,
		isBox = "width" in props || "height" in props,
		anim = this,
		orig = {},
		style = elem.style,
		hidden = elem.nodeType && isHiddenWithinTree( elem ),
		dataShow = dataPriv.get( elem, "fxshow" );

	// Queue-skipping animations hijack the fx hooks
	if ( !opts.queue ) {
		hooks = jQuery._queueHooks( elem, "fx" );
		if ( hooks.unqueued == null ) {
			hooks.unqueued = 0;
			oldfire = hooks.empty.fire;
			hooks.empty.fire = function() {
				if ( !hooks.unqueued ) {
					oldfire();
				}
			};
		}
		hooks.unqueued++;

		anim.always( function() {

			// Ensure the complete handler is called before this completes
			anim.always( function() {
				hooks.unqueued--;
				if ( !jQuery.queue( elem, "fx" ).length ) {
					hooks.empty.fire();
				}
			} );
		} );
	}

	// Detect show/hide animations
	for ( prop in props ) {
		value = props[ prop ];
		if ( rfxtypes.test( value ) ) {
			delete props[ prop ];
			toggle = toggle || value === "toggle";
			if ( value === ( hidden ? "hide" : "show" ) ) {

				// Pretend to be hidden if this is a "show" and
				// there is still data from a stopped show/hide
				if ( value === "show" && dataShow && dataShow[ prop ] !== undefined ) {
					hidden = true;

				// Ignore all other no-op show/hide data
				} else {
					continue;
				}
			}
			orig[ prop ] = dataShow && dataShow[ prop ] || jQuery.style( elem, prop );
		}
	}

	// Bail out if this is a no-op like .hide().hide()
	propTween = !jQuery.isEmptyObject( props );
	if ( !propTween && jQuery.isEmptyObject( orig ) ) {
		return;
	}

	// Restrict "overflow" and "display" styles during box animations
	if ( isBox && elem.nodeType === 1 ) {

		// Support: IE <=9 - 11, Edge 12 - 13
		// Record all 3 overflow attributes because IE does not infer the shorthand
		// from identically-valued overflowX and overflowY
		opts.overflow = [ style.overflow, style.overflowX, style.overflowY ];

		// Identify a display type, preferring old show/hide data over the CSS cascade
		restoreDisplay = dataShow && dataShow.display;
		if ( restoreDisplay == null ) {
			restoreDisplay = dataPriv.get( elem, "display" );
		}
		display = jQuery.css( elem, "display" );
		if ( display === "none" ) {
			if ( restoreDisplay ) {
				display = restoreDisplay;
			} else {

				// Get nonempty value(s) by temporarily forcing visibility
				showHide( [ elem ], true );
				restoreDisplay = elem.style.display || restoreDisplay;
				display = jQuery.css( elem, "display" );
				showHide( [ elem ] );
			}
		}

		// Animate inline elements as inline-block
		if ( display === "inline" || display === "inline-block" && restoreDisplay != null ) {
			if ( jQuery.css( elem, "float" ) === "none" ) {

				// Restore the original display value at the end of pure show/hide animations
				if ( !propTween ) {
					anim.done( function() {
						style.display = restoreDisplay;
					} );
					if ( restoreDisplay == null ) {
						display = style.display;
						restoreDisplay = display === "none" ? "" : display;
					}
				}
				style.display = "inline-block";
			}
		}
	}

	if ( opts.overflow ) {
		style.overflow = "hidden";
		anim.always( function() {
			style.overflow = opts.overflow[ 0 ];
			style.overflowX = opts.overflow[ 1 ];
			style.overflowY = opts.overflow[ 2 ];
		} );
	}

	// Implement show/hide animations
	propTween = false;
	for ( prop in orig ) {

		// General show/hide setup for this element animation
		if ( !propTween ) {
			if ( dataShow ) {
				if ( "hidden" in dataShow ) {
					hidden = dataShow.hidden;
				}
			} else {
				dataShow = dataPriv.access( elem, "fxshow", { display: restoreDisplay } );
			}

			// Store hidden/visible for toggle so `.stop().toggle()` "reverses"
			if ( toggle ) {
				dataShow.hidden = !hidden;
			}

			// Show elements before animating them
			if ( hidden ) {
				showHide( [ elem ], true );
			}

			/* eslint-disable no-loop-func */

			anim.done( function() {

			/* eslint-enable no-loop-func */

				// The final step of a "hide" animation is actually hiding the element
				if ( !hidden ) {
					showHide( [ elem ] );
				}
				dataPriv.remove( elem, "fxshow" );
				for ( prop in orig ) {
					jQuery.style( elem, prop, orig[ prop ] );
				}
			} );
		}

		// Per-property setup
		propTween = createTween( hidden ? dataShow[ prop ] : 0, prop, anim );
		if ( !( prop in dataShow ) ) {
			dataShow[ prop ] = propTween.start;
			if ( hidden ) {
				propTween.end = propTween.start;
				propTween.start = 0;
			}
		}
	}
}

function propFilter( props, specialEasing ) {
	var index, name, easing, value, hooks;

	// camelCase, specialEasing and expand cssHook pass
	for ( index in props ) {
		name = jQuery.camelCase( index );
		easing = specialEasing[ name ];
		value = props[ index ];
		if ( jQuery.isArray( value ) ) {
			easing = value[ 1 ];
			value = props[ index ] = value[ 0 ];
		}

		if ( index !== name ) {
			props[ name ] = value;
			delete props[ index ];
		}

		hooks = jQuery.cssHooks[ name ];
		if ( hooks && "expand" in hooks ) {
			value = hooks.expand( value );
			delete props[ name ];

			// Not quite $.extend, this won't overwrite existing keys.
			// Reusing 'index' because we have the correct "name"
			for ( index in value ) {
				if ( !( index in props ) ) {
					props[ index ] = value[ index ];
					specialEasing[ index ] = easing;
				}
			}
		} else {
			specialEasing[ name ] = easing;
		}
	}
}

function Animation( elem, properties, options ) {
	var result,
		stopped,
		index = 0,
		length = Animation.prefilters.length,
		deferred = jQuery.Deferred().always( function() {

			// Don't match elem in the :animated selector
			delete tick.elem;
		} ),
		tick = function() {
			if ( stopped ) {
				return false;
			}
			var currentTime = fxNow || createFxNow(),
				remaining = Math.max( 0, animation.startTime + animation.duration - currentTime ),

				// Support: Android 2.3 only
				// Archaic crash bug won't allow us to use `1 - ( 0.5 || 0 )` (#12497)
				temp = remaining / animation.duration || 0,
				percent = 1 - temp,
				index = 0,
				length = animation.tweens.length;

			for ( ; index < length; index++ ) {
				animation.tweens[ index ].run( percent );
			}

			deferred.notifyWith( elem, [ animation, percent, remaining ] );

			if ( percent < 1 && length ) {
				return remaining;
			} else {
				deferred.resolveWith( elem, [ animation ] );
				return false;
			}
		},
		animation = deferred.promise( {
			elem: elem,
			props: jQuery.extend( {}, properties ),
			opts: jQuery.extend( true, {
				specialEasing: {},
				easing: jQuery.easing._default
			}, options ),
			originalProperties: properties,
			originalOptions: options,
			startTime: fxNow || createFxNow(),
			duration: options.duration,
			tweens: [],
			createTween: function( prop, end ) {
				var tween = jQuery.Tween( elem, animation.opts, prop, end,
						animation.opts.specialEasing[ prop ] || animation.opts.easing );
				animation.tweens.push( tween );
				return tween;
			},
			stop: function( gotoEnd ) {
				var index = 0,

					// If we are going to the end, we want to run all the tweens
					// otherwise we skip this part
					length = gotoEnd ? animation.tweens.length : 0;
				if ( stopped ) {
					return this;
				}
				stopped = true;
				for ( ; index < length; index++ ) {
					animation.tweens[ index ].run( 1 );
				}

				// Resolve when we played the last frame; otherwise, reject
				if ( gotoEnd ) {
					deferred.notifyWith( elem, [ animation, 1, 0 ] );
					deferred.resolveWith( elem, [ animation, gotoEnd ] );
				} else {
					deferred.rejectWith( elem, [ animation, gotoEnd ] );
				}
				return this;
			}
		} ),
		props = animation.props;

	propFilter( props, animation.opts.specialEasing );

	for ( ; index < length; index++ ) {
		result = Animation.prefilters[ index ].call( animation, elem, props, animation.opts );
		if ( result ) {
			if ( jQuery.isFunction( result.stop ) ) {
				jQuery._queueHooks( animation.elem, animation.opts.queue ).stop =
					jQuery.proxy( result.stop, result );
			}
			return result;
		}
	}

	jQuery.map( props, createTween, animation );

	if ( jQuery.isFunction( animation.opts.start ) ) {
		animation.opts.start.call( elem, animation );
	}

	jQuery.fx.timer(
		jQuery.extend( tick, {
			elem: elem,
			anim: animation,
			queue: animation.opts.queue
		} )
	);

	// attach callbacks from options
	return animation.progress( animation.opts.progress )
		.done( animation.opts.done, animation.opts.complete )
		.fail( animation.opts.fail )
		.always( animation.opts.always );
}

jQuery.Animation = jQuery.extend( Animation, {

	tweeners: {
		"*": [ function( prop, value ) {
			var tween = this.createTween( prop, value );
			adjustCSS( tween.elem, prop, rcssNum.exec( value ), tween );
			return tween;
		} ]
	},

	tweener: function( props, callback ) {
		if ( jQuery.isFunction( props ) ) {
			callback = props;
			props = [ "*" ];
		} else {
			props = props.match( rnothtmlwhite );
		}

		var prop,
			index = 0,
			length = props.length;

		for ( ; index < length; index++ ) {
			prop = props[ index ];
			Animation.tweeners[ prop ] = Animation.tweeners[ prop ] || [];
			Animation.tweeners[ prop ].unshift( callback );
		}
	},

	prefilters: [ defaultPrefilter ],

	prefilter: function( callback, prepend ) {
		if ( prepend ) {
			Animation.prefilters.unshift( callback );
		} else {
			Animation.prefilters.push( callback );
		}
	}
} );

jQuery.speed = function( speed, easing, fn ) {
	var opt = speed && typeof speed === "object" ? jQuery.extend( {}, speed ) : {
		complete: fn || !fn && easing ||
			jQuery.isFunction( speed ) && speed,
		duration: speed,
		easing: fn && easing || easing && !jQuery.isFunction( easing ) && easing
	};

	// Go to the end state if fx are off or if document is hidden
	if ( jQuery.fx.off || document.hidden ) {
		opt.duration = 0;

	} else {
		if ( typeof opt.duration !== "number" ) {
			if ( opt.duration in jQuery.fx.speeds ) {
				opt.duration = jQuery.fx.speeds[ opt.duration ];

			} else {
				opt.duration = jQuery.fx.speeds._default;
			}
		}
	}

	// Normalize opt.queue - true/undefined/null -> "fx"
	if ( opt.queue == null || opt.queue === true ) {
		opt.queue = "fx";
	}

	// Queueing
	opt.old = opt.complete;

	opt.complete = function() {
		if ( jQuery.isFunction( opt.old ) ) {
			opt.old.call( this );
		}

		if ( opt.queue ) {
			jQuery.dequeue( this, opt.queue );
		}
	};

	return opt;
};

jQuery.fn.extend( {
	fadeTo: function( speed, to, easing, callback ) {

		// Show any hidden elements after setting opacity to 0
		return this.filter( isHiddenWithinTree ).css( "opacity", 0 ).show()

			// Animate to the value specified
			.end().animate( { opacity: to }, speed, easing, callback );
	},
	animate: function( prop, speed, easing, callback ) {
		var empty = jQuery.isEmptyObject( prop ),
			optall = jQuery.speed( speed, easing, callback ),
			doAnimation = function() {

				// Operate on a copy of prop so per-property easing won't be lost
				var anim = Animation( this, jQuery.extend( {}, prop ), optall );

				// Empty animations, or finishing resolves immediately
				if ( empty || dataPriv.get( this, "finish" ) ) {
					anim.stop( true );
				}
			};
			doAnimation.finish = doAnimation;

		return empty || optall.queue === false ?
			this.each( doAnimation ) :
			this.queue( optall.queue, doAnimation );
	},
	stop: function( type, clearQueue, gotoEnd ) {
		var stopQueue = function( hooks ) {
			var stop = hooks.stop;
			delete hooks.stop;
			stop( gotoEnd );
		};

		if ( typeof type !== "string" ) {
			gotoEnd = clearQueue;
			clearQueue = type;
			type = undefined;
		}
		if ( clearQueue && type !== false ) {
			this.queue( type || "fx", [] );
		}

		return this.each( function() {
			var dequeue = true,
				index = type != null && type + "queueHooks",
				timers = jQuery.timers,
				data = dataPriv.get( this );

			if ( index ) {
				if ( data[ index ] && data[ index ].stop ) {
					stopQueue( data[ index ] );
				}
			} else {
				for ( index in data ) {
					if ( data[ index ] && data[ index ].stop && rrun.test( index ) ) {
						stopQueue( data[ index ] );
					}
				}
			}

			for ( index = timers.length; index--; ) {
				if ( timers[ index ].elem === this &&
					( type == null || timers[ index ].queue === type ) ) {

					timers[ index ].anim.stop( gotoEnd );
					dequeue = false;
					timers.splice( index, 1 );
				}
			}

			// Start the next in the queue if the last step wasn't forced.
			// Timers currently will call their complete callbacks, which
			// will dequeue but only if they were gotoEnd.
			if ( dequeue || !gotoEnd ) {
				jQuery.dequeue( this, type );
			}
		} );
	},
	finish: function( type ) {
		if ( type !== false ) {
			type = type || "fx";
		}
		return this.each( function() {
			var index,
				data = dataPriv.get( this ),
				queue = data[ type + "queue" ],
				hooks = data[ type + "queueHooks" ],
				timers = jQuery.timers,
				length = queue ? queue.length : 0;

			// Enable finishing flag on private data
			data.finish = true;

			// Empty the queue first
			jQuery.queue( this, type, [] );

			if ( hooks && hooks.stop ) {
				hooks.stop.call( this, true );
			}

			// Look for any active animations, and finish them
			for ( index = timers.length; index--; ) {
				if ( timers[ index ].elem === this && timers[ index ].queue === type ) {
					timers[ index ].anim.stop( true );
					timers.splice( index, 1 );
				}
			}

			// Look for any animations in the old queue and finish them
			for ( index = 0; index < length; index++ ) {
				if ( queue[ index ] && queue[ index ].finish ) {
					queue[ index ].finish.call( this );
				}
			}

			// Turn off finishing flag
			delete data.finish;
		} );
	}
} );

jQuery.each( [ "toggle", "show", "hide" ], function( i, name ) {
	var cssFn = jQuery.fn[ name ];
	jQuery.fn[ name ] = function( speed, easing, callback ) {
		return speed == null || typeof speed === "boolean" ?
			cssFn.apply( this, arguments ) :
			this.animate( genFx( name, true ), speed, easing, callback );
	};
} );

// Generate shortcuts for custom animations
jQuery.each( {
	slideDown: genFx( "show" ),
	slideUp: genFx( "hide" ),
	slideToggle: genFx( "toggle" ),
	fadeIn: { opacity: "show" },
	fadeOut: { opacity: "hide" },
	fadeToggle: { opacity: "toggle" }
}, function( name, props ) {
	jQuery.fn[ name ] = function( speed, easing, callback ) {
		return this.animate( props, speed, easing, callback );
	};
} );

jQuery.timers = [];
jQuery.fx.tick = function() {
	var timer,
		i = 0,
		timers = jQuery.timers;

	fxNow = jQuery.now();

	for ( ; i < timers.length; i++ ) {
		timer = timers[ i ];

		// Checks the timer has not already been removed
		if ( !timer() && timers[ i ] === timer ) {
			timers.splice( i--, 1 );
		}
	}

	if ( !timers.length ) {
		jQuery.fx.stop();
	}
	fxNow = undefined;
};

jQuery.fx.timer = function( timer ) {
	jQuery.timers.push( timer );
	if ( timer() ) {
		jQuery.fx.start();
	} else {
		jQuery.timers.pop();
	}
};

jQuery.fx.interval = 13;
jQuery.fx.start = function() {
	if ( !timerId ) {
		timerId = window.requestAnimationFrame ?
			window.requestAnimationFrame( raf ) :
			window.setInterval( jQuery.fx.tick, jQuery.fx.interval );
	}
};

jQuery.fx.stop = function() {
	if ( window.cancelAnimationFrame ) {
		window.cancelAnimationFrame( timerId );
	} else {
		window.clearInterval( timerId );
	}

	timerId = null;
};

jQuery.fx.speeds = {
	slow: 600,
	fast: 200,

	// Default speed
	_default: 400
};


// Based off of the plugin by Clint Helfers, with permission.
// https://web.archive.org/web/20100324014747/http://blindsignals.com/index.php/2009/07/jquery-delay/
jQuery.fn.delay = function( time, type ) {
	time = jQuery.fx ? jQuery.fx.speeds[ time ] || time : time;
	type = type || "fx";

	return this.queue( type, function( next, hooks ) {
		var timeout = window.setTimeout( next, time );
		hooks.stop = function() {
			window.clearTimeout( timeout );
		};
	} );
};


( function() {
	var input = document.createElement( "input" ),
		select = document.createElement( "select" ),
		opt = select.appendChild( document.createElement( "option" ) );

	input.type = "checkbox";

	// Support: Android <=4.3 only
	// Default value for a checkbox should be "on"
	support.checkOn = input.value !== "";

	// Support: IE <=11 only
	// Must access selectedIndex to make default options select
	support.optSelected = opt.selected;

	// Support: IE <=11 only
	// An input loses its value after becoming a radio
	input = document.createElement( "input" );
	input.value = "t";
	input.type = "radio";
	support.radioValue = input.value === "t";
} )();


var boolHook,
	attrHandle = jQuery.expr.attrHandle;

jQuery.fn.extend( {
	attr: function( name, value ) {
		return access( this, jQuery.attr, name, value, arguments.length > 1 );
	},

	removeAttr: function( name ) {
		return this.each( function() {
			jQuery.removeAttr( this, name );
		} );
	}
} );

jQuery.extend( {
	attr: function( elem, name, value ) {
		var ret, hooks,
			nType = elem.nodeType;

		// Don't get/set attributes on text, comment and attribute nodes
		if ( nType === 3 || nType === 8 || nType === 2 ) {
			return;
		}

		// Fallback to prop when attributes are not supported
		if ( typeof elem.getAttribute === "undefined" ) {
			return jQuery.prop( elem, name, value );
		}

		// Attribute hooks are determined by the lowercase version
		// Grab necessary hook if one is defined
		if ( nType !== 1 || !jQuery.isXMLDoc( elem ) ) {
			hooks = jQuery.attrHooks[ name.toLowerCase() ] ||
				( jQuery.expr.match.bool.test( name ) ? boolHook : undefined );
		}

		if ( value !== undefined ) {
			if ( value === null ) {
				jQuery.removeAttr( elem, name );
				return;
			}

			if ( hooks && "set" in hooks &&
				( ret = hooks.set( elem, value, name ) ) !== undefined ) {
				return ret;
			}

			elem.setAttribute( name, value + "" );
			return value;
		}

		if ( hooks && "get" in hooks && ( ret = hooks.get( elem, name ) ) !== null ) {
			return ret;
		}

		ret = jQuery.find.attr( elem, name );

		// Non-existent attributes return null, we normalize to undefined
		return ret == null ? undefined : ret;
	},

	attrHooks: {
		type: {
			set: function( elem, value ) {
				if ( !support.radioValue && value === "radio" &&
					jQuery.nodeName( elem, "input" ) ) {
					var val = elem.value;
					elem.setAttribute( "type", value );
					if ( val ) {
						elem.value = val;
					}
					return value;
				}
			}
		}
	},

	removeAttr: function( elem, value ) {
		var name,
			i = 0,

			// Attribute names can contain non-HTML whitespace characters
			// https://html.spec.whatwg.org/multipage/syntax.html#attributes-2
			attrNames = value && value.match( rnothtmlwhite );

		if ( attrNames && elem.nodeType === 1 ) {
			while ( ( name = attrNames[ i++ ] ) ) {
				elem.removeAttribute( name );
			}
		}
	}
} );

// Hooks for boolean attributes
boolHook = {
	set: function( elem, value, name ) {
		if ( value === false ) {

			// Remove boolean attributes when set to false
			jQuery.removeAttr( elem, name );
		} else {
			elem.setAttribute( name, name );
		}
		return name;
	}
};

jQuery.each( jQuery.expr.match.bool.source.match( /\w+/g ), function( i, name ) {
	var getter = attrHandle[ name ] || jQuery.find.attr;

	attrHandle[ name ] = function( elem, name, isXML ) {
		var ret, handle,
			lowercaseName = name.toLowerCase();

		if ( !isXML ) {

			// Avoid an infinite loop by temporarily removing this function from the getter
			handle = attrHandle[ lowercaseName ];
			attrHandle[ lowercaseName ] = ret;
			ret = getter( elem, name, isXML ) != null ?
				lowercaseName :
				null;
			attrHandle[ lowercaseName ] = handle;
		}
		return ret;
	};
} );




var rfocusable = /^(?:input|select|textarea|button)$/i,
	rclickable = /^(?:a|area)$/i;

jQuery.fn.extend( {
	prop: function( name, value ) {
		return access( this, jQuery.prop, name, value, arguments.length > 1 );
	},

	removeProp: function( name ) {
		return this.each( function() {
			delete this[ jQuery.propFix[ name ] || name ];
		} );
	}
} );

jQuery.extend( {
	prop: function( elem, name, value ) {
		var ret, hooks,
			nType = elem.nodeType;

		// Don't get/set properties on text, comment and attribute nodes
		if ( nType === 3 || nType === 8 || nType === 2 ) {
			return;
		}

		if ( nType !== 1 || !jQuery.isXMLDoc( elem ) ) {

			// Fix name and attach hooks
			name = jQuery.propFix[ name ] || name;
			hooks = jQuery.propHooks[ name ];
		}

		if ( value !== undefined ) {
			if ( hooks && "set" in hooks &&
				( ret = hooks.set( elem, value, name ) ) !== undefined ) {
				return ret;
			}

			return ( elem[ name ] = value );
		}

		if ( hooks && "get" in hooks && ( ret = hooks.get( elem, name ) ) !== null ) {
			return ret;
		}

		return elem[ name ];
	},

	propHooks: {
		tabIndex: {
			get: function( elem ) {

				// Support: IE <=9 - 11 only
				// elem.tabIndex doesn't always return the
				// correct value when it hasn't been explicitly set
				// https://web.archive.org/web/20141116233347/http://fluidproject.org/blog/2008/01/09/getting-setting-and-removing-tabindex-values-with-javascript/
				// Use proper attribute retrieval(#12072)
				var tabindex = jQuery.find.attr( elem, "tabindex" );

				if ( tabindex ) {
					return parseInt( tabindex, 10 );
				}

				if (
					rfocusable.test( elem.nodeName ) ||
					rclickable.test( elem.nodeName ) &&
					elem.href
				) {
					return 0;
				}

				return -1;
			}
		}
	},

	propFix: {
		"for": "htmlFor",
		"class": "className"
	}
} );

// Support: IE <=11 only
// Accessing the selectedIndex property
// forces the browser to respect setting selected
// on the option
// The getter ensures a default option is selected
// when in an optgroup
// eslint rule "no-unused-expressions" is disabled for this code
// since it considers such accessions noop
if ( !support.optSelected ) {
	jQuery.propHooks.selected = {
		get: function( elem ) {

			/* eslint no-unused-expressions: "off" */

			var parent = elem.parentNode;
			if ( parent && parent.parentNode ) {
				parent.parentNode.selectedIndex;
			}
			return null;
		},
		set: function( elem ) {

			/* eslint no-unused-expressions: "off" */

			var parent = elem.parentNode;
			if ( parent ) {
				parent.selectedIndex;

				if ( parent.parentNode ) {
					parent.parentNode.selectedIndex;
				}
			}
		}
	};
}

jQuery.each( [
	"tabIndex",
	"readOnly",
	"maxLength",
	"cellSpacing",
	"cellPadding",
	"rowSpan",
	"colSpan",
	"useMap",
	"frameBorder",
	"contentEditable"
], function() {
	jQuery.propFix[ this.toLowerCase() ] = this;
} );




	// Strip and collapse whitespace according to HTML spec
	// https://html.spec.whatwg.org/multipage/infrastructure.html#strip-and-collapse-whitespace
	function stripAndCollapse( value ) {
		var tokens = value.match( rnothtmlwhite ) || [];
		return tokens.join( " " );
	}


function getClass( elem ) {
	return elem.getAttribute && elem.getAttribute( "class" ) || "";
}

jQuery.fn.extend( {
	addClass: function( value ) {
		var classes, elem, cur, curValue, clazz, j, finalValue,
			i = 0;

		if ( jQuery.isFunction( value ) ) {
			return this.each( function( j ) {
				jQuery( this ).addClass( value.call( this, j, getClass( this ) ) );
			} );
		}

		if ( typeof value === "string" && value ) {
			classes = value.match( rnothtmlwhite ) || [];

			while ( ( elem = this[ i++ ] ) ) {
				curValue = getClass( elem );
				cur = elem.nodeType === 1 && ( " " + stripAndCollapse( curValue ) + " " );

				if ( cur ) {
					j = 0;
					while ( ( clazz = classes[ j++ ] ) ) {
						if ( cur.indexOf( " " + clazz + " " ) < 0 ) {
							cur += clazz + " ";
						}
					}

					// Only assign if different to avoid unneeded rendering.
					finalValue = stripAndCollapse( cur );
					if ( curValue !== finalValue ) {
						elem.setAttribute( "class", finalValue );
					}
				}
			}
		}

		return this;
	},

	removeClass: function( value ) {
		var classes, elem, cur, curValue, clazz, j, finalValue,
			i = 0;

		if ( jQuery.isFunction( value ) ) {
			return this.each( function( j ) {
				jQuery( this ).removeClass( value.call( this, j, getClass( this ) ) );
			} );
		}

		if ( !arguments.length ) {
			return this.attr( "class", "" );
		}

		if ( typeof value === "string" && value ) {
			classes = value.match( rnothtmlwhite ) || [];

			while ( ( elem = this[ i++ ] ) ) {
				curValue = getClass( elem );

				// This expression is here for better compressibility (see addClass)
				cur = elem.nodeType === 1 && ( " " + stripAndCollapse( curValue ) + " " );

				if ( cur ) {
					j = 0;
					while ( ( clazz = classes[ j++ ] ) ) {

						// Remove *all* instances
						while ( cur.indexOf( " " + clazz + " " ) > -1 ) {
							cur = cur.replace( " " + clazz + " ", " " );
						}
					}

					// Only assign if different to avoid unneeded rendering.
					finalValue = stripAndCollapse( cur );
					if ( curValue !== finalValue ) {
						elem.setAttribute( "class", finalValue );
					}
				}
			}
		}

		return this;
	},

	toggleClass: function( value, stateVal ) {
		var type = typeof value;

		if ( typeof stateVal === "boolean" && type === "string" ) {
			return stateVal ? this.addClass( value ) : this.removeClass( value );
		}

		if ( jQuery.isFunction( value ) ) {
			return this.each( function( i ) {
				jQuery( this ).toggleClass(
					value.call( this, i, getClass( this ), stateVal ),
					stateVal
				);
			} );
		}

		return this.each( function() {
			var className, i, self, classNames;

			if ( type === "string" ) {

				// Toggle individual class names
				i = 0;
				self = jQuery( this );
				classNames = value.match( rnothtmlwhite ) || [];

				while ( ( className = classNames[ i++ ] ) ) {

					// Check each className given, space separated list
					if ( self.hasClass( className ) ) {
						self.removeClass( className );
					} else {
						self.addClass( className );
					}
				}

			// Toggle whole class name
			} else if ( value === undefined || type === "boolean" ) {
				className = getClass( this );
				if ( className ) {

					// Store className if set
					dataPriv.set( this, "__className__", className );
				}

				// If the element has a class name or if we're passed `false`,
				// then remove the whole classname (if there was one, the above saved it).
				// Otherwise bring back whatever was previously saved (if anything),
				// falling back to the empty string if nothing was stored.
				if ( this.setAttribute ) {
					this.setAttribute( "class",
						className || value === false ?
						"" :
						dataPriv.get( this, "__className__" ) || ""
					);
				}
			}
		} );
	},

	hasClass: function( selector ) {
		var className, elem,
			i = 0;

		className = " " + selector + " ";
		while ( ( elem = this[ i++ ] ) ) {
			if ( elem.nodeType === 1 &&
				( " " + stripAndCollapse( getClass( elem ) ) + " " ).indexOf( className ) > -1 ) {
					return true;
			}
		}

		return false;
	}
} );




var rreturn = /\r/g;

jQuery.fn.extend( {
	val: function( value ) {
		var hooks, ret, isFunction,
			elem = this[ 0 ];

		if ( !arguments.length ) {
			if ( elem ) {
				hooks = jQuery.valHooks[ elem.type ] ||
					jQuery.valHooks[ elem.nodeName.toLowerCase() ];

				if ( hooks &&
					"get" in hooks &&
					( ret = hooks.get( elem, "value" ) ) !== undefined
				) {
					return ret;
				}

				ret = elem.value;

				// Handle most common string cases
				if ( typeof ret === "string" ) {
					return ret.replace( rreturn, "" );
				}

				// Handle cases where value is null/undef or number
				return ret == null ? "" : ret;
			}

			return;
		}

		isFunction = jQuery.isFunction( value );

		return this.each( function( i ) {
			var val;

			if ( this.nodeType !== 1 ) {
				return;
			}

			if ( isFunction ) {
				val = value.call( this, i, jQuery( this ).val() );
			} else {
				val = value;
			}

			// Treat null/undefined as ""; convert numbers to string
			if ( val == null ) {
				val = "";

			} else if ( typeof val === "number" ) {
				val += "";

			} else if ( jQuery.isArray( val ) ) {
				val = jQuery.map( val, function( value ) {
					return value == null ? "" : value + "";
				} );
			}

			hooks = jQuery.valHooks[ this.type ] || jQuery.valHooks[ this.nodeName.toLowerCase() ];

			// If set returns undefined, fall back to normal setting
			if ( !hooks || !( "set" in hooks ) || hooks.set( this, val, "value" ) === undefined ) {
				this.value = val;
			}
		} );
	}
} );

jQuery.extend( {
	valHooks: {
		option: {
			get: function( elem ) {

				var val = jQuery.find.attr( elem, "value" );
				return val != null ?
					val :

					// Support: IE <=10 - 11 only
					// option.text throws exceptions (#14686, #14858)
					// Strip and collapse whitespace
					// https://html.spec.whatwg.org/#strip-and-collapse-whitespace
					stripAndCollapse( jQuery.text( elem ) );
			}
		},
		select: {
			get: function( elem ) {
				var value, option, i,
					options = elem.options,
					index = elem.selectedIndex,
					one = elem.type === "select-one",
					values = one ? null : [],
					max = one ? index + 1 : options.length;

				if ( index < 0 ) {
					i = max;

				} else {
					i = one ? index : 0;
				}

				// Loop through all the selected options
				for ( ; i < max; i++ ) {
					option = options[ i ];

					// Support: IE <=9 only
					// IE8-9 doesn't update selected after form reset (#2551)
					if ( ( option.selected || i === index ) &&

							// Don't return options that are disabled or in a disabled optgroup
							!option.disabled &&
							( !option.parentNode.disabled ||
								!jQuery.nodeName( option.parentNode, "optgroup" ) ) ) {

						// Get the specific value for the option
						value = jQuery( option ).val();

						// We don't need an array for one selects
						if ( one ) {
							return value;
						}

						// Multi-Selects return an array
						values.push( value );
					}
				}

				return values;
			},

			set: function( elem, value ) {
				var optionSet, option,
					options = elem.options,
					values = jQuery.makeArray( value ),
					i = options.length;

				while ( i-- ) {
					option = options[ i ];

					/* eslint-disable no-cond-assign */

					if ( option.selected =
						jQuery.inArray( jQuery.valHooks.option.get( option ), values ) > -1
					) {
						optionSet = true;
					}

					/* eslint-enable no-cond-assign */
				}

				// Force browsers to behave consistently when non-matching value is set
				if ( !optionSet ) {
					elem.selectedIndex = -1;
				}
				return values;
			}
		}
	}
} );

// Radios and checkboxes getter/setter
jQuery.each( [ "radio", "checkbox" ], function() {
	jQuery.valHooks[ this ] = {
		set: function( elem, value ) {
			if ( jQuery.isArray( value ) ) {
				return ( elem.checked = jQuery.inArray( jQuery( elem ).val(), value ) > -1 );
			}
		}
	};
	if ( !support.checkOn ) {
		jQuery.valHooks[ this ].get = function( elem ) {
			return elem.getAttribute( "value" ) === null ? "on" : elem.value;
		};
	}
} );




// Return jQuery for attributes-only inclusion


var rfocusMorph = /^(?:focusinfocus|focusoutblur)$/;

jQuery.extend( jQuery.event, {

	trigger: function( event, data, elem, onlyHandlers ) {

		var i, cur, tmp, bubbleType, ontype, handle, special,
			eventPath = [ elem || document ],
			type = hasOwn.call( event, "type" ) ? event.type : event,
			namespaces = hasOwn.call( event, "namespace" ) ? event.namespace.split( "." ) : [];

		cur = tmp = elem = elem || document;

		// Don't do events on text and comment nodes
		if ( elem.nodeType === 3 || elem.nodeType === 8 ) {
			return;
		}

		// focus/blur morphs to focusin/out; ensure we're not firing them right now
		if ( rfocusMorph.test( type + jQuery.event.triggered ) ) {
			return;
		}

		if ( type.indexOf( "." ) > -1 ) {

			// Namespaced trigger; create a regexp to match event type in handle()
			namespaces = type.split( "." );
			type = namespaces.shift();
			namespaces.sort();
		}
		ontype = type.indexOf( ":" ) < 0 && "on" + type;

		// Caller can pass in a jQuery.Event object, Object, or just an event type string
		event = event[ jQuery.expando ] ?
			event :
			new jQuery.Event( type, typeof event === "object" && event );

		// Trigger bitmask: & 1 for native handlers; & 2 for jQuery (always true)
		event.isTrigger = onlyHandlers ? 2 : 3;
		event.namespace = namespaces.join( "." );
		event.rnamespace = event.namespace ?
			new RegExp( "(^|\\.)" + namespaces.join( "\\.(?:.*\\.|)" ) + "(\\.|$)" ) :
			null;

		// Clean up the event in case it is being reused
		event.result = undefined;
		if ( !event.target ) {
			event.target = elem;
		}

		// Clone any incoming data and prepend the event, creating the handler arg list
		data = data == null ?
			[ event ] :
			jQuery.makeArray( data, [ event ] );

		// Allow special events to draw outside the lines
		special = jQuery.event.special[ type ] || {};
		if ( !onlyHandlers && special.trigger && special.trigger.apply( elem, data ) === false ) {
			return;
		}

		// Determine event propagation path in advance, per W3C events spec (#9951)
		// Bubble up to document, then to window; watch for a global ownerDocument var (#9724)
		if ( !onlyHandlers && !special.noBubble && !jQuery.isWindow( elem ) ) {

			bubbleType = special.delegateType || type;
			if ( !rfocusMorph.test( bubbleType + type ) ) {
				cur = cur.parentNode;
			}
			for ( ; cur; cur = cur.parentNode ) {
				eventPath.push( cur );
				tmp = cur;
			}

			// Only add window if we got to document (e.g., not plain obj or detached DOM)
			if ( tmp === ( elem.ownerDocument || document ) ) {
				eventPath.push( tmp.defaultView || tmp.parentWindow || window );
			}
		}

		// Fire handlers on the event path
		i = 0;
		while ( ( cur = eventPath[ i++ ] ) && !event.isPropagationStopped() ) {

			event.type = i > 1 ?
				bubbleType :
				special.bindType || type;

			// jQuery handler
			handle = ( dataPriv.get( cur, "events" ) || {} )[ event.type ] &&
				dataPriv.get( cur, "handle" );
			if ( handle ) {
				handle.apply( cur, data );
			}

			// Native handler
			handle = ontype && cur[ ontype ];
			if ( handle && handle.apply && acceptData( cur ) ) {
				event.result = handle.apply( cur, data );
				if ( event.result === false ) {
					event.preventDefault();
				}
			}
		}
		event.type = type;

		// If nobody prevented the default action, do it now
		if ( !onlyHandlers && !event.isDefaultPrevented() ) {

			if ( ( !special._default ||
				special._default.apply( eventPath.pop(), data ) === false ) &&
				acceptData( elem ) ) {

				// Call a native DOM method on the target with the same name as the event.
				// Don't do default actions on window, that's where global variables be (#6170)
				if ( ontype && jQuery.isFunction( elem[ type ] ) && !jQuery.isWindow( elem ) ) {

					// Don't re-trigger an onFOO event when we call its FOO() method
					tmp = elem[ ontype ];

					if ( tmp ) {
						elem[ ontype ] = null;
					}

					// Prevent re-triggering of the same event, since we already bubbled it above
					jQuery.event.triggered = type;
					elem[ type ]();
					jQuery.event.triggered = undefined;

					if ( tmp ) {
						elem[ ontype ] = tmp;
					}
				}
			}
		}

		return event.result;
	},

	// Piggyback on a donor event to simulate a different one
	// Used only for `focus(in | out)` events
	simulate: function( type, elem, event ) {
		var e = jQuery.extend(
			new jQuery.Event(),
			event,
			{
				type: type,
				isSimulated: true
			}
		);

		jQuery.event.trigger( e, null, elem );
	}

} );

jQuery.fn.extend( {

	trigger: function( type, data ) {
		return this.each( function() {
			jQuery.event.trigger( type, data, this );
		} );
	},
	triggerHandler: function( type, data ) {
		var elem = this[ 0 ];
		if ( elem ) {
			return jQuery.event.trigger( type, data, elem, true );
		}
	}
} );


jQuery.each( ( "blur focus focusin focusout resize scroll click dblclick " +
	"mousedown mouseup mousemove mouseover mouseout mouseenter mouseleave " +
	"change select submit keydown keypress keyup contextmenu" ).split( " " ),
	function( i, name ) {

	// Handle event binding
	jQuery.fn[ name ] = function( data, fn ) {
		return arguments.length > 0 ?
			this.on( name, null, data, fn ) :
			this.trigger( name );
	};
} );

jQuery.fn.extend( {
	hover: function( fnOver, fnOut ) {
		return this.mouseenter( fnOver ).mouseleave( fnOut || fnOver );
	}
} );




support.focusin = "onfocusin" in window;


// Support: Firefox <=44
// Firefox doesn't have focus(in | out) events
// Related ticket - https://bugzilla.mozilla.org/show_bug.cgi?id=687787
//
// Support: Chrome <=48 - 49, Safari <=9.0 - 9.1
// focus(in | out) events fire after focus & blur events,
// which is spec violation - http://www.w3.org/TR/DOM-Level-3-Events/#events-focusevent-event-order
// Related ticket - https://bugs.chromium.org/p/chromium/issues/detail?id=449857
if ( !support.focusin ) {
	jQuery.each( { focus: "focusin", blur: "focusout" }, function( orig, fix ) {

		// Attach a single capturing handler on the document while someone wants focusin/focusout
		var handler = function( event ) {
			jQuery.event.simulate( fix, event.target, jQuery.event.fix( event ) );
		};

		jQuery.event.special[ fix ] = {
			setup: function() {
				var doc = this.ownerDocument || this,
					attaches = dataPriv.access( doc, fix );

				if ( !attaches ) {
					doc.addEventListener( orig, handler, true );
				}
				dataPriv.access( doc, fix, ( attaches || 0 ) + 1 );
			},
			teardown: function() {
				var doc = this.ownerDocument || this,
					attaches = dataPriv.access( doc, fix ) - 1;

				if ( !attaches ) {
					doc.removeEventListener( orig, handler, true );
					dataPriv.remove( doc, fix );

				} else {
					dataPriv.access( doc, fix, attaches );
				}
			}
		};
	} );
}
var location = window.location;

var nonce = jQuery.now();

var rquery = ( /\?/ );



// Cross-browser xml parsing
jQuery.parseXML = function( data ) {
	var xml;
	if ( !data || typeof data !== "string" ) {
		return null;
	}

	// Support: IE 9 - 11 only
	// IE throws on parseFromString with invalid input.
	try {
		xml = ( new window.DOMParser() ).parseFromString( data, "text/xml" );
	} catch ( e ) {
		xml = undefined;
	}

	if ( !xml || xml.getElementsByTagName( "parsererror" ).length ) {
		jQuery.error( "Invalid XML: " + data );
	}
	return xml;
};


var
	rbracket = /\[\]$/,
	rCRLF = /\r?\n/g,
	rsubmitterTypes = /^(?:submit|button|image|reset|file)$/i,
	rsubmittable = /^(?:input|select|textarea|keygen)/i;

function buildParams( prefix, obj, traditional, add ) {
	var name;

	if ( jQuery.isArray( obj ) ) {

		// Serialize array item.
		jQuery.each( obj, function( i, v ) {
			if ( traditional || rbracket.test( prefix ) ) {

				// Treat each array item as a scalar.
				add( prefix, v );

			} else {

				// Item is non-scalar (array or object), encode its numeric index.
				buildParams(
					prefix + "[" + ( typeof v === "object" && v != null ? i : "" ) + "]",
					v,
					traditional,
					add
				);
			}
		} );

	} else if ( !traditional && jQuery.type( obj ) === "object" ) {

		// Serialize object item.
		for ( name in obj ) {
			buildParams( prefix + "[" + name + "]", obj[ name ], traditional, add );
		}

	} else {

		// Serialize scalar item.
		add( prefix, obj );
	}
}

// Serialize an array of form elements or a set of
// key/values into a query string
jQuery.param = function( a, traditional ) {
	var prefix,
		s = [],
		add = function( key, valueOrFunction ) {

			// If value is a function, invoke it and use its return value
			var value = jQuery.isFunction( valueOrFunction ) ?
				valueOrFunction() :
				valueOrFunction;

			s[ s.length ] = encodeURIComponent( key ) + "=" +
				encodeURIComponent( value == null ? "" : value );
		};

	// If an array was passed in, assume that it is an array of form elements.
	if ( jQuery.isArray( a ) || ( a.jquery && !jQuery.isPlainObject( a ) ) ) {

		// Serialize the form elements
		jQuery.each( a, function() {
			add( this.name, this.value );
		} );

	} else {

		// If traditional, encode the "old" way (the way 1.3.2 or older
		// did it), otherwise encode params recursively.
		for ( prefix in a ) {
			buildParams( prefix, a[ prefix ], traditional, add );
		}
	}

	// Return the resulting serialization
	return s.join( "&" );
};

jQuery.fn.extend( {
	serialize: function() {
		return jQuery.param( this.serializeArray() );
	},
	serializeArray: function() {
		return this.map( function() {

			// Can add propHook for "elements" to filter or add form elements
			var elements = jQuery.prop( this, "elements" );
			return elements ? jQuery.makeArray( elements ) : this;
		} )
		.filter( function() {
			var type = this.type;

			// Use .is( ":disabled" ) so that fieldset[disabled] works
			return this.name && !jQuery( this ).is( ":disabled" ) &&
				rsubmittable.test( this.nodeName ) && !rsubmitterTypes.test( type ) &&
				( this.checked || !rcheckableType.test( type ) );
		} )
		.map( function( i, elem ) {
			var val = jQuery( this ).val();

			if ( val == null ) {
				return null;
			}

			if ( jQuery.isArray( val ) ) {
				return jQuery.map( val, function( val ) {
					return { name: elem.name, value: val.replace( rCRLF, "\r\n" ) };
				} );
			}

			return { name: elem.name, value: val.replace( rCRLF, "\r\n" ) };
		} ).get();
	}
} );


var
	r20 = /%20/g,
	rhash = /#.*$/,
	rantiCache = /([?&])_=[^&]*/,
	rheaders = /^(.*?):[ \t]*([^\r\n]*)$/mg,

	// #7653, #8125, #8152: local protocol detection
	rlocalProtocol = /^(?:about|app|app-storage|.+-extension|file|res|widget):$/,
	rnoContent = /^(?:GET|HEAD)$/,
	rprotocol = /^\/\//,

	/* Prefilters
	 * 1) They are useful to introduce custom dataTypes (see ajax/jsonp.js for an example)
	 * 2) These are called:
	 *    - BEFORE asking for a transport
	 *    - AFTER param serialization (s.data is a string if s.processData is true)
	 * 3) key is the dataType
	 * 4) the catchall symbol "*" can be used
	 * 5) execution will start with transport dataType and THEN continue down to "*" if needed
	 */
	prefilters = {},

	/* Transports bindings
	 * 1) key is the dataType
	 * 2) the catchall symbol "*" can be used
	 * 3) selection will start with transport dataType and THEN go to "*" if needed
	 */
	transports = {},

	// Avoid comment-prolog char sequence (#10098); must appease lint and evade compression
	allTypes = "*/".concat( "*" ),

	// Anchor tag for parsing the document origin
	originAnchor = document.createElement( "a" );
	originAnchor.href = location.href;

// Base "constructor" for jQuery.ajaxPrefilter and jQuery.ajaxTransport
function addToPrefiltersOrTransports( structure ) {

	// dataTypeExpression is optional and defaults to "*"
	return function( dataTypeExpression, func ) {

		if ( typeof dataTypeExpression !== "string" ) {
			func = dataTypeExpression;
			dataTypeExpression = "*";
		}

		var dataType,
			i = 0,
			dataTypes = dataTypeExpression.toLowerCase().match( rnothtmlwhite ) || [];

		if ( jQuery.isFunction( func ) ) {

			// For each dataType in the dataTypeExpression
			while ( ( dataType = dataTypes[ i++ ] ) ) {

				// Prepend if requested
				if ( dataType[ 0 ] === "+" ) {
					dataType = dataType.slice( 1 ) || "*";
					( structure[ dataType ] = structure[ dataType ] || [] ).unshift( func );

				// Otherwise append
				} else {
					( structure[ dataType ] = structure[ dataType ] || [] ).push( func );
				}
			}
		}
	};
}

// Base inspection function for prefilters and transports
function inspectPrefiltersOrTransports( structure, options, originalOptions, jqXHR ) {

	var inspected = {},
		seekingTransport = ( structure === transports );

	function inspect( dataType ) {
		var selected;
		inspected[ dataType ] = true;
		jQuery.each( structure[ dataType ] || [], function( _, prefilterOrFactory ) {
			var dataTypeOrTransport = prefilterOrFactory( options, originalOptions, jqXHR );
			if ( typeof dataTypeOrTransport === "string" &&
				!seekingTransport && !inspected[ dataTypeOrTransport ] ) {

				options.dataTypes.unshift( dataTypeOrTransport );
				inspect( dataTypeOrTransport );
				return false;
			} else if ( seekingTransport ) {
				return !( selected = dataTypeOrTransport );
			}
		} );
		return selected;
	}

	return inspect( options.dataTypes[ 0 ] ) || !inspected[ "*" ] && inspect( "*" );
}

// A special extend for ajax options
// that takes "flat" options (not to be deep extended)
// Fixes #9887
function ajaxExtend( target, src ) {
	var key, deep,
		flatOptions = jQuery.ajaxSettings.flatOptions || {};

	for ( key in src ) {
		if ( src[ key ] !== undefined ) {
			( flatOptions[ key ] ? target : ( deep || ( deep = {} ) ) )[ key ] = src[ key ];
		}
	}
	if ( deep ) {
		jQuery.extend( true, target, deep );
	}

	return target;
}

/* Handles responses to an ajax request:
 * - finds the right dataType (mediates between content-type and expected dataType)
 * - returns the corresponding response
 */
function ajaxHandleResponses( s, jqXHR, responses ) {

	var ct, type, finalDataType, firstDataType,
		contents = s.contents,
		dataTypes = s.dataTypes;

	// Remove auto dataType and get content-type in the process
	while ( dataTypes[ 0 ] === "*" ) {
		dataTypes.shift();
		if ( ct === undefined ) {
			ct = s.mimeType || jqXHR.getResponseHeader( "Content-Type" );
		}
	}

	// Check if we're dealing with a known content-type
	if ( ct ) {
		for ( type in contents ) {
			if ( contents[ type ] && contents[ type ].test( ct ) ) {
				dataTypes.unshift( type );
				break;
			}
		}
	}

	// Check to see if we have a response for the expected dataType
	if ( dataTypes[ 0 ] in responses ) {
		finalDataType = dataTypes[ 0 ];
	} else {

		// Try convertible dataTypes
		for ( type in responses ) {
			if ( !dataTypes[ 0 ] || s.converters[ type + " " + dataTypes[ 0 ] ] ) {
				finalDataType = type;
				break;
			}
			if ( !firstDataType ) {
				firstDataType = type;
			}
		}

		// Or just use first one
		finalDataType = finalDataType || firstDataType;
	}

	// If we found a dataType
	// We add the dataType to the list if needed
	// and return the corresponding response
	if ( finalDataType ) {
		if ( finalDataType !== dataTypes[ 0 ] ) {
			dataTypes.unshift( finalDataType );
		}
		return responses[ finalDataType ];
	}
}

/* Chain conversions given the request and the original response
 * Also sets the responseXXX fields on the jqXHR instance
 */
function ajaxConvert( s, response, jqXHR, isSuccess ) {
	var conv2, current, conv, tmp, prev,
		converters = {},

		// Work with a copy of dataTypes in case we need to modify it for conversion
		dataTypes = s.dataTypes.slice();

	// Create converters map with lowercased keys
	if ( dataTypes[ 1 ] ) {
		for ( conv in s.converters ) {
			converters[ conv.toLowerCase() ] = s.converters[ conv ];
		}
	}

	current = dataTypes.shift();

	// Convert to each sequential dataType
	while ( current ) {

		if ( s.responseFields[ current ] ) {
			jqXHR[ s.responseFields[ current ] ] = response;
		}

		// Apply the dataFilter if provided
		if ( !prev && isSuccess && s.dataFilter ) {
			response = s.dataFilter( response, s.dataType );
		}

		prev = current;
		current = dataTypes.shift();

		if ( current ) {

			// There's only work to do if current dataType is non-auto
			if ( current === "*" ) {

				current = prev;

			// Convert response if prev dataType is non-auto and differs from current
			} else if ( prev !== "*" && prev !== current ) {

				// Seek a direct converter
				conv = converters[ prev + " " + current ] || converters[ "* " + current ];

				// If none found, seek a pair
				if ( !conv ) {
					for ( conv2 in converters ) {

						// If conv2 outputs current
						tmp = conv2.split( " " );
						if ( tmp[ 1 ] === current ) {

							// If prev can be converted to accepted input
							conv = converters[ prev + " " + tmp[ 0 ] ] ||
								converters[ "* " + tmp[ 0 ] ];
							if ( conv ) {

								// Condense equivalence converters
								if ( conv === true ) {
									conv = converters[ conv2 ];

								// Otherwise, insert the intermediate dataType
								} else if ( converters[ conv2 ] !== true ) {
									current = tmp[ 0 ];
									dataTypes.unshift( tmp[ 1 ] );
								}
								break;
							}
						}
					}
				}

				// Apply converter (if not an equivalence)
				if ( conv !== true ) {

					// Unless errors are allowed to bubble, catch and return them
					if ( conv && s.throws ) {
						response = conv( response );
					} else {
						try {
							response = conv( response );
						} catch ( e ) {
							return {
								state: "parsererror",
								error: conv ? e : "No conversion from " + prev + " to " + current
							};
						}
					}
				}
			}
		}
	}

	return { state: "success", data: response };
}

jQuery.extend( {

	// Counter for holding the number of active queries
	active: 0,

	// Last-Modified header cache for next request
	lastModified: {},
	etag: {},

	ajaxSettings: {
		url: location.href,
		type: "GET",
		isLocal: rlocalProtocol.test( location.protocol ),
		global: true,
		processData: true,
		async: true,
		contentType: "application/x-www-form-urlencoded; charset=UTF-8",

		/*
		timeout: 0,
		data: null,
		dataType: null,
		username: null,
		password: null,
		cache: null,
		throws: false,
		traditional: false,
		headers: {},
		*/

		accepts: {
			"*": allTypes,
			text: "text/plain",
			html: "text/html",
			xml: "application/xml, text/xml",
			json: "application/json, text/javascript"
		},

		contents: {
			xml: /\bxml\b/,
			html: /\bhtml/,
			json: /\bjson\b/
		},

		responseFields: {
			xml: "responseXML",
			text: "responseText",
			json: "responseJSON"
		},

		// Data converters
		// Keys separate source (or catchall "*") and destination types with a single space
		converters: {

			// Convert anything to text
			"* text": String,

			// Text to html (true = no transformation)
			"text html": true,

			// Evaluate text as a json expression
			"text json": JSON.parse,

			// Parse text as xml
			"text xml": jQuery.parseXML
		},

		// For options that shouldn't be deep extended:
		// you can add your own custom options here if
		// and when you create one that shouldn't be
		// deep extended (see ajaxExtend)
		flatOptions: {
			url: true,
			context: true
		}
	},

	// Creates a full fledged settings object into target
	// with both ajaxSettings and settings fields.
	// If target is omitted, writes into ajaxSettings.
	ajaxSetup: function( target, settings ) {
		return settings ?

			// Building a settings object
			ajaxExtend( ajaxExtend( target, jQuery.ajaxSettings ), settings ) :

			// Extending ajaxSettings
			ajaxExtend( jQuery.ajaxSettings, target );
	},

	ajaxPrefilter: addToPrefiltersOrTransports( prefilters ),
	ajaxTransport: addToPrefiltersOrTransports( transports ),

	// Main method
	ajax: function( url, options ) {

		// If url is an object, simulate pre-1.5 signature
		if ( typeof url === "object" ) {
			options = url;
			url = undefined;
		}

		// Force options to be an object
		options = options || {};

		var transport,

			// URL without anti-cache param
			cacheURL,

			// Response headers
			responseHeadersString,
			responseHeaders,

			// timeout handle
			timeoutTimer,

			// Url cleanup var
			urlAnchor,

			// Request state (becomes false upon send and true upon completion)
			completed,

			// To know if global events are to be dispatched
			fireGlobals,

			// Loop variable
			i,

			// uncached part of the url
			uncached,

			// Create the final options object
			s = jQuery.ajaxSetup( {}, options ),

			// Callbacks context
			callbackContext = s.context || s,

			// Context for global events is callbackContext if it is a DOM node or jQuery collection
			globalEventContext = s.context &&
				( callbackContext.nodeType || callbackContext.jquery ) ?
					jQuery( callbackContext ) :
					jQuery.event,

			// Deferreds
			deferred = jQuery.Deferred(),
			completeDeferred = jQuery.Callbacks( "once memory" ),

			// Status-dependent callbacks
			statusCode = s.statusCode || {},

			// Headers (they are sent all at once)
			requestHeaders = {},
			requestHeadersNames = {},

			// Default abort message
			strAbort = "canceled",

			// Fake xhr
			jqXHR = {
				readyState: 0,

				// Builds headers hashtable if needed
				getResponseHeader: function( key ) {
					var match;
					if ( completed ) {
						if ( !responseHeaders ) {
							responseHeaders = {};
							while ( ( match = rheaders.exec( responseHeadersString ) ) ) {
								responseHeaders[ match[ 1 ].toLowerCase() ] = match[ 2 ];
							}
						}
						match = responseHeaders[ key.toLowerCase() ];
					}
					return match == null ? null : match;
				},

				// Raw string
				getAllResponseHeaders: function() {
					return completed ? responseHeadersString : null;
				},

				// Caches the header
				setRequestHeader: function( name, value ) {
					if ( completed == null ) {
						name = requestHeadersNames[ name.toLowerCase() ] =
							requestHeadersNames[ name.toLowerCase() ] || name;
						requestHeaders[ name ] = value;
					}
					return this;
				},

				// Overrides response content-type header
				overrideMimeType: function( type ) {
					if ( completed == null ) {
						s.mimeType = type;
					}
					return this;
				},

				// Status-dependent callbacks
				statusCode: function( map ) {
					var code;
					if ( map ) {
						if ( completed ) {

							// Execute the appropriate callbacks
							jqXHR.always( map[ jqXHR.status ] );
						} else {

							// Lazy-add the new callbacks in a way that preserves old ones
							for ( code in map ) {
								statusCode[ code ] = [ statusCode[ code ], map[ code ] ];
							}
						}
					}
					return this;
				},

				// Cancel the request
				abort: function( statusText ) {
					var finalText = statusText || strAbort;
					if ( transport ) {
						transport.abort( finalText );
					}
					done( 0, finalText );
					return this;
				}
			};

		// Attach deferreds
		deferred.promise( jqXHR );

		// Add protocol if not provided (prefilters might expect it)
		// Handle falsy url in the settings object (#10093: consistency with old signature)
		// We also use the url parameter if available
		s.url = ( ( url || s.url || location.href ) + "" )
			.replace( rprotocol, location.protocol + "//" );

		// Alias method option to type as per ticket #12004
		s.type = options.method || options.type || s.method || s.type;

		// Extract dataTypes list
		s.dataTypes = ( s.dataType || "*" ).toLowerCase().match( rnothtmlwhite ) || [ "" ];

		// A cross-domain request is in order when the origin doesn't match the current origin.
		if ( s.crossDomain == null ) {
			urlAnchor = document.createElement( "a" );

			// Support: IE <=8 - 11, Edge 12 - 13
			// IE throws exception on accessing the href property if url is malformed,
			// e.g. http://example.com:80x/
			try {
				urlAnchor.href = s.url;

				// Support: IE <=8 - 11 only
				// Anchor's host property isn't correctly set when s.url is relative
				urlAnchor.href = urlAnchor.href;
				s.crossDomain = originAnchor.protocol + "//" + originAnchor.host !==
					urlAnchor.protocol + "//" + urlAnchor.host;
			} catch ( e ) {

				// If there is an error parsing the URL, assume it is crossDomain,
				// it can be rejected by the transport if it is invalid
				s.crossDomain = true;
			}
		}

		// Convert data if not already a string
		if ( s.data && s.processData && typeof s.data !== "string" ) {
			s.data = jQuery.param( s.data, s.traditional );
		}

		// Apply prefilters
		inspectPrefiltersOrTransports( prefilters, s, options, jqXHR );

		// If request was aborted inside a prefilter, stop there
		if ( completed ) {
			return jqXHR;
		}

		// We can fire global events as of now if asked to
		// Don't fire events if jQuery.event is undefined in an AMD-usage scenario (#15118)
		fireGlobals = jQuery.event && s.global;

		// Watch for a new set of requests
		if ( fireGlobals && jQuery.active++ === 0 ) {
			jQuery.event.trigger( "ajaxStart" );
		}

		// Uppercase the type
		s.type = s.type.toUpperCase();

		// Determine if request has content
		s.hasContent = !rnoContent.test( s.type );

		// Save the URL in case we're toying with the If-Modified-Since
		// and/or If-None-Match header later on
		// Remove hash to simplify url manipulation
		cacheURL = s.url.replace( rhash, "" );

		// More options handling for requests with no content
		if ( !s.hasContent ) {

			// Remember the hash so we can put it back
			uncached = s.url.slice( cacheURL.length );

			// If data is available, append data to url
			if ( s.data ) {
				cacheURL += ( rquery.test( cacheURL ) ? "&" : "?" ) + s.data;

				// #9682: remove data so that it's not used in an eventual retry
				delete s.data;
			}

			// Add or update anti-cache param if needed
			if ( s.cache === false ) {
				cacheURL = cacheURL.replace( rantiCache, "$1" );
				uncached = ( rquery.test( cacheURL ) ? "&" : "?" ) + "_=" + ( nonce++ ) + uncached;
			}

			// Put hash and anti-cache on the URL that will be requested (gh-1732)
			s.url = cacheURL + uncached;

		// Change '%20' to '+' if this is encoded form body content (gh-2658)
		} else if ( s.data && s.processData &&
			( s.contentType || "" ).indexOf( "application/x-www-form-urlencoded" ) === 0 ) {
			s.data = s.data.replace( r20, "+" );
		}

		// Set the If-Modified-Since and/or If-None-Match header, if in ifModified mode.
		if ( s.ifModified ) {
			if ( jQuery.lastModified[ cacheURL ] ) {
				jqXHR.setRequestHeader( "If-Modified-Since", jQuery.lastModified[ cacheURL ] );
			}
			if ( jQuery.etag[ cacheURL ] ) {
				jqXHR.setRequestHeader( "If-None-Match", jQuery.etag[ cacheURL ] );
			}
		}

		// Set the correct header, if data is being sent
		if ( s.data && s.hasContent && s.contentType !== false || options.contentType ) {
			jqXHR.setRequestHeader( "Content-Type", s.contentType );
		}

		// Set the Accepts header for the server, depending on the dataType
		jqXHR.setRequestHeader(
			"Accept",
			s.dataTypes[ 0 ] && s.accepts[ s.dataTypes[ 0 ] ] ?
				s.accepts[ s.dataTypes[ 0 ] ] +
					( s.dataTypes[ 0 ] !== "*" ? ", " + allTypes + "; q=0.01" : "" ) :
				s.accepts[ "*" ]
		);

		// Check for headers option
		for ( i in s.headers ) {
			jqXHR.setRequestHeader( i, s.headers[ i ] );
		}

		// Allow custom headers/mimetypes and early abort
		if ( s.beforeSend &&
			( s.beforeSend.call( callbackContext, jqXHR, s ) === false || completed ) ) {

			// Abort if not done already and return
			return jqXHR.abort();
		}

		// Aborting is no longer a cancellation
		strAbort = "abort";

		// Install callbacks on deferreds
		completeDeferred.add( s.complete );
		jqXHR.done( s.success );
		jqXHR.fail( s.error );

		// Get transport
		transport = inspectPrefiltersOrTransports( transports, s, options, jqXHR );

		// If no transport, we auto-abort
		if ( !transport ) {
			done( -1, "No Transport" );
		} else {
			jqXHR.readyState = 1;

			// Send global event
			if ( fireGlobals ) {
				globalEventContext.trigger( "ajaxSend", [ jqXHR, s ] );
			}

			// If request was aborted inside ajaxSend, stop there
			if ( completed ) {
				return jqXHR;
			}

			// Timeout
			if ( s.async && s.timeout > 0 ) {
				timeoutTimer = window.setTimeout( function() {
					jqXHR.abort( "timeout" );
				}, s.timeout );
			}

			try {
				completed = false;
				transport.send( requestHeaders, done );
			} catch ( e ) {

				// Rethrow post-completion exceptions
				if ( completed ) {
					throw e;
				}

				// Propagate others as results
				done( -1, e );
			}
		}

		// Callback for when everything is done
		function done( status, nativeStatusText, responses, headers ) {
			var isSuccess, success, error, response, modified,
				statusText = nativeStatusText;

			// Ignore repeat invocations
			if ( completed ) {
				return;
			}

			completed = true;

			// Clear timeout if it exists
			if ( timeoutTimer ) {
				window.clearTimeout( timeoutTimer );
			}

			// Dereference transport for early garbage collection
			// (no matter how long the jqXHR object will be used)
			transport = undefined;

			// Cache response headers
			responseHeadersString = headers || "";

			// Set readyState
			jqXHR.readyState = status > 0 ? 4 : 0;

			// Determine if successful
			isSuccess = status >= 200 && status < 300 || status === 304;

			// Get response data
			if ( responses ) {
				response = ajaxHandleResponses( s, jqXHR, responses );
			}

			// Convert no matter what (that way responseXXX fields are always set)
			response = ajaxConvert( s, response, jqXHR, isSuccess );

			// If successful, handle type chaining
			if ( isSuccess ) {

				// Set the If-Modified-Since and/or If-None-Match header, if in ifModified mode.
				if ( s.ifModified ) {
					modified = jqXHR.getResponseHeader( "Last-Modified" );
					if ( modified ) {
						jQuery.lastModified[ cacheURL ] = modified;
					}
					modified = jqXHR.getResponseHeader( "etag" );
					if ( modified ) {
						jQuery.etag[ cacheURL ] = modified;
					}
				}

				// if no content
				if ( status === 204 || s.type === "HEAD" ) {
					statusText = "nocontent";

				// if not modified
				} else if ( status === 304 ) {
					statusText = "notmodified";

				// If we have data, let's convert it
				} else {
					statusText = response.state;
					success = response.data;
					error = response.error;
					isSuccess = !error;
				}
			} else {

				// Extract error from statusText and normalize for non-aborts
				error = statusText;
				if ( status || !statusText ) {
					statusText = "error";
					if ( status < 0 ) {
						status = 0;
					}
				}
			}

			// Set data for the fake xhr object
			jqXHR.status = status;
			jqXHR.statusText = ( nativeStatusText || statusText ) + "";

			// Success/Error
			if ( isSuccess ) {
				deferred.resolveWith( callbackContext, [ success, statusText, jqXHR ] );
			} else {
				deferred.rejectWith( callbackContext, [ jqXHR, statusText, error ] );
			}

			// Status-dependent callbacks
			jqXHR.statusCode( statusCode );
			statusCode = undefined;

			if ( fireGlobals ) {
				globalEventContext.trigger( isSuccess ? "ajaxSuccess" : "ajaxError",
					[ jqXHR, s, isSuccess ? success : error ] );
			}

			// Complete
			completeDeferred.fireWith( callbackContext, [ jqXHR, statusText ] );

			if ( fireGlobals ) {
				globalEventContext.trigger( "ajaxComplete", [ jqXHR, s ] );

				// Handle the global AJAX counter
				if ( !( --jQuery.active ) ) {
					jQuery.event.trigger( "ajaxStop" );
				}
			}
		}

		return jqXHR;
	},

	getJSON: function( url, data, callback ) {
		return jQuery.get( url, data, callback, "json" );
	},

	getScript: function( url, callback ) {
		return jQuery.get( url, undefined, callback, "script" );
	}
} );

jQuery.each( [ "get", "post" ], function( i, method ) {
	jQuery[ method ] = function( url, data, callback, type ) {

		// Shift arguments if data argument was omitted
		if ( jQuery.isFunction( data ) ) {
			type = type || callback;
			callback = data;
			data = undefined;
		}

		// The url can be an options object (which then must have .url)
		return jQuery.ajax( jQuery.extend( {
			url: url,
			type: method,
			dataType: type,
			data: data,
			success: callback
		}, jQuery.isPlainObject( url ) && url ) );
	};
} );


jQuery._evalUrl = function( url ) {
	return jQuery.ajax( {
		url: url,

		// Make this explicit, since user can override this through ajaxSetup (#11264)
		type: "GET",
		dataType: "script",
		cache: true,
		async: false,
		global: false,
		"throws": true
	} );
};


jQuery.fn.extend( {
	wrapAll: function( html ) {
		var wrap;

		if ( this[ 0 ] ) {
			if ( jQuery.isFunction( html ) ) {
				html = html.call( this[ 0 ] );
			}

			// The elements to wrap the target around
			wrap = jQuery( html, this[ 0 ].ownerDocument ).eq( 0 ).clone( true );

			if ( this[ 0 ].parentNode ) {
				wrap.insertBefore( this[ 0 ] );
			}

			wrap.map( function() {
				var elem = this;

				while ( elem.firstElementChild ) {
					elem = elem.firstElementChild;
				}

				return elem;
			} ).append( this );
		}

		return this;
	},

	wrapInner: function( html ) {
		if ( jQuery.isFunction( html ) ) {
			return this.each( function( i ) {
				jQuery( this ).wrapInner( html.call( this, i ) );
			} );
		}

		return this.each( function() {
			var self = jQuery( this ),
				contents = self.contents();

			if ( contents.length ) {
				contents.wrapAll( html );

			} else {
				self.append( html );
			}
		} );
	},

	wrap: function( html ) {
		var isFunction = jQuery.isFunction( html );

		return this.each( function( i ) {
			jQuery( this ).wrapAll( isFunction ? html.call( this, i ) : html );
		} );
	},

	unwrap: function( selector ) {
		this.parent( selector ).not( "body" ).each( function() {
			jQuery( this ).replaceWith( this.childNodes );
		} );
		return this;
	}
} );


jQuery.expr.pseudos.hidden = function( elem ) {
	return !jQuery.expr.pseudos.visible( elem );
};
jQuery.expr.pseudos.visible = function( elem ) {
	return !!( elem.offsetWidth || elem.offsetHeight || elem.getClientRects().length );
};




jQuery.ajaxSettings.xhr = function() {
	try {
		return new window.XMLHttpRequest();
	} catch ( e ) {}
};

var xhrSuccessStatus = {

		// File protocol always yields status code 0, assume 200
		0: 200,

		// Support: IE <=9 only
		// #1450: sometimes IE returns 1223 when it should be 204
		1223: 204
	},
	xhrSupported = jQuery.ajaxSettings.xhr();

support.cors = !!xhrSupported && ( "withCredentials" in xhrSupported );
support.ajax = xhrSupported = !!xhrSupported;

jQuery.ajaxTransport( function( options ) {
	var callback, errorCallback;

	// Cross domain only allowed if supported through XMLHttpRequest
	if ( support.cors || xhrSupported && !options.crossDomain ) {
		return {
			send: function( headers, complete ) {
				var i,
					xhr = options.xhr();

				xhr.open(
					options.type,
					options.url,
					options.async,
					options.username,
					options.password
				);

				// Apply custom fields if provided
				if ( options.xhrFields ) {
					for ( i in options.xhrFields ) {
						xhr[ i ] = options.xhrFields[ i ];
					}
				}

				// Override mime type if needed
				if ( options.mimeType && xhr.overrideMimeType ) {
					xhr.overrideMimeType( options.mimeType );
				}

				// X-Requested-With header
				// For cross-domain requests, seeing as conditions for a preflight are
				// akin to a jigsaw puzzle, we simply never set it to be sure.
				// (it can always be set on a per-request basis or even using ajaxSetup)
				// For same-domain requests, won't change header if already provided.
				if ( !options.crossDomain && !headers[ "X-Requested-With" ] ) {
					headers[ "X-Requested-With" ] = "XMLHttpRequest";
				}

				// Set headers
				for ( i in headers ) {
					xhr.setRequestHeader( i, headers[ i ] );
				}

				// Callback
				callback = function( type ) {
					return function() {
						if ( callback ) {
							callback = errorCallback = xhr.onload =
								xhr.onerror = xhr.onabort = xhr.onreadystatechange = null;

							if ( type === "abort" ) {
								xhr.abort();
							} else if ( type === "error" ) {

								// Support: IE <=9 only
								// On a manual native abort, IE9 throws
								// errors on any property access that is not readyState
								if ( typeof xhr.status !== "number" ) {
									complete( 0, "error" );
								} else {
									complete(

										// File: protocol always yields status 0; see #8605, #14207
										xhr.status,
										xhr.statusText
									);
								}
							} else {
								complete(
									xhrSuccessStatus[ xhr.status ] || xhr.status,
									xhr.statusText,

									// Support: IE <=9 only
									// IE9 has no XHR2 but throws on binary (trac-11426)
									// For XHR2 non-text, let the caller handle it (gh-2498)
									( xhr.responseType || "text" ) !== "text"  ||
									typeof xhr.responseText !== "string" ?
										{ binary: xhr.response } :
										{ text: xhr.responseText },
									xhr.getAllResponseHeaders()
								);
							}
						}
					};
				};

				// Listen to events
				xhr.onload = callback();
				errorCallback = xhr.onerror = callback( "error" );

				// Support: IE 9 only
				// Use onreadystatechange to replace onabort
				// to handle uncaught aborts
				if ( xhr.onabort !== undefined ) {
					xhr.onabort = errorCallback;
				} else {
					xhr.onreadystatechange = function() {

						// Check readyState before timeout as it changes
						if ( xhr.readyState === 4 ) {

							// Allow onerror to be called first,
							// but that will not handle a native abort
							// Also, save errorCallback to a variable
							// as xhr.onerror cannot be accessed
							window.setTimeout( function() {
								if ( callback ) {
									errorCallback();
								}
							} );
						}
					};
				}

				// Create the abort callback
				callback = callback( "abort" );

				try {

					// Do send the request (this may raise an exception)
					xhr.send( options.hasContent && options.data || null );
				} catch ( e ) {

					// #14683: Only rethrow if this hasn't been notified as an error yet
					if ( callback ) {
						throw e;
					}
				}
			},

			abort: function() {
				if ( callback ) {
					callback();
				}
			}
		};
	}
} );




// Prevent auto-execution of scripts when no explicit dataType was provided (See gh-2432)
jQuery.ajaxPrefilter( function( s ) {
	if ( s.crossDomain ) {
		s.contents.script = false;
	}
} );

// Install script dataType
jQuery.ajaxSetup( {
	accepts: {
		script: "text/javascript, application/javascript, " +
			"application/ecmascript, application/x-ecmascript"
	},
	contents: {
		script: /\b(?:java|ecma)script\b/
	},
	converters: {
		"text script": function( text ) {
			jQuery.globalEval( text );
			return text;
		}
	}
} );

// Handle cache's special case and crossDomain
jQuery.ajaxPrefilter( "script", function( s ) {
	if ( s.cache === undefined ) {
		s.cache = false;
	}
	if ( s.crossDomain ) {
		s.type = "GET";
	}
} );

// Bind script tag hack transport
jQuery.ajaxTransport( "script", function( s ) {

	// This transport only deals with cross domain requests
	if ( s.crossDomain ) {
		var script, callback;
		return {
			send: function( _, complete ) {
				script = jQuery( "<script>" ).prop( {
					charset: s.scriptCharset,
					src: s.url
				} ).on(
					"load error",
					callback = function( evt ) {
						script.remove();
						callback = null;
						if ( evt ) {
							complete( evt.type === "error" ? 404 : 200, evt.type );
						}
					}
				);

				// Use native DOM manipulation to avoid our domManip AJAX trickery
				document.head.appendChild( script[ 0 ] );
			},
			abort: function() {
				if ( callback ) {
					callback();
				}
			}
		};
	}
} );




var oldCallbacks = [],
	rjsonp = /(=)\?(?=&|$)|\?\?/;

// Default jsonp settings
jQuery.ajaxSetup( {
	jsonp: "callback",
	jsonpCallback: function() {
		var callback = oldCallbacks.pop() || ( jQuery.expando + "_" + ( nonce++ ) );
		this[ callback ] = true;
		return callback;
	}
} );

// Detect, normalize options and install callbacks for jsonp requests
jQuery.ajaxPrefilter( "json jsonp", function( s, originalSettings, jqXHR ) {

	var callbackName, overwritten, responseContainer,
		jsonProp = s.jsonp !== false && ( rjsonp.test( s.url ) ?
			"url" :
			typeof s.data === "string" &&
				( s.contentType || "" )
					.indexOf( "application/x-www-form-urlencoded" ) === 0 &&
				rjsonp.test( s.data ) && "data"
		);

	// Handle iff the expected data type is "jsonp" or we have a parameter to set
	if ( jsonProp || s.dataTypes[ 0 ] === "jsonp" ) {

		// Get callback name, remembering preexisting value associated with it
		callbackName = s.jsonpCallback = jQuery.isFunction( s.jsonpCallback ) ?
			s.jsonpCallback() :
			s.jsonpCallback;

		// Insert callback into url or form data
		if ( jsonProp ) {
			s[ jsonProp ] = s[ jsonProp ].replace( rjsonp, "$1" + callbackName );
		} else if ( s.jsonp !== false ) {
			s.url += ( rquery.test( s.url ) ? "&" : "?" ) + s.jsonp + "=" + callbackName;
		}

		// Use data converter to retrieve json after script execution
		s.converters[ "script json" ] = function() {
			if ( !responseContainer ) {
				jQuery.error( callbackName + " was not called" );
			}
			return responseContainer[ 0 ];
		};

		// Force json dataType
		s.dataTypes[ 0 ] = "json";

		// Install callback
		overwritten = window[ callbackName ];
		window[ callbackName ] = function() {
			responseContainer = arguments;
		};

		// Clean-up function (fires after converters)
		jqXHR.always( function() {

			// If previous value didn't exist - remove it
			if ( overwritten === undefined ) {
				jQuery( window ).removeProp( callbackName );

			// Otherwise restore preexisting value
			} else {
				window[ callbackName ] = overwritten;
			}

			// Save back as free
			if ( s[ callbackName ] ) {

				// Make sure that re-using the options doesn't screw things around
				s.jsonpCallback = originalSettings.jsonpCallback;

				// Save the callback name for future use
				oldCallbacks.push( callbackName );
			}

			// Call if it was a function and we have a response
			if ( responseContainer && jQuery.isFunction( overwritten ) ) {
				overwritten( responseContainer[ 0 ] );
			}

			responseContainer = overwritten = undefined;
		} );

		// Delegate to script
		return "script";
	}
} );




// Support: Safari 8 only
// In Safari 8 documents created via document.implementation.createHTMLDocument
// collapse sibling forms: the second one becomes a child of the first one.
// Because of that, this security measure has to be disabled in Safari 8.
// https://bugs.webkit.org/show_bug.cgi?id=137337
support.createHTMLDocument = ( function() {
	var body = document.implementation.createHTMLDocument( "" ).body;
	body.innerHTML = "<form></form><form></form>";
	return body.childNodes.length === 2;
} )();


// Argument "data" should be string of html
// context (optional): If specified, the fragment will be created in this context,
// defaults to document
// keepScripts (optional): If true, will include scripts passed in the html string
jQuery.parseHTML = function( data, context, keepScripts ) {
	if ( typeof data !== "string" ) {
		return [];
	}
	if ( typeof context === "boolean" ) {
		keepScripts = context;
		context = false;
	}

	var base, parsed, scripts;

	if ( !context ) {

		// Stop scripts or inline event handlers from being executed immediately
		// by using document.implementation
		if ( support.createHTMLDocument ) {
			context = document.implementation.createHTMLDocument( "" );

			// Set the base href for the created document
			// so any parsed elements with URLs
			// are based on the document's URL (gh-2965)
			base = context.createElement( "base" );
			base.href = document.location.href;
			context.head.appendChild( base );
		} else {
			context = document;
		}
	}

	parsed = rsingleTag.exec( data );
	scripts = !keepScripts && [];

	// Single tag
	if ( parsed ) {
		return [ context.createElement( parsed[ 1 ] ) ];
	}

	parsed = buildFragment( [ data ], context, scripts );

	if ( scripts && scripts.length ) {
		jQuery( scripts ).remove();
	}

	return jQuery.merge( [], parsed.childNodes );
};


/**
 * Load a url into a page
 */
jQuery.fn.load = function( url, params, callback ) {
	var selector, type, response,
		self = this,
		off = url.indexOf( " " );

	if ( off > -1 ) {
		selector = stripAndCollapse( url.slice( off ) );
		url = url.slice( 0, off );
	}

	// If it's a function
	if ( jQuery.isFunction( params ) ) {

		// We assume that it's the callback
		callback = params;
		params = undefined;

	// Otherwise, build a param string
	} else if ( params && typeof params === "object" ) {
		type = "POST";
	}

	// If we have elements to modify, make the request
	if ( self.length > 0 ) {
		jQuery.ajax( {
			url: url,

			// If "type" variable is undefined, then "GET" method will be used.
			// Make value of this field explicit since
			// user can override it through ajaxSetup method
			type: type || "GET",
			dataType: "html",
			data: params
		} ).done( function( responseText ) {

			// Save response for use in complete callback
			response = arguments;

			self.html( selector ?

				// If a selector was specified, locate the right elements in a dummy div
				// Exclude scripts to avoid IE 'Permission Denied' errors
				jQuery( "<div>" ).append( jQuery.parseHTML( responseText ) ).find( selector ) :

				// Otherwise use the full result
				responseText );

		// If the request succeeds, this function gets "data", "status", "jqXHR"
		// but they are ignored because response was set above.
		// If it fails, this function gets "jqXHR", "status", "error"
		} ).always( callback && function( jqXHR, status ) {
			self.each( function() {
				callback.apply( this, response || [ jqXHR.responseText, status, jqXHR ] );
			} );
		} );
	}

	return this;
};




// Attach a bunch of functions for handling common AJAX events
jQuery.each( [
	"ajaxStart",
	"ajaxStop",
	"ajaxComplete",
	"ajaxError",
	"ajaxSuccess",
	"ajaxSend"
], function( i, type ) {
	jQuery.fn[ type ] = function( fn ) {
		return this.on( type, fn );
	};
} );




jQuery.expr.pseudos.animated = function( elem ) {
	return jQuery.grep( jQuery.timers, function( fn ) {
		return elem === fn.elem;
	} ).length;
};




/**
 * Gets a window from an element
 */
function getWindow( elem ) {
	return jQuery.isWindow( elem ) ? elem : elem.nodeType === 9 && elem.defaultView;
}

jQuery.offset = {
	setOffset: function( elem, options, i ) {
		var curPosition, curLeft, curCSSTop, curTop, curOffset, curCSSLeft, calculatePosition,
			position = jQuery.css( elem, "position" ),
			curElem = jQuery( elem ),
			props = {};

		// Set position first, in-case top/left are set even on static elem
		if ( position === "static" ) {
			elem.style.position = "relative";
		}

		curOffset = curElem.offset();
		curCSSTop = jQuery.css( elem, "top" );
		curCSSLeft = jQuery.css( elem, "left" );
		calculatePosition = ( position === "absolute" || position === "fixed" ) &&
			( curCSSTop + curCSSLeft ).indexOf( "auto" ) > -1;

		// Need to be able to calculate position if either
		// top or left is auto and position is either absolute or fixed
		if ( calculatePosition ) {
			curPosition = curElem.position();
			curTop = curPosition.top;
			curLeft = curPosition.left;

		} else {
			curTop = parseFloat( curCSSTop ) || 0;
			curLeft = parseFloat( curCSSLeft ) || 0;
		}

		if ( jQuery.isFunction( options ) ) {

			// Use jQuery.extend here to allow modification of coordinates argument (gh-1848)
			options = options.call( elem, i, jQuery.extend( {}, curOffset ) );
		}

		if ( options.top != null ) {
			props.top = ( options.top - curOffset.top ) + curTop;
		}
		if ( options.left != null ) {
			props.left = ( options.left - curOffset.left ) + curLeft;
		}

		if ( "using" in options ) {
			options.using.call( elem, props );

		} else {
			curElem.css( props );
		}
	}
};

jQuery.fn.extend( {
	offset: function( options ) {

		// Preserve chaining for setter
		if ( arguments.length ) {
			return options === undefined ?
				this :
				this.each( function( i ) {
					jQuery.offset.setOffset( this, options, i );
				} );
		}

		var docElem, win, rect, doc,
			elem = this[ 0 ];

		if ( !elem ) {
			return;
		}

		// Support: IE <=11 only
		// Running getBoundingClientRect on a
		// disconnected node in IE throws an error
		if ( !elem.getClientRects().length ) {
			return { top: 0, left: 0 };
		}

		rect = elem.getBoundingClientRect();

		// Make sure element is not hidden (display: none)
		if ( rect.width || rect.height ) {
			doc = elem.ownerDocument;
			win = getWindow( doc );
			docElem = doc.documentElement;

			return {
				top: rect.top + win.pageYOffset - docElem.clientTop,
				left: rect.left + win.pageXOffset - docElem.clientLeft
			};
		}

		// Return zeros for disconnected and hidden elements (gh-2310)
		return rect;
	},

	position: function() {
		if ( !this[ 0 ] ) {
			return;
		}

		var offsetParent, offset,
			elem = this[ 0 ],
			parentOffset = { top: 0, left: 0 };

		// Fixed elements are offset from window (parentOffset = {top:0, left: 0},
		// because it is its only offset parent
		if ( jQuery.css( elem, "position" ) === "fixed" ) {

			// Assume getBoundingClientRect is there when computed position is fixed
			offset = elem.getBoundingClientRect();

		} else {

			// Get *real* offsetParent
			offsetParent = this.offsetParent();

			// Get correct offsets
			offset = this.offset();
			if ( !jQuery.nodeName( offsetParent[ 0 ], "html" ) ) {
				parentOffset = offsetParent.offset();
			}

			// Add offsetParent borders
			parentOffset = {
				top: parentOffset.top + jQuery.css( offsetParent[ 0 ], "borderTopWidth", true ),
				left: parentOffset.left + jQuery.css( offsetParent[ 0 ], "borderLeftWidth", true )
			};
		}

		// Subtract parent offsets and element margins
		return {
			top: offset.top - parentOffset.top - jQuery.css( elem, "marginTop", true ),
			left: offset.left - parentOffset.left - jQuery.css( elem, "marginLeft", true )
		};
	},

	// This method will return documentElement in the following cases:
	// 1) For the element inside the iframe without offsetParent, this method will return
	//    documentElement of the parent window
	// 2) For the hidden or detached element
	// 3) For body or html element, i.e. in case of the html node - it will return itself
	//
	// but those exceptions were never presented as a real life use-cases
	// and might be considered as more preferable results.
	//
	// This logic, however, is not guaranteed and can change at any point in the future
	offsetParent: function() {
		return this.map( function() {
			var offsetParent = this.offsetParent;

			while ( offsetParent && jQuery.css( offsetParent, "position" ) === "static" ) {
				offsetParent = offsetParent.offsetParent;
			}

			return offsetParent || documentElement;
		} );
	}
} );

// Create scrollLeft and scrollTop methods
jQuery.each( { scrollLeft: "pageXOffset", scrollTop: "pageYOffset" }, function( method, prop ) {
	var top = "pageYOffset" === prop;

	jQuery.fn[ method ] = function( val ) {
		return access( this, function( elem, method, val ) {
			var win = getWindow( elem );

			if ( val === undefined ) {
				return win ? win[ prop ] : elem[ method ];
			}

			if ( win ) {
				win.scrollTo(
					!top ? val : win.pageXOffset,
					top ? val : win.pageYOffset
				);

			} else {
				elem[ method ] = val;
			}
		}, method, val, arguments.length );
	};
} );

// Support: Safari <=7 - 9.1, Chrome <=37 - 49
// Add the top/left cssHooks using jQuery.fn.position
// Webkit bug: https://bugs.webkit.org/show_bug.cgi?id=29084
// Blink bug: https://bugs.chromium.org/p/chromium/issues/detail?id=589347
// getComputedStyle returns percent when specified for top/left/bottom/right;
// rather than make the css module depend on the offset module, just check for it here
jQuery.each( [ "top", "left" ], function( i, prop ) {
	jQuery.cssHooks[ prop ] = addGetHookIf( support.pixelPosition,
		function( elem, computed ) {
			if ( computed ) {
				computed = curCSS( elem, prop );

				// If curCSS returns percentage, fallback to offset
				return rnumnonpx.test( computed ) ?
					jQuery( elem ).position()[ prop ] + "px" :
					computed;
			}
		}
	);
} );


// Create innerHeight, innerWidth, height, width, outerHeight and outerWidth methods
jQuery.each( { Height: "height", Width: "width" }, function( name, type ) {
	jQuery.each( { padding: "inner" + name, content: type, "": "outer" + name },
		function( defaultExtra, funcName ) {

		// Margin is only for outerHeight, outerWidth
		jQuery.fn[ funcName ] = function( margin, value ) {
			var chainable = arguments.length && ( defaultExtra || typeof margin !== "boolean" ),
				extra = defaultExtra || ( margin === true || value === true ? "margin" : "border" );

			return access( this, function( elem, type, value ) {
				var doc;

				if ( jQuery.isWindow( elem ) ) {

					// $( window ).outerWidth/Height return w/h including scrollbars (gh-1729)
					return funcName.indexOf( "outer" ) === 0 ?
						elem[ "inner" + name ] :
						elem.document.documentElement[ "client" + name ];
				}

				// Get document width or height
				if ( elem.nodeType === 9 ) {
					doc = elem.documentElement;

					// Either scroll[Width/Height] or offset[Width/Height] or client[Width/Height],
					// whichever is greatest
					return Math.max(
						elem.body[ "scroll" + name ], doc[ "scroll" + name ],
						elem.body[ "offset" + name ], doc[ "offset" + name ],
						doc[ "client" + name ]
					);
				}

				return value === undefined ?

					// Get width or height on the element, requesting but not forcing parseFloat
					jQuery.css( elem, type, extra ) :

					// Set width or height on the element
					jQuery.style( elem, type, value, extra );
			}, type, chainable ? margin : undefined, chainable );
		};
	} );
} );


jQuery.fn.extend( {

	bind: function( types, data, fn ) {
		return this.on( types, null, data, fn );
	},
	unbind: function( types, fn ) {
		return this.off( types, null, fn );
	},

	delegate: function( selector, types, data, fn ) {
		return this.on( types, selector, data, fn );
	},
	undelegate: function( selector, types, fn ) {

		// ( namespace ) or ( selector, types [, fn] )
		return arguments.length === 1 ?
			this.off( selector, "**" ) :
			this.off( types, selector || "**", fn );
	}
} );

jQuery.parseJSON = JSON.parse;




// Register as a named AMD module, since jQuery can be concatenated with other
// files that may use define, but not via a proper concatenation script that
// understands anonymous AMD modules. A named AMD is safest and most robust
// way to register. Lowercase jquery is used because AMD module names are
// derived from file names, and jQuery is normally delivered in a lowercase
// file name. Do this after creating the global so that if an AMD module wants
// to call noConflict to hide this version of jQuery, it will work.

// Note that for maximum portability, libraries that are not jQuery should
// declare themselves as anonymous modules, and avoid setting a global if an
// AMD loader is present. jQuery is a special case. For more information, see
// https://github.com/jrburke/requirejs/wiki/Updating-existing-libraries#wiki-anon

if ( true ) {
	!(__WEBPACK_AMD_DEFINE_ARRAY__ = [], __WEBPACK_AMD_DEFINE_RESULT__ = function() {
		return jQuery;
	}.apply(exports, __WEBPACK_AMD_DEFINE_ARRAY__),
				__WEBPACK_AMD_DEFINE_RESULT__ !== undefined && (module.exports = __WEBPACK_AMD_DEFINE_RESULT__));
}




var

	// Map over jQuery in case of overwrite
	_jQuery = window.jQuery,

	// Map over the $ in case of overwrite
	_$ = window.$;

jQuery.noConflict = function( deep ) {
	if ( window.$ === jQuery ) {
		window.$ = _$;
	}

	if ( deep && window.jQuery === jQuery ) {
		window.jQuery = _jQuery;
	}

	return jQuery;
};

// Expose jQuery and $ identifiers, even in AMD
// (#7102#comment:10, https://github.com/jquery/jquery/pull/557)
// and CommonJS for browser emulators (#13566)
if ( !noGlobal ) {
	window.jQuery = window.$ = jQuery;
}





return jQuery;
} );


/***/ }),
/* 2 */
/***/ (function(module, exports) {

var g;

// This works in non-strict mode
g = (function() {
	return this;
})();

try {
	// This works if eval is allowed (see CSP)
	g = g || Function("return this")() || (1,eval)("this");
} catch(e) {
	// This works if the window reference is available
	if(typeof window === "object")
		g = window;
}

// g can still be undefined, but nothing to do about it...
// We return undefined, instead of nothing here, so it's
// easier to handle this case. if(!global) { ...}

module.exports = g;


/***/ }),
/* 3 */,
/* 4 */
/***/ (function(module, __webpack_exports__, __webpack_require__) {

"use strict";
/* WEBPACK VAR INJECTION */(function($) {Object.defineProperty(__webpack_exports__, "__esModule", { value: true });
var _createClass = function () { function defineProperties(target, props) { for (var i = 0; i < props.length; i++) { var descriptor = props[i]; descriptor.enumerable = descriptor.enumerable || false; descriptor.configurable = true; if ("value" in descriptor) descriptor.writable = true; Object.defineProperty(target, descriptor.key, descriptor); } } return function (Constructor, protoProps, staticProps) { if (protoProps) defineProperties(Constructor.prototype, protoProps); if (staticProps) defineProperties(Constructor, staticProps); return Constructor; }; }();

function _classCallCheck(instance, Constructor) { if (!(instance instanceof Constructor)) { throw new TypeError("Cannot call a class as a function"); } }

/*!
The following license applies to all parts of this software except as
documented below.

    Copyright (c) 2017, Santosh Baggam.
    All rights reserved.
*/
/* Video conference code */

var Video = __webpack_require__(33);
var Chat = __webpack_require__(53);
var plyr = __webpack_require__(41);

var VideoConference = function () {
	function VideoConference(config) {
		_classCallCheck(this, VideoConference);

		this.baseUrl = 'https://healthkon-video-api.herokuapp.com', this.identity = config.identity, this.room = config.room;
		this.localVideoContainer = document.getElementById(config.localVideoContainer);
		this.remoteVideoContainer = document.getElementById(config.remoteVideoContainer);
		this.presenterIdentity = config.presenterIdentity;
		this.presenterVideoContainer = document.getElementById(config.presenterVideoContainer);

		this.checkBrowserSupport();
	}

	_createClass(VideoConference, [{
		key: 'authorize',
		value: function authorize(token) {
			var _this = this;

			return $.ajax({
				method: 'POST',
				url: this.baseUrl + '/api/conference/authenticate',
				data: {
					identity: this.identity
				},
				dataType: 'json',
				error: function error(_error) {
					alert('Error: Check your API key.');
				},
				success: function success(data) {
					_this.videoJwt = data.video_jwt;
					_this.chatJwt = data.chat_jwt;
					_this.userId = data.user_id;
				},
				beforeSend: function beforeSend(xhr, settings) {
					xhr.setRequestHeader('Authorization', 'Bearer: ' + token);
				}
			});
		}
	}, {
		key: 'presenterInitiation',
		value: function presenterInitiation(status) {
			this.presenterInitiation = status;
		}
	}, {
		key: 'connect',
		value: function connect() {
			var _this2 = this;

			this.checkBrowserSupport();

			var client = new Video.Client(this.videoJwt);
			var localMedia = new Video.LocalMedia();

			Video.getUserMedia().then(function (mediaStream) {
				localMedia.addStream(mediaStream);
				var video = _this2.attachLocalVideo(localMedia);
			});

			client.connect({
				to: this.room,
				localMedia: localMedia
			}).then(function (room) {
				_this2.joinedRoom(room);
			}, function (error) {
				alert('Failed to connect to conference. Error: ', error);
			});
		}
	}, {
		key: 'attachLocalVideo',
		value: function attachLocalVideo(localMedia) {
			var _this3 = this;

			var container = this.localVideoContainer;

			localMedia.tracks.forEach(function (track) {
				var wrapper = document.createElement('div');
				var video = document.createElement('video');

				if (track.kind == 'video') {
					wrapper.appendChild(video);
					video.setAttribute('controls', true);
					video.setAttribute('autoplay', true);
					video.setAttribute('id', track.id);
					video.srcObject = track.mediaStream;
					container.appendChild(wrapper);

					var controls = _this3.localPlayerControls();

					plyr.setup(video, {
						html: controls
					});
				}
			});
		}
	}, {
		key: 'joinedRoom',
		value: function joinedRoom(room) {
			var _this4 = this;

			var localParticipant = room.localParticipant;

			// check for presenter initiation
			if (this.presenterInitiation) {
				if (this.identity != this.presenterIdentity) {
					var presenterFound = false;
					room.participants.forEach(function (participant) {
						if (participant.identity == _this4.presenterIdentity) {
							presenterFound = true;
						}
					});

					if (!presenterFound) {
						room.disconnect();
						alert('Waiting for presenter!');
						location.reload(true);
						return;
					}
				}
			}

			this.logConnection(room, localParticipant);

			// already connected remote participant(s)
			room.participants.forEach(function (participant) {
				participant.on('trackAdded', function (track) {
					_this4.addVideo(participant, track, room);
				});
			});

			// new remote participant(s)
			room.on('participantConnected', function (participant) {
				participant.on('trackAdded', function (track) {
					_this4.addVideo(participant, track, room);
				});
			});

			// disconnected participant(s)
			room.on('participantDisconnected', function (participant) {
				// ajax call to server goes here for logs.. using participant identity
				_this4.removeVideo(participant);
			});
		}
	}, {
		key: 'setConferenceTimeout',
		value: function setConferenceTimeout(seconds) {
			this.timeout = seconds;
		}
	}, {
		key: 'addVideo',
		value: function addVideo(participant, track, room) {
			var timeout = this.timeout;

			if (track.kind == 'video') {
				var container = '';

				if (participant.identity == this.presenterIdentity) {
					container = this.presenterVideoContainer;
				} else {
					container = this.remoteVideoContainer;
				}

				var wrapper = document.createElement('div');
				wrapper.setAttribute('id', participant.sid);

				var video = document.createElement('video');
				video.setAttribute('class', 'remote-video');

				wrapper.appendChild(video);

				video.setAttribute('controls', true);
				video.setAttribute('autoplay', true);
				video.setAttribute('id', track.id);

				video.srcObject = track.mediaStream;

				container.appendChild(wrapper);

				var controls = '';

				if (participant.identity == this.presenterIdentity) {
					controls = this.presenterPlayerControls();
				} else {
					controls = this.remotePlayerControls();
				}

				plyr.setup(video, {
					html: controls,
					duration: this.timeout
				});

				var self = this;

				video.addEventListener('timeupdate', function () {
					if (!this._startTime) this._startTime = this.currentTime;
					var playedTime = this.currentTime - this._startTime;

					var timeEl = document.querySelector('#player__time');

					if (timeEl) {
						// add event to the player current time
						var seconds = Math.floor(playedTime);
						seconds = ('0' + seconds).slice(-2);
						var minutes = Math.floor(playedTime / 60);
						minutes = ('0' + minutes).slice(-2);
						var hours = Math.floor(playedTime / 3600);
						hours = ('0' + hours).slice(-2);
						var time = minutes + ":" + seconds;
						if (hours > 0) {
							time = hours + ":" + time;
						}
						timeEl.innerHTML = time;
					}

					// add timeout event
					if (playedTime >= timeout) {
						room.disconnect();
						self.removeVideo(participant);
					}
				});
			}
		}
	}, {
		key: 'localPlayerControls',
		value: function localPlayerControls() {
			return '<div class=\'plyr__controls\'>\n\t\t\t    <button type=\'button\' data-plyr=\'play\'>\n\t\t\t        <svg><use xlink:href=\'#plyr-play\'></use></svg>\n\t\t\t        <span class=\'plyr__sr-only\'>Play</span>\n\t\t\t    </button>\n\t\t\t    <button type=\'button\' data-plyr=\'pause\'>\n\t\t\t        <svg><use xlink:href=\'#plyr-pause\'></use></svg>\n\t\t\t        <span class=\'plyr__sr-only\'>Pause</span>\n\t\t\t    </button>\n\t\t\t    <button type=\'button\' data-plyr=\'fullscreen\'>\n\t\t\t        <svg class=\'icon--exit-fullscreen\'><use xlink:href=\'#plyr-exit-fullscreen\'></use></svg>\n\t\t\t        <svg><use xlink:href=\'#plyr-enter-fullscreen\'></use></svg>\n\t\t\t        <span class=\'plyr__sr-only\'>Toggle Fullscreen</span>\n\t\t\t    </button>\n\t\t\t</div>';
		}
	}, {
		key: 'remotePlayerControls',
		value: function remotePlayerControls() {
			return '<div class=\'plyr__controls\'>\n\t\t\t    <button type=\'button\' data-plyr=\'play\'>\n\t\t\t        <svg><use xlink:href=\'#plyr-play\'></use></svg>\n\t\t\t        <span class=\'plyr__sr-only\'>Play</span>\n\t\t\t    </button>\n\t\t\t    <button type=\'button\' data-plyr=\'pause\'>\n\t\t\t        <svg><use xlink:href=\'#plyr-pause\'></use></svg>\n\t\t\t        <span class=\'plyr__sr-only\'>Pause</span>\n\t\t\t    </button>\n\t\t\t    <span class=\'plyr__time\'>\n\t\t\t        <span class=\'plyr__sr-only\'>Current time</span>\n\t\t\t        <span class=\'plyr__time\' id=\'player__time\'>00:00</span>\n\t\t\t    </span>\n\t\t\t    <span class=\'plyr__time\'>\n\t\t\t        <span class=\'plyr__sr-only\'>Duration</span>\n\t\t\t        <span class=\'plyr__time--duration\'>00:00</span>\n\t\t\t    </span>\n\t\t\t    <button type=\'button\' data-plyr=\'mute\'>\n\t\t\t        <svg class=\'icon--muted\'><use xlink:href=\'#plyr-muted\'></use></svg>\n\t\t\t        <svg><use xlink:href=\'#plyr-volume\'></use></svg>\n\t\t\t        <span class=\'plyr__sr-only\'>Toggle Mute</span>\n\t\t\t    </button>\n\t\t\t    <span class=\'plyr__volume\'>\n\t\t\t        <label for=\'volume{id}\' class=\'plyr__sr-only\'>Volume</label>\n\t\t\t        <input id=\'volume{id}\' class=\'plyr__volume--input\' type=\'range\' min=\'0\' max=\'10\' value=\'5\' data-plyr=\'volume\'>\n\t\t\t        <progress class=\'plyr__volume--display\' max=\'10\' value=\'0\' role=\'presentation\'></progress>\n\t\t\t    </span>\n\t\t\t    <button type=\'button\' data-plyr=\'fullscreen\'>\n\t\t\t        <svg class=\'icon--exit-fullscreen\'><use xlink:href=\'#plyr-exit-fullscreen\'></use></svg>\n\t\t\t        <svg><use xlink:href=\'#plyr-enter-fullscreen\'></use></svg>\n\t\t\t        <span class=\'plyr__sr-only\'>Toggle Fullscreen</span>\n\t\t\t    </button>\n\t\t\t</div>';
		}
	}, {
		key: 'presenterPlayerControls',
		value: function presenterPlayerControls() {
			return '<div class=\'plyr__controls\'>\n\t\t\t    <button type=\'button\' data-plyr=\'play\'>\n\t\t\t        <svg><use xlink:href=\'#plyr-play\'></use></svg>\n\t\t\t        <span class=\'plyr__sr-only\'>Play</span>\n\t\t\t    </button>\n\t\t\t    <button type=\'button\' data-plyr=\'pause\'>\n\t\t\t        <svg><use xlink:href=\'#plyr-pause\'></use></svg>\n\t\t\t        <span class=\'plyr__sr-only\'>Pause</span>\n\t\t\t    </button>\n\t\t\t    <span class=\'plyr__time\'>\n\t\t\t        <span class=\'plyr__sr-only\'>Current time</span>\n\t\t\t        <span class=\'plyr__time\' id=\'player__time\'>00:00</span>\n\t\t\t    </span>\n\t\t\t    <span class=\'plyr__time\'>\n\t\t\t        <span class=\'plyr__sr-only\'>Duration</span>\n\t\t\t        <span class=\'plyr__time--duration\'>00:00</span>\n\t\t\t    </span>\n\t\t\t    <button type=\'button\' data-plyr=\'mute\'>\n\t\t\t        <svg class=\'icon--muted\'><use xlink:href=\'#plyr-muted\'></use></svg>\n\t\t\t        <svg><use xlink:href=\'#plyr-volume\'></use></svg>\n\t\t\t        <span class=\'plyr__sr-only\'>Toggle Mute</span>\n\t\t\t    </button>\n\t\t\t    <span class=\'plyr__volume\'>\n\t\t\t        <label for=\'volume{id}\' class=\'plyr__sr-only\'>Volume</label>\n\t\t\t        <input id=\'volume{id}\' class=\'plyr__volume--input\' type=\'range\' min=\'0\' max=\'10\' value=\'5\' data-plyr=\'volume\'>\n\t\t\t        <progress class=\'plyr__volume--display\' max=\'10\' value=\'0\' role=\'presentation\'></progress>\n\t\t\t    </span>\n\t\t\t    <button type=\'button\' data-plyr=\'fullscreen\'>\n\t\t\t        <svg class=\'icon--exit-fullscreen\'><use xlink:href=\'#plyr-exit-fullscreen\'></use></svg>\n\t\t\t        <svg><use xlink:href=\'#plyr-enter-fullscreen\'></use></svg>\n\t\t\t        <span class=\'plyr__sr-only\'>Toggle Fullscreen</span>\n\t\t\t    </button>\n\t\t\t</div>';
		}
	}, {
		key: 'removeVideo',
		value: function removeVideo(participant) {
			this.logDisconnection(participant);
			var id = '#' + participant.sid;
			$(id).remove();
		}
	}, {
		key: 'withChat',
		value: function withChat(chatConfig) {
			var _this5 = this;

			this.chatConfig = chatConfig;

			var chatClient = Chat.Client;
			chatClient = new Chat(this.chatJwt);

			chatClient.initialize().then(function (chatClient) {
				_this5.chatConnected(chatClient);
			});
		}
	}, {
		key: 'chatConnected',
		value: function chatConnected(chatClient) {
			var _this6 = this;

			var channelFound = chatClient.getChannelByUniqueName(this.room);

			this.pushChatInfo('Connecting..');

			channelFound.then(function (channel) {
				_this6.pushChatInfo('Connected');
				_this6.setupChatConversation(channel);
			}, function (error) {
				if (error.status == 404) {
					chatClient.createChannel({
						uniqueName: _this6.room,
						friendlyName: 'General Channel'
					}).then(function (channel) {
						_this6.pushChatInfo('Connected');
						_this6.setupChatConversation(channel);
					});
				}
			});
		}
	}, {
		key: 'setupChatConversation',
		value: function setupChatConversation(channel) {
			var _this7 = this;

			channel.join().then(function (channel) {
				_this7.pushChatInfo('Joined as ' + _this7.identity);
			});

			// new message event
			channel.on('messageAdded', function (message) {
				_this7.pushChatMessage(message.author, message.body);
			});

			// attach message input event
			var input = $('#' + this.chatConfig.messageInput);
			input.on('keydown', function (e) {
				if (e.keyCode == 13) {
					channel.sendMessage(input.val());
					input.val('');
				}
			});
		}
	}, {
		key: 'pushChatMessage',
		value: function pushChatMessage(member, message) {
			var el = $('#' + this.chatConfig.messagesContainer);
			var block = '<div class="video-chat-message-block">\n\t\t\t\t<div class="video-chat-user"> ' + member + ': </div>\n\t\t\t\t<div class="video-chat-message"> ' + message + ' </div>\n\t\t</div>';
			el.append(block);
		}
	}, {
		key: 'pushChatInfo',
		value: function pushChatInfo(message) {
			var el = $('#' + this.chatConfig.messagesContainer);
			var info = '<div class="video-chat-message-info">' + message + '</div>';
			el.append(info);
		}
	}, {
		key: 'logConnection',
		value: function logConnection(room, participant) {
			return $.ajax({
				method: 'POST',
				url: this.baseUrl + '/api/conference/connect',
				data: {
					user_id: this.userId,
					room_sid: room.sid,
					room_name: room.name,
					participant: participant.identity,
					participant_sid: participant.sid
				},
				success: function success(data) {
					console.info('OK. Connected');
				},
				error: function error(_error2) {
					// console.error(error.statusText);
				}
			});
		}
	}, {
		key: 'logDisconnection',
		value: function logDisconnection(participant) {
			return $.ajax({
				method: 'POST',
				url: this.baseUrl + '/api/conference/disconnect',
				data: {
					participant_sid: participant.sid
				},
				success: function success(data) {
					console.info('OK. Disconnected');
				},
				error: function error(_error3) {
					// console.error(error.statusText);
				}
			});
		}
	}, {
		key: 'checkBrowserSupport',
		value: function checkBrowserSupport() {
			if (!navigator.getUserMedia && !navigator.webkitGetUserMedia && !navigator.mozGetUserMedia && !navigator.msGetUserMedia) {
				alert('Video conference is not available in your browser. Kindly use Chrome / Firefox / Opera');
			}
		}
	}]);

	return VideoConference;
}();

/* harmony default export */ __webpack_exports__["default"] = VideoConference;
/* WEBPACK VAR INJECTION */}.call(__webpack_exports__, __webpack_require__(1)))

/***/ }),
/* 5 */,
/* 6 */,
/* 7 */,
/* 8 */,
/* 9 */,
/* 10 */
/***/ (function(module, exports) {

// shim for using process in browser
var process = module.exports = {};

// cached from whatever global is present so that test runners that stub it
// don't break things.  But we need to wrap it in a try catch in case it is
// wrapped in strict mode code which doesn't define any globals.  It's inside a
// function because try/catches deoptimize in certain engines.

var cachedSetTimeout;
var cachedClearTimeout;

function defaultSetTimout() {
    throw new Error('setTimeout has not been defined');
}
function defaultClearTimeout () {
    throw new Error('clearTimeout has not been defined');
}
(function () {
    try {
        if (typeof setTimeout === 'function') {
            cachedSetTimeout = setTimeout;
        } else {
            cachedSetTimeout = defaultSetTimout;
        }
    } catch (e) {
        cachedSetTimeout = defaultSetTimout;
    }
    try {
        if (typeof clearTimeout === 'function') {
            cachedClearTimeout = clearTimeout;
        } else {
            cachedClearTimeout = defaultClearTimeout;
        }
    } catch (e) {
        cachedClearTimeout = defaultClearTimeout;
    }
} ())
function runTimeout(fun) {
    if (cachedSetTimeout === setTimeout) {
        //normal enviroments in sane situations
        return setTimeout(fun, 0);
    }
    // if setTimeout wasn't available but was latter defined
    if ((cachedSetTimeout === defaultSetTimout || !cachedSetTimeout) && setTimeout) {
        cachedSetTimeout = setTimeout;
        return setTimeout(fun, 0);
    }
    try {
        // when when somebody has screwed with setTimeout but no I.E. maddness
        return cachedSetTimeout(fun, 0);
    } catch(e){
        try {
            // When we are in I.E. but the script has been evaled so I.E. doesn't trust the global object when called normally
            return cachedSetTimeout.call(null, fun, 0);
        } catch(e){
            // same as above but when it's a version of I.E. that must have the global object for 'this', hopfully our context correct otherwise it will throw a global error
            return cachedSetTimeout.call(this, fun, 0);
        }
    }


}
function runClearTimeout(marker) {
    if (cachedClearTimeout === clearTimeout) {
        //normal enviroments in sane situations
        return clearTimeout(marker);
    }
    // if clearTimeout wasn't available but was latter defined
    if ((cachedClearTimeout === defaultClearTimeout || !cachedClearTimeout) && clearTimeout) {
        cachedClearTimeout = clearTimeout;
        return clearTimeout(marker);
    }
    try {
        // when when somebody has screwed with setTimeout but no I.E. maddness
        return cachedClearTimeout(marker);
    } catch (e){
        try {
            // When we are in I.E. but the script has been evaled so I.E. doesn't  trust the global object when called normally
            return cachedClearTimeout.call(null, marker);
        } catch (e){
            // same as above but when it's a version of I.E. that must have the global object for 'this', hopfully our context correct otherwise it will throw a global error.
            // Some versions of I.E. have different rules for clearTimeout vs setTimeout
            return cachedClearTimeout.call(this, marker);
        }
    }



}
var queue = [];
var draining = false;
var currentQueue;
var queueIndex = -1;

function cleanUpNextTick() {
    if (!draining || !currentQueue) {
        return;
    }
    draining = false;
    if (currentQueue.length) {
        queue = currentQueue.concat(queue);
    } else {
        queueIndex = -1;
    }
    if (queue.length) {
        drainQueue();
    }
}

function drainQueue() {
    if (draining) {
        return;
    }
    var timeout = runTimeout(cleanUpNextTick);
    draining = true;

    var len = queue.length;
    while(len) {
        currentQueue = queue;
        queue = [];
        while (++queueIndex < len) {
            if (currentQueue) {
                currentQueue[queueIndex].run();
            }
        }
        queueIndex = -1;
        len = queue.length;
    }
    currentQueue = null;
    draining = false;
    runClearTimeout(timeout);
}

process.nextTick = function (fun) {
    var args = new Array(arguments.length - 1);
    if (arguments.length > 1) {
        for (var i = 1; i < arguments.length; i++) {
            args[i - 1] = arguments[i];
        }
    }
    queue.push(new Item(fun, args));
    if (queue.length === 1 && !draining) {
        runTimeout(drainQueue);
    }
};

// v8 likes predictible objects
function Item(fun, array) {
    this.fun = fun;
    this.array = array;
}
Item.prototype.run = function () {
    this.fun.apply(null, this.array);
};
process.title = 'browser';
process.browser = true;
process.env = {};
process.argv = [];
process.version = ''; // empty string to avoid regexp issues
process.versions = {};

function noop() {}

process.on = noop;
process.addListener = noop;
process.once = noop;
process.off = noop;
process.removeListener = noop;
process.removeAllListeners = noop;
process.emit = noop;

process.binding = function (name) {
    throw new Error('process.binding is not supported');
};

process.cwd = function () { return '/' };
process.chdir = function (dir) {
    throw new Error('process.chdir is not supported');
};
process.umask = function() { return 0; };


/***/ }),
/* 11 */,
/* 12 */
/***/ (function(module, __webpack_exports__, __webpack_require__) {

"use strict";
Object.defineProperty(__webpack_exports__, "__esModule", { value: true });
/* harmony import */ var __WEBPACK_IMPORTED_MODULE_0__sdk_VideoConference_js__ = __webpack_require__(4);


window.Video = __WEBPACK_IMPORTED_MODULE_0__sdk_VideoConference_js__["default"];

/***/ }),
/* 13 */,
/* 14 */,
/* 15 */,
/* 16 */,
/* 17 */,
/* 18 */,
/* 19 */,
/* 20 */,
/* 21 */,
/* 22 */,
/* 23 */,
/* 24 */,
/* 25 */,
/* 26 */,
/* 27 */,
/* 28 */,
/* 29 */,
/* 30 */,
/* 31 */,
/* 32 */,
/* 33 */
/***/ (function(module, exports, __webpack_require__) {

/* WEBPACK VAR INJECTION */(function(global, Buffer) {var require;var require;var __WEBPACK_AMD_DEFINE_ARRAY__, __WEBPACK_AMD_DEFINE_RESULT__;var _typeof=typeof Symbol==="function"&&typeof Symbol.iterator==="symbol"?function(obj){return typeof obj;}:function(obj){return obj&&typeof Symbol==="function"&&obj.constructor===Symbol&&obj!==Symbol.prototype?"symbol":typeof obj;};/*! twilio-video.js 1.0.0-beta4

The following license applies to all parts of this software except as
documented below.

    Copyright (c) 2015, Twilio, inc.
    All rights reserved.

    Redistribution and use in source and binary forms, with or without
    modification, are permitted provided that the following conditions are
    met:

      1. Redistributions of source code must retain the above copyright
         notice, this list of conditions and the following disclaimer.

      2. Redistributions in binary form must reproduce the above copyright
         notice, this list of conditions and the following disclaimer in
         the documentation and/or other materials provided with the
         distribution.

      3. Neither the name of Twilio nor the names of its contributors may
         be used to endorse or promote products derived from this software
         without specific prior written permission.

    THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS
    "AS IS" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT
    LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR
    A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT
    HOLDER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,
    SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT
    LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,
    DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY
    THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
    (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE
    OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.

This software includes SIP.js under the following license.

    Copyright (c) 2014 Junction Networks, Inc. <http://www.onsip.com>

    License: The MIT License

    Permission is hereby granted, free of charge, to any person obtaining
    a copy of this software and associated documentation files (the
    "Software"), to deal in the Software without restriction, including
    without limitation the rights to use, copy, modify, merge, publish,
    distribute, sublicense, and/or sell copies of the Software, and to
    permit persons to whom the Software is furnished to do so, subject to
    the following conditions:

    The above copyright notice and this permission notice shall be
    included in all copies or substantial portions of the Software.

    THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND,
    EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF
    MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND
    NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE
    LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION
    OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION
    WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.

SIP.js contains substantial portions of the JsSIP software under the following
license.

    Copyright (c) 2012-2013 Jos Luis Milln - Versatica <http://www.versatica.com>

    License: The MIT License

    Permission is hereby granted, free of charge, to any person obtaining
    a copy of this software and associated documentation files (the
    "Software"), to deal in the Software without restriction, including
    without limitation the rights to use, copy, modify, merge, publish,
    distribute, sublicense, and/or sell copies of the Software, and to
    permit persons to whom the Software is furnished to do so, subject to
    the following conditions:

    The above copyright notice and this permission notice shall be
    included in all copies or substantial portions of the Software.

    THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND,
    EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF
    MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND
    NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE
    LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION
    OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION
    WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.

 *//* eslint strict:0 */(function(root){var bundle=function e(t,n,r){function s(o,u){if(!n[o]){if(!t[o]){var a=typeof require=="function"&&require;if(!u&&a)return require(o,!0);if(i)return i(o,!0);var f=new Error("Cannot find module '"+o+"'");throw f.code="MODULE_NOT_FOUND",f;}var l=n[o]={exports:{}};t[o][0].call(l.exports,function(e){var n=t[o][1][e];return s(n?n:e);},l,l.exports,e,t,n,r);}return n[o].exports;}var i=typeof require=="function"&&require;for(var o=0;o<r.length;o++){s(r[o]);}return s;}({1:[function(require,module,exports){'use strict';var version=require('../package').version;function Video(accessManager,options){return new Video.Client(accessManager,options);}Object.defineProperties(Video,{Client:{enumerable:true,value:require('./client')},getUserMedia:{enumerable:true,value:require('./webrtc/getusermedia')},LocalMedia:{enumerable:true,value:require('./media/localmedia')},version:{enumerable:true,value:version}});module.exports=Video;},{"../package":110,"./client":3,"./media/localmedia":8,"./webrtc/getusermedia":59}],2:[function(require,module,exports){'use strict';var CancelablePromise=require('./util/cancelablepromise');/**
 * Create a {@link CancelablePromise<Room>}.
 * @param {function(function(LocalMedia): CancelablePromise<RoomSignaling>):
 *   Promise<function(): CancelablePromise<RoomSignaling>>} getLocalMedia
 * @param {function(LocalMedia): LocalParticipant} createLocalParticipant
 * @param {function(LocalMedia): CancelablePromise<RoomSignaling>} createRoomSignaling
 * @param {function(LocalParticipant, RoomSignaling): Room} createRoom
 * @returns CancelablePromise<Room>
 */function createCancelableRoomPromise(getLocalMedia,createLocalParticipant,createRoomSignaling,createRoom){var cancelableRoomSignalingPromise;var cancelationError=new Error('Canceled');return new CancelablePromise(function onCreate(resolve,reject,isCanceled){var localParticipant;getLocalMedia(function getLocalMediaSucceeded(localMedia){if(isCanceled()){return Promise.reject(cancelationError);}localParticipant=createLocalParticipant(localMedia);return createRoomSignaling(localParticipant).then(function createRoomSignalingSucceeded(getCancelableRoomSignalingPromise){if(isCanceled()){throw cancelationError;}cancelableRoomSignalingPromise=getCancelableRoomSignalingPromise();return cancelableRoomSignalingPromise;});}).then(function roomSignalingConnected(roomSignaling){if(isCanceled()){roomSignaling.disconnect();throw cancelationError;}resolve(createRoom(localParticipant,roomSignaling));}).catch(function onError(error){reject(error);});},function onCancel(){if(cancelableRoomSignalingPromise){cancelableRoomSignalingPromise.cancel();}});}module.exports=createCancelableRoomPromise;},{"./util/cancelablepromise":48}],3:[function(require,module,exports){'use strict';var inherits=require('util').inherits;var createCancelableRoomPromise=require('./cancelableroompromise');var constants=require('./util/constants');var DefaultECS=require('./ecs');var Room=require('./room');var E=require('./util/constants').typeErrors;var TwE=require('./util/constants').twilioErrors;var EventEmitter=require('events').EventEmitter;var LocalMedia=require('./media/localmedia');var LocalParticipant=require('./localparticipant');var Log=require('./util/log');var SignalingV2=require('./signaling/v2');var TimeoutPromise=require('./util/timeoutpromise');var util=require('./util');var version=require('../package').version;var nInstances=0;/**
 * Constructs a new {@link Client} with an Access Token string.
 * @class
 * @classdesc Construct a {@link Client} to start creating and connecting
 *   to {@link Room}s with other {@link Participant}s.
 * @param {string} initialToken - The {@link Client}'s Access Token string
 * @param {Client.ConstructorOptions} [options] - Options to override the
 *   constructor's default behavior
 * @property {string} token - The current Access Token
 * @property {Map<Room.SID, Room>} rooms - The {@link Room}s this
 *   {@link Client} is participating in
 * @fires Client#error
 */function Client(initialToken,options){if(!(this instanceof Client)){return new Client(initialToken,options);}if(typeof initialToken!=='string'){throw new E.INVALID_TYPE('initialToken','string');}EventEmitter.call(this);try{var accountSid=util.token.getAccountSid(initialToken);var identity=util.token.getIdentity(initialToken);}catch(e){throw new TwE.INVALID_ACCESSTOKEN(e.message);}options=Object.assign({ECS:DefaultECS,environment:constants.DEFAULT_ENVIRONMENT,getLocalMedia:LocalMedia.getLocalMedia,logLevel:constants.DEFAULT_LOG_LEVEL,realm:constants.DEFAULT_REALM,signaling:SignalingV2},options);/* eslint new-cap:0 */options=Object.assign({ecsServer:constants.ECS_SERVER(options.environment,options.realm),wsServer:constants.WS_SERVER(options.environment,options.realm,accountSid)},options);var defaultIceServers=constants.DEFAULT_ICE_SERVERS(options.environment);var ECS=options.ECS;var logLevels=util.buildLogLevels(options.logLevel);var log=new Log('default',this,logLevels);var rooms=new Map();var self=this;var Signaling=options.signaling;options.log=log;var signaling=new Signaling(options.wsServer,accountSid,identity,options);function getConfiguration(){var ecsOptions={configUrl:options.ecsServer+'/v1/Configuration',body:{'service':'video','sdk_version':version}};log.info('Getting ECS configuration');log.debug('Token:',self.token);log.debug('ECS options:',ecsOptions);return ECS.getConfiguration(self.token,ecsOptions).then(function(res){log.info('Got ECS configuration');log.debug('ECS configuration:',res);var ttl=util.getOrNull(res,'video.network_traversal_service.ttl');ttl=ttl||constants.ICE_SERVERS_DEFAULT_TTL;log.debug('NTS Token TTL:',ttl);setTimeout(function renewIceServers(){self._ecsPromise=getConfiguration();},(ttl-constants.ECS_TIMEOUT)*1000);return res;},function(reason){log.warn('Failed to get ECS configuration:',reason);return null;});}/* istanbul ignore next */Object.defineProperties(this,{_defaultIceServers:{value:defaultIceServers},_getLocalMedia:{value:options.getLocalMedia},_instanceId:{value:++nInstances},_log:{value:log},_options:{value:options},_rooms:{value:rooms},_signaling:{value:signaling},_token:{value:initialToken,writable:true},rooms:{enumerable:true,get:function get(){return new Map(rooms);}},token:{enumerable:true,get:function get(){return this._token;}}});Object.defineProperty(this,'_ecsPromise',{value:getConfiguration(),writable:true});log.info('Created a new Client');log.debug('Initial Access Token:',initialToken);log.debug('Options:',options);}inherits(Client,EventEmitter);Client.prototype.toString=function toString(){return'[Client #'+this._instanceId+']';};/**
 * Connect to a {@link Room}.
 *   <br><br>
 *   By default, this will automatically acquire {@link LocalMedia} containing a
 *   {@link LocalAudioTrack} and {@link LocalVideoTrack} before connecting to the
 *   {@link Room}. The {@link LocalMedia} will be stopped when you disconnect
 *   from the {@link Room}.
 *   <br><br>
 *   You can override the default behavior by specifying
 *   <code>options</code>. For example, rather than acquiring {@link LocalMedia}
 *   automatically, you can pass your own instance which you can stop yourself.
 *   See {@link Client.ConnectOptions} for more information.
 * @param {Client.ConnectOptions} [options={audio:true,video:true}] - Options to override the default behavior
 * @returns {CancelablePromise<Room>}
 * @example
 * var initialToken = getAccessToken();
 * var client = new Twilio.Video.Client(initialToken);
 *
 * client.connect({ to: 'my-cool-room' }).then(function(room) {
 *   room.on('participantConnected', function(participant) {
 *     console.log(participant.identity + ' has connected');
 *   });
 * });
 * @example
 * var initialToken = getAccessToken();
 * var client = new Twilio.Video.Client(initialToken);
 *
 * var localMedia = new Twilio.Video.LocalMedia();
 *
 * // Connect with audio-only
 * localMedia.addMicrophone().then(function() {
 *   return client.connect({ to: 'my-cool-room', localMedia: localMedia });
 * }).then(function(room) {
 *   // Our LocalParticipant reuses the LocalMedia we passed in.
 *   room.localParticipant.media === localMedia; // true
 *
 *   room.on('participantConnected', function(participant) {
 *     console.log(participant.identity + ' has connected');
 *   });
 *
 *   // Make sure to stop localMedia
 *   room.once('disconnected', function() {
 *     localMedia.stop();
 *   });
 * });
 */Client.prototype.connect=function connect(options){options=Object.assign({to:null},this._options,options);var log=this._log;log.info('Connecting to a Room');log.debug('Options:',options);var cancelableRoomPromise=createCancelableRoomPromise(getLocalMedia.bind(null,this,options),createLocalParticipant.bind(null,this),createRoomSignaling.bind(null,this,options),createRoom.bind(null,this,options));cancelableRoomPromise.then(function(room){log.info('Connected to Room:',room.toString());log.info('Room name:',room.name);log.debug('Room:',room);return room;},function(error){if(cancelableRoomPromise._isCanceled){log.info('Attempt to connect to a Room was canceled');}else{log.info('Error while connecting to a Room:',error);}});return cancelableRoomPromise;};/**
 * Set log levels for {@link Client}
 * @param {LogLevels|LogLevel} logLevel - New log level(s)
 * @returns {Client} this
 */Client.prototype.setLogLevel=function setLogLevel(logLevel){this._log.setLevels(util.buildLogLevels(logLevel));return this;};/**
 * Replace the {@link Client}'s currently active token with a new token.
 * @param {string} newToken - The new token to use to authenticate this {@link Client}.
 * @returns {Promise<this>}
 * @example
 * var initialToken = getAccessToken();
 * var client = new Twilio.Video.Client(initialToken);
 *
 * getAccessToken().then(function(newToken) {
 *   return client.updateToken(newToken);
 * }).then(function() {
 *   console.info('Successfully updated with new token');
 * }, function(reason) {
 *   console.error('Error while updating token: ' + reason);
 * });
 */Client.prototype.updateToken=function updateToken(newToken){var log=this._log;log.info('Updating the Client with a new Access Token');log.debug('New Access Token:',newToken);try{util.token.getAccountSid(newToken);util.token.getIdentity(newToken);this._token=newToken;return Promise.resolve(this);}catch(e){throw new TwE.INVALID_ACCESSTOKEN(e.message);}};/**
 * Your {@link Client} has run into an error.
 * @param {Error} error - The Error
 * @event Client#error
 * @example
 * var initialToken = getAccessToken();
 * var client = new Twilio.Video.Client(initialToken);
 *
 * client.on('error', function(error) {
 *  console.error(error);
 * });
 *//**
 * You may pass these options to {@link Client}'s constructor to override
 * its default behavior.
 * @typedef {object} Client.ConstructorOptions
 * @property {Array<RTCIceServer>} iceServers - Override the STUN and TURN
 *   servers used by the {@link Client} when connecting to {@link Room}s
 * @property {RTCIceTransportPolicy} [iceTransportPolicy="all"] - Override the ICE
 *   transport policy to be one of "relay" or "all"
 * @property {LogLevel|LogLevels} [logLevel='warn'] - Set the log verbosity
 *   of logging to console. Passing a {@link LogLevel} string will use the same level for
 *   all components. Pass a {@link LogLevels} to set specific log levels.
 *//**
 * You may pass these options to {@link Client#connect} to
 * override the default behavior.
 * @typedef {object} Client.ConnectOptions
 * @property {?boolean} [audio=true] - Whether or not to get local audio
 *   with <code>getUserMedia</code> when neither <code>localMedia</code>
 *   nor <code>localStream</code> are provided
 * @property {Array<RTCIceServer>} iceServers - Override the STUN and TURN
 *   servers used by the {@link Client} when connecting to {@link Room}s
 * @property {RTCIceTransportPolicy} [iceTransportPolicy="all"] - Override the ICE
 *   transport policy to be one of "relay" or "all"
 * @property {?LocalMedia} [localMedia=null] - Set to reuse an existing
 *   {@link LocalMedia} object when creating the {@link Room}
 * @property {?MediaStream} [localStream=null] - Set to reuse an existing
 *   <code>MediaStream</code> when creating the {@link Room}
 * @property {?string} [to=null] - Set to connect to a {@link Room} by name
 * @property {?boolean} [video=true] - Whether or not to get local video
 *   with <code>getUserMedia</code> when neither <code>localMedia</code>
 *   nor <code>localStream</code> are provided
 *//**
 * You may pass these levels to {@link Client.ConstructorOptions} to override
 *   log levels for individual components.
 * @typedef {object} LogLevels
 * @property {LogLevel} [default='warn'] - Override the log level for 'default' modules.
 * @property {LogLevel} [media='warn'] - Override the log level for 'media' modules.
 * @property {LogLevel} [signaling='warn'] - Override the log level for 'signaling' module.
 * @property {LogLevel} [webrtc='warn'] - Override the log level for 'webrtc' module.
 *//**
 * Levels for logging verbosity.
 * @typedef {String} LogLevel - One of ['debug', 'info', 'warn', 'error', 'off']
 */function createLocalParticipant(client,localMedia){var signaling=client._signaling.createLocalParticipantSignaling();var log=client._log;log.debug('Creating a new LocalParticipant:',signaling);return new LocalParticipant(signaling,localMedia,{log:log});}function createRoom(client,options,localParticipant,roomSignaling){var room=new Room(localParticipant,roomSignaling,options);var log=client._log;log.debug('Creating a new Room:',room);client._rooms.set(room.sid,room);roomSignaling.on('stateChanged',function stateChanged(){log.info('Disconnected from Room:',room.toString());client._rooms.delete(room.sid);roomSignaling.removeListener('stateChanged',stateChanged);});return room;}function createRoomSignaling(client,options,localParticipant){var log=client._log;log.info('Getting ICE servers');log.debug('Options:',options);return getIceServers(client,options).then(function(iceServers){var roomSignalingParams={token:client.token,accountSid:util.token.getAccountSid(client.token),identity:util.token.getIdentity(client.token)};log.info('Got ICE servers');log.debug('ICE servers:',iceServers);options.iceServers=iceServers;log.debug('Creating a new RoomSignaling');log.debug('RoomSignaling params:',roomSignalingParams);return client._signaling.connect(localParticipant._signaling,roomSignalingParams.token,roomSignalingParams.accountSid,roomSignalingParams.identity,options);});}function getLocalMedia(client,options,handleLocalMedia){var log=client._log;options.shouldStopLocalMedia=!options.localMedia&&!options.localStream;options.log=log;if(options.shouldStopLocalMedia){log.info('LocalMedia was not provided, so it will be acquired '+'automatically before connecting to the Room. LocalMedia will '+'be released if connecting to the Room fails or if the Room '+'is disconnected');}else{log.info('Getting LocalMedia');log.debug('Options:',options);}return client._getLocalMedia(options).then(function getLocalMediaSucceeded(localMedia){if(options.shouldStopLocalMedia){log.info('Got LocalMedia:',localMedia);}var promise=handleLocalMedia(localMedia);promise.catch(function handleLocalMediaFailed(){if(options.shouldStopLocalMedia){log.info('The automatically acquired LocalMedia will now be stopped');localMedia.stop();}});return promise;});}function getIceServers(client,options){var log=client._log;if(options.iceServers){log.debug('ICE servers:',options.iceServers);return Promise.resolve(options.iceServers);}log.debug('No ICE servers provided, so getting them from ECS');return new TimeoutPromise(client._ecsPromise,constants.ICE_SERVERS_TIMEOUT_MS).then(function(config){var nts=util.getOrNull(config,'video.network_traversal_service');if(!nts){throw new Error('network_traversal_service not available');}if(nts.warning){log.warn(nts.warning);}if(!nts.ice_servers){throw new Error('ice_servers not available');}log.info('Got ICE servers');log.debug('ICE servers:',nts.ice_servers);return nts.ice_servers;}).catch(function(reason){log.error('Failed to get ICE servers from ECS:',reason.message);log.warn('Returning default ICE servers:',client._defaultIceServers);return client._defaultIceServers;});}module.exports=Client;},{"../package":110,"./cancelableroompromise":2,"./ecs":4,"./localparticipant":6,"./media/localmedia":8,"./room":18,"./signaling/v2":28,"./util":51,"./util/constants":49,"./util/log":53,"./util/timeoutpromise":55,"events":70,"util":109}],4:[function(require,module,exports){'use strict';var request=require('./request');var CONFIG_URL='https://ecs.us1.twilio.com/v1/Configuration';/**
 * Request a configuration setting for the specified JWT.
 * @param {String} token - A JWT String representing a valid AccessToken.
 * @param {?ECS.getConfigurationOptions} [options]
 * @returns {Promise<Object>} configuration - An unformatted map of
 *   configuration settings specific to the specified service.
 *//**
 * @typedef {Object} ECS.getConfigurationOptions
 * @property {?Object} [body] - A valid JSON payload to send to the
 *   ECS endpoint.
 * @property {?String} [configUrl='https://ecs.us1.twilio.com/v1/Configuration'] - A
 *   custom URL to POST ECS configuration requests to.
 */function getConfiguration(token,options){if(!token){throw new Error('<String>token is a required argument.');}options=Object.assign({configUrl:CONFIG_URL},options);var postData={url:options.configUrl,headers:{'X-Twilio-Token':token,'Content-Type':'application/x-www-form-urlencoded'}};if(options.body){postData.body=toQueryString(options.body);}return request.post(postData).then(function(responseText){return JSON.parse(responseText);});}function toQueryString(params){return Object.keys(params||{}).map(function(key){return encodeURIComponent(key)+'='+encodeURIComponent(params[key]);}).join('&');}module.exports.getConfiguration=getConfiguration;},{"./request":17}],5:[function(require,module,exports){'use strict';var EventEmitter=require('events').EventEmitter;function EventTarget(){Object.defineProperties(this,{_eventEmitter:{value:new EventEmitter()}});}EventTarget.prototype.dispatchEvent=function dispatchEvent(event){return this._eventEmitter.emit(event.type,event);};EventTarget.prototype.addEventListener=function addEventListener(){return this._eventEmitter.addListener.apply(this._eventEmitter,arguments);};EventTarget.prototype.removeEventListener=function removeEventListener(){return this._eventEmitter.removeListener.apply(this._eventEmitter,arguments);};module.exports=EventTarget;},{"events":70}],6:[function(require,module,exports){'use strict';var util=require('./util');var inherits=require('util').inherits;var Participant=require('./participant');/**
 * Construct a {@link LocalParticipant}.
 * @class
 * @classdesc A {@link LocalParticipant} represents the local {@link Client} in a
 * {@link Room}.
 * @extends Participant
 * @param {ParticipantSignaling} signaling
 * @param {LocalMedia} localMedia
 * @param {Object} options
 * @property {LocalMedia} media
 */function LocalParticipant(signaling,localMedia,options){if(!(this instanceof LocalParticipant)){return new LocalParticipant(signaling,localMedia,options);}options.media=localMedia;Participant.call(this,signaling,options);}inherits(LocalParticipant,Participant);LocalParticipant.prototype.toString=function toString(){return'[LocalParticipant #'+this._instanceId+(this.sid?': '+this.sid:'')+']';};LocalParticipant.prototype._handleTrackSignalingEvents=function _handleTrackSignalingEvents(){var log=this._log;if(this.state==='disconnected'){return;}var media=this.media;var signaling=this._signaling;function localTrackAdded(localTrack){signaling.addTrack(localTrack._signaling);log.info('Added a new '+util.trackClass(localTrack,true)+':',localTrack.id);log.debug(util.trackClass(localTrack,true)+':',localTrack);}function localTrackRemoved(localTrack){signaling.removeTrack(localTrack._signaling);log.info('Removed a '+util.trackClass(localTrack,true)+':',localTrack.id);log.debug(util.trackClass(localTrack,true)+':',localTrack);}media.on('trackAdded',localTrackAdded);media.on('trackRemoved',localTrackRemoved);media.tracks.forEach(localTrackAdded);signaling.on('stateChanged',function stateChanged(state){log.debug('Transitioned to state:',state);if(state==='disconnected'){log.debug('Removing LocalTrack event listeners');signaling.removeListener('stateChanged',stateChanged);media.removeListener('trackAdded',localTrackAdded);media.removeListener('trackRemoved',localTrackRemoved);}});};module.exports=LocalParticipant;},{"./participant":15,"./util":51,"util":109}],7:[function(require,module,exports){'use strict';var EventEmitter=require('events').EventEmitter;var inherits=require('util').inherits;var util=require('../util');var nInstances=0;var Track=require('./track');var VideoTrack=require('./track/videotrack');/**
 * Construct a {@link Media} object.
 * @class
 * @classdesc A {@link Media} object contains a number of {@link AudioTrack}s
 *   and {@link VideoTrack}s. You can call {@link Media#attach} with a
 *   &lt;div&gt; to automatically update your application's user interface with
 *   &lt;audio&gt; and &lt;video&gt; elements as {@link Track}s are added and
 *   removed.
 * @property {Map<HTMLElement, Map<Track, HTMLElement>>} attachments - A Map
 *   from &lt;div&gt; elements to a Map from {@link Track}s to their attached
 *   HTMLElements (managed by {@link Media#attach} and {@link Media#detach})
 * @property {Map<Track.ID, AudioTrack>} audioTracks - The {@link AudioTrack}s on
 *   this {@link Media} object
 * @property {boolean} isMuted - True if every {@link AudioTrack} on this
 *   {@link Media} object is disabled
 * @property {boolean} isPaused - True if every {@link VideoTrack} on this
 *   {@link Media} object is disabled
 * @property {Set<MediaStream>} mediaStreams - The MediaStreams associated with
 *   the {@link Track}s on this {@link Media} object
 * @property {Map<Track.ID, Track>} tracks - The {@link AudioTrack}s and
 *   {@link VideoTrack}s on this {@link Media} object
 * @property {Map<Track.ID, VideoTrack>} videoTracks - The {@link VideoTrack}s on
 *   this {@link Media} object
 * @fires Media#trackAdded
 * @fires Media#trackDimensionsChanged
 * @fires Media#trackDisabled
 * @fires Media#trackEnabled
 * @fires Media#trackRemoved
 * @fires Media#trackStarted
 */function Media(options){EventEmitter.call(this);options=options||{};var attachments=new Map();var audioTracks=new Map();var mediaStreams=new Set();var tracks=new Map();var trackEventListeners=new Map();var videoTracks=new Map();/* istanbul ignore next */Object.defineProperties(this,{_instanceId:{value:++nInstances},_log:{value:options.log.createLog('media',this)},_trackEventListeners:{value:trackEventListeners},attachments:{enumerable:true,value:attachments},audioTracks:{enumerable:true,value:audioTracks},isMuted:{enumerable:true,get:function get(){var isMuted=true;audioTracks.forEach(function(track){isMuted=isMuted&&!track.isEnabled;});return isMuted;}},isPaused:{enumerable:true,get:function get(){var isPaused=true;videoTracks.forEach(function(track){isPaused=isPaused&&!track.isEnabled;});return isPaused;}},mediaStreams:{enumerable:true,value:mediaStreams},tracks:{enumerable:true,value:tracks},videoTracks:{enumerable:true,value:videoTracks}});var log=this._log;log.info('Created a new Media');return this;}var TRACK_ADDED=Media.TRACK_ADDED='trackAdded';var TRACK_DIMENSIONS_CHANGED=Media.TRACK_DIMENSIONS_CHANGED='trackDimensionsChanged';var TRACK_DISABLED=Media.TRACK_DISABLED='trackDisabled';var TRACK_ENABLED=Media.TRACK_ENABLED='trackEnabled';var TRACK_REMOVED=Media.TRACK_REMOVED='trackRemoved';var TRACK_STARTED=Media.TRACK_STARTED='trackStarted';inherits(Media,EventEmitter);Media.prototype.toString=function toString(){return'[Media #'+this._instanceId+']';};Media.prototype._updateMediaStreams=function _updateMediaStreams(){this.mediaStreams.clear();this.tracks.forEach(function(track){this.mediaStreams.add(track.mediaStream);},this);return this.mediaStreams;};Media.prototype._addTrack=function _addTrack(track){if(this.tracks.has(track.id)){return this;}this.mediaStreams.add(track.mediaStream);this.tracks.set(track.id,track);this._reemitTrackEvents(track);if(track.kind==='audio'){this.audioTracks.set(track.id,track);}else{this.videoTracks.set(track.id,track);}this.emit(TRACK_ADDED,track);var log=this._log;log.info('Added '+util.trackClass(track)+':',track.id);return this;};Media.prototype._reemitTrackEvents=function _reemitTrackEvents(track){if(this._trackEventListeners.has(track)){return;}var trackEventListeners=[[VideoTrack.DIMENSIONS_CHANGED,TRACK_DIMENSIONS_CHANGED],[Track.DISABLED,TRACK_DISABLED],[Track.ENABLED,TRACK_ENABLED],[Track.STARTED,TRACK_STARTED]].map(function(pair){var trackEvent=pair[0];var mediaEvent=pair[1];var eventListener=this._reemitTrackEvent(track,trackEvent,mediaEvent);return[trackEvent,eventListener];},this);this._trackEventListeners.set(track,trackEventListeners);};Media.prototype._reemitTrackEvent=function _reemitTrackEvent(track,trackEvent,mediaEvent){var self=this;function eventListener(){self.emit(mediaEvent,track);}track.on(trackEvent,eventListener);return eventListener;};Media.prototype._createTrackElement=function _createTrackElement(track){return track.attach();};Media.prototype._attachTrack=function _attachTrack(el,attachments,track){var trackEl=this._createTrackElement(track);el.appendChild(trackEl);attachments.set(track,trackEl);this._log.debug('Attached '+track+'to element:',trackEl);return this;};Media.prototype._detachTrack=function _detachTrack(attachments,track){var trackEl=attachments.get(track);if(!trackEl){return this;}track.detach(trackEl);if(trackEl.parentNode){trackEl.parentNode.removeChild(trackEl);}attachments.delete(track);this._log.debug('Detached '+track+' from element:',trackEl);return this;};Media.prototype._removeTrack=function _removeTrack(track){if(!this.tracks.has(track.id)){return this;}this.tracks.delete(track.id);(track.kind==='audio'?this.audioTracks:this.videoTracks).delete(track.id);this._removeTrackEventListeners(track);this._updateMediaStreams();this.emit(TRACK_REMOVED,track);var log=this._log;log.info('Removed a '+util.trackClass(track)+':',track.id);return this;};Media.prototype._removeTrackEventListeners=function _removeTrackEventListeners(track){var trackEventListeners=this._trackEventListeners.get(track)||[];this._trackEventListeners.delete(track);trackEventListeners.forEach(function(trackEventListener){track.removeListener.apply(track,trackEventListener);});};/**
 * Attach the {@link Media} to a newly created &lt;div&gt; element.
 * @returns {HTMLElement}
 * @example
 * var remoteMediaEl = media.attach();
 * document.getElementById('div#remote-media-container').appendChild(remoteMediaEl);
*//**
 * Attach the {@link Media} to an existing HTMLElement.
 * @param {HTMLElement} el - The HTMLElement to attach to
 * @returns {HTMLElement}
 * @example
 * var remoteMediaEl = document.getElementById('remote-media');
 * media.attach(remoteMediaEl);
*//**
 * Attach the {@link Media} to an HTMLElement selected by
 * <code>document.querySelector</code>.
 * @param {string} selector - A query selector for the HTMLElement to attach to
 * @returns {HTMLElement}
 * @example
 * var remoteMediaEl = media.attach('div#remote-media');
 */Media.prototype.attach=function attach(el){if(typeof el==='string'){el=this._selectContainer(el);}else if(!el){el=this._createContainer();}return this._attach(el);};Media.prototype._createContainer=function(){return document.createElement('div');};Media.prototype._selectContainer=function(selector){var el=document.querySelector(selector);if(!el){throw new Error('Selector matched no element: '+selector);}return el;};Media.prototype._attach=function(el){if(this.attachments.has(el)){return el;}var attachments=new Map();var self=this;// Attach existing audio and video tracks to the element,
this.tracks.forEach(function(track){self._attachTrack(el,attachments,track);});// And update the element as tracks are added,
this.on(TRACK_ADDED,function trackAdded(track){// But stop updating the element if we've been detached.
if(!self.attachments.has(el)){return self.removeListener(TRACK_ADDED,trackAdded);}self._attachTrack(el,attachments,track);});this.on(TRACK_REMOVED,function trackRemoved(track){if(!self.attachments.has(el)){return self.removeListener(TRACK_REMOVED,trackRemoved);}self._detachTrack(attachments,track);});this.attachments.set(el,attachments);return el;};/**
 * Detach the {@link Media} from any and all previously attached HTMLElements.
 * @returns {Array<HTMLElement>}
 * @example
 * var detachedMediaEls = media.detach();
*//**
 * Detach the {@link Media} from a previously attached HTMLElement.
 * @param {HTMLElement} el - The HTMLElement to detach from
 * @returns {HTMLElement}
 * @example
 * var remoteMediaEl = document.getElementById('remote-media');
 * media.detach(remoteMediaEl);
*//**
 * Detach the {@link Media} from a previously attached HTMLElement selected by
 * <code>document.querySelector</code>.
 * @param {string} selector - A query selector for the HTMLElement to detach from
 * @returns {HTMLElement}
 * @example
 * var detachedMediaEl = media.detach('div#remote-media');
 */Media.prototype.detach=function detach(el){var els;if(typeof el==='string'){els=[this._selectContainer(el)];}else if(!el){els=this._getAllAttachedContainers();}else{els=[el];}this._detachContainers(els);return el?els[0]:els;};Media.prototype._detachContainers=function(containers){return containers.map(this._detachContainer.bind(this));};Media.prototype._detachContainer=function(el){if(!this.attachments.has(el)){return el;}var attachments=this.attachments.get(el);var self=this;this.attachments.delete(el);attachments.forEach(function(trackEl,track){self._detachTrack(attachments,track);});return el;};Media.prototype._getAllAttachedContainers=function(){var els=[];this.attachments.forEach(function(attachments,el){els.push(el);});return els;};/**
 * A {@link Track} was added to this {@link Media} object.
 * @param {Track} track - The {@link Track} that was added
 * @event Media#trackAdded
 *//**
 * The dimensions of a {@link VideoTrack} on this {@link Media} object changed.
 * @param {VideoTrack} track - The {@link VideoTrack} whose dimensions changed
 * @event Media#trackDimensionsChanged
 *//**
 * A {@link Track} on this {@link Media} object was disabled.
 * @param {Track} track - The {@link Track} that was disabled
 * @event Media#trackDisabled
 *//**
 * A {@link Track} on this {@link Media} object was enabled.
 * @param {Track} track - The {@link Track} that was enabled
 * @event Media#trackEnabled
 *//**
 * A {@link Track} was removed from this {@link Media} object.
 * @param {Track} track - The {@link Track} that was removed
 * @event Media#trackRemoved
 *//**
 * A {@link Track} on this {@link Media} object was started.
 * @param {Track} track - The {@link Track} that was started
 * @event Media#trackStarted
 */module.exports=Media;},{"../util":51,"./track":10,"./track/videotrack":14,"events":70,"util":109}],8:[function(require,module,exports){'use strict';var getUserMedia=require('../webrtc/getusermedia');var inherits=require('util').inherits;var constants=require('../util/constants');var util=require('../util');var LocalAudioTrack=require('./track/localaudiotrack');var LocalVideoTrack=require('./track/localvideotrack');var Media=require('./');var Log=require('../util/log');/**
 * Construct a {@link LocalMedia} object.
 * @class
 * @classdesc A {@link LocalMedia} object is a {@link Media} object representing
 *   {@link LocalAudioTrack}s and {@link LocalVideoTrack}s that your {@link Client} may
 *   share in a {@link Room}.
 * @extends Media
 * @params {LocalMedia.Options} [options] - The {@link LocalMedia} options.
 * @property {Map<Track.ID, LocalAudioTrack>} audioTracks - The {@link LocalAudioTrack}s on
 *   this {@link Media} object
 * @property {Map<Track.ID, LocalTrack>} tracks - The {@link LocalAudioTrack}s and
 *   {@link LocalVideoTrack}s on this {@link Media} object
 * @property {Map<Track.ID, LocalVideoTrack>} videoTracks - The {@link LocalVideoTrack}s on
 *   this {@link Media} object
 */function LocalMedia(options){if(!(this instanceof LocalMedia)){return new LocalMedia(options);}options=Object.assign({logLevel:constants.DEFAULT_LOG_LEVEL},options);options.log=options.log||new Log('media',this,util.buildLogLevels(options.logLevel));Media.call(this,options);return this;}/**
 * Get {@link LocalMedia}. By default, this requests a
 * {@link LocalAudioTrack} and a {@link LocalVideoTrack} representing a microphone and
 * camera.
 * <br><br>
 * This method calls <code>getUserMedia</code> internally. Pass in
 * <code>options</code> to override the default behavior.
 * @param {?LocalMedia.GetLocalMediaOptions}
 *   [options={audio:true,video:true}] - Options to override
 *   {@link LocalMedia.getLocalMedia}'s default behavior
 * @returns {Promise<LocalMedia>}
 */LocalMedia.getLocalMedia=function getLocalMedia(options){options=options||{};if(options.localMedia){return Promise.resolve(options.localMedia);}var localMedia=new LocalMedia(options);var log=localMedia._log;if(options.localStream){log.info('Adding user-provided local MediaStream');log.debug('MediaStream:',options.localStream);return Promise.resolve(localMedia.addStream(options.localStream));}// NOTE(mroberts): getUserMedia requires audio and/or video, so if
// localStreamConstraints is set explicitly disabling both, just return an
// empty LocalMedia object.
if(options.audio===false&&options.video===false){log.info('Neither audio nor video requested, so returning empty LocalMedia');return Promise.resolve(localMedia);}log.info('Calling getUserMedia:',options);return getUserMedia({audio:options.audio===null||typeof options.audio==='undefined'?true:options.audio,video:options.video===null||typeof options.video==='undefined'?true:options.video}).then(function(mediaStream){log.info('Call to getUserMedia successful; got MediaStream:',mediaStream);log.info('Adding MediaStream to LocalMedia');return localMedia.addStream(mediaStream);}).catch(function(error){log.warn('Call to getUserMedia failed:',error);throw error;});};inherits(LocalMedia,Media);LocalMedia.prototype.toString=function toString(){return'[LocalMedia #'+this._instanceId+']';};/**
 * Set log levels for {@link LocalMedia}
 * @param {LogLevels|LogLevel} logLevel - New log level(s)
 * @returns {LocalMedia} this
 */LocalMedia.prototype.setLogLevel=function setLogLevel(logLevel){this._log.setLevels(util.buildLogLevels(logLevel));return this;};/**
 * Adds a {@link LocalTrack} to the {@link LocalMedia} object, if not already added.
 * @method
 * @param {LocalTrack} track - The {@link LocalTrack} to add
 * @returns {this}
 * @fires Media#trackAdded
 */LocalMedia.prototype.addTrack=function addTrack(track){// LocalMedia's removeTrack method will remove the MediaStreamTrack
// from the MediaStream; add it back here if it is missing.
if(track.mediaStream.getTracks().indexOf(track.mediaStreamTrack)===-1){this._log.debug('Adding MediaStreamTrack:',track.mediaStreamTrack);track.mediaStream.addTrack(track.mediaStreamTrack);}return Media.prototype._addTrack.apply(this,arguments);};/**
 * Adds a {@link LocalAudioTrack} representing your browser's microphone to the
 * {@link LocalMedia} object, if not already added.
 * <br><br>
 * Internally, this calls <code>getUserMedia({ audio: true })</code>.
 * @param {MediaTrackConstraints} [audioConstraints]
 * @returns {Promise<LocalAudioTrack>}
 * @fires Media#trackAdded
 */LocalMedia.prototype.addMicrophone=function addMicrophone(audioConstraints){var self=this;var microphone=null;var log=this._log;audioConstraints=audioConstraints||true;this.audioTracks.forEach(function(audioTrack){microphone=microphone||audioTrack;});if(microphone){log.info('Returning existing LocalAudioTrack for microphone:',microphone);return Promise.resolve(microphone);}log.info('Getting microphone');return getUserMedia({audio:audioConstraints,video:false}).then(function gotMicrophone(mediaStream){var audioTracks=mediaStream.getAudioTracks();var mediaStreamTrack=audioTracks[0];var audioTrack=new LocalAudioTrack(mediaStream,mediaStreamTrack,{log:log});self._addTrack(audioTrack);log.info('Got microphone:',mediaStreamTrack);return audioTrack;}).catch(function(error){log.warn('Error while getting microphone:',error);throw error;});};/**
 * Removes the {@link LocalAudioTrack} representing your browser's microphone, if it
 * has been added.
 * @param {?boolean} [stop=true] - Whether or not to call
 *   {@link LocalTrack#stop} on the corresponding {@link LocalTrack}
 * @returns {?LocalAudioTrack}
 * @fires Media#trackRemoved
 */LocalMedia.prototype.removeMicrophone=function removeMicrophone(stop){var microphone=null;var log=this._log;this.audioTracks.forEach(function(audioTrack){microphone=microphone||audioTrack;});if(microphone){log.info((stop?'Stopping and r':'R')+'emoving microphone:',microphone);return this.removeTrack(microphone,stop);}log.debug('Cannot remove the microphone because it has not been added');return microphone;};/**
 * Adds a {@link LocalVideoTrack} representing your browser's camera to the
 * {@link LocalMedia} object, if not already added.
 * <br><br>
 * Internally, this calls <code>getUserMedia({ video: true })</code>.
 * @param {MediaTrackConstraints} [videoConstraints]
 * @returns {Promise<LocalVideoTrack>}
 * @fires Media#trackAdded
 */LocalMedia.prototype.addCamera=function addCamera(videoConstraints){var self=this;var camera=null;var log=this._log;videoConstraints=videoConstraints||true;this.videoTracks.forEach(function(videoTrack){camera=camera||videoTrack;});if(camera){log.info('Returning existing LocalVideoTrack for camera:',camera);return Promise.resolve(camera);}return getUserMedia({audio:false,video:videoConstraints}).then(function gotCamera(mediaStream){var videoTracks=mediaStream.getVideoTracks();var mediaStreamTrack=videoTracks[0];var videoTrack=new LocalVideoTrack(mediaStream,mediaStreamTrack,{log:log});self._addTrack(videoTrack);log.info('Got camera:',mediaStreamTrack);return videoTrack;}).catch(function(error){log.warn('Error while getting camera:',error);throw error;});};/**
 * Removes the {@link LocalVideoTrack} representing your browser's camera, if it
 * has been added.
 * @param {?boolean} [stop=true] - Whether or not to call
 *   {@link LocalTrack#stop} on the corresponding {@link LocalTrack}
 * @returns {?LocalVideoTrack}
 * @fires Media#trackRemoved
 */LocalMedia.prototype.removeCamera=function removeCamera(stop){var camera=null;var log=this._log;this.videoTracks.forEach(function(videoTrack){camera=camera||videoTrack;});if(camera){log.info((stop?'Stopping and r':'R')+'emoving camera:',camera);return this.removeTrack(camera,stop);}log.debug('Cannot remove the camera because it has not been added');return camera;};/**
 * Add a <code>MediaStream</code> to the {@link LocalMedia} object, constructing
 * {@link LocalTrack}s as necessary for each <code>MediaStreamTrack</code> contained
 * within.
 * @param {MediaStream} mediaStream - The <code>MediaStream</code> to add
 * @returns {this}
 * @fires Media#trackAdded
 */LocalMedia.prototype.addStream=function addStream(mediaStream){var log=this._log;mediaStream.getAudioTracks().forEach(function(mediaStreamTrack){var audioTrack=new LocalAudioTrack(mediaStream,mediaStreamTrack,{log:log});this._addTrack(audioTrack);log.debug('Added new LocalAudioTrack:',audioTrack);},this);mediaStream.getVideoTracks().forEach(function(mediaStreamTrack){var videoTrack=new LocalVideoTrack(mediaStream,mediaStreamTrack,{log:log});this._addTrack(videoTrack);log.debug('Added new LocalVideoTrack:',videoTrack);},this);log.info('Added MediaStream:',mediaStream);return this;};/**
 * Remove a <code>MediaStream</code> from the {@link LocalMedia} object. This
 * will remove any {@link LocalTrack}s corresponding to
 * <code>MediaStreamTrack</code>s contained within the <code>MediaStream</code>.
 * @param {MediaStream} mediaStream - The <code>MediaStream</code> to remove
 * @param {?boolean} [stop=true] - Whether or not to call
 *   {@link LocalTrack#stop} on the corresponding {@link LocalTrack}s
 * @returns {this}
 * @fires Media#trackRemoved
 */LocalMedia.prototype.removeStream=function removeStream(mediaStream,stop){var log=this._log;log.info((stop?'Stopping and r':'R')+'emoving all Tracks '+'associated with local MediaStream:',mediaStream);mediaStream.getTracks().forEach(function(mediaStreamTrack){var track=this.tracks.get(mediaStreamTrack.id);if(track){log.debug((stop?'Stopping and r':'R')+'emoving LocalTrack:',track);this.removeTrack(track,stop);}},this);return this;};/**
 * Removes a {@link LocalTrack} from the {@link LocalMedia} object, if it was added.
 * @method
 * @param {LocalTrack} track - The {@link LocalTrack} to remove
 * @param {?boolean} [stop=true] - Whether or not to call
 *   {@link LocalTrack#stop}
 * @returns {this}
 * @fires Media#trackRemoved
 */LocalMedia.prototype.removeTrack=function removeTrack(track,stop){var log=this._log;try{track.mediaStream.removeTrack(track.mediaStreamTrack);log.info('Removed MediaStreamTrack:',track.mediaStreamTrack);}catch(error){// Firefox doesn't support removeStream/removeTrack, so we can't yet truly
// remove and renegotiate media.
log.warn('Cannot remove MediaStreamTrack on Firefox:',error);}Media.prototype._removeTrack.call(this,track);// NOTE(mroberts): An ended Track will trigger a subsequent call to
// removeTrack on the Media superclass, which will trigger a renegotiation
// before we have actually updated the MediaStream. So keep this line _after_
// we actually updated the MediaStream.
if(typeof stop==='boolean'?stop:true){track.stop();log.info('Stopped LocalTrack:',track);}return track;};/**
 * Disable every {@link LocalAudioTrack} on this {@link LocalMedia} object.
 * @returns {this}
 * @fires Media#trackDisabled
*//**
 * Disable or enable every {@link LocalAudioTrack} on this {@link LocalMedia} object.
 * @param {?boolean} enabled - Specify false to enable the {@link LocalAudioTrack}s
 * @returns {this}
 * @fires Media#trackDisabled
 * @fires Media#trackEnabled
 */LocalMedia.prototype.mute=function mute(muted){var log=this._log;log.info((muted?'M':'Unm')+'uting LocalMedia by '+(muted?'dis':'en')+'abling the LocalAudioTracks');muted=typeof muted==='boolean'?muted:true;this.audioTracks.forEach(function(track){log.debug((muted?'Dis':'En')+'abling LocalAudioTrack:',track);track.enable(!muted);});return this;};/**
 * Disable every {@link LocalVideoTrack} on this {@link LocalMedia} object.
 * @returns {this}
 * @fires Media#trackDisabled
*//**
 * Disable or enable every {@link LocalVideoTrack} on this {@link LocalMedia} object.
 * @param {?boolean} enabled - Specify false to enable the {@link LocalVideoTrack}s
 * @returns {this}
 * @fires Media#trackDisabled
 * @fires Media#trackEnabled
 */LocalMedia.prototype.pause=function pause(paused){var log=this._log;log.info((paused?'P':'Unp')+'ausing LocalMedia by '+(paused?'dis':'en')+'abling the LocalVideoTracks');paused=typeof paused==='boolean'?paused:true;this.videoTracks.forEach(function(track){log.debug((paused?'Dis':'En')+'abling LocalVideoTrack:',track);track.enable(!paused);});return this;};/**
 * Stop all {@link LocalAudioTrack}s and {@link LocalVideoTrack}s on this {@link LocalMedia} object.
 * @returns {this}
 */LocalMedia.prototype.stop=function stop(){var log=this._log;log.info('Stopping the LocalMedia by stopping all LocalTracks');this.tracks.forEach(function(track){log.debug('Stopping LocalTrack:',track);track.stop();});return this;};/**
 * Enable every {@link LocalAudioTrack} on this {@link LocalMedia} object.
 * @returns {this}
 * @fires Media#trackEnabled
 */LocalMedia.prototype.unmute=function unmute(){return this.mute(false);};/**
 * Enable every {@link LocalVideoTrack} on this {@link LocalMedia} object.
 * @returns {this}
 * @fires Media#trackEnabled
 */LocalMedia.prototype.unpause=function unpause(){return this.pause(false);};/**
 * You may pass these options to the {@link LocalMedia} constructor to
 * override the default behavior.
 * @typedef {object} LocalMedia.Options
 * @property {LogLevel|LogLevels} [logLevel='warn'] - Set the log verbosity
 *   of logging to console. Passing a {@link LogLevel} string will use the
 *   same level for all components. Pass a {@link LogLevels} to set specific
 *   log levels.
 *//**
 * You may pass these options to {@link LocalMedia.getLocalMedia} to
 * override the default behavior.
 * @typedef {object} LocalMedia.GetLocalMediaOptions
 * @property {?LocalMedia} [localMedia=null] - Set to reuse an existing
 *   {@link LocalMedia} object
 * @property {?MediaStream} [localStream=null] - Set to reuse an existing
 *   <code>MediaStream</code>
 * @property {?boolean} [audio=true] - Whether or not to get local audio
 *   with <code>getUserMedia</code> when neither <code>localMedia</code>
 *   nor <code>localStream</code> are provided
 * @property {?boolean} [video=true] - Whether or not to get local video
 *   with <code>getUserMedia</code> when neither <code>localMedia</code>
 *   nor <code>localStream</code> are provided
 */module.exports=LocalMedia;},{"../util":51,"../util/constants":49,"../util/log":53,"../webrtc/getusermedia":59,"./":7,"./track/localaudiotrack":11,"./track/localvideotrack":13,"util":109}],9:[function(require,module,exports){'use strict';var inherits=require('util').inherits;var Track=require('./');/**
 * Construct an {@link AudioTrack} from MediaStream and MediaStreamTrack.
 * @class
 * @classdesc An {@link AudioTrack} is a {@link Track} representing audio.
 * @extends Track
 * @param {MediaStream} mediaStream
 * @param {MediaStreamTrack} mediaStreamTrack
 * @param {TrackSignaling} signaling
 * @param {{log: Log}} options
 * @property {Set<HTMLElement>} attachments - The &lt;audio&gt; elements this
 *   {@link AudioTrack} is currently attached to (managed by
 *   {@link AudioTrack#attach})
 */function AudioTrack(mediaStream,mediaStreamTrack,signaling,options){Track.call(this,mediaStream,mediaStreamTrack,signaling,options);}inherits(AudioTrack,Track);AudioTrack.prototype.toString=function toString(){return'[AudioTrack #'+this._instanceId+': '+this.id+']';};/**
 * Attach the {@link AudioTrack} to a newly created &lt;audio&gt; element.
 * @method
 * @returns {HTMLElement}
 * @example
 * var audioEl = audioTrack.attach();
 * document.getElementById('div#audio-track-container').appendChild(audioEl);
*//**
 * Attach the {@link AudioTrack} to an existing &lt;audio&gt; element.
 * @method
 * @param {HTMLElement} audio - The &lt;audio&gt; element to attach to
 * @returns {HTMLElement}
 * @example
 * var audioEl = document.getElementById('audio-track');
 * audioTrack.attach(audioEl);
*//**
 * Attach the {@link AudioTrack} to a &lt;audio&gt; element selected by
 * <code>document.querySelector</code>.
 * @method
 * @param {string} selector - A query selector for the &lt;audio&gt; element to attach to
 * @returns {HTMLElement}
 * @example
 * var audioEl = audioTrack.attach('audio#audio-track');
 */AudioTrack.prototype.attach=Track.prototype.attach;/**
 * Detach the {@link AudioTrack} from any and all previously attached &lt;audio&gt; elements.
 * @method
 * @returns {Array<HTMLElement>}
 * @example
 * var detachedAudioEls = audioTrack.detach();
*//**
 * Detach the {@link AudioTrack} from a previously attached &lt;audio&gt; element.
 * @method
 * @param {HTMLElement} audio - The &lt;audio&gt; element to detach from
 * @returns {HTMLElement}
 * @example
 * var audioEl = document.getElementById('audio-track');
 * audioTrack.detach(audioEl);
*//**
 * Detach the {@link AudioTrack} from a previously attached &lt;audio&gt; element selected by
 * <code>document.querySelector</code>.
 * @method
 * @param {string} selector - A query selector for the &lt;audio&gt; element to detach from
 * @returns {HTMLElement}
 * @example
 * var detachedAudioEl = media.detach('div#audio-track');
 */AudioTrack.prototype.detach=Track.prototype.detach;module.exports=AudioTrack;},{"./":10,"util":109}],10:[function(require,module,exports){/* globals webkitMediaStream, MediaStream */'use strict';var EventEmitter=require('events').EventEmitter;var inherits=require('util').inherits;var nInstances=0;/**
 * Construct a {@link Track} from a MediaStream and MediaStreamTrack.
 * @class
 * @classdesc A {@link Track} represents audio or video that can be sent to or
 * received from a {@link Room}. {@link Track}s abstract away the notion
 * of MediaStream and MediaStreamTrack.
 * @param {MediaStream} mediaStream
 * @param {MediaStreamTrack} mediaStreamTrack
 * @param {TrackSignaling} signaling
 * @param {{log: Log}} options
 * @property {Track.ID} id - This {@link Track}'s ID
 * @property {boolean} isStarted - Whether or not the {@link Track} has started
 * @property {boolean} isEnabled - Whether or not the {@link Track} is enabled
 *  (i.e., whether it is paused or muted)
 * @property {string} kind - The kind of the underlying
 *   {@link MediaStreamTrack}; e.g. "audio" or "video"
 * @property {MediaStream} mediaStream - The underlying MediaStream
 * @property {MediaStreamTrack} mediaStreamTrack - The underlying
 *   MediaStreamTrack
 * @fires Track#disabled
 * @fires Track#enabled
 * @fires Track#started
 */function Track(mediaStream,mediaStreamTrack,signaling,options){EventEmitter.call(this);var isStarted=false;/* istanbul ignore next */Object.defineProperties(this,{_instanceId:{value:++nInstances},_isStarted:{get:function get(){return isStarted;},set:function set(_isStarted){isStarted=_isStarted;}},_log:{value:options.log.createLog('media',this)},_signaling:{value:signaling},attachments:{value:new Set()},id:{enumerable:true,value:mediaStreamTrack.id},isEnabled:{enumerable:true,get:function get(){return signaling.isEnabled;}},isStarted:{get:function get(){return isStarted;}},kind:{enumerable:true,value:mediaStreamTrack.kind},mediaStream:{enumerable:true,value:mediaStream},mediaStreamTrack:{enumerable:true,value:mediaStreamTrack}});this._initialize();}Track.DISABLED='disabled';Track.ENABLED='enabled';var STARTED=Track.STARTED='started';inherits(Track,EventEmitter);Track.prototype._start=function _start(){this._log.debug('Started');this._isStarted=true;this._detachElement(this._dummyEl);this._dummyEl.oncanplay=null;this.emit(STARTED,this);};Track.prototype._initialize=function _initialize(){var self=this;this._log.debug('Initializing');this._dummyEl=this._createElement();this._dummyEl.muted=true;this._dummyEl.oncanplay=this._start.bind(this,this._dummyEl);this._reemit=function reemmit(){self.emit(self.isEnabled?'enabled':'disabled',self);};this._signaling.on('updated',this._reemit);this._attach(this._dummyEl);};Track.prototype._end=function _end(){this._log.debug('Ended');this._signaling.removeListener('updated',this._reemit);this._detachElement(this._dummyEl);this._dummyEl.oncanplay=null;};Track.prototype.attach=function attach(el){if(typeof el==='string'){el=this._selectElement(el);}else if(!el){el=this._createElement();}this._log.debug('Attempting to attach to element:',el);el=this._attach(el);return el;};Track.prototype._attach=function _attach(el){if(this.attachments.has(el)){return el;}if(typeof window==='undefined'||typeof navigator==='undefined'){throw new Error('Can not attach track to page: global.navigator and global.window are required.');}var _MediaStream=typeof webkitMediaStream!=='undefined'?webkitMediaStream:MediaStream;var mediaStream=new _MediaStream();mediaStream.addTrack(this.mediaStreamTrack);if(typeof navigator.webkitGetUserMedia==='function'){var vendorURL=window.URL||window.webkitURL;el.src=vendorURL.createObjectURL(mediaStream);}else if(typeof navigator.mozGetUserMedia==='function'){el.mozSrcObject=mediaStream;}el.autoplay=true;this.attachments.add(el);return el;};Track.prototype._selectElement=function _selectElement(selector){var el=document.querySelector(selector);if(!el){throw new Error('Selector matched no element: '+selector);}return el;};Track.prototype._createElement=function _createElement(){return document.createElement(this.kind);};Track.prototype.detach=function _detach(el){var els;if(typeof el==='string'){els=[this._selectElement(el)];}else if(!el){els=this._getAllAttachedElements();}else{els=[el];}this._log.debug('Attempting to detach from elements:',els);this._detachElements(els);return el?els[0]:els;};Track.prototype._detachElements=function _detachElements(elements){return elements.map(this._detachElement.bind(this));};Track.prototype._detachElement=function _detachElement(el){if(!this.attachments.has(el)){return el;}el.removeAttribute('src');this.attachments.delete(el);return el;};Track.prototype._getAllAttachedElements=function _getAllAttachedElements(){var els=[];this.attachments.forEach(function(el){els.push(el);});return els;};/**
 * The {@link Track} ID is a string identifier for the {@link Track}.
 * @type string
 * @typedef Track.ID
 *//**
 * The {@link Track} was disabled. For {@link AudioTrack}s this means
 * "muted", and for {@link VideoTrack}s this means "paused".
 * @param {Track} track - The {@link Track} that was disabled
 * @event Track#disabled
 *//**
 * The {@link Track} was enabled. For {@link AudioTrack}s this means
 * "unmuted", and for {@link VideoTrack}s this means "unpaused".
 * @param {Track} track - The {@link Track} that was enabled
 * @event Track#enabled
 *//**
 * The {@link Track} started. This means that the {@link Track} contains
 * enough audio or video to begin playback.
 * @param {Track} track - The {@link Track} that started
 * @event Track#started
 */module.exports=Track;},{"events":70,"util":109}],11:[function(require,module,exports){'use strict';var AudioTrack=require('./audiotrack');var inherits=require('util').inherits;var LocalTrack=require('./localtrack');/**
 * Construct a {@link LocalAudioTrack} from MediaStream and MediaStreamTrack.
 * @class
 * @classdesc A {@link LocalAudioTrack} is an {@link AudioTrack} representing
 * audio that your {@link Client} sends to a {@link Room}.
 * @extends {AudioTrack}
 * @extends {LocalTrack}
 * @param {MediaStream} mediaStream
 * @param {MediaStreamTrack} mediaStreamTrack
 * @param {{log: Log}} options
 */function LocalAudioTrack(mediaStream,mediaStreamTrack,options){if(!(this instanceof LocalAudioTrack)){return new LocalAudioTrack(mediaStream,mediaStreamTrack,options);}LocalTrack.call(this,AudioTrack,mediaStream,mediaStreamTrack,options);}inherits(LocalAudioTrack,AudioTrack);LocalAudioTrack.prototype.toString=function toString(){return'[LocalAudioTrack #'+this._instanceId+': '+this.id+']';};LocalAudioTrack.prototype.attach=function attach(el){el=AudioTrack.prototype.attach.call(this,el);el.muted=true;return el;};/**
 * Disable the {@link LocalAudioTrack}. This is effectively "mute".
 * @method
 * @returns {this}
 * @fires Track#disabled
 */LocalAudioTrack.prototype.disable=LocalTrack.prototype.disable;/**
 * Enable the {@link LocalAudioTrack}. This is effectively "unmute".
 * @method
 * @returns {this}
 * @fires Track#enabled
*//**
 * Enable or disable the {@link LocalAudioTrack}. This is effectively "unmute" or
 * "mute".
 * @method
 * @param {boolean} [enabled] - Specify false to mute the {@link LocalAudioTrack}
 * @returns {this}
 * @fires Track#disabled
 * @fires Track#enabled
 */LocalAudioTrack.prototype.enable=LocalTrack.prototype.enable;LocalAudioTrack.prototype.stop=LocalTrack.prototype.stop;module.exports=LocalAudioTrack;},{"./audiotrack":9,"./localtrack":12,"util":109}],12:[function(require,module,exports){'use strict';var LocalTrackSignaling=require('../../signaling/localtrack');/**
 * @class
 * @classdesc A {@link LocalTrack} represents audio or video that your
 * {@link Client} is sending to a {@link Room}. As such, it can be
 * enabled and disabled with {@link LocalTrack#enable} and
 * {@link LocalTrack#disable} or stopped completely with
 * {@link LocalTrack#stop}.
 * @extends Track
 * @param {function(MediaStream, MediaStreamTrack, TrackSignaling): Track} Track
 * @param {MediaStream} mediaStream
 * @param {MediaStream} mediaStreamTrack
 * @param {{log: Log}} options
 */function LocalTrack(Track,mediaStream,mediaStreamTrack,options){var self=this;var signaling=new LocalTrackSignaling(mediaStreamTrack,mediaStream);Track.call(this,mediaStream,mediaStreamTrack,signaling,options);this.mediaStreamTrack.addEventListener('ended',function onended(){Track.prototype._end.call(self);self.mediaStreamTrack.removeEventListener('ended',onended);});}/**
 * Enable the {@link LocalTrack}.
 * @returns {this}
 * @fires Track#enabled
*//**
 * Enable or disable the {@link LocalTrack}.
 * @param {boolean} [enabled] - Specify false to disable the {@link LocalTrack}
 * @returns {this}
 * @fires Track#disabled
 * @fires Track#enabled
 */LocalTrack.prototype.enable=function enable(enabled){enabled=typeof enabled==='boolean'?enabled:true;this._log.info((enabled?'En':'Dis')+'abling');this.mediaStreamTrack.enabled=enabled;this._signaling.enable(enabled);return this;};/**
 * Disable the {@link LocalTrack}.
 * @returns {this}
 * @fires Track#disabled
 */LocalTrack.prototype.disable=function disable(){return this.enable(false);};/**
 * Calls stop on the underlying MediaStreamTrack. If you choose to stop a
 * {@link LocalTrack}, you should use {@link LocalMedia#removeTrack} to remove
 * it after stopping. You do not need to stop a track before using
 * {@link LocalTrack#disable} or {@link LocalMedia#removeTrack}.
 * @returns {this}
 */LocalTrack.prototype.stop=function stop(){this._log.info('Stopping');this.mediaStreamTrack.stop();return this;};module.exports=LocalTrack;},{"../../signaling/localtrack":20}],13:[function(require,module,exports){'use strict';var inherits=require('util').inherits;var LocalTrack=require('./localtrack');var VideoTrack=require('./videotrack');/**
 * Construct a {@link LocalVideoTrack} from MediaStream and MediaStreamTrack.
 * @class
 * @classdesc A {@link LocalVideoTrack} is a {@link VideoTrack} representing
 * audio that your {@link Client} sends to a {@link Room}.
 * @extends {VideoTrack}
 * @extends {LocalTrack}
 * @param {MediaStream} mediaStream
 * @param {MediaStreamTrack} mediaStreamTrack
 * @param {{log: Log}} options
 */function LocalVideoTrack(mediaStream,mediaStreamTrack,options){if(!(this instanceof LocalVideoTrack)){return new LocalVideoTrack(mediaStream,mediaStreamTrack,options);}LocalTrack.call(this,VideoTrack,mediaStream,mediaStreamTrack,options);}inherits(LocalVideoTrack,VideoTrack);LocalVideoTrack.prototype.toString=function toString(){return'[LocalVideoTrack #'+this._instanceId+': '+this.id+']';};/**
 * Enable the {@link LocalVideoTrack}. This is effectively "unpause".
 * @method
 * @returns {this}
 * @fires Track#enabled
*//**
 * Enable or disable the {@link LocalVideoTrack}. This is effectively "unpause" or
 * "pause".
 * @method
 * @param {boolean} [enabled] - Specify false to pause the {@link LocalVideoTrack}
 * @returns {this}
 * @fires Track#disabled
 * @fires Track#enabled
 */LocalVideoTrack.prototype.enable=LocalTrack.prototype.enable;/**
 * Disable the {@link LocalVideoTrack}. This is effectively "pause".
 * @method
 * @returns {this}
 * @fires Track#disabled
 */LocalVideoTrack.prototype.disable=LocalTrack.prototype.disable;LocalVideoTrack.prototype.stop=LocalTrack.prototype.stop;module.exports=LocalVideoTrack;},{"./localtrack":12,"./videotrack":14,"util":109}],14:[function(require,module,exports){'use strict';var inherits=require('util').inherits;var Track=require('./');/**
 * Construct a {@link VideoTrack} from MediaStream and MediaStreamTrack.
 * @class
 * @classdesc A {@link VideoTrack} is a {@link Track} representing video.
 * @extends Track
 * @param {MediaStream} mediaStream
 * @param {MediaStreamTrack} mediaStreamTrack
 * @param {TrackSignaling} signaling
 * @param {{log: Log}} options
 * @property {Set<HTMLElement>} attachments - The &lt;video&gt; elements this
 *   {@link VideoTrack} is currently attached to (managed by
 *   {@link VideoTrack#attach})
 * @property {VideoTrack#Dimensions} dimensions - The {@link VideoTrack}'s {@link VideoTrack#Dimensions}
 * @fires VideoTrack#dimensionsChanged
 */function VideoTrack(mediaStream,mediaStreamTrack,signaling,options){Track.call(this,mediaStream,mediaStreamTrack,signaling,options);Object.defineProperties(this,{dimensions:{enumerable:true,value:{width:null,height:null}}});Object.defineProperty(this,'_dimensionsChangedElem',{value:emitDimensionsChangedEvents(this)});return this;}var DIMENSIONS_CHANGED=VideoTrack.DIMENSIONS_CHANGED='dimensionsChanged';function emitDimensionsChangedEvents(track){if(typeof document==='undefined'){throw new Error('document is undefined');}var elem=document.createElement(track.kind);elem.muted=true;elem.onloadedmetadata=function onloadedmetadata(){if(dimensionsChanged(track,elem)){track.dimensions.width=elem.videoWidth;track.dimensions.height=elem.videoHeight;}};elem.onresize=function onresize(){if(dimensionsChanged(track,elem)){track.dimensions.width=elem.videoWidth;track.dimensions.height=elem.videoHeight;if(track.isStarted){track._log.debug('Dimensions changed:',track.dimensions);track.emit(DIMENSIONS_CHANGED,track);}}};return track.attach(elem);}function dimensionsChanged(track,elem){return track.dimensions.width!==elem.videoWidth||track.dimensions.height!==elem.videoHeight;}inherits(VideoTrack,Track);VideoTrack.prototype.toString=function toString(){return'[VideoTrack #'+this._instanceId+': '+this.id+']';};VideoTrack.prototype._start=function _start(dummyEl){this.dimensions.width=dummyEl.videoWidth;this.dimensions.height=dummyEl.videoHeight;this._log.debug('Dimensions:',this.dimensions);return Track.prototype._start.call(this,dummyEl);};/**
 * Attach the {@link VideoTrack} to a newly created &lt;video&gt; element.
 * @method
 * @returns {HTMLElement}
 * @example
 * var videoEl = videoTrack.attach();
 * document.getElementById('div#video-track-container').appendChild(videoEl);
*//**
 * Attach the {@link VideoTrack} to an existing &lt;video&gt; element.
 * @method
 * @param {HTMLElement} video - The &lt;video&gt; element to attach to
 * @returns {HTMLElement}
 * @example
 * var videoEl = document.getElementById('video-track');
 * videoTrack.attach(videoEl);
*//**
 * Attach the {@link VideoTrack} to a &lt;video&gt; element selected by
 * <code>document.querySelector</code>.
 * @method
 * @param {string} selector - A query selector for the &lt;video&gt; element to attach to
 * @returns {HTMLElement}
 * @example
 * var videoEl = videoTrack.attach('video#video-track');
 */VideoTrack.prototype.attach=function attach(el){el=Track.prototype.attach.call(this,el);el.muted=true;return el;};/**
 * Detach the {@link VideoTrack} from any and all previously attached &lt;video&gt; elements.
 * @method
 * @returns {Array<HTMLElement>}
 * @example
 * var detachedVideoEls = videoTrack.detach();
*//**
 * Detach the {@link VideoTrack} from a previously attached &lt;video&gt; element.
 * @method
 * @param {HTMLElement} video - The &lt;video&gt; element to detach from
 * @returns {HTMLElement}
 * @example
 * var videoEl = document.getElementById('video-track');
 * videoTrack.detach(videoEl);
*//**
 * Detach the {@link VideoTrack} from a previously attached &lt;video&gt; element selected by
 * <code>document.querySelector</code>.
 * @method
 * @param {string} selector - A query selector for the &lt;video&gt; element to detach from
 * @returns {HTMLElement}
 * @example
 * var detachedVideoEl = media.detach('div#video-track');
 */VideoTrack.prototype.detach=function detach(){Track.prototype.detach.call(this,this._dimensionsChangedElem);return Track.prototype.detach.apply(this,arguments);};/**
 * A {@link VideoTrack}'s width and height.
 * @typedef {object} VideoTrack#Dimensions
 * @property {?number} width - The {@link VideoTrack}'s width or null if the
 *   {@link VideoTrack} has not yet started
 * @property {?number} height - The {@link VideoTrack}'s height or null if the
 *   {@link VideoTrack} has not yet started
 *//**
 * The {@link VideoTrack}'s dimensions changed.
 * @param {VideoTrack} track - The {@link VideoTrack} whose dimensions changed
 * @event VideoTrack#dimensionsChanged
 */module.exports=VideoTrack;},{"./":10,"util":109}],15:[function(require,module,exports){'use strict';var DefaultAudioTrack=require('./media/track/audiotrack');var DefaultVideoTrack=require('./media/track/videotrack');var EventEmitter=require('events').EventEmitter;var inherits=require('util').inherits;var util=require('./util');var Media=require('./media');var nInstances=0;/**
 * Construct a {@link Participant}.
 * @class
 * @classdesc A {@link Participant} represents a remote {@link Client} in a
 * {@link Room}.
 * @param {ParticipantSignaling} signaling
 * @param {object} [options]
 * @property {Participant.Identity} identity - The identity of the {@link Participant}
 * @property {Media} media - The {@link Media} this {@link Participant} is sharing, if any
 * @property {Participant.SID} sid - The {@link Participant}'s SID
 * @property {string} state - "connected", "disconnected" or "failed"
 * @fires Participant#connected
 * @fires Participant#disconnected
 * @fires Participant#trackAdded
 * @fires Participant#trackDimensionsChanged
 * @fires Participant#trackDisabled
 * @fires Participant#trackEnabled
 * @fires Participant#trackRemoved
 * @fires Participant#trackStarted
 */function Participant(signaling,options){if(!(this instanceof Participant)){return new Participant(signaling,options);}EventEmitter.call(this);options=Object.assign({AudioTrack:DefaultAudioTrack,VideoTrack:DefaultVideoTrack},options);Object.defineProperties(this,{_AudioTrack:{value:options.AudioTrack},_instanceId:{value:++nInstances},_log:{value:options.log.createLog('default',this)},_signaling:{value:signaling},_VideoTrack:{value:options.VideoTrack},identity:{enumerable:true,get:function get(){return signaling.identity;}},media:{enumerable:true,value:options.media||new Media({log:options.log})},sid:{enumerable:true,get:function get(){return signaling.sid;}},state:{enumerable:true,get:function get(){return signaling.state;}}});handleMediaAndSignalingEvents(this,signaling);this._handleTrackSignalingEvents();var log=this._log;log.info('Created a new Participant'+(this.identity?': '+this.identity:''));log.debug('Media:',this.media);}inherits(Participant,EventEmitter);Participant.prototype.toString=function toString(){return'[Participant #'+this._instanceId+': '+this.sid+']';};Participant.prototype._handleTrackSignalingEvents=function _handleTrackSignalingEvents(){var log=this._log;if(this.state==='disconnected'){return;}var AudioTrack=this._AudioTrack;var media=this.media;var signaling=this._signaling;var VideoTrack=this._VideoTrack;function trackSignalingAdded(signaling){signaling.getMediaStreamTrack().then(function(pair){var mediaStreamTrack=pair[0];var mediaStream=pair[1];var Track=signaling.kind==='audio'?AudioTrack:VideoTrack;var track=new Track(mediaStream,mediaStreamTrack,signaling,{log:log});media._addTrack(track);log.info('Added a new '+util.trackClass(track)+':',track.id);log.debug(util.trackClass(track)+':',track);});}function trackSignalingRemoved(signaling){signaling.getMediaStreamTrack().then(function(){var track=media.tracks.get(signaling.id);if(track){media._removeTrack(track);log.info('Removed a '+util.trackClass(track)+':',track.id);log.debug(util.trackClass(track)+':',track);}});}signaling.on('trackAdded',trackSignalingAdded);signaling.on('trackRemoved',trackSignalingRemoved);signaling.tracks.forEach(trackSignalingAdded);signaling.on('stateChanged',function stateChanged(state){if(state==='disconnected'){log.debug('Removing TrackSignaling listeners');signaling.removeListener('stateChanged',stateChanged);signaling.removeListener('trackAdded',trackSignalingAdded);signaling.removeListener('trackRemoved',trackSignalingRemoved);}});};/**
 * A {@link Participant.SID} is a 34-character string starting with "PA"
 * that uniquely identifies a {@link Participant}.
 * @type string
 * @typedef Participant.SID
 *//**
 * A {@link Participant.Identity} is a string that identifies a
 * {@link Participant}. You can think of it like a name.
 * @type string
 * @typedef Participant.Identity
 *//**
 * The {@link Participant} has disconnected.
 * @param {Participant} participant - The {@link Participant} that disconnected.
 * @event Participant#disconnected
 *//**
 * A {@link Track} was added by the {@link Participant}.
 * @param {Track} track - The {@link Track} that was added
 * @event Participant#trackAdded
 *//**
 * One of the {@link Participant}'s {@link VideoTrack}'s dimensions changed.
 * @param {VideoTrack} track - The {@link VideoTrack} whose dimensions changed
 * @event Participant#trackDimensionsChanged
 *//**
 * A {@link Track} was disabled by the {@link Participant}.
 * @param {Track} track - The {@link Track} that was disabled
 * @event Participant#trackDisabled
 *//**
 * A {@link Track} was enabled by the {@link Participant}.
 * @param {Track} track - The {@link Track} that was enabled
 * @event Participant#trackEnabled
 *//**
 * A {@link Track} was removed by the {@link Participant}.
 * @param {Track} track - The {@link Track} that was removed
 * @event Participant#trackRemoved
 *//**
 * One of the {@link Participant}'s {@link Track}s started.
 * @param {Track} track - The {@link Track} that started
 * @event Participant#trackStarted
 */function handleMediaAndSignalingEvents(participant,signaling){var log=participant._log;if(participant.state==='disconnected'){return;}// Reemit Track events from Media.
var removeListeners=['trackAdded','trackDimensionsChanged','trackDisabled','trackEnabled','trackRemoved','trackStarted'].map(function(event){function eventListener(){var args=[].slice.call(arguments);args.unshift(event);participant.emit.apply(participant,args);}participant.media.on(event,eventListener);return participant.media.removeListener.bind(participant.media,event,eventListener);});// Reemit state transition events from the ParticipantSignaling.
signaling.on('stateChanged',function stateChanged(state){log.debug('Transitioned to state:',state);participant.emit(state,participant);if(state==='disconnected'){log.debug('Removing Track event reemitters');signaling.removeListener('stateChanged',stateChanged);removeListeners.forEach(function(removeListener){removeListener();});}});}module.exports=Participant;},{"./media":7,"./media/track/audiotrack":9,"./media/track/videotrack":14,"./util":51,"events":70,"util":109}],16:[function(require,module,exports){'use strict';var EventEmitter=require('events').EventEmitter;var inherits=require('util').inherits;/**
 * Construct a {@link QueueingEventEmitter}
 * @class
 * @classdesc A {@link QueueingEventEmitter} can queue events until a listener
 *   has been added.
 * @extends EventEmitter
 */function QueueingEventEmitter(){EventEmitter.call(this);Object.defineProperties(this,{_queuedEvents:{value:new Map()}});}inherits(QueueingEventEmitter,EventEmitter);/**
 * Emit any queued events.
 * @returns {boolean} true if every event had listeners, false otherwise
*//**
 * Emit any queued events matching the event name.
 * @param {string} event
 * @returns {boolean} true if every event had listeners, false otherwise
 */QueueingEventEmitter.prototype.dequeue=function dequeue(event){var result=true;if(!event){this._queuedEvents.forEach(function(_,queuedEvent){result=this.dequeue(queuedEvent)&&result;},this);return result;}var queue=this._queuedEvents.get(event)||[];this._queuedEvents.delete(event);var self=this;return queue.reduce(function(result,args){return self.emit.apply(self,[event].concat(args))&&result;},result);};/**
 * If the event has listeners, emit the event; otherwise, queue the event.
 * @param {string} event
 * @param {...*} args
 * @returns {boolean} true if the event had listeners, false if the event was queued
 */QueueingEventEmitter.prototype.queue=function queue(){var args=[].slice.call(arguments);if(this.emit.apply(this,args)){return true;}var event=args[0];if(!this._queuedEvents.has(event)){this._queuedEvents.set(event,[]);}this._queuedEvents.get(event).push(args.slice(1));return false;};module.exports=QueueingEventEmitter;},{"events":70,"util":109}],17:[function(require,module,exports){'use strict';var XHR=require('xmlhttprequest').XMLHttpRequest;/**
 * Make a network request.
 * @param {String} method - HTTP method to use. e.g: GET, POST.
 * @param {RequestParams} params
 * @returns {Promise<String>} responseText
 *//**
 * @typedef {Object} RequestParams
 * @property {String} url - URL to access.
 * @property {Object} [headers] - An unformatted map of headers.
 * @property {Object} [body] - An unformatted map representing
 *   post body.
 * @property {Boolean} [withCredentials=false] - Whether to set the
 *   XHR withCredentials flag.
 */function request(method,params){return new Promise(function(resolve,reject){if(typeof method!=='string'||!params){throw new Error('<String>method and <Object>params are required args.');}var xhr=new XHR();xhr.open(method.toUpperCase(),params.url,true);xhr.withCredentials=!!params.withCredentials;xhr.onreadystatechange=function onreadystatechange(){if(xhr.readyState!==4){return;}if(200<=xhr.status&&xhr.status<300){resolve(xhr.responseText);}else{reject(xhr.responseText);}};for(var headerName in params.headers){xhr.setRequestHeader(headerName,params.headers[headerName]);}xhr.send(params.body);});}request.get=request.bind(null,'GET');request.post=request.bind(null,'POST');module.exports=request;},{"xmlhttprequest":112}],18:[function(require,module,exports){'use strict';var EventEmitter=require('events').EventEmitter;var inherits=require('util').inherits;var Participant=require('./participant');var TwE=require('./util/constants').twilioErrors;var nInstances=0;/**
 * Construct a {@link Room}.
 * @class
 * @classdesc A {@link Room} represents communication between your
 *   {@link Client} and one or more {@link Participant}s sharing
 *   {@link AudioTrack}s and {@link VideoTrack}s.
 *   <br><br>
 *   You can connect to a {@link Room} by calling {@link Client#connect}.
 * @param {RoomSignaling} signaling
 * @param {?object} [options={}]
 * @property {boolean} isRecording - Whether or not the {@link Room} is being
 *   recorded
 * @property {LocalParticipant} localParticipant - Your {@link Client}'s
 *   {@link LocalParticipant} in the {@link Room}.
 * @property {string} name - The {@link Room}'s name
 * @property {Map<Participant.SID, Participant>} participants - The {@link Participant}s
 *   participating in this {@link Room}
 * @property {Room.SID} sid - The {@link Room}'s SID
 * @property {string} state - "connected" or "disconnected"
 * @fires Room#disconnected
 * @fires Room#participantConnected
 * @fires Room#participantDisconnected
 * @fires Room#recordingStarted
 * @fires Room#recordingStopped
 * @fires Room#trackAdded
 * @fires Room#trackDimensionsChanged
 * @fires Room#trackDisabled
 * @fires Room#trackEnabled
 * @fires Room#trackRemoved
 * @fires Room#trackStarted
 */function Room(localParticipant,signaling,options){if(!(this instanceof Room)){return new Room(localParticipant,signaling,options);}EventEmitter.call(this);var log=options.log.createLog('default',this);var participants=new Map();/* istanbul ignore next */Object.defineProperties(this,{_log:{value:log},_instanceId:{value:++nInstances},_options:{value:options},_participants:{value:participants},_signaling:{value:signaling},isRecording:{enumerable:true,get:function get(){return signaling.recording.isEnabled||false;}},localParticipant:{enumerable:true,value:localParticipant},name:{enumerable:true,value:signaling.name},participants:{enumerable:true,value:participants},sid:{enumerable:true,value:signaling.sid},state:{enumerable:true,get:function get(){return signaling.state;}}});handleRecordingEvents(this,signaling.recording);handleSignalingEvents(this,signaling);log.info('Created a new Room:',this.name);log.debug('Initial Participants:',Array.from(this._participants.values()));}inherits(Room,EventEmitter);Room.prototype.toString=function toString(){return'[Room #'+this._instanceId+': '+this.sid+']';};/**
 * Disconnect from the {@link Room}.
 * @returns {this}
 */Room.prototype.disconnect=function disconnect(){this._log.info('Disconnecting');this._signaling.disconnect();return this;};/**
 * Get the {@link Room}'s media statistics.
 * @returns {Promise.<Array<StatsReport>>}
 */Room.prototype.getStats=function getStats(){return this._signaling.getStats();};/**
 * A {@link Room.SID} is a 34-character string starting with "RM"
 * that uniquely identifies a {@link Room}.
 * @type string
 * @typedef Room.SID
 *//**
 * Your {@link Client} was disconnected from the {@link Room} and all
 * other {@link Participant}s.
 * @param {Room} room - The {@link Room} your
 *   {@link Client} was disconnected from
 * @param {?TwilioError} error - Present when the {@link Client} got
 *   disconnected from the {@link Room} unexpectedly
 * @event Room#disconnected
 * @example
 * myRoom.on('disconnected', function(room, error) {
 *   if (error) {
 *     console.log('Unexpectedly disconnected:', error);
 *   }
 *   myRoom.localParticipant.media.detach();
 * });
 *//**
 * A {@link Participant} joined the {@link Room}.
 * @param {Participant} participant - The {@link Participant} who joined
 * @event Room#participantConnected
 * @example
 * myRoom.on('participantConnected', function(participant) {
 *   console.log(participant.identity + ' joined the Room');
 *
 *   // Get the participant's Media,
 *   var participantMedia = participant.media;
 *
 *   // And attach it to your application's view.
 *   var participantView = document.getElementById('participant-view');
 *   participantMedia.attach(participantView);
 *   participantVideos.appendChild(participantView);
 * });
 *//**
 * A {@link Participant} left the {@link Room}.
 * @param {Participant} participant - The {@link Participant} who left
 * @event Room#participantDisconnected
 * @example
 * myRoom.on('participantDisconnected', function(participant) {
 *   console.log(participant.identity + ' left the Room');
 * });
 *//**
 * The {@link Room} is now being recorded
 * @event Room#recordingStarted
 *//**
 * The {@link Room} is no longer being recorded
 * @event Room#recordingStopped
 *//**
 * A {@link Track} was added by a {@link Participant} in the {@link Room}.
 * @param {Track} track - The {@link Track} that was added
 * @param {Participant} participant - The {@link Participant} who added the
 *   {@link Track}
 * @event Room#trackAdded
 *//**
 * One of the {@link Participant}'s {@link VideoTrack}'s dimensions changed.
 * @param {VideoTrack} track - The {@link VideoTrack} whose dimensions changed
 * @param {Participant} participant - The {@link Participant} whose {@link VideoTrack}'s
 *   dimensions changed
 * @event Room#trackDimensionsChanged
 *//**
 * A {@link Track} was disabled by a {@link Participant} in the {@link Room}.
 * @param {Track} track - The {@link Track} that was disabled
 * @param {Participant} participant - The {@link Participant} who disabled the
 *   {@link Track}
 * @event Room#trackDisabled
 *//**
 * A {@link Track} was enabled by a {@link Participant} in the {@link Room}.
 * @param {Track} track - The {@link Track} that was enabled
 * @param {Participant} participant - The {@link Participant} who enabled the
 *   {@link Track}
 * @event Room#trackEnabled
 *//**
 * A {@link Track} was removed by a {@link Participant} in the {@link Room}.
 * @param {Track} track - The {@link Track} that was removed
 * @param {Participant} participant - The {@link Participant} who removed the
 *   {@link Track}
 * @event Room#trackRemoved
 *//**
 * One of a {@link Participant}'s {@link Track}s in the {@link Room} started.
 * @param {Track} track - The {@link Track} that started
 * @param {Participant} participant - The {@link Participant} whose {@link Track} started
 * @event Room#trackStarted
 */function connectParticipant(room,participantSignaling){var log=room._log;var participant=new Participant(participantSignaling,{log:log});log.info('A new Participant connected:',participant);room._participants.set(participant.sid,participant);room.emit('participantConnected',participant);// Reemit Track events from the Participant.
var eventListeners=['trackAdded','trackDimensionsChanged','trackDisabled','trackEnabled','trackRemoved','trackStarted'].map(function(event){function reemit(){var args=[].slice.call(arguments);args.unshift(event);args.push(participant);room.emit.apply(room,args);}participant.on(event,reemit);return[event,reemit];});// Reemit state transition events from the Participant.
participant.once('disconnected',function participantDisconnected(){log.info('Participant disconnected:',participant);room._participants.delete(participant.sid);eventListeners.forEach(function(args){participant.removeListener(args[0],args[1]);});room.emit('participantDisconnected',participant);});}function handleRecordingEvents(room,recording){recording.on('updated',function updated(){var started=recording.isEnabled;room._log.info('Recording '+(started?'started':'stopped'));room.emit('recording'+(started?'Started':'Stopped'));});}function handleSignalingEvents(room,signaling){var log=room._log;// Reemit Participant events from the RoomSignaling.
log.debug('Creating a new Participant for each ParticipantSignaling '+'in the RoomSignaling');signaling.participants.forEach(connectParticipant.bind(null,room));log.debug('Setting up Participant creation for all subsequent '+'ParticipantSignalings that connect to the RoomSignaling');signaling.on('participantConnected',connectParticipant.bind(null,room));// Reemit state transition events from the RoomSignaling.
signaling.on('stateChanged',function stateChanged(state){var error=signaling.didDisconnectUnexpectedly?new TwE.SIGNALING_CONNECTION_DISCONNECTED():null;log.info('Transitioned to state:',state);room.emit(state,room,error);if(state==='disconnected'&&room._options.shouldStopLocalMedia){log.info('Room disconnected. We now stop any automatically acquired '+'LocalMedia');room.localParticipant.media.stop();}});}module.exports=Room;},{"./participant":15,"./util/constants":49,"events":70,"util":109}],19:[function(require,module,exports){/* eslint consistent-return:0 */'use strict';var inherits=require('util').inherits;var ParticipantSignaling=require('./participant');var RoomSignaling=require('./room');var StateMachine=require('../statemachine');/*
Signaling States
----------------

              +---------+
              |         |
              | opening |
         +--->|         |
         |    +---------+
    +--------+   |   |   +------+
    |        |<--+   +-->|      |
    | closed |<----------| open |
    |        |<--+   +-->|      |
    +--------+   |   |   +------+
              +---------+   |
              |         |<--+
              | closing |
              |         |
              +---------+

*/var states={closed:['opening'],opening:['closed','open'],open:['closed','closing'],closing:['closed','open']};/**
 * Construct {@link Signaling}.
 * @class
 * @extends StateMachine
 * @property {string} state - one of "closed", "opening", "open", or "closing"
 */function Signaling(){StateMachine.call(this,'closed',states);}inherits(Signaling,StateMachine);// NOTE(mroberts): This is a dummy implementation suitable for testing.
Signaling.prototype._close=function _close(key){this.transition('closing',key);this.transition('closed',key);return Promise.resolve(this);};// NOTE(mroberts): This is a dummy implementation suitable for testing.
Signaling.prototype._connect=function _connect(localParticipant,token,accountSid,identity,options){localParticipant.connect('PA00000000000000000000000000000000',identity);var sid='RM00000000000000000000000000000000';var promise=Promise.resolve(new RoomSignaling(localParticipant,sid,options));promise.cancel=function cancel(){};return promise;};// NOTE(mroberts): This is a dummy implementation suitable for testing.
Signaling.prototype._open=function _open(key){this.transition('opening',key);this.transition('open',key);return Promise.resolve(this);};/**
 * Close the {@link Signaling}.
 * @returns {Promise<this>}
 */Signaling.prototype.close=function close(){var self=this;return this.bracket('close',function transition(key){switch(self.state){case'closed':return self;case'open':return self._close(key);default:throw new Error('Unexpected Signaling state "'+self.state+'"');}});};/**
 * Connect to a {@link RoomSignaling}.
 * @param {ParticipantSignaling} localParticipant
 * @param {string} token
 * @param {string} accountSid
 * @param {string} identity
 * @param {object} options
 * @returns {Promise<function(): CancelablePromise<RoomSignaling>>}
 */Signaling.prototype.connect=function connect(localParticipant,token,accountSid,identity,options){var self=this;return this.bracket('connect',function transition(key){switch(self.state){case'closed':return self._open(key).then(transition.bind(null,key));case'open':// NOTE(mroberts): We don't need to hold the lock in _connect. Instead,
// we just need to ensure the Signaling remains open.
self.releaseLockCompletely(key);return self._connect(localParticipant,token,accountSid,identity,options);default:throw new Error('Unexpected Signaling state "'+self.state+'"');}});};/**
 * Create a local {@link ParticipantSignaling}.
 * @returns {ParticipantSignaling}
 */Signaling.prototype.createLocalParticipantSignaling=function createLocalParticipantSignaling(){return new ParticipantSignaling();};/**
 * Open the {@link Signaling}.
 * @returns {Promise<this>}
 */Signaling.prototype.open=function open(){var self=this;return this.bracket('open',function transition(key){switch(self.state){case'closed':return self._open(key);case'open':return self;default:throw new Error('Unexpected Signaling state "'+self.state+'"');}});};module.exports=Signaling;},{"../statemachine":39,"./participant":21,"./room":24,"util":109}],20:[function(require,module,exports){'use strict';var inherits=require('util').inherits;var TrackSignaling=require('./track');/**
 * Construct a {@link LocalTrackSignaling}.
 * @class
 * @classdesc A {@link LocalTrack} implementation
 * @extends TrackSignaling
 * @param {MediaStreamTrack} mediaStreamTrack
 * @param {MediaStream} mediaStream
 */function LocalTrackSignaling(mediaStreamTrack,mediaStream){TrackSignaling.call(this,mediaStreamTrack.id,mediaStreamTrack.kind,mediaStreamTrack.enabled);this.setMediaStreamTrack(mediaStreamTrack,mediaStream);}inherits(LocalTrackSignaling,TrackSignaling);module.exports=LocalTrackSignaling;},{"./track":25,"util":109}],21:[function(require,module,exports){'use strict';var inherits=require('util').inherits;var StateMachine=require('../statemachine');/*
ParticipantSignaling States
----------------------

    +------------+     +-----------+     +--------------+
    |            |     |           |     |              |
    | connecting |---->| connected |---->| disconnected |
    |            |     |           |     |              |
    +------------+     +-----------+     +--------------+

*/var states={connecting:['connected'],connected:['disconnected'],disconnected:[]};/**
 * Construct a {@link ParticipantSignaling}.
 * @class
 * @classdesc A {@link Participant} implementation
 * @extends StateMachine
 * @property {?string} identity
 * @property {?Participant.SID} sid
 * @property {string} state - "connecting", "connected", or "disconnected"
 * @property {Map<string, TrackSignaling>} tracks
 * @emits ParticipantSignaling#trackAdded
 * @emits ParticipantSignaling#trackRemoved
 */function ParticipantSignaling(){StateMachine.call(this,'connecting',states);Object.defineProperties(this,{_identity:{writable:true,value:null},_sid:{writable:true,value:null},identity:{enumerable:true,get:function get(){return this._identity;}},sid:{enumerable:true,get:function get(){return this._sid;}},tracks:{enumerable:true,value:new Map()}});}inherits(ParticipantSignaling,StateMachine);/**
 * Add {@link TrackSignaling} to the {@link ParticipantSignaling}.
 * @param {TrackSignaling} track
 * @returns {this}
 */ParticipantSignaling.prototype.addTrack=function addTrack(track){this.tracks.set(track.id,track);this.emit('trackAdded',track);return this;};/**
 * Disconnect the {@link ParticipantSignaling}.
 * @returns {boolean}
 */ParticipantSignaling.prototype.disconnect=function disconnect(){if(this.state!=='disconnected'){this.preempt('disconnected');return true;}return false;};/**
 * Remove {@link TrackSignaling} from the {@link ParticipantSignaling}.
 * @param {TrackSignaling} track
 * @returns {boolean}
 */ParticipantSignaling.prototype.removeTrack=function removeTrack(track){var didDelete=this.tracks.delete(track.id);if(didDelete){this.emit('trackRemoved',track);}return didDelete;};/**
 * Connect the {@link ParticipantSignaling}.
 * @param {Participant.SID} sid
 * @param {string} identity
 * @returns {boolean}
 */ParticipantSignaling.prototype.connect=function connect(sid,identity){if(this.state==='connecting'){this._sid=sid;this._identity=identity;this.preempt('connected');return true;}return false;};/**
 * {@link TrackSignaling} was added to the {@link ParticipantSignaling}.
 * @event ParticipantSignaling#trackAdded
 * @param {TrackSignaling} track
 *//**
 * {@link TrackSignaling} was removed from the {@link ParticipantSignaling}.
 * @event ParticipantSignaling#trackRemoved
 * @param {TrackSignaling} track
 */module.exports=ParticipantSignaling;},{"../statemachine":39,"util":109}],22:[function(require,module,exports){'use strict';var EventEmitter=require('events').EventEmitter;var inherits=require('util').inherits;/**
 * Construct a {@link RecordingSignaling}.
 * @class
 * @classdesc Represents recording state
 * @property {?boolean} isEnabled
 */function RecordingSignaling(){EventEmitter.call(this);Object.defineProperties(this,{_isEnabled:{value:null,writable:true},isEnabled:{enumerable:true,get:function get(){return this._isEnabled;}}});}inherits(RecordingSignaling,EventEmitter);/**
 * Disable the {@link RecordingSignaling} if it is not already disabled.
 * @return {this}
 */RecordingSignaling.prototype.disable=function disable(){return this.enable(false);};/**
 * Enable (or disable) the {@link RecordingSignaling} if it is not already enabled
 * (or disabled).
 * @param {boolean} [enabled=true]
 * @return {this}
 */RecordingSignaling.prototype.enable=function enable(enabled){enabled=typeof enabled==='boolean'?enabled:true;if(this.isEnabled!==enabled){this._isEnabled=enabled;this.emit('updated');}return this;};/**
 * Emitted whenever the {@link RecordingSignaling} is updated
 * @event RecordingSignaling#updated
 */module.exports=RecordingSignaling;},{"events":70,"util":109}],23:[function(require,module,exports){'use strict';var inherits=require('util').inherits;var ParticipantSignaling=require('./participant');/**
 * Construct a {@link RemoteParticipantSignaling}.
 * @class
 * @classdesc A {@link Participant} implementation
 * @extends ParticipantSignaling
 * @param {Participant.SID} sid
 * @param {string} identity
 * @property {string} identity
 * @property {Participant.SID} sid
 */function RemoteParticipantSignaling(sid,identity){ParticipantSignaling.call(this);this.connect(sid,identity);}inherits(RemoteParticipantSignaling,ParticipantSignaling);module.exports=RemoteParticipantSignaling;},{"./participant":21,"util":109}],24:[function(require,module,exports){'use strict';var inherits=require('util').inherits;var DefaultRecordingSignaling=require('./recording');var StateMachine=require('../statemachine');/*
RoomSignaling States
-----------------------

    +-----------+     +--------------+
    |           |     |              |
    | connected |---->| disconnected |
    |           |     |              |
    +-----------+     +--------------+

*/var states={connected:['disconnected'],disconnected:[]};/**
 * Construct a {@link RoomSignaling}.
 * @class
 * @classdesc A {@link Room} implementation
 * @extends StateMachine
 * @param {ParticipantSignaling} localParticipant
 * @param {Room.SID} sid
 * @param {string} name
 * @param {boolean} didDisconnectUnexpectedly
 * @property {ParticipantSignaling} localParticipant
 * @property {string} name
 * @property {Map<string, RemoteParticipantSignaling>} participants
 * @property {RecordingSignaling} recording
 * @property {Room.SID} sid
 * @property {string} state - "connected" or "disconnected"
 */function RoomSignaling(localParticipant,sid,name,options){options=Object.assign({RecordingSignaling:DefaultRecordingSignaling},options);StateMachine.call(this,'connected',states);var RecordingSignaling=options.RecordingSignaling;Object.defineProperties(this,{_options:{value:options},didDisconnectUnexpectedly:{value:false,writable:true,enumerable:true},localParticipant:{enumerable:true,value:localParticipant},name:{enumerable:true,value:name},participants:{enumerable:true,value:new Map()},recording:{enumerable:true,value:new RecordingSignaling()},sid:{enumerable:true,value:sid}});}inherits(RoomSignaling,StateMachine);/**
 * Handle unexpected disconnect.
 * @returns {boolean}
 */RoomSignaling.prototype._handleUnexpectedDisconnect=function _handleUnexpectedDisconnect(){this.didDisconnectUnexpectedly=true;return this.disconnect();};/**
 * Connect {@link RemoteParticipantSignaling} to the {@link RoomSignaling}.
 * @param {RemoteParticipantSignaling} participant
 * @returns {boolean}
 */RoomSignaling.prototype.connectParticipant=function connectParticipant(participant){var self=this;if(participant.state==='disconnected'){return false;}if(this.participants.has(participant.sid)){return false;}this.participants.set(participant.sid,participant);participant.on('stateChanged',function stateChanged(state){if(state==='disconnected'){participant.removeListener('stateChanged',stateChanged);self.participants.delete(participant.sid);self.emit('participantDisconnected',participant);}});this.emit('participantConnected',participant);return true;};/**
 * Disconnect.
 * @returns {boolean}
 */RoomSignaling.prototype.disconnect=function disconnect(){if(this.state==='connected'){this.preempt('disconnected');return true;}return false;};/**
 * {@link RemoteParticipantSignaling} connected to the {@link RoomSignaling}.
 * @event RoomSignaling#event:participantConnected
 * @param {RemoteParticipantSignaling} participantSignaling
 *//**
 * {@link RemoteParticipantSignaling} disconnected from the {@link RoomSignaling}.
 * @event RoomSignaling#event:participantDisconnected
 * @param {RemoteParticipantSignaling} participantSignaling
 */module.exports=RoomSignaling;},{"../statemachine":39,"./recording":22,"util":109}],25:[function(require,module,exports){'use strict';var EventEmitter=require('events').EventEmitter;var inherits=require('util').inherits;var util=require('../util');/**
 * Construct a {@link TrackSignaling}.
 * @class
 * @classdesc A {@link Track} implementation
 * @param {string} id
 * @param {string} kind - one of "audio" or "video"
 * @param {boolean} isEnabled
 * @property {string} id
 * @property {boolean} isEnabled
 * @property {string} kind
 * @property {?MediaStream} mediaStream
 * @property {?MediaStreamTrack} mediaStreamTrack
 */function TrackSignaling(id,kind,isEnabled){EventEmitter.call(this);var mediaStream;var mediaStreamTrack;Object.defineProperties(this,{_isEnabled:{value:isEnabled,writable:true},_mediaStream:{get:function get(){return mediaStream;},set:function set(_mediaStream){mediaStream=_mediaStream;this._mediaStreamDeferred.resolve(mediaStream);}},_mediaStreamDeferred:{value:util.defer()},_mediaStreamTrack:{get:function get(){return mediaStreamTrack;},set:function set(_mediaStreamTrack){mediaStreamTrack=_mediaStreamTrack;this._mediaStreamTrackDeferred.resolve(mediaStreamTrack);}},_mediaStreamTrackDeferred:{value:util.defer()},id:{enumerable:true,value:id},isEnabled:{enumerable:true,get:function get(){return this._isEnabled;}},kind:{enumerable:true,value:kind},mediaStream:{enumerable:true,get:function get(){return mediaStream;}},mediaStreamTrack:{enumerable:true,get:function get(){return mediaStreamTrack;}}});}inherits(TrackSignaling,EventEmitter);/**
 * Disable the {@link TrackSignaling} if it is not already disabled.
 * @return {this}
 */TrackSignaling.prototype.disable=function disable(){return this.enable(false);};/**
 * Enable (or disable) the {@link TrackSignaling} if it is not already enabled
 * (or disabled).
 * @param {boolean} [enabled=true]
 * @return {this}
 */TrackSignaling.prototype.enable=function enable(enabled){enabled=typeof enabled==='boolean'?enabled:true;if(this.isEnabled!==enabled){this._isEnabled=enabled;this.emit('updated');}return this;};/**
 * Get the MediaStreamTrack (and MediaStream) on the {@link TrackSignaling}.
 * @returns {Promise<[MediaStreamTrack, MediaStream]>}
 */TrackSignaling.prototype.getMediaStreamTrack=function getMediaStreamTrack(){return Promise.all([this._mediaStreamTrackDeferred.promise,this._mediaStreamDeferred.promise]);};/**
 * Set the MediaStreamTrack (and MediaStream) on the {@link TrackSignaling}.
 * @param {MediaStreamTrack} mediaStreamTrack
 * @param {MediaStream} mediaStream
 * @returns {this}
 */TrackSignaling.prototype.setMediaStreamTrack=function setMediaStreamTrack(mediaStreamTrack,mediaStream){this._mediaStream=mediaStream;this._mediaStreamTrack=mediaStreamTrack;return this;};/**
 * Emitted whenever the {@link TrackSignaling} is updated
 * @event TrackSignaling#updated
 */module.exports=TrackSignaling;},{"../util":51,"events":70,"util":109}],26:[function(require,module,exports){'use strict';var CancelablePromise=require('../../util/cancelablepromise');var DefaultPeerConnectionManager=require('./peerconnectionmanager');var DefaultRoomV2=require('./room');var DefaultTransport=require('./transport');var TwE=require('../../util/constants').twilioErrors;function createCancelableRoomSignalingPromise(accountSid,token,ua,localParticipant,options){options=Object.assign({PeerConnectionManager:DefaultPeerConnectionManager,RoomV2:DefaultRoomV2,Transport:DefaultTransport},options);var transport;var PeerConnectionManager=options.PeerConnectionManager;var RoomV2=options.RoomV2;var peerConnectionManager=new PeerConnectionManager();peerConnectionManager.setConfiguration(options);var mediaStreams=new Set();localParticipant.tracks.forEach(function(track){mediaStreams.add(track.mediaStream);});mediaStreams.forEach(peerConnectionManager.addMediaStream,peerConnectionManager);var cancelationError=new Error('Canceled');return new CancelablePromise(function onCreate(resolve,reject,isCanceled){peerConnectionManager.createAndOffer().then(function createAndOfferSucceeded(){// NOTE(mmalavalli): PeerConnectionManager#createAndOffer() queues the
// initial offer in the event queue for the 'description' event. So,
// we are dequeueing to prevent the spurious 'update' message sent by
// the client after connecting to a room.
peerConnectionManager.dequeue('description');return new Promise(function(resolve,reject){if(isCanceled()){reject(cancelationError);return;}var Transport=options.Transport;transport=new Transport(options.to,accountSid,token,localParticipant,peerConnectionManager,ua);transport.once('connected',function connected(initialState){if(isCanceled()){reject(cancelationError);return;}var localParticipantState=initialState.participant;if(!localParticipantState){reject(new Error('Missing LocalParticipant information'));return;}localParticipant.connect(localParticipantState.sid,localParticipantState.identity);resolve(new RoomV2(localParticipant,initialState,transport,peerConnectionManager,options));});transport.once('stateChanged',function stateChanged(state){if(state==='disconnected'){transport=null;reject(new TwE.SIGNALING_CONNECTION_DISCONNECTED());}});});}).then(function createRoomSignalingSucceeded(roomSignaling){if(isCanceled()){peerConnectionManager.close();roomSignaling.disconnect();reject(cancelationError);return;}resolve(roomSignaling);}).catch(function onError(error){if(transport){transport.disconnect();transport=null;}peerConnectionManager.close();reject(error);});},function onCancel(){if(transport){transport.disconnect();transport=null;}});}module.exports=createCancelableRoomSignalingPromise;},{"../../util/cancelablepromise":48,"../../util/constants":49,"./peerconnectionmanager":31,"./room":34,"./transport":37}],27:[function(require,module,exports){'use strict';var Filter=require('../../util/filter');/**
 * Construct an {@link IceBox}.
 * @class
 * @classdesc An {@link IceBox} stores trickled ICE candidates. Candidates added
 * to the {@link IceBox} via {@link IceBox#update} are compared against
 * previously trickled candidates and only new candidates will be returned
 * (assuming they match the current ICE username fragment set by
 * {@link IceBox#setUfrag}.
 * @property {?string} ufrag
 */function IceBox(){if(!(this instanceof IceBox)){return new IceBox();}Object.defineProperties(this,{_filter:{value:new Filter({getKey:function getKey(iceState){return iceState.ufrag;},isLessThanOrEqualTo:function isLessThanOrEqualTo(a,b){return a.revision<=b.revision;}})},_ufrag:{writable:true,value:null},ufrag:{enumerable:true,get:function get(){return this._ufrag;}}});}/**
 * Set the ICE username fragment on the {@link IceBox}. This method returns any
 * ICE candidates associated with the username fragment.
 * @param {string} ufrag
 * @returns {Array<RTCIceCandidateInit>}
 */IceBox.prototype.setUfrag=function setUfrag(ufrag){this._ufrag=ufrag;var ice=this._filter.toMap().get(ufrag);return ice?ice.candidates:[];};/**
 * Update the {@link IceBox}. This method returns any new ICE candidates
 * associated with the current username fragment.
 * @param {object} iceState
 * @returns {Array<RTCIceCandidateInit>}
 */IceBox.prototype.update=function update(iceState){// NOTE(mroberts): The Server sometimes does not set the candidates property.
iceState.candidates=iceState.candidates||[];var oldIceState=this._filter.toMap().get(iceState.ufrag);var oldCandidates=oldIceState?oldIceState.candidates:[];return this._filter.update(iceState)&&this._ufrag===iceState.ufrag?iceState.candidates.slice(oldCandidates.length):[];};module.exports=IceBox;},{"../../util/filter":50}],28:[function(require,module,exports){'use strict';var constants=require('../../util/constants');var defaultCreateCancelableRoomSignalingPromise=require('./cancelableroomsignalingpromise');var inherits=require('util').inherits;var LocalParticipantV2=require('./localparticipant');var Signaling=require('../');var SIP=require('../../sip');var SIPJSMediaHandler=require('./sipjsmediahandler');var util=require('../../util');/**
 * Construct {@link SignalingV2}.
 * @class
 * @classdesc {@link SignalingV2} implements version 2 of our signaling
 * protocol.
 * @extends {Signaling}
 * @param {string} wsServer
 * @param {string} accountSid
 * @param {string} identity
 * @param {?object} [options={}]
 */function SignalingV2(wsServer,accountSid,identity,options){var uri=util.makeRegistrationSIPURI(accountSid,identity);/* eslint new-cap:0 */options=Object.assign({createCancelableRoomSignalingPromise:defaultCreateCancelableRoomSignalingPromise,registrarServer:constants.REGISTRAR_SERVER(accountSid),UA:SIP.UA},options);var debug=options.logLevel==='debug';var useWssHack=wsServer.startsWith('wss://');var UA=options.UA;var ua=new UA({autostart:false,log:{builtinEnabled:debug},extraSupported:['room-signaling','timer'],hackAllowUnregisteredOptionTags:true,keepAliveInterval:30,mediaHandlerFactory:SIPJSMediaHandler.defaultFactory,register:false,registrarServer:options.registrarServer,traceSip:debug,uri:uri,wsServers:wsServer,hackWssInTransport:useWssHack});Signaling.call(this);Object.defineProperties(this,{_createCancelableRoomSignalingPromise:{value:options.createCancelableRoomSignalingPromise},_options:{value:options},_ua:{value:ua}});}inherits(SignalingV2,Signaling);SignalingV2.prototype._close=function _close(key){this.transition('closing',key);this._ua.stop();this._ua.transport.disconnect();this.transition('closed',key);return Promise.resolve(this);};SignalingV2.prototype._open=function _open(key){var self=this;function startUA(){self._ua.start();}this.transition('opening',key);return util.promiseFromEvents(startUA,this._ua,'connected','disconnected').then(function(){self.transition('open',key);return self;},function(){self.transition('closed',key);throw new Error('Open failed');});};SignalingV2.prototype._connect=function _connect(localParticipant,token,accountSid,identity,options){options=Object.assign({iceServers:constants.DEFAULT_ICE_SERVERS},this._options,options);var ua=this._ua;return this._createCancelableRoomSignalingPromise.bind(null,accountSid,token,ua,localParticipant,options);};SignalingV2.prototype.createLocalParticipantSignaling=function createLocalParticipantSignaling(){return new LocalParticipantV2();};module.exports=SignalingV2;},{"../":19,"../../sip":38,"../../util":51,"../../util/constants":49,"./cancelableroomsignalingpromise":26,"./localparticipant":29,"./sipjsmediahandler":35,"util":109}],29:[function(require,module,exports){'use strict';var getTrackState=require('./track').getState;var inherits=require('util').inherits;var ParticipantSignaling=require('../participant');/**
 * Construct a {@link LocalParticipantV2}.
 * @class
 * @extends ParticipantSignaling
 */function LocalParticipantV2(){if(!(this instanceof LocalParticipantV2)){return new LocalParticipantV2();}ParticipantSignaling.call(this);Object.defineProperties(this,{_revision:{writable:true,value:1},revision:{enumerable:true,get:function get(){return this._revision;}}});}inherits(LocalParticipantV2,ParticipantSignaling);LocalParticipantV2.prototype.update=function update(){this._revision++;return this;};LocalParticipantV2.prototype.getState=function getState(){return{revision:this.revision,tracks:Array.from(this.tracks.values()).map(getTrackState)};};module.exports=LocalParticipantV2;},{"../participant":21,"./track":36,"util":109}],30:[function(require,module,exports){'use strict';var DefaultRTCIceCandidate=require('../../webrtc/rtcicecandidate');var DefaultRTCPeerConnection=require('../../webrtc/rtcpeerconnection');var DefaultRTCSessionDescription=require('../../webrtc/rtcsessiondescription');var IceBox=require('./icebox');var inherits=require('util').inherits;var StateMachine=require('../../../lib/statemachine');var getStatistics=require('../../webrtc/getstats');var StatsReport=require('../../stats/statsreport');var TwE=require('../../util/constants').twilioErrors;var defaults={iceServers:[],offerOptions:{offerToReceiveAudio:true,offerToReceiveVideo:true},RTCIceCandidate:DefaultRTCIceCandidate,RTCPeerConnection:DefaultRTCPeerConnection,RTCSessionDescription:DefaultRTCSessionDescription};/*
PeerConnectionV2 States
-----------------------

    +------+    +--------+
    |      |    |        |
    | open |--->| closed |
    |      |    |        |
    +------+    +--------+
      |  ^          ^
      |  |          |
      |  |          |
      v  |          |
  +----------+      |
  |          |      |
  | updating |------+
  |          |
  +----------+

*/var states={open:['closed','updating'],updating:['closed','open'],closed:[]};/**
 * Construct a {@link PeerConnectionV2}.
 * @class
 * @extends StateMachine
 * @param {string} id
 * @param {object} [options]
 * @property {id}
 * @fires PeerConnectionV2#candidates
 * @fires PeerConnectionV2#description
 */function PeerConnectionV2(id,options){if(!(this instanceof PeerConnectionV2)){return new PeerConnectionV2(id,options);}StateMachine.call(this,'open',states);options=Object.assign(defaults,options);var configuration=getConfiguration(options);var RTCPeerConnection=options.RTCPeerConnection;var peerConnection=new RTCPeerConnection(configuration);Object.defineProperties(this,{_descriptionRevision:{writable:true,value:0},_localCandidates:{writable:true,value:[]},_localCandidatesRevision:{writable:true,value:1},_localDescription:{writable:true,value:null},_localUfrag:{writable:true,value:null},_offerOptions:{writable:true,value:options.offerOptions},_peerConnection:{value:peerConnection},_remoteCandidates:{writable:true,value:new IceBox()},_RTCIceCandidate:{value:options.RTCIceCandidate},_RTCPeerConnection:{value:options.RTCPeerConnection},_RTCSessionDescription:{value:options.RTCSessionDescription},id:{enumerable:true,value:id}});peerConnection.addEventListener('icecandidate',this._handleIceCandidateEvent.bind(this));peerConnection.addEventListener('signalingstatechange',this._handleSignalingStateChange.bind(this));peerConnection.addEventListener('track',this._handleTrackEvent.bind(this));}inherits(PeerConnectionV2,StateMachine);/**
 * Add an ICE candidate to the {@link PeerConnectionV2}.
 * @param {object} candidate
 * @returns {Promise<this>}
 */PeerConnectionV2.prototype._addIceCandidate=function _addIceCandidate(candidate){var RTCIceCandidate=this._RTCIceCandidate;var self=this;return new Promise(function(resolve,reject){self._peerConnection.addIceCandidate(new RTCIceCandidate(candidate),resolve,reject);}).then(function addIceCandidatesSucceeded(){return self;});};/**
 * Add ICE candidates to the {@link PeerConnectionV2}.
 * @param {Array<object>} candidates
 * @returns {Promise<this>}
 */PeerConnectionV2.prototype._addIceCandidates=function _addIceCandidates(candidates){var self=this;return Promise.all(candidates.map(this._addIceCandidate,this)).then(function addIceCandidatesSucceeded(){return self;});};/**
 * Create an answer and set it on the {@link PeerConnectionV2}.
 * @param {object} offer
 * @returns {Promise<this>}
 */PeerConnectionV2.prototype._answer=function _answer(offer){var RTCSessionDescription=this._RTCSessionDescription;var self=this;return new Promise(function(resolve,reject){var description=new RTCSessionDescription(offer);var _reject=reject.bind(null,new TwE.MEDIA_CLIENT_REMOTE_DESC_FAILED());self._peerConnection.setRemoteDescription(description,resolve,_reject);}).then(function setRemoteDescriptionSucceeded(){var ufrag=getUfrag(offer);if(ufrag){var candidates=self._remoteCandidates.setUfrag(ufrag);self._addIceCandidates(candidates);}return new Promise(function(resolve,reject){var _reject=reject.bind(null,new TwE.MEDIA_CLIENT_LOCAL_DESC_FAILED());self._peerConnection.createAnswer(resolve,_reject);});}).then(function createAnswerSucceeded(answer){return self._setLocalDescription(answer);}).then(function setLocalDescriptionSucceeded(){return self;});};/**
 * Close the underlying RTCPeerConnection. Returns false if the
 * RTCPeerConnection was already closed.
 * @returns {boolean}
 */PeerConnectionV2.prototype._close=function _close(){if(this._peerConnection.signalingState!=='closed'){this._peerConnection.close();return true;}return false;};/**
 * Handle a glare scenario on the {@link PeerConnectionV2}.
 * @param {object} offer
 * @returns {Promise<this>}
 */PeerConnectionV2.prototype._handleGlare=function _handleGlare(offer){var RTCSessionDescription=this._RTCSessionDescription;var rollback=new RTCSessionDescription({type:'rollback'});var self=this;return this._setLocalDescription(rollback).then(function setLocalDescriptionSucceeded(){return self._answer(offer);}).then(function answerSucceeded(){return self._offer();});};/**
 * Handle an ICE candidate event.
 * @param {Event} event
 * @returns {undefined}
 */PeerConnectionV2.prototype._handleIceCandidateEvent=function _handleIceCandidateEvent(event){if(event.candidate){this._localCandidates.push(event.candidate);}var peerConnectionState={ice:{candidates:this._localCandidates.slice(),revision:this._localCandidatesRevision++,ufrag:this._localUfrag},id:this.id};if(!event.candidate){peerConnectionState.ice.complete=true;}this.emit('candidates',peerConnectionState);};/**
 * Handle a signaling state change event.
 * @param {Event}
 * @returns {undefined}
 */PeerConnectionV2.prototype._handleSignalingStateChange=function _handleSignalingStateChange(){if(this._peerConnection.signalingState==='closed'&&this.state!=='closed'){this.preempt('closed');}};/**
 * Handle a track event.
 * @param {Event} event
 * @returns {undefined}
 */PeerConnectionV2.prototype._handleTrackEvent=function _handleTrackEvent(event){var mediaStreamTrack=event.track;var mediaStream=event.streams[0];this.emit('trackAdded',mediaStreamTrack,mediaStream);};/**
 * Create an offer and set it on the {@link PeerConnectionV2}.
 * @returns {Promise<this>}
 */PeerConnectionV2.prototype._offer=function _offer(){var self=this;return new Promise(function(resolve,reject){var _reject=reject.bind(null,new TwE.MEDIA_CLIENT_LOCAL_DESC_FAILED());self._peerConnection.createOffer(resolve,_reject,self._offerOptions);}).then(function createOfferSucceeded(offer){return self._setLocalDescription(offer);});};/**
 * Set a local description on the {@link PeerConnectionV2}.
 * @param {object} description
 * @returns {this}
 */PeerConnectionV2.prototype._setLocalDescription=function _setLocalDescription(description){var RTCSessionDescription=this._RTCSessionDescription;var self=this;return new Promise(function(resolve,reject){var _reject=reject.bind(null,new TwE.MEDIA_CLIENT_LOCAL_DESC_FAILED());self._peerConnection.setLocalDescription(new RTCSessionDescription(description),resolve,_reject);}).then(function setLocalDescriptionSucceeded(){if(description.type!=='rollback'){self._localDescription=description;self._localCandidates=[];if(description.type==='offer'){self._descriptionRevision++;}self._localUfrag=getUfrag(description);self.emit('description',self.getState());}return self;});};/**
 * Update the {@link PeerConnectionV2}'s description.
 * @param {object} description
 * @returns {Promise<this>}
 */PeerConnectionV2.prototype._updateDescription=function _updateDescription(description){switch(description.type){case'answer':case'pranswer':if(description.revision!==this._descriptionRevision||this._peerConnection.signalingState!=='have-local-offer'){return Promise.resolve(this);}this._descriptionRevision=description.revision;break;case'close':if(description.revision<this._descriptionRevision||description.revision===this._descriptionRevision&&this._peerConnection.signalingState!=='have-local-offer'||this._peerConnection.signalingState==='closed'){return Promise.resolve(this);}return this._close();case'create-offer':if(description.revision<=this._descriptionRevision||this._peerConnection.signalingState!=='stable'){return Promise.resolve(this);}this._descriptionRevision=description.revision;return this._offer();case'offer':if(description.revision<this._descriptionRevision||description.revision===this._descriptionRevision&&this._peerConnection.signalingState!=='have-local-offer'||this._peerConnection.signalingState==='closed'){return Promise.resolve(this);}else if(description.revision>=this._descriptionRevision&&this._peerConnection.signalingState==='have-local-offer'){this._descriptionRevision=description.revision;return this._handleGlare(description);}this._descriptionRevision=description.revision;return this._answer(description);default:// Do nothing.
}// Handle answer or pranswer.
var RTCSessionDescription=this._RTCSessionDescription;var self=this;return new Promise(function(resolve,reject){var _reject=reject.bind(null,new TwE.MEDIA_CLIENT_REMOTE_DESC_FAILED());self._peerConnection.setRemoteDescription(new RTCSessionDescription(description),resolve,_reject);}).then(function setRemoteDescriptionSucceeded(){var ufrag=getUfrag(description);if(ufrag){var candidates=self._remoteCandidates.setUfrag(ufrag);return self._addIceCandidates(candidates);}return self;});};/**
 * Update the {@link PeerConnectionV2}'s ICE candidates.
 * @param {object} iceState
 * @returns {Promise<this>}
 */PeerConnectionV2.prototype._updateIce=function _updateIce(iceState){var candidates=this._remoteCandidates.update(iceState);return this._addIceCandidates(candidates);};/**
 * Add a local MediaStream to the {@link PeerConnectionV2}.
 * @param {MediaStream} mediaStream
 * @returns {this}
 */PeerConnectionV2.prototype.addMediaStream=function addMediaStream(mediaStream){this._peerConnection.addStream(mediaStream);return this;};/**
 * Close the {@link PeerConnectionV2}.
 * @returns {this}
 */PeerConnectionV2.prototype.close=function close(){if(this._close()){this._descriptionRevision++;this._localDescription={type:'close'};this.emit('description',this.getState());}return this;};/**
 * Get remote MediaStreams on the {@link PeerConnectionV2}.
 * @returns {Array<MediaStream>}
 */PeerConnectionV2.prototype.getRemoteMediaStreams=function getRemoteMediaStreams(){return this._peerConnection.getRemoteStreams();};/**
 * Get the {@link PeerConnectionV2}'s state (specifically, its description).
 * @returns {?object}
 */PeerConnectionV2.prototype.getState=function getState(){if(!this._localDescription){return null;}var localDescription={type:this._localDescription.type,revision:this._descriptionRevision};if(this._localDescription.sdp){localDescription.sdp=this._localDescription.sdp;}return{description:localDescription,id:this.id};};/**
 * Create an offer and set it on the {@link PeerConnectionV2}.
 * @returns {Promise<this>}
 */PeerConnectionV2.prototype.offer=function offer(){var self=this;return this.bracket('offering',function transition(key){self.transition('updating',key);return self._offer().then(function offerSucceeded(){self.tryTransition('open',key);return self;},function offerFailed(error){self.tryTransition('open',key);throw error;});});};/**
 * Remove a local MediaStream from the {@link PeerConnectionV2}.
 * @param {MediaStream} mediaStream
 * @returns {this}
 */PeerConnectionV2.prototype.removeMediaStream=function removeMediaStream(mediaStream){this._peerConnection.removeStream(mediaStream);return this;};/**
 * Set the RTCConfiguration on the underlying RTCPeerConnection.
 * @returns {this}
 */PeerConnectionV2.prototype.setConfiguration=function setConfiguration(configuration){if(typeof this._peerConnection.setConfiguration==='function'){this._peerConnection.setConfiguration(getConfiguration(configuration));}return this;};/**
 * Update the {@link PeerConnectionV2}.
 * @param {object} peerConnectionState
 * @returns {Promise<this>}
 */PeerConnectionV2.prototype.update=function update(peerConnectionState){var self=this;return this.bracket('updating',function transition(key){if(self.state==='closed'){return Promise.resolve(self);}self.transition('updating',key);var updates=[];if(peerConnectionState.ice){updates.push(self._updateIce(peerConnectionState.ice));}if(peerConnectionState.description){updates.push(self._updateDescription(peerConnectionState.description));}return Promise.all(updates).then(function updatesSucceeded(){self.tryTransition('open',key);return self;},function updatesFailed(error){self.tryTransition('open',key);throw error;});});};/**
 * Get the {@link PeerConnectionV2}'s media statistics.
 * @returns {Promise.<StatsReport>}
 */PeerConnectionV2.prototype.getStats=function getStats(){var self=this;return getStatistics(this._peerConnection).then(function(statsResponse){return new StatsReport(self.id,statsResponse);});};/**
 * @event PeerConnectionV2#candidates
 * @param {object} candidates
 *//**
 * @event PeerConnectionV2#description
 * @param {object} description
 *//**
 * @event PeerConnectionV2#trackAdded
 * @param {MediaStreamTrack} mediaStreamTrack
 * @param {MediaStream} mediaStream
 */function getUfrag(description){if(description.sdp){var match=description.sdp.match(/^a=ice-ufrag:([a-zA-Z0-9+/]+)/m);if(match){return match[1];}}return null;}function getConfiguration(configuration){return Object.assign({bundlePolicy:'max-bundle',rtcpMuxPolicy:'require'},configuration);}module.exports=PeerConnectionV2;},{"../../../lib/statemachine":39,"../../stats/statsreport":46,"../../util/constants":49,"../../webrtc/getstats":58,"../../webrtc/rtcicecandidate":60,"../../webrtc/rtcpeerconnection":63,"../../webrtc/rtcsessiondescription":66,"./icebox":27,"util":109}],31:[function(require,module,exports){'use strict';var inherits=require('util').inherits;var PeerConnectionV2=require('./peerconnection');var QueueingEventEmitter=require('../../queueingeventemitter');var util=require('../../util');/**
 * Construct {@link PeerConnectionManager}.
 * @class
 * @classdesc {@link PeerConnectionManager} manages multiple
 * {@link PeerConnectionV2}s.
 * @extends {QueueingEventEmitter}
 * @emits PeerConnectionManager#candidates
 * @emits PeerConnectionManager#description
 * @emits PeerConnectionManager#trackAdded
 */function PeerConnectionManager(options){if(!(this instanceof PeerConnectionManager)){return new PeerConnectionManager(options);}QueueingEventEmitter.call(this);options=Object.assign({PeerConnectionV2:PeerConnectionV2},options);Object.defineProperties(this,{_closedPeerConnectionIds:{value:new Set()},_configuration:{writable:true,value:null},_configurationDeferred:{writable:true,value:util.defer()},_localMediaStreams:{value:new Set()},_localMediaStreamTracks:{value:new Set()},_peerConnections:{value:new Map()},_PeerConnectionV2:{value:options.PeerConnectionV2}});}inherits(PeerConnectionManager,QueueingEventEmitter);/**
 * Get the {@link PeerConnectionManager}'s configuration.
 * @returns {Promise<object>}
 */PeerConnectionManager.prototype._getConfiguration=function _getConfiguration(){return this._configurationDeferred.promise;};/**
 * Get or create a {@link PeerConnectionV2}.
 * @param {string} id
 * @param {object} [configuration]
 * @returns {PeerConnectionV2}
 */PeerConnectionManager.prototype._getOrCreate=function _getOrCreate(id,configuration){var self=this;var peerConnection=this._peerConnections.get(id);if(!peerConnection){var PeerConnectionV2=this._PeerConnectionV2;peerConnection=new PeerConnectionV2(id,configuration);this._peerConnections.set(peerConnection.id,peerConnection);peerConnection.on('candidates',this.queue.bind(this,'candidates'));peerConnection.on('description',this.queue.bind(this,'description'));peerConnection.on('trackAdded',this.queue.bind(this,'trackAdded'));peerConnection.on('stateChanged',function stateChanged(state){if(state==='closed'){peerConnection.removeListener('stateChanged',stateChanged);self._peerConnections.delete(peerConnection.id);self._closedPeerConnectionIds.add(peerConnection.id);}});this._localMediaStreams.forEach(peerConnection.addMediaStream,peerConnection);}return peerConnection;};/**
 * Add a local MediaStream to the {@link PeerConnectionManager}'s underlying
 * {@link PeerConnectionV2}s.
 * @param {MediaStream} mediaStream
 * @returns {this}
 */PeerConnectionManager.prototype.addMediaStream=function addMediaStream(mediaStream){this._localMediaStreams.add(mediaStream);mediaStream.getTracks().forEach(function(mediaStreamTrack){this._localMediaStreamTracks.add(mediaStreamTrack);},this);this._peerConnections.forEach(function(peerConnection){peerConnection.addMediaStream(mediaStream);},this);return this;};/**
 * Close all the {@link PeerConnectionV2}s in this {@link PeerConnectionManager}.
 * @returns {this}
 */PeerConnectionManager.prototype.close=function close(){this._peerConnections.forEach(function(peerConnection){peerConnection.close();});return this;};/**
 * Create a new {@link PeerConnectionV2} on this {@link PeerConnectionManager}.
 * Then, create a new offer with the newly-created {@link PeerConnectionV2}.
 * @return {Promise<this>}
 */PeerConnectionManager.prototype.createAndOffer=function createAndOffer(){var self=this;return this._getConfiguration().then(function getConfigurationSucceeded(configuration){var id;do{id=util.makeUUID();}while(self._peerConnections.has(id));return self._getOrCreate(id,configuration);}).then(function createSucceeded(peerConnection){return peerConnection.offer();}).then(function offerSucceeded(){return self;});};/**
 * Get the remote MediaStreams of all the {@link PeerConnectionV2}s.
 * @returns {Array<MediaStream>}
 */PeerConnectionManager.prototype.getRemoteMediaStreams=function getRemoteMediaStreams(){var remoteStreams=[];this._peerConnections.forEach(function(peerConnection){remoteStreams=remoteStreams.concat(peerConnection.getRemoteMediaStreams());});return remoteStreams;};/**
 * Get the states of all {@link PeerConnectionV2}s.
 * @returns {Array<object>}
 */PeerConnectionManager.prototype.getStates=function getStates(){var peerConnectionStates=[];this._peerConnections.forEach(function(peerConnection){var peerConnectionState=peerConnection.getState();if(peerConnectionState){peerConnectionStates.push(peerConnectionState);}});return peerConnectionStates;};/**
 * Remove a local MediaStream from the {@link PeerConnectionManager}'s underlying
 * {@link PeerConnectionV2}s.
 * @param {MediaStream} mediaStream
 * @returns {boolean}
 */PeerConnectionManager.prototype.removeMediaStream=function removeMediaStream(mediaStream){var result=this._localMediaStreams.delete(mediaStream);this._peerConnections.forEach(function(peerConnection){peerConnection.removeMediaStream(mediaStream);mediaStream.getTracks().forEach(function(mediaStreamTrack){this._localMediaStreamTracks.delete(mediaStreamTrack);},this);},this);return result;};/**
 * Set the {@link PeerConnectionManager}'s configuration.
 * @param {object} configuration
 * @returns {this}
 */PeerConnectionManager.prototype.setConfiguration=function setConfiguration(configuration){if(this._configuration){this._configurationDeferred=util.defer();this._peerConnections.forEach(function(peerConnection){peerConnection.setConfiguration(configuration);});}this._configuration=configuration;this._configurationDeferred.resolve(configuration);return this;};/**
 * Set the local MediaStreams on the {@link PeerConnectionManager}'s underlying
 * {@link PeerConnectionV2}s.
 * @param {Array<MediaStream>} mediaStreams
 * @returns {this}
 */PeerConnectionManager.prototype.setMediaStreams=function setMediaStreams(mediaStreams){var mediaStreamTracksBefore=new Set(this._localMediaStreamTracks.values());this._localMediaStreamTracks.clear();this._localMediaStreams.forEach(this.removeMediaStream,this);mediaStreams.forEach(this.addMediaStream,this);var mediaStreamTracksAfter=this._localMediaStreamTracks;var mediaStreamTracksChanged=false;if(mediaStreamTracksBefore.size!==mediaStreamTracksAfter.size){mediaStreamTracksChanged=true;}else{mediaStreamTracksBefore.forEach(function(mediaStreamTrack){if(!mediaStreamTracksAfter.has(mediaStreamTrack)){mediaStreamTracksChanged=true;}});}if(mediaStreamTracksChanged){this._peerConnections.forEach(function(peerConnection){peerConnection.offer();});}return this;};/**
 * Update the {@link PeerConnectionManager}.
 * @param {Array<object>} peerConnectionStates
 * @returns {Promise<this>}
 */PeerConnectionManager.prototype.update=function update(peerConnectionStates){var self=this;return this._getConfiguration().then(function getConfigurationSucceeded(configuration){return Promise.all(peerConnectionStates.map(function(peerConnectionState){if(self._closedPeerConnectionIds.has(peerConnectionState.id)){return null;}var peerConnection=self._getOrCreate(peerConnectionState.id,configuration);return peerConnection.update(peerConnectionState);}));}).then(function updatesSucceeded(){return self;});};/**
 * Get the {@link PeerConnectionManager}'s media statistics.
 * @returns {Promise.<Array<StatsReport>>}
 */PeerConnectionManager.prototype.getStats=function getStats(){var peerConnections=Array.from(this._peerConnections.values());return Promise.all(peerConnections.map(function(peerConnection){return peerConnection.getStats();}));};/**
 * @event {PeerConnectionManager#candidates}
 * @param {object} candidates
 *//**
 * @event {PeerConnectionManager#description}
 * @param {object} description
 *//**
 * @event {PeerConnectionManager#trackAdded}
 * @param {MediaStreamTrack} mediaStreamTrack
 * @param {MediaStream} mediaStream
 */module.exports=PeerConnectionManager;},{"../../queueingeventemitter":16,"../../util":51,"./peerconnection":30,"util":109}],32:[function(require,module,exports){'use strict';var inherits=require('util').inherits;var RecordingSignaling=require('../recording');/**
 * Construct a {@link RecordingV2}.
 * @class
 * @extends RecordingSignaling
 */function RecordingV2(){RecordingSignaling.call(this);Object.defineProperties(this,{_revision:{value:1,writable:true}});}inherits(RecordingV2,RecordingSignaling);/**
 * Compare the {@link RecordingV2} to a {@link RecordingV2#Representation}
 * of itself and perform any updates necessary.
 * @param {RecordingV2#Representation} recording
 * @returns {this}
 * @fires RecordingSignaling#updated
 */RecordingV2.prototype.update=function update(recording){if(recording.revision<this._revision){return this;}this._revision=recording.revision;return this.enable(recording.enabled);};/**
 * The Room Signaling Protocol (RSP) representation of a {@link RecordingV2}
 * @typedef {object} RecordingV2#Representation
 * @property {boolean} enabled
 * @property {number} revision
 */module.exports=RecordingV2;},{"../recording":22,"util":109}],33:[function(require,module,exports){'use strict';var inherits=require('util').inherits;var RemoteParticipantSignaling=require('../remoteparticipant');var TrackV2=require('./track');/**
 * Construct a {@link RemoteParticipantV2}.
 * @class
 * @extends RemoteParticipantSignaling
 * @param {object} participantState
 * @param {function(string): Promise<[MediaStreamTrack, MediaStream]>} getMediaStreamTrack
 * @property {?number} revision
 */function RemoteParticipantV2(participantState,getMediaStreamTrack,options){if(!(this instanceof RemoteParticipantV2)){return new RemoteParticipantV2(participantState,getMediaStreamTrack,options);}RemoteParticipantSignaling.call(this,participantState.sid,participantState.identity);options=Object.assign({TrackV2:TrackV2},options);Object.defineProperties(this,{_revision:{writable:true,value:null},_TrackV2:{value:options.TrackV2},_getMediaStreamTrack:{value:getMediaStreamTrack},revision:{enumerable:true,get:function get(){return this._revision;}}});return this.update(participantState);}inherits(RemoteParticipantV2,RemoteParticipantSignaling);RemoteParticipantV2.prototype._getOrCreateTrack=function _getOrCreateTrack(trackState){var TrackV2=this._TrackV2;var track=this.tracks.get(trackState.id);if(!track){track=new TrackV2(trackState);this.addTrack(track);}return track;};RemoteParticipantV2.prototype.update=function update(participantState){if(this.revision!==null&&participantState.revision<=this.revision){return this;}this._revision=participantState.revision;var tracksToKeep=new Set();participantState.tracks.forEach(function(trackState){var track=this._getOrCreateTrack(trackState);track.update(trackState);tracksToKeep.add(track);},this);this.tracks.forEach(function(track){if(!tracksToKeep.has(track)){this.removeTrack(track);}},this);if(participantState.state==='disconnected'&&this.state==='connected'){this.preempt('disconnected');}return this;};RemoteParticipantV2.prototype.addTrack=function addTrack(track){RemoteParticipantSignaling.prototype.addTrack.call(this,track);this._getMediaStreamTrack(track.id).then(function(pair){var mediaStreamTrack=pair[0];var mediaStream=pair[1];track.setMediaStreamTrack(mediaStreamTrack,mediaStream);});return this;};module.exports=RemoteParticipantV2;},{"../remoteparticipant":23,"./track":36,"util":109}],34:[function(require,module,exports){'use strict';var inherits=require('util').inherits;var RecordingV2=require('./recording');var RoomSignaling=require('../room');var RemoteParticipantV2=require('./remoteparticipant');var util=require('../../util');function RoomV2(localParticipant,initialState,transport,peerConnectionManager,options){if(!(this instanceof RoomV2)){return new RoomV2(localParticipant,initialState,transport,peerConnectionManager,options);}options=Object.assign({RecordingSignaling:RecordingV2,RemoteParticipantV2:RemoteParticipantV2},options);RoomSignaling.call(this,localParticipant,initialState.sid,initialState.name,options);Object.defineProperties(this,{_disconnectedParticipantSids:{value:new Set()},_peerConnectionManager:{value:peerConnectionManager},_RemoteParticipantV2:{value:options.RemoteParticipantV2},_transport:{value:transport},_trackIdToParticipants:{value:new Map()},_mediaStreamTrackDeferreds:{value:new Map()}});handleLocalParticipantEvents(this,localParticipant);handlePeerConnectionEvents(this,peerConnectionManager);handleTransportEvents(this,transport);this._update(initialState);}inherits(RoomV2,RoomSignaling);RoomV2.prototype._deleteMediaStreamTrackDeferred=function _deleteMediaStreamTrackDeferred(id){return this._mediaStreamTrackDeferreds.delete(id);};RoomV2.prototype._getOrCreateMediaStreamTrackDeferred=function _getOrCreateMediaStreamTrackDeferred(id){var deferred=this._mediaStreamTrackDeferreds.get(id);if(!deferred){deferred=util.defer();this._mediaStreamTrackDeferreds.set(id,deferred);}return deferred;};RoomV2.prototype._addMediaStreamTrack=function _addMediaStreamTrack(mediaStreamTrack,mediaStream){var deferred=this._getOrCreateMediaStreamTrackDeferred(mediaStreamTrack.id);deferred.resolve([mediaStreamTrack,mediaStream]);return this;};RoomV2.prototype.disconnect=function disconnect(){var didDisconnect=RoomSignaling.prototype.disconnect.call(this);if(didDisconnect){this._transport.disconnect();}return didDisconnect;};RoomV2.prototype._getMediaStreamTrack=function _getMediaStreamTrack(id){var self=this;return this._getOrCreateMediaStreamTrackDeferred(id).promise.then(function(result){self._deleteMediaStreamTrackDeferred(id);return result;});};RoomV2.prototype._getOrCreateRemoteParticipant=function _getOrCreateRemoteParticipant(participantState){var RemoteParticipantV2=this._RemoteParticipantV2;var participant=this.participants.get(participantState.sid);var self=this;if(!participant){participant=new RemoteParticipantV2(participantState,this._getMediaStreamTrack.bind(this));participant.on('stateChanged',function stateChanged(state){if(state==='disconnected'){participant.removeListener('stateChanged',stateChanged);self.participants.delete(participant.sid);self._disconnectedParticipantSids.add(participant.sid);}});this.connectParticipant(participant);}return participant;};RoomV2.prototype._getState=function _getState(){return{participant:this.localParticipant.getState()};};RoomV2.prototype._publishNewLocalParticipantState=function _publishNewLocalParticipantState(){this.localParticipant.update();this._transport.publish(this._getState());};RoomV2.prototype._publishPeerConnectionState=function _publishPeerConnectionState(peerConnectionState){/* eslint camelcase:0 */this._transport.publish(Object.assign({peer_connections:[peerConnectionState]},this._getState()));};RoomV2.prototype._update=function _update(roomState){var participantsToKeep=new Set();// TODO(mroberts): Remove me once the Server is fixed.
(roomState.participants||[]).forEach(function(participantState){if(participantState.sid===this.localParticipant.sid||this._disconnectedParticipantSids.has(participantState.sid)){return;}var participant=this._getOrCreateRemoteParticipant(participantState);participant.update(participantState);participantsToKeep.add(participant);},this);// TODO(mroberts): Remove me once the Server is fixed.
/* eslint camelcase:0 */if(roomState.peer_connections){this._peerConnectionManager.update(roomState.peer_connections);}if(roomState.recording){this.recording.update(roomState.recording);}return this;};/**
 * Get the {@link RoomV2}'s media statistics.
 * @returns {Promise.<Array<StatsReport>>}
 */RoomV2.prototype.getStats=function getStats(){return this._peerConnectionManager.getStats();};/**
 * @typedef {object} RoomV2#Representation
 * @property {string} name
 * @property {LocalParticipantV2#Representation} participant
 * @property {?Array<ParticipantV2#Representation>} participants
 * @property {?Array<PeerConnectionV2#Representation>} peer_connections
 * @property {?RecordingV2#Representation} recording
 * @property {string} sid
 */function handleLocalParticipantEvents(roomV2,localParticipant){var removeListeners=new Map();var peerConnectionManager=roomV2._peerConnectionManager;function renegotiate(){var mediaStreams=new Set();localParticipant.tracks.forEach(function(track){mediaStreams.add(track.mediaStream);});peerConnectionManager.setMediaStreams(mediaStreams);}function addListener(track){function updated(){roomV2._publishNewLocalParticipantState();}track.on('updated',updated);removeListener(track);removeListeners.set(track,track.removeListener.bind(track,'updated',updated));}function removeListener(track){var removeListener=removeListeners.get(track);if(removeListener){removeListener();}}function trackAdded(track){addListener(track);roomV2._publishNewLocalParticipantState();renegotiate();}function trackRemoved(track){removeListener(track);roomV2._publishNewLocalParticipantState();renegotiate();}localParticipant.on('trackAdded',trackAdded);localParticipant.on('trackRemoved',trackRemoved);localParticipant.tracks.forEach(addListener);roomV2.on('stateChanged',function stateChanged(state){if(state==='disconnected'){localParticipant.removeListener('trackAdded',trackAdded);localParticipant.removeListener('trackRemoved',trackRemoved);roomV2.removeListener('stateChanged',stateChanged);localParticipant.disconnect();}});}function handlePeerConnectionEvents(roomV2,peerConnectionManager){peerConnectionManager.on('description',function onDescription(description){roomV2._publishPeerConnectionState(description);});peerConnectionManager.dequeue('description');peerConnectionManager.on('candidates',function onCandidates(candidates){roomV2._publishPeerConnectionState(candidates);});peerConnectionManager.dequeue('candidates');peerConnectionManager.on('trackAdded',roomV2._addMediaStreamTrack.bind(roomV2));peerConnectionManager.dequeue('trackAdded');peerConnectionManager.getRemoteMediaStreams().forEach(function(mediaStream){mediaStream.getTracks().forEach(function(mediaStreamTrack){roomV2._addMediaStreamTrack(mediaStreamTrack,mediaStream);});});}function handleTransportEvents(roomV2,transport){transport.on('message',roomV2._update.bind(roomV2));transport.on('stateChanged',function stateChanged(state){if(state==='disconnected'){if(roomV2.state==='connected'){roomV2._handleUnexpectedDisconnect();}transport.removeListener('stateChanged',stateChanged);}});}module.exports=RoomV2;},{"../../util":51,"../room":24,"./recording":32,"./remoteparticipant":33,"util":109}],35:[function(require,module,exports){'use strict';var SIP=require('../../sip');function SIPJSMediaHandler(peerConnectionManager,createMessage){if(!(this instanceof SIPJSMediaHandler)){return new SIPJSMediaHandler(peerConnectionManager);}Object.defineProperties(this,{createMessage:{enumerable:true,value:createMessage},peerConnectionManager:{enumerable:true,value:peerConnectionManager}});}SIPJSMediaHandler.defaultFactory=function defaultFactory(){// NOTE(mroberts): We don't use SIP.js's defaultFactory functionality.
};SIPJSMediaHandler.defaultFactory.isSupported=function isSupported(){return SIP.WebRTC.isSupported();};SIPJSMediaHandler.prototype.close=function close(){this.peerConnectionManager.close();};SIPJSMediaHandler.prototype.getDescription=function getDescription(){var connectMessage=Object.assign({/* eslint camelcase:0 */peer_connections:this.peerConnectionManager.getStates()},this.createMessage());return Promise.resolve({body:JSON.stringify(connectMessage),contentType:'application/room-signaling+json'});};SIPJSMediaHandler.prototype.hasDescription=function hasDescription(){return true;};SIPJSMediaHandler.prototype.hold=function hold(){// NOTE(mroberts): We don't use SIP.js's hold functionality.
};SIPJSMediaHandler.prototype.isReady=function isReady(){// NOTE(mroberts): We don't use SIP.js's isReady functionality.
return true;};SIPJSMediaHandler.prototype.isMuted=function isMuted(){// NOTE(mroberts): We don't use SIP.js's isMuted functionality.
return{audio:false,video:false};};SIPJSMediaHandler.prototype.mute=function mute(){// NOTE(mroberts): We don't use SIP.js's mute functionality.
};SIPJSMediaHandler.prototype.render=function render(){// NOTE(mroberts): We don't use SIP.js's render functionality.
};SIPJSMediaHandler.prototype.setDescription=function setDescription(message){var roomState=getRoomState(message);if(roomState){var peerConnectionStates=roomState.peer_connections;if(peerConnectionStates){return this.peerConnectionManager.update(peerConnectionStates);}}return Promise.resolve();};SIPJSMediaHandler.prototype.unhold=function unhold(){// NOTE(mroberts): We don't use SIP.js's unhold functionality.
};SIPJSMediaHandler.prototype.unmute=function unmute(){// NOTE(mroberts): We don't use SIP.js's unmute functionality.
};SIPJSMediaHandler.prototype.updateIceServers=function updateIceServers(){// NOTE(mroberts): We don't use SIP.js's ICE server functionality.
};function getRoomState(message){try{return JSON.parse(message.body);}catch(error){return null;}}module.exports=SIPJSMediaHandler;},{"../../sip":38}],36:[function(require,module,exports){'use strict';var inherits=require('util').inherits;var TrackSignaling=require('../track');/**
 * Construct a {@link TrackV2}.
 * @class
 * @extends TrackSignaling
 * @param {TrackV2#Representation} track
 */function TrackV2(track){TrackSignaling.call(this,track.id,track.kind,track.enabled);}inherits(TrackV2,TrackSignaling);/**
 * Get the {@link TrackV2#Representation} of a given {@link TrackSignaling}.
 * @param {TrackSignaling} track
 * @returns {TrackV2#Representation}
 */TrackV2.getState=function getState(track){return{enabled:track.isEnabled,id:track.id,kind:track.kind};};/**
 * Compare the {@link TrackV2} to a {@link TrackV2#Representation} of itself
 * and perform any updates necessary.
 * @param {TrackV2#Representation} track
 * @returns {this}
 * @fires TrackSignaling#updated
 */TrackV2.prototype.update=function update(track){this.enable(track.enabled);return this;};/**
 * The Room Signaling Protocol (RSP) representation of a {@link TrackV2}
 * @typedef {object} TrackV2#Representation
 * @property {boolean} enabled
 * @property {string} id
 * @property {string} kind
 */module.exports=TrackV2;},{"../track":25,"util":109}],37:[function(require,module,exports){'use strict';var constants=require('../../util/constants');var inherits=require('util').inherits;var SIP=require('../../sip');var DefaultSIPJSMediaHandler=require('./sipjsmediahandler');var StateMachine=require('../../statemachine');var util=require('../../util');var VERSION=1;/*
Transport States
----------------

                      +-----------+
                      |           |
                      |  syncing  |---------+
                      |           |         |
                      +-----------+         |
                         ^     |            |
                         |     |            |
                         |     v            v
    +------------+    +-----------+    +--------------+
    |            |    |           |    |              |
    | connecting |--->| connected |--->| disconnected |
    |            |    |           |    |              |
    +------------+    +-----------+    +--------------+
             |                              ^
             |                              |
             |                              |
             +------------------------------+

*/var states={connecting:['connected','disconnected'],connected:['disconnected','syncing'],syncing:['connected','disconnected'],disconnected:[]};/**
 * Construct a {@link Transport}.
 * @extends StateMachine
 * @class
 * @classdesc A {@link Transport} supports sending and receiving Room Signaling
 * Protocol (RSP) messages. It also supports RSP requests, such as Sync and
 * Disconnect.
 * @param {?string} name
 * @param {string} accountSid
 * @param {string} accessToken
 * @param {ParticipantSignaling} localParticipant
 * @param {PeerConnectionManager} peerConnectionManager
 * @param {object} ua
 * @param {object} [options]
 * @emits Transport#connected
 * @emits Transport#message
 */function Transport(name,accountSid,accessToken,localParticipant,peerConnectionManager,ua,options){if(!(this instanceof Transport)){return new Transport(name,accountSid,accessToken,localParticipant,peerConnectionManager,ua,options);}options=Object.assign({SIPJSMediaHandler:DefaultSIPJSMediaHandler},options);StateMachine.call(this,'connecting',states);var session=createSession(this,name,accountSid,accessToken,localParticipant,peerConnectionManager,ua,options.SIPJSMediaHandler);Object.defineProperties(this,{_session:{value:session},_updatesReceived:{value:[]},_updatesToSend:{value:[]}});setupEventListeners(this,session,ua);}inherits(Transport,StateMachine);/**
 * Disconnect the {@link Transport}. Returns true if calling the method resulted
 * in disconnection.
 * @returns {boolean}
 */Transport.prototype.disconnect=function disconnect(){if(this.state!=='disconnected'){this.preempt('disconnected');this._session.terminate({body:JSON.stringify({type:'disconnect',version:VERSION}),extraHeaders:['Content-Type: application/room-signaling+json']});return true;}return false;};/**
 * Publish an RSP Update. Returns true if calling the method resulted in
 * publishing (or eventually publishing) the update.
 * @param {object} update
 * @returns {boolean}
 */Transport.prototype.publish=function publish(update){update=Object.assign({type:'update',version:VERSION},update);switch(this.state){case'connected':publishWithRetries(this._session,update);return true;case'connecting':case'syncing':this._updatesToSend.push(update);return true;case'disconnected':default:return false;}};/**
 * Sync the {@link Transport}. Returns true if calling the method resulted in
 * syncing.
 * @returns {boolean}
 */Transport.prototype.sync=function sync(){if(this.state==='connected'){this.preempt('syncing');this._session.sendReinvite();return true;}return false;};/**
 * @event Transport#connected
 * @param {object} initialState
 *//**
 * @event Transport#message
 * @param {object} state
 */function createSession(transport,name,accountSid,accessToken,localParticipant,peerConnectionManager,ua,SIPJSMediaHandler){var target='sip:'+util.makeSIPURI(accountSid,'orchestrator');return ua.invite(target,{extraHeaders:[constants.headers.X_TWILIO_ACCESSTOKEN+': '+accessToken,'Session-Expires: 120'],media:{stream:{}},mediaHandlerFactory:function mediaHandlerFactory(){return new SIPJSMediaHandler(peerConnectionManager,function createMessage(){if(transport.state==='disconnected'){return{type:'disconnect',version:VERSION};}var type={connecting:'connect',syncing:'sync'}[transport.state]||'update';var message={name:name,participant:localParticipant.getState(),type:type,version:VERSION};var sdpFormat=util.getSdpFormat();if(type==='connect'&&sdpFormat){message.format=sdpFormat;}return message;});},onInfo:function onInfo(request){this.emit('info',request);request.reply(200);}});}function publishWithRetries(session,payload,attempts){attempts=attempts||0;return new Promise(function(resolve,reject){function receiveResponse(response){switch(Math.floor(response.status_code/100)){case 2:resolve();break;case 5:if(attempts<constants.PUBLISH_MAX_ATTEMPTS){resolve(publishWithRetries(session,payload,++attempts));break;}break;default:reject(response);}}function sendRequest(){session.sendRequest('INFO',{body:JSON.stringify(payload),extraHeaders:['Content-Type: application/room-signaling+json','Event: room-signaling','Info-Package: room-signaling'],receiveResponse:receiveResponse});}if(attempts===0){sendRequest();return;}setTimeout(sendRequest,attempts*constants.PUBLISH_BACKOFF_MS);});}function reducePeerConnections(peerConnections){return Array.from(peerConnections.reduce(function(peerConnectionsById,update){var reduced=peerConnectionsById.get(update.id)||update;// First, reduce the top-level `description` property.
if(!reduced.description&&update.description){reduced.description=update.description;}else if(reduced.description&&update.description){if(update.description.revision>reduced.description.revision){reduced.description=update.description;}}// Then, reduce the top-level `ice` property.
if(!reduced.ice&&update.ice){reduced.ice=update.ice;}else if(reduced.ice&&update.ice){if(update.ice.revision>reduced.ice.revision){reduced.ice=update.ice;}}// Finally, update the map.
peerConnectionsById.set(reduced.id,reduced);return peerConnectionsById;},new Map()).values());}function reduceUpdates(updates){return updates.reduce(function(reduced,update){// First, reduce the top-level `participant` property.
if(!reduced.participant&&update.participant){reduced.participant=update.participant;}else if(reduced.participant&&update.participant){if(update.participant.revision>reduced.participant.revision){reduced.participant=update.participant;}}// Then, reduce the top-level `peer_connections` property.
/* eslint camelcase:0 */if(!reduced.peer_connections&&update.peer_connections){reduced.peer_connections=reducePeerConnections(update.peer_connections);}else if(reduced.peer_connections&&update.peer_connections){reduced.peer_connections=reducePeerConnections(reduced.peer_connections.concat(update.peer_connections));}return reduced;},{type:'update',version:VERSION});}function setupEventListeners(transport,session,ua){function disconnect(){transport.disconnect();}function handleRequestOrResponse(requestOrResponse){if(requestOrResponse instanceof SIP.OutgoingRequest){return;}var message;try{message=JSON.parse(requestOrResponse.body);}catch(error){return;}switch(transport.state){case'connected':switch(message.type){case'connected':case'synced':case'update':transport.emit('message',message);return;case'error':case'disconnected':transport.disconnect();return;default:// Do nothing.
return;}case'connecting':switch(message.type){case'connected':transport.emit('connected',message);transport.preempt('connected');return;case'synced':case'update':transport._updatesReceived.push(message);return;case'error':case'disconnected':transport.disconnect();return;default:// Do nothing.
return;}case'disconnected':// Do nothing.
return;case'syncing':switch(message.type){case'connected':case'update':transport._updatesReceived.push(message);return;case'synced':transport.emit('message',message);transport.preempt('connected');return;case'disconnected':case'error':transport.disconnect();return;default:// Do nothing.
return;}default:// Impossible
return;}}session.on('info',handleRequestOrResponse);session.once('bye',disconnect);session.once('accepted',handleRequestOrResponse);session.once('failed',disconnect);transport.on('stateChanged',function stateChanged(state){switch(state){case'connected':session.removeListener('accepted',handleRequestOrResponse);session.removeListener('failed',disconnect);var updates=transport._updatesToSend.splice(0);if(updates.length){transport.publish(reduceUpdates(updates));}transport._updatesReceived.splice(0).forEach(transport.emit.bind(transport,'message'));return;case'disconnected':session.removeListener('accepted',handleRequestOrResponse);session.removeListener('failed',disconnect);session.removeListener('info',handleRequestOrResponse);session.removeListener('bye',disconnect);transport.removeListener('stateChanged',stateChanged);return;case'syncing':// Do nothing.
return;default:// Impossible
return;}});ua.once('disconnected',disconnect);}module.exports=Transport;},{"../../sip":38,"../../statemachine":39,"../../util":51,"../../util/constants":49,"./sipjsmediahandler":35,"util":109}],38:[function(require,module,exports){(function(global){'use strict';var toplevel=global.window||global;var Transport=require('sip.js/src/Transport');var WebSocket=toplevel.WebSocket?toplevel.WebSocket:require('ws');var addEventListener=toplevel.addEventListener?toplevel.addEventListener.bind(toplevel):null;module.exports=require('sip.js/src/SIP')({addEventListener:addEventListener,console:toplevel.console,Promise:toplevel.Promise,WebSocket:WebSocket,timers:toplevel,Transport:Transport});}).call(this,typeof global!=="undefined"?global:typeof self!=="undefined"?self:typeof window!=="undefined"?window:{});},{"sip.js/src/SIP":91,"sip.js/src/Transport":100,"ws":111}],39:[function(require,module,exports){'use strict';var EventEmitter=require('events').EventEmitter;var inherits=require('util').inherits;var util=require('./util');/**
 * Construct a {@link StateMachine}.
 * @class
 * @classdesc {@link StateMachine} represents a state machine. The state
 * machine supports a reentrant locking mechanism to allow asynchronous state
 * transitions to ensure they have not been preempted. Calls to
 * {@link StateMachine#takeLock} are guaranteed to be resolved in FIFO order.
 * @extends {EventEmitter}
 * @param {string} initialState - the intiial state
 * @param {object} states
 * @property {boolean} isLocked - whether or not the {@link StateMachine} is
 * locked performing asynchronous state transition
 * @property {string} state - the current state
 * @emits {@link StateMachine#stateChanged}
 */function StateMachine(initialState,states){EventEmitter.call(this);var lock=null;var state=initialState;states=transformStates(states);Object.defineProperties(this,{_lock:{get:function get(){return lock;},set:function set(_lock){lock=_lock;}},_reachableStates:{value:reachable(states)},_state:{get:function get(){return state;},set:function set(_state){state=_state;}},_states:{value:states},isLocked:{enumerable:true,get:function get(){return lock!==null;}},state:{enumerable:true,get:function get(){return state;}}});}inherits(StateMachine,EventEmitter);/**
 * This method takes a lock and passes the {@link StateMachine#Key} to your
 * transition function. You may perform zero or more state transitions in your
 * transition function, but you should check for preemption in each tick. You
 * may also reenter the lock. Once the Promise returned by your transition
 * function resolves or rejects, this method releases the lock it acquired for
 * you.
 * @param {string} name - a name for the lock
 * @param {function(StateMachine#Key): Promise} transitionFunction
 * @returns {Promise}
 */// NOTE(mroberts): This method is named after a Haskell function:
// https://hackage.haskell.org/package/base-4.8.2.0/docs/Control-Exception.html#v:bracket
StateMachine.prototype.bracket=function bracket(name,transitionFunction){var key;var self=this;function releaseLock(error){if(self.hasLock(key)){self.releaseLockCompletely(key);}if(error){throw error;}}return this.takeLock(name).then(function gotKey(_key){key=_key;return transitionFunction(key);}).then(function success(result){releaseLock();return result;},releaseLock);};/**
 * Check whether or not a {@link StateMachine#Key} matches the lock.
 * @param {StateMachine#Key} key
 * @returns {boolean}
 */StateMachine.prototype.hasLock=function hasLock(key){return this._lock===key;};/**
 * Preempt any pending state transitions and immediately transition to the new
 * state. If a lock name is specified, take the lock and return the
 * {@link StateMachine#Key}.
 * @param {string} newState
 * @param {?string} [name=null] - a name for the lock
 * @returns {?StateMachine#Key}
 */StateMachine.prototype.preempt=function preempt(newState,name){// 1. Check that the new state is valid.
if(!isValidTransition(this._states,this.state,newState)){throw new Error('Cannot transition from "'+this.state+'" to "'+newState+'"');}// 2. Release the old lock, if any.
var oldLock;if(this.isLocked){oldLock=this._lock;this._lock=null;}// 3. Take the lock, if requested.
var error;var key=null;if(name===null||typeof name==='undefined'){if(oldLock){error=new Error(oldLock.name+' was preempted');}}else{if(oldLock){error=new Error(oldLock.name+' was preempted by '+name);}key=this.takeLockSync(name);}// 4. If a lock wasn't requested, take a "preemption" lock in order to
// maintain FIFO order of those taking locks.
var preemptionKey=key?null:this.takeLockSync('preemption');// 5. Transition.
this.transition(newState,key||preemptionKey);// 6. Preempt anyone blocked on the old lock.
if(oldLock){oldLock.reject(error);}// 7. Release the "preemption" lock, if we took it.
if(preemptionKey){this.releaseLock(preemptionKey);}return key;};/**
 * Release a lock. This method succeeds only if the {@link StateMachine} is
 * still locked and has not been preempted.
 * @param {StateMachine#Key} key
 * @throws Error
 */StateMachine.prototype.releaseLock=function releaseLock(key){if(!this.isLocked){throw new Error('Could not release the lock for '+key.name+' because the StateMachine is not locked');}else if(!this.hasLock(key)){throw new Error('Could not release the lock for '+key.name+' because '+this._lock.name+' has the lock');}if(key.depth===0){this._lock=null;key.resolve();}else{key.depth--;}};/**
 * Release a lock completely, even if it has been reentered. This method
 * succeeds only if the {@link StateMachine} is still locked and has not been
 * preempted.
 * @param {StateMachine#Key} key
 * @throws Error
 */StateMachine.prototype.releaseLockCompletely=function releaseLockCompletely(key){if(!this.isLocked){throw new Error('Could not release the lock for '+key.name+' because the StateMachine is not locked');}else if(!this.hasLock(key)){throw new Error('Could not release the lock for '+key.name+' because '+this._lock.name+' has the lock');}key.depth=0;this._lock=null;key.resolve();};/**
 * Take a lock, returning a Promise for the {@link StateMachine#Key}. You should
 * take a lock anytime you intend to perform asynchronous transitions. Calls to
 * this method are guaranteed to be resolved in FIFO order. You may reenter
 * a lock by passing its {@link StateMachine#Key}.
 * @param {string|StateMachine#Key} nameOrKey - a name for the lock or an
 * existing {@link StateMachine#Key}
 * @returns {Promise<object>}
 */StateMachine.prototype.takeLock=function takeLock(nameOrKey){// Reentrant lock
if((typeof nameOrKey==="undefined"?"undefined":_typeof(nameOrKey))==='object'){var key=nameOrKey;var self=this;return new Promise(function takeReentrantLock(resolve){resolve(self.takeLockSync(key));});}// New lock
var name=nameOrKey;if(this.isLocked){var takeLock=this.takeLock.bind(this,name);return this._lock.promise.then(takeLock,takeLock);}return Promise.resolve(this.takeLockSync(name));};/**
 * Take a lock, returning the {@Link StateMachine#Key}. This method throws if
 * the {@link StateMachine} is locked or the wrong {@link StateMachine#Key} is
 * provided. You may reenter a lock by passing its {@link StateMachine#Key}.
 * @param {string|StateMachine#Key} nameOrKey - a name for the lock or an
 * existing {@link StateMachine#Key}
 * @returns {object}
 * @throws Error
 */StateMachine.prototype.takeLockSync=function takeLockSync(nameOrKey){var key=typeof nameOrKey==='string'?null:nameOrKey;var name=key?key.name:nameOrKey;if(key&&!this.hasLock(key)||!key&&this.isLocked){throw new Error('Could not take the lock for '+name+' '+'because the lock for '+this._lock.name+' was not released');}// Reentrant lock
if(key){key.depth++;return key;}// New lock
var lock=makeLock(name);this._lock=lock;return lock;};/**
 * Transition to a new state. If the {@link StateMachine} is locked, you must
 * provide the {@link StateMachine#Key}. An invalid state or the wrong
 * {@link StateMachine#Key} will throw an error.
 * @param {string} newState
 * @param {?StateMachine#Key} [key=null]
 * @throws {Error}
 */StateMachine.prototype.transition=function transition(newState,key){// 1. If we're locked, required the key.
if(this.isLocked){if(!key){throw new Error('You must provide the key in order to '+'transition');}else if(!this.hasLock(key)){throw new Error('Could not transition using the key for '+key.name+' because '+this._lock.name+' has the lock');}}else if(key){throw new Error('Key provided for '+key.name+', but the '+'StateMachine was not locked (possibly due to preemption)');}// 2. Check that the new state is valid.
if(!isValidTransition(this._states,this.state,newState)){throw new Error('Cannot transition from "'+this.state+'" to "'+newState+'"');}// 3. Update the state and emit an event.
this._state=newState;this.emit('stateChanged',newState);};/**
 * Attempt to transition to a new state. Unlike {@link StateMachine#transition},
 * this method does not throw.
 * @param {string} newState
 * @param {?StateMachine#Key} [key=null]
 * @returns {boolean}
 */StateMachine.prototype.tryTransition=function tryTransition(newState,key){try{this.transition(newState,key);}catch(error){return false;}return true;};/**
 * Return a Promise that resolves when the {@link StateMachine} transitions to
 * the specified state. If the {@link StateMachine} transitions such that the
 * requested state becomes unreachable, the Promise rejects.
 * @param {string} state
 * @returns {Promise<this>}
 */StateMachine.prototype.when=function when(state){var self=this;if(this.state===state){return Promise.resolve(this);}else if(!isValidTransition(this._reachableStates,this.state,state)){return Promise.reject(createUnreachableError(this.state,state));}return new Promise(function whenPromise(resolve,reject){self.on('stateChanged',function stateChanged(newState){if(newState===state){self.removeListener('stateChanged',stateChanged);resolve(self);}else if(!isValidTransition(self._reachableStates,newState,state)){self.removeListener('stateChanged',stateChanged);reject(createUnreachableError(newState,state));}});});};/**
 * @event StateMachine#stateChanged
 * @param {string} newState
 *//**
 * Check if a transition is valid.
 * @private
 * @param {Map<*, Set<*>>} graph
 * @param {*} from
 * @param {*} to
 * @returns {boolean}
 */function isValidTransition(graph,from,to){return graph.get(from).has(to);}/**
 * @typedef {object} StateMachine#Key
 */function makeLock(name){var lock=util.defer();lock.name=name;lock.depth=0;return lock;}/**
 * Compute the transitive closure of a graph (i.e. what nodes are reachable from
 * where).
 * @private
 * @param {Map<*, Set<*>>} graph
 * @returns {Map<*, Set<*>>}
 */function reachable(graph){return Array.from(graph.keys()).reduce(function(newGraph,from){return newGraph.set(from,reachableFrom(graph,from));},new Map());}/**
 * Compute the Set of node reachable from a particular node in the graph.
 * @private
 * @param {Map<*, Set<*>>} graph
 * @param {*} from
 * @param {Set<*>} [to]
 * @returns {Set<*>}
 */function reachableFrom(graph,from,to){to=to||new Set();graph.get(from).forEach(function(node){if(!to.has(node)){to.add(node);reachableFrom(graph,node,to).forEach(to.add,to);}});return to;}function transformStates(states){var newStates=new Map();for(var key in states){newStates.set(key,new Set(states[key]));}return newStates;}/**
 * Create an "unreachable state" Error.
 * @param {string} here
 * @param {string} there
 * @returns {Error}
 */function createUnreachableError(here,there){return new Error('"'+there+'" cannot be reached from "'+here+'"');}module.exports=StateMachine;},{"./util":51,"events":70,"util":109}],40:[function(require,module,exports){'use strict';var inherits=require('util').inherits;var LocalTrackStats=require('./localtrackstats');/**
 * Statistics for a {@link LocalAudioTrack}.
 * @extends LocalTrackStats
 * @property {?AudioLevel} audioLevel - Input {@link AudioLevel}
 * @property {?number} jitter - Audio jitter in milliseconds
 * @param {string} trackId - {@link LocalAudioTrack} ID
 * @param {StandardizedTrackStatsReport} statsReport
 * @constructor
 */function LocalAudioTrackStats(trackId,statsReport){LocalTrackStats.call(this,trackId,statsReport);Object.defineProperties(this,{audioLevel:{value:typeof statsReport.audioInputLevel==='number'?statsReport.audioInputLevel:null,enumerable:true},jitter:{value:typeof statsReport.jitter==='number'?statsReport.jitter:null,enumerable:true}});}inherits(LocalAudioTrackStats,LocalTrackStats);/**
 * The maximum absolute amplitude of a set of audio samples in the
 * range of 0 to 32767 inclusive.
 * @typedef {number} AudioLevel
 */module.exports=LocalAudioTrackStats;},{"./localtrackstats":41,"util":109}],41:[function(require,module,exports){'use strict';var inherits=require('util').inherits;var TrackStats=require('./trackstats');/**
 * Statistics for a {@link LocalTrack}.
 * @extends TrackStats
 * @property {string} direction - 'sending'
 * @property {?number} bytesSent - Number of bytes sent
 * @property {?number} packetsSent - Number of packets sent
 * @property {?number} roundTripTime - Round trip time in milliseconds
 * @param {string} trackId - {@link LocalTrack} ID
 * @param {StandardizedTrackStatsReport} statsReport
 * @constructor
 */function LocalTrackStats(trackId,statsReport){TrackStats.call(this,trackId,statsReport);Object.defineProperties(this,{direction:{value:'sending',enumerable:true},bytesSent:{value:typeof statsReport.bytesSent==='number'?statsReport.bytesSent:null,enumerable:true},packetsSent:{value:typeof statsReport.packetsSent==='number'?statsReport.packetsSent:null,enumerable:true},roundTripTime:{value:typeof statsReport.roundTripTime==='number'?statsReport.roundTripTime:null,enumerable:true}});}inherits(LocalTrackStats,TrackStats);module.exports=LocalTrackStats;},{"./trackstats":47,"util":109}],42:[function(require,module,exports){'use strict';var inherits=require('util').inherits;var LocalTrackStats=require('./localtrackstats');/**
 * Statistics for a {@link LocalVideoTrack}.
 * @extends LocalTrackStats
 * @property {?VideoTrack#Dimensions} captureDimensions - Video capture resolution
 * @property {?VideoTrack#Dimensions} dimensions - Video encoding resolution
 * @property {?number} captureFrameRate - Video capture frame rate
 * @property {?number} frameRate - Video encoding frame rate
 * @param {string} trackId - {@link LocalVideoTrack} ID
 * @param {StandardizedTrackStatsReport} statsReport
 * @constructor
 */function LocalVideoTrackStats(trackId,statsReport){LocalTrackStats.call(this,trackId,statsReport);var captureDimensions=null;if(typeof statsReport.frameWidthInput==='number'&&typeof statsReport.frameHeightInput==='number'){captureDimensions={};Object.defineProperties(captureDimensions,{width:{value:statsReport.frameWidthInput,enumerable:true},height:{value:statsReport.frameHeightInput,enumerable:true}});}var dimensions=null;if(typeof statsReport.frameWidthSent==='number'&&typeof statsReport.frameHeightSent==='number'){dimensions={};Object.defineProperties(dimensions,{width:{value:statsReport.frameWidthSent,enumerable:true},height:{value:statsReport.frameHeightSent,enumerable:true}});}Object.defineProperties(this,{captureDimensions:{value:captureDimensions,enumerable:true},dimensions:{value:dimensions,enumerable:true},captureFrameRate:{value:typeof statsReport.frameRateInput==='number'?statsReport.frameRateInput:null,enumerable:true},frameRate:{value:typeof statsReport.frameRateSent==='number'?statsReport.frameRateSent:null,enumerable:true}});}inherits(LocalVideoTrackStats,LocalTrackStats);module.exports=LocalVideoTrackStats;},{"./localtrackstats":41,"util":109}],43:[function(require,module,exports){'use strict';var inherits=require('util').inherits;var RemoteTrackStats=require('./remotetrackstats');/**
 * Statistics for an {@link AudioTrack}.
 * @extends RemoteTrackStats
 * @property {?AudioLevel} audioLevel - Output {@link AudioLevel}
 * @property {?number} jitter - Audio jitter in milliseconds
 * @param {string} trackId - {@link AudioTrack} ID
 * @param {StandardizedTrackStatsReport} statsReport
 * @constructor
 */function RemoteAudioTrackStats(trackId,statsReport){RemoteTrackStats.call(this,trackId,statsReport);Object.defineProperties(this,{audioLevel:{value:typeof statsReport.audioOutputLevel==='number'?statsReport.audioOutputLevel:null,enumerable:true},jitter:{value:typeof statsReport.jitter==='number'?statsReport.jitter:null,enumerable:true}});}inherits(RemoteAudioTrackStats,RemoteTrackStats);module.exports=RemoteAudioTrackStats;},{"./remotetrackstats":44,"util":109}],44:[function(require,module,exports){'use strict';var inherits=require('util').inherits;var TrackStats=require('./trackstats');/**
 * Statistics for a remote {@link Track}.
 * @extends TrackStats
 * @property {string} direction - 'receiving'
 * @property {?number} bytesReceived - Number of bytes received
 * @property {?number} packetsReceived - Number of packets received
 * @param {string} trackId - {@link Track} ID
 * @param {StandardizedTrackStatsReport} statsReport
 * @constructor
 */function RemoteTrackStats(trackId,statsReport){TrackStats.call(this,trackId,statsReport);Object.defineProperties(this,{direction:{value:'receiving',enumerable:true},bytesReceived:{value:typeof statsReport.bytesReceived==='number'?statsReport.bytesReceived:null,enumerable:true},packetsReceived:{value:typeof statsReport.packetsReceived==='number'?statsReport.packetsReceived:null,enumerable:true}});}inherits(RemoteTrackStats,TrackStats);module.exports=RemoteTrackStats;},{"./trackstats":47,"util":109}],45:[function(require,module,exports){'use strict';var inherits=require('util').inherits;var RemoteTrackStats=require('./remotetrackstats');/**
 * Statistics for a {@link VideoTrack}.
 * @extends RemoteTrackStats
 * @property {?VideoTrack#Dimensions} dimensions - Received video resolution
 * @property {?number} frameRate - Received video frame rate
 * @param {string} trackId - {@link VideoTrack} ID
 * @param {StandardizedTrackStatsReport} statsReport
 * @constructor
 */function RemoteVideoTrackStats(trackId,statsReport){RemoteTrackStats.call(this,trackId,statsReport);var dimensions=null;if(typeof statsReport.frameWidthReceived==='number'&&typeof statsReport.frameHeightReceived==='number'){dimensions={};Object.defineProperties(dimensions,{width:{value:statsReport.frameWidthReceived,enumerable:true},height:{value:statsReport.frameHeightReceived,enumerable:true}});}Object.defineProperties(this,{dimensions:{value:dimensions,enumerable:true},frameRate:{value:typeof statsReport.frameRateReceived==='number'?statsReport.frameRateReceived:null,enumerable:true}});}inherits(RemoteVideoTrackStats,RemoteTrackStats);module.exports=RemoteVideoTrackStats;},{"./remotetrackstats":44,"util":109}],46:[function(require,module,exports){'use strict';var LocalAudioTrackStats=require('./localaudiotrackstats');var LocalVideoTrackStats=require('./localvideotrackstats');var RemoteAudioTrackStats=require('./remoteaudiotrackstats');var RemoteVideoTrackStats=require('./remotevideotrackstats');/**
 * Statistics report for an RTCPeerConnection.
 * @property {Array<LocalAudioTrackStats>} localAudioTrackStats - List of {@link LocalAudioTrackStats}
 * @property {Array<LocalVideoTrackStats>} localVideoTrackStats - List of {@link LocalVideoTrackStats}
 * @property {Array<RemoteAudioTrackStats>} remoteAudioTrackStats - List of {@link RemoteAudioTrackStats}
 * @property {Array<RemoteVideoTrackStats>} remoteVideoTrackStats - List of {@link RemoteVideoTrackStats}
 * @param {string} peerConnectionId - RTCPeerConnection ID
 * @param {StandardizedStatsResponse} statsResponse
 * @constructor
 */function StatsReport(peerConnectionId,statsResponse){if(typeof peerConnectionId!=='string'){throw new Error('RTCPeerConnection id must be a string');}Object.defineProperties(this,{peerConnectionId:{value:peerConnectionId,enumerable:true},localAudioTrackStats:{value:statsResponse.localAudioTrackStats.map(function(report){return new LocalAudioTrackStats(report.trackId,report);}),enumerable:true},localVideoTrackStats:{value:statsResponse.localVideoTrackStats.map(function(report){return new LocalVideoTrackStats(report.trackId,report);}),enumerable:true},remoteAudioTrackStats:{value:statsResponse.remoteAudioTrackStats.map(function(report){return new RemoteAudioTrackStats(report.trackId,report);}),enumerable:true},remoteVideoTrackStats:{value:statsResponse.remoteVideoTrackStats.map(function(report){return new RemoteVideoTrackStats(report.trackId,report);}),enumerable:true}});}module.exports=StatsReport;},{"./localaudiotrackstats":40,"./localvideotrackstats":42,"./remoteaudiotrackstats":43,"./remotevideotrackstats":45}],47:[function(require,module,exports){'use strict';/**
 * Statistics for a {@link Track}.
 * @property {string} trackId - MediaStreamTrack ID
 * @property {number} timestamp - The Unix timestamp in milliseconds
 * @property {string} ssrc - SSRC of the MediaStreamTrack
 * @property {?number} packetsLost - Then number of packets lost
 * @property {?string} codec - Name of the codec used to encode the MediaStreamTrack's media
 * @param {string} trackId - {@link Track} ID
 * @param {StandardizedTrackStatsReport} statsReport
 * @constructor
 */function TrackStats(trackId,statsReport){if(typeof trackId!=='string'){throw new Error('Track id must be a string');}Object.defineProperties(this,{trackId:{value:trackId,enumerable:true},timestamp:{value:statsReport.timestamp,enumerable:true},ssrc:{value:statsReport.ssrc,enumerable:true},packetsLost:{value:typeof statsReport.packetsLost==='number'?statsReport.packetsLost:null,enumerable:true},codec:{value:typeof statsReport.codecName==='string'?statsReport.codecName:null,enumerable:true}});}module.exports=TrackStats;},{}],48:[function(require,module,exports){'use strict';/**
 * Construct a new {@link CancelablePromise}.
 * @class
 * @classdesc A Promise that can be canceled with {@link CancelablePromise#cancel}.
 * @extends Promise
 * @param {CancelablePromise.OnCreate} onCreate
 * @param {CancelablePromise.OnCancel} onCancel
*//**
 * A function to be called on {@link CancelablePromise} creation
 * @typedef {function} CancelablePromise.OnCreate
 * @param {function(*)} resolve
 * @param {function(*)} reject
 * @param {function(): boolean} isCanceled
*//**
 * A function to be called when {@link CancelablePromise#cancel} is called
 * @typedef {function} CancelablePromise.OnCancel
 */function CancelablePromise(onCreate,onCancel){var self=this;/* istanbul ignore next */Object.defineProperties(this,{_isCancelable:{writable:true,value:true},_isCanceled:{writable:true,value:false},_onCancel:{value:onCancel}});Object.defineProperty(this,'_promise',{value:new Promise(function(resolve,reject){onCreate(function _resolve(value){self._isCancelable=false;resolve(value);},function _reject(reason){self._isCancelable=false;reject(reason);},function isCanceled(){return self._isCanceled;});})});}/**
 * Attempt to cancel the {@link CancelablePromise}.
 * @returns {this}
 */CancelablePromise.prototype.cancel=function cancel(){if(this._isCancelable){this._isCanceled=true;this._onCancel();}return this;};CancelablePromise.prototype.catch=function _catch(){return this._promise.catch.apply(this._promise,arguments);};CancelablePromise.prototype.then=function then(){return this._promise.then.apply(this._promise,arguments);};module.exports=CancelablePromise;},{}],49:[function(require,module,exports){'use strict';module.exports.DEFAULT_ENVIRONMENT='prod';module.exports.DEFAULT_REALM='us1';module.exports.DEFAULT_LOG_LEVEL='warn';module.exports.REGISTRAR_SERVER=function(accountSid){return accountSid+'.endpoint.twilio.com';};module.exports.WS_SERVER=function(environment,realm,accountSid){switch(environment){case'prod':switch(realm){case'us1':return'wss://'+accountSid+'.endpoint.twilio.com';default:return'wss://'+accountSid+'.endpoint.'+realm+'.twilio.com';}default:return'wss://'+accountSid+'.endpoint.'+environment+'-'+realm+'.twilio.com';}};module.exports.ECS_SERVER=function(environment,realm){switch(environment){case'prod':return'https://ecs.'+realm+'.twilio.com';default:return'https://ecs.'+environment+'-'+realm+'.twilio.com';}};module.exports.ECS_TIMEOUT=60;module.exports.PUBLISH_MAX_ATTEMPTS=5;module.exports.PUBLISH_BACKOFF_MS=10;module.exports.ICE_SERVERS_TIMEOUT_MS=3000;module.exports.ICE_SERVERS_DEFAULT_TTL=3600;module.exports.DEFAULT_ICE_SERVERS=function(environment){switch(environment){case'prod':return[{urls:'stun:global.stun.twilio.com:3478?transport=udp'}];default:return[{urls:'stun:global.stun.'+environment+'.twilio.com:3478?transport=udp'}];}};// Headers
/* eslint key-spacing:0 */module.exports.headers={X_TWILIO_ACCESSTOKEN:'X-Twilio-AccessToken',X_TWILIO_PARTICIPANTS:'X-Twilio-Participants',X_TWILIO_PARTICIPANTSID:'X-Twilio-ParticipantSid'};var TwilioError=require('./twilioerror');var BASE_ERROR_CODES={SIGNALING:53000,ROOM:53100,PARTICIPANT:53200,TRACK:53300,MEDIA:53400,CONFIGURATION:53500};module.exports.twilioErrors=[{category:'SIGNALING',errors:['CONNECTION_ERROR','CONNECTION_DISCONNECTED','CONNECTION_TIMEOUT','INVALID_MESSAGE_RECEIVED','INVALID_MESSAGE_SENT'],messages:['Signaling connection error','Signaling connection disconnected','Signaling connection timed out','Client received an invalid signaling message','Client sent an invalid signaling message']},{category:'ROOM',errors:['INVALID_NAME','NAME_TOO_LONG','INVALID_NAME_CHARS','CREATE_FAILED','CONNECT_FAILED','TOO_MANY_PARTICIPANTS'],messages:['Room name is invalid','Room name is too long','Room name contains invalid characters','Unable to create Room','Unable to connect to Room','Room contains too many Participants']},{category:'PARTICIPANT',errors:['INVALID_IDENTITY','IDENTITY_TOO_LONG','INVALID_IDENTITY_CHARS','TOO_MANY_TRACKS'],messages:['Participant identity is invalid','Participant identity is too long','Participant identity contains invalid characters','Participant has too many Tracks']},{category:'TRACK',errors:['INVALID','INVALID_NAME','NAME_TOO_LONG','INVALID_NAME_CHARS'],messages:['Track is invalid','Track name is invalid','Track name is too long','Track name contains invalid characters']},{category:'MEDIA',errors:['CLIENT_LOCAL_DESC_FAILED','SERVER_LOCAL_DESC_FAILED','CLIENT_REMOTE_DESC_FAILED','SERVER_REMOTE_DESC_FAILED','NO_SUPPORTED_CODEC'],messages:['Client is unable to create or apply a local media description','Server is unable to create or apply a local media description','Client is unable to apply a remote media description','Server is unable to apply a remote media description','No supported codec']},{category:'CONFIGURATION',errors:['ACQUIRE_FAILED','ACQUIRE_TURN_FAILED'],messages:['Unable to acquire configuration','Unable to acquire TURN credentials']}].reduce(function(errors,data){data.errors.forEach(function(name,i){errors[data.category+'_'+name]=TwilioError.bind(null,BASE_ERROR_CODES[data.category]+i,data.messages[i]);});return errors;},{INVALID_ACCESSTOKEN:TwilioError.bind(null,20101)});/**
 * Returns the appropriate indefinite article ("a" | "an").
 * @param {string} word - The word which determines whether "a" | "an" is returned
 * @returns {string} "a" if word's first letter is a vowel, "an" otherwise
 */function article(word){// NOTE(mmalavalli): This will not be accurate for words like "hour",
// which have consonants as their first character, but are pronounced like
// vowels. We can address this issue if the need arises.
return['a','e','i','o','u'].indexOf(word.toLowerCase()[0])>=0?'an':'a';}module.exports.typeErrors={INVALID_TYPE:function INVALID_TYPE(name,type){return new TypeError(name+' must be '+article(type)+' '+type);},INVALID_VALUE:function INVALID_VALUE(name,values){return new RangeError(name+' must be one of ',values.join(', '));},REQUIRED_ARGUMENT:function REQUIRED_ARGUMENT(name){return new TypeError(name+' must be specified');}};},{"./twilioerror":57}],50:[function(require,module,exports){'use strict';function Filter(options){if(!(this instanceof Filter)){return new Filter(options);}options=Object.assign({getKey:function defaultGetKey(a){return a;},getValue:function defaultGetValue(a){return a;},isLessThanOrEqualTo:function defaultIsLessThanOrEqualTo(a,b){return a<=b;}},options);Object.defineProperties(this,{_getKey:{value:options.getKey},_getValue:{value:options.getValue},_isLessThanOrEqualTo:{value:options.isLessThanOrEqualTo},_map:{value:new Map()}});}Filter.prototype.toMap=function toMap(){return new Map(this._map);};Filter.prototype.updateAndFilter=function filter(entries){return entries.filter(this.update,this);};Filter.prototype.update=function update(entry){var key=this._getKey(entry);var value=this._getValue(entry);if(this._map.has(key)&&this._isLessThanOrEqualTo(value,this._map.get(key))){return false;}this._map.set(key,value);return true;};module.exports=Filter;},{}],51:[function(require,module,exports){/* globals mozRTCPeerConnection */'use strict';var constants=require('./constants');var map=require('./map');var token=require('./token');/**
 * Construct the SIP URI for a client of a particular account.
 * @param {string} accountSid - the Account SID
 * @param {string} clientName - the client name
 * @returns {string}
 */function makeSIPURI(accountSid,clientName){/* eslint new-cap:0 */return encodeURIComponent(clientName)+'@'+constants.REGISTRAR_SERVER(accountSid);}// TODO(mroberts): Remove this as soon as the following is fixed:
// https://github.com/onsip/SIP.js/issues/286
/**
 * Construct the SIP URI for a client of a particular account specifically for
 * use with registration (this works around a SIP.js bug).
 * @param {string} accountSid - the Account SID
 * @param {string} clientName - the client name
 * @returns {string}
 */function makeRegistrationSIPURI(accountSid,clientName){/* eslint new-cap:0 */return makeSIPURI(accountSid,encodeURIComponent(clientName));}/**
 * Get the decoded user portion of a SIP URI.
 * @param {string} uri - the SIP URI
 * @returns {?string}
 */function getUser(uri){var SIPJS=require('../sip');var result=SIPJS.Grammar.parse(uri,'Contact');if(result!==-1&&result[0]){return result[0].parsed.uri.user;}return null;}function makeUUID(){return'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g,function(c){var r=Math.random()*16|0;var v=c==='x'?r:r&0x3|0x8;return v.toString(16);});}function promiseFromEvents(operation,eventEmitter,successEvent,failureEvent){return new Promise(function(resolve,reject){function onSuccess(){var args=[].slice.call(arguments);if(failureEvent){eventEmitter.removeListener(failureEvent,onFailure);}resolve.apply(null,args);}function onFailure(){var args=[].slice.call(arguments);eventEmitter.removeListener(successEvent,onSuccess);reject.apply(null,args);}eventEmitter.once(successEvent,onSuccess);if(failureEvent){eventEmitter.once(failureEvent,onFailure);}operation();});}function parseRoomSIDFromContactHeader(contactHeader){var match=contactHeader.match(/<sip:(.*)@(.*)$/);return match?match[1]:null;}/**
 * Traverse down multiple nodes on an object and return null if
 * any link in the path is unavailable.
 * @param {Object} obj - Object to traverse
 * @param {String} path - Path to traverse. Period-separated.
 * @returns {Any|null}
 */function getOrNull(obj,path){return path.split('.').reduce(function(output,step){if(!output){return null;}return output[step];},obj);}/**
 * @typedef {object} Deferred
 * @property {Promise} promise
 * @property {function} reject
 * @property {function} resolve
 *//**
 * Create a {@link Deferred}.
 * @returns {Deferred}
 */function defer(){var deferred={};deferred.promise=new Promise(function(resolve,reject){deferred.resolve=resolve;deferred.reject=reject;});return deferred;}/**
 * Copy a method from a `source` prototype onto a `wrapper` prototype. Invoking
 * the method on the `wrapper` prototype will invoke the corresponding method
 * on an instance accessed by `target`.
 * @param {object} source
 * @param {object} wrapper
 * @param {string} target
 * @param {string} methodName
 * @returns {undefined}
 */function delegateMethod(source,wrapper,target,methodName){if(wrapper[methodName]){// Skip any methods already set.
return;}else if(methodName.match(/^on[a-z]+$/)){// Skip EventHandlers (these are handled in the constructor).
return;}var type;try{type=_typeof(source[methodName]);}catch(error){// NOTE(mroberts): Attempting to check the type of non-function members
// on the prototype throws an error for some types.
}if(type!=='function'){// Skip non-function members.
return;}/* eslint no-loop-func:0 */wrapper[methodName]=function(){return this[target][methodName].apply(this[target],arguments);};}/**
 * Copy methods from a `source` prototype onto a `wrapper` prototype. Invoking
 * the methods on the `wrapper` prototype will invoke the corresponding method
 * on an instance accessed by `target`.
 * @param {object} source
 * @param {object} wrapper
 * @param {string} target
 * @returns {undefined}
 */function delegateMethods(source,wrapper,target){for(var methodName in source){delegateMethod(source,wrapper,target,methodName);}}/**
 * For each property name on the `source` prototype, add getters and/or setters
 * to `wrapper` that proxy to `target`.
 * @param {object} source
 * @param {object} wrapper
 * @param {string} target
 * @returns {undefined}
 */function proxyProperties(source,wrapper,target){for(var propertyName in source){proxyProperty(source,wrapper,target,propertyName);}}/**
 * For the property name on the `source` prototype, add a getter and/or setter
 * to `wrapper` that proxies to `target`.
 * @param {object} source
 * @param {object} wrapper
 * @param {string} target
 * @param {string} propertyName
 * @returns {undefined}
 */function proxyProperty(source,wrapper,target,propertyName){if(propertyName in wrapper){// Skip any properties already set.
return;}else if(propertyName.match(/^on[a-z]+$/)){Object.defineProperty(wrapper,propertyName,{value:null,writable:true});target.addEventListener(propertyName.slice(2),function(){wrapper.dispatchEvent.apply(wrapper,arguments);});return;}Object.defineProperty(wrapper,propertyName,{enumerable:true,get:function get(){return target[propertyName];}});}/**
 * This is a function for turning a Promise into the kind referenced in the
 * Legacy Interface Extensions section of the WebRTC spec.
 * @param {Promise<*>} promise
 * @param {function<*>} onSuccess
 * @param {function<Error>} onFailure
 * @returns {Promise<undefined>}
 */function legacyPromise(promise,onSuccess,onFailure){if(onSuccess){return promise.then(function(result){onSuccess(result);},function(error){onFailure(error);});}return promise;}/**
 * Build the {@link LogLevels} object.
 * @param {String|LogLevel} logLevel - Log level name or object
 * @returns {LogLevels}
 */function buildLogLevels(logLevel){if(typeof logLevel==='string'){return{default:logLevel,media:logLevel,signaling:logLevel,webrtc:logLevel};}return logLevel;}/**
 * Get the {@link Track}'s derived class name
 * @param {AudioTrack|VideoTrack|LocalAudioTrack|LocalVideoTrack} track
 * @param {?boolean} [local=undefined]
 * @returns {string}
 */function trackClass(track,local){local=local?'Local':'';return local+(track.kind||'').replace(/\w{1}/,function(m){return m.toUpperCase();})+'Track';}/**
 * Use unified plan SDP format on Firefox
 * @returns {?string} SDP format
 */function getSdpFormat(){return typeof mozRTCPeerConnection!=='undefined'?'unified':null;}module.exports.constants=constants;module.exports.makeSIPURI=makeSIPURI;module.exports.makeRegistrationSIPURI=makeRegistrationSIPURI;module.exports.getUser=getUser;module.exports.makeUUID=makeUUID;module.exports.promiseFromEvents=promiseFromEvents;module.exports.parseRoomSIDFromContactHeader=parseRoomSIDFromContactHeader;module.exports.map=map;module.exports.getOrNull=getOrNull;module.exports.defer=defer;module.exports.token=token;module.exports.delegateMethods=delegateMethods;module.exports.proxyProperties=proxyProperties;module.exports.legacyPromise=legacyPromise;module.exports.buildLogLevels=buildLogLevels;module.exports.trackClass=trackClass;module.exports.getSdpFormat=getSdpFormat;},{"../sip":38,"./constants":49,"./map":54,"./token":56}],52:[function(require,module,exports){'use strict';var inherits=require('util').inherits;var StateMachine=require('../statemachine');/*
Latch States
------------

    +------+    +------+
    |      |<---|      |
    | high |    | low  |
    |      |--->|      |
    +------+    +------+

*/var states={high:['low'],low:['high']};/**
 * Construct a {@link Latch}.
 * @class
 * @classdesc A {@link Latch} is just a {@link StateMachine} with two states
 *   ("high" and "low") and methods for transitioning between them
 *   ({@link Latch#raise} and {@link Latch#lower}).
 * @extends StateMachine
 * @param {string} [initialState="low"] - either "high" or "low"
 */function Latch(initialState){if(!(this instanceof Latch)){return new Latch(initialState);}StateMachine.call(this,initialState||'low',states);}inherits(Latch,StateMachine);/**
 * Transition to "high".
 * @returns {this}
 * @throws {Error}
 */Latch.prototype.raise=function raise(){return transition(this,'high');};/**
 * Transition to "low".
 * @returns {this}
 * @throws {Error}
 */Latch.prototype.lower=function lower(){return transition(this,'low');};/**
 * Transition a {@link Latch}.
 * @private
 * @param {Latch} latch
 * @param {string} newState - either "high" or "low"
 * @returns {Latch}
 * @throws {Error}
 */function transition(latch,newState){latch.transition(newState);return latch;}module.exports=Latch;},{"../statemachine":39,"util":109}],53:[function(require,module,exports){/* eslint no-console:0 */'use strict';// Dependencies
var constants=require('./constants');var DEFAULT_LOG_LEVEL=constants.DEFAULT_LOG_LEVEL;var E=require('./constants').typeErrors;/**
 * Construct a new {@link Log} object.
 * @class
 * @classdesc Selectively outputs messages to console.log
 *   based on specified minimum module specific log levels.
 *
 * NOTE: The values in the logLevels object passed to the constructor is changed
 *       by subsequent calls to {@link Log#setLevels}.
 *
 * @param {String} moduleName - Name of the logging module (webrtc/media/signaling)
 * @param {object} component - Component owning this instance of {@link Log}
 * @param {LogLevels} logLevels - Logging levels. See {@link LogLevels}
 */function Log(moduleName,component,logLevels){if(!(this instanceof Log)){return new Log(moduleName,component,logLevels);}if(typeof moduleName!=='string'){throw new E.INVALID_TYPE('moduleName','string');}if(!component){throw new E.REQUIRED_ARGUMENT('component');}if((typeof logLevels==="undefined"?"undefined":_typeof(logLevels))!=='object'){logLevels={};}validateLogLevels(logLevels);/* istanbul ignore next */Object.defineProperties(this,{_logLevels:{value:logLevels},logLevel:{get:function get(){return Log.getLevelByName(logLevels[moduleName]||DEFAULT_LOG_LEVEL);}},name:{get:component.toString.bind(component)}});}// Singleton Constants
/* eslint key-spacing:0 *//* istanbul ignore next */Object.defineProperties(Log,{DEBUG:{value:0},INFO:{value:1},WARN:{value:2},ERROR:{value:3},OFF:{value:4},_levels:{value:[{name:'DEBUG',logFn:console.log},{name:'INFO',logFn:console.info},{name:'WARN',logFn:console.warn},{name:'ERROR',logFn:console.error},{name:'OFF',logFn:function noop(){}}]}});var LOG_LEVELS_SET={};var LOG_LEVEL_VALUES=[];var LOG_LEVEL_NAMES=Log._levels.map(function(level,i){LOG_LEVELS_SET[level.name]=true;LOG_LEVEL_VALUES.push(i);return level.name;});function validateLogLevel(level){if(!(level in LOG_LEVELS_SET)){throw new E.INVALID_VALUE('level',LOG_LEVEL_NAMES);}}function validateLogLevels(levels){Object.keys(levels).forEach(function(moduleName){validateLogLevel(levels[moduleName].toUpperCase());});}/**
 * Get the log level (number) by its name (string)
 * @param {String} name - Name of the log level
 * @returns {Number} Requested log level
 * @throws {TwilioError} INVALID_LOG_LEVEL (32056)
 * @public
 */Log.getLevelByName=function getLevelByName(name){if(!isNaN(name)){return parseInt(name,10);}name=name.toUpperCase();validateLogLevel(name);return Log[name];};/**
 * Create a child {@link Log} instance with this._logLevels
 * @param moduleName - Name of the logging module
 * @param component - Component owning this instance of {@link Log}
 * @returns {Log} this
 */Log.prototype.createLog=function createLog(moduleName,component){return new Log(moduleName,component,this._logLevels);};/**
 * Set new log levels.
 * This changes the levels for all its ancestors,
 * siblings, and children and descendants instances of {@link Log}.
 * @param {LogLevels} levels - New log levels
 * @throws {TwilioError} INVALID_ARGUMENT
 * @returns {Log} this
 */Log.prototype.setLevels=function setLevels(levels){validateLogLevels(levels);Object.assign(this._logLevels,levels);return this;};/**
 * Log a message using the console method appropriate for the specified logLevel
 * @param {Number} logLevel - Log level of the message being logged
 * @param {String} message - Message(s) to log
 * @returns {Log} This instance of {@link Log}
 * @public
 */Log.prototype.log=function log(logLevel,message){var logSpec=Log._levels[logLevel];if(!logSpec){throw new E.INVALID_VALUE('logLevel',LOG_LEVEL_VALUES);}if(this.logLevel<=logLevel){var levelName=logSpec.name;var prefix=new Date().toISOString().split('T').concat(['|',levelName,'in',this.name+':']);logSpec.logFn.apply(console,prefix.concat(message));}return this;};/**
 * Log a debug message using console.log
 * @param {...String} messages - Message(s) to pass to console.log
 * @returns {Log} This instance of {@link Log}
 * @public
 */Log.prototype.debug=function debug(){return this.log(Log.DEBUG,[].slice.call(arguments));};/**
 * Log an info message using console.info
 * @param {...String} messages - Message(s) to pass to console.info
 * @returns {Log} This instance of {@link Log}
 * @public
 */Log.prototype.info=function info(){return this.log(Log.INFO,[].slice.call(arguments));};/**
 * Log a warn message using console.warn
 * @param {...String} messages - Message(s) to pass to console.warn
 * @returns {Log} This instance of {@link Log}
 * @public
 */Log.prototype.warn=function warn(){return this.log(Log.WARN,[].slice.call(arguments));};/**
 * Log an error message using console.error
 * @param {...String} messages - Message(s) to pass to console.error
 * @returns {Log} This instance of {@link Log}
 * @public
 */Log.prototype.error=function error(){return this.log(Log.ERROR,[].slice.call(arguments));};/**
 * Log an error message using console.error and throw an exception
 * @param {TwilioError} error - Error to throw
 * @param {String} customMessage - Custom message for the error
 * @public
 */Log.prototype.throw=function throwFn(error,customMessage){if(error.clone){error=error.clone(customMessage);}this.log(Log.ERROR,error);throw error;};module.exports=Log;},{"./constants":49}],54:[function(require,module,exports){'use strict';/**
 * Add a value to the Set at the given key. If a Set does not already exist
 * at the given key, create one.
 * @param {Map<*, Set<*>>} map
 * @param {*} key
 * @param {*} value
 * @returns {Map<*, Set<*>>}
 */function addToMapOfSets(map,key,value){if(!map.has(key)){map.set(key,new Set());}map.get(key).add(value);return map;}/**
 * Delete a value from the Set at the given key. If deleting the value results
 * in an empty Set, delete the Set from the Map.
 * @param {Map<*, Set<*>>} map
 * @param {*} key
 * @param {*} value
 * @returns {Map<*, Set<*>>}
 */function deleteFromMapOfSets(map,key,value){if(!map.has(key)){return map;}var set=map.get(key);set.delete(value);if(!set.size){map.delete(set);}return map;}module.exports.addToMapOfSets=addToMapOfSets;module.exports.deleteFromMapOfSets=deleteFromMapOfSets;},{}],55:[function(require,module,exports){'use strict';var EventEmitter=require('events').EventEmitter;var inherits=require('util').inherits;var util=require('./');/**
 * Construct a new {@link TimeoutPromise}.
 * @class
 * @classdesc A Promise that can time out.
 * @extends Promise
 * @param {Promise} original - a Promise
 * @param {?number} [timeout] - the timeout, in milliseconds; providing this in
 *   the constructor invokes {@link TimeoutPromise#start} (otherwise, you must
 *   call {@link TimeoutPromise#start} yourself)
 * @property {?number} timeout - the timeout, in milliseconds
 * @property {boolean} isTimedOut - whether or not the
 *   {@link TimeoutPromise} timed out
 * @fires TimeoutPromise#timedOut
 */function TimeoutPromise(original,initialTimeout){if(!(this instanceof TimeoutPromise)){return new TimeoutPromise(original,initialTimeout);}EventEmitter.call(this);var deferred=util.defer();var isTimedOut=false;var timedOut=new Error('Timed out');var timeout=null;var timer=null;/* istanbul ignore next */Object.defineProperties(this,{_deferred:{value:deferred},_isTimedOut:{get:function get(){return isTimedOut;},set:function set(_isTimedOut){isTimedOut=_isTimedOut;}},_timedOut:{value:timedOut},_timeout:{get:function get(){return timeout;},set:function set(_timeout){timeout=_timeout;}},_timer:{get:function get(){return timer;},set:function set(_timer){timer=_timer;}},_promise:{value:deferred.promise},isTimedOut:{enumerable:true,get:function get(){return isTimedOut;}},timeout:{enumerable:true,get:function get(){return timeout;}}});var self=this;original.then(function originalResolved(){clearTimeout(self._timer);deferred.resolve.apply(deferred.promise,arguments);},function originalRejected(){clearTimeout(self._timer);deferred.reject.apply(deferred.promise,arguments);});if(initialTimeout){this.start(initialTimeout);}}inherits(TimeoutPromise,EventEmitter);TimeoutPromise.prototype.catch=function _catch(){return this._promise.catch.apply(this._promise,arguments);};/**
 * Start the timer that will time out the {@link TimeoutPromise} if the
 * original Promise has neither resolved nor rejected. Subsequent calls have no
 * effect once the {@link TimeoutPromise} is started.
 * @param {number} timeout - the timeout, in milliseconds
 * @returns {this}
 */TimeoutPromise.prototype.start=function start(timeout){if(this._timer){return this;}var self=this;this._timeout=timeout;this._timer=setTimeout(function timer(){if(self._timer){self._isTimedOut=true;self.emit('timedOut',self);self._deferred.reject(self._timedOut);}},this.timeout);return this;};TimeoutPromise.prototype.then=function then(){return this._promise.then.apply(this._promise,arguments);};/**
 * The {@link TimeoutPromise} timed out.
 * @param {TimeoutPromise} promise - The {@link TimeoutPromise}
 * @event TimeoutPromise#timedOut
 */module.exports=TimeoutPromise;},{"./":51,"events":70,"util":109}],56:[function(require,module,exports){(function(Buffer){'use strict';// NOTE(mroberts): The functions here are a stop-gap solution; we really should
// not be parsing Access Tokens in the Client.
/**
 * Parse the payload of a JSON Web Token (JWT).
 * @private
 * @param {string} jwt
 * @returns {object}
 */function parsePayload(jwt){var segments=jwt.split('.');if(segments.length!==3){throw new Error('Token is invalid or malformed');}var encodedPayloadString=segments[1];var payloadString=decodeBase64URL(encodedPayloadString);var payload=JSON.parse(payloadString);return payload;}/**
 * Decode a base64url-encoded string.
 * @private
 * @param {string} encoded
 * @returns {string}
 */function decodeBase64URL(encoded){var remainder=encoded.length%4;if(remainder>0){var padlen=4-remainder;encoded+=new Array(padlen+1).join('=');}encoded=encoded.replace(/-/g,'+').replace(/_/g,'/');return decodeBase64(encoded);}/**
 * Decode a base64-encoded string.
 * @private
 * @param {string} encoded
 * @returns {string}
 */function decodeBase64(encoded){return new Buffer(encoded,'base64').toString();}/**
 * Get the Account SID out of an Access Token.
 * @param {string} token
 * @returns {string}
 * @throws
 */function getAccountSid(token){return parsePayload(token).sub;}/**
 * Get the identity out of an Access Token.
 * @param {string} token
 * @returns {string}
 * @throws
 */function getIdentity(token){return parsePayload(token).grants.identity;}exports.getAccountSid=getAccountSid;exports.getIdentity=getIdentity;}).call(this,require("buffer").Buffer);},{"buffer":68}],57:[function(require,module,exports){'use strict';var inherits=require('util').inherits;/**
 * Creates a new {@link TwilioError}
 * @extends Error
 * @param {number} code - Error code
 * @param {string} [message] - Error message
 * @param {string} [fileName] - Name of the script file where error was generated
 * @param {number} [lineNumber] - Line number of the script file where error was generated
 * @property {number} code - Error code
 * @constructor
 */function TwilioError(code){var error=Error.apply(this,[].slice.call(arguments,1));error.name='TwilioError';Object.defineProperty(this,'code',{value:code,enumerable:true});Object.getOwnPropertyNames(error).forEach(function(prop){Object.defineProperty(this,prop,{value:error[prop],enumerable:true});},this);}inherits(TwilioError,Error);/**
 * Returns human readable string describing the error.
 * @returns {string}
 */TwilioError.prototype.toString=function toString(){var message=this.message?': '+this.message:'';return this.name+' '+this.code+message;};module.exports=TwilioError;},{"util":109}],58:[function(require,module,exports){/* global webkitRTCPeerConnection, mozRTCPeerConnection */'use strict';/**
 * Get the standardized {@link RTCPeerConnection} statistics.
 * @param {RTCPeerConnection} peerConnection
 * @param {object} [options] - Used for testing
 * @returns {Promise.<StandardizedStatsResponse>}
 */function getStats(peerConnection,options){if(!(peerConnection&&typeof peerConnection.getStats==='function')){return Promise.reject(new Error('Given PeerConnection does not support getStats'));}return _getStats(peerConnection,options);}/**
 * getStats() implementation.
 * @param {RTCPeerConnection} peerConnection
 * @param {object} [options] - Used for testing
 * @returns {Promise.<StandardizedStatsResponse>}
 */function _getStats(peerConnection,options){var localAudioTracks=getTracks(peerConnection,'audio','local');var localVideoTracks=getTracks(peerConnection,'video','local');var remoteAudioTracks=getTracks(peerConnection,'audio');var remoteVideoTracks=getTracks(peerConnection,'video');var statsResponse={localAudioTrackStats:[],localVideoTrackStats:[],remoteAudioTrackStats:[],remoteVideoTrackStats:[]};var trackStatsPromises=[].concat(localAudioTracks.map(function(track){return getTrackStats(peerConnection,track,options).then(function(stats){stats.trackId=track.id;statsResponse.localAudioTrackStats.push(stats);});}),localVideoTracks.map(function(track){return getTrackStats(peerConnection,track,options).then(function(stats){stats.trackId=track.id;statsResponse.localVideoTrackStats.push(stats);});}),remoteAudioTracks.map(function(track){return getTrackStats(peerConnection,track,options).then(function(stats){stats.trackId=track.id;statsResponse.remoteAudioTrackStats.push(stats);});}),remoteVideoTracks.map(function(track){return getTrackStats(peerConnection,track,options).then(function(stats){stats.trackId=track.id;statsResponse.remoteVideoTrackStats.push(stats);});}));return Promise.all(trackStatsPromises).then(function(){return statsResponse;});}/**
 * Get local/remote audio/video MediaStreamTracks.
 * @param {RTCPeerConnection} peerConnection - The RTCPeerConnection
 * @param {string} kind - 'audio' or 'video'
 * @param {string} [localOrRemote] - 'local' or 'remote'
 * @returns {Array<MediaStreamTrack>}
 */function getTracks(peerConnection,kind,localOrRemote){var getStreams=localOrRemote==='local'?'getLocalStreams':'getRemoteStreams';return peerConnection[getStreams]().reduce(function(localTracks,localStream){var getTracks=kind==='audio'?'getAudioTracks':'getVideoTracks';return localTracks.concat(localStream[getTracks]());},[]);}/**
 * Get the standardized statistics for a particular MediaStreamTrack.
 * @param {RTCPeerConnection} peerConnection
 * @param {MediaStreamTrack} track
 * @param {object} [options] - Used for testing
 * @returns {Promise.<StandardizedTrackStatsReport>}
 */function getTrackStats(peerConnection,track,options){options=options||{};if(typeof options.testForChrome!=='undefined'||typeof webkitRTCPeerConnection!=='undefined'){return chromeGetTrackStats(peerConnection,track);}if(typeof options.testForFirefox!=='undefined'||typeof mozRTCPeerConnection!=='undefined'){return firefoxGetTrackStats(peerConnection,track);}return Promise.reject(new Error('RTCPeerConnection#getStats() not supported'));}/**
 * Get the standardized statistics for a particular MediaStreamTrack in Chrome.
 * @param {RTCPeerConnection} peerConnection
 * @param {MediaStreamTrack} track
 * @returns {Promise.<StandardizedTrackStatsReport>}
 */function chromeGetTrackStats(peerConnection,track){return new Promise(function(resolve,reject){peerConnection.getStats(function(response){resolve(standardizeChromeStats(response));},track,reject);});}/**
 * Get the standardized statistics for a particular MediaStreamTrack in Firefox.
 * @param {RTCPeerConnection} peerConnection
 * @param {MediaStreamTrack} track
 * @returns {Promise.<StandardizedTrackStatsReport>}
 */function firefoxGetTrackStats(peerConnection,track){return new Promise(function(resolve,reject){peerConnection.getStats(track,function(response){resolve(standardizeFirefoxStats(response));},reject);});}/**
 * Standardize the MediaStreamTrack's statistics in Chrome.
 * @param {RTCStatsResponse} response
 * @returns {StandardizedTrackStatsReport}
 */function standardizeChromeStats(response){var ssrcReport=response.result().reduce(function(ssrcReport,report){return report.type==='ssrc'?report:ssrcReport;},null);var standardizedStats={};if(ssrcReport){standardizedStats.timestamp=Math.round(Number(ssrcReport.timestamp));standardizedStats=ssrcReport.names().reduce(function(stats,name){switch(name){case'googCodecName':stats.codecName=ssrcReport.stat(name);break;case'googRtt':stats.roundTripTime=Number(ssrcReport.stat(name))*1000;break;case'googJitterReceived':stats.jitter=Number(ssrcReport.stat(name));break;case'googFrameWidthInput':stats.frameWidthInput=Number(ssrcReport.stat(name));break;case'googFrameHeightInput':stats.frameHeightInput=Number(ssrcReport.stat(name));break;case'googFrameWidthSent':stats.frameWidthSent=Number(ssrcReport.stat(name));break;case'googFrameHeightSent':stats.frameHeightSent=Number(ssrcReport.stat(name));break;case'googFrameWidthReceived':stats.frameWidthReceived=Number(ssrcReport.stat(name));break;case'googFrameHeightReceived':stats.frameHeightReceived=Number(ssrcReport.stat(name));break;case'googFrameRateInput':stats.frameRateInput=Number(ssrcReport.stat(name));break;case'googFrameRateSent':stats.frameRateSent=Number(ssrcReport.stat(name));break;case'googFrameRateReceived':stats.frameRateReceived=Number(ssrcReport.stat(name));break;case'ssrc':stats[name]=ssrcReport.stat(name);break;case'bytesReceived':case'bytesSent':case'packetsLost':case'packetsReceived':case'packetsSent':case'audioInputLevel':case'audioOutputLevel':stats[name]=Number(ssrcReport.stat(name));break;}return stats;},standardizedStats);}return standardizedStats;}/**
 * Standardize the MediaStreamTrack's statistics in Firefox.
 * @param {RTCStatsReport} response
 * @returns {StandardizedTrackStatsReport}
 */function standardizeFirefoxStats(response){var inbound=Object.keys(response).reduce(function(report,id){return response[id].type==='inboundrtp'?response[id]:report;},null);var outbound=Object.keys(response).reduce(function(report,id){return response[id].type==='outboundrtp'?response[id]:report;},null);var standardizedStats={};function getStatValue(name){var first=outbound;var second=inbound;if(outbound.isRemote){first=inbound;second=outbound;}return typeof first[name]!=='undefined'?first[name]:second[name];}var timestamp=getStatValue('timestamp');standardizedStats.timestamp=Math.round(timestamp);var ssrc=getStatValue('ssrc');if(typeof ssrc==='string'){standardizedStats.ssrc=ssrc;}var bytesSent=getStatValue('bytesSent');if(typeof bytesSent==='number'){standardizedStats.bytesSent=bytesSent;}var packetsLost=getStatValue('packetsLost');if(typeof packetsLost==='number'){standardizedStats.packetsLost=packetsLost;}var packetsSent=getStatValue('packetsSent');if(typeof packetsSent==='number'){standardizedStats.packetsSent=packetsSent;}var roundTripTime=getStatValue('mozRtt');if(typeof roundTripTime==='number'){standardizedStats.roundTripTime=roundTripTime*1000;}var jitter=getStatValue('jitter');if(typeof jitter==='number'){standardizedStats.jitter=Math.round(jitter*1000);}var frameRateSent=getStatValue('framerateMean');if(typeof frameRateSent==='number'){standardizedStats.frameRateSent=Math.round(frameRateSent);}var bytesReceived=getStatValue('bytesReceived');if(typeof bytesReceived==='number'){standardizedStats.bytesReceived=bytesReceived;}var packetsReceived=getStatValue('packetsReceived');if(typeof packetsReceived==='number'){standardizedStats.packetsReceived=packetsReceived;}var frameRateReceived=getStatValue('framerateMean');if(typeof frameRateReceived==='number'){standardizedStats.frameRateReceived=Math.round(frameRateReceived);}return standardizedStats;}/**
 * Standardized {@link RTCPeerConnection} statistics.
 * @typedef {Object} StandardizedStatsResponse
 * @property Array<StandardizedTrackStatsReport> localAudioTracks - Stats for local audio MediaStreamTracks
 * @property Array<StandardizedTrackStatsReport> localVideoTracks - Stats for local video MediaStreamTracks
 * @property Array<StandardizedTrackStatsReport> remoteAudioTracks - Stats for remote audio MediaStreamTracks
 * @property Array<StandardizedTrackStatsReport> remoteVideoTracks - Stats for remote video MediaStreamTracks
 *//**
 * Standardized MediaStreamTrack statistics.
 * @typedef {Object} StandardizedTrackStatsReport
 * @property {string} trackId - MediaStreamTrack ID
 * @property {string} ssrc - SSRC of the MediaStreamTrack
 * @property {number} timestamp - The Unix timestamp in milliseconds
 * @property {string} [codecName] - Name of the codec used to encode the MediaStreamTrack's media
 * @property {number} [roundTripTime] - Round trip time in milliseconds
 * @property {number} [jitter] - Jitter in milliseconds
 * @property {number} [frameWidthInput] - Width in pixels of the local video MediaStreamTrack's captured frame
 * @property {number} [frameHeightInput] - Height in pixels of the local video MediaStreamTrack's captured frame
 * @property {number} [frameWidthSent] - Width in pixels of the local video MediaStreamTrack's encoded frame
 * @property {number} [frameHeightSent] - Height in pixels of the local video MediaStreamTrack's encoded frame
 * @property {number} [frameWidthReceived] - Width in pixels of the remote video MediaStreamTrack's received frame
 * @property {number} [frameHeightReceived] - Height in pixels of the remote video MediaStreamTrack's received frame
 * @property {number} [frameRateInput] - Captured frames per second of the local video MediaStreamTrack
 * @property {number} [frameRateSent] - Frames per second of the local video MediaStreamTrack's encoded video
 * @property {number} [frameRateReceived] - Frames per second of the remote video MediaStreamTrack's received video
 * @property {number} [bytesReceived] - Number of bytes of the remote MediaStreamTrack's media received
 * @property {number} [bytesSent] - Number of bytes of the local MediaStreamTrack's media sent
 * @property {number} [packetsLost] - Number of packets of the MediaStreamTrack's media lost
 * @property {number} [packetsReceived] - Number of packets of the remote MediaStreamTrack's media received
 * @property {number} [packetsSent] - Number of packets of the local MediaStreamTrack's media sent
 * @property {AudioLevel} [audioInputLevel] - The {@link AudioLevel} of the local audio MediaStreamTrack
 * @property {AudioLevel} [audioOutputLevel] - The {@link AudioLevel} of the remote video MediaStreamTrack
 */module.exports=getStats;},{}],59:[function(require,module,exports){'use strict';/**
 * This function is very similar to <code>navigator.getUserMedia</code> except
 * that it does not use callbacks and returns a Promise for a MediaStream
 * @function getUserMedia
 * @param {MediaStreamConstraints} [constraints={audio:true,video:true}] - the
 *   MediaStreamConstraints object specifying what kind of LocalMediaStream to
 *   request from the browser (by default both audio and video)
 * @returns Promise<MediaStream>
 */function getUserMedia(constraints){return new Promise(function getUserMediaPromise(resolve,reject){_getUserMedia(constraints||{audio:true,video:true},resolve,reject);});}function _getUserMedia(constraints,onSuccess,onFailure){if(typeof window!=='undefined'&&typeof navigator!=='undefined'){if(_typeof(navigator.mediaDevices)==='object'&&typeof navigator.mediaDevices.getUserMedia==='function'){navigator.mediaDevices.getUserMedia(constraints).then(onSuccess,onFailure);}else if(typeof navigator.webkitGetUserMedia==='function'){navigator.webkitGetUserMedia(constraints,onSuccess,onFailure);}else if(typeof navigator.mozGetUserMedia==='function'){navigator.mozGetUserMedia(constraints,onSuccess,onFailure);}return;}onFailure(new Error('getUserMedia is not supported'));}module.exports=getUserMedia;},{}],60:[function(require,module,exports){/* global mozRTCIceCandidate, RTCIceCandidate */'use strict';if(typeof mozRTCIceCandidate!=='undefined'){module.exports=mozRTCIceCandidate;}else if(typeof RTCIceCandidate!=='undefined'){module.exports=RTCIceCandidate;}},{}],61:[function(require,module,exports){/* globals RTCSessionDescription, webkitRTCPeerConnection */'use strict';var ChromeRTCSessionDescription=require('../rtcsessiondescription/chrome');var EventTarget=require('../../eventtarget');var inherits=require('util').inherits;var Latch=require('../../util/latch');var util=require('../../util');// NOTE(mroberts): This class wraps Chrome's RTCPeerConnection implementation.
// It provides some functionality not currently present in Chrome, namely the
// abilities to
//
//   1. Rollback, per the workaround suggested here:
//      https://bugs.chromium.org/p/webrtc/issues/detail?id=5738#c3
//
//   2. Listen for track events, per the adapter.js workaround.
//
//   3. Set iceTransportPolicy.
//
function ChromeRTCPeerConnection(configuration){if(!(this instanceof ChromeRTCPeerConnection)){return new ChromeRTCPeerConnection(configuration);}EventTarget.call(this);var newConfiguration=Object.assign({},configuration);if(newConfiguration.iceTransportPolicy){newConfiguration.iceTransports=newConfiguration.iceTransportPolicy;}var onsignalingstatechange=null;/* eslint new-cap:0 */var peerConnection=new webkitRTCPeerConnection(newConfiguration);Object.defineProperties(this,{_peerConnection:{value:peerConnection},_pendingLocalOffer:{value:null,writable:true},_pendingRemoteOffer:{value:null,writable:true},_signalingStateLatch:{value:new Latch()},localDescription:{enumerable:true,get:function get(){return this._pendingLocalOffer?this._pendingLocalOffer:peerConnection.localDescription;}},onsignalingstatechange:{get:function get(){return onsignalingstatechange;},set:function set(_onsignalingstatechange){if(onsignalingstatechange){this.removeEventListener('signalingstatechange',onsignalingstatechange);}if(typeof _onsignalingstatechange==='function'){onsignalingstatechange=_onsignalingstatechange;this.addEventListener('signalingstatechange',onsignalingstatechange);}else{onsignalingstatechange=null;}}},remoteDescription:{enumerable:true,get:function get(){return this._pendingRemoteOffer?this._pendingRemoteOffer:peerConnection.remoteDescription;}},signalingState:{enumerable:true,get:function get(){if(this._pendingLocalOffer){return'have-local-offer';}else if(this._pendingRemoteOffer){return'have-remote-offer';}return peerConnection.signalingState;}}});var self=this;peerConnection.addEventListener('signalingstatechange',function onsignalingstatechange(){if(!self._pendingLocalOffer&&!self._pendingRemoteOffer){self.dispatchEvent.apply(self,arguments);}});util.proxyProperties(webkitRTCPeerConnection.prototype,this,peerConnection);// NOTE(mroberts): We use the adapter.js workaround for providing track events.
if(!('ontrack'in webkitRTCPeerConnection.prototype)){peerConnection.addEventListener('addstream',function onaddstream(addStreamEvent){var mediaStream=addStreamEvent.stream;mediaStream.addEventListener('addtrack',function onaddtrack(addTrackEvent){var mediaStreamTrack=addTrackEvent.track;var newEvent=new Event('track');newEvent.track=mediaStreamTrack;newEvent.receiver={track:mediaStreamTrack};newEvent.streams=[mediaStream];self.dispatchEvent(newEvent);});mediaStream.getTracks().forEach(function(mediaStreamTrack){var newEvent=new Event('track');newEvent.track=mediaStreamTrack;newEvent.streams=[mediaStream];self.dispatchEvent(newEvent);});});}}inherits(ChromeRTCPeerConnection,EventTarget);ChromeRTCPeerConnection.prototype.addIceCandidate=function addIceCandidate(candidate){var args=[].slice.call(arguments);var promise;var self=this;if(this.signalingState==='have-remote-offer'){// NOTE(mroberts): Because the ChromeRTCPeerConnection simulates the
// "have-remote-offer" signalingStates, we only want to invoke the true
// addIceCandidates method when the remote description has been applied.
promise=this._signalingStateLatch.when('low').then(function signalingStatesResolved(){return self._peerConnection.addIceCandidate(candidate);});}else{promise=this._peerConnection.addIceCandidate(candidate);}return args.length>1?util.legacyPromise(promise,args[1],args[2]):promise;};// NOTE(mroberts): The WebRTC spec does not specify that close should throw an
// Error; however, in Chrome it does. We workaround this by checking the
// signalingState manually.
ChromeRTCPeerConnection.prototype.close=function close(){if(this.signalingState!=='closed'){this._pendingLocalOffer=null;this._pendingRemoteOffer=null;this._peerConnection.close();}};// NOTE(mroberts): Because we workaround Chrome's lack of rollback support by
// "faking" setRemoteDescription, we cannot create an answer until we actually
// apply the remote description. This means, once you call createAnswer, you
// can no longer rollback. This is acceptable for our use case because we will
// apply the newly-created answer almost immediately; however, this may be
// unacceptable for other use cases.
ChromeRTCPeerConnection.prototype.createAnswer=function createAnswer(){var args=[].slice.call(arguments);var promise;var self=this;if(this._pendingRemoteOffer){promise=this._peerConnection.setRemoteDescription(this._pendingRemoteOffer).then(function setRemoteDescriptionSucceeded(){// NOTE(mroberts): The signalingStates between the ChromeRTCPeerConnection
// and the underlying RTCPeerConnection implementation have converged. We
// can unblock any pending calls to addIceCandidate now.
self._signalingStateLatch.lower();return self._peerConnection.createAnswer();}).then(function createAnswerSucceeded(answer){self._pendingRemoteOffer=null;return answer;},function setRemoteDescriptionOrCreateAnswerFailed(error){self._pendingRemoteOffer=null;throw error;});}if(promise){return args.length>1?util.legacyPromise(promise,args[0],args[1]):promise;}return this._peerConnection.createAnswer.apply(this._peerConnection,args);};ChromeRTCPeerConnection.prototype.setLocalDescription=function setLocalDescription(){var args=[].slice.call(arguments);var description=args[0];var promise=setDescription(this,true,description);return args.length>1?util.legacyPromise(promise,args[1],args[2]):promise;};ChromeRTCPeerConnection.prototype.setRemoteDescription=function setRemoteDescription(){var args=[].slice.call(arguments);var description=args[0];var promise=setDescription(this,false,description);return args.length>1?util.legacyPromise(promise,args[1],args[2]):promise;};util.delegateMethods(webkitRTCPeerConnection.prototype,ChromeRTCPeerConnection.prototype,'_peerConnection');// NOTE(mroberts): We workaround Chrome's lack of rollback support, per the
// workaround suggested here: https://bugs.chromium.org/p/webrtc/issues/detail?id=5738#c3
// Namely, we "fake" setting the local or remote description and instead buffer
// it. If we receive or create an answer, then we will actually apply the
// description. Until we receive or create an answer, we will be able to
// "rollback" by simply discarding the buffer description.
function setDescription(peerConnection,local,description){function setPendingLocalOffer(offer){if(local){peerConnection._pendingLocalOffer=offer;}else{peerConnection._pendingRemoteOffer=offer;}}function clearPendingLocalOffer(){if(local){peerConnection._pendingLocalOffer=null;}else{peerConnection._pendingRemoteOffer=null;}}var pendingLocalOffer=local?peerConnection._pendingLocalOffer:peerConnection._pendingRemoteOffer;var pendingRemoteOffer=local?peerConnection._pendingRemoteOffer:peerConnection._pendingLocalOffer;var intermediateState=local?'have-local-offer':'have-remote-offer';var setLocalDescription=local?'setLocalDescription':'setRemoteDescription';var promise;if(!local&&pendingRemoteOffer&&description.type==='answer'){promise=setRemoteAnswer(peerConnection,description);}else if(description.type==='offer'){if(peerConnection.signalingState!==intermediateState&&peerConnection.signalingState!=='stable'){// NOTE(mroberts): Error message copied from Firefox.
return Promise.reject(new Error('Cannot set '+(local?'local':'remote')+' offer in state '+peerConnection.signalingState));}// We need to save this local offer in case of a rollback. We also need to
// check to see if the signalingState between the ChromeRTCPeerConnection
// and the underlying RTCPeerConnection implementation are about to diverge.
// If so, we need to ensure subsequent calls to addIceCandidate will block.
if(!pendingLocalOffer){peerConnection._signalingStateLatch.raise();}var previousSignalingState=peerConnection.signalingState;setPendingLocalOffer(unwrap(description));promise=Promise.resolve();// Only dispatch a signalingstatechange event if we transitioned.
if(peerConnection.signalingState!==previousSignalingState){promise.then(function dispatchSignalingStateChangeEvent(){peerConnection.dispatchEvent(new Event('signalingstatechange'));});}}else if(description.type==='rollback'){if(peerConnection.signalingState!==intermediateState){// NOTE(mroberts): Error message copied from Firefox.
promise=Promise.reject(new Error('Cannot rollback '+(local?'local':'remote')+' description in '+peerConnection.signalingState));}else{// Reset the pending offer.
clearPendingLocalOffer();promise=Promise.resolve();promise.then(function dispatchSignalingStateChangeEvent(){peerConnection.dispatchEvent(new Event('signalingstatechange'));});}}return promise||peerConnection._peerConnection[setLocalDescription](unwrap(description));}function setRemoteAnswer(peerConnection,answer){// Apply the pending local offer.
var pendingLocalOffer=peerConnection._pendingLocalOffer;return peerConnection._peerConnection.setLocalDescription(pendingLocalOffer).then(function setLocalOfferSucceeded(){peerConnection._pendingLocalOffer=null;return peerConnection.setRemoteDescription(answer);}).then(function setRemoteAnswerSucceeded(){// NOTE(mroberts): The signalingStates between the ChromeRTCPeerConnection
// and the underlying RTCPeerConnection implementation have converged. We
// can unblock any pending calls to addIceCandidate now.
peerConnection._signalingStateLatch.lower();});}function unwrap(description){if(description instanceof ChromeRTCSessionDescription){if(description._description){return description._description;}}return new RTCSessionDescription(description);}module.exports=ChromeRTCPeerConnection;},{"../../eventtarget":5,"../../util":51,"../../util/latch":52,"../rtcsessiondescription/chrome":64,"util":109}],62:[function(require,module,exports){/* globals mozRTCPeerConnection */'use strict';var EventTarget=require('../../eventtarget');var FirefoxRTCSessionDescription=require('../rtcsessiondescription/firefox');var inherits=require('util').inherits;var util=require('../../util');// NOTE(mroberts): This class wraps Firefox's RTCPeerConnection implementation.
// It provides some functionality not currently present in Firefox, namely the
// abilities to
//
//   1. Call setLocalDescription and setRemoteDescription with new offers in
//      signalingStates "have-local-offer" and "have-remote-offer",
//      respectively.
//
//   2. The ability to call createOffer in signalingState "have-local-offer".
//
// Both of these are implemented using rollbacks to workaround the following
// bug:
//
//   https://bugzilla.mozilla.org/show_bug.cgi?id=1072388
//
// We also provide a workaround for a bug where Firefox may change the
// previously-negotiated DTLS role in an answer, which breaks Chrome:
//
//     https://bugzilla.mozilla.org/show_bug.cgi?id=1240897
//
function FirefoxRTCPeerConnection(configuration){if(!(this instanceof FirefoxRTCPeerConnection)){return new FirefoxRTCPeerConnection(configuration);}EventTarget.call(this);var onsignalingstatechange=null;/* eslint new-cap:0 */var peerConnection=new mozRTCPeerConnection(configuration);Object.defineProperties(this,{_initiallyNegotiatedDtlsRole:{value:null,writable:true},_isClosed:{value:false,writable:true},_peerConnection:{value:peerConnection},_rollingBack:{value:false,writable:true},iceGatheringState:{enumerable:true,get:function get(){return this._isClosed?'complete':this._peerConnection.iceGatheringState;}},localDescription:{enumerable:true,get:function get(){return overwriteWithInitiallyNegotiatedDtlsRole(this._peerConnection.localDescription,this._initiallyNegotiatedDtlsRole);}},onsignalingstatechange:{get:function get(){return onsignalingstatechange;},set:function set(_onsignalingstatechange){if(onsignalingstatechange){this.removeEventListener('signalingstatechange',onsignalingstatechange);}if(typeof _onsignalingstatechange==='function'){onsignalingstatechange=_onsignalingstatechange;this.addEventListener('signalingstatechange',onsignalingstatechange);}else{onsignalingstatechange=null;}}},signalingState:{enumerable:true,get:function get(){return this._isClosed?'closed':this._peerConnection.signalingState;}}});var self=this;var previousSignalingState;peerConnection.addEventListener('signalingstatechange',function onsignalingstatechange(){if(!self._rollingBack&&self.signalingState!==previousSignalingState){previousSignalingState=self.signalingState;// NOTE(mmalavalli): In Firefox, 'signalingstatechange' event is
// triggered synchronously in the same tick after
// RTCPeerConnection#close() is called. So we mimic Chrome's behavior
// by triggering 'signalingstatechange' on the next tick.
var dispatchEventToSelf=self.dispatchEvent.apply.bind(self.dispatchEvent,self,arguments);if(self._isClosed){setTimeout(dispatchEventToSelf);}else{dispatchEventToSelf();}}});util.proxyProperties(mozRTCPeerConnection.prototype,this,peerConnection);// NOTE(mroberts): We use the adapter.js workaround for providing track events.
if(!('ontrack'in mozRTCPeerConnection.prototype)){peerConnection.addEventListener('addstream',function onaddstream(addStreamEvent){var mediaStream=addStreamEvent.stream;// NOTE(mmalavalli): We are not using MediaStream#onaddtrack event listeners
// for shimming PeerConnection#ontrack like we do for Chrome because it
// is not yet supported in Firefox (support is slated for Firefox 50).
// That's why we don't see this event being used in adapter.js's Firefox
// shim.
// Reference: https://developer.mozilla.org/en-US/docs/Web/API/MediaStream#Browser_compatibility
mediaStream.getTracks().forEach(function(mediaStreamTrack){var newEvent=new Event('track');newEvent.track=mediaStreamTrack;newEvent.streams=[mediaStream];self.dispatchEvent(newEvent);});});}}inherits(FirefoxRTCPeerConnection,EventTarget);// NOTE(mmalavalli): Firefox throws an exception when
// RTCPeerConnection#getRemoteStreams() is called after it is 'closed'.
// Expected behavior is to return an empty array.
// Bugzilla: https://bugzilla.mozilla.org/show_bug.cgi?id=1154084
FirefoxRTCPeerConnection.prototype.getRemoteStreams=function getRemoteStreams(){return this._isClosed?[]:this._peerConnection.getRemoteStreams();};// NOTE(mmalavalli): Firefox does not support RTCPeerConnection#removeStream(),
// and calling it will screw up the RTCPeerConnection's internal state. So
// for now, we don't do anything when it is called.
// Bugzilla: https://bugzilla.mozilla.org/show_bug.cgi?id=842455
FirefoxRTCPeerConnection.prototype.removeStream=function removeStream(){};// NOTE(mmalavalli): Firefox throws an exception if
// RTCPeerConnection#addStream() tries to add an already added stream. So,
// we check to make sure the new stream is not already added.
// Bugzilla: https://bugzilla.mozilla.org/show_bug.cgi?id=825550
FirefoxRTCPeerConnection.prototype.addStream=function addStream(newStream){var localStreams=this._peerConnection.getLocalStreams();var exists=localStreams.some(function(stream){return stream===newStream;});if(!exists){return this._peerConnection.addStream(newStream);}};FirefoxRTCPeerConnection.prototype.createAnswer=function createAnswer(){var args=[].slice.call(arguments);var promise;var self=this;promise=this._peerConnection.createAnswer().then(function createAnswerSucceeded(answer){saveInitiallyNegotiatedDtlsRole(self,answer);overwriteWithInitiallyNegotiatedDtlsRole(answer,self._initiallyNegotiatedDtlsRole);return answer;});return typeof args[0]==='function'?util.legacyPromise(promise,args[0],args[1]):promise;};// NOTE(mroberts): The WebRTC spec allows you to call createOffer from any
// signalingState other than "closed"; however, Firefox has not yet implemented
// this (https://bugzilla.mozilla.org/show_bug.cgi?id=1072388). We workaround
// this by rolling back if we are in state "have-local-offer" or
// "have-remote-offer". This is acceptable for our use case because we will
// apply the newly-created offer almost immediately; however, this may be
// unacceptable for other use cases.
FirefoxRTCPeerConnection.prototype.createOffer=function createOffer(){var args=[].slice.call(arguments);var promise;var self=this;if(this.signalingState==='have-local-offer'||this.signalingState==='have-remote-offer'){var local=this.signalingState==='have-local-offer';var offerOptions=(args.length>1?args[2]:args[0])||{};promise=rollback(this,local,function rollbackSucceeded(){return self.createOffer(offerOptions);});}if(promise){return args.length>1?util.legacyPromise(promise,args[0],args[1]):promise;}return this._peerConnection.createOffer.apply(this._peerConnection,args);};// NOTE(mroberts): While Firefox will reject the Promise returned by
// setLocalDescription when called from signalingState "have-local-offer" with
// an answer, it still updates the .localDescription property. We workaround
// this by explicitly handling this case.
FirefoxRTCPeerConnection.prototype.setLocalDescription=function setLocalDescription(){var args=[].slice.call(arguments);var description=args[0];var promise;if(description&&description.type==='answer'&&this.signalingState==='have-local-offer'){promise=Promise.reject(new Error('Cannot set local answer in state have-local-offer'));}if(promise){return args.length>1?util.legacyPromise(promise,args[1],args[2]):promise;}return this._peerConnection.setLocalDescription.apply(this._peerConnection,args);};// NOTE(mroberts): The WebRTC spec allows you to call setRemoteDescription with
// an offer multiple times in signalingState "have-remote-offer"; however,
// Firefox has not yet implemented this (https://bugzilla.mozilla.org/show_bug.cgi?id=1072388).
// We workaround this by rolling back if we are in state "have-remote-offer".
// This is acceptable for our use case; however, this may be unacceptable for
// other use cases.
//
// While Firefox will reject the Promise returned by setRemoteDescription when
// called from signalingState "have-remote-offer" with an answer, it sill
// updates the .remoteDescription property. We workaround this by explicitly
// handling this case.
FirefoxRTCPeerConnection.prototype.setRemoteDescription=function setRemoteDescription(){var args=[].slice.call(arguments);var description=args[0];var promise;var self=this;if(description&&this.signalingState==='have-remote-offer'){if(description.type==='answer'){promise=Promise.reject(new Error('Cannot set remote answer in state have-remote-offer'));}else if(description.type==='offer'){promise=rollback(this,false,function rollbackSucceeded(){return self._peerConnection.setRemoteDescription(description);});}}if(!promise){promise=this._peerConnection.setRemoteDescription(description);}promise=promise.then(function setRemoteDescriptionSucceeded(){saveInitiallyNegotiatedDtlsRole(self,description,true);});return args.length>1?util.legacyPromise(promise,args[1],args[2]):promise;};// NOTE(mroberts): The WebRTC spec specifies that the PeerConnection's internal
// isClosed slot should immediately be set to true; however, in Firefox it
// occurs in the next tick. We workaround this by tracking isClosed manually.
FirefoxRTCPeerConnection.prototype.close=function close(){if(this.signalingState!=='closed'){this._isClosed=true;this._peerConnection.close();}};util.delegateMethods(mozRTCPeerConnection.prototype,FirefoxRTCPeerConnection.prototype,'_peerConnection');function rollback(peerConnection,local,onceRolledBack){var setLocalDescription=local?'setLocalDescription':'setRemoteDescription';peerConnection._rollingBack=true;return peerConnection._peerConnection[setLocalDescription](new FirefoxRTCSessionDescription({type:'rollback'})).then(onceRolledBack).then(function onceRolledBackSucceeded(result){peerConnection._rollingBack=false;return result;},function rollbackOrOnceRolledBackFailed(error){peerConnection._rollingBack=false;throw error;});}/**
 * Extract the initially negotiated DTLS role out of an RTCSessionDescription's
 * sdp property and save it on the FirefoxRTCPeerConnection if and only if
 *
 *   1. A DTLS role was not already saved on the FirefoxRTCPeerConnection, and
 *   2. The description is an answer.
 *
 * @private
 * @param {FirefoxRTCPeerConnection} peerConnection
 * @param {RTCSessionDescription} description
 * @param {boolean} [remote=false] - if true, save the inverse of the DTLS role,
 *   e.g. "active" instead of "passive" and vice versa
 * @returns {undefined}
 */function saveInitiallyNegotiatedDtlsRole(peerConnection,description,remote){// NOTE(mroberts): JSEP specifies that offers always offer "actpass" as the
// DTLS role. We need to inspect answers to figure out the negotiated DTLS
// role.
if(peerConnection._initiallyNegotiatedDtlsRole||description.type==='offer'){return;}var match=description.sdp.match(/a=setup:([a-z]+)/);if(!match){return;}var dtlsRole=match[1];peerConnection._initiallyNegotiatedDtlsRole=remote?{active:'passive',passive:'active'}[dtlsRole]:dtlsRole;}/**
 * Overwrite the DTLS role in the sdp property of an RTCSessionDescription if
 * and only if
 *
 *   1. The description is an answer, and
 *   2. A DTLS role is provided.
 *
 * @private
 * @param {RTCSessionDescription} [description]
 * @param {string} [dtlsRole] - one of "active" or "passive"
 * @returns {?RTCSessionDescription} description
 */function overwriteWithInitiallyNegotiatedDtlsRole(description,dtlsRole){if(description&&description.type==='answer'&&dtlsRole){description.sdp=description.sdp.replace(/a=setup:[a-z]+/g,'a=setup:'+dtlsRole);}return description;}module.exports=FirefoxRTCPeerConnection;},{"../../eventtarget":5,"../../util":51,"../rtcsessiondescription/firefox":65,"util":109}],63:[function(require,module,exports){/* globals mozRTCPeerConnection, RTCPeerConnection, webkitRTCPeerConnection */'use strict';if(typeof webkitRTCPeerConnection!=='undefined'){module.exports=require('./chrome');}else if(typeof mozRTCPeerConnection!=='undefined'){module.exports=require('./firefox');}else if(typeof RTCPeerConnection!=='undefined'){module.exports=RTCPeerConnection;}},{"./chrome":61,"./firefox":62}],64:[function(require,module,exports){/* globals RTCSessionDescription */'use strict';// This class wraps Chrome's RTCSessionDescription implementation. It provides
// one piece of functionality not currently present in Chrome, namely
//
//   1. Rollback support
//      https://bugs.chromium.org/p/webrtc/issues/detail?id=4676
//
function ChromeRTCSessionDescription(descriptionInitDict){if(!(this instanceof ChromeRTCSessionDescription)){return new ChromeRTCSessionDescription(descriptionInitDict);}// If this constructor is called with an object with a .type property set to
// "rollback", we should not call Chrome's RTCSessionDescription constructor,
// because this would throw an RTCSdpType error.
var description=descriptionInitDict&&descriptionInitDict.type==='rollback'?null:new RTCSessionDescription(descriptionInitDict);var type=description?null:'rollback';var sdp=descriptionInitDict.sdp;Object.defineProperties(this,{_description:{get:function get(){return description;}},// The .sdp property of an RTCSessionDescription can be updated. If we have
// an underlying RTCSessionDescription, update that with a setter. (If not,
// the user is able to set a property on the ChromeRTCSessionDescription
// directly.)
sdp:{enumerable:true,get:function get(){return description?description.sdp:sdp;},set:function set(_sdp){if(description){description.sdp=_sdp;return;}sdp=_sdp;}},// The .type property of an RTCSessionDescription can be updated. If we have
// an underlying RTCSessionDescription, update that with the setter. If not,
// just update a type variable.
type:{enumerable:true,get:function get(){return description?description.type:type;},set:function set(_type){if(_type==='rollback'&&description){var sdp=description.sdp;description=null;this.sdp=sdp;}else if(description){description.type=_type;return;}else if(['offer','answer','pranswer','rollback'].indexOf(_type)===-1){// Chrome will reject setting .type to an invalid RTCSdpType. We
// emulate that here, adding support for "rollback".
return;}type=_type;}}});}module.exports=ChromeRTCSessionDescription;},{}],65:[function(require,module,exports){/* globals mozRTCSessionDescription */'use strict';module.exports=mozRTCSessionDescription;},{}],66:[function(require,module,exports){/* globals mozRTCSessionDescription, RTCSessionDescription, webkitRTCPeerConnection */'use strict';if(typeof webkitRTCPeerConnection!=='undefined'){module.exports=require('./chrome');}else if(typeof mozRTCSessionDescription!=='undefined'){module.exports=require('./firefox');}else if(typeof RTCSessionDescription!=='undefined'){module.exports=RTCSessionDescription;}},{"./chrome":64,"./firefox":65}],67:[function(require,module,exports){var lookup='ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/';;(function(exports){'use strict';var Arr=typeof Uint8Array!=='undefined'?Uint8Array:Array;var PLUS='+'.charCodeAt(0);var SLASH='/'.charCodeAt(0);var NUMBER='0'.charCodeAt(0);var LOWER='a'.charCodeAt(0);var UPPER='A'.charCodeAt(0);var PLUS_URL_SAFE='-'.charCodeAt(0);var SLASH_URL_SAFE='_'.charCodeAt(0);function decode(elt){var code=elt.charCodeAt(0);if(code===PLUS||code===PLUS_URL_SAFE)return 62;// '+'
if(code===SLASH||code===SLASH_URL_SAFE)return 63;// '/'
if(code<NUMBER)return-1;//no match
if(code<NUMBER+10)return code-NUMBER+26+26;if(code<UPPER+26)return code-UPPER;if(code<LOWER+26)return code-LOWER+26;}function b64ToByteArray(b64){var i,j,l,tmp,placeHolders,arr;if(b64.length%4>0){throw new Error('Invalid string. Length must be a multiple of 4');}// the number of equal signs (place holders)
// if there are two placeholders, than the two characters before it
// represent one byte
// if there is only one, then the three characters before it represent 2 bytes
// this is just a cheap hack to not do indexOf twice
var len=b64.length;placeHolders='='===b64.charAt(len-2)?2:'='===b64.charAt(len-1)?1:0;// base64 is 4/3 + up to two characters of the original data
arr=new Arr(b64.length*3/4-placeHolders);// if there are placeholders, only get up to the last complete 4 chars
l=placeHolders>0?b64.length-4:b64.length;var L=0;function push(v){arr[L++]=v;}for(i=0,j=0;i<l;i+=4,j+=3){tmp=decode(b64.charAt(i))<<18|decode(b64.charAt(i+1))<<12|decode(b64.charAt(i+2))<<6|decode(b64.charAt(i+3));push((tmp&0xFF0000)>>16);push((tmp&0xFF00)>>8);push(tmp&0xFF);}if(placeHolders===2){tmp=decode(b64.charAt(i))<<2|decode(b64.charAt(i+1))>>4;push(tmp&0xFF);}else if(placeHolders===1){tmp=decode(b64.charAt(i))<<10|decode(b64.charAt(i+1))<<4|decode(b64.charAt(i+2))>>2;push(tmp>>8&0xFF);push(tmp&0xFF);}return arr;}function uint8ToBase64(uint8){var i,extraBytes=uint8.length%3,// if we have 1 byte left, pad 2 bytes
output="",temp,length;function encode(num){return lookup.charAt(num);}function tripletToBase64(num){return encode(num>>18&0x3F)+encode(num>>12&0x3F)+encode(num>>6&0x3F)+encode(num&0x3F);}// go through the array every three bytes, we'll deal with trailing stuff later
for(i=0,length=uint8.length-extraBytes;i<length;i+=3){temp=(uint8[i]<<16)+(uint8[i+1]<<8)+uint8[i+2];output+=tripletToBase64(temp);}// pad the end with zeros, but make sure to not forget the extra bytes
switch(extraBytes){case 1:temp=uint8[uint8.length-1];output+=encode(temp>>2);output+=encode(temp<<4&0x3F);output+='==';break;case 2:temp=(uint8[uint8.length-2]<<8)+uint8[uint8.length-1];output+=encode(temp>>10);output+=encode(temp>>4&0x3F);output+=encode(temp<<2&0x3F);output+='=';break;}return output;}exports.toByteArray=b64ToByteArray;exports.fromByteArray=uint8ToBase64;})(typeof exports==='undefined'?this.base64js={}:exports);},{}],68:[function(require,module,exports){(function(global){/*!
 * The buffer module from node.js, for the browser.
 *
 * @author   Feross Aboukhadijeh <feross@feross.org> <http://feross.org>
 * @license  MIT
 *//* eslint-disable no-proto */'use strict';var base64=require('base64-js');var ieee754=require('ieee754');var isArray=require('isarray');exports.Buffer=Buffer;exports.SlowBuffer=SlowBuffer;exports.INSPECT_MAX_BYTES=50;Buffer.poolSize=8192;// not used by this implementation
var rootParent={};/**
 * If `Buffer.TYPED_ARRAY_SUPPORT`:
 *   === true    Use Uint8Array implementation (fastest)
 *   === false   Use Object implementation (most compatible, even IE6)
 *
 * Browsers that support typed arrays are IE 10+, Firefox 4+, Chrome 7+, Safari 5.1+,
 * Opera 11.6+, iOS 4.2+.
 *
 * Due to various browser bugs, sometimes the Object implementation will be used even
 * when the browser supports typed arrays.
 *
 * Note:
 *
 *   - Firefox 4-29 lacks support for adding new properties to `Uint8Array` instances,
 *     See: https://bugzilla.mozilla.org/show_bug.cgi?id=695438.
 *
 *   - Safari 5-7 lacks support for changing the `Object.prototype.constructor` property
 *     on objects.
 *
 *   - Chrome 9-10 is missing the `TypedArray.prototype.subarray` function.
 *
 *   - IE10 has a broken `TypedArray.prototype.subarray` function which returns arrays of
 *     incorrect length in some situations.

 * We detect these buggy browsers and set `Buffer.TYPED_ARRAY_SUPPORT` to `false` so they
 * get the Object implementation, which is slower but behaves correctly.
 */Buffer.TYPED_ARRAY_SUPPORT=global.TYPED_ARRAY_SUPPORT!==undefined?global.TYPED_ARRAY_SUPPORT:typedArraySupport();function typedArraySupport(){function Bar(){}try{var arr=new Uint8Array(1);arr.foo=function(){return 42;};arr.constructor=Bar;return arr.foo()===42&&// typed array instances can be augmented
arr.constructor===Bar&&// constructor can be set
typeof arr.subarray==='function'&&// chrome 9-10 lack `subarray`
arr.subarray(1,1).byteLength===0;// ie10 has broken `subarray`
}catch(e){return false;}}function kMaxLength(){return Buffer.TYPED_ARRAY_SUPPORT?0x7fffffff:0x3fffffff;}/**
 * Class: Buffer
 * =============
 *
 * The Buffer constructor returns instances of `Uint8Array` that are augmented
 * with function properties for all the node `Buffer` API functions. We use
 * `Uint8Array` so that square bracket notation works as expected -- it returns
 * a single octet.
 *
 * By augmenting the instances, we can avoid modifying the `Uint8Array`
 * prototype.
 */function Buffer(arg){if(!(this instanceof Buffer)){// Avoid going through an ArgumentsAdaptorTrampoline in the common case.
if(arguments.length>1)return new Buffer(arg,arguments[1]);return new Buffer(arg);}if(!Buffer.TYPED_ARRAY_SUPPORT){this.length=0;this.parent=undefined;}// Common case.
if(typeof arg==='number'){return fromNumber(this,arg);}// Slightly less common case.
if(typeof arg==='string'){return fromString(this,arg,arguments.length>1?arguments[1]:'utf8');}// Unusual.
return fromObject(this,arg);}function fromNumber(that,length){that=allocate(that,length<0?0:checked(length)|0);if(!Buffer.TYPED_ARRAY_SUPPORT){for(var i=0;i<length;i++){that[i]=0;}}return that;}function fromString(that,string,encoding){if(typeof encoding!=='string'||encoding==='')encoding='utf8';// Assumption: byteLength() return value is always < kMaxLength.
var length=byteLength(string,encoding)|0;that=allocate(that,length);that.write(string,encoding);return that;}function fromObject(that,object){if(Buffer.isBuffer(object))return fromBuffer(that,object);if(isArray(object))return fromArray(that,object);if(object==null){throw new TypeError('must start with number, buffer, array or string');}if(typeof ArrayBuffer!=='undefined'){if(object.buffer instanceof ArrayBuffer){return fromTypedArray(that,object);}if(object instanceof ArrayBuffer){return fromArrayBuffer(that,object);}}if(object.length)return fromArrayLike(that,object);return fromJsonObject(that,object);}function fromBuffer(that,buffer){var length=checked(buffer.length)|0;that=allocate(that,length);buffer.copy(that,0,0,length);return that;}function fromArray(that,array){var length=checked(array.length)|0;that=allocate(that,length);for(var i=0;i<length;i+=1){that[i]=array[i]&255;}return that;}// Duplicate of fromArray() to keep fromArray() monomorphic.
function fromTypedArray(that,array){var length=checked(array.length)|0;that=allocate(that,length);// Truncating the elements is probably not what people expect from typed
// arrays with BYTES_PER_ELEMENT > 1 but it's compatible with the behavior
// of the old Buffer constructor.
for(var i=0;i<length;i+=1){that[i]=array[i]&255;}return that;}function fromArrayBuffer(that,array){if(Buffer.TYPED_ARRAY_SUPPORT){// Return an augmented `Uint8Array` instance, for best performance
array.byteLength;that=Buffer._augment(new Uint8Array(array));}else{// Fallback: Return an object instance of the Buffer class
that=fromTypedArray(that,new Uint8Array(array));}return that;}function fromArrayLike(that,array){var length=checked(array.length)|0;that=allocate(that,length);for(var i=0;i<length;i+=1){that[i]=array[i]&255;}return that;}// Deserialize { type: 'Buffer', data: [1,2,3,...] } into a Buffer object.
// Returns a zero-length buffer for inputs that don't conform to the spec.
function fromJsonObject(that,object){var array;var length=0;if(object.type==='Buffer'&&isArray(object.data)){array=object.data;length=checked(array.length)|0;}that=allocate(that,length);for(var i=0;i<length;i+=1){that[i]=array[i]&255;}return that;}if(Buffer.TYPED_ARRAY_SUPPORT){Buffer.prototype.__proto__=Uint8Array.prototype;Buffer.__proto__=Uint8Array;}else{// pre-set for values that may exist in the future
Buffer.prototype.length=undefined;Buffer.prototype.parent=undefined;}function allocate(that,length){if(Buffer.TYPED_ARRAY_SUPPORT){// Return an augmented `Uint8Array` instance, for best performance
that=Buffer._augment(new Uint8Array(length));that.__proto__=Buffer.prototype;}else{// Fallback: Return an object instance of the Buffer class
that.length=length;that._isBuffer=true;}var fromPool=length!==0&&length<=Buffer.poolSize>>>1;if(fromPool)that.parent=rootParent;return that;}function checked(length){// Note: cannot use `length < kMaxLength` here because that fails when
// length is NaN (which is otherwise coerced to zero.)
if(length>=kMaxLength()){throw new RangeError('Attempt to allocate Buffer larger than maximum '+'size: 0x'+kMaxLength().toString(16)+' bytes');}return length|0;}function SlowBuffer(subject,encoding){if(!(this instanceof SlowBuffer))return new SlowBuffer(subject,encoding);var buf=new Buffer(subject,encoding);delete buf.parent;return buf;}Buffer.isBuffer=function isBuffer(b){return!!(b!=null&&b._isBuffer);};Buffer.compare=function compare(a,b){if(!Buffer.isBuffer(a)||!Buffer.isBuffer(b)){throw new TypeError('Arguments must be Buffers');}if(a===b)return 0;var x=a.length;var y=b.length;var i=0;var len=Math.min(x,y);while(i<len){if(a[i]!==b[i])break;++i;}if(i!==len){x=a[i];y=b[i];}if(x<y)return-1;if(y<x)return 1;return 0;};Buffer.isEncoding=function isEncoding(encoding){switch(String(encoding).toLowerCase()){case'hex':case'utf8':case'utf-8':case'ascii':case'binary':case'base64':case'raw':case'ucs2':case'ucs-2':case'utf16le':case'utf-16le':return true;default:return false;}};Buffer.concat=function concat(list,length){if(!isArray(list))throw new TypeError('list argument must be an Array of Buffers.');if(list.length===0){return new Buffer(0);}var i;if(length===undefined){length=0;for(i=0;i<list.length;i++){length+=list[i].length;}}var buf=new Buffer(length);var pos=0;for(i=0;i<list.length;i++){var item=list[i];item.copy(buf,pos);pos+=item.length;}return buf;};function byteLength(string,encoding){if(typeof string!=='string')string=''+string;var len=string.length;if(len===0)return 0;// Use a for loop to avoid recursion
var loweredCase=false;for(;;){switch(encoding){case'ascii':case'binary':// Deprecated
case'raw':case'raws':return len;case'utf8':case'utf-8':return utf8ToBytes(string).length;case'ucs2':case'ucs-2':case'utf16le':case'utf-16le':return len*2;case'hex':return len>>>1;case'base64':return base64ToBytes(string).length;default:if(loweredCase)return utf8ToBytes(string).length;// assume utf8
encoding=(''+encoding).toLowerCase();loweredCase=true;}}}Buffer.byteLength=byteLength;function slowToString(encoding,start,end){var loweredCase=false;start=start|0;end=end===undefined||end===Infinity?this.length:end|0;if(!encoding)encoding='utf8';if(start<0)start=0;if(end>this.length)end=this.length;if(end<=start)return'';while(true){switch(encoding){case'hex':return hexSlice(this,start,end);case'utf8':case'utf-8':return utf8Slice(this,start,end);case'ascii':return asciiSlice(this,start,end);case'binary':return binarySlice(this,start,end);case'base64':return base64Slice(this,start,end);case'ucs2':case'ucs-2':case'utf16le':case'utf-16le':return utf16leSlice(this,start,end);default:if(loweredCase)throw new TypeError('Unknown encoding: '+encoding);encoding=(encoding+'').toLowerCase();loweredCase=true;}}}Buffer.prototype.toString=function toString(){var length=this.length|0;if(length===0)return'';if(arguments.length===0)return utf8Slice(this,0,length);return slowToString.apply(this,arguments);};Buffer.prototype.equals=function equals(b){if(!Buffer.isBuffer(b))throw new TypeError('Argument must be a Buffer');if(this===b)return true;return Buffer.compare(this,b)===0;};Buffer.prototype.inspect=function inspect(){var str='';var max=exports.INSPECT_MAX_BYTES;if(this.length>0){str=this.toString('hex',0,max).match(/.{2}/g).join(' ');if(this.length>max)str+=' ... ';}return'<Buffer '+str+'>';};Buffer.prototype.compare=function compare(b){if(!Buffer.isBuffer(b))throw new TypeError('Argument must be a Buffer');if(this===b)return 0;return Buffer.compare(this,b);};Buffer.prototype.indexOf=function indexOf(val,byteOffset){if(byteOffset>0x7fffffff)byteOffset=0x7fffffff;else if(byteOffset<-0x80000000)byteOffset=-0x80000000;byteOffset>>=0;if(this.length===0)return-1;if(byteOffset>=this.length)return-1;// Negative offsets start from the end of the buffer
if(byteOffset<0)byteOffset=Math.max(this.length+byteOffset,0);if(typeof val==='string'){if(val.length===0)return-1;// special case: looking for empty string always fails
return String.prototype.indexOf.call(this,val,byteOffset);}if(Buffer.isBuffer(val)){return arrayIndexOf(this,val,byteOffset);}if(typeof val==='number'){if(Buffer.TYPED_ARRAY_SUPPORT&&Uint8Array.prototype.indexOf==='function'){return Uint8Array.prototype.indexOf.call(this,val,byteOffset);}return arrayIndexOf(this,[val],byteOffset);}function arrayIndexOf(arr,val,byteOffset){var foundIndex=-1;for(var i=0;byteOffset+i<arr.length;i++){if(arr[byteOffset+i]===val[foundIndex===-1?0:i-foundIndex]){if(foundIndex===-1)foundIndex=i;if(i-foundIndex+1===val.length)return byteOffset+foundIndex;}else{foundIndex=-1;}}return-1;}throw new TypeError('val must be string, number or Buffer');};// `get` is deprecated
Buffer.prototype.get=function get(offset){console.log('.get() is deprecated. Access using array indexes instead.');return this.readUInt8(offset);};// `set` is deprecated
Buffer.prototype.set=function set(v,offset){console.log('.set() is deprecated. Access using array indexes instead.');return this.writeUInt8(v,offset);};function hexWrite(buf,string,offset,length){offset=Number(offset)||0;var remaining=buf.length-offset;if(!length){length=remaining;}else{length=Number(length);if(length>remaining){length=remaining;}}// must be an even number of digits
var strLen=string.length;if(strLen%2!==0)throw new Error('Invalid hex string');if(length>strLen/2){length=strLen/2;}for(var i=0;i<length;i++){var parsed=parseInt(string.substr(i*2,2),16);if(isNaN(parsed))throw new Error('Invalid hex string');buf[offset+i]=parsed;}return i;}function utf8Write(buf,string,offset,length){return blitBuffer(utf8ToBytes(string,buf.length-offset),buf,offset,length);}function asciiWrite(buf,string,offset,length){return blitBuffer(asciiToBytes(string),buf,offset,length);}function binaryWrite(buf,string,offset,length){return asciiWrite(buf,string,offset,length);}function base64Write(buf,string,offset,length){return blitBuffer(base64ToBytes(string),buf,offset,length);}function ucs2Write(buf,string,offset,length){return blitBuffer(utf16leToBytes(string,buf.length-offset),buf,offset,length);}Buffer.prototype.write=function write(string,offset,length,encoding){// Buffer#write(string)
if(offset===undefined){encoding='utf8';length=this.length;offset=0;// Buffer#write(string, encoding)
}else if(length===undefined&&typeof offset==='string'){encoding=offset;length=this.length;offset=0;// Buffer#write(string, offset[, length][, encoding])
}else if(isFinite(offset)){offset=offset|0;if(isFinite(length)){length=length|0;if(encoding===undefined)encoding='utf8';}else{encoding=length;length=undefined;}// legacy write(string, encoding, offset, length) - remove in v0.13
}else{var swap=encoding;encoding=offset;offset=length|0;length=swap;}var remaining=this.length-offset;if(length===undefined||length>remaining)length=remaining;if(string.length>0&&(length<0||offset<0)||offset>this.length){throw new RangeError('attempt to write outside buffer bounds');}if(!encoding)encoding='utf8';var loweredCase=false;for(;;){switch(encoding){case'hex':return hexWrite(this,string,offset,length);case'utf8':case'utf-8':return utf8Write(this,string,offset,length);case'ascii':return asciiWrite(this,string,offset,length);case'binary':return binaryWrite(this,string,offset,length);case'base64':// Warning: maxLength not taken into account in base64Write
return base64Write(this,string,offset,length);case'ucs2':case'ucs-2':case'utf16le':case'utf-16le':return ucs2Write(this,string,offset,length);default:if(loweredCase)throw new TypeError('Unknown encoding: '+encoding);encoding=(''+encoding).toLowerCase();loweredCase=true;}}};Buffer.prototype.toJSON=function toJSON(){return{type:'Buffer',data:Array.prototype.slice.call(this._arr||this,0)};};function base64Slice(buf,start,end){if(start===0&&end===buf.length){return base64.fromByteArray(buf);}else{return base64.fromByteArray(buf.slice(start,end));}}function utf8Slice(buf,start,end){end=Math.min(buf.length,end);var res=[];var i=start;while(i<end){var firstByte=buf[i];var codePoint=null;var bytesPerSequence=firstByte>0xEF?4:firstByte>0xDF?3:firstByte>0xBF?2:1;if(i+bytesPerSequence<=end){var secondByte,thirdByte,fourthByte,tempCodePoint;switch(bytesPerSequence){case 1:if(firstByte<0x80){codePoint=firstByte;}break;case 2:secondByte=buf[i+1];if((secondByte&0xC0)===0x80){tempCodePoint=(firstByte&0x1F)<<0x6|secondByte&0x3F;if(tempCodePoint>0x7F){codePoint=tempCodePoint;}}break;case 3:secondByte=buf[i+1];thirdByte=buf[i+2];if((secondByte&0xC0)===0x80&&(thirdByte&0xC0)===0x80){tempCodePoint=(firstByte&0xF)<<0xC|(secondByte&0x3F)<<0x6|thirdByte&0x3F;if(tempCodePoint>0x7FF&&(tempCodePoint<0xD800||tempCodePoint>0xDFFF)){codePoint=tempCodePoint;}}break;case 4:secondByte=buf[i+1];thirdByte=buf[i+2];fourthByte=buf[i+3];if((secondByte&0xC0)===0x80&&(thirdByte&0xC0)===0x80&&(fourthByte&0xC0)===0x80){tempCodePoint=(firstByte&0xF)<<0x12|(secondByte&0x3F)<<0xC|(thirdByte&0x3F)<<0x6|fourthByte&0x3F;if(tempCodePoint>0xFFFF&&tempCodePoint<0x110000){codePoint=tempCodePoint;}}}}if(codePoint===null){// we did not generate a valid codePoint so insert a
// replacement char (U+FFFD) and advance only 1 byte
codePoint=0xFFFD;bytesPerSequence=1;}else if(codePoint>0xFFFF){// encode to utf16 (surrogate pair dance)
codePoint-=0x10000;res.push(codePoint>>>10&0x3FF|0xD800);codePoint=0xDC00|codePoint&0x3FF;}res.push(codePoint);i+=bytesPerSequence;}return decodeCodePointsArray(res);}// Based on http://stackoverflow.com/a/22747272/680742, the browser with
// the lowest limit is Chrome, with 0x10000 args.
// We go 1 magnitude less, for safety
var MAX_ARGUMENTS_LENGTH=0x1000;function decodeCodePointsArray(codePoints){var len=codePoints.length;if(len<=MAX_ARGUMENTS_LENGTH){return String.fromCharCode.apply(String,codePoints);// avoid extra slice()
}// Decode in chunks to avoid "call stack size exceeded".
var res='';var i=0;while(i<len){res+=String.fromCharCode.apply(String,codePoints.slice(i,i+=MAX_ARGUMENTS_LENGTH));}return res;}function asciiSlice(buf,start,end){var ret='';end=Math.min(buf.length,end);for(var i=start;i<end;i++){ret+=String.fromCharCode(buf[i]&0x7F);}return ret;}function binarySlice(buf,start,end){var ret='';end=Math.min(buf.length,end);for(var i=start;i<end;i++){ret+=String.fromCharCode(buf[i]);}return ret;}function hexSlice(buf,start,end){var len=buf.length;if(!start||start<0)start=0;if(!end||end<0||end>len)end=len;var out='';for(var i=start;i<end;i++){out+=toHex(buf[i]);}return out;}function utf16leSlice(buf,start,end){var bytes=buf.slice(start,end);var res='';for(var i=0;i<bytes.length;i+=2){res+=String.fromCharCode(bytes[i]+bytes[i+1]*256);}return res;}Buffer.prototype.slice=function slice(start,end){var len=this.length;start=~~start;end=end===undefined?len:~~end;if(start<0){start+=len;if(start<0)start=0;}else if(start>len){start=len;}if(end<0){end+=len;if(end<0)end=0;}else if(end>len){end=len;}if(end<start)end=start;var newBuf;if(Buffer.TYPED_ARRAY_SUPPORT){newBuf=Buffer._augment(this.subarray(start,end));}else{var sliceLen=end-start;newBuf=new Buffer(sliceLen,undefined);for(var i=0;i<sliceLen;i++){newBuf[i]=this[i+start];}}if(newBuf.length)newBuf.parent=this.parent||this;return newBuf;};/*
 * Need to make sure that buffer isn't trying to write out of bounds.
 */function checkOffset(offset,ext,length){if(offset%1!==0||offset<0)throw new RangeError('offset is not uint');if(offset+ext>length)throw new RangeError('Trying to access beyond buffer length');}Buffer.prototype.readUIntLE=function readUIntLE(offset,byteLength,noAssert){offset=offset|0;byteLength=byteLength|0;if(!noAssert)checkOffset(offset,byteLength,this.length);var val=this[offset];var mul=1;var i=0;while(++i<byteLength&&(mul*=0x100)){val+=this[offset+i]*mul;}return val;};Buffer.prototype.readUIntBE=function readUIntBE(offset,byteLength,noAssert){offset=offset|0;byteLength=byteLength|0;if(!noAssert){checkOffset(offset,byteLength,this.length);}var val=this[offset+--byteLength];var mul=1;while(byteLength>0&&(mul*=0x100)){val+=this[offset+--byteLength]*mul;}return val;};Buffer.prototype.readUInt8=function readUInt8(offset,noAssert){if(!noAssert)checkOffset(offset,1,this.length);return this[offset];};Buffer.prototype.readUInt16LE=function readUInt16LE(offset,noAssert){if(!noAssert)checkOffset(offset,2,this.length);return this[offset]|this[offset+1]<<8;};Buffer.prototype.readUInt16BE=function readUInt16BE(offset,noAssert){if(!noAssert)checkOffset(offset,2,this.length);return this[offset]<<8|this[offset+1];};Buffer.prototype.readUInt32LE=function readUInt32LE(offset,noAssert){if(!noAssert)checkOffset(offset,4,this.length);return(this[offset]|this[offset+1]<<8|this[offset+2]<<16)+this[offset+3]*0x1000000;};Buffer.prototype.readUInt32BE=function readUInt32BE(offset,noAssert){if(!noAssert)checkOffset(offset,4,this.length);return this[offset]*0x1000000+(this[offset+1]<<16|this[offset+2]<<8|this[offset+3]);};Buffer.prototype.readIntLE=function readIntLE(offset,byteLength,noAssert){offset=offset|0;byteLength=byteLength|0;if(!noAssert)checkOffset(offset,byteLength,this.length);var val=this[offset];var mul=1;var i=0;while(++i<byteLength&&(mul*=0x100)){val+=this[offset+i]*mul;}mul*=0x80;if(val>=mul)val-=Math.pow(2,8*byteLength);return val;};Buffer.prototype.readIntBE=function readIntBE(offset,byteLength,noAssert){offset=offset|0;byteLength=byteLength|0;if(!noAssert)checkOffset(offset,byteLength,this.length);var i=byteLength;var mul=1;var val=this[offset+--i];while(i>0&&(mul*=0x100)){val+=this[offset+--i]*mul;}mul*=0x80;if(val>=mul)val-=Math.pow(2,8*byteLength);return val;};Buffer.prototype.readInt8=function readInt8(offset,noAssert){if(!noAssert)checkOffset(offset,1,this.length);if(!(this[offset]&0x80))return this[offset];return(0xff-this[offset]+1)*-1;};Buffer.prototype.readInt16LE=function readInt16LE(offset,noAssert){if(!noAssert)checkOffset(offset,2,this.length);var val=this[offset]|this[offset+1]<<8;return val&0x8000?val|0xFFFF0000:val;};Buffer.prototype.readInt16BE=function readInt16BE(offset,noAssert){if(!noAssert)checkOffset(offset,2,this.length);var val=this[offset+1]|this[offset]<<8;return val&0x8000?val|0xFFFF0000:val;};Buffer.prototype.readInt32LE=function readInt32LE(offset,noAssert){if(!noAssert)checkOffset(offset,4,this.length);return this[offset]|this[offset+1]<<8|this[offset+2]<<16|this[offset+3]<<24;};Buffer.prototype.readInt32BE=function readInt32BE(offset,noAssert){if(!noAssert)checkOffset(offset,4,this.length);return this[offset]<<24|this[offset+1]<<16|this[offset+2]<<8|this[offset+3];};Buffer.prototype.readFloatLE=function readFloatLE(offset,noAssert){if(!noAssert)checkOffset(offset,4,this.length);return ieee754.read(this,offset,true,23,4);};Buffer.prototype.readFloatBE=function readFloatBE(offset,noAssert){if(!noAssert)checkOffset(offset,4,this.length);return ieee754.read(this,offset,false,23,4);};Buffer.prototype.readDoubleLE=function readDoubleLE(offset,noAssert){if(!noAssert)checkOffset(offset,8,this.length);return ieee754.read(this,offset,true,52,8);};Buffer.prototype.readDoubleBE=function readDoubleBE(offset,noAssert){if(!noAssert)checkOffset(offset,8,this.length);return ieee754.read(this,offset,false,52,8);};function checkInt(buf,value,offset,ext,max,min){if(!Buffer.isBuffer(buf))throw new TypeError('buffer must be a Buffer instance');if(value>max||value<min)throw new RangeError('value is out of bounds');if(offset+ext>buf.length)throw new RangeError('index out of range');}Buffer.prototype.writeUIntLE=function writeUIntLE(value,offset,byteLength,noAssert){value=+value;offset=offset|0;byteLength=byteLength|0;if(!noAssert)checkInt(this,value,offset,byteLength,Math.pow(2,8*byteLength),0);var mul=1;var i=0;this[offset]=value&0xFF;while(++i<byteLength&&(mul*=0x100)){this[offset+i]=value/mul&0xFF;}return offset+byteLength;};Buffer.prototype.writeUIntBE=function writeUIntBE(value,offset,byteLength,noAssert){value=+value;offset=offset|0;byteLength=byteLength|0;if(!noAssert)checkInt(this,value,offset,byteLength,Math.pow(2,8*byteLength),0);var i=byteLength-1;var mul=1;this[offset+i]=value&0xFF;while(--i>=0&&(mul*=0x100)){this[offset+i]=value/mul&0xFF;}return offset+byteLength;};Buffer.prototype.writeUInt8=function writeUInt8(value,offset,noAssert){value=+value;offset=offset|0;if(!noAssert)checkInt(this,value,offset,1,0xff,0);if(!Buffer.TYPED_ARRAY_SUPPORT)value=Math.floor(value);this[offset]=value&0xff;return offset+1;};function objectWriteUInt16(buf,value,offset,littleEndian){if(value<0)value=0xffff+value+1;for(var i=0,j=Math.min(buf.length-offset,2);i<j;i++){buf[offset+i]=(value&0xff<<8*(littleEndian?i:1-i))>>>(littleEndian?i:1-i)*8;}}Buffer.prototype.writeUInt16LE=function writeUInt16LE(value,offset,noAssert){value=+value;offset=offset|0;if(!noAssert)checkInt(this,value,offset,2,0xffff,0);if(Buffer.TYPED_ARRAY_SUPPORT){this[offset]=value&0xff;this[offset+1]=value>>>8;}else{objectWriteUInt16(this,value,offset,true);}return offset+2;};Buffer.prototype.writeUInt16BE=function writeUInt16BE(value,offset,noAssert){value=+value;offset=offset|0;if(!noAssert)checkInt(this,value,offset,2,0xffff,0);if(Buffer.TYPED_ARRAY_SUPPORT){this[offset]=value>>>8;this[offset+1]=value&0xff;}else{objectWriteUInt16(this,value,offset,false);}return offset+2;};function objectWriteUInt32(buf,value,offset,littleEndian){if(value<0)value=0xffffffff+value+1;for(var i=0,j=Math.min(buf.length-offset,4);i<j;i++){buf[offset+i]=value>>>(littleEndian?i:3-i)*8&0xff;}}Buffer.prototype.writeUInt32LE=function writeUInt32LE(value,offset,noAssert){value=+value;offset=offset|0;if(!noAssert)checkInt(this,value,offset,4,0xffffffff,0);if(Buffer.TYPED_ARRAY_SUPPORT){this[offset+3]=value>>>24;this[offset+2]=value>>>16;this[offset+1]=value>>>8;this[offset]=value&0xff;}else{objectWriteUInt32(this,value,offset,true);}return offset+4;};Buffer.prototype.writeUInt32BE=function writeUInt32BE(value,offset,noAssert){value=+value;offset=offset|0;if(!noAssert)checkInt(this,value,offset,4,0xffffffff,0);if(Buffer.TYPED_ARRAY_SUPPORT){this[offset]=value>>>24;this[offset+1]=value>>>16;this[offset+2]=value>>>8;this[offset+3]=value&0xff;}else{objectWriteUInt32(this,value,offset,false);}return offset+4;};Buffer.prototype.writeIntLE=function writeIntLE(value,offset,byteLength,noAssert){value=+value;offset=offset|0;if(!noAssert){var limit=Math.pow(2,8*byteLength-1);checkInt(this,value,offset,byteLength,limit-1,-limit);}var i=0;var mul=1;var sub=value<0?1:0;this[offset]=value&0xFF;while(++i<byteLength&&(mul*=0x100)){this[offset+i]=(value/mul>>0)-sub&0xFF;}return offset+byteLength;};Buffer.prototype.writeIntBE=function writeIntBE(value,offset,byteLength,noAssert){value=+value;offset=offset|0;if(!noAssert){var limit=Math.pow(2,8*byteLength-1);checkInt(this,value,offset,byteLength,limit-1,-limit);}var i=byteLength-1;var mul=1;var sub=value<0?1:0;this[offset+i]=value&0xFF;while(--i>=0&&(mul*=0x100)){this[offset+i]=(value/mul>>0)-sub&0xFF;}return offset+byteLength;};Buffer.prototype.writeInt8=function writeInt8(value,offset,noAssert){value=+value;offset=offset|0;if(!noAssert)checkInt(this,value,offset,1,0x7f,-0x80);if(!Buffer.TYPED_ARRAY_SUPPORT)value=Math.floor(value);if(value<0)value=0xff+value+1;this[offset]=value&0xff;return offset+1;};Buffer.prototype.writeInt16LE=function writeInt16LE(value,offset,noAssert){value=+value;offset=offset|0;if(!noAssert)checkInt(this,value,offset,2,0x7fff,-0x8000);if(Buffer.TYPED_ARRAY_SUPPORT){this[offset]=value&0xff;this[offset+1]=value>>>8;}else{objectWriteUInt16(this,value,offset,true);}return offset+2;};Buffer.prototype.writeInt16BE=function writeInt16BE(value,offset,noAssert){value=+value;offset=offset|0;if(!noAssert)checkInt(this,value,offset,2,0x7fff,-0x8000);if(Buffer.TYPED_ARRAY_SUPPORT){this[offset]=value>>>8;this[offset+1]=value&0xff;}else{objectWriteUInt16(this,value,offset,false);}return offset+2;};Buffer.prototype.writeInt32LE=function writeInt32LE(value,offset,noAssert){value=+value;offset=offset|0;if(!noAssert)checkInt(this,value,offset,4,0x7fffffff,-0x80000000);if(Buffer.TYPED_ARRAY_SUPPORT){this[offset]=value&0xff;this[offset+1]=value>>>8;this[offset+2]=value>>>16;this[offset+3]=value>>>24;}else{objectWriteUInt32(this,value,offset,true);}return offset+4;};Buffer.prototype.writeInt32BE=function writeInt32BE(value,offset,noAssert){value=+value;offset=offset|0;if(!noAssert)checkInt(this,value,offset,4,0x7fffffff,-0x80000000);if(value<0)value=0xffffffff+value+1;if(Buffer.TYPED_ARRAY_SUPPORT){this[offset]=value>>>24;this[offset+1]=value>>>16;this[offset+2]=value>>>8;this[offset+3]=value&0xff;}else{objectWriteUInt32(this,value,offset,false);}return offset+4;};function checkIEEE754(buf,value,offset,ext,max,min){if(value>max||value<min)throw new RangeError('value is out of bounds');if(offset+ext>buf.length)throw new RangeError('index out of range');if(offset<0)throw new RangeError('index out of range');}function writeFloat(buf,value,offset,littleEndian,noAssert){if(!noAssert){checkIEEE754(buf,value,offset,4,3.4028234663852886e+38,-3.4028234663852886e+38);}ieee754.write(buf,value,offset,littleEndian,23,4);return offset+4;}Buffer.prototype.writeFloatLE=function writeFloatLE(value,offset,noAssert){return writeFloat(this,value,offset,true,noAssert);};Buffer.prototype.writeFloatBE=function writeFloatBE(value,offset,noAssert){return writeFloat(this,value,offset,false,noAssert);};function writeDouble(buf,value,offset,littleEndian,noAssert){if(!noAssert){checkIEEE754(buf,value,offset,8,1.7976931348623157E+308,-1.7976931348623157E+308);}ieee754.write(buf,value,offset,littleEndian,52,8);return offset+8;}Buffer.prototype.writeDoubleLE=function writeDoubleLE(value,offset,noAssert){return writeDouble(this,value,offset,true,noAssert);};Buffer.prototype.writeDoubleBE=function writeDoubleBE(value,offset,noAssert){return writeDouble(this,value,offset,false,noAssert);};// copy(targetBuffer, targetStart=0, sourceStart=0, sourceEnd=buffer.length)
Buffer.prototype.copy=function copy(target,targetStart,start,end){if(!start)start=0;if(!end&&end!==0)end=this.length;if(targetStart>=target.length)targetStart=target.length;if(!targetStart)targetStart=0;if(end>0&&end<start)end=start;// Copy 0 bytes; we're done
if(end===start)return 0;if(target.length===0||this.length===0)return 0;// Fatal error conditions
if(targetStart<0){throw new RangeError('targetStart out of bounds');}if(start<0||start>=this.length)throw new RangeError('sourceStart out of bounds');if(end<0)throw new RangeError('sourceEnd out of bounds');// Are we oob?
if(end>this.length)end=this.length;if(target.length-targetStart<end-start){end=target.length-targetStart+start;}var len=end-start;var i;if(this===target&&start<targetStart&&targetStart<end){// descending copy from end
for(i=len-1;i>=0;i--){target[i+targetStart]=this[i+start];}}else if(len<1000||!Buffer.TYPED_ARRAY_SUPPORT){// ascending copy from start
for(i=0;i<len;i++){target[i+targetStart]=this[i+start];}}else{target._set(this.subarray(start,start+len),targetStart);}return len;};// fill(value, start=0, end=buffer.length)
Buffer.prototype.fill=function fill(value,start,end){if(!value)value=0;if(!start)start=0;if(!end)end=this.length;if(end<start)throw new RangeError('end < start');// Fill 0 bytes; we're done
if(end===start)return;if(this.length===0)return;if(start<0||start>=this.length)throw new RangeError('start out of bounds');if(end<0||end>this.length)throw new RangeError('end out of bounds');var i;if(typeof value==='number'){for(i=start;i<end;i++){this[i]=value;}}else{var bytes=utf8ToBytes(value.toString());var len=bytes.length;for(i=start;i<end;i++){this[i]=bytes[i%len];}}return this;};/**
 * Creates a new `ArrayBuffer` with the *copied* memory of the buffer instance.
 * Added in Node 0.12. Only available in browsers that support ArrayBuffer.
 */Buffer.prototype.toArrayBuffer=function toArrayBuffer(){if(typeof Uint8Array!=='undefined'){if(Buffer.TYPED_ARRAY_SUPPORT){return new Buffer(this).buffer;}else{var buf=new Uint8Array(this.length);for(var i=0,len=buf.length;i<len;i+=1){buf[i]=this[i];}return buf.buffer;}}else{throw new TypeError('Buffer.toArrayBuffer not supported in this browser');}};// HELPER FUNCTIONS
// ================
var BP=Buffer.prototype;/**
 * Augment a Uint8Array *instance* (not the Uint8Array class!) with Buffer methods
 */Buffer._augment=function _augment(arr){arr.constructor=Buffer;arr._isBuffer=true;// save reference to original Uint8Array set method before overwriting
arr._set=arr.set;// deprecated
arr.get=BP.get;arr.set=BP.set;arr.write=BP.write;arr.toString=BP.toString;arr.toLocaleString=BP.toString;arr.toJSON=BP.toJSON;arr.equals=BP.equals;arr.compare=BP.compare;arr.indexOf=BP.indexOf;arr.copy=BP.copy;arr.slice=BP.slice;arr.readUIntLE=BP.readUIntLE;arr.readUIntBE=BP.readUIntBE;arr.readUInt8=BP.readUInt8;arr.readUInt16LE=BP.readUInt16LE;arr.readUInt16BE=BP.readUInt16BE;arr.readUInt32LE=BP.readUInt32LE;arr.readUInt32BE=BP.readUInt32BE;arr.readIntLE=BP.readIntLE;arr.readIntBE=BP.readIntBE;arr.readInt8=BP.readInt8;arr.readInt16LE=BP.readInt16LE;arr.readInt16BE=BP.readInt16BE;arr.readInt32LE=BP.readInt32LE;arr.readInt32BE=BP.readInt32BE;arr.readFloatLE=BP.readFloatLE;arr.readFloatBE=BP.readFloatBE;arr.readDoubleLE=BP.readDoubleLE;arr.readDoubleBE=BP.readDoubleBE;arr.writeUInt8=BP.writeUInt8;arr.writeUIntLE=BP.writeUIntLE;arr.writeUIntBE=BP.writeUIntBE;arr.writeUInt16LE=BP.writeUInt16LE;arr.writeUInt16BE=BP.writeUInt16BE;arr.writeUInt32LE=BP.writeUInt32LE;arr.writeUInt32BE=BP.writeUInt32BE;arr.writeIntLE=BP.writeIntLE;arr.writeIntBE=BP.writeIntBE;arr.writeInt8=BP.writeInt8;arr.writeInt16LE=BP.writeInt16LE;arr.writeInt16BE=BP.writeInt16BE;arr.writeInt32LE=BP.writeInt32LE;arr.writeInt32BE=BP.writeInt32BE;arr.writeFloatLE=BP.writeFloatLE;arr.writeFloatBE=BP.writeFloatBE;arr.writeDoubleLE=BP.writeDoubleLE;arr.writeDoubleBE=BP.writeDoubleBE;arr.fill=BP.fill;arr.inspect=BP.inspect;arr.toArrayBuffer=BP.toArrayBuffer;return arr;};var INVALID_BASE64_RE=/[^+\/0-9A-Za-z-_]/g;function base64clean(str){// Node strips out invalid characters like \n and \t from the string, base64-js does not
str=stringtrim(str).replace(INVALID_BASE64_RE,'');// Node converts strings with length < 2 to ''
if(str.length<2)return'';// Node allows for non-padded base64 strings (missing trailing ===), base64-js does not
while(str.length%4!==0){str=str+'=';}return str;}function stringtrim(str){if(str.trim)return str.trim();return str.replace(/^\s+|\s+$/g,'');}function toHex(n){if(n<16)return'0'+n.toString(16);return n.toString(16);}function utf8ToBytes(string,units){units=units||Infinity;var codePoint;var length=string.length;var leadSurrogate=null;var bytes=[];for(var i=0;i<length;i++){codePoint=string.charCodeAt(i);// is surrogate component
if(codePoint>0xD7FF&&codePoint<0xE000){// last char was a lead
if(!leadSurrogate){// no lead yet
if(codePoint>0xDBFF){// unexpected trail
if((units-=3)>-1)bytes.push(0xEF,0xBF,0xBD);continue;}else if(i+1===length){// unpaired lead
if((units-=3)>-1)bytes.push(0xEF,0xBF,0xBD);continue;}// valid lead
leadSurrogate=codePoint;continue;}// 2 leads in a row
if(codePoint<0xDC00){if((units-=3)>-1)bytes.push(0xEF,0xBF,0xBD);leadSurrogate=codePoint;continue;}// valid surrogate pair
codePoint=(leadSurrogate-0xD800<<10|codePoint-0xDC00)+0x10000;}else if(leadSurrogate){// valid bmp char, but last char was a lead
if((units-=3)>-1)bytes.push(0xEF,0xBF,0xBD);}leadSurrogate=null;// encode utf8
if(codePoint<0x80){if((units-=1)<0)break;bytes.push(codePoint);}else if(codePoint<0x800){if((units-=2)<0)break;bytes.push(codePoint>>0x6|0xC0,codePoint&0x3F|0x80);}else if(codePoint<0x10000){if((units-=3)<0)break;bytes.push(codePoint>>0xC|0xE0,codePoint>>0x6&0x3F|0x80,codePoint&0x3F|0x80);}else if(codePoint<0x110000){if((units-=4)<0)break;bytes.push(codePoint>>0x12|0xF0,codePoint>>0xC&0x3F|0x80,codePoint>>0x6&0x3F|0x80,codePoint&0x3F|0x80);}else{throw new Error('Invalid code point');}}return bytes;}function asciiToBytes(str){var byteArray=[];for(var i=0;i<str.length;i++){// Node's code seems to be doing this and not & 0x7F..
byteArray.push(str.charCodeAt(i)&0xFF);}return byteArray;}function utf16leToBytes(str,units){var c,hi,lo;var byteArray=[];for(var i=0;i<str.length;i++){if((units-=2)<0)break;c=str.charCodeAt(i);hi=c>>8;lo=c%256;byteArray.push(lo);byteArray.push(hi);}return byteArray;}function base64ToBytes(str){return base64.toByteArray(base64clean(str));}function blitBuffer(src,dst,offset,length){for(var i=0;i<length;i++){if(i+offset>=dst.length||i>=src.length)break;dst[i+offset]=src[i];}return i;}}).call(this,typeof global!=="undefined"?global:typeof self!=="undefined"?self:typeof window!=="undefined"?window:{});},{"base64-js":67,"ieee754":71,"isarray":69}],69:[function(require,module,exports){var toString={}.toString;module.exports=Array.isArray||function(arr){return toString.call(arr)=='[object Array]';};},{}],70:[function(require,module,exports){// Copyright Joyent, Inc. and other Node contributors.
//
// Permission is hereby granted, free of charge, to any person obtaining a
// copy of this software and associated documentation files (the
// "Software"), to deal in the Software without restriction, including
// without limitation the rights to use, copy, modify, merge, publish,
// distribute, sublicense, and/or sell copies of the Software, and to permit
// persons to whom the Software is furnished to do so, subject to the
// following conditions:
//
// The above copyright notice and this permission notice shall be included
// in all copies or substantial portions of the Software.
//
// THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS
// OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF
// MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN
// NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM,
// DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR
// OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE
// USE OR OTHER DEALINGS IN THE SOFTWARE.
function EventEmitter(){this._events=this._events||{};this._maxListeners=this._maxListeners||undefined;}module.exports=EventEmitter;// Backwards-compat with node 0.10.x
EventEmitter.EventEmitter=EventEmitter;EventEmitter.prototype._events=undefined;EventEmitter.prototype._maxListeners=undefined;// By default EventEmitters will print a warning if more than 10 listeners are
// added to it. This is a useful default which helps finding memory leaks.
EventEmitter.defaultMaxListeners=10;// Obviously not all Emitters should be limited to 10. This function allows
// that to be increased. Set to zero for unlimited.
EventEmitter.prototype.setMaxListeners=function(n){if(!isNumber(n)||n<0||isNaN(n))throw TypeError('n must be a positive number');this._maxListeners=n;return this;};EventEmitter.prototype.emit=function(type){var er,handler,len,args,i,listeners;if(!this._events)this._events={};// If there is no 'error' event listener then throw.
if(type==='error'){if(!this._events.error||isObject(this._events.error)&&!this._events.error.length){er=arguments[1];if(er instanceof Error){throw er;// Unhandled 'error' event
}throw TypeError('Uncaught, unspecified "error" event.');}}handler=this._events[type];if(isUndefined(handler))return false;if(isFunction(handler)){switch(arguments.length){// fast cases
case 1:handler.call(this);break;case 2:handler.call(this,arguments[1]);break;case 3:handler.call(this,arguments[1],arguments[2]);break;// slower
default:len=arguments.length;args=new Array(len-1);for(i=1;i<len;i++){args[i-1]=arguments[i];}handler.apply(this,args);}}else if(isObject(handler)){len=arguments.length;args=new Array(len-1);for(i=1;i<len;i++){args[i-1]=arguments[i];}listeners=handler.slice();len=listeners.length;for(i=0;i<len;i++){listeners[i].apply(this,args);}}return true;};EventEmitter.prototype.addListener=function(type,listener){var m;if(!isFunction(listener))throw TypeError('listener must be a function');if(!this._events)this._events={};// To avoid recursion in the case that type === "newListener"! Before
// adding it to the listeners, first emit "newListener".
if(this._events.newListener)this.emit('newListener',type,isFunction(listener.listener)?listener.listener:listener);if(!this._events[type])// Optimize the case of one listener. Don't need the extra array object.
this._events[type]=listener;else if(isObject(this._events[type]))// If we've already got an array, just append.
this._events[type].push(listener);else// Adding the second element, need to change to array.
this._events[type]=[this._events[type],listener];// Check for listener leak
if(isObject(this._events[type])&&!this._events[type].warned){var m;if(!isUndefined(this._maxListeners)){m=this._maxListeners;}else{m=EventEmitter.defaultMaxListeners;}if(m&&m>0&&this._events[type].length>m){this._events[type].warned=true;console.error('(node) warning: possible EventEmitter memory '+'leak detected. %d listeners added. '+'Use emitter.setMaxListeners() to increase limit.',this._events[type].length);if(typeof console.trace==='function'){// not supported in IE 10
console.trace();}}}return this;};EventEmitter.prototype.on=EventEmitter.prototype.addListener;EventEmitter.prototype.once=function(type,listener){if(!isFunction(listener))throw TypeError('listener must be a function');var fired=false;function g(){this.removeListener(type,g);if(!fired){fired=true;listener.apply(this,arguments);}}g.listener=listener;this.on(type,g);return this;};// emits a 'removeListener' event iff the listener was removed
EventEmitter.prototype.removeListener=function(type,listener){var list,position,length,i;if(!isFunction(listener))throw TypeError('listener must be a function');if(!this._events||!this._events[type])return this;list=this._events[type];length=list.length;position=-1;if(list===listener||isFunction(list.listener)&&list.listener===listener){delete this._events[type];if(this._events.removeListener)this.emit('removeListener',type,listener);}else if(isObject(list)){for(i=length;i-->0;){if(list[i]===listener||list[i].listener&&list[i].listener===listener){position=i;break;}}if(position<0)return this;if(list.length===1){list.length=0;delete this._events[type];}else{list.splice(position,1);}if(this._events.removeListener)this.emit('removeListener',type,listener);}return this;};EventEmitter.prototype.removeAllListeners=function(type){var key,listeners;if(!this._events)return this;// not listening for removeListener, no need to emit
if(!this._events.removeListener){if(arguments.length===0)this._events={};else if(this._events[type])delete this._events[type];return this;}// emit removeListener for all listeners on all events
if(arguments.length===0){for(key in this._events){if(key==='removeListener')continue;this.removeAllListeners(key);}this.removeAllListeners('removeListener');this._events={};return this;}listeners=this._events[type];if(isFunction(listeners)){this.removeListener(type,listeners);}else{// LIFO order
while(listeners.length){this.removeListener(type,listeners[listeners.length-1]);}}delete this._events[type];return this;};EventEmitter.prototype.listeners=function(type){var ret;if(!this._events||!this._events[type])ret=[];else if(isFunction(this._events[type]))ret=[this._events[type]];else ret=this._events[type].slice();return ret;};EventEmitter.listenerCount=function(emitter,type){var ret;if(!emitter._events||!emitter._events[type])ret=0;else if(isFunction(emitter._events[type]))ret=1;else ret=emitter._events[type].length;return ret;};function isFunction(arg){return typeof arg==='function';}function isNumber(arg){return typeof arg==='number';}function isObject(arg){return(typeof arg==="undefined"?"undefined":_typeof(arg))==='object'&&arg!==null;}function isUndefined(arg){return arg===void 0;}},{}],71:[function(require,module,exports){exports.read=function(buffer,offset,isLE,mLen,nBytes){var e,m;var eLen=nBytes*8-mLen-1;var eMax=(1<<eLen)-1;var eBias=eMax>>1;var nBits=-7;var i=isLE?nBytes-1:0;var d=isLE?-1:1;var s=buffer[offset+i];i+=d;e=s&(1<<-nBits)-1;s>>=-nBits;nBits+=eLen;for(;nBits>0;e=e*256+buffer[offset+i],i+=d,nBits-=8){}m=e&(1<<-nBits)-1;e>>=-nBits;nBits+=mLen;for(;nBits>0;m=m*256+buffer[offset+i],i+=d,nBits-=8){}if(e===0){e=1-eBias;}else if(e===eMax){return m?NaN:(s?-1:1)*Infinity;}else{m=m+Math.pow(2,mLen);e=e-eBias;}return(s?-1:1)*m*Math.pow(2,e-mLen);};exports.write=function(buffer,value,offset,isLE,mLen,nBytes){var e,m,c;var eLen=nBytes*8-mLen-1;var eMax=(1<<eLen)-1;var eBias=eMax>>1;var rt=mLen===23?Math.pow(2,-24)-Math.pow(2,-77):0;var i=isLE?0:nBytes-1;var d=isLE?1:-1;var s=value<0||value===0&&1/value<0?1:0;value=Math.abs(value);if(isNaN(value)||value===Infinity){m=isNaN(value)?1:0;e=eMax;}else{e=Math.floor(Math.log(value)/Math.LN2);if(value*(c=Math.pow(2,-e))<1){e--;c*=2;}if(e+eBias>=1){value+=rt/c;}else{value+=rt*Math.pow(2,1-eBias);}if(value*c>=2){e++;c/=2;}if(e+eBias>=eMax){m=0;e=eMax;}else if(e+eBias>=1){m=(value*c-1)*Math.pow(2,mLen);e=e+eBias;}else{m=value*Math.pow(2,eBias-1)*Math.pow(2,mLen);e=0;}}for(;mLen>=8;buffer[offset+i]=m&0xff,i+=d,m/=256,mLen-=8){}e=e<<mLen|m;eLen+=mLen;for(;eLen>0;buffer[offset+i]=e&0xff,i+=d,e/=256,eLen-=8){}buffer[offset+i-d]|=s*128;};},{}],72:[function(require,module,exports){// shim for using process in browser
var process=module.exports={};var queue=[];var draining=false;function drainQueue(){if(draining){return;}draining=true;var currentQueue;var len=queue.length;while(len){currentQueue=queue;queue=[];var i=-1;while(++i<len){currentQueue[i]();}len=queue.length;}draining=false;}process.nextTick=function(fun){queue.push(fun);if(!draining){setTimeout(drainQueue,0);}};process.title='browser';process.browser=true;process.env={};process.argv=[];process.version='';// empty string to avoid regexp issues
process.versions={};function noop(){}process.on=noop;process.addListener=noop;process.once=noop;process.off=noop;process.removeListener=noop;process.removeAllListeners=noop;process.emit=noop;process.binding=function(name){throw new Error('process.binding is not supported');};// TODO(shtylman)
process.cwd=function(){return'/';};process.chdir=function(dir){throw new Error('process.chdir is not supported');};process.umask=function(){return 0;};},{}],73:[function(require,module,exports){module.exports={"_args":[[{"raw":"sip.js@github:twilio/SIP.js#420ed46ba6751b32e99950fb6fb84683afb820cc","scope":null,"escapedName":"sip.js","name":"sip.js","rawSpec":"github:twilio/SIP.js#420ed46ba6751b32e99950fb6fb84683afb820cc","spec":"github:twilio/SIP.js#420ed46ba6751b32e99950fb6fb84683afb820cc","type":"hosted","hosted":{"type":"github","ssh":"git@github.com:twilio/SIP.js.git#420ed46ba6751b32e99950fb6fb84683afb820cc","sshUrl":"git+ssh://git@github.com/twilio/SIP.js.git#420ed46ba6751b32e99950fb6fb84683afb820cc","httpsUrl":"git+https://github.com/twilio/SIP.js.git#420ed46ba6751b32e99950fb6fb84683afb820cc","gitUrl":"git://github.com/twilio/SIP.js.git#420ed46ba6751b32e99950fb6fb84683afb820cc","shortcut":"github:twilio/SIP.js#420ed46ba6751b32e99950fb6fb84683afb820cc","directUrl":"https://raw.githubusercontent.com/twilio/SIP.js/420ed46ba6751b32e99950fb6fb84683afb820cc/package.json"}},"/home/travis/build/twilio/twilio-video.js"]],"_from":"twilio/SIP.js#420ed46ba6751b32e99950fb6fb84683afb820cc","_id":"sip.js@0.7.5","_inCache":true,"_location":"/sip.js","_phantomChildren":{},"_requested":{"raw":"sip.js@github:twilio/SIP.js#420ed46ba6751b32e99950fb6fb84683afb820cc","scope":null,"escapedName":"sip.js","name":"sip.js","rawSpec":"github:twilio/SIP.js#420ed46ba6751b32e99950fb6fb84683afb820cc","spec":"github:twilio/SIP.js#420ed46ba6751b32e99950fb6fb84683afb820cc","type":"hosted","hosted":{"type":"github","ssh":"git@github.com:twilio/SIP.js.git#420ed46ba6751b32e99950fb6fb84683afb820cc","sshUrl":"git+ssh://git@github.com/twilio/SIP.js.git#420ed46ba6751b32e99950fb6fb84683afb820cc","httpsUrl":"git+https://github.com/twilio/SIP.js.git#420ed46ba6751b32e99950fb6fb84683afb820cc","gitUrl":"git://github.com/twilio/SIP.js.git#420ed46ba6751b32e99950fb6fb84683afb820cc","shortcut":"github:twilio/SIP.js#420ed46ba6751b32e99950fb6fb84683afb820cc","directUrl":"https://raw.githubusercontent.com/twilio/SIP.js/420ed46ba6751b32e99950fb6fb84683afb820cc/package.json"}},"_requiredBy":["/"],"_resolved":"git://github.com/twilio/SIP.js.git#420ed46ba6751b32e99950fb6fb84683afb820cc","_shasum":"964da52f1f19b7ad6662d83ad03a3bac705a36dc","_shrinkwrap":null,"_spec":"sip.js@github:twilio/SIP.js#420ed46ba6751b32e99950fb6fb84683afb820cc","_where":"/home/travis/build/twilio/twilio-video.js","author":{"name":"OnSIP","email":"developer@onsip.com","url":"http://sipjs.com/authors/"},"browser":{"./src/environment.js":"./src/environment_browser.js"},"bugs":{"url":"https://github.com/onsip/SIP.js/issues"},"contributors":[{"url":"https://github.com/onsip/SIP.js/blob/master/THANKS.md"}],"dependencies":{"pegjs":"^0.8.0","promiscuous":"^0.6.0","ws":"^1.0.1"},"description":"A simple, intuitive, and powerful JavaScript signaling library","devDependencies":{"beefy":"^2.1.5","browserify":"^4.1.8","grunt":"~0.4.0","grunt-browserify":"^4.0.1","grunt-cli":"~0.1.6","grunt-contrib-copy":"^0.5.0","grunt-contrib-jasmine":"^1.0.3","grunt-contrib-jshint":">0.5.0","grunt-contrib-uglify":"~0.2.0","grunt-peg":"~1.3.1","grunt-trimtrailingspaces":"^0.4.0"},"engines":{"node":">=0.12"},"gitHead":"420ed46ba6751b32e99950fb6fb84683afb820cc","homepage":"http://sipjs.com","keywords":["sip","websocket","webrtc","library","javascript"],"license":"MIT","main":"src/index.js","name":"sip.js","optionalDependencies":{"promiscuous":"^0.6.0"},"readme":"# SIP.js\n\n[![Build Status](https://travis-ci.org/onsip/SIP.js.png?branch=master)](https://travis-ci.org/onsip/SIP.js)\n\nA JavaScript SIP stack for WebRTC, instant messaging, and more!\n\n\n## Website and Documentation\n\n* [SIPjs.com](http://sipjs.com)\n* [Mailing List](https://groups.google.com/forum/#!forum/sip_js)\n* [Issue Tracking](https://github.com/onsip/sip.js/issues)\n\n\n## Download\n\n* [sipjs.com/download](http://sipjs.com/download/)\n* Bower: `bower install sip.js`\n* npm: `npm install sip.js`\n\n## Authors\n\n### James Criscuolo\n\n* <james@onsip.com>\n\n### Joseph Frazier\n\n* <1212jtraceur@gmail.com>\n* GitHub [@josephfrazier](https://github.com/josephfrazier)\n* Twitter [@josephfrazier_](https://twitter.com/josephfrazier_)\n\n### Eric Green\n\n* <eric.green@onsip.com>\n\n### Will Mitchell\n\n* <wakamoleguy@gmail.com>\n* GitHub [@wakamoleguy](http://github.com/wakamoleguy)\n* Twitter [@wakamoleguy](http://twitter.com/wakamoleguy)\n\n### JsSIP Authors\n\nSIP.js contains substantial portions of the JsSIP software. JsSIP's authors at time of fork are listed below. For up to date information about JsSIP, please visit [jssip.net](http://jssip.net)\n\n* Jos Luis Milln\n* Iaki Baz Castillo\n* Sal Ibarra Corretg\n\n## License\n\nSIP.js is released under the [MIT license](http://sipjs.com/license).\n\nSIP.js contains substantial portions of the JsSIP software, under the following license:\n\n~~~\nCopyright (c) 2012-2013 Jos Luis Milln - Versatica <http://www.versatica.com>\n\nPermission is hereby granted, free of charge, to any person obtaining\na copy of this software and associated documentation files (the\n\"Software\"), to deal in the Software without restriction, including\nwithout limitation the rights to use, copy, modify, merge, publish,\ndistribute, sublicense, and/or sell copies of the Software, and to\npermit persons to whom the Software is furnished to do so, subject to\nthe following conditions:\n\nThe above copyright notice and this permission notice shall be\nincluded in all copies or substantial portions of the Software.\n\nTHE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND,\nEXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF\nMERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND\nNONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE\nLIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION\nOF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION\nWITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.\n\n~~~\n","readmeFilename":"README.md","repository":{"type":"git","url":"git+https://github.com/onsip/SIP.js.git"},"scripts":{"build":"grunt build","postinstall":"cd src/Grammar && mkdir -p dist && pegjs --extra-options-file peg.json src/Grammar.pegjs dist/Grammar.js","repl":"beefy test/repl.js --open","test":"grunt travis --verbose"},"title":"SIP.js","version":"0.7.5"};},{}],74:[function(require,module,exports){"use strict";module.exports=function(SIP){var ClientContext;ClientContext=function ClientContext(ua,method,target,options){var originalTarget=target;// Validate arguments
if(target===undefined){throw new TypeError('Not enough arguments');}this.ua=ua;this.logger=ua.getLogger('sip.clientcontext');this.method=method;target=ua.normalizeTarget(target);if(!target){throw new TypeError('Invalid target: '+originalTarget);}/* Options
   * - extraHeaders
   * - params
   * - contentType
   * - body
   */options=Object.create(options||Object.prototype);options.extraHeaders=(options.extraHeaders||[]).slice();// Build the request
this.request=new SIP.OutgoingRequest(this.method,target,this.ua,options.params,options.extraHeaders);if(options.body){this.body={};this.body.body=options.body;if(options.contentType){this.body.contentType=options.contentType;}this.request.body=this.body;}/* Set other properties from the request */this.localIdentity=this.request.from;this.remoteIdentity=this.request.to;this.data={};};ClientContext.prototype=Object.create(SIP.EventEmitter.prototype);ClientContext.prototype.send=function(){new SIP.RequestSender(this,this.ua).send();return this;};ClientContext.prototype.cancel=function(options){options=options||{};options.extraHeaders=(options.extraHeaders||[]).slice();var cancel_reason=SIP.Utils.getCancelReason(options.status_code,options.reason_phrase);this.request.cancel(cancel_reason,options.extraHeaders);this.emit('cancel');};ClientContext.prototype.receiveResponse=function(response){var cause=SIP.Utils.getReasonPhrase(response.status_code);switch(true){case /^1[0-9]{2}$/.test(response.status_code):this.emit('progress',response,cause);break;case /^2[0-9]{2}$/.test(response.status_code):if(this.ua.applicants[this]){delete this.ua.applicants[this];}this.emit('accepted',response,cause);break;default:if(this.ua.applicants[this]){delete this.ua.applicants[this];}this.emit('rejected',response,cause);this.emit('failed',response,cause);break;}};ClientContext.prototype.onRequestTimeout=function(){this.emit('failed',null,SIP.C.causes.REQUEST_TIMEOUT);};ClientContext.prototype.onTransportError=function(){this.emit('failed',null,SIP.C.causes.CONNECTION_ERROR);};SIP.ClientContext=ClientContext;};},{}],75:[function(require,module,exports){"use strict";/**
 * @fileoverview SIP Constants
 *//**
 * SIP Constants.
 * @augments SIP
 */module.exports=function(name,version){return{USER_AGENT:name+'/'+version,// SIP scheme
SIP:'sip',SIPS:'sips',// End and Failure causes
causes:{// Generic error causes
CONNECTION_ERROR:'Connection Error',REQUEST_TIMEOUT:'Request Timeout',SIP_FAILURE_CODE:'SIP Failure Code',INTERNAL_ERROR:'Internal Error',// SIP error causes
BUSY:'Busy',REJECTED:'Rejected',REDIRECTED:'Redirected',UNAVAILABLE:'Unavailable',NOT_FOUND:'Not Found',ADDRESS_INCOMPLETE:'Address Incomplete',INCOMPATIBLE_SDP:'Incompatible SDP',AUTHENTICATION_ERROR:'Authentication Error',DIALOG_ERROR:'Dialog Error',// Session error causes
WEBRTC_NOT_SUPPORTED:'WebRTC Not Supported',WEBRTC_ERROR:'WebRTC Error',CANCELED:'Canceled',NO_ANSWER:'No Answer',EXPIRES:'Expires',NO_ACK:'No ACK',NO_PRACK:'No PRACK',USER_DENIED_MEDIA_ACCESS:'User Denied Media Access',BAD_MEDIA_DESCRIPTION:'Bad Media Description',RTP_TIMEOUT:'RTP Timeout'},supported:{UNSUPPORTED:'none',SUPPORTED:'supported',REQUIRED:'required'},SIP_ERROR_CAUSES:{REDIRECTED:[300,301,302,305,380],BUSY:[486,600],REJECTED:[403,603],NOT_FOUND:[404,604],UNAVAILABLE:[480,410,408,430],ADDRESS_INCOMPLETE:[484],INCOMPATIBLE_SDP:[488,606],AUTHENTICATION_ERROR:[401,407]},// SIP Methods
ACK:'ACK',BYE:'BYE',CANCEL:'CANCEL',INFO:'INFO',INVITE:'INVITE',MESSAGE:'MESSAGE',NOTIFY:'NOTIFY',OPTIONS:'OPTIONS',REGISTER:'REGISTER',UPDATE:'UPDATE',SUBSCRIBE:'SUBSCRIBE',REFER:'REFER',PRACK:'PRACK',/* SIP Response Reasons
   * DOC: http://www.iana.org/assignments/sip-parameters
   * Copied from https://github.com/versatica/OverSIP/blob/master/lib/oversip/sip/constants.rb#L7
   */REASON_PHRASE:{100:'Trying',180:'Ringing',181:'Call Is Being Forwarded',182:'Queued',183:'Session Progress',199:'Early Dialog Terminated',// draft-ietf-sipcore-199
200:'OK',202:'Accepted',// RFC 3265
204:'No Notification',//RFC 5839
300:'Multiple Choices',301:'Moved Permanently',302:'Moved Temporarily',305:'Use Proxy',380:'Alternative Service',400:'Bad Request',401:'Unauthorized',402:'Payment Required',403:'Forbidden',404:'Not Found',405:'Method Not Allowed',406:'Not Acceptable',407:'Proxy Authentication Required',408:'Request Timeout',410:'Gone',412:'Conditional Request Failed',// RFC 3903
413:'Request Entity Too Large',414:'Request-URI Too Long',415:'Unsupported Media Type',416:'Unsupported URI Scheme',417:'Unknown Resource-Priority',// RFC 4412
420:'Bad Extension',421:'Extension Required',422:'Session Interval Too Small',// RFC 4028
423:'Interval Too Brief',428:'Use Identity Header',// RFC 4474
429:'Provide Referrer Identity',// RFC 3892
430:'Flow Failed',// RFC 5626
433:'Anonymity Disallowed',// RFC 5079
436:'Bad Identity-Info',// RFC 4474
437:'Unsupported Certificate',// RFC 4744
438:'Invalid Identity Header',// RFC 4744
439:'First Hop Lacks Outbound Support',// RFC 5626
440:'Max-Breadth Exceeded',// RFC 5393
469:'Bad Info Package',// draft-ietf-sipcore-info-events
470:'Consent Needed',// RFC 5360
478:'Unresolvable Destination',// Custom code copied from Kamailio.
480:'Temporarily Unavailable',481:'Call/Transaction Does Not Exist',482:'Loop Detected',483:'Too Many Hops',484:'Address Incomplete',485:'Ambiguous',486:'Busy Here',487:'Request Terminated',488:'Not Acceptable Here',489:'Bad Event',// RFC 3265
491:'Request Pending',493:'Undecipherable',494:'Security Agreement Required',// RFC 3329
500:'Internal Server Error',501:'Not Implemented',502:'Bad Gateway',503:'Service Unavailable',504:'Server Time-out',505:'Version Not Supported',513:'Message Too Large',580:'Precondition Failure',// RFC 3312
600:'Busy Everywhere',603:'Decline',604:'Does Not Exist Anywhere',606:'Not Acceptable'},/* SIP Option Tags
   * DOC: http://www.iana.org/assignments/sip-parameters/sip-parameters.xhtml#sip-parameters-4
   */OPTION_TAGS:{'100rel':true,// RFC 3262
199:true,// RFC 6228
answermode:true,// RFC 5373
'early-session':true,// RFC 3959
eventlist:true,// RFC 4662
explicitsub:true,// RFC-ietf-sipcore-refer-explicit-subscription-03
'from-change':true,// RFC 4916
'geolocation-http':true,// RFC 6442
'geolocation-sip':true,// RFC 6442
gin:true,// RFC 6140
gruu:true,// RFC 5627
histinfo:true,// RFC 7044
ice:true,// RFC 5768
join:true,// RFC 3911
'multiple-refer':true,// RFC 5368
norefersub:true,// RFC 4488
nosub:true,// RFC-ietf-sipcore-refer-explicit-subscription-03
outbound:true,// RFC 5626
path:true,// RFC 3327
policy:true,// RFC 6794
precondition:true,// RFC 3312
pref:true,// RFC 3840
privacy:true,// RFC 3323
'recipient-list-invite':true,// RFC 5366
'recipient-list-message':true,// RFC 5365
'recipient-list-subscribe':true,// RFC 5367
replaces:true,// RFC 3891
'resource-priority':true,// RFC 4412
'sdp-anat':true,// RFC 4092
'sec-agree':true,// RFC 3329
tdialog:true,// RFC 4538
timer:true,// RFC 4028
uui:true// RFC 7433
}};};},{}],76:[function(require,module,exports){"use strict";/**
 * @fileoverview In-Dialog Request Sender
 *//**
 * @augments SIP.Dialog
 * @class Class creating an In-dialog request sender.
 * @param {SIP.Dialog} dialog
 * @param {Object} applicant
 * @param {SIP.OutgoingRequest} request
 *//**
 * @fileoverview in-Dialog Request Sender
 */module.exports=function(SIP){var RequestSender;RequestSender=function RequestSender(dialog,applicant,request){this.dialog=dialog;this.applicant=applicant;this.request=request;// RFC3261 14.1 Modifying an Existing Session. UAC Behavior.
this.reattempt=false;this.reattemptTimer=null;};RequestSender.prototype={send:function send(){var self=this,request_sender=new SIP.RequestSender(this,this.dialog.owner.ua);request_sender.send();// RFC3261 14.2 Modifying an Existing Session -UAC BEHAVIOR-
if(this.request.method===SIP.C.INVITE&&request_sender.clientTransaction.state!==SIP.Transactions.C.STATUS_TERMINATED){this.dialog.uac_pending_reply=true;request_sender.clientTransaction.on('stateChanged',function stateChanged(){if(this.state===SIP.Transactions.C.STATUS_ACCEPTED||this.state===SIP.Transactions.C.STATUS_COMPLETED||this.state===SIP.Transactions.C.STATUS_TERMINATED){this.removeListener('stateChanged',stateChanged);self.dialog.uac_pending_reply=false;if(self.dialog.uas_pending_reply===false){self.dialog.owner.onReadyToReinvite();}}});}},onRequestTimeout:function onRequestTimeout(){this.applicant.onRequestTimeout();},onTransportError:function onTransportError(){this.applicant.onTransportError();},receiveResponse:function receiveResponse(response){var self=this;// RFC3261 12.2.1.2 408 or 481 is received for a request within a dialog.
if(response.status_code===408||response.status_code===481){this.applicant.onDialogError(response);}else if(response.method===SIP.C.INVITE&&response.status_code===491){if(this.reattempt){this.applicant.receiveResponse(response);}else{this.request.cseq.value=this.dialog.local_seqnum+=1;this.reattemptTimer=SIP.Timers.setTimeout(function(){if(self.applicant.owner.status!==SIP.Session.C.STATUS_TERMINATED){self.reattempt=true;self.request_sender.send();}},this.getReattemptTimeout());}}else{this.applicant.receiveResponse(response);}}};return RequestSender;};},{}],77:[function(require,module,exports){"use strict";/**
 * @fileoverview SIP Dialog
 *//**
 * @augments SIP
 * @class Class creating a SIP dialog.
 * @param {SIP.RTCSession} owner
 * @param {SIP.IncomingRequest|SIP.IncomingResponse} message
 * @param {Enum} type UAC / UAS
 * @param {Enum} state SIP.Dialog.C.STATUS_EARLY / SIP.Dialog.C.STATUS_CONFIRMED
 */module.exports=function(SIP){var RequestSender=require('./Dialog/RequestSender')(SIP);var Dialog,C={// Dialog states
STATUS_EARLY:1,STATUS_CONFIRMED:2};// RFC 3261 12.1
Dialog=function Dialog(owner,message,type,state){var contact;this.uac_pending_reply=false;this.uas_pending_reply=false;if(!message.hasHeader('contact')){return{error:'unable to create a Dialog without Contact header field'};}if(message instanceof SIP.IncomingResponse){state=message.status_code<200?C.STATUS_EARLY:C.STATUS_CONFIRMED;}else{// Create confirmed dialog if state is not defined
state=state||C.STATUS_CONFIRMED;}contact=message.parseHeader('contact');// RFC 3261 12.1.1
if(type==='UAS'){this.id={call_id:message.call_id,local_tag:message.to_tag,remote_tag:message.from_tag,toString:function toString(){return this.call_id+this.local_tag+this.remote_tag;}};this.state=state;this.remote_seqnum=message.cseq;this.local_uri=message.parseHeader('to').uri;this.remote_uri=message.parseHeader('from').uri;this.remote_target=contact.uri;this.route_set=message.getHeaders('record-route');this.invite_seqnum=message.cseq;this.local_seqnum=message.cseq;}// RFC 3261 12.1.2
else if(type==='UAC'){this.id={call_id:message.call_id,local_tag:message.from_tag,remote_tag:message.to_tag,toString:function toString(){return this.call_id+this.local_tag+this.remote_tag;}};this.state=state;this.invite_seqnum=message.cseq;this.local_seqnum=message.cseq;this.local_uri=message.parseHeader('from').uri;this.pracked=[];this.remote_uri=message.parseHeader('to').uri;this.remote_target=contact.uri;this.route_set=message.getHeaders('record-route').reverse();//RENDERBODY
if(this.state===C.STATUS_EARLY&&!owner.hasOffer){this.mediaHandler=owner.mediaHandlerFactory(owner);}}this.logger=owner.ua.getLogger('sip.dialog',this.id.toString());this.owner=owner;owner.ua.dialogs[this.id.toString()]=this;this.logger.log('new '+type+' dialog created with status '+(this.state===C.STATUS_EARLY?'EARLY':'CONFIRMED'));owner.emit('dialog',this);};Dialog.prototype={/**
   * @param {SIP.IncomingMessage} message
   * @param {Enum} UAC/UAS
   */update:function update(message,type){this.state=C.STATUS_CONFIRMED;this.logger.log('dialog '+this.id.toString()+'  changed to CONFIRMED state');if(type==='UAC'){// RFC 3261 13.2.2.4
this.route_set=message.getHeaders('record-route').reverse();}},terminate:function terminate(){this.logger.log('dialog '+this.id.toString()+' deleted');if(this.mediaHandler&&this.state!==C.STATUS_CONFIRMED){this.mediaHandler.peerConnection.close();}delete this.owner.ua.dialogs[this.id.toString()];},/**
  * @param {String} method request method
  * @param {Object} extraHeaders extra headers
  * @returns {SIP.OutgoingRequest}
  */// RFC 3261 12.2.1.1
createRequest:function createRequest(method,extraHeaders,body){var cseq,request;extraHeaders=(extraHeaders||[]).slice();if(!this.local_seqnum){this.local_seqnum=Math.floor(Math.random()*10000);}cseq=method===SIP.C.CANCEL||method===SIP.C.ACK?this.invite_seqnum:this.local_seqnum+=1;request=new SIP.OutgoingRequest(method,this.remote_target,this.owner.ua,{'cseq':cseq,'call_id':this.id.call_id,'from_uri':this.local_uri,'from_tag':this.id.local_tag,'to_uri':this.remote_uri,'to_tag':this.id.remote_tag,'route_set':this.route_set},extraHeaders,body);request.dialog=this;return request;},/**
  * @param {SIP.IncomingRequest} request
  * @returns {Boolean}
  */// RFC 3261 12.2.2
checkInDialogRequest:function checkInDialogRequest(request){var self=this;if(!this.remote_seqnum){this.remote_seqnum=request.cseq;}else if(request.cseq<this.remote_seqnum){//Do not try to reply to an ACK request.
if(request.method!==SIP.C.ACK){request.reply(500);}if(request.cseq===this.invite_seqnum){return true;}return false;}else if(request.cseq>this.remote_seqnum){this.remote_seqnum=request.cseq;}switch(request.method){// RFC3261 14.2 Modifying an Existing Session -UAS BEHAVIOR-
case SIP.C.INVITE:if(this.uac_pending_reply===true){request.reply(491);}else if(this.uas_pending_reply===true){var retryAfter=(Math.random()*10|0)+1;request.reply(500,null,['Retry-After:'+retryAfter]);return false;}else{this.uas_pending_reply=true;request.server_transaction.on('stateChanged',function stateChanged(){if(this.state===SIP.Transactions.C.STATUS_ACCEPTED||this.state===SIP.Transactions.C.STATUS_COMPLETED||this.state===SIP.Transactions.C.STATUS_TERMINATED){this.removeListener('stateChanged',stateChanged);self.uas_pending_reply=false;if(self.uac_pending_reply===false){self.owner.onReadyToReinvite();}}});}// RFC3261 12.2.2 Replace the dialog`s remote target URI if the request is accepted
if(request.hasHeader('contact')){request.server_transaction.on('stateChanged',function(){if(this.state===SIP.Transactions.C.STATUS_ACCEPTED){self.remote_target=request.parseHeader('contact').uri;}});}break;case SIP.C.NOTIFY:// RFC6665 3.2 Replace the dialog`s remote target URI if the request is accepted
if(request.hasHeader('contact')){request.server_transaction.on('stateChanged',function(){if(this.state===SIP.Transactions.C.STATUS_COMPLETED){self.remote_target=request.parseHeader('contact').uri;}});}break;}return true;},sendRequest:function sendRequest(applicant,method,options){options=options||{};var extraHeaders=(options.extraHeaders||[]).slice();var body=null;if(options.body){if(options.body.body){body=options.body;}else{body={};body.body=options.body;if(options.contentType){body.contentType=options.contentType;}}}var request=this.createRequest(method,extraHeaders,body),request_sender=new RequestSender(this,applicant,request);request_sender.send();return request;},/**
  * @param {SIP.IncomingRequest} request
  */receiveRequest:function receiveRequest(request){//Check in-dialog request
if(!this.checkInDialogRequest(request)){return;}this.owner.receiveRequest(request);}};Dialog.C=C;SIP.Dialog=Dialog;};},{"./Dialog/RequestSender":76}],78:[function(require,module,exports){"use strict";/**
 * @fileoverview SIP Digest Authentication
 *//**
 * SIP Digest Authentication.
 * @augments SIP.
 * @function Digest Authentication
 * @param {SIP.UA} ua
 */module.exports=function(Utils){var DigestAuthentication;DigestAuthentication=function DigestAuthentication(ua){this.logger=ua.getLogger('sipjs.digestauthentication');this.username=ua.configuration.authorizationUser;this.password=ua.configuration.password;this.cnonce=null;this.nc=0;this.ncHex='00000000';this.response=null;};/**
* Performs Digest authentication given a SIP request and the challenge
* received in a response to that request.
* Returns true if credentials were successfully generated, false otherwise.
*
* @param {SIP.OutgoingRequest} request
* @param {Object} challenge
*/DigestAuthentication.prototype.authenticate=function(request,challenge){// Inspect and validate the challenge.
this.algorithm=challenge.algorithm;this.realm=challenge.realm;this.nonce=challenge.nonce;this.opaque=challenge.opaque;this.stale=challenge.stale;if(this.algorithm){if(this.algorithm!=='MD5'){this.logger.warn('challenge with Digest algorithm different than "MD5", authentication aborted');return false;}}else{this.algorithm='MD5';}if(!this.realm){this.logger.warn('challenge without Digest realm, authentication aborted');return false;}if(!this.nonce){this.logger.warn('challenge without Digest nonce, authentication aborted');return false;}// 'qop' can contain a list of values (Array). Let's choose just one.
if(challenge.qop){if(challenge.qop.indexOf('auth')>-1){this.qop='auth';}else if(challenge.qop.indexOf('auth-int')>-1){this.qop='auth-int';}else{// Otherwise 'qop' is present but does not contain 'auth' or 'auth-int', so abort here.
this.logger.warn('challenge without Digest qop different than "auth" or "auth-int", authentication aborted');return false;}}else{this.qop=null;}// Fill other attributes.
this.method=request.method;this.uri=request.ruri;this.cnonce=Utils.createRandomToken(12);this.nc+=1;this.updateNcHex();// nc-value = 8LHEX. Max value = 'FFFFFFFF'.
if(this.nc===4294967296){this.nc=1;this.ncHex='00000001';}// Calculate the Digest "response" value.
this.calculateResponse();return true;};/**
* Generate Digest 'response' value.
* @private
*/DigestAuthentication.prototype.calculateResponse=function(){var ha1,ha2;// HA1 = MD5(A1) = MD5(username:realm:password)
ha1=Utils.calculateMD5(this.username+":"+this.realm+":"+this.password);if(this.qop==='auth'){// HA2 = MD5(A2) = MD5(method:digestURI)
ha2=Utils.calculateMD5(this.method+":"+this.uri);// response = MD5(HA1:nonce:nonceCount:credentialsNonce:qop:HA2)
this.response=Utils.calculateMD5(ha1+":"+this.nonce+":"+this.ncHex+":"+this.cnonce+":auth:"+ha2);}else if(this.qop==='auth-int'){// HA2 = MD5(A2) = MD5(method:digestURI:MD5(entityBody))
ha2=Utils.calculateMD5(this.method+":"+this.uri+":"+Utils.calculateMD5(this.body?this.body:""));// response = MD5(HA1:nonce:nonceCount:credentialsNonce:qop:HA2)
this.response=Utils.calculateMD5(ha1+":"+this.nonce+":"+this.ncHex+":"+this.cnonce+":auth-int:"+ha2);}else if(this.qop===null){// HA2 = MD5(A2) = MD5(method:digestURI)
ha2=Utils.calculateMD5(this.method+":"+this.uri);// response = MD5(HA1:nonce:HA2)
this.response=Utils.calculateMD5(ha1+":"+this.nonce+":"+ha2);}};/**
* Return the Proxy-Authorization or WWW-Authorization header value.
*/DigestAuthentication.prototype.toString=function(){var auth_params=[];if(!this.response){throw new Error('response field does not exist, cannot generate Authorization header');}auth_params.push('algorithm='+this.algorithm);auth_params.push('username="'+this.username+'"');auth_params.push('realm="'+this.realm+'"');auth_params.push('nonce="'+this.nonce+'"');auth_params.push('uri="'+this.uri+'"');auth_params.push('response="'+this.response+'"');if(this.opaque){auth_params.push('opaque="'+this.opaque+'"');}if(this.qop){auth_params.push('qop='+this.qop);auth_params.push('cnonce="'+this.cnonce+'"');auth_params.push('nc='+this.ncHex);}return'Digest '+auth_params.join(', ');};/**
* Generate the 'nc' value as required by Digest in this.ncHex by reading this.nc.
* @private
*/DigestAuthentication.prototype.updateNcHex=function(){var hex=Number(this.nc).toString(16);this.ncHex='00000000'.substr(0,8-hex.length)+hex;};return DigestAuthentication;};},{}],79:[function(require,module,exports){"use strict";var NodeEventEmitter=require('events').EventEmitter;module.exports=function(console){// Don't use `new SIP.EventEmitter()` for inheriting.
// Use Object.create(SIP.EventEmitter.prototoype);
function EventEmitter(){NodeEventEmitter.call(this);}EventEmitter.prototype=Object.create(NodeEventEmitter.prototype,{constructor:{value:EventEmitter,enumerable:false,writable:true,configurable:true}});EventEmitter.prototype.off=function off(eventName,listener){var warning='';warning+='SIP.EventEmitter#off is deprecated and may be removed in future SIP.js versions.\n';warning+='Please use removeListener or removeAllListeners instead.\n';warning+='See here for more details:\n';warning+='http://nodejs.org/api/events.html#events_emitter_removelistener_event_listener';console.warn(warning);if(arguments.length<2){return this.removeAllListeners.apply(this,arguments);}else{return this.removeListener(eventName,listener);}};return EventEmitter;};},{"events":70}],80:[function(require,module,exports){"use strict";/**
 * @fileoverview Exceptions
 *//**
 * SIP Exceptions.
 * @augments SIP
 */module.exports={ConfigurationError:function(){var exception=function exception(parameter,value){this.code=1;this.name='CONFIGURATION_ERROR';this.parameter=parameter;this.value=value;this.message=!this.value?'Missing parameter: '+this.parameter:'Invalid value '+JSON.stringify(this.value)+' for parameter "'+this.parameter+'"';};exception.prototype=new Error();return exception;}(),InvalidStateError:function(){var exception=function exception(status){this.code=2;this.name='INVALID_STATE_ERROR';this.status=status;this.message='Invalid status: '+status;};exception.prototype=new Error();return exception;}(),NotSupportedError:function(){var exception=function exception(message){this.code=3;this.name='NOT_SUPPORTED_ERROR';this.message=message;};exception.prototype=new Error();return exception;}(),GetDescriptionError:function(){var exception=function exception(message){this.code=4;this.name='GET_DESCRIPTION_ERROR';this.message=message;};exception.prototype=new Error();return exception;}()};},{}],81:[function(require,module,exports){"use strict";var Grammar=require('./Grammar/dist/Grammar');module.exports=function(SIP){return{parse:function parseCustom(input,startRule){var options={startRule:startRule,SIP:SIP};try{Grammar.parse(input,options);}catch(e){options.data=-1;}return options.data;}};};},{"./Grammar/dist/Grammar":82}],82:[function(require,module,exports){module.exports=function(){/*
   * Generated by PEG.js 0.8.0.
   *
   * http://pegjs.majda.cz/
   */function peg$subclass(child,parent){function ctor(){this.constructor=child;}ctor.prototype=parent.prototype;child.prototype=new ctor();}function SyntaxError(message,expected,found,offset,line,column){this.message=message;this.expected=expected;this.found=found;this.offset=offset;this.line=line;this.column=column;this.name="SyntaxError";}peg$subclass(SyntaxError,Error);function parse(input){var options=arguments.length>1?arguments[1]:{},peg$FAILED={},peg$startRuleIndices={Contact:118,Name_Addr_Header:155,Record_Route:175,Request_Response:81,SIP_URI:45,Subscription_State:185,Supported:190,Require:181,Via:193,absoluteURI:84,Call_ID:117,Content_Disposition:129,Content_Length:134,Content_Type:135,CSeq:145,displayName:121,Event:148,From:150,host:52,Max_Forwards:153,Min_SE:212,Proxy_Authenticate:156,quoted_string:40,Refer_To:177,Replaces:178,Session_Expires:209,stun_URI:216,To:191,turn_URI:223,uuid:226,WWW_Authenticate:208,challenge:157},peg$startRuleIndex=118,peg$consts=["\r\n",{type:"literal",value:"\r\n",description:"\"\\r\\n\""},/^[0-9]/,{type:"class",value:"[0-9]",description:"[0-9]"},/^[a-zA-Z]/,{type:"class",value:"[a-zA-Z]",description:"[a-zA-Z]"},/^[0-9a-fA-F]/,{type:"class",value:"[0-9a-fA-F]",description:"[0-9a-fA-F]"},/^[\0-\xFF]/,{type:"class",value:"[\\0-\\xFF]",description:"[\\0-\\xFF]"},/^["]/,{type:"class",value:"[\"]",description:"[\"]"}," ",{type:"literal",value:" ",description:"\" \""},"\t",{type:"literal",value:"\t",description:"\"\\t\""},/^[a-zA-Z0-9]/,{type:"class",value:"[a-zA-Z0-9]",description:"[a-zA-Z0-9]"},";",{type:"literal",value:";",description:"\";\""},"/",{type:"literal",value:"/",description:"\"/\""},"?",{type:"literal",value:"?",description:"\"?\""},":",{type:"literal",value:":",description:"\":\""},"@",{type:"literal",value:"@",description:"\"@\""},"&",{type:"literal",value:"&",description:"\"&\""},"=",{type:"literal",value:"=",description:"\"=\""},"+",{type:"literal",value:"+",description:"\"+\""},"$",{type:"literal",value:"$",description:"\"$\""},",",{type:"literal",value:",",description:"\",\""},"-",{type:"literal",value:"-",description:"\"-\""},"_",{type:"literal",value:"_",description:"\"_\""},".",{type:"literal",value:".",description:"\".\""},"!",{type:"literal",value:"!",description:"\"!\""},"~",{type:"literal",value:"~",description:"\"~\""},"*",{type:"literal",value:"*",description:"\"*\""},"'",{type:"literal",value:"'",description:"\"'\""},"(",{type:"literal",value:"(",description:"\"(\""},")",{type:"literal",value:")",description:"\")\""},peg$FAILED,"%",{type:"literal",value:"%",description:"\"%\""},null,[],function(){return" ";},function(){return':';},/^[!-~]/,{type:"class",value:"[!-~]",description:"[!-~]"},/^[\x80-\uFFFF]/,{type:"class",value:"[\\x80-\\uFFFF]",description:"[\\x80-\\uFFFF]"},/^[\x80-\xBF]/,{type:"class",value:"[\\x80-\\xBF]",description:"[\\x80-\\xBF]"},/^[a-f]/,{type:"class",value:"[a-f]",description:"[a-f]"},"`",{type:"literal",value:"`",description:"\"`\""},"<",{type:"literal",value:"<",description:"\"<\""},">",{type:"literal",value:">",description:"\">\""},"\\",{type:"literal",value:"\\",description:"\"\\\\\""},"[",{type:"literal",value:"[",description:"\"[\""},"]",{type:"literal",value:"]",description:"\"]\""},"{",{type:"literal",value:"{",description:"\"{\""},"}",{type:"literal",value:"}",description:"\"}\""},function(){return"*";},function(){return"/";},function(){return"=";},function(){return"(";},function(){return")";},function(){return">";},function(){return"<";},function(){return",";},function(){return";";},function(){return":";},function(){return"\"";},/^[!-']/,{type:"class",value:"[!-']",description:"[!-']"},/^[*-[]/,{type:"class",value:"[*-[]",description:"[*-[]"},/^[\]-~]/,{type:"class",value:"[\\]-~]",description:"[\\]-~]"},function(contents){return contents;},/^[#-[]/,{type:"class",value:"[#-[]",description:"[#-[]"},/^[\0-\t]/,{type:"class",value:"[\\0-\\t]",description:"[\\0-\\t]"},/^[\x0B-\f]/,{type:"class",value:"[\\x0B-\\f]",description:"[\\x0B-\\f]"},/^[\x0E-]/,{type:"class",value:"[\\x0E-]",description:"[\\x0E-]"},function(){options.data.uri=new options.SIP.URI(options.data.scheme,options.data.user,options.data.host,options.data.port);delete options.data.scheme;delete options.data.user;delete options.data.host;delete options.data.host_type;delete options.data.port;},function(){options.data.uri=new options.SIP.URI(options.data.scheme,options.data.user,options.data.host,options.data.port,options.data.uri_params,options.data.uri_headers);delete options.data.scheme;delete options.data.user;delete options.data.host;delete options.data.host_type;delete options.data.port;delete options.data.uri_params;if(options.startRule==='SIP_URI'){options.data=options.data.uri;}},"sips",{type:"literal",value:"sips",description:"\"sips\""},"sip",{type:"literal",value:"sip",description:"\"sip\""},function(uri_scheme){options.data.scheme=uri_scheme;},function(){options.data.user=decodeURIComponent(text().slice(0,-1));},function(){options.data.password=text();},function(){options.data.host=text();return options.data.host;},function(){options.data.host_type='domain';return text();},/^[a-zA-Z0-9_\-]/,{type:"class",value:"[a-zA-Z0-9_\\-]",description:"[a-zA-Z0-9_\\-]"},/^[a-zA-Z0-9\-]/,{type:"class",value:"[a-zA-Z0-9\\-]",description:"[a-zA-Z0-9\\-]"},function(){options.data.host_type='IPv6';return text();},"::",{type:"literal",value:"::",description:"\"::\""},function(){options.data.host_type='IPv6';return text();},function(){options.data.host_type='IPv4';return text();},"25",{type:"literal",value:"25",description:"\"25\""},/^[0-5]/,{type:"class",value:"[0-5]",description:"[0-5]"},"2",{type:"literal",value:"2",description:"\"2\""},/^[0-4]/,{type:"class",value:"[0-4]",description:"[0-4]"},"1",{type:"literal",value:"1",description:"\"1\""},/^[1-9]/,{type:"class",value:"[1-9]",description:"[1-9]"},function(port){port=parseInt(port.join(''));options.data.port=port;return port;},"transport=",{type:"literal",value:"transport=",description:"\"transport=\""},"udp",{type:"literal",value:"udp",description:"\"udp\""},"tcp",{type:"literal",value:"tcp",description:"\"tcp\""},"sctp",{type:"literal",value:"sctp",description:"\"sctp\""},"tls",{type:"literal",value:"tls",description:"\"tls\""},function(transport){if(!options.data.uri_params)options.data.uri_params={};options.data.uri_params['transport']=transport.toLowerCase();},"user=",{type:"literal",value:"user=",description:"\"user=\""},"phone",{type:"literal",value:"phone",description:"\"phone\""},"ip",{type:"literal",value:"ip",description:"\"ip\""},function(user){if(!options.data.uri_params)options.data.uri_params={};options.data.uri_params['user']=user.toLowerCase();},"method=",{type:"literal",value:"method=",description:"\"method=\""},function(method){if(!options.data.uri_params)options.data.uri_params={};options.data.uri_params['method']=method;},"ttl=",{type:"literal",value:"ttl=",description:"\"ttl=\""},function(ttl){if(!options.data.params)options.data.params={};options.data.params['ttl']=ttl;},"maddr=",{type:"literal",value:"maddr=",description:"\"maddr=\""},function(maddr){if(!options.data.uri_params)options.data.uri_params={};options.data.uri_params['maddr']=maddr;},"lr",{type:"literal",value:"lr",description:"\"lr\""},function(){if(!options.data.uri_params)options.data.uri_params={};options.data.uri_params['lr']=undefined;},function(param,value){if(!options.data.uri_params)options.data.uri_params={};if(value===null){value=undefined;}else{value=value[1];}options.data.uri_params[param.toLowerCase()]=value&&value.toLowerCase();},function(hname,hvalue){hname=hname.join('').toLowerCase();hvalue=hvalue.join('');if(!options.data.uri_headers)options.data.uri_headers={};if(!options.data.uri_headers[hname]){options.data.uri_headers[hname]=[hvalue];}else{options.data.uri_headers[hname].push(hvalue);}},function(){// lots of tests fail if this isn't guarded...
if(options.startRule==='Refer_To'){options.data.uri=new options.SIP.URI(options.data.scheme,options.data.user,options.data.host,options.data.port,options.data.uri_params,options.data.uri_headers);delete options.data.scheme;delete options.data.user;delete options.data.host;delete options.data.host_type;delete options.data.port;delete options.data.uri_params;}},"//",{type:"literal",value:"//",description:"\"//\""},function(){options.data.scheme=text();},{type:"literal",value:"SIP",description:"\"SIP\""},function(){options.data.sip_version=text();},"INVITE",{type:"literal",value:"INVITE",description:"\"INVITE\""},"ACK",{type:"literal",value:"ACK",description:"\"ACK\""},"VXACH",{type:"literal",value:"VXACH",description:"\"VXACH\""},"OPTIONS",{type:"literal",value:"OPTIONS",description:"\"OPTIONS\""},"BYE",{type:"literal",value:"BYE",description:"\"BYE\""},"CANCEL",{type:"literal",value:"CANCEL",description:"\"CANCEL\""},"REGISTER",{type:"literal",value:"REGISTER",description:"\"REGISTER\""},"SUBSCRIBE",{type:"literal",value:"SUBSCRIBE",description:"\"SUBSCRIBE\""},"NOTIFY",{type:"literal",value:"NOTIFY",description:"\"NOTIFY\""},"REFER",{type:"literal",value:"REFER",description:"\"REFER\""},function(){options.data.method=text();return options.data.method;},function(status_code){options.data.status_code=parseInt(status_code.join(''));},function(){options.data.reason_phrase=text();},function(){options.data=text();},function(){var idx,length;length=options.data.multi_header.length;for(idx=0;idx<length;idx++){if(options.data.multi_header[idx].parsed===null){options.data=null;break;}}if(options.data!==null){options.data=options.data.multi_header;}else{options.data=-1;}},function(){var header;if(!options.data.multi_header)options.data.multi_header=[];try{header=new options.SIP.NameAddrHeader(options.data.uri,options.data.displayName,options.data.params);delete options.data.uri;delete options.data.displayName;delete options.data.params;}catch(e){header=null;}options.data.multi_header.push({'position':peg$currPos,'offset':offset(),'parsed':header});},function(displayName){displayName=text().trim();if(displayName[0]==='\"'){displayName=displayName.substring(1,displayName.length-1);}options.data.displayName=displayName;},"q",{type:"literal",value:"q",description:"\"q\""},function(q){if(!options.data.params)options.data.params={};options.data.params['q']=q;},"expires",{type:"literal",value:"expires",description:"\"expires\""},function(expires){if(!options.data.params)options.data.params={};options.data.params['expires']=expires;},function(delta_seconds){return parseInt(delta_seconds.join(''));},"0",{type:"literal",value:"0",description:"\"0\""},function(){return parseFloat(text());},function(param,value){if(!options.data.params)options.data.params={};if(value===null){value=undefined;}else{value=value[1];}options.data.params[param.toLowerCase()]=value;},"render",{type:"literal",value:"render",description:"\"render\""},"session",{type:"literal",value:"session",description:"\"session\""},"icon",{type:"literal",value:"icon",description:"\"icon\""},"alert",{type:"literal",value:"alert",description:"\"alert\""},function(){if(options.startRule==='Content_Disposition'){options.data.type=text().toLowerCase();}},"handling",{type:"literal",value:"handling",description:"\"handling\""},"optional",{type:"literal",value:"optional",description:"\"optional\""},"required",{type:"literal",value:"required",description:"\"required\""},function(length){options.data=parseInt(length.join(''));},function(){options.data=text();},"text",{type:"literal",value:"text",description:"\"text\""},"image",{type:"literal",value:"image",description:"\"image\""},"audio",{type:"literal",value:"audio",description:"\"audio\""},"video",{type:"literal",value:"video",description:"\"video\""},"application",{type:"literal",value:"application",description:"\"application\""},"message",{type:"literal",value:"message",description:"\"message\""},"multipart",{type:"literal",value:"multipart",description:"\"multipart\""},"x-",{type:"literal",value:"x-",description:"\"x-\""},function(cseq_value){options.data.value=parseInt(cseq_value.join(''));},function(expires){options.data=expires;},function(event_type){options.data.event=event_type.toLowerCase();},function(){var tag=options.data.tag;options.data=new options.SIP.NameAddrHeader(options.data.uri,options.data.displayName,options.data.params);if(tag){options.data.setParam('tag',tag);}},"tag",{type:"literal",value:"tag",description:"\"tag\""},function(tag){options.data.tag=tag;},function(forwards){options.data=parseInt(forwards.join(''));},function(min_expires){options.data=min_expires;},function(){options.data=new options.SIP.NameAddrHeader(options.data.uri,options.data.displayName,options.data.params);},"digest",{type:"literal",value:"Digest",description:"\"Digest\""},"realm",{type:"literal",value:"realm",description:"\"realm\""},function(realm){options.data.realm=realm;},"domain",{type:"literal",value:"domain",description:"\"domain\""},"nonce",{type:"literal",value:"nonce",description:"\"nonce\""},function(nonce){options.data.nonce=nonce;},"opaque",{type:"literal",value:"opaque",description:"\"opaque\""},function(opaque){options.data.opaque=opaque;},"stale",{type:"literal",value:"stale",description:"\"stale\""},"true",{type:"literal",value:"true",description:"\"true\""},function(){options.data.stale=true;},"false",{type:"literal",value:"false",description:"\"false\""},function(){options.data.stale=false;},"algorithm",{type:"literal",value:"algorithm",description:"\"algorithm\""},"md5",{type:"literal",value:"MD5",description:"\"MD5\""},"md5-sess",{type:"literal",value:"MD5-sess",description:"\"MD5-sess\""},function(algorithm){options.data.algorithm=algorithm.toUpperCase();},"qop",{type:"literal",value:"qop",description:"\"qop\""},"auth-int",{type:"literal",value:"auth-int",description:"\"auth-int\""},"auth",{type:"literal",value:"auth",description:"\"auth\""},function(qop_value){options.data.qop||(options.data.qop=[]);options.data.qop.push(qop_value.toLowerCase());},function(rack_value){options.data.value=parseInt(rack_value.join(''));},function(){var idx,length;length=options.data.multi_header.length;for(idx=0;idx<length;idx++){if(options.data.multi_header[idx].parsed===null){options.data=null;break;}}if(options.data!==null){options.data=options.data.multi_header;}else{options.data=-1;}},function(){var header;if(!options.data.multi_header)options.data.multi_header=[];try{header=new options.SIP.NameAddrHeader(options.data.uri,options.data.displayName,options.data.params);delete options.data.uri;delete options.data.displayName;delete options.data.params;}catch(e){header=null;}options.data.multi_header.push({'position':peg$currPos,'offset':offset(),'parsed':header});},function(){options.data=new options.SIP.NameAddrHeader(options.data.uri,options.data.displayName,options.data.params);},function(){if(!(options.data.replaces_from_tag&&options.data.replaces_to_tag)){options.data=-1;}},function(){options.data={call_id:options.data};},"from-tag",{type:"literal",value:"from-tag",description:"\"from-tag\""},function(from_tag){options.data.replaces_from_tag=from_tag;},"to-tag",{type:"literal",value:"to-tag",description:"\"to-tag\""},function(to_tag){options.data.replaces_to_tag=to_tag;},"early-only",{type:"literal",value:"early-only",description:"\"early-only\""},function(){options.data.early_only=true;},function(r){return r;},function(first,rest){return list(first,rest);},function(value){if(options.startRule==='Require'){options.data=value||[];}},function(rseq_value){options.data.value=parseInt(rseq_value.join(''));},"active",{type:"literal",value:"active",description:"\"active\""},"pending",{type:"literal",value:"pending",description:"\"pending\""},"terminated",{type:"literal",value:"terminated",description:"\"terminated\""},function(){options.data.state=text();},"reason",{type:"literal",value:"reason",description:"\"reason\""},function(reason){if(typeof reason!=='undefined')options.data.reason=reason;},function(expires){if(typeof expires!=='undefined')options.data.expires=expires;},"retry_after",{type:"literal",value:"retry_after",description:"\"retry_after\""},function(retry_after){if(typeof retry_after!=='undefined')options.data.retry_after=retry_after;},"deactivated",{type:"literal",value:"deactivated",description:"\"deactivated\""},"probation",{type:"literal",value:"probation",description:"\"probation\""},"rejected",{type:"literal",value:"rejected",description:"\"rejected\""},"timeout",{type:"literal",value:"timeout",description:"\"timeout\""},"giveup",{type:"literal",value:"giveup",description:"\"giveup\""},"noresource",{type:"literal",value:"noresource",description:"\"noresource\""},"invariant",{type:"literal",value:"invariant",description:"\"invariant\""},function(value){if(options.startRule==='Supported'){options.data=value||[];}},function(){var tag=options.data.tag;options.data=new options.SIP.NameAddrHeader(options.data.uri,options.data.displayName,options.data.params);if(tag){options.data.setParam('tag',tag);}},"ttl",{type:"literal",value:"ttl",description:"\"ttl\""},function(via_ttl_value){options.data.ttl=via_ttl_value;},"maddr",{type:"literal",value:"maddr",description:"\"maddr\""},function(via_maddr){options.data.maddr=via_maddr;},"received",{type:"literal",value:"received",description:"\"received\""},function(via_received){options.data.received=via_received;},"branch",{type:"literal",value:"branch",description:"\"branch\""},function(via_branch){options.data.branch=via_branch;},"rport",{type:"literal",value:"rport",description:"\"rport\""},function(){if(typeof response_port!=='undefined')options.data.rport=response_port.join('');},function(via_protocol){options.data.protocol=via_protocol;},{type:"literal",value:"UDP",description:"\"UDP\""},{type:"literal",value:"TCP",description:"\"TCP\""},{type:"literal",value:"TLS",description:"\"TLS\""},{type:"literal",value:"SCTP",description:"\"SCTP\""},function(via_transport){options.data.transport=via_transport;},function(){options.data.host=text();},function(via_sent_by_port){options.data.port=parseInt(via_sent_by_port.join(''));},function(ttl){return parseInt(ttl.join(''));},function(deltaSeconds){if(options.startRule==='Session_Expires'){options.data.deltaSeconds=deltaSeconds;}},"refresher",{type:"literal",value:"refresher",description:"\"refresher\""},"uas",{type:"literal",value:"uas",description:"\"uas\""},"uac",{type:"literal",value:"uac",description:"\"uac\""},function(endpoint){if(options.startRule==='Session_Expires'){options.data.refresher=endpoint;}},function(deltaSeconds){if(options.startRule==='Min_SE'){options.data=deltaSeconds;}},"stuns",{type:"literal",value:"stuns",description:"\"stuns\""},"stun",{type:"literal",value:"stun",description:"\"stun\""},function(scheme){options.data.scheme=scheme;},function(host){options.data.host=host;},"?transport=",{type:"literal",value:"?transport=",description:"\"?transport=\""},"turns",{type:"literal",value:"turns",description:"\"turns\""},"turn",{type:"literal",value:"turn",description:"\"turn\""},function(){options.data.transport=transport;},function(){options.data=text();}],peg$bytecode=[peg$decode(". \"\"2 3!"),peg$decode("0\"\"\"1!3#"),peg$decode("0$\"\"1!3%"),peg$decode("0&\"\"1!3'"),peg$decode("7'*# \"7("),peg$decode("0(\"\"1!3)"),peg$decode("0*\"\"1!3+"),peg$decode(".,\"\"2,3-"),peg$decode("..\"\"2.3/"),peg$decode("00\"\"1!31"),peg$decode(".2\"\"2233*\x89 \".4\"\"2435*} \".6\"\"2637*q \".8\"\"2839*e \".:\"\"2:3;*Y \".<\"\"2<3=*M \".>\"\"2>3?*A \".@\"\"2@3A*5 \".B\"\"2B3C*) \".D\"\"2D3E"),peg$decode("7)*# \"7,"),peg$decode(".F\"\"2F3G*} \".H\"\"2H3I*q \".J\"\"2J3K*e \".L\"\"2L3M*Y \".N\"\"2N3O*M \".P\"\"2P3Q*A \".R\"\"2R3S*5 \".T\"\"2T3U*) \".V\"\"2V3W"),peg$decode("!!.Y\"\"2Y3Z+7$7#+-%7#+#%'#%$## X$\"# X\"# X+! (%"),peg$decode("!! \\7$,#&7$\"+-$7 +#%'\"%$\"# X\"# X*# \" [+@$ \\7$+&$,#&7$\"\"\" X+'%4\"6]\" %$\"# X\"# X"),peg$decode("7.*# \" ["),peg$decode("! \\7'*# \"7(,)&7'*# \"7(\"+A$.8\"\"2839+1%7/+'%4#6^# %$## X$\"# X\"# X"),peg$decode("!! \\72+&$,#&72\"\"\" X+o$ \\! \\7.,#&7.\"+-$72+#%'\"%$\"# X\"# X,@&! \\7.,#&7.\"+-$72+#%'\"%$\"# X\"# X\"+#%'\"%$\"# X\"# X+! (%"),peg$decode("0_\"\"1!3`*# \"73"),peg$decode("0a\"\"1!3b"),peg$decode("0c\"\"1!3d"),peg$decode("7!*) \"0e\"\"1!3f"),peg$decode("! \\7)*\x95 \".F\"\"2F3G*\x89 \".J\"\"2J3K*} \".L\"\"2L3M*q \".Y\"\"2Y3Z*e \".P\"\"2P3Q*Y \".H\"\"2H3I*M \".@\"\"2@3A*A \".g\"\"2g3h*5 \".R\"\"2R3S*) \".N\"\"2N3O+\x9E$,\x9B&7)*\x95 \".F\"\"2F3G*\x89 \".J\"\"2J3K*} \".L\"\"2L3M*q \".Y\"\"2Y3Z*e \".P\"\"2P3Q*Y \".H\"\"2H3I*M \".@\"\"2@3A*A \".g\"\"2g3h*5 \".R\"\"2R3S*) \".N\"\"2N3O\"\"\" X+! (%"),peg$decode("! \\7)*\x89 \".F\"\"2F3G*} \".L\"\"2L3M*q \".Y\"\"2Y3Z*e \".P\"\"2P3Q*Y \".H\"\"2H3I*M \".@\"\"2@3A*A \".g\"\"2g3h*5 \".R\"\"2R3S*) \".N\"\"2N3O+\x92$,\x8F&7)*\x89 \".F\"\"2F3G*} \".L\"\"2L3M*q \".Y\"\"2Y3Z*e \".P\"\"2P3Q*Y \".H\"\"2H3I*M \".@\"\"2@3A*A \".g\"\"2g3h*5 \".R\"\"2R3S*) \".N\"\"2N3O\"\"\" X+! (%"),peg$decode(".T\"\"2T3U*\xE3 \".V\"\"2V3W*\xD7 \".i\"\"2i3j*\xCB \".k\"\"2k3l*\xBF \".:\"\"2:3;*\xB3 \".D\"\"2D3E*\xA7 \".2\"\"2233*\x9B \".8\"\"2839*\x8F \".m\"\"2m3n*\x83 \"7&*} \".4\"\"2435*q \".o\"\"2o3p*e \".q\"\"2q3r*Y \".6\"\"2637*M \".>\"\"2>3?*A \".s\"\"2s3t*5 \".u\"\"2u3v*) \"7'*# \"7("),peg$decode("! \\7)*\u012B \".F\"\"2F3G*\u011F \".J\"\"2J3K*\u0113 \".L\"\"2L3M*\u0107 \".Y\"\"2Y3Z*\xFB \".P\"\"2P3Q*\xEF \".H\"\"2H3I*\xE3 \".@\"\"2@3A*\xD7 \".g\"\"2g3h*\xCB \".R\"\"2R3S*\xBF \".N\"\"2N3O*\xB3 \".T\"\"2T3U*\xA7 \".V\"\"2V3W*\x9B \".i\"\"2i3j*\x8F \".k\"\"2k3l*\x83 \".8\"\"2839*w \".m\"\"2m3n*k \"7&*e \".4\"\"2435*Y \".o\"\"2o3p*M \".q\"\"2q3r*A \".6\"\"2637*5 \".s\"\"2s3t*) \".u\"\"2u3v+\u0134$,\u0131&7)*\u012B \".F\"\"2F3G*\u011F \".J\"\"2J3K*\u0113 \".L\"\"2L3M*\u0107 \".Y\"\"2Y3Z*\xFB \".P\"\"2P3Q*\xEF \".H\"\"2H3I*\xE3 \".@\"\"2@3A*\xD7 \".g\"\"2g3h*\xCB \".R\"\"2R3S*\xBF \".N\"\"2N3O*\xB3 \".T\"\"2T3U*\xA7 \".V\"\"2V3W*\x9B \".i\"\"2i3j*\x8F \".k\"\"2k3l*\x83 \".8\"\"2839*w \".m\"\"2m3n*k \"7&*e \".4\"\"2435*Y \".o\"\"2o3p*M \".q\"\"2q3r*A \".6\"\"2637*5 \".s\"\"2s3t*) \".u\"\"2u3v\"\"\" X+! (%"),peg$decode("!7/+A$.P\"\"2P3Q+1%7/+'%4#6w# %$## X$\"# X\"# X"),peg$decode("!7/+A$.4\"\"2435+1%7/+'%4#6x# %$## X$\"# X\"# X"),peg$decode("!7/+A$.>\"\"2>3?+1%7/+'%4#6y# %$## X$\"# X\"# X"),peg$decode("!7/+A$.T\"\"2T3U+1%7/+'%4#6z# %$## X$\"# X\"# X"),peg$decode("!7/+A$.V\"\"2V3W+1%7/+'%4#6{# %$## X$\"# X\"# X"),peg$decode("!.k\"\"2k3l+1$7/+'%4\"6|\" %$\"# X\"# X"),peg$decode("!7/+7$.i\"\"2i3j+'%4\"6}\" %$\"# X\"# X"),peg$decode("!7/+A$.D\"\"2D3E+1%7/+'%4#6~# %$## X$\"# X\"# X"),peg$decode("!7/+A$.2\"\"2233+1%7/+'%4#6# %$## X$\"# X\"# X"),peg$decode("!7/+A$.8\"\"2839+1%7/+'%4#6\x80# %$## X$\"# X\"# X"),peg$decode("!7/+1$7&+'%4\"6\x81\" %$\"# X\"# X"),peg$decode("!7&+1$7/+'%4\"6\x81\" %$\"# X\"# X"),peg$decode("!7=+W$ \\7G*) \"7K*# \"7F,/&7G*) \"7K*# \"7F\"+-%7>+#%'#%$## X$\"# X\"# X"),peg$decode("0\x82\"\"1!3\x83*A \"0\x84\"\"1!3\x85*5 \"0\x86\"\"1!3\x87*) \"73*# \"7."),peg$decode("!!7/+U$7&+K% \\7J*# \"7K,)&7J*# \"7K\"+-%7&+#%'$%$$# X$## X$\"# X\"# X+! (%"),peg$decode("!7/+`$7&+V%! \\7J*# \"7K,)&7J*# \"7K\"+! (%+2%7&+(%4$6\x88$!!%$$# X$## X$\"# X\"# X"),peg$decode("7.*G \".L\"\"2L3M*; \"0\x89\"\"1!3\x8A*/ \"0\x86\"\"1!3\x87*# \"73"),peg$decode("!.m\"\"2m3n+K$0\x8B\"\"1!3\x8C*5 \"0\x8D\"\"1!3\x8E*) \"0\x8F\"\"1!3\x90+#%'\"%$\"# X\"# X"),peg$decode("!7N+Q$.8\"\"2839+A%7O*# \" [+1%7S+'%4$6\x91$ %$$# X$## X$\"# X\"# X"),peg$decode("!7N+k$.8\"\"2839+[%7O*# \" [+K%7S+A%7_+7%7l*# \" [+'%4&6\x92& %$&# X$%# X$$# X$## X$\"# X\"# X"),peg$decode("!/\x93\"\"1$3\x94*) \"/\x95\"\"1#3\x96+' 4!6\x97!! %"),peg$decode("!7P+b$!.8\"\"2839+-$7R+#%'\"%$\"# X\"# X*# \" [+7%.:\"\"2:3;+'%4#6\x98# %$## X$\"# X\"# X"),peg$decode(" \\7+*) \"7-*# \"7Q+2$,/&7+*) \"7-*# \"7Q\"\"\" X"),peg$decode(".<\"\"2<3=*q \".>\"\"2>3?*e \".@\"\"2@3A*Y \".B\"\"2B3C*M \".D\"\"2D3E*A \".2\"\"2233*5 \".6\"\"2637*) \".4\"\"2435"),peg$decode("! \\7+*_ \"7-*Y \".<\"\"2<3=*M \".>\"\"2>3?*A \".@\"\"2@3A*5 \".B\"\"2B3C*) \".D\"\"2D3E,e&7+*_ \"7-*Y \".<\"\"2<3=*M \".>\"\"2>3?*A \".@\"\"2@3A*5 \".B\"\"2B3C*) \".D\"\"2D3E\"+& 4!6\x99! %"),peg$decode("!7T+N$!.8\"\"2839+-$7^+#%'\"%$\"# X\"# X*# \" [+#%'\"%$\"# X\"# X"),peg$decode("!7U*) \"7\\*# \"7X+& 4!6\x9A! %"),peg$decode("! \\!7V+3$.J\"\"2J3K+#%'\"%$\"# X\"# X,>&!7V+3$.J\"\"2J3K+#%'\"%$\"# X\"# X\"+G$7W+=%.J\"\"2J3K*# \" [+'%4#6\x9B# %$## X$\"# X\"# X"),peg$decode(" \\0\x9C\"\"1!3\x9D+,$,)&0\x9C\"\"1!3\x9D\"\"\" X"),peg$decode("!0$\"\"1!3%+A$ \\0\x9E\"\"1!3\x9F,)&0\x9E\"\"1!3\x9F\"+#%'\"%$\"# X\"# X"),peg$decode("!.o\"\"2o3p+A$7Y+7%.q\"\"2q3r+'%4#6\xA0# %$## X$\"# X\"# X"),peg$decode("!!7Z+\xBF$.8\"\"2839+\xAF%7Z+\xA5%.8\"\"2839+\x95%7Z+\x8B%.8\"\"2839+{%7Z+q%.8\"\"2839+a%7Z+W%.8\"\"2839+G%7Z+=%.8\"\"2839+-%7[+#%'-%$-# X$,# X$+# X$*# X$)# X$(# X$'# X$&# X$%# X$$# X$## X$\"# X\"# X*\u0838 \"!.\xA1\"\"2\xA13\xA2+\xAF$7Z+\xA5%.8\"\"2839+\x95%7Z+\x8B%.8\"\"2839+{%7Z+q%.8\"\"2839+a%7Z+W%.8\"\"2839+G%7Z+=%.8\"\"2839+-%7[+#%',%$,# X$+# X$*# X$)# X$(# X$'# X$&# X$%# X$$# X$## X$\"# X\"# X*\u0795 \"!.\xA1\"\"2\xA13\xA2+\x95$7Z+\x8B%.8\"\"2839+{%7Z+q%.8\"\"2839+a%7Z+W%.8\"\"2839+G%7Z+=%.8\"\"2839+-%7[+#%'*%$*# X$)# X$(# X$'# X$&# X$%# X$$# X$## X$\"# X\"# X*\u070C \"!.\xA1\"\"2\xA13\xA2+{$7Z+q%.8\"\"2839+a%7Z+W%.8\"\"2839+G%7Z+=%.8\"\"2839+-%7[+#%'(%$(# X$'# X$&# X$%# X$$# X$## X$\"# X\"# X*\u069D \"!.\xA1\"\"2\xA13\xA2+a$7Z+W%.8\"\"2839+G%7Z+=%.8\"\"2839+-%7[+#%'&%$&# X$%# X$$# X$## X$\"# X\"# X*\u0648 \"!.\xA1\"\"2\xA13\xA2+G$7Z+=%.8\"\"2839+-%7[+#%'$%$$# X$## X$\"# X\"# X*\u060D \"!.\xA1\"\"2\xA13\xA2+-$7[+#%'\"%$\"# X\"# X*\u05EC \"!.\xA1\"\"2\xA13\xA2+-$7Z+#%'\"%$\"# X\"# X*\u05CB \"!7Z+\xA5$.\xA1\"\"2\xA13\xA2+\x95%7Z+\x8B%.8\"\"2839+{%7Z+q%.8\"\"2839+a%7Z+W%.8\"\"2839+G%7Z+=%.8\"\"2839+-%7[+#%'+%$+# X$*# X$)# X$(# X$'# X$&# X$%# X$$# X$## X$\"# X\"# X*\u0538 \"!7Z+\xB6$!.8\"\"2839+-$7Z+#%'\"%$\"# X\"# X*# \" [+\x8B%.\xA1\"\"2\xA13\xA2+{%7Z+q%.8\"\"2839+a%7Z+W%.8\"\"2839+G%7Z+=%.8\"\"2839+-%7[+#%'*%$*# X$)# X$(# X$'# X$&# X$%# X$$# X$## X$\"# X\"# X*\u0494 \"!7Z+\xC7$!.8\"\"2839+-$7Z+#%'\"%$\"# X\"# X*# \" [+\x9C%!.8\"\"2839+-$7Z+#%'\"%$\"# X\"# X*# \" [+q%.\xA1\"\"2\xA13\xA2+a%7Z+W%.8\"\"2839+G%7Z+=%.8\"\"2839+-%7[+#%')%$)# X$(# X$'# X$&# X$%# X$$# X$## X$\"# X\"# X*\u03DF \"!7Z+\xD8$!.8\"\"2839+-$7Z+#%'\"%$\"# X\"# X*# \" [+\xAD%!.8\"\"2839+-$7Z+#%'\"%$\"# X\"# X*# \" [+\x82%!.8\"\"2839+-$7Z+#%'\"%$\"# X\"# X*# \" [+W%.\xA1\"\"2\xA13\xA2+G%7Z+=%.8\"\"2839+-%7[+#%'(%$(# X$'# X$&# X$%# X$$# X$## X$\"# X\"# X*\u0319 \"!7Z+\xE9$!.8\"\"2839+-$7Z+#%'\"%$\"# X\"# X*# \" [+\xBE%!.8\"\"2839+-$7Z+#%'\"%$\"# X\"# X*# \" [+\x93%!.8\"\"2839+-$7Z+#%'\"%$\"# X\"# X*# \" [+h%!.8\"\"2839+-$7Z+#%'\"%$\"# X\"# X*# \" [+=%.\xA1\"\"2\xA13\xA2+-%7[+#%''%$'# X$&# X$%# X$$# X$## X$\"# X\"# X*\u0242 \"!7Z+\u0114$!.8\"\"2839+-$7Z+#%'\"%$\"# X\"# X*# \" [+\xE9%!.8\"\"2839+-$7Z+#%'\"%$\"# X\"# X*# \" [+\xBE%!.8\"\"2839+-$7Z+#%'\"%$\"# X\"# X*# \" [+\x93%!.8\"\"2839+-$7Z+#%'\"%$\"# X\"# X*# \" [+h%!.8\"\"2839+-$7Z+#%'\"%$\"# X\"# X*# \" [+=%.\xA1\"\"2\xA13\xA2+-%7Z+#%'(%$(# X$'# X$&# X$%# X$$# X$## X$\"# X\"# X*\u0140 \"!7Z+\u0135$!.8\"\"2839+-$7Z+#%'\"%$\"# X\"# X*# \" [+\u010A%!.8\"\"2839+-$7Z+#%'\"%$\"# X\"# X*# \" [+\xDF%!.8\"\"2839+-$7Z+#%'\"%$\"# X\"# X*# \" [+\xB4%!.8\"\"2839+-$7Z+#%'\"%$\"# X\"# X*# \" [+\x89%!.8\"\"2839+-$7Z+#%'\"%$\"# X\"# X*# \" [+^%!.8\"\"2839+-$7Z+#%'\"%$\"# X\"# X*# \" [+3%.\xA1\"\"2\xA13\xA2+#%'(%$(# X$'# X$&# X$%# X$$# X$## X$\"# X\"# X+& 4!6\xA3! %"),peg$decode("!7#+S$7#*# \" [+C%7#*# \" [+3%7#*# \" [+#%'$%$$# X$## X$\"# X\"# X"),peg$decode("!7Z+=$.8\"\"2839+-%7Z+#%'#%$## X$\"# X\"# X*# \"7\\"),peg$decode("!7]+u$.J\"\"2J3K+e%7]+[%.J\"\"2J3K+K%7]+A%.J\"\"2J3K+1%7]+'%4'6\xA4' %$'# X$&# X$%# X$$# X$## X$\"# X\"# X"),peg$decode("!.\xA5\"\"2\xA53\xA6+3$0\xA7\"\"1!3\xA8+#%'\"%$\"# X\"# X*\xA0 \"!.\xA9\"\"2\xA93\xAA+=$0\xAB\"\"1!3\xAC+-%7!+#%'#%$## X$\"# X\"# X*o \"!.\xAD\"\"2\xAD3\xAE+7$7!+-%7!+#%'#%$## X$\"# X\"# X*D \"!0\xAF\"\"1!3\xB0+-$7!+#%'\"%$\"# X\"# X*# \"7!"),peg$decode("!!7!*# \" [+c$7!*# \" [+S%7!*# \" [+C%7!*# \" [+3%7!*# \" [+#%'%%$%# X$$# X$## X$\"# X\"# X+' 4!6\xB1!! %"),peg$decode(" \\!.2\"\"2233+-$7`+#%'\"%$\"# X\"# X,>&!.2\"\"2233+-$7`+#%'\"%$\"# X\"# X\""),peg$decode("7a*A \"7b*; \"7c*5 \"7d*/ \"7e*) \"7f*# \"7g"),peg$decode("!/\xB2\"\"1*3\xB3+b$/\xB4\"\"1#3\xB5*G \"/\xB6\"\"1#3\xB7*; \"/\xB8\"\"1$3\xB9*/ \"/\xBA\"\"1#3\xBB*# \"76+(%4\"6\xBC\"! %$\"# X\"# X"),peg$decode("!/\xBD\"\"1%3\xBE+J$/\xBF\"\"1%3\xC0*/ \"/\xC1\"\"1\"3\xC2*# \"76+(%4\"6\xC3\"! %$\"# X\"# X"),peg$decode("!/\xC4\"\"1'3\xC5+2$7\x8F+(%4\"6\xC6\"! %$\"# X\"# X"),peg$decode("!/\xC7\"\"1$3\xC8+2$7\xEF+(%4\"6\xC9\"! %$\"# X\"# X"),peg$decode("!/\xCA\"\"1&3\xCB+2$7T+(%4\"6\xCC\"! %$\"# X\"# X"),peg$decode("!/\xCD\"\"1\"3\xCE+R$!.>\"\"2>3?+-$76+#%'\"%$\"# X\"# X*# \" [+'%4\"6\xCF\" %$\"# X\"# X"),peg$decode("!7h+T$!.>\"\"2>3?+-$7i+#%'\"%$\"# X\"# X*# \" [+)%4\"6\xD0\"\"! %$\"# X\"# X"),peg$decode("! \\7j+&$,#&7j\"\"\" X+! (%"),peg$decode("! \\7j+&$,#&7j\"\"\" X+! (%"),peg$decode("7k*) \"7+*# \"7-"),peg$decode(".o\"\"2o3p*e \".q\"\"2q3r*Y \".4\"\"2435*M \".8\"\"2839*A \".<\"\"2<3=*5 \".@\"\"2@3A*) \".B\"\"2B3C"),peg$decode("!.6\"\"2637+u$7m+k% \\!.<\"\"2<3=+-$7m+#%'\"%$\"# X\"# X,>&!.<\"\"2<3=+-$7m+#%'\"%$\"# X\"# X\"+#%'#%$## X$\"# X\"# X"),peg$decode("!7n+C$.>\"\"2>3?+3%7o+)%4#6\xD1#\"\" %$## X$\"# X\"# X"),peg$decode(" \\7p*) \"7+*# \"7-+2$,/&7p*) \"7+*# \"7-\"\"\" X"),peg$decode(" \\7p*) \"7+*# \"7-,/&7p*) \"7+*# \"7-\""),peg$decode(".o\"\"2o3p*e \".q\"\"2q3r*Y \".4\"\"2435*M \".6\"\"2637*A \".8\"\"2839*5 \".@\"\"2@3A*) \".B\"\"2B3C"),peg$decode("7\x90*# \"7r"),peg$decode("!7\x8F+K$7'+A%7s+7%7'+-%7\x84+#%'%%$%# X$$# X$## X$\"# X\"# X"),peg$decode("7M*# \"7t"),peg$decode("!7+G$.8\"\"2839+7%7u*# \"7x+'%4#6\xD2# %$## X$\"# X\"# X"),peg$decode("!7v*# \"7w+N$!.6\"\"2637+-$7\x83+#%'\"%$\"# X\"# X*# \" [+#%'\"%$\"# X\"# X"),peg$decode("!.\xD3\"\"2\xD33\xD4+=$7\x80+3%7w*# \" [+#%'#%$## X$\"# X\"# X"),peg$decode("!.4\"\"2435+-$7{+#%'\"%$\"# X\"# X"),peg$decode("!7z+5$ \\7y,#&7y\"+#%'\"%$\"# X\"# X"),peg$decode("7**) \"7+*# \"7-"),peg$decode("7+*\x8F \"7-*\x89 \".2\"\"2233*} \".6\"\"2637*q \".8\"\"2839*e \".:\"\"2:3;*Y \".<\"\"2<3=*M \".>\"\"2>3?*A \".@\"\"2@3A*5 \".B\"\"2B3C*) \".D\"\"2D3E"),peg$decode("!7|+k$ \\!.4\"\"2435+-$7|+#%'\"%$\"# X\"# X,>&!.4\"\"2435+-$7|+#%'\"%$\"# X\"# X\"+#%'\"%$\"# X\"# X"),peg$decode("! \\7~,#&7~\"+k$ \\!.2\"\"2233+-$7}+#%'\"%$\"# X\"# X,>&!.2\"\"2233+-$7}+#%'\"%$\"# X\"# X\"+#%'\"%$\"# X\"# X"),peg$decode(" \\7~,#&7~\""),peg$decode("7+*w \"7-*q \".8\"\"2839*e \".:\"\"2:3;*Y \".<\"\"2<3=*M \".>\"\"2>3?*A \".@\"\"2@3A*5 \".B\"\"2B3C*) \".D\"\"2D3E"),peg$decode("!7\"+\x8D$ \\7\"*G \"7!*A \".@\"\"2@3A*5 \".F\"\"2F3G*) \".J\"\"2J3K,M&7\"*G \"7!*A \".@\"\"2@3A*5 \".F\"\"2F3G*) \".J\"\"2J3K\"+'%4\"6\xD5\" %$\"# X\"# X"),peg$decode("7\x81*# \"7\x82"),peg$decode("!!7O+3$.:\"\"2:3;+#%'\"%$\"# X\"# X*# \" [+-$7S+#%'\"%$\"# X\"# X*# \" ["),peg$decode(" \\7+*\x83 \"7-*} \".B\"\"2B3C*q \".D\"\"2D3E*e \".2\"\"2233*Y \".8\"\"2839*M \".:\"\"2:3;*A \".<\"\"2<3=*5 \".>\"\"2>3?*) \".@\"\"2@3A+\x8C$,\x89&7+*\x83 \"7-*} \".B\"\"2B3C*q \".D\"\"2D3E*e \".2\"\"2233*Y \".8\"\"2839*M \".:\"\"2:3;*A \".<\"\"2<3=*5 \".>\"\"2>3?*) \".@\"\"2@3A\"\"\" X"),peg$decode(" \\7y,#&7y\""),peg$decode("!/\x95\"\"1#3\xD6+y$.4\"\"2435+i% \\7!+&$,#&7!\"\"\" X+P%.J\"\"2J3K+@% \\7!+&$,#&7!\"\"\" X+'%4%6\xD7% %$%# X$$# X$## X$\"# X\"# X"),peg$decode(".\xD8\"\"2\xD83\xD9"),peg$decode(".\xDA\"\"2\xDA3\xDB"),peg$decode(".\xDC\"\"2\xDC3\xDD"),peg$decode(".\xDE\"\"2\xDE3\xDF"),peg$decode(".\xE0\"\"2\xE03\xE1"),peg$decode(".\xE2\"\"2\xE23\xE3"),peg$decode(".\xE4\"\"2\xE43\xE5"),peg$decode(".\xE6\"\"2\xE63\xE7"),peg$decode(".\xE8\"\"2\xE83\xE9"),peg$decode(".\xEA\"\"2\xEA3\xEB"),peg$decode("!7\x85*S \"7\x86*M \"7\x88*G \"7\x89*A \"7\x8A*; \"7\x8B*5 \"7\x8C*/ \"7\x8D*) \"7\x8E*# \"76+& 4!6\xEC! %"),peg$decode("!7\x84+K$7'+A%7\x91+7%7'+-%7\x93+#%'%%$%# X$$# X$## X$\"# X\"# X"),peg$decode("!7\x92+' 4!6\xED!! %"),peg$decode("!7!+7$7!+-%7!+#%'#%$## X$\"# X\"# X"),peg$decode("! \\7**A \"7+*; \"7-*5 \"73*/ \"74*) \"7'*# \"7(,G&7**A \"7+*; \"7-*5 \"73*/ \"74*) \"7'*# \"7(\"+& 4!6\xEE! %"),peg$decode("!7\xB5+_$ \\!7A+-$7\xB5+#%'\"%$\"# X\"# X,8&!7A+-$7\xB5+#%'\"%$\"# X\"# X\"+#%'\"%$\"# X\"# X"),peg$decode("!79+R$!.:\"\"2:3;+-$79+#%'\"%$\"# X\"# X*# \" [+'%4\"6\xEF\" %$\"# X\"# X"),peg$decode("!7:*j \"!7\x97+_$ \\!7A+-$7\x97+#%'\"%$\"# X\"# X,8&!7A+-$7\x97+#%'\"%$\"# X\"# X\"+#%'\"%$\"# X\"# X+& 4!6\xF0! %"),peg$decode("!7L*# \"7\x98+c$ \\!7B+-$7\x9A+#%'\"%$\"# X\"# X,8&!7B+-$7\x9A+#%'\"%$\"# X\"# X\"+'%4\"6\xF1\" %$\"# X\"# X"),peg$decode("!7\x99*# \" [+A$7@+7%7M+-%7?+#%'$%$$# X$## X$\"# X\"# X"),peg$decode("!!76+_$ \\!7.+-$76+#%'\"%$\"# X\"# X,8&!7.+-$76+#%'\"%$\"# X\"# X\"+#%'\"%$\"# X\"# X*# \"7H+' 4!6\xF2!! %"),peg$decode("7\x9B*) \"7\x9C*# \"7\x9F"),peg$decode("!/\xF3\"\"1!3\xF4+<$7<+2%7\x9E+(%4#6\xF5#! %$## X$\"# X\"# X"),peg$decode("!/\xF6\"\"1'3\xF7+<$7<+2%7\x9D+(%4#6\xF8#! %$## X$\"# X\"# X"),peg$decode("! \\7!+&$,#&7!\"\"\" X+' 4!6\xF9!! %"),peg$decode("!.\xFA\"\"2\xFA3\xFB+x$!.J\"\"2J3K+S$7!*# \" [+C%7!*# \" [+3%7!*# \" [+#%'$%$$# X$## X$\"# X\"# X*# \" [+'%4\"6\xFC\" %$\"# X\"# X"),peg$decode("!76+N$!7<+-$7\xA0+#%'\"%$\"# X\"# X*# \" [+)%4\"6\xFD\"\"! %$\"# X\"# X"),peg$decode("76*) \"7T*# \"7H"),peg$decode("!7\xA2+_$ \\!7B+-$7\xA3+#%'\"%$\"# X\"# X,8&!7B+-$7\xA3+#%'\"%$\"# X\"# X\"+#%'\"%$\"# X\"# X"),peg$decode("!/\xFE\"\"1&3\xFF*G \"/\u0100\"\"1'3\u0101*; \"/\u0102\"\"1$3\u0103*/ \"/\u0104\"\"1%3\u0105*# \"76+& 4!6\u0106! %"),peg$decode("7\xA4*# \"7\x9F"),peg$decode("!/\u0107\"\"1(3\u0108+O$7<+E%/\u0109\"\"1(3\u010A*/ \"/\u010B\"\"1(3\u010C*# \"76+#%'#%$## X$\"# X\"# X"),peg$decode("!76+_$ \\!7A+-$76+#%'\"%$\"# X\"# X,8&!7A+-$76+#%'\"%$\"# X\"# X\"+#%'\"%$\"# X\"# X"),peg$decode("! \\7!+&$,#&7!\"\"\" X+' 4!6\u010D!! %"),peg$decode("!7\xA8+& 4!6\u010E! %"),peg$decode("!7\xA9+s$7;+i%7\xAE+_% \\!7B+-$7\xAF+#%'\"%$\"# X\"# X,8&!7B+-$7\xAF+#%'\"%$\"# X\"# X\"+#%'$%$$# X$## X$\"# X\"# X"),peg$decode("7\xAA*# \"7\xAB"),peg$decode("/\u010F\"\"1$3\u0110*S \"/\u0111\"\"1%3\u0112*G \"/\u0113\"\"1%3\u0114*; \"/\u0115\"\"1%3\u0116*/ \"/\u0117\"\"1+3\u0118*# \"7\xAC"),peg$decode("/\u0119\"\"1'3\u011A*/ \"/\u011B\"\"1)3\u011C*# \"7\xAC"),peg$decode("76*# \"7\xAD"),peg$decode("!/\u011D\"\"1\"3\u011E+-$76+#%'\"%$\"# X\"# X"),peg$decode("7\xAC*# \"76"),peg$decode("!76+7$7<+-%7\xB0+#%'#%$## X$\"# X\"# X"),peg$decode("76*# \"7H"),peg$decode("!7\xB2+7$7.+-%7\x8F+#%'#%$## X$\"# X\"# X"),peg$decode("! \\7!+&$,#&7!\"\"\" X+' 4!6\u011F!! %"),peg$decode("!7\x9D+' 4!6\u0120!! %"),peg$decode("!7\xB5+d$ \\!7B+-$7\x9F+#%'\"%$\"# X\"# X,8&!7B+-$7\x9F+#%'\"%$\"# X\"# X\"+(%4\"6\u0121\"!!%$\"# X\"# X"),peg$decode("!!77+k$ \\!.J\"\"2J3K+-$77+#%'\"%$\"# X\"# X,>&!.J\"\"2J3K+-$77+#%'\"%$\"# X\"# X\"+#%'\"%$\"# X\"# X+! (%"),peg$decode("!7L*# \"7\x98+c$ \\!7B+-$7\xB7+#%'\"%$\"# X\"# X,8&!7B+-$7\xB7+#%'\"%$\"# X\"# X\"+'%4\"6\u0122\" %$\"# X\"# X"),peg$decode("7\xB8*# \"7\x9F"),peg$decode("!/\u0123\"\"1#3\u0124+<$7<+2%76+(%4#6\u0125#! %$## X$\"# X\"# X"),peg$decode("! \\7!+&$,#&7!\"\"\" X+' 4!6\u0126!! %"),peg$decode("!7\x9D+' 4!6\u0127!! %"),peg$decode("! \\7\x99,#&7\x99\"+\x81$7@+w%7M+m%7?+c% \\!7B+-$7\x9F+#%'\"%$\"# X\"# X,8&!7B+-$7\x9F+#%'\"%$\"# X\"# X\"+'%4%6\u0128% %$%# X$$# X$## X$\"# X\"# X"),peg$decode("7\xBD"),peg$decode("!/\u0129\"\"1&3\u012A+s$7.+i%7\xC0+_% \\!7A+-$7\xC0+#%'\"%$\"# X\"# X,8&!7A+-$7\xC0+#%'\"%$\"# X\"# X\"+#%'$%$$# X$## X$\"# X\"# X*# \"7\xBE"),peg$decode("!76+s$7.+i%7\xBF+_% \\!7A+-$7\xBF+#%'\"%$\"# X\"# X,8&!7A+-$7\xBF+#%'\"%$\"# X\"# X\"+#%'$%$$# X$## X$\"# X\"# X"),peg$decode("!76+=$7<+3%76*# \"7H+#%'#%$## X$\"# X\"# X"),peg$decode("7\xC1*G \"7\xC3*A \"7\xC5*; \"7\xC7*5 \"7\xC8*/ \"7\xC9*) \"7\xCA*# \"7\xBF"),peg$decode("!/\u012B\"\"1%3\u012C+7$7<+-%7\xC2+#%'#%$## X$\"# X\"# X"),peg$decode("!7I+' 4!6\u012D!! %"),peg$decode("!/\u012E\"\"1&3\u012F+\xA5$7<+\x9B%7D+\x91%7\xC4+\x87% \\! \\7'+&$,#&7'\"\"\" X+-$7\xC4+#%'\"%$\"# X\"# X,G&! \\7'+&$,#&7'\"\"\" X+-$7\xC4+#%'\"%$\"# X\"# X\"+-%7E+#%'&%$&# X$%# X$$# X$## X$\"# X\"# X"),peg$decode("7t*# \"7w"),peg$decode("!/\u0130\"\"1%3\u0131+7$7<+-%7\xC6+#%'#%$## X$\"# X\"# X"),peg$decode("!7I+' 4!6\u0132!! %"),peg$decode("!/\u0133\"\"1&3\u0134+<$7<+2%7I+(%4#6\u0135#! %$## X$\"# X\"# X"),peg$decode("!/\u0136\"\"1%3\u0137+_$7<+U%!/\u0138\"\"1$3\u0139+& 4!6\u013A! %*4 \"!/\u013B\"\"1%3\u013C+& 4!6\u013D! %+#%'#%$## X$\"# X\"# X"),peg$decode("!/\u013E\"\"1)3\u013F+T$7<+J%/\u0140\"\"1#3\u0141*/ \"/\u0142\"\"1(3\u0143*# \"76+(%4#6\u0144#! %$## X$\"# X\"# X"),peg$decode("!/\u0145\"\"1#3\u0146+\x9E$7<+\x94%7D+\x8A%!7\xCB+k$ \\!.D\"\"2D3E+-$7\xCB+#%'\"%$\"# X\"# X,>&!.D\"\"2D3E+-$7\xCB+#%'\"%$\"# X\"# X\"+#%'\"%$\"# X\"# X+-%7E+#%'%%$%# X$$# X$## X$\"# X\"# X"),peg$decode("!/\u0147\"\"1(3\u0148*/ \"/\u0149\"\"1$3\u014A*# \"76+' 4!6\u014B!! %"),peg$decode("!76+_$ \\!7A+-$76+#%'\"%$\"# X\"# X,8&!7A+-$76+#%'\"%$\"# X\"# X\"+#%'\"%$\"# X\"# X"),peg$decode("!7\xCE+K$7.+A%7\xCE+7%7.+-%7\x8F+#%'%%$%# X$$# X$## X$\"# X\"# X"),peg$decode("! \\7!+&$,#&7!\"\"\" X+' 4!6\u014C!! %"),peg$decode("!7\xD0+c$ \\!7A+-$7\xD0+#%'\"%$\"# X\"# X,8&!7A+-$7\xD0+#%'\"%$\"# X\"# X\"+'%4\"6\u014D\" %$\"# X\"# X"),peg$decode("!7\x98+c$ \\!7B+-$7\x9F+#%'\"%$\"# X\"# X,8&!7B+-$7\x9F+#%'\"%$\"# X\"# X\"+'%4\"6\u014E\" %$\"# X\"# X"),peg$decode("!7L*T \"7\x98*N \"!7@*# \" [+=$7t+3%7?*# \" [+#%'#%$## X$\"# X\"# X+c$ \\!7B+-$7\x9F+#%'\"%$\"# X\"# X,8&!7B+-$7\x9F+#%'\"%$\"# X\"# X\"+'%4\"6\u014F\" %$\"# X\"# X"),peg$decode("!7\xD3+c$ \\!7B+-$7\xD4+#%'\"%$\"# X\"# X,8&!7B+-$7\xD4+#%'\"%$\"# X\"# X\"+'%4\"6\u0150\" %$\"# X\"# X"),peg$decode("!7\x95+& 4!6\u0151! %"),peg$decode("!/\u0152\"\"1(3\u0153+<$7<+2%76+(%4#6\u0154#! %$## X$\"# X\"# X*j \"!/\u0155\"\"1&3\u0156+<$7<+2%76+(%4#6\u0157#! %$## X$\"# X\"# X*: \"!/\u0158\"\"1*3\u0159+& 4!6\u015A! %*# \"7\x9F"),peg$decode("!!76+o$ \\!7A+2$76+(%4\"6\u015B\"! %$\"# X\"# X,=&!7A+2$76+(%4\"6\u015B\"! %$\"# X\"# X\"+)%4\"6\u015C\"\"! %$\"# X\"# X*# \" [+' 4!6\u015D!! %"),peg$decode("!7\xD7+_$ \\!7A+-$7\xD7+#%'\"%$\"# X\"# X,8&!7A+-$7\xD7+#%'\"%$\"# X\"# X\"+#%'\"%$\"# X\"# X"),peg$decode("!7\x98+_$ \\!7B+-$7\x9F+#%'\"%$\"# X\"# X,8&!7B+-$7\x9F+#%'\"%$\"# X\"# X\"+#%'\"%$\"# X\"# X"),peg$decode("! \\7!+&$,#&7!\"\"\" X+' 4!6\u015E!! %"),peg$decode("!7\xDA+_$ \\!7B+-$7\xDB+#%'\"%$\"# X\"# X,8&!7B+-$7\xDB+#%'\"%$\"# X\"# X\"+#%'\"%$\"# X\"# X"),peg$decode("!/\u015F\"\"1&3\u0160*; \"/\u0161\"\"1'3\u0162*/ \"/\u0163\"\"1*3\u0164*# \"76+& 4!6\u0165! %"),peg$decode("!/\u0166\"\"1&3\u0167+<$7<+2%7\xDC+(%4#6\u0168#! %$## X$\"# X\"# X*\x83 \"!/\xF6\"\"1'3\xF7+<$7<+2%7\x9D+(%4#6\u0169#! %$## X$\"# X\"# X*S \"!/\u016A\"\"1+3\u016B+<$7<+2%7\x9D+(%4#6\u016C#! %$## X$\"# X\"# X*# \"7\x9F"),peg$decode("/\u016D\"\"1+3\u016E*k \"/\u016F\"\"1)3\u0170*_ \"/\u0171\"\"1(3\u0172*S \"/\u0173\"\"1'3\u0174*G \"/\u0175\"\"1&3\u0176*; \"/\u0177\"\"1*3\u0178*/ \"/\u0179\"\"1)3\u017A*# \"76"),peg$decode("71*# \" ["),peg$decode("!!76+o$ \\!7A+2$76+(%4\"6\u015B\"! %$\"# X\"# X,=&!7A+2$76+(%4\"6\u015B\"! %$\"# X\"# X\"+)%4\"6\u015C\"\"! %$\"# X\"# X*# \" [+' 4!6\u017B!! %"),peg$decode("!7L*# \"7\x98+c$ \\!7B+-$7\xE0+#%'\"%$\"# X\"# X,8&!7B+-$7\xE0+#%'\"%$\"# X\"# X\"+'%4\"6\u017C\" %$\"# X\"# X"),peg$decode("7\xB8*# \"7\x9F"),peg$decode("!7\xE2+_$ \\!7A+-$7\xE2+#%'\"%$\"# X\"# X,8&!7A+-$7\xE2+#%'\"%$\"# X\"# X\"+#%'\"%$\"# X\"# X"),peg$decode("!7\xE9+s$7.+i%7\xEC+_% \\!7B+-$7\xE3+#%'\"%$\"# X\"# X,8&!7B+-$7\xE3+#%'\"%$\"# X\"# X\"+#%'$%$$# X$## X$\"# X\"# X"),peg$decode("7\xE4*; \"7\xE5*5 \"7\xE6*/ \"7\xE7*) \"7\xE8*# \"7\x9F"),peg$decode("!/\u017D\"\"1#3\u017E+<$7<+2%7\xEF+(%4#6\u017F#! %$## X$\"# X\"# X"),peg$decode("!/\u0180\"\"1%3\u0181+<$7<+2%7T+(%4#6\u0182#! %$## X$\"# X\"# X"),peg$decode("!/\u0183\"\"1(3\u0184+B$7<+8%7\\*# \"7Y+(%4#6\u0185#! %$## X$\"# X\"# X"),peg$decode("!/\u0186\"\"1&3\u0187+<$7<+2%76+(%4#6\u0188#! %$## X$\"# X\"# X"),peg$decode("!/\u0189\"\"1%3\u018A+T$!7<+5$ \\7!,#&7!\"+#%'\"%$\"# X\"# X*# \" [+'%4\"6\u018B\" %$\"# X\"# X"),peg$decode("!7\xEA+K$7;+A%76+7%7;+-%7\xEB+#%'%%$%# X$$# X$## X$\"# X\"# X"),peg$decode("!/\x95\"\"1#3\xD6*# \"76+' 4!6\u018C!! %"),peg$decode("!/\xB4\"\"1#3\u018D*G \"/\xB6\"\"1#3\u018E*; \"/\xBA\"\"1#3\u018F*/ \"/\xB8\"\"1$3\u0190*# \"76+' 4!6\u0191!! %"),peg$decode("!7\xED+H$!7C+-$7\xEE+#%'\"%$\"# X\"# X*# \" [+#%'\"%$\"# X\"# X"),peg$decode("!7U*) \"7\\*# \"7X+& 4!6\u0192! %"),peg$decode("!!7!*# \" [+c$7!*# \" [+S%7!*# \" [+C%7!*# \" [+3%7!*# \" [+#%'%%$%# X$$# X$## X$\"# X\"# X+' 4!6\u0193!! %"),peg$decode("!!7!+C$7!*# \" [+3%7!*# \" [+#%'#%$## X$\"# X\"# X+' 4!6\u0194!! %"),peg$decode("7\xBD"),peg$decode("!7\x9D+d$ \\!7B+-$7\xF2+#%'\"%$\"# X\"# X,8&!7B+-$7\xF2+#%'\"%$\"# X\"# X\"+(%4\"6\u0195\"!!%$\"# X\"# X"),peg$decode("7\xF3*# \"7\x9F"),peg$decode("!.\u0196\"\"2\u01963\u0197+N$7<+D%.\u0198\"\"2\u01983\u0199*) \".\u019A\"\"2\u019A3\u019B+(%4#6\u019C#! %$## X$\"# X\"# X"),peg$decode("!7\x9D+d$ \\!7B+-$7\x9F+#%'\"%$\"# X\"# X,8&!7B+-$7\x9F+#%'\"%$\"# X\"# X\"+(%4\"6\u019D\"!!%$\"# X\"# X"),peg$decode("!76+7$70+-%7\xF6+#%'#%$## X$\"# X\"# X"),peg$decode(" \\72*) \"74*# \"7.,/&72*) \"74*# \"7.\""),peg$decode(" \\7%,#&7%\""),peg$decode("!7\xF9+=$.8\"\"2839+-%7\xFA+#%'#%$## X$\"# X\"# X"),peg$decode("!/\u019E\"\"1%3\u019F*) \"/\u01A0\"\"1$3\u01A1+' 4!6\u01A2!! %"),peg$decode("!7\xFB+N$!.8\"\"2839+-$7^+#%'\"%$\"# X\"# X*# \" [+#%'\"%$\"# X\"# X"),peg$decode("!7\\*) \"7X*# \"7\x82+' 4!6\u01A3!! %"),peg$decode("! \\7\xFD*) \"7-*# \"7\xFE,/&7\xFD*) \"7-*# \"7\xFE\"+! (%"),peg$decode("7\"*S \"7!*M \".F\"\"2F3G*A \".J\"\"2J3K*5 \".H\"\"2H3I*) \".N\"\"2N3O"),peg$decode(".L\"\"2L3M*\x95 \".B\"\"2B3C*\x89 \".<\"\"2<3=*} \".R\"\"2R3S*q \".T\"\"2T3U*e \".V\"\"2V3W*Y \".P\"\"2P3Q*M \".@\"\"2@3A*A \".D\"\"2D3E*5 \".2\"\"2233*) \".>\"\"2>3?"),peg$decode("!7\u0100+h$.8\"\"2839+X%7\xFA+N%!.\u01A4\"\"2\u01A43\u01A5+-$7\xEB+#%'\"%$\"# X\"# X*# \" [+#%'$%$$# X$## X$\"# X\"# X"),peg$decode("!/\u01A6\"\"1%3\u01A7*) \"/\u01A8\"\"1$3\u01A9+' 4!6\u01A2!! %"),peg$decode("!7\xEB+Q$/\xB4\"\"1#3\xB5*7 \"/\xB6\"\"1#3\xB7*+ \" \\7+,#&7+\"+'%4\"6\u01AA\" %$\"# X\"# X"),peg$decode("!7\u0104+\x8F$.F\"\"2F3G+\x7F%7\u0103+u%.F\"\"2F3G+e%7\u0103+[%.F\"\"2F3G+K%7\u0103+A%.F\"\"2F3G+1%7\u0105+'%4)6\u01AB) %$)# X$(# X$'# X$&# X$%# X$$# X$## X$\"# X\"# X"),peg$decode("!7#+A$7#+7%7#+-%7#+#%'$%$$# X$## X$\"# X\"# X"),peg$decode("!7\u0103+-$7\u0103+#%'\"%$\"# X\"# X"),peg$decode("!7\u0103+7$7\u0103+-%7\u0103+#%'#%$## X$\"# X\"# X")],peg$currPos=0,peg$reportedPos=0,peg$cachedPos=0,peg$cachedPosDetails={line:1,column:1,seenCR:false},peg$maxFailPos=0,peg$maxFailExpected=[],peg$silentFails=0,peg$result;if("startRule"in options){if(!(options.startRule in peg$startRuleIndices)){throw new Error("Can't start parsing from rule \""+options.startRule+"\".");}peg$startRuleIndex=peg$startRuleIndices[options.startRule];}function text(){return input.substring(peg$reportedPos,peg$currPos);}function offset(){return peg$reportedPos;}function line(){return peg$computePosDetails(peg$reportedPos).line;}function column(){return peg$computePosDetails(peg$reportedPos).column;}function expected(description){throw peg$buildException(null,[{type:"other",description:description}],peg$reportedPos);}function error(message){throw peg$buildException(message,null,peg$reportedPos);}function peg$computePosDetails(pos){function advance(details,startPos,endPos){var p,ch;for(p=startPos;p<endPos;p++){ch=input.charAt(p);if(ch==="\n"){if(!details.seenCR){details.line++;}details.column=1;details.seenCR=false;}else if(ch==="\r"||ch==="\u2028"||ch==="\u2029"){details.line++;details.column=1;details.seenCR=true;}else{details.column++;details.seenCR=false;}}}if(peg$cachedPos!==pos){if(peg$cachedPos>pos){peg$cachedPos=0;peg$cachedPosDetails={line:1,column:1,seenCR:false};}advance(peg$cachedPosDetails,peg$cachedPos,pos);peg$cachedPos=pos;}return peg$cachedPosDetails;}function peg$fail(expected){if(peg$currPos<peg$maxFailPos){return;}if(peg$currPos>peg$maxFailPos){peg$maxFailPos=peg$currPos;peg$maxFailExpected=[];}peg$maxFailExpected.push(expected);}function peg$buildException(message,expected,pos){function cleanupExpected(expected){var i=1;expected.sort(function(a,b){if(a.description<b.description){return-1;}else if(a.description>b.description){return 1;}else{return 0;}});while(i<expected.length){if(expected[i-1]===expected[i]){expected.splice(i,1);}else{i++;}}}function buildMessage(expected,found){function stringEscape(s){function hex(ch){return ch.charCodeAt(0).toString(16).toUpperCase();}return s.replace(/\\/g,'\\\\').replace(/"/g,'\\"').replace(/\x08/g,'\\b').replace(/\t/g,'\\t').replace(/\n/g,'\\n').replace(/\f/g,'\\f').replace(/\r/g,'\\r').replace(/[\x00-\x07\x0B\x0E\x0F]/g,function(ch){return'\\x0'+hex(ch);}).replace(/[\x10-\x1F\x80-\xFF]/g,function(ch){return'\\x'+hex(ch);}).replace(/[\u0180-\u0FFF]/g,function(ch){return"\\u0"+hex(ch);}).replace(/[\u1080-\uFFFF]/g,function(ch){return"\\u"+hex(ch);});}var expectedDescs=new Array(expected.length),expectedDesc,foundDesc,i;for(i=0;i<expected.length;i++){expectedDescs[i]=expected[i].description;}expectedDesc=expected.length>1?expectedDescs.slice(0,-1).join(", ")+" or "+expectedDescs[expected.length-1]:expectedDescs[0];foundDesc=found?"\""+stringEscape(found)+"\"":"end of input";return"Expected "+expectedDesc+" but "+foundDesc+" found.";}var posDetails=peg$computePosDetails(pos),found=pos<input.length?input.charAt(pos):null;if(expected!==null){cleanupExpected(expected);}return new SyntaxError(message!==null?message:buildMessage(expected,found),expected,found,pos,posDetails.line,posDetails.column);}function peg$decode(s){var bc=new Array(s.length),i;for(i=0;i<s.length;i++){bc[i]=s.charCodeAt(i)-32;}return bc;}function peg$parseRule(index){var bc=peg$bytecode[index],ip=0,ips=[],end=bc.length,ends=[],stack=[],params,i;function protect(object){return Object.prototype.toString.apply(object)==="[object Array]"?[]:object;}while(true){while(ip<end){switch(bc[ip]){case 0:stack.push(protect(peg$consts[bc[ip+1]]));ip+=2;break;case 1:stack.push(peg$currPos);ip++;break;case 2:stack.pop();ip++;break;case 3:peg$currPos=stack.pop();ip++;break;case 4:stack.length-=bc[ip+1];ip+=2;break;case 5:stack.splice(-2,1);ip++;break;case 6:stack[stack.length-2].push(stack.pop());ip++;break;case 7:stack.push(stack.splice(stack.length-bc[ip+1],bc[ip+1]));ip+=2;break;case 8:stack.pop();stack.push(input.substring(stack[stack.length-1],peg$currPos));ip++;break;case 9:ends.push(end);ips.push(ip+3+bc[ip+1]+bc[ip+2]);if(stack[stack.length-1]){end=ip+3+bc[ip+1];ip+=3;}else{end=ip+3+bc[ip+1]+bc[ip+2];ip+=3+bc[ip+1];}break;case 10:ends.push(end);ips.push(ip+3+bc[ip+1]+bc[ip+2]);if(stack[stack.length-1]===peg$FAILED){end=ip+3+bc[ip+1];ip+=3;}else{end=ip+3+bc[ip+1]+bc[ip+2];ip+=3+bc[ip+1];}break;case 11:ends.push(end);ips.push(ip+3+bc[ip+1]+bc[ip+2]);if(stack[stack.length-1]!==peg$FAILED){end=ip+3+bc[ip+1];ip+=3;}else{end=ip+3+bc[ip+1]+bc[ip+2];ip+=3+bc[ip+1];}break;case 12:if(stack[stack.length-1]!==peg$FAILED){ends.push(end);ips.push(ip);end=ip+2+bc[ip+1];ip+=2;}else{ip+=2+bc[ip+1];}break;case 13:ends.push(end);ips.push(ip+3+bc[ip+1]+bc[ip+2]);if(input.length>peg$currPos){end=ip+3+bc[ip+1];ip+=3;}else{end=ip+3+bc[ip+1]+bc[ip+2];ip+=3+bc[ip+1];}break;case 14:ends.push(end);ips.push(ip+4+bc[ip+2]+bc[ip+3]);if(input.substr(peg$currPos,peg$consts[bc[ip+1]].length)===peg$consts[bc[ip+1]]){end=ip+4+bc[ip+2];ip+=4;}else{end=ip+4+bc[ip+2]+bc[ip+3];ip+=4+bc[ip+2];}break;case 15:ends.push(end);ips.push(ip+4+bc[ip+2]+bc[ip+3]);if(input.substr(peg$currPos,peg$consts[bc[ip+1]].length).toLowerCase()===peg$consts[bc[ip+1]]){end=ip+4+bc[ip+2];ip+=4;}else{end=ip+4+bc[ip+2]+bc[ip+3];ip+=4+bc[ip+2];}break;case 16:ends.push(end);ips.push(ip+4+bc[ip+2]+bc[ip+3]);if(peg$consts[bc[ip+1]].test(input.charAt(peg$currPos))){end=ip+4+bc[ip+2];ip+=4;}else{end=ip+4+bc[ip+2]+bc[ip+3];ip+=4+bc[ip+2];}break;case 17:stack.push(input.substr(peg$currPos,bc[ip+1]));peg$currPos+=bc[ip+1];ip+=2;break;case 18:stack.push(peg$consts[bc[ip+1]]);peg$currPos+=peg$consts[bc[ip+1]].length;ip+=2;break;case 19:stack.push(peg$FAILED);if(peg$silentFails===0){peg$fail(peg$consts[bc[ip+1]]);}ip+=2;break;case 20:peg$reportedPos=stack[stack.length-1-bc[ip+1]];ip+=2;break;case 21:peg$reportedPos=peg$currPos;ip++;break;case 22:params=bc.slice(ip+4,ip+4+bc[ip+3]);for(i=0;i<bc[ip+3];i++){params[i]=stack[stack.length-1-params[i]];}stack.splice(stack.length-bc[ip+2],bc[ip+2],peg$consts[bc[ip+1]].apply(null,params));ip+=4+bc[ip+3];break;case 23:stack.push(peg$parseRule(bc[ip+1]));ip+=2;break;case 24:peg$silentFails++;ip++;break;case 25:peg$silentFails--;ip++;break;default:throw new Error("Invalid opcode: "+bc[ip]+".");}}if(ends.length>0){end=ends.pop();ip=ips.pop();}else{break;}}return stack[0];}options.data={};// Object to which header attributes will be assigned during parsing
function list(first,rest){return[first].concat(rest);}peg$result=peg$parseRule(peg$startRuleIndex);if(peg$result!==peg$FAILED&&peg$currPos===input.length){return peg$result;}else{if(peg$result!==peg$FAILED&&peg$currPos<input.length){peg$fail({type:"end",description:"end of input"});}throw peg$buildException(null,peg$maxFailExpected,peg$maxFailPos);}}return{SyntaxError:SyntaxError,parse:parse};}();},{}],83:[function(require,module,exports){"use strict";/**
 * @fileoverview Hacks - This file contains all of the things we
 * wish we didn't have to do, just for interop.  It is similar to
 * Utils, which provides actually useful and relevant functions for
 * a SIP library. Methods in this file are grouped by vendor, so
 * as to most easily track when particular hacks may not be necessary anymore.
 */module.exports=function(SIP){//keep to quiet jshint, and remain consistent with other files
SIP=SIP;var Hacks={AllBrowsers:{maskDtls:function maskDtls(sdp){if(sdp){sdp=sdp.replace(/ UDP\/TLS\/RTP\/SAVP/gmi," RTP/SAVP");}return sdp;},unmaskDtls:function unmaskDtls(sdp){/**
       * Chrome does not handle DTLS correctly (Canaray does, but not production)
       * keeping Chrome as SDES until DTLS is fixed (comment out 'is_opera' condition)
       *
       * UPDATE: May 21, 2014
       * Chrome 35 now properly defaults to DTLS.  Only Opera remains using SDES
       *
       * UPDATE: 2014-09-24
       * Opera now supports DTLS by default as well.
       *
       **/return sdp.replace(/ RTP\/SAVP/gmi," UDP/TLS/RTP/SAVP");}},Firefox:{/* Condition to detect if hacks are applicable */isFirefox:function isFirefox(){return typeof mozRTCPeerConnection!=='undefined';},cannotHandleExtraWhitespace:function cannotHandleExtraWhitespace(sdp){if(this.isFirefox()&&sdp){sdp=sdp.replace(/ \r\n/g,"\r\n");}return sdp;},hasMissingCLineInSDP:function hasMissingCLineInSDP(sdp){/*
       * This is a Firefox hack to insert valid sdp when getDescription is
       * called with the constraint offerToReceiveVideo = false.
       * We search for either a c-line at the top of the sdp above all
       * m-lines. If that does not exist then we search for a c-line
       * beneath each m-line. If it is missing a c-line, we insert
       * a fake c-line with the ip address 0.0.0.0. This is then valid
       * sdp and no media will be sent for that m-line.
       *
       * Valid SDP is:
       * m=
       * i=
       * c=
       */var insertAt,mlines;if(sdp.indexOf('c=')>sdp.indexOf('m=')){// Find all m= lines
mlines=sdp.match(/m=.*\r\n.*/g);for(var i=0;i<mlines.length;i++){// If it has an i= line, check if the next line is the c= line
if(mlines[i].toString().search(/i=.*/)>=0){insertAt=sdp.indexOf(mlines[i].toString())+mlines[i].toString().length;if(sdp.substr(insertAt,2)!=='c='){sdp=sdp.substr(0,insertAt)+'\r\nc=IN IP4 0.0.0.0'+sdp.substr(insertAt);}// else add the C line if it's missing
}else if(mlines[i].toString().search(/c=.*/)<0){insertAt=sdp.indexOf(mlines[i].toString().match(/.*/))+mlines[i].toString().match(/.*/).toString().length;sdp=sdp.substr(0,insertAt)+'\r\nc=IN IP4 0.0.0.0'+sdp.substr(insertAt);}}}return sdp;}},Chrome:{needsExplicitlyInactiveSDP:function needsExplicitlyInactiveSDP(sdp){var sub,index;if(Hacks.Firefox.isFirefox()){// Fix this in Firefox before sending
index=sdp.indexOf('m=video 0');if(index!==-1){sub=sdp.substr(index);sub=sub.replace(/\r\nc=IN IP4.*\r\n$/,'\r\nc=IN IP4 0.0.0.0\r\na=inactive\r\n');return sdp.substr(0,index)+sub;}}return sdp;},getsConfusedAboutGUM:function getsConfusedAboutGUM(session){if(session.mediaHandler){session.mediaHandler.close();}}}};return Hacks;};},{}],84:[function(require,module,exports){"use strict";var levels={'error':0,'warn':1,'log':2,'debug':3};module.exports=function(console){var LoggerFactory=function LoggerFactory(){var logger,level=2,builtinEnabled=true,connector=null;this.loggers={};logger=this.getLogger('sip.loggerfactory');Object.defineProperties(this,{builtinEnabled:{get:function get(){return builtinEnabled;},set:function set(value){if(typeof value==='boolean'){builtinEnabled=value;}else{logger.error('invalid "builtinEnabled" parameter value: '+JSON.stringify(value));}}},level:{get:function get(){return level;},set:function set(value){if(value>=0&&value<=3){level=value;}else if(value>3){level=3;}else if(levels.hasOwnProperty(value)){level=levels[value];}else{logger.error('invalid "level" parameter value: '+JSON.stringify(value));}}},connector:{get:function get(){return connector;},set:function set(value){if(value===null||value===""||value===undefined){connector=null;}else if(typeof value==='function'){connector=value;}else{logger.error('invalid "connector" parameter value: '+JSON.stringify(value));}}}});};LoggerFactory.prototype.print=function(target,category,label,content){if(typeof content==='string'){var prefix=[new Date(),category];if(label){prefix.push(label);}content=prefix.concat(content).join(' | ');}target.call(console,content);};function Logger(logger,category,label){this.logger=logger;this.category=category;this.label=label;}Object.keys(levels).forEach(function(targetName){Logger.prototype[targetName]=function(content){this.logger[targetName](this.category,this.label,content);};LoggerFactory.prototype[targetName]=function(category,label,content){if(this.level>=levels[targetName]){if(this.builtinEnabled){this.print(console[targetName],category,label,content);}if(this.connector){this.connector(targetName,category,label,content);}}};});LoggerFactory.prototype.getLogger=function(category,label){var logger;if(label&&this.level===3){return new Logger(this,category,label);}else if(this.loggers[category]){return this.loggers[category];}else{logger=new Logger(this,category);this.loggers[category]=logger;return logger;}};return LoggerFactory;};},{}],85:[function(require,module,exports){"use strict";/**
 * @fileoverview MediaHandler
 *//* MediaHandler
 * @class PeerConnection helper Class.
 * @param {SIP.Session} session
 * @param {Object} [options]
 */module.exports=function(EventEmitter){var MediaHandler=function MediaHandler(session,options){// keep jshint happy
session=session;options=options;};MediaHandler.prototype=Object.create(EventEmitter.prototype,{isReady:{value:function isReady(){}},close:{value:function close(){}},/**
   * @param {Object} [mediaHint] A custom object describing the media to be used during this session.
   */getDescription:{value:function getDescription(mediaHint){// keep jshint happy
mediaHint=mediaHint;}},/**
   * Check if a SIP message contains a session description.
   * @param {SIP.SIPMessage} message
   * @returns {boolean}
   */hasDescription:{value:function hasDescription(message){// keep jshint happy
message=message;}},/**
   * Set the session description contained in a SIP message.
   * @param {SIP.SIPMessage} message
   * @returns {Promise}
   */setDescription:{value:function setDescription(message){// keep jshint happy
message=message;}}});return MediaHandler;};},{}],86:[function(require,module,exports){"use strict";/**
 * @fileoverview SIP NameAddrHeader
 *//**
 * @augments SIP
 * @class Class creating a Name Address SIP header.
 *
 * @param {SIP.URI} uri
 * @param {String} [displayName]
 * @param {Object} [parameters]
 *
 */module.exports=function(SIP){var NameAddrHeader;NameAddrHeader=function NameAddrHeader(uri,displayName,parameters){var param;// Checks
if(!uri||!(uri instanceof SIP.URI)){throw new TypeError('missing or invalid "uri" parameter');}// Initialize parameters
this.uri=uri;this.parameters={};for(param in parameters){this.setParam(param,parameters[param]);}Object.defineProperties(this,{friendlyName:{get:function get(){return this.displayName||uri.aor;}},displayName:{get:function get(){return displayName;},set:function set(value){displayName=value===0?'0':value;}}});};NameAddrHeader.prototype={setParam:function setParam(key,value){if(key){this.parameters[key.toLowerCase()]=typeof value==='undefined'||value===null?null:value.toString();}},getParam:SIP.URI.prototype.getParam,hasParam:SIP.URI.prototype.hasParam,deleteParam:SIP.URI.prototype.deleteParam,clearParams:SIP.URI.prototype.clearParams,clone:function clone(){return new NameAddrHeader(this.uri.clone(),this.displayName,JSON.parse(JSON.stringify(this.parameters)));},toString:function toString(){var body,parameter;body=this.displayName||this.displayName===0?'"'+this.displayName+'" ':'';body+='<'+this.uri.toString()+'>';for(parameter in this.parameters){body+=';'+parameter;if(this.parameters[parameter]!==null){body+='='+this.parameters[parameter];}}return body;}};/**
  * Parse the given string and returns a SIP.NameAddrHeader instance or undefined if
  * it is an invalid NameAddrHeader.
  * @public
  * @param {String} name_addr_header
  */NameAddrHeader.parse=function(name_addr_header){name_addr_header=SIP.Grammar.parse(name_addr_header,'Name_Addr_Header');if(name_addr_header!==-1){return name_addr_header;}else{return undefined;}};SIP.NameAddrHeader=NameAddrHeader;};},{}],87:[function(require,module,exports){"use strict";/**
 * @fileoverview SIP Message Parser
 *//**
 * Extract and parse every header of a SIP message.
 * @augments SIP
 * @namespace
 */module.exports=function(SIP){var Parser;function getHeader(data,headerStart){var// 'start' position of the header.
start=headerStart,// 'end' position of the header.
end=0,// 'partial end' position of the header.
partialEnd=0;//End of message.
if(data.substring(start,start+2).match(/(^\r\n)/)){return-2;}while(end===0){// Partial End of Header.
partialEnd=data.indexOf('\r\n',start);// 'indexOf' returns -1 if the value to be found never occurs.
if(partialEnd===-1){return partialEnd;}if(!data.substring(partialEnd+2,partialEnd+4).match(/(^\r\n)/)&&data.charAt(partialEnd+2).match(/(^\s+)/)){// Not the end of the message. Continue from the next position.
start=partialEnd+2;}else{end=partialEnd;}}return end;}function parseHeader(message,data,headerStart,headerEnd){var header,idx,length,parsed,hcolonIndex=data.indexOf(':',headerStart),headerName=data.substring(headerStart,hcolonIndex).trim(),headerValue=data.substring(hcolonIndex+1,headerEnd).trim();// If header-field is well-known, parse it.
switch(headerName.toLowerCase()){case'via':case'v':message.addHeader('via',headerValue);if(message.getHeaders('via').length===1){parsed=message.parseHeader('Via');if(parsed){message.via=parsed;message.via_branch=parsed.branch;}}else{parsed=0;}break;case'from':case'f':message.setHeader('from',headerValue);parsed=message.parseHeader('from');if(parsed){message.from=parsed;message.from_tag=parsed.getParam('tag');}break;case'to':case't':message.setHeader('to',headerValue);parsed=message.parseHeader('to');if(parsed){message.to=parsed;message.to_tag=parsed.getParam('tag');}break;case'record-route':parsed=SIP.Grammar.parse(headerValue,'Record_Route');if(parsed===-1){parsed=undefined;break;}length=parsed.length;for(idx=0;idx<length;idx++){header=parsed[idx];message.addHeader('record-route',headerValue.substring(header.position,header.offset));message.headers['Record-Route'][message.getHeaders('record-route').length-1].parsed=header.parsed;}break;case'call-id':case'i':message.setHeader('call-id',headerValue);parsed=message.parseHeader('call-id');if(parsed){message.call_id=headerValue;}break;case'contact':case'm':parsed=SIP.Grammar.parse(headerValue,'Contact');if(parsed===-1){parsed=undefined;break;}length=parsed.length;for(idx=0;idx<length;idx++){header=parsed[idx];message.addHeader('contact',headerValue.substring(header.position,header.offset));message.headers['Contact'][message.getHeaders('contact').length-1].parsed=header.parsed;}break;case'content-length':case'l':message.setHeader('content-length',headerValue);parsed=message.parseHeader('content-length');break;case'content-type':case'c':message.setHeader('content-type',headerValue);parsed=message.parseHeader('content-type');break;case'cseq':message.setHeader('cseq',headerValue);parsed=message.parseHeader('cseq');if(parsed){message.cseq=parsed.value;}if(message instanceof SIP.IncomingResponse){message.method=parsed.method;}break;case'max-forwards':message.setHeader('max-forwards',headerValue);parsed=message.parseHeader('max-forwards');break;case'www-authenticate':message.setHeader('www-authenticate',headerValue);parsed=message.parseHeader('www-authenticate');break;case'proxy-authenticate':message.setHeader('proxy-authenticate',headerValue);parsed=message.parseHeader('proxy-authenticate');break;case'refer-to':case'r':message.setHeader('refer-to',headerValue);parsed=message.parseHeader('refer-to');if(parsed){message.refer_to=parsed;}break;default:// Do not parse this header.
message.setHeader(headerName,headerValue);parsed=0;}if(parsed===undefined){return{error:'error parsing header "'+headerName+'"'};}else{return true;}}/** Parse SIP Message
 * @function
 * @param {String} message SIP message.
 * @param {Object} logger object.
 * @returns {SIP.IncomingRequest|SIP.IncomingResponse|undefined}
 */Parser={};Parser.parseMessage=function(data,ua){var message,firstLine,contentLength,bodyStart,parsed,headerStart=0,headerEnd=data.indexOf('\r\n'),logger=ua.getLogger('sip.parser');if(headerEnd===-1){logger.warn('no CRLF found, not a SIP message, discarded');return;}// Parse first line. Check if it is a Request or a Reply.
firstLine=data.substring(0,headerEnd);parsed=SIP.Grammar.parse(firstLine,'Request_Response');if(parsed===-1){logger.warn('error parsing first line of SIP message: "'+firstLine+'"');return;}else if(!parsed.status_code){message=new SIP.IncomingRequest(ua);message.method=parsed.method;message.ruri=parsed.uri;}else{message=new SIP.IncomingResponse(ua);message.status_code=parsed.status_code;message.reason_phrase=parsed.reason_phrase;}message.data=data;headerStart=headerEnd+2;/* Loop over every line in data. Detect the end of each header and parse
  * it or simply add to the headers collection.
  */while(true){headerEnd=getHeader(data,headerStart);// The SIP message has normally finished.
if(headerEnd===-2){bodyStart=headerStart+2;break;}// data.indexOf returned -1 due to a malformed message.
else if(headerEnd===-1){logger.error('malformed message');return;}parsed=parseHeader(message,data,headerStart,headerEnd);if(parsed!==true){logger.error(parsed.error);return;}headerStart=headerEnd+2;}/* RFC3261 18.3.
   * If there are additional bytes in the transport packet
   * beyond the end of the body, they MUST be discarded.
   */if(message.hasHeader('content-length')){contentLength=message.getHeader('content-length');message.body=data.substr(bodyStart,contentLength);}else{message.body=data.substring(bodyStart);}return message;};SIP.Parser=Parser;};},{}],88:[function(require,module,exports){var localMinSE=90;module.exports=function(Timers){// http://tools.ietf.org/html/rfc4028#section-9
function hasSmallMinSE(message){var supportedOptions=message.parseHeader('Supported')||[];var sessionExpires=message.parseHeader('Session-Expires')||{};return supportedOptions.indexOf('timer')>=0&&sessionExpires.deltaSeconds<localMinSE;}// `response` is an IncomingResponse or a String (outgoing response)
function updateState(dialog,response,parseMessage,ua){dialog.sessionTimerState=dialog.sessionTimerState||{};Timers.clearTimeout(dialog.sessionTimerState.timeout);var isUAS=typeof response==='string';if(isUAS){response=parseMessage(response,ua);}var sessionExpires=response.parseHeader('Session-Expires');// If the most recent 2xx response had no Session-Expires header field, there
// is no session expiration, and no refreshes have to be performed
if(!sessionExpires){dialog.sessionTimerState=null;return;}var interval=sessionExpires.deltaSeconds;var isRefresher=isUAS===(sessionExpires.refresher==='uas');dialog.sessionTimerState={interval:interval,isRefresher:isRefresher};var intervalMilliseconds=interval*1000;var self=this;if(isRefresher){dialog.sessionTimerState.timeout=Timers.setInterval(function sendRefresh(){var exists=dialog.owner.ua.dialogs[dialog.id.toString()]||false;if(exists){dialog.sendRequest(self,"UPDATE",{extraHeaders:["Session-Expires: "+interval]});}else{Timers.clearInterval(dialog.sessionTimerState.timeout);}},intervalMilliseconds/2);}else{var before=Math.min(32*1000,intervalMilliseconds/3);dialog.sessionTimerState.timeout=Timers.setTimeout(function sendBye(){// TODO
},intervalMilliseconds-before);}}function receiveResponse(response){/* jshint unused: false */}function onDialogError(response){/* jshint unused: false */}function onRequestTimeout(){/* jshint unused: false */}function onTransportError(){/* jshint unused: false */}return{localMinSE:localMinSE,hasSmallMinSE:hasSmallMinSE,updateState:updateState,receiveResponse:receiveResponse,onDialogError:onDialogError,onRequestTimeout:onRequestTimeout,onTransportError:onTransportError};};},{}],89:[function(require,module,exports){"use strict";module.exports=function(SIP){var RegisterContext;RegisterContext=function RegisterContext(ua){var params={},regId=1;this.registrar=ua.configuration.registrarServer;this.expires=ua.configuration.registerExpires;// Contact header
this.contact=ua.contact.toString();if(regId){this.contact+=';reg-id='+regId;this.contact+=';+sip.instance="<urn:uuid:'+ua.configuration.instanceId+'>"';}// Call-ID and CSeq values RFC3261 10.2
this.call_id=SIP.Utils.createRandomToken(22);this.cseq=80;this.to_uri=ua.configuration.uri;params.to_uri=this.to_uri;params.to_displayName=ua.configuration.displayName;params.call_id=this.call_id;params.cseq=this.cseq;// Extends ClientContext
SIP.Utils.augment(this,SIP.ClientContext,[ua,'REGISTER',this.registrar,{params:params}]);this.registrationTimer=null;this.registrationExpiredTimer=null;// Set status
this.registered=false;this.logger=ua.getLogger('sip.registercontext');};RegisterContext.prototype={register:function register(options){var self=this,extraHeaders;// Handle Options
this.options=options||{};extraHeaders=(this.options.extraHeaders||[]).slice();extraHeaders.push('Contact: '+this.contact+';expires='+this.expires);extraHeaders.push('Allow: '+SIP.UA.C.ALLOWED_METHODS.toString());// Save original extraHeaders to be used in .close
this.closeHeaders=this.options.closeWithHeaders?(this.options.extraHeaders||[]).slice():[];this.receiveResponse=function(response){var contact,expires,contacts=response.getHeaders('contact').length,cause;// Discard responses to older REGISTER/un-REGISTER requests.
if(response.cseq!==this.cseq){return;}// Clear registration timer
if(this.registrationTimer!==null){SIP.Timers.clearTimeout(this.registrationTimer);this.registrationTimer=null;}switch(true){case /^1[0-9]{2}$/.test(response.status_code):this.emit('progress',response);break;case /^2[0-9]{2}$/.test(response.status_code):this.emit('accepted',response);if(response.hasHeader('expires')){expires=response.getHeader('expires');}if(this.registrationExpiredTimer!==null){SIP.Timers.clearTimeout(this.registrationExpiredTimer);this.registrationExpiredTimer=null;}// Search the Contact pointing to us and update the expires value accordingly.
if(!contacts){this.logger.warn('no Contact header in response to REGISTER, response ignored');break;}while(contacts--){contact=response.parseHeader('contact',contacts);if(contact.uri.user===this.ua.contact.uri.user){expires=contact.getParam('expires');break;}else{contact=null;}}if(!contact){this.logger.warn('no Contact header pointing to us, response ignored');break;}if(!expires){expires=this.expires;}// Re-Register before the expiration interval has elapsed.
// For that, decrease the expires value. ie: 3 seconds
this.registrationTimer=SIP.Timers.setTimeout(function(){self.registrationTimer=null;self.register(self.options);},expires*1000-3000);this.registrationExpiredTimer=SIP.Timers.setTimeout(function(){self.logger.warn('registration expired');if(self.registered){self.unregistered(null,SIP.C.causes.EXPIRES);}},expires*1000);//Save gruu values
if(contact.hasParam('temp-gruu')){this.ua.contact.temp_gruu=SIP.URI.parse(contact.getParam('temp-gruu').replace(/"/g,''));}if(contact.hasParam('pub-gruu')){this.ua.contact.pub_gruu=SIP.URI.parse(contact.getParam('pub-gruu').replace(/"/g,''));}this.registered=true;this.emit('registered',response||null);break;// Interval too brief RFC3261 10.2.8
case /^423$/.test(response.status_code):if(response.hasHeader('min-expires')){// Increase our registration interval to the suggested minimum
this.expires=response.getHeader('min-expires');// Attempt the registration again immediately
this.register(this.options);}else{//This response MUST contain a Min-Expires header field
this.logger.warn('423 response received for REGISTER without Min-Expires');this.registrationFailure(response,SIP.C.causes.SIP_FAILURE_CODE);}break;default:cause=SIP.Utils.sipErrorCause(response.status_code);this.registrationFailure(response,cause);}};this.onRequestTimeout=function(){this.registrationFailure(null,SIP.C.causes.REQUEST_TIMEOUT);};this.onTransportError=function(){this.registrationFailure(null,SIP.C.causes.CONNECTION_ERROR);};this.cseq++;this.request.cseq=this.cseq;this.request.setHeader('cseq',this.cseq+' REGISTER');this.request.extraHeaders=extraHeaders;this.send();},registrationFailure:function registrationFailure(response,cause){this.emit('failed',response||null,cause||null);},onTransportClosed:function onTransportClosed(){this.registered_before=this.registered;if(this.registrationTimer!==null){SIP.Timers.clearTimeout(this.registrationTimer);this.registrationTimer=null;}if(this.registrationExpiredTimer!==null){SIP.Timers.clearTimeout(this.registrationExpiredTimer);this.registrationExpiredTimer=null;}if(this.registered){this.unregistered(null,SIP.C.causes.CONNECTION_ERROR);}},onTransportConnected:function onTransportConnected(){this.register(this.options);},close:function close(){var options={all:false,extraHeaders:this.closeHeaders};this.registered_before=this.registered;this.unregister(options);},unregister:function unregister(options){var extraHeaders;options=options||{};if(!this.registered&&!options.all){this.logger.warn('already unregistered');return;}extraHeaders=(options.extraHeaders||[]).slice();this.registered=false;// Clear the registration timer.
if(this.registrationTimer!==null){SIP.Timers.clearTimeout(this.registrationTimer);this.registrationTimer=null;}if(options.all){extraHeaders.push('Contact: *');extraHeaders.push('Expires: 0');}else{extraHeaders.push('Contact: '+this.contact+';expires=0');}this.receiveResponse=function(response){var cause;switch(true){case /^1[0-9]{2}$/.test(response.status_code):this.emit('progress',response);break;case /^2[0-9]{2}$/.test(response.status_code):this.emit('accepted',response);if(this.registrationExpiredTimer!==null){SIP.Timers.clearTimeout(this.registrationExpiredTimer);this.registrationExpiredTimer=null;}this.unregistered(response);break;default:cause=SIP.Utils.sipErrorCause(response.status_code);this.unregistered(response,cause);}};this.onRequestTimeout=function(){// Not actually unregistered...
//this.unregistered(null, SIP.C.causes.REQUEST_TIMEOUT);
};this.onTransportError=function(){// Not actually unregistered...
//this.unregistered(null, SIP.C.causes.CONNECTION_ERROR);
};this.cseq++;this.request.cseq=this.cseq;this.request.setHeader('cseq',this.cseq+' REGISTER');this.request.extraHeaders=extraHeaders;this.send();},unregistered:function unregistered(response,cause){this.registered=false;this.emit('unregistered',response||null,cause||null);}};SIP.RegisterContext=RegisterContext;};},{}],90:[function(require,module,exports){"use strict";/**
 * @fileoverview Request Sender
 *//**
 * @augments SIP
 * @class Class creating a request sender.
 * @param {Object} applicant
 * @param {SIP.UA} ua
 */module.exports=function(SIP){var RequestSender;RequestSender=function RequestSender(applicant,ua){this.logger=ua.getLogger('sip.requestsender');this.ua=ua;this.applicant=applicant;this.method=applicant.request.method;this.request=applicant.request;this.credentials=null;this.challenged=false;this.staled=false;// If ua is in closing process or even closed just allow sending Bye and ACK
if(ua.status===SIP.UA.C.STATUS_USER_CLOSED&&(this.method!==SIP.C.BYE||this.method!==SIP.C.ACK)){this.onTransportError();}};/**
* Create the client transaction and send the message.
*/RequestSender.prototype={send:function send(){switch(this.method){case"INVITE":this.clientTransaction=new SIP.Transactions.InviteClientTransaction(this,this.request,this.ua.transport);break;case"ACK":this.clientTransaction=new SIP.Transactions.AckClientTransaction(this,this.request,this.ua.transport);break;default:this.clientTransaction=new SIP.Transactions.NonInviteClientTransaction(this,this.request,this.ua.transport);}this.clientTransaction.send();return this.clientTransaction;},/**
  * Callback fired when receiving a request timeout error from the client transaction.
  * To be re-defined by the applicant.
  * @event
  */onRequestTimeout:function onRequestTimeout(){this.applicant.onRequestTimeout();},/**
  * Callback fired when receiving a transport error from the client transaction.
  * To be re-defined by the applicant.
  * @event
  */onTransportError:function onTransportError(){this.applicant.onTransportError();},/**
  * Called from client transaction when receiving a correct response to the request.
  * Authenticate request if needed or pass the response back to the applicant.
  * @param {SIP.IncomingResponse} response
  */receiveResponse:function receiveResponse(response){var cseq,challenge,authorization_header_name,status_code=response.status_code;/*
    * Authentication
    * Authenticate once. _challenged_ flag used to avoid infinite authentications.
    */if(status_code===401||status_code===407){// Get and parse the appropriate WWW-Authenticate or Proxy-Authenticate header.
if(response.status_code===401){challenge=response.parseHeader('www-authenticate');authorization_header_name='authorization';}else{challenge=response.parseHeader('proxy-authenticate');authorization_header_name='proxy-authorization';}// Verify it seems a valid challenge.
if(!challenge){this.logger.warn(response.status_code+' with wrong or missing challenge, cannot authenticate');this.applicant.receiveResponse(response);return;}if(!this.challenged||!this.staled&&challenge.stale===true){if(!this.credentials){this.credentials=this.ua.configuration.authenticationFactory(this.ua);}// Verify that the challenge is really valid.
if(!this.credentials.authenticate(this.request,challenge)){this.applicant.receiveResponse(response);return;}this.challenged=true;if(challenge.stale){this.staled=true;}if(response.method===SIP.C.REGISTER){cseq=this.applicant.cseq+=1;}else if(this.request.dialog){cseq=this.request.dialog.local_seqnum+=1;}else{cseq=this.request.cseq+1;this.request.cseq=cseq;}this.request.setHeader('cseq',cseq+' '+this.method);this.request.setHeader(authorization_header_name,this.credentials.toString());this.send();}else{this.applicant.receiveResponse(response);}}else{this.applicant.receiveResponse(response);}}};SIP.RequestSender=RequestSender;};},{}],91:[function(require,module,exports){/**
 * @name SIP
 * @namespace
 */"use strict";module.exports=function(environment){var pkg=require('../package.json');var SIP=Object.defineProperties({},{version:{get:function get(){return pkg.version;}},name:{get:function get(){return pkg.title;}}});require('./Utils')(SIP,environment);SIP.LoggerFactory=require('./LoggerFactory')(environment.console);SIP.EventEmitter=require('./EventEmitter')(environment.console);SIP.C=require('./Constants')(SIP.name,SIP.version);SIP.Exceptions=require('./Exceptions');SIP.Timers=require('./Timers')(environment.timers);SIP.Transport=environment.Transport(SIP,environment.WebSocket);require('./Parser')(SIP);require('./SIPMessage')(SIP);require('./URI')(SIP);require('./NameAddrHeader')(SIP);require('./Transactions')(SIP);require('./Dialogs')(SIP);require('./RequestSender')(SIP);require('./RegisterContext')(SIP);SIP.MediaHandler=require('./MediaHandler')(SIP.EventEmitter);require('./ClientContext')(SIP);require('./ServerContext')(SIP);require('./Session')(SIP,environment);require('./Subscription')(SIP);SIP.WebRTC=require('./WebRTC')(SIP,environment);require('./UA')(SIP,environment);SIP.Hacks=require('./Hacks')(SIP);require('./SanityCheck')(SIP);SIP.DigestAuthentication=require('./DigestAuthentication')(SIP.Utils);SIP.Grammar=require('./Grammar')(SIP);return SIP;};},{"../package.json":73,"./ClientContext":74,"./Constants":75,"./Dialogs":77,"./DigestAuthentication":78,"./EventEmitter":79,"./Exceptions":80,"./Grammar":81,"./Hacks":83,"./LoggerFactory":84,"./MediaHandler":85,"./NameAddrHeader":86,"./Parser":87,"./RegisterContext":89,"./RequestSender":90,"./SIPMessage":92,"./SanityCheck":93,"./ServerContext":94,"./Session":95,"./Subscription":97,"./Timers":98,"./Transactions":99,"./UA":101,"./URI":102,"./Utils":103,"./WebRTC":104}],92:[function(require,module,exports){"use strict";/**
 * @fileoverview SIP Message
 */module.exports=function(SIP){var OutgoingRequest,IncomingMessage,IncomingRequest,IncomingResponse;function getSupportedHeader(request){var allowUnregistered=request.ua.configuration.hackAllowUnregisteredOptionTags;var optionTags=[];var optionTagSet={};if(request.method===SIP.C.REGISTER){optionTags.push('path','gruu');}else if(request.method===SIP.C.INVITE&&(request.ua.contact.pub_gruu||request.ua.contact.temp_gruu)){optionTags.push('gruu');}if(request.ua.configuration.rel100===SIP.C.supported.SUPPORTED){optionTags.push('100rel');}if(request.ua.configuration.replaces===SIP.C.supported.SUPPORTED){optionTags.push('replaces');}optionTags.push('outbound');optionTags=optionTags.concat(request.ua.configuration.extraSupported);optionTags=optionTags.filter(function(optionTag){var registered=SIP.C.OPTION_TAGS[optionTag];var unique=!optionTagSet[optionTag];optionTagSet[optionTag]=true;return(registered||allowUnregistered)&&unique;});return'Supported: '+optionTags.join(', ')+'\r\n';}/**
 * @augments SIP
 * @class Class for outgoing SIP request.
 * @param {String} method request method
 * @param {String} ruri request uri
 * @param {SIP.UA} ua
 * @param {Object} params parameters that will have priority over ua.configuration parameters:
 * <br>
 *  - cseq, call_id, from_tag, from_uri, from_displayName, to_uri, to_tag, route_set
 * @param {Object} [headers] extra headers
 * @param {String} [body]
 */OutgoingRequest=function OutgoingRequest(method,ruri,ua,params,extraHeaders,body){var to,from,call_id,cseq,to_uri,from_uri;params=params||{};// Mandatory parameters check
if(!method||!ruri||!ua){return null;}this.logger=ua.getLogger('sip.sipmessage');this.ua=ua;this.headers={};this.method=method;this.ruri=ruri;this.body=body;this.extraHeaders=(extraHeaders||[]).slice();this.statusCode=params.status_code;this.reasonPhrase=params.reason_phrase;// Fill the Common SIP Request Headers
// Route
if(params.route_set){this.setHeader('route',params.route_set);}else if(ua.configuration.usePreloadedRoute){this.setHeader('route',ua.transport.server.sip_uri);}// Via
// Empty Via header. Will be filled by the client transaction.
this.setHeader('via','');// Max-Forwards
this.setHeader('max-forwards',SIP.UA.C.MAX_FORWARDS);// To
to_uri=params.to_uri||ruri;to=params.to_displayName||params.to_displayName===0?'"'+params.to_displayName+'" ':'';to+='<'+(to_uri&&to_uri.toRaw?to_uri.toRaw():to_uri)+'>';to+=params.to_tag?';tag='+params.to_tag:'';this.to=new SIP.NameAddrHeader.parse(to);this.setHeader('to',to);// From
from_uri=params.from_uri||ua.configuration.uri;if(params.from_displayName||params.from_displayName===0){from='"'+params.from_displayName+'" ';}else if(ua.configuration.displayName){from='"'+ua.configuration.displayName+'" ';}else{from='';}from+='<'+(from_uri&&from_uri.toRaw?from_uri.toRaw():from_uri)+'>;tag=';from+=params.from_tag||SIP.Utils.newTag();this.from=new SIP.NameAddrHeader.parse(from);this.setHeader('from',from);// Call-ID
call_id=params.call_id||ua.configuration.sipjsId+SIP.Utils.createRandomToken(15);this.call_id=call_id;this.setHeader('call-id',call_id);// CSeq
cseq=params.cseq||Math.floor(Math.random()*10000);this.cseq=cseq;this.setHeader('cseq',cseq+' '+method);};OutgoingRequest.prototype={/**
   * Replace the the given header by the given value.
   * @param {String} name header name
   * @param {String | Array} value header value
   */setHeader:function setHeader(name,value){this.headers[SIP.Utils.headerize(name)]=value instanceof Array?value:[value];},/**
   * Get the value of the given header name at the given position.
   * @param {String} name header name
   * @returns {String|undefined} Returns the specified header, undefined if header doesn't exist.
   */getHeader:function getHeader(name){var regexp,idx,length=this.extraHeaders.length,header=this.headers[SIP.Utils.headerize(name)];if(header){if(header[0]){return header[0];}}else{regexp=new RegExp('^\\s*'+name+'\\s*:','i');for(idx=0;idx<length;idx++){header=this.extraHeaders[idx];if(regexp.test(header)){return header.substring(header.indexOf(':')+1).trim();}}}return;},/**
   * Get the header/s of the given name.
   * @param {String} name header name
   * @returns {Array} Array with all the headers of the specified name.
   */getHeaders:function getHeaders(name){var idx,length,regexp,header=this.headers[SIP.Utils.headerize(name)],result=[];if(header){length=header.length;for(idx=0;idx<length;idx++){result.push(header[idx]);}return result;}else{length=this.extraHeaders.length;regexp=new RegExp('^\\s*'+name+'\\s*:','i');for(idx=0;idx<length;idx++){header=this.extraHeaders[idx];if(regexp.test(header)){result.push(header.substring(header.indexOf(':')+1).trim());}}return result;}},/**
   * Verify the existence of the given header.
   * @param {String} name header name
   * @returns {boolean} true if header with given name exists, false otherwise
   */hasHeader:function hasHeader(name){var regexp,idx,length=this.extraHeaders.length;if(this.headers[SIP.Utils.headerize(name)]){return true;}else{regexp=new RegExp('^\\s*'+name+'\\s*:','i');for(idx=0;idx<length;idx++){if(regexp.test(this.extraHeaders[idx])){return true;}}}return false;},toString:function toString(){var msg='',header,length,idx;msg+=this.method+' '+(this.ruri.toRaw?this.ruri.toRaw():this.ruri)+' SIP/2.0\r\n';for(header in this.headers){length=this.headers[header].length;for(idx=0;idx<length;idx++){msg+=header+': '+this.headers[header][idx]+'\r\n';}}length=this.extraHeaders.length;for(idx=0;idx<length;idx++){msg+=this.extraHeaders[idx].trim()+'\r\n';}msg+=getSupportedHeader(this);msg+='User-Agent: '+this.ua.configuration.userAgentString+'\r\n';if(this.body){if(typeof this.body==='string'){length=SIP.Utils.str_utf8_length(this.body);msg+='Content-Length: '+length+'\r\n\r\n';msg+=this.body;}else{if(this.body.body&&this.body.contentType){length=SIP.Utils.str_utf8_length(this.body.body);msg+='Content-Type: '+this.body.contentType+'\r\n';msg+='Content-Length: '+length+'\r\n\r\n';msg+=this.body.body;}else{msg+='Content-Length: '+0+'\r\n\r\n';}}}else{msg+='Content-Length: '+0+'\r\n\r\n';}return msg;}};/**
 * @augments SIP
 * @class Class for incoming SIP message.
 */IncomingMessage=function IncomingMessage(){this.data=null;this.headers=null;this.method=null;this.via=null;this.via_branch=null;this.call_id=null;this.cseq=null;this.from=null;this.from_tag=null;this.to=null;this.to_tag=null;this.body=null;};IncomingMessage.prototype={/**
  * Insert a header of the given name and value into the last position of the
  * header array.
  * @param {String} name header name
  * @param {String} value header value
  */addHeader:function addHeader(name,value){var header={raw:value};name=SIP.Utils.headerize(name);if(this.headers[name]){this.headers[name].push(header);}else{this.headers[name]=[header];}},/**
   * Get the value of the given header name at the given position.
   * @param {String} name header name
   * @returns {String|undefined} Returns the specified header, null if header doesn't exist.
   */getHeader:function getHeader(name){var header=this.headers[SIP.Utils.headerize(name)];if(header){if(header[0]){return header[0].raw;}}else{return;}},/**
   * Get the header/s of the given name.
   * @param {String} name header name
   * @returns {Array} Array with all the headers of the specified name.
   */getHeaders:function getHeaders(name){var idx,length,header=this.headers[SIP.Utils.headerize(name)],result=[];if(!header){return[];}length=header.length;for(idx=0;idx<length;idx++){result.push(header[idx].raw);}return result;},/**
   * Verify the existence of the given header.
   * @param {String} name header name
   * @returns {boolean} true if header with given name exists, false otherwise
   */hasHeader:function hasHeader(name){return this.headers[SIP.Utils.headerize(name)]?true:false;},/**
  * Parse the given header on the given index.
  * @param {String} name header name
  * @param {Number} [idx=0] header index
  * @returns {Object|undefined} Parsed header object, undefined if the header is not present or in case of a parsing error.
  */parseHeader:function parseHeader(name,idx){var header,value,parsed;name=SIP.Utils.headerize(name);idx=idx||0;if(!this.headers[name]){this.logger.log('header "'+name+'" not present');return;}else if(idx>=this.headers[name].length){this.logger.log('not so many "'+name+'" headers present');return;}header=this.headers[name][idx];value=header.raw;if(header.parsed){return header.parsed;}//substitute '-' by '_' for grammar rule matching.
parsed=SIP.Grammar.parse(value,name.replace(/-/g,'_'));if(parsed===-1){this.headers[name].splice(idx,1);//delete from headers
this.logger.warn('error parsing "'+name+'" header field with value "'+value+'"');return;}else{header.parsed=parsed;return parsed;}},/**
   * Message Header attribute selector. Alias of parseHeader.
   * @param {String} name header name
   * @param {Number} [idx=0] header index
   * @returns {Object|undefined} Parsed header object, undefined if the header is not present or in case of a parsing error.
   *
   * @example
   * message.s('via',3).port
   */s:function s(name,idx){return this.parseHeader(name,idx);},/**
  * Replace the value of the given header by the value.
  * @param {String} name header name
  * @param {String} value header value
  */setHeader:function setHeader(name,value){var header={raw:value};this.headers[SIP.Utils.headerize(name)]=[header];},toString:function toString(){return this.data;}};/**
 * @augments IncomingMessage
 * @class Class for incoming SIP request.
 */IncomingRequest=function IncomingRequest(ua){this.logger=ua.getLogger('sip.sipmessage');this.ua=ua;this.headers={};this.ruri=null;this.transport=null;this.server_transaction=null;};IncomingRequest.prototype=new IncomingMessage();/**
* Stateful reply.
* @param {Number} code status code
* @param {String} reason reason phrase
* @param {Object} headers extra headers
* @param {String} body body
* @param {Function} [onSuccess] onSuccess callback
* @param {Function} [onFailure] onFailure callback
*/IncomingRequest.prototype.reply=function(code,reason,extraHeaders,body,onSuccess,onFailure){var rr,vias,length,idx,response,to=this.getHeader('To'),r=0,v=0;response=SIP.Utils.buildStatusLine(code,reason);extraHeaders=(extraHeaders||[]).slice();if(this.method===SIP.C.INVITE&&code>100&&code<=200){rr=this.getHeaders('record-route');length=rr.length;for(r;r<length;r++){response+='Record-Route: '+rr[r]+'\r\n';}}vias=this.getHeaders('via');length=vias.length;for(v;v<length;v++){response+='Via: '+vias[v]+'\r\n';}if(!this.to_tag&&code>100){to+=';tag='+SIP.Utils.newTag();}else if(this.to_tag&&!this.s('to').hasParam('tag')){to+=';tag='+this.to_tag;}response+='To: '+to+'\r\n';response+='From: '+this.getHeader('From')+'\r\n';response+='Call-ID: '+this.call_id+'\r\n';response+='CSeq: '+this.cseq+' '+this.method+'\r\n';length=extraHeaders.length;for(idx=0;idx<length;idx++){response+=extraHeaders[idx].trim()+'\r\n';}response+=getSupportedHeader(this);response+='User-Agent: '+this.ua.configuration.userAgentString+'\r\n';if(body){if(typeof body==='string'){length=SIP.Utils.str_utf8_length(body);response+='Content-Type: application/sdp\r\n';response+='Content-Length: '+length+'\r\n\r\n';response+=body;}else{if(body.body&&body.contentType){length=SIP.Utils.str_utf8_length(body.body);response+='Content-Type: '+body.contentType+'\r\n';response+='Content-Length: '+length+'\r\n\r\n';response+=body.body;}else{response+='Content-Length: '+0+'\r\n\r\n';}}}else{response+='Content-Length: '+0+'\r\n\r\n';}this.server_transaction.receiveResponse(code,response).then(onSuccess,onFailure);return response;};/**
* Stateless reply.
* @param {Number} code status code
* @param {String} reason reason phrase
*/IncomingRequest.prototype.reply_sl=function(code,reason){var to,response,v=0,vias=this.getHeaders('via'),length=vias.length;response=SIP.Utils.buildStatusLine(code,reason);for(v;v<length;v++){response+='Via: '+vias[v]+'\r\n';}to=this.getHeader('To');if(!this.to_tag&&code>100){to+=';tag='+SIP.Utils.newTag();}else if(this.to_tag&&!this.s('to').hasParam('tag')){to+=';tag='+this.to_tag;}response+='To: '+to+'\r\n';response+='From: '+this.getHeader('From')+'\r\n';response+='Call-ID: '+this.call_id+'\r\n';response+='CSeq: '+this.cseq+' '+this.method+'\r\n';response+='User-Agent: '+this.ua.configuration.userAgentString+'\r\n';response+='Content-Length: '+0+'\r\n\r\n';this.transport.send(response);};/**
 * @augments IncomingMessage
 * @class Class for incoming SIP response.
 */IncomingResponse=function IncomingResponse(ua){this.logger=ua.getLogger('sip.sipmessage');this.headers={};this.status_code=null;this.reason_phrase=null;};IncomingResponse.prototype=new IncomingMessage();SIP.OutgoingRequest=OutgoingRequest;SIP.IncomingRequest=IncomingRequest;SIP.IncomingResponse=IncomingResponse;};},{}],93:[function(require,module,exports){"use strict";/**
 * @fileoverview Incoming SIP Message Sanity Check
 *//**
 * SIP message sanity check.
 * @augments SIP
 * @function
 * @param {SIP.IncomingMessage} message
 * @param {SIP.UA} ua
 * @param {SIP.Transport} transport
 * @returns {Boolean}
 */module.exports=function(SIP){var sanityCheck,logger,message,ua,transport,requests=[],responses=[],all=[];// Reply
function reply(status_code){var to,response=SIP.Utils.buildStatusLine(status_code),vias=message.getHeaders('via'),length=vias.length,idx=0;for(idx;idx<length;idx++){response+="Via: "+vias[idx]+"\r\n";}to=message.getHeader('To');if(!message.to_tag){to+=';tag='+SIP.Utils.newTag();}response+="To: "+to+"\r\n";response+="From: "+message.getHeader('From')+"\r\n";response+="Call-ID: "+message.call_id+"\r\n";response+="CSeq: "+message.cseq+" "+message.method+"\r\n";response+="\r\n";transport.send(response);}/*
 * Sanity Check for incoming Messages
 *
 * Requests:
 *  - _rfc3261_8_2_2_1_ Receive a Request with a non supported URI scheme
 *  - _rfc3261_16_3_4_ Receive a Request already sent by us
 *   Does not look at via sent-by but at sipjsId, which is inserted as
 *   a prefix in all initial requests generated by the ua
 *  - _rfc3261_18_3_request_ Body Content-Length
 *  - _rfc3261_8_2_2_2_ Merged Requests
 *
 * Responses:
 *  - _rfc3261_8_1_3_3_ Multiple Via headers
 *  - _rfc3261_18_1_2_ sent-by mismatch
 *  - _rfc3261_18_3_response_ Body Content-Length
 *
 * All:
 *  - Minimum headers in a SIP message
 */// Sanity Check functions for requests
function rfc3261_8_2_2_1(){if(!message.ruri||message.ruri.scheme!=='sip'){reply(416);return false;}}function rfc3261_16_3_4(){if(!message.to_tag){if(message.call_id.substr(0,5)===ua.configuration.sipjsId){reply(482);return false;}}}function rfc3261_18_3_request(){var len=SIP.Utils.str_utf8_length(message.body),contentLength=message.getHeader('content-length');if(len<contentLength){reply(400);return false;}}function rfc3261_8_2_2_2(){var tr,idx,fromTag=message.from_tag,call_id=message.call_id,cseq=message.cseq;if(!message.to_tag){if(message.method===SIP.C.INVITE){tr=ua.transactions.ist[message.via_branch];if(tr){return;}else{for(idx in ua.transactions.ist){tr=ua.transactions.ist[idx];if(tr.request.from_tag===fromTag&&tr.request.call_id===call_id&&tr.request.cseq===cseq){reply(482);return false;}}}}else{tr=ua.transactions.nist[message.via_branch];if(tr){return;}else{for(idx in ua.transactions.nist){tr=ua.transactions.nist[idx];if(tr.request.from_tag===fromTag&&tr.request.call_id===call_id&&tr.request.cseq===cseq){reply(482);return false;}}}}}}// Sanity Check functions for responses
function rfc3261_8_1_3_3(){if(message.getHeaders('via').length>1){logger.warn('More than one Via header field present in the response. Dropping the response');return false;}}function rfc3261_18_1_2(){var viaHost=ua.configuration.viaHost;if(message.via.host!==viaHost||message.via.port!==undefined){logger.warn('Via sent-by in the response does not match UA Via host value. Dropping the response');return false;}}function rfc3261_18_3_response(){var len=SIP.Utils.str_utf8_length(message.body),contentLength=message.getHeader('content-length');if(len<contentLength){logger.warn('Message body length is lower than the value in Content-Length header field. Dropping the response');return false;}}// Sanity Check functions for requests and responses
function minimumHeaders(){var mandatoryHeaders=['from','to','call_id','cseq','via'],idx=mandatoryHeaders.length;while(idx--){if(!message.hasHeader(mandatoryHeaders[idx])){logger.warn('Missing mandatory header field : '+mandatoryHeaders[idx]+'. Dropping the response');return false;}}}requests.push(rfc3261_8_2_2_1);requests.push(rfc3261_16_3_4);requests.push(rfc3261_18_3_request);requests.push(rfc3261_8_2_2_2);responses.push(rfc3261_8_1_3_3);// responses.push(rfc3261_18_1_2);
responses.push(rfc3261_18_3_response);all.push(minimumHeaders);sanityCheck=function sanityCheck(m,u,t){var len,pass;message=m;ua=u;transport=t;logger=ua.getLogger('sip.sanitycheck');len=all.length;while(len--){pass=all[len](message);if(pass===false){return false;}}if(message instanceof SIP.IncomingRequest){len=requests.length;while(len--){pass=requests[len](message);if(pass===false){return false;}}}else if(message instanceof SIP.IncomingResponse){len=responses.length;while(len--){pass=responses[len](message);if(pass===false){return false;}}}//Everything is OK
return true;};SIP.sanityCheck=sanityCheck;};},{}],94:[function(require,module,exports){"use strict";module.exports=function(SIP){var ServerContext;ServerContext=function ServerContext(ua,request){this.ua=ua;this.logger=ua.getLogger('sip.servercontext');this.request=request;if(request.method===SIP.C.INVITE){this.transaction=new SIP.Transactions.InviteServerTransaction(request,ua);}else{this.transaction=new SIP.Transactions.NonInviteServerTransaction(request,ua);}if(request.body){this.body=request.body;}if(request.hasHeader('Content-Type')){this.contentType=request.getHeader('Content-Type');}this.method=request.method;this.data={};this.localIdentity=request.to;this.remoteIdentity=request.from;};ServerContext.prototype=Object.create(SIP.EventEmitter.prototype);ServerContext.prototype.progress=function(options){options=Object.create(options||Object.prototype);options.statusCode||(options.statusCode=180);options.minCode=100;options.maxCode=199;options.events=['progress'];return this.reply(options);};ServerContext.prototype.accept=function(options){options=Object.create(options||Object.prototype);options.statusCode||(options.statusCode=200);options.minCode=200;options.maxCode=299;options.events=['accepted'];return this.reply(options);};ServerContext.prototype.reject=function(options){options=Object.create(options||Object.prototype);options.statusCode||(options.statusCode=480);options.minCode=300;options.maxCode=699;options.events=['rejected','failed'];return this.reply(options);};ServerContext.prototype.reply=function(options){options=options||{};// This is okay, so long as we treat options as read-only in this method
var statusCode=options.statusCode||100,minCode=options.minCode||100,maxCode=options.maxCode||699,reasonPhrase=SIP.Utils.getReasonPhrase(statusCode,options.reasonPhrase),extraHeaders=options.extraHeaders||[],body=options.body,events=options.events||[],response;if(statusCode<minCode||statusCode>maxCode){throw new TypeError('Invalid statusCode: '+statusCode);}response=this.request.reply(statusCode,reasonPhrase,extraHeaders,body);events.forEach(function(event){this.emit(event,response,reasonPhrase);},this);return this;};ServerContext.prototype.onRequestTimeout=function(){this.emit('failed',null,SIP.C.causes.REQUEST_TIMEOUT);};ServerContext.prototype.onTransportError=function(){this.emit('failed',null,SIP.C.causes.CONNECTION_ERROR);};SIP.ServerContext=ServerContext;};},{}],95:[function(require,module,exports){"use strict";module.exports=function(SIP,environment){var DTMF=require('./Session/DTMF')(SIP);var RFC4028=require('./RFC4028')(SIP.Timers);var Session,InviteServerContext,InviteClientContext,C={//Session states
STATUS_NULL:0,STATUS_INVITE_SENT:1,STATUS_1XX_RECEIVED:2,STATUS_INVITE_RECEIVED:3,STATUS_WAITING_FOR_ANSWER:4,STATUS_ANSWERED:5,STATUS_WAITING_FOR_PRACK:6,STATUS_WAITING_FOR_ACK:7,STATUS_CANCELED:8,STATUS_TERMINATED:9,STATUS_ANSWERED_WAITING_FOR_PRACK:10,STATUS_EARLY_MEDIA:11,STATUS_CONFIRMED:12};/*
 * @param {function returning SIP.MediaHandler} [mediaHandlerFactory]
 *        (See the documentation for the mediaHandlerFactory argument of the UA constructor.)
 */Session=function Session(mediaHandlerFactory){this.status=C.STATUS_NULL;this.dialog=null;this.earlyDialogs={};this.mediaHandlerFactory=mediaHandlerFactory||SIP.WebRTC.MediaHandler.defaultFactory;// this.mediaHandler gets set by ICC/ISC constructors
this.hasOffer=false;this.hasAnswer=false;// Session Timers
this.timers={ackTimer:null,expiresTimer:null,invite2xxTimer:null,userNoAnswerTimer:null,rel1xxTimer:null,prackTimer:null};// Session info
this.startTime=null;this.endTime=null;this.tones=null;// Mute/Hold state
this.local_hold=false;this.remote_hold=false;this.pending_actions={actions:[],length:function length(){return this.actions.length;},isPending:function isPending(name){var idx=0,length=this.actions.length;for(idx;idx<length;idx++){if(this.actions[idx].name===name){return true;}}return false;},shift:function shift(){return this.actions.shift();},push:function push(name){this.actions.push({name:name});},pop:function pop(name){var idx=0,length=this.actions.length;for(idx;idx<length;idx++){if(this.actions[idx].name===name){this.actions.splice(idx,1);length--;idx--;}}}};this.early_sdp=null;this.rel100=SIP.C.supported.UNSUPPORTED;};Session.prototype={dtmf:function dtmf(tones,options){var tone,dtmfs=[],self=this;options=options||{};if(tones===undefined){throw new TypeError('Not enough arguments');}// Check Session Status
if(this.status!==C.STATUS_CONFIRMED&&this.status!==C.STATUS_WAITING_FOR_ACK){throw new SIP.Exceptions.InvalidStateError(this.status);}// Check tones
if(typeof tones!=='string'&&typeof tones!=='number'||!tones.toString().match(/^[0-9A-D#*,]+$/i)){throw new TypeError('Invalid tones: '+tones);}tones=tones.toString().split('');while(tones.length>0){dtmfs.push(new DTMF(this,tones.shift(),options));}if(this.tones){// Tones are already queued, just add to the queue
this.tones=this.tones.concat(dtmfs);return this;}var sendDTMF=function sendDTMF(){var dtmf,timeout;if(self.status===C.STATUS_TERMINATED||!self.tones||self.tones.length===0){// Stop sending DTMF
self.tones=null;return this;}dtmf=self.tones.shift();if(tone===','){timeout=2000;}else{dtmf.on('failed',function(){self.tones=null;});dtmf.send(options);timeout=dtmf.duration+dtmf.interToneGap;}// Set timeout for the next tone
SIP.Timers.setTimeout(sendDTMF,timeout);};this.tones=dtmfs;sendDTMF();return this;},bye:function bye(options){options=Object.create(options||Object.prototype);var statusCode=options.statusCode;// Check Session Status
if(this.status===C.STATUS_TERMINATED){this.logger.error('Error: Attempted to send BYE in a terminated session.');return this;}this.logger.log('terminating Session');if(statusCode&&(statusCode<200||statusCode>=700)){throw new TypeError('Invalid statusCode: '+statusCode);}options.receiveResponse=function(){};return this.sendRequest(SIP.C.BYE,options).terminated();},refer:function refer(target,options){options=options||{};var extraHeaders=(options.extraHeaders||[]).slice(),withReplaces=target instanceof SIP.InviteServerContext||target instanceof SIP.InviteClientContext,originalTarget=target;if(target===undefined){throw new TypeError('Not enough arguments');}// Check Session Status
if(this.status!==C.STATUS_CONFIRMED){throw new SIP.Exceptions.InvalidStateError(this.status);}// transform `target` so that it can be a Refer-To header value
if(withReplaces){//Attended Transfer
// B.transfer(C)
target='"'+target.remoteIdentity.friendlyName+'" '+'<'+target.dialog.remote_target.toString()+'?Replaces='+target.dialog.id.call_id+'%3Bto-tag%3D'+target.dialog.id.remote_tag+'%3Bfrom-tag%3D'+target.dialog.id.local_tag+'>';}else{//Blind Transfer
// normalizeTarget allows instances of SIP.URI to pass through unaltered,
// so try to make one ahead of time
try{target=SIP.Grammar.parse(target,'Refer_To').uri||target;}catch(e){this.logger.debug(".refer() cannot parse Refer_To from",target);this.logger.debug("...falling through to normalizeTarget()");}// Check target validity
target=this.ua.normalizeTarget(target);if(!target){throw new TypeError('Invalid target: '+originalTarget);}}extraHeaders.push('Contact: '+this.contact);extraHeaders.push('Allow: '+SIP.UA.C.ALLOWED_METHODS.toString());extraHeaders.push('Refer-To: '+target);// Send the request
this.sendRequest(SIP.C.REFER,{extraHeaders:extraHeaders,body:options.body,receiveResponse:function(response){if(!/^2[0-9]{2}$/.test(response.status_code)){return;}// hang up only if we transferred to a SIP address
if(withReplaces||target.scheme&&target.scheme.match("^sips?$")){this.terminate();}}.bind(this)});return this;},followRefer:function followRefer(callback){return function referListener(callback,request){// open non-SIP URIs if possible and keep session open
var referTo=request.parseHeader('refer-to');var target=referTo.uri;if(!target.scheme.match("^sips?$")){var targetString=target.toString();if(typeof environment.open==="function"){environment.open(targetString);}else{this.logger.warn("referred to non-SIP URI but `open` isn't in the environment: "+targetString);}return;}var extraHeaders=[];/* Copy the Replaces query into a Replaces header *//* TODO - make sure we don't copy a poorly formatted header? */var replaces=target.getHeader('Replaces');if(replaces!==undefined){extraHeaders.push('Replaces: '+decodeURIComponent(replaces));}// don't embed headers into Request-URI of INVITE
target.clearHeaders();/*
        Harmless race condition.  Both sides of REFER
        may send a BYE, but in the end the dialogs are destroyed.
      */var getReferMedia=this.mediaHandler.getReferMedia;var mediaHint=getReferMedia?getReferMedia.call(this.mediaHandler):this.mediaHint;SIP.Hacks.Chrome.getsConfusedAboutGUM(this);var referSession=this.ua.invite(target,{media:mediaHint,params:{to_displayName:referTo.friendlyName},extraHeaders:extraHeaders});callback.call(this,request,referSession);this.terminate();}.bind(this,callback);},sendRequest:function sendRequest(method,options){options=options||{};var self=this;var request=new SIP.OutgoingRequest(method,this.dialog.remote_target,this.ua,{cseq:options.cseq||(this.dialog.local_seqnum+=1),call_id:this.dialog.id.call_id,from_uri:this.dialog.local_uri,from_tag:this.dialog.id.local_tag,to_uri:this.dialog.remote_uri,to_tag:this.dialog.id.remote_tag,route_set:this.dialog.route_set,statusCode:options.statusCode,reasonPhrase:options.reasonPhrase},options.extraHeaders||[],options.body);new SIP.RequestSender({request:request,onRequestTimeout:function onRequestTimeout(){self.onRequestTimeout();},onTransportError:function onTransportError(){self.onTransportError();},receiveResponse:options.receiveResponse||function(response){self.receiveNonInviteResponse(response);}},this.ua).send();// Emit the request event
this.emit(method.toLowerCase(),request);return this;},close:function close(){var idx;if(this.status===C.STATUS_TERMINATED){return this;}this.logger.log('closing INVITE session '+this.id);// 1st Step. Terminate media.
if(this.mediaHandler){this.mediaHandler.close();}// 2nd Step. Terminate signaling.
// Clear session timers
for(idx in this.timers){SIP.Timers.clearTimeout(this.timers[idx]);}// Terminate dialogs
// Terminate confirmed dialog
if(this.dialog){this.dialog.terminate();delete this.dialog;}// Terminate early dialogs
for(idx in this.earlyDialogs){this.earlyDialogs[idx].terminate();delete this.earlyDialogs[idx];}this.status=C.STATUS_TERMINATED;delete this.ua.sessions[this.id];return this;},createDialog:function createDialog(message,type,early){var dialog,early_dialog,local_tag=message[type==='UAS'?'to_tag':'from_tag'],remote_tag=message[type==='UAS'?'from_tag':'to_tag'],id=message.call_id+local_tag+remote_tag;early_dialog=this.earlyDialogs[id];// Early Dialog
if(early){if(early_dialog){return true;}else{early_dialog=new SIP.Dialog(this,message,type,SIP.Dialog.C.STATUS_EARLY);// Dialog has been successfully created.
if(early_dialog.error){this.logger.error(early_dialog.error);this.failed(message,SIP.C.causes.INTERNAL_ERROR);return false;}else{this.earlyDialogs[id]=early_dialog;return true;}}}// Confirmed Dialog
else{// In case the dialog is in _early_ state, update it
if(early_dialog){early_dialog.update(message,type);this.dialog=early_dialog;delete this.earlyDialogs[id];for(var dia in this.earlyDialogs){this.earlyDialogs[dia].terminate();delete this.earlyDialogs[dia];}return true;}// Otherwise, create a _confirmed_ dialog
dialog=new SIP.Dialog(this,message,type);if(dialog.error){this.logger.error(dialog.error);this.failed(message,SIP.C.causes.INTERNAL_ERROR);return false;}else{this.to_tag=message.to_tag;this.dialog=dialog;return true;}}},/**
  * Check if Session is ready for a re-INVITE
  *
  * @returns {Boolean}
  */isReadyToReinvite:function isReadyToReinvite(){return this.mediaHandler.isReady()&&!this.dialog.uac_pending_reply&&!this.dialog.uas_pending_reply;},/**
   * Mute
   */mute:function mute(options){var ret=this.mediaHandler.mute(options);if(ret){this.onmute(ret);}},/**
   * Unmute
   */unmute:function unmute(options){var ret=this.mediaHandler.unmute(options);if(ret){this.onunmute(ret);}},/**
   * Hold
   */hold:function hold(){if(this.status!==C.STATUS_WAITING_FOR_ACK&&this.status!==C.STATUS_CONFIRMED){throw new SIP.Exceptions.InvalidStateError(this.status);}this.mediaHandler.hold();// Check if RTCSession is ready to send a reINVITE
if(!this.isReadyToReinvite()){/* If there is a pending 'unhold' action, cancel it and don't queue this one
       * Else, if there isn't any 'hold' action, add this one to the queue
       * Else, if there is already a 'hold' action, skip
       */if(this.pending_actions.isPending('unhold')){this.pending_actions.pop('unhold');}else if(!this.pending_actions.isPending('hold')){this.pending_actions.push('hold');}return;}else if(this.local_hold===true){return;}this.onhold('local');this.sendReinvite();},/**
   * Unhold
   */unhold:function unhold(options){if(this.status!==C.STATUS_WAITING_FOR_ACK&&this.status!==C.STATUS_CONFIRMED){throw new SIP.Exceptions.InvalidStateError(this.status);}this.mediaHandler.unhold();if(!this.isReadyToReinvite()){/* If there is a pending 'hold' action, cancel it and don't queue this one
       * Else, if there isn't any 'unhold' action, add this one to the queue
       * Else, if there is already a 'unhold' action, skip
       */if(this.pending_actions.isPending('hold')){this.pending_actions.pop('hold');}else if(!this.pending_actions.isPending('unhold')){this.pending_actions.push('unhold');}return;}else if(this.local_hold===false){return;}this.onunhold('local');this.sendReinvite(options);},/**
   * isOnHold
   */isOnHold:function isOnHold(){return{local:this.local_hold,remote:this.remote_hold};},/**
   * In dialog INVITE Reception
   * @private
   */receiveReinvite:function receiveReinvite(request){var self=this;if(!this.mediaHandler.hasDescription(request)){this.logger.warn('invalid Content-Type');request.reply(415);return;}this.mediaHandler.setDescription(request).then(this.mediaHandler.getDescription.bind(this.mediaHandler,this.mediaHint)).then(function(description){var extraHeaders=['Contact: '+self.contact];request.reply(200,null,extraHeaders,description,function(){self.status=C.STATUS_WAITING_FOR_ACK;self.setInvite2xxTimer(request,description);self.setACKTimer();if(self.remote_hold&&!self.mediaHandler.remote_hold){self.onunhold('remote');}else if(!self.remote_hold&&self.mediaHandler.remote_hold){self.onhold('remote');}});}).catch(function onFailure(e){var statusCode;if(e instanceof SIP.Exceptions.GetDescriptionError){statusCode=500;}else{self.logger.error(e);statusCode=488;}request.reply(statusCode);});},sendReinvite:function sendReinvite(options){options=options||{};var self=this,extraHeaders=(options.extraHeaders||[]).slice(),eventHandlers=options.eventHandlers||{},succeeded;if(eventHandlers.succeeded){succeeded=eventHandlers.succeeded;}this.reinviteSucceeded=function(){SIP.Timers.clearTimeout(self.timers.ackTimer);SIP.Timers.clearTimeout(self.timers.invite2xxTimer);self.status=C.STATUS_CONFIRMED;succeeded&&succeeded.apply(this,arguments);};if(eventHandlers.failed){this.reinviteFailed=eventHandlers.failed;}else{this.reinviteFailed=function(){};}extraHeaders.push('Contact: '+this.contact);extraHeaders.push('Allow: '+SIP.UA.C.ALLOWED_METHODS.toString());this.receiveResponse=this.receiveReinviteResponse;//REVISIT
this.mediaHandler.getDescription(self.mediaHint).then(function(description){self.dialog.sendRequest(self,SIP.C.INVITE,{extraHeaders:extraHeaders,body:description});},function(){if(self.isReadyToReinvite()){self.onReadyToReinvite();}self.reinviteFailed();});},receiveRequest:function receiveRequest(request){switch(request.method){case SIP.C.BYE:request.reply(200);if(this.status===C.STATUS_CONFIRMED){this.emit('bye',request);this.terminated(request,SIP.C.causes.BYE);}break;case SIP.C.INVITE:if(this.status===C.STATUS_CONFIRMED){this.logger.log('re-INVITE received');this.receiveReinvite(request);}break;case SIP.C.INFO:if(this.status===C.STATUS_1XX_RECEIVED||this.status===C.STATUS_WAITING_FOR_PRACK||this.status===C.STATUS_WAITING_FOR_ACK||this.status===C.STATUS_ANSWERED_WAITING_FOR_PRACK||this.status===C.STATUS_EARLY_MEDIA||this.status===C.STATUS_CONFIRMED||this.dialog){if(this.onInfo){return this.onInfo(request);}var body,tone,duration,contentType=request.getHeader('content-type'),reg_tone=/^(Signal\s*?=\s*?)([0-9A-D#*]{1})(\s)?.*/,reg_duration=/^(Duration\s?=\s?)([0-9]{1,4})(\s)?.*/;if(contentType){if(contentType.match(/^application\/dtmf-relay/i)){if(request.body){body=request.body.split('\r\n',2);if(body.length===2){if(reg_tone.test(body[0])){tone=body[0].replace(reg_tone,"$2");}if(reg_duration.test(body[1])){duration=parseInt(body[1].replace(reg_duration,"$2"),10);}}}new DTMF(this,tone,{duration:duration}).init_incoming(request);}else{request.reply(415,null,["Accept: application/dtmf-relay"]);}}}break;case SIP.C.REFER:if(this.status===C.STATUS_CONFIRMED){this.logger.log('REFER received');var hasReferListener=this.listeners('refer').length,notifyBody;if(hasReferListener){request.reply(202,'Accepted');notifyBody='SIP/2.0 100 Trying';this.sendRequest(SIP.C.NOTIFY,{extraHeaders:['Event: refer','Subscription-State: terminated','Content-Type: message/sipfrag'],body:notifyBody,receiveResponse:function receiveResponse(){}});this.emit('refer',request);}else{// RFC 3515.2.4.2: 'the UA MAY decline the request.'
request.reply(603,'Declined');}}break;case SIP.C.NOTIFY:request.reply(200,'OK');this.emit('notify',request);break;}},/**
   * Reception of Response for in-dialog INVITE
   * @private
   */receiveReinviteResponse:function receiveReinviteResponse(response){var self=this;if(this.status===C.STATUS_TERMINATED){return;}switch(true){case /^1[0-9]{2}$/.test(response.status_code):break;case /^2[0-9]{2}$/.test(response.status_code):this.status=C.STATUS_CONFIRMED;this.sendRequest(SIP.C.ACK,{cseq:response.cseq});if(!this.mediaHandler.hasDescription(response)){this.reinviteFailed();break;}//REVISIT
this.mediaHandler.setDescription(response).then(function onSuccess(){self.reinviteSucceeded();},function onFailure(){self.reinviteFailed();});break;default:this.reinviteFailed();}},acceptAndTerminate:function acceptAndTerminate(response,status_code,reason_phrase){var extraHeaders=[];if(status_code){extraHeaders.push('Reason: '+SIP.Utils.getReasonHeaderValue(status_code,reason_phrase));}// An error on dialog creation will fire 'failed' event
if(this.dialog||this.createDialog(response,'UAC')){this.sendRequest(SIP.C.ACK,{cseq:response.cseq});this.sendRequest(SIP.C.BYE,{extraHeaders:extraHeaders});}return this;},/**
   * RFC3261 13.3.1.4
   * Response retransmissions cannot be accomplished by transaction layer
   *  since it is destroyed when receiving the first 2xx answer
   */setInvite2xxTimer:function setInvite2xxTimer(request,description){var self=this,timeout=SIP.Timers.T1;this.timers.invite2xxTimer=SIP.Timers.setTimeout(function invite2xxRetransmission(){if(self.status!==C.STATUS_WAITING_FOR_ACK){return;}self.logger.log('no ACK received, attempting to retransmit OK');var extraHeaders=['Contact: '+self.contact];request.reply(200,null,extraHeaders,description);timeout=Math.min(timeout*2,SIP.Timers.T2);self.timers.invite2xxTimer=SIP.Timers.setTimeout(invite2xxRetransmission,timeout);},timeout);},/**
   * RFC3261 14.2
   * If a UAS generates a 2xx response and never receives an ACK,
   *  it SHOULD generate a BYE to terminate the dialog.
   */setACKTimer:function setACKTimer(){var self=this;this.timers.ackTimer=SIP.Timers.setTimeout(function(){if(self.status===C.STATUS_WAITING_FOR_ACK){self.logger.log('no ACK received for an extended period of time, terminating the call');SIP.Timers.clearTimeout(self.timers.invite2xxTimer);self.sendRequest(SIP.C.BYE);self.terminated(null,SIP.C.causes.NO_ACK);}},SIP.Timers.TIMER_H);},/*
   * @private
   */onReadyToReinvite:function onReadyToReinvite(){var action=this.pending_actions.shift();if(!action||!this[action.name]){return;}this[action.name]();},onTransportError:function onTransportError(){if(this.status!==C.STATUS_CONFIRMED&&this.status!==C.STATUS_TERMINATED){this.failed(null,SIP.C.causes.CONNECTION_ERROR);}},onRequestTimeout:function onRequestTimeout(){if(this.status===C.STATUS_CONFIRMED){this.terminated(null,SIP.C.causes.REQUEST_TIMEOUT);}else if(this.status!==C.STATUS_TERMINATED){this.failed(null,SIP.C.causes.REQUEST_TIMEOUT);this.terminated(null,SIP.C.causes.REQUEST_TIMEOUT);}},onDialogError:function onDialogError(response){if(this.status===C.STATUS_CONFIRMED){this.terminated(response,SIP.C.causes.DIALOG_ERROR);}else if(this.status!==C.STATUS_TERMINATED){this.failed(response,SIP.C.causes.DIALOG_ERROR);this.terminated(response,SIP.C.causes.DIALOG_ERROR);}},/**
   * @private
   */onhold:function onhold(originator){this[originator==='local'?'local_hold':'remote_hold']=true;this.emit('hold',{originator:originator});},/**
   * @private
   */onunhold:function onunhold(originator){this[originator==='local'?'local_hold':'remote_hold']=false;this.emit('unhold',{originator:originator});},/*
   * @private
   */onmute:function onmute(options){this.emit('muted',{audio:options.audio,video:options.video});},/*
   * @private
   */onunmute:function onunmute(options){this.emit('unmuted',{audio:options.audio,video:options.video});},failed:function failed(response,cause){if(this.status===C.STATUS_TERMINATED){return this;}this.emit('failed',response||null,cause||null);return this;},rejected:function rejected(response,cause){this.emit('rejected',response||null,cause||null);return this;},canceled:function canceled(){this.emit('cancel');return this;},accepted:function accepted(response,cause){cause=SIP.Utils.getReasonPhrase(response&&response.status_code,cause);this.startTime=new Date();if(this.replacee){this.replacee.emit('replaced',this);this.replacee.terminate();}if(response){RFC4028.updateState(this.dialog,response,SIP.Parser.parseMessage,this.ua);}this.emit('accepted',response,cause);return this;},terminated:function terminated(message,cause){if(this.status===C.STATUS_TERMINATED){return this;}this.endTime=new Date();this.close();this.emit('terminated',message||null,cause||null);return this;},connecting:function connecting(request){this.emit('connecting',{request:request});return this;}};Session.desugar=function desugar(options){if(environment.HTMLMediaElement&&options instanceof environment.HTMLMediaElement){options={media:{constraints:{audio:true,video:options.tagName==='VIDEO'},render:{remote:options}}};}return options||{};};Session.C=C;SIP.Session=Session;InviteServerContext=function InviteServerContext(ua,request){var expires,self=this,contentType=request.getHeader('Content-Type'),contentDisp=request.parseHeader('Content-Disposition');SIP.Utils.augment(this,SIP.ServerContext,[ua,request]);SIP.Utils.augment(this,SIP.Session,[ua.configuration.mediaHandlerFactory]);//Initialize Media Session
this.mediaHandler=this.mediaHandlerFactory(this,{RTCConstraints:{"optional":[{'DtlsSrtpKeyAgreement':'true'}]}});// Check body and content type
if(!contentDisp&&!this.mediaHandler.hasDescription(request)||contentDisp&&contentDisp.type==='render'){this.renderbody=request.body;this.rendertype=contentType;}else if(!this.mediaHandler.hasDescription(request)&&contentDisp&&contentDisp.type==='session'){request.reply(415);//TODO: instead of 415, pass off to the media handler, who can then decide if we can use it
return;}// TODO test
// http://tools.ietf.org/html/rfc4028#section-9
if(RFC4028.hasSmallMinSE(request)){request.reply(422,null,['Min-SE: '+RFC4028.localMinSE]);return;}this.status=C.STATUS_INVITE_RECEIVED;this.from_tag=request.from_tag;this.id=request.call_id+this.from_tag;this.request=request;this.contact=this.ua.contact.toString();this.receiveNonInviteResponse=function(){};// intentional no-op
this.logger=ua.getLogger('sip.inviteservercontext',this.id);//Save the session into the ua sessions collection.
this.ua.sessions[this.id]=this;//Get the Expires header value if exists
if(request.hasHeader('expires')){expires=request.getHeader('expires')*1000;}//Set 100rel if necessary
function set100rel(h,c){if(request.hasHeader(h)&&request.getHeader(h).toLowerCase().indexOf('100rel')>=0){self.rel100=c;}}set100rel('require',SIP.C.supported.REQUIRED);set100rel('supported',SIP.C.supported.SUPPORTED);/* Set the to_tag before
   * replying a response code that will create a dialog.
   */request.to_tag=SIP.Utils.newTag();// An error on dialog creation will fire 'failed' event
if(!this.createDialog(request,'UAS',true)){request.reply(500,'Missing Contact header field');return;}if(this.mediaHandler&&this.mediaHandler.getRemoteStreams){this.getRemoteStreams=this.mediaHandler.getRemoteStreams.bind(this.mediaHandler);this.getLocalStreams=this.mediaHandler.getLocalStreams.bind(this.mediaHandler);}function fireNewSession(){var options={extraHeaders:['Contact: '+self.contact]};if(self.rel100!==SIP.C.supported.REQUIRED){self.progress(options);}self.status=C.STATUS_WAITING_FOR_ANSWER;// Set userNoAnswerTimer
self.timers.userNoAnswerTimer=SIP.Timers.setTimeout(function(){request.reply(408);self.failed(request,SIP.C.causes.NO_ANSWER);self.terminated(request,SIP.C.causes.NO_ANSWER);},self.ua.configuration.noAnswerTimeout);/* Set expiresTimer
     * RFC3261 13.3.1
     */if(expires){self.timers.expiresTimer=SIP.Timers.setTimeout(function(){if(self.status===C.STATUS_WAITING_FOR_ANSWER){request.reply(487);self.failed(request,SIP.C.causes.EXPIRES);self.terminated(request,SIP.C.causes.EXPIRES);}},expires);}self.emit('invite',request);}if(!this.mediaHandler.hasDescription(request)||this.renderbody){SIP.Timers.setTimeout(fireNewSession,0);}else{this.hasOffer=true;this.mediaHandler.setDescription(request).then(fireNewSession,function onFailure(e){self.logger.warn('invalid description');self.logger.warn(e);request.reply(488);});}};InviteServerContext.prototype={reject:function reject(options){// Check Session Status
if(this.status===C.STATUS_TERMINATED){throw new SIP.Exceptions.InvalidStateError(this.status);}this.logger.log('rejecting RTCSession');SIP.ServerContext.prototype.reject.call(this,options);return this.terminated();},terminate:function terminate(options){options=options||{};var extraHeaders=(options.extraHeaders||[]).slice(),body=options.body,dialog,self=this;if(this.status===C.STATUS_WAITING_FOR_ACK&&this.request.server_transaction.state!==SIP.Transactions.C.STATUS_TERMINATED){dialog=this.dialog;this.receiveRequest=function(request){if(request.method===SIP.C.ACK){this.sendRequest(SIP.C.BYE,{extraHeaders:extraHeaders,body:body});dialog.terminate();}};this.request.server_transaction.on('stateChanged',function(){if(this.state===SIP.Transactions.C.STATUS_TERMINATED&&this.dialog){this.request=new SIP.OutgoingRequest(SIP.C.BYE,this.dialog.remote_target,this.ua,{'cseq':this.dialog.local_seqnum+=1,'call_id':this.dialog.id.call_id,'from_uri':this.dialog.local_uri,'from_tag':this.dialog.id.local_tag,'to_uri':this.dialog.remote_uri,'to_tag':this.dialog.id.remote_tag,'route_set':this.dialog.route_set},extraHeaders,body);new SIP.RequestSender({request:this.request,onRequestTimeout:function onRequestTimeout(){self.onRequestTimeout();},onTransportError:function onTransportError(){self.onTransportError();},receiveResponse:function receiveResponse(){return;}},this.ua).send();dialog.terminate();}});this.emit('bye',this.request);this.terminated();// Restore the dialog into 'this' in order to be able to send the in-dialog BYE :-)
this.dialog=dialog;// Restore the dialog into 'ua' so the ACK can reach 'this' session
this.ua.dialogs[dialog.id.toString()]=dialog;}else if(this.status===C.STATUS_CONFIRMED){this.bye(options);}else{this.reject(options);}return this;},/*
   * @param {Object} [options.media] gets passed to SIP.MediaHandler.getDescription as mediaHint
   */progress:function progress(options){options=options||{};var statusCode=options.statusCode||180,reasonPhrase=options.reasonPhrase,extraHeaders=(options.extraHeaders||[]).slice(),iceServers,stunServers=options.stunServers||null,turnServers=options.turnServers||null,body=options.body,response;if(statusCode<100||statusCode>199){throw new TypeError('Invalid statusCode: '+statusCode);}if(this.isCanceled||this.status===C.STATUS_TERMINATED){return this;}if(stunServers||turnServers){if(stunServers){iceServers=SIP.UA.configuration_check.optional['stunServers'](stunServers);if(!iceServers){throw new TypeError('Invalid stunServers: '+stunServers);}else{this.stunServers=iceServers;}}if(turnServers){iceServers=SIP.UA.configuration_check.optional['turnServers'](turnServers);if(!iceServers){throw new TypeError('Invalid turnServers: '+turnServers);}else{this.turnServers=iceServers;}}this.mediaHandler.updateIceServers({stunServers:this.stunServers,turnServers:this.turnServers});}function do100rel(){/* jshint validthis: true */statusCode=options.statusCode||183;// Set status and add extra headers
this.status=C.STATUS_WAITING_FOR_PRACK;extraHeaders.push('Contact: '+this.contact);extraHeaders.push('Require: 100rel');extraHeaders.push('RSeq: '+Math.floor(Math.random()*10000));// Save media hint for later (referred sessions)
this.mediaHint=options.media;// Get the session description to add to preaccept with
this.mediaHandler.getDescription(options.media).then(function onSuccess(description){if(this.isCanceled||this.status===C.STATUS_TERMINATED){return;}this.early_sdp=description.body;this[this.hasOffer?'hasAnswer':'hasOffer']=true;// Retransmit until we get a response or we time out (see prackTimer below)
var timeout=SIP.Timers.T1;this.timers.rel1xxTimer=SIP.Timers.setTimeout(function rel1xxRetransmission(){this.request.reply(statusCode,null,extraHeaders,description);timeout*=2;this.timers.rel1xxTimer=SIP.Timers.setTimeout(rel1xxRetransmission.bind(this),timeout);}.bind(this),timeout);// Timeout and reject INVITE if no response
this.timers.prackTimer=SIP.Timers.setTimeout(function(){if(this.status!==C.STATUS_WAITING_FOR_PRACK){return;}this.logger.log('no PRACK received, rejecting the call');SIP.Timers.clearTimeout(this.timers.rel1xxTimer);this.request.reply(504);this.terminated(null,SIP.C.causes.NO_PRACK);}.bind(this),SIP.Timers.T1*64);// Send the initial response
response=this.request.reply(statusCode,reasonPhrase,extraHeaders,description);this.emit('progress',response,reasonPhrase);}.bind(this),function onFailure(){this.request.reply(480);this.failed(null,SIP.C.causes.WEBRTC_ERROR);this.terminated(null,SIP.C.causes.WEBRTC_ERROR);}.bind(this));}// end do100rel
function normalReply(){/* jshint validthis:true */response=this.request.reply(statusCode,reasonPhrase,extraHeaders,body);this.emit('progress',response,reasonPhrase);}if(options.statusCode!==100&&(this.rel100===SIP.C.supported.REQUIRED||this.rel100===SIP.C.supported.SUPPORTED&&options.rel100||this.rel100===SIP.C.supported.SUPPORTED&&this.ua.configuration.rel100===SIP.C.supported.REQUIRED)){do100rel.apply(this);}else{normalReply.apply(this);}return this;},/*
   * @param {Object} [options.media] gets passed to SIP.MediaHandler.getDescription as mediaHint
   */accept:function accept(options){options=Object.create(Session.desugar(options));SIP.Utils.optionsOverride(options,'media','mediaConstraints',true,this.logger,this.ua.configuration.media);this.mediaHint=options.media;this.onInfo=options.onInfo;// commented out now-unused hold-related variables for jshint. See below. JMF 2014-1-21
var//idx, length, hasAudio, hasVideo,
self=this,request=this.request,extraHeaders=(options.extraHeaders||[]).slice(),//mediaStream = options.mediaStream || null,
iceServers,stunServers=options.stunServers||null,turnServers=options.turnServers||null,descriptionCreationSucceeded=function descriptionCreationSucceeded(description){var response,// run for reply success callback
replySucceeded=function replySucceeded(){self.status=C.STATUS_WAITING_FOR_ACK;self.setInvite2xxTimer(request,description);self.setACKTimer();},// run for reply failure callback
replyFailed=function replyFailed(){self.failed(null,SIP.C.causes.CONNECTION_ERROR);self.terminated(null,SIP.C.causes.CONNECTION_ERROR);};// Chrome might call onaddstream before accept() is called, which means
// mediaHandler.render() was called without a renderHint, so we need to
// re-render now that mediaHint.render has been set.
//
// Chrome seems to be in the right regarding this, see
// http://dev.w3.org/2011/webrtc/editor/webrtc.html#widl-RTCPeerConnection-onaddstream
self.mediaHandler.render();extraHeaders.push('Contact: '+self.contact);extraHeaders.push('Allow: '+SIP.UA.C.ALLOWED_METHODS.toString());// TODO test
// http://tools.ietf.org/html/rfc4028#section-9
var supportedOptions=request.parseHeader('Supported')||[];var sessionExpires=request.parseHeader('Session-Expires')||{};var interval=sessionExpires.deltaSeconds;if(interval){var refresher=sessionExpires.refresher||'uas';extraHeaders.push('Session-Expires: '+interval+';'+refresher);if(refresher==='uac'||supportedOptions.indexOf('timer')>=0){extraHeaders.push('Require: timer');}}if(!self.hasOffer){self.hasOffer=true;}else{self.hasAnswer=true;}response=request.reply(200,null,extraHeaders,description,replySucceeded,replyFailed);if(self.status!==C.STATUS_TERMINATED){// Didn't fail
self.accepted(response,SIP.Utils.getReasonPhrase(200));}},descriptionCreationFailed=function descriptionCreationFailed(){if(self.status===C.STATUS_TERMINATED){return;}// TODO - fail out on error
self.request.reply(480);//self.failed(response, SIP.C.causes.USER_DENIED_MEDIA_ACCESS);
self.failed(null,SIP.C.causes.WEBRTC_ERROR);self.terminated(null,SIP.C.causes.WEBRTC_ERROR);};// Check Session Status
if(this.status===C.STATUS_WAITING_FOR_PRACK){this.status=C.STATUS_ANSWERED_WAITING_FOR_PRACK;return this;}else if(this.status===C.STATUS_WAITING_FOR_ANSWER){this.status=C.STATUS_ANSWERED;}else if(this.status!==C.STATUS_EARLY_MEDIA){throw new SIP.Exceptions.InvalidStateError(this.status);}if((stunServers||turnServers)&&this.status!==C.STATUS_EARLY_MEDIA&&this.status!==C.STATUS_ANSWERED_WAITING_FOR_PRACK){if(stunServers){iceServers=SIP.UA.configuration_check.optional['stunServers'](stunServers);if(!iceServers){throw new TypeError('Invalid stunServers: '+stunServers);}else{this.stunServers=iceServers;}}if(turnServers){iceServers=SIP.UA.configuration_check.optional['turnServers'](turnServers);if(!iceServers){throw new TypeError('Invalid turnServers: '+turnServers);}else{this.turnServers=iceServers;}}this.mediaHandler.updateIceServers({stunServers:this.stunServers,turnServers:this.turnServers});}// An error on dialog creation will fire 'failed' event
if(!this.createDialog(request,'UAS')){request.reply(500,'Missing Contact header field');return this;}SIP.Timers.clearTimeout(this.timers.userNoAnswerTimer);// this hold-related code breaks FF accepting new calls - JMF 2014-1-21
/*
    length = this.getRemoteStreams().length;

    for (idx = 0; idx < length; idx++) {
      if (this.mediaHandler.getRemoteStreams()[idx].getVideoTracks().length > 0) {
        hasVideo = true;
      }
      if (this.mediaHandler.getRemoteStreams()[idx].getAudioTracks().length > 0) {
        hasAudio = true;
      }
    }

    if (!hasAudio && this.mediaConstraints.audio === true) {
      this.mediaConstraints.audio = false;
      if (mediaStream) {
        length = mediaStream.getAudioTracks().length;
        for (idx = 0; idx < length; idx++) {
          mediaStream.removeTrack(mediaStream.getAudioTracks()[idx]);
        }
      }
    }

    if (!hasVideo && this.mediaConstraints.video === true) {
      this.mediaConstraints.video = false;
      if (mediaStream) {
        length = mediaStream.getVideoTracks().length;
        for (idx = 0; idx < length; idx++) {
          mediaStream.removeTrack(mediaStream.getVideoTracks()[idx]);
        }
      }
    }
    */if(this.status===C.STATUS_EARLY_MEDIA){descriptionCreationSucceeded({});}else{this.mediaHandler.getDescription(self.mediaHint).then(descriptionCreationSucceeded,descriptionCreationFailed);}return this;},receiveRequest:function receiveRequest(request){// ISC RECEIVE REQUEST
function confirmSession(){/* jshint validthis:true */var contentType;SIP.Timers.clearTimeout(this.timers.ackTimer);SIP.Timers.clearTimeout(this.timers.invite2xxTimer);this.status=C.STATUS_CONFIRMED;this.unmute();// TODO - this logic assumes Content-Disposition defaults
contentType=request.getHeader('Content-Type');if(!this.mediaHandler.hasDescription(request)){this.renderbody=request.body;this.rendertype=contentType;}this.emit('confirmed',request);}switch(request.method){case SIP.C.CANCEL:/* RFC3261 15 States that a UAS may have accepted an invitation while a CANCEL
       * was in progress and that the UAC MAY continue with the session established by
       * any 2xx response, or MAY terminate with BYE. SIP does continue with the
       * established session. So the CANCEL is processed only if the session is not yet
       * established.
       *//*
       * Terminate the whole session in case the user didn't accept (or yet to send the answer) nor reject the
       *request opening the session.
       */if(this.status===C.STATUS_WAITING_FOR_ANSWER||this.status===C.STATUS_WAITING_FOR_PRACK||this.status===C.STATUS_ANSWERED_WAITING_FOR_PRACK||this.status===C.STATUS_EARLY_MEDIA||this.status===C.STATUS_ANSWERED){this.status=C.STATUS_CANCELED;this.request.reply(487);this.canceled(request);this.rejected(request,SIP.C.causes.CANCELED);this.failed(request,SIP.C.causes.CANCELED);this.terminated(request,SIP.C.causes.CANCELED);}break;case SIP.C.ACK:if(this.status===C.STATUS_WAITING_FOR_ACK){if(!this.hasAnswer){if(this.mediaHandler.hasDescription(request)){// ACK contains answer to an INVITE w/o SDP negotiation
this.hasAnswer=true;this.mediaHandler.setDescription(request).then(confirmSession.bind(this),function onFailure(e){this.logger.warn(e);this.terminate({statusCode:'488',reasonPhrase:'Bad Media Description'});this.failed(request,SIP.C.causes.BAD_MEDIA_DESCRIPTION);this.terminated(request,SIP.C.causes.BAD_MEDIA_DESCRIPTION);}.bind(this));}else if(this.early_sdp){confirmSession.apply(this);}else{//TODO: Pass to mediahandler
this.failed(request,SIP.C.causes.BAD_MEDIA_DESCRIPTION);this.terminated(request,SIP.C.causes.BAD_MEDIA_DESCRIPTION);}}else{confirmSession.apply(this);}}break;case SIP.C.PRACK:if(this.status===C.STATUS_WAITING_FOR_PRACK||this.status===C.STATUS_ANSWERED_WAITING_FOR_PRACK){//localMedia = session.mediaHandler.localMedia;
if(!this.hasAnswer){if(this.mediaHandler.hasDescription(request)){this.hasAnswer=true;this.mediaHandler.setDescription(request).then(function onSuccess(){SIP.Timers.clearTimeout(this.timers.rel1xxTimer);SIP.Timers.clearTimeout(this.timers.prackTimer);request.reply(200);if(this.status===C.STATUS_ANSWERED_WAITING_FOR_PRACK){this.status=C.STATUS_EARLY_MEDIA;this.accept();}this.status=C.STATUS_EARLY_MEDIA;//REVISIT
this.mute();}.bind(this),function onFailure(e){//TODO: Send to media handler
this.logger.warn(e);this.terminate({statusCode:'488',reasonPhrase:'Bad Media Description'});this.failed(request,SIP.C.causes.BAD_MEDIA_DESCRIPTION);this.terminated(request,SIP.C.causes.BAD_MEDIA_DESCRIPTION);}.bind(this));}else{this.terminate({statusCode:'488',reasonPhrase:'Bad Media Description'});this.failed(request,SIP.C.causes.BAD_MEDIA_DESCRIPTION);this.terminated(request,SIP.C.causes.BAD_MEDIA_DESCRIPTION);}}else{SIP.Timers.clearTimeout(this.timers.rel1xxTimer);SIP.Timers.clearTimeout(this.timers.prackTimer);request.reply(200);if(this.status===C.STATUS_ANSWERED_WAITING_FOR_PRACK){this.status=C.STATUS_EARLY_MEDIA;this.accept();}this.status=C.STATUS_EARLY_MEDIA;//REVISIT
this.mute();}}else if(this.status===C.STATUS_EARLY_MEDIA){request.reply(200);}break;default:Session.prototype.receiveRequest.apply(this,[request]);break;}},onTransportError:function onTransportError(){if(this.status!==C.STATUS_CONFIRMED&&this.status!==C.STATUS_TERMINATED){this.failed(null,SIP.C.causes.CONNECTION_ERROR);}},onRequestTimeout:function onRequestTimeout(){if(this.status===C.STATUS_CONFIRMED){this.terminated(null,SIP.C.causes.REQUEST_TIMEOUT);}else if(this.status!==C.STATUS_TERMINATED){this.failed(null,SIP.C.causes.REQUEST_TIMEOUT);this.terminated(null,SIP.C.causes.REQUEST_TIMEOUT);}}};SIP.InviteServerContext=InviteServerContext;InviteClientContext=function InviteClientContext(ua,target,options){options=Object.create(Session.desugar(options));options.params=Object.create(options.params||Object.prototype);var iceServers,extraHeaders=(options.extraHeaders||[]).slice(),stunServers=options.stunServers||null,turnServers=options.turnServers||null,mediaHandlerFactory=options.mediaHandlerFactory||ua.configuration.mediaHandlerFactory,isMediaSupported=mediaHandlerFactory.isSupported;// Check WebRTC support
if(isMediaSupported&&!isMediaSupported()){throw new SIP.Exceptions.NotSupportedError('Media not supported');}this.RTCConstraints=options.RTCConstraints||{};this.inviteWithoutSdp=options.inviteWithoutSdp||false;// Set anonymous property
this.anonymous=options.anonymous||false;// Custom data to be sent either in INVITE or in ACK
this.renderbody=options.renderbody||null;this.rendertype=options.rendertype||'text/plain';options.params.from_tag=this.from_tag;/* Do not add ;ob in initial forming dialog requests if the registration over
   *  the current connection got a GRUU URI.
   */this.contact=ua.contact.toString({anonymous:this.anonymous,outbound:this.anonymous?!ua.contact.temp_gruu:!ua.contact.pub_gruu});if(this.anonymous){options.params.from_displayName='Anonymous';options.params.from_uri='sip:anonymous@anonymous.invalid';extraHeaders.push('P-Preferred-Identity: '+ua.configuration.uri.toString());extraHeaders.push('Privacy: id');}extraHeaders.push('Contact: '+this.contact);extraHeaders.push('Allow: '+SIP.UA.C.ALLOWED_METHODS.toString());if(this.inviteWithoutSdp&&this.renderbody){extraHeaders.push('Content-Type: '+this.rendertype);extraHeaders.push('Content-Disposition: render;handling=optional');}if(ua.configuration.rel100===SIP.C.supported.REQUIRED){extraHeaders.push('Require: 100rel');}if(ua.configuration.replaces===SIP.C.supported.REQUIRED){extraHeaders.push('Require: replaces');}options.extraHeaders=extraHeaders;SIP.Utils.augment(this,SIP.ClientContext,[ua,SIP.C.INVITE,target,options]);SIP.Utils.augment(this,SIP.Session,[mediaHandlerFactory]);// Check Session Status
if(this.status!==C.STATUS_NULL){throw new SIP.Exceptions.InvalidStateError(this.status);}// Session parameter initialization
this.from_tag=SIP.Utils.newTag();// OutgoingSession specific parameters
this.isCanceled=false;this.received_100=false;this.method=SIP.C.INVITE;this.receiveNonInviteResponse=this.receiveResponse;this.receiveResponse=this.receiveInviteResponse;this.logger=ua.getLogger('sip.inviteclientcontext');if(stunServers){iceServers=SIP.UA.configuration_check.optional['stunServers'](stunServers);if(!iceServers){throw new TypeError('Invalid stunServers: '+stunServers);}else{this.stunServers=iceServers;}}if(turnServers){iceServers=SIP.UA.configuration_check.optional['turnServers'](turnServers);if(!iceServers){throw new TypeError('Invalid turnServers: '+turnServers);}else{this.turnServers=iceServers;}}ua.applicants[this]=this;this.id=this.request.call_id+this.from_tag;//Initialize Media Session
this.mediaHandler=this.mediaHandlerFactory(this,{RTCConstraints:this.RTCConstraints,stunServers:this.stunServers,turnServers:this.turnServers});if(this.mediaHandler&&this.mediaHandler.getRemoteStreams){this.getRemoteStreams=this.mediaHandler.getRemoteStreams.bind(this.mediaHandler);this.getLocalStreams=this.mediaHandler.getLocalStreams.bind(this.mediaHandler);}SIP.Utils.optionsOverride(options,'media','mediaConstraints',true,this.logger,this.ua.configuration.media);this.mediaHint=options.media;this.onInfo=options.onInfo;};InviteClientContext.prototype={invite:function invite(){var self=this;//Save the session into the ua sessions collection.
//Note: placing in constructor breaks call to request.cancel on close... User does not need this anyway
this.ua.sessions[this.id]=this;//Note: due to the way Firefox handles gUM calls, it is recommended to make the gUM call at the app level
// and hand sip.js a stream as the mediaHint
if(this.inviteWithoutSdp){//just send an invite with no sdp...
this.request.body=self.renderbody;this.status=C.STATUS_INVITE_SENT;this.send();}else{this.mediaHandler.getDescription(self.mediaHint).then(function onSuccess(description){if(self.isCanceled||self.status===C.STATUS_TERMINATED){return;}self.hasOffer=true;self.request.body=description;self.status=C.STATUS_INVITE_SENT;self.send();},function onFailure(){if(self.status===C.STATUS_TERMINATED){return;}// TODO...fail out
//self.failed(null, SIP.C.causes.USER_DENIED_MEDIA_ACCESS);
//self.failed(null, SIP.C.causes.WEBRTC_ERROR);
self.failed(null,SIP.C.causes.WEBRTC_ERROR);self.terminated(null,SIP.C.causes.WEBRTC_ERROR);});}return this;},receiveInviteResponse:function receiveInviteResponse(response){var cause,//localMedia,
session=this,id=response.call_id+response.from_tag+response.to_tag,extraHeaders=[],options={};if(this.status===C.STATUS_TERMINATED||response.method!==SIP.C.INVITE){return;}if(this.dialog&&response.status_code>=200&&response.status_code<=299){if(id!==this.dialog.id.toString()){if(!this.createDialog(response,'UAC',true)){return;}this.earlyDialogs[id].sendRequest(this,SIP.C.ACK,{body:SIP.Utils.generateFakeSDP(response.body)});this.earlyDialogs[id].sendRequest(this,SIP.C.BYE);/* NOTE: This fails because the forking proxy does not recognize that an unanswerable
         * leg (due to peerConnection limitations) has been answered first. If your forking
         * proxy does not hang up all unanswered branches on the first branch answered, remove this.
         */if(this.status!==C.STATUS_CONFIRMED){this.failed(response,SIP.C.causes.WEBRTC_ERROR);this.terminated(response,SIP.C.causes.WEBRTC_ERROR);}return;}else if(this.status===C.STATUS_CONFIRMED){this.sendRequest(SIP.C.ACK,{cseq:response.cseq});return;}else if(!this.hasAnswer){// invite w/o sdp is waiting for callback
//an invite with sdp must go on, and hasAnswer is true
return;}}if(this.dialog&&response.status_code<200){/*
        Early media has been set up with at least one other different branch,
        but a final 2xx response hasn't been received
      */if(this.dialog.pracked.indexOf(response.getHeader('rseq'))!==-1||this.dialog.pracked[this.dialog.pracked.length-1]>=response.getHeader('rseq')&&this.dialog.pracked.length>0){return;}if(!this.earlyDialogs[id]&&!this.createDialog(response,'UAC',true)){return;}if(this.earlyDialogs[id].pracked.indexOf(response.getHeader('rseq'))!==-1||this.earlyDialogs[id].pracked[this.earlyDialogs[id].pracked.length-1]>=response.getHeader('rseq')&&this.earlyDialogs[id].pracked.length>0){return;}extraHeaders.push('RAck: '+response.getHeader('rseq')+' '+response.getHeader('cseq'));this.earlyDialogs[id].pracked.push(response.getHeader('rseq'));this.earlyDialogs[id].sendRequest(this,SIP.C.PRACK,{extraHeaders:extraHeaders,body:SIP.Utils.generateFakeSDP(response.body)});return;}// Proceed to cancellation if the user requested.
if(this.isCanceled){if(response.status_code>=100&&response.status_code<200){this.request.cancel(this.cancelReason,extraHeaders);this.canceled(null);}else if(response.status_code>=200&&response.status_code<299){this.acceptAndTerminate(response);this.emit('bye',this.request);}else if(response.status_code>=300){cause=SIP.C.REASON_PHRASE[response.status_code]||SIP.C.causes.CANCELED;this.rejected(response,cause);this.failed(response,cause);this.terminated(response,cause);}return;}switch(true){case /^100$/.test(response.status_code):this.received_100=true;this.emit('progress',response);break;case /^1[0-9]{2}$/.test(response.status_code):// Do nothing with 1xx responses without To tag.
if(!response.to_tag){this.logger.warn('1xx response received without to tag');break;}// Create Early Dialog if 1XX comes with contact
if(response.hasHeader('contact')){// An error on dialog creation will fire 'failed' event
if(!this.createDialog(response,'UAC',true)){break;}}this.status=C.STATUS_1XX_RECEIVED;if(response.hasHeader('require')&&response.getHeader('require').indexOf('100rel')!==-1){// Do nothing if this.dialog is already confirmed
if(this.dialog||!this.earlyDialogs[id]){break;}if(this.earlyDialogs[id].pracked.indexOf(response.getHeader('rseq'))!==-1||this.earlyDialogs[id].pracked[this.earlyDialogs[id].pracked.length-1]>=response.getHeader('rseq')&&this.earlyDialogs[id].pracked.length>0){return;}if(!this.mediaHandler.hasDescription(response)){extraHeaders.push('RAck: '+response.getHeader('rseq')+' '+response.getHeader('cseq'));this.earlyDialogs[id].pracked.push(response.getHeader('rseq'));this.earlyDialogs[id].sendRequest(this,SIP.C.PRACK,{extraHeaders:extraHeaders});this.emit('progress',response);}else if(this.hasOffer){if(!this.createDialog(response,'UAC')){break;}this.hasAnswer=true;this.dialog.pracked.push(response.getHeader('rseq'));this.mediaHandler.setDescription(response).then(function onSuccess(){extraHeaders.push('RAck: '+response.getHeader('rseq')+' '+response.getHeader('cseq'));session.sendRequest(SIP.C.PRACK,{extraHeaders:extraHeaders,receiveResponse:function receiveResponse(){}});session.status=C.STATUS_EARLY_MEDIA;session.mute();session.emit('progress',response);/*
                if (session.status === C.STATUS_EARLY_MEDIA) {
                  localMedia = session.mediaHandler.localMedia;
                  if (localMedia.getAudioTracks().length > 0) {
                    localMedia.getAudioTracks()[0].enabled = false;
                  }
                  if (localMedia.getVideoTracks().length > 0) {
                    localMedia.getVideoTracks()[0].enabled = false;
                  }
                }*/},function onFailure(e){session.logger.warn(e);session.acceptAndTerminate(response,488,'Not Acceptable Here');session.failed(response,SIP.C.causes.BAD_MEDIA_DESCRIPTION);});}else{var earlyDialog=this.earlyDialogs[id];var earlyMedia=earlyDialog.mediaHandler;earlyDialog.pracked.push(response.getHeader('rseq'));earlyMedia.setDescription(response).then(earlyMedia.getDescription.bind(earlyMedia,session.mediaHint)).then(function onSuccess(description){extraHeaders.push('RAck: '+response.getHeader('rseq')+' '+response.getHeader('cseq'));earlyDialog.sendRequest(session,SIP.C.PRACK,{extraHeaders:extraHeaders,body:description});session.status=C.STATUS_EARLY_MEDIA;session.emit('progress',response);}).catch(function onFailure(e){if(e instanceof SIP.Exceptions.GetDescriptionError){earlyDialog.pracked.push(response.getHeader('rseq'));if(session.status===C.STATUS_TERMINATED){return;}// TODO - fail out on error
// session.failed(gum error);
session.failed(null,SIP.C.causes.WEBRTC_ERROR);session.terminated(null,SIP.C.causes.WEBRTC_ERROR);}else{earlyDialog.pracked.splice(earlyDialog.pracked.indexOf(response.getHeader('rseq')),1);// Could not set remote description
session.logger.warn('invalid description');session.logger.warn(e);}});}}else{this.emit('progress',response);}break;case /^2[0-9]{2}$/.test(response.status_code):var cseq=this.request.cseq+' '+this.request.method;if(cseq!==response.getHeader('cseq')){break;}if(this.status===C.STATUS_EARLY_MEDIA&&this.dialog){this.status=C.STATUS_CONFIRMED;this.unmute();/*localMedia = this.mediaHandler.localMedia;
          if (localMedia.getAudioTracks().length > 0) {
            localMedia.getAudioTracks()[0].enabled = true;
          }
          if (localMedia.getVideoTracks().length > 0) {
            localMedia.getVideoTracks()[0].enabled = true;
          }*/options={};if(this.renderbody){extraHeaders.push('Content-Type: '+this.rendertype);options.extraHeaders=extraHeaders;options.body=this.renderbody;}options.cseq=response.cseq;this.sendRequest(SIP.C.ACK,options);this.accepted(response);break;}// Do nothing if this.dialog is already confirmed
if(this.dialog){break;}// This is an invite without sdp
if(!this.hasOffer){if(this.earlyDialogs[id]&&this.earlyDialogs[id].mediaHandler.localMedia){//REVISIT
this.hasOffer=true;this.hasAnswer=true;this.mediaHandler=this.earlyDialogs[id].mediaHandler;if(!this.createDialog(response,'UAC')){break;}this.status=C.STATUS_CONFIRMED;this.sendRequest(SIP.C.ACK,{cseq:response.cseq});this.unmute();/*
            localMedia = session.mediaHandler.localMedia;
            if (localMedia.getAudioTracks().length > 0) {
              localMedia.getAudioTracks()[0].enabled = true;
            }
            if (localMedia.getVideoTracks().length > 0) {
              localMedia.getVideoTracks()[0].enabled = true;
            }*/this.accepted(response);}else{if(!this.mediaHandler.hasDescription(response)){this.acceptAndTerminate(response,400,'Missing session description');this.failed(response,SIP.C.causes.BAD_MEDIA_DESCRIPTION);break;}if(!this.createDialog(response,'UAC')){break;}this.hasOffer=true;this.mediaHandler.setDescription(response).then(this.mediaHandler.getDescription.bind(this.mediaHandler,this.mediaHint)).then(function onSuccess(description){//var localMedia;
if(session.isCanceled||session.status===C.STATUS_TERMINATED){return;}session.status=C.STATUS_CONFIRMED;session.hasAnswer=true;session.unmute();/*localMedia = session.mediaHandler.localMedia;
              if (localMedia.getAudioTracks().length > 0) {
                localMedia.getAudioTracks()[0].enabled = true;
              }
              if (localMedia.getVideoTracks().length > 0) {
                localMedia.getVideoTracks()[0].enabled = true;
              }*/session.sendRequest(SIP.C.ACK,{body:description,cseq:response.cseq});session.accepted(response);}).catch(function onFailure(e){if(e instanceof SIP.Exceptions.GetDescriptionError){// TODO do something here
session.logger.warn("there was a problem");}else{session.logger.warn('invalid description');session.logger.warn(e);response.reply(488);}});}}else if(this.hasAnswer){if(this.renderbody){extraHeaders.push('Content-Type: '+session.rendertype);options.extraHeaders=extraHeaders;options.body=this.renderbody;}this.sendRequest(SIP.C.ACK,options);}else{if(!this.mediaHandler.hasDescription(response)){this.acceptAndTerminate(response,400,'Missing session description');this.failed(response,SIP.C.causes.BAD_MEDIA_DESCRIPTION);break;}if(!this.createDialog(response,'UAC')){break;}this.hasAnswer=true;this.mediaHandler.setDescription(response).then(function onSuccess(){var options={};//,localMedia;
session.status=C.STATUS_CONFIRMED;session.unmute();/*localMedia = session.mediaHandler.localMedia;
              if (localMedia.getAudioTracks().length > 0) {
                localMedia.getAudioTracks()[0].enabled = true;
              }
              if (localMedia.getVideoTracks().length > 0) {
                localMedia.getVideoTracks()[0].enabled = true;
              }*/if(session.renderbody){extraHeaders.push('Content-Type: '+session.rendertype);options.extraHeaders=extraHeaders;options.body=session.renderbody;}options.cseq=response.cseq;session.sendRequest(SIP.C.ACK,options);session.accepted(response);},function onFailure(e){session.logger.warn(e);session.acceptAndTerminate(response,488,'Not Acceptable Here');session.failed(response,SIP.C.causes.BAD_MEDIA_DESCRIPTION);});}break;default:cause=SIP.Utils.sipErrorCause(response.status_code);this.rejected(response,cause);this.failed(response,cause);this.terminated(response,cause);}},cancel:function cancel(options){options=options||{};options.extraHeaders=(options.extraHeaders||[]).slice();// Check Session Status
if(this.status===C.STATUS_TERMINATED||this.status===C.STATUS_CONFIRMED){throw new SIP.Exceptions.InvalidStateError(this.status);}this.logger.log('canceling RTCSession');var cancel_reason=SIP.Utils.getCancelReason(options.status_code,options.reason_phrase);// Check Session Status
if(this.status===C.STATUS_NULL||this.status===C.STATUS_INVITE_SENT&&!this.received_100){this.isCanceled=true;this.cancelReason=cancel_reason;}else if(this.status===C.STATUS_INVITE_SENT||this.status===C.STATUS_1XX_RECEIVED||this.status===C.STATUS_EARLY_MEDIA){this.request.cancel(cancel_reason,options.extraHeaders);}return this.canceled();},terminate:function terminate(options){if(this.status===C.STATUS_TERMINATED){return this;}if(this.status===C.STATUS_WAITING_FOR_ACK||this.status===C.STATUS_CONFIRMED){this.bye(options);}else{this.cancel(options);}return this;},receiveRequest:function receiveRequest(request){// ICC RECEIVE REQUEST
// Reject CANCELs
if(request.method===SIP.C.CANCEL){// TODO; make this a switch when it gets added
}if(request.method===SIP.C.ACK&&this.status===C.STATUS_WAITING_FOR_ACK){SIP.Timers.clearTimeout(this.timers.ackTimer);SIP.Timers.clearTimeout(this.timers.invite2xxTimer);this.status=C.STATUS_CONFIRMED;this.unmute();this.accepted();}return Session.prototype.receiveRequest.apply(this,[request]);},onTransportError:function onTransportError(){if(this.status!==C.STATUS_CONFIRMED&&this.status!==C.STATUS_TERMINATED){this.failed(null,SIP.C.causes.CONNECTION_ERROR);}},onRequestTimeout:function onRequestTimeout(){if(this.status===C.STATUS_CONFIRMED){this.terminated(null,SIP.C.causes.REQUEST_TIMEOUT);}else if(this.status!==C.STATUS_TERMINATED){this.failed(null,SIP.C.causes.REQUEST_TIMEOUT);this.terminated(null,SIP.C.causes.REQUEST_TIMEOUT);}}};SIP.InviteClientContext=InviteClientContext;};},{"./RFC4028":88,"./Session/DTMF":96}],96:[function(require,module,exports){"use strict";/**
 * @fileoverview DTMF
 *//**
 * @class DTMF
 * @param {SIP.Session} session
 */module.exports=function(SIP){var _DTMF,C={MIN_DURATION:70,MAX_DURATION:6000,DEFAULT_DURATION:100,MIN_INTER_TONE_GAP:50,DEFAULT_INTER_TONE_GAP:500};_DTMF=function DTMF(session,tone,options){var duration,interToneGap;if(tone===undefined){throw new TypeError('Not enough arguments');}this.logger=session.ua.getLogger('sip.invitecontext.dtmf',session.id);this.owner=session;this.direction=null;options=options||{};duration=options.duration||null;interToneGap=options.interToneGap||null;// Check tone type
if(typeof tone==='string'){tone=tone.toUpperCase();}else if(typeof tone==='number'){tone=tone.toString();}else{throw new TypeError('Invalid tone: '+tone);}// Check tone value
if(!tone.match(/^[0-9A-D#*]$/)){throw new TypeError('Invalid tone: '+tone);}else{this.tone=tone;}// Check duration
if(duration&&!SIP.Utils.isDecimal(duration)){throw new TypeError('Invalid tone duration: '+duration);}else if(!duration){duration=_DTMF.C.DEFAULT_DURATION;}else if(duration<_DTMF.C.MIN_DURATION){this.logger.warn('"duration" value is lower than the minimum allowed, setting it to '+_DTMF.C.MIN_DURATION+' milliseconds');duration=_DTMF.C.MIN_DURATION;}else if(duration>_DTMF.C.MAX_DURATION){this.logger.warn('"duration" value is greater than the maximum allowed, setting it to '+_DTMF.C.MAX_DURATION+' milliseconds');duration=_DTMF.C.MAX_DURATION;}else{duration=Math.abs(duration);}this.duration=duration;// Check interToneGap
if(interToneGap&&!SIP.Utils.isDecimal(interToneGap)){throw new TypeError('Invalid interToneGap: '+interToneGap);}else if(!interToneGap){interToneGap=_DTMF.C.DEFAULT_INTER_TONE_GAP;}else if(interToneGap<_DTMF.C.MIN_INTER_TONE_GAP){this.logger.warn('"interToneGap" value is lower than the minimum allowed, setting it to '+_DTMF.C.MIN_INTER_TONE_GAP+' milliseconds');interToneGap=_DTMF.C.MIN_INTER_TONE_GAP;}else{interToneGap=Math.abs(interToneGap);}this.interToneGap=interToneGap;};_DTMF.prototype=Object.create(SIP.EventEmitter.prototype);_DTMF.prototype.send=function(options){var extraHeaders,body={};this.direction='outgoing';// Check RTCSession Status
if(this.owner.status!==SIP.Session.C.STATUS_CONFIRMED&&this.owner.status!==SIP.Session.C.STATUS_WAITING_FOR_ACK){throw new SIP.Exceptions.InvalidStateError(this.owner.status);}// Get DTMF options
options=options||{};extraHeaders=options.extraHeaders?options.extraHeaders.slice():[];body.contentType='application/dtmf-relay';body.body="Signal= "+this.tone+"\r\n";body.body+="Duration= "+this.duration;this.request=this.owner.dialog.sendRequest(this,SIP.C.INFO,{extraHeaders:extraHeaders,body:body});this.owner.emit('dtmf',this.request,this);};/**
 * @private
 */_DTMF.prototype.receiveResponse=function(response){var cause;switch(true){case /^1[0-9]{2}$/.test(response.status_code):// Ignore provisional responses.
break;case /^2[0-9]{2}$/.test(response.status_code):this.emit('succeeded',{originator:'remote',response:response});break;default:cause=SIP.Utils.sipErrorCause(response.status_code);this.emit('failed',response,cause);break;}};/**
 * @private
 */_DTMF.prototype.onRequestTimeout=function(){this.emit('failed',null,SIP.C.causes.REQUEST_TIMEOUT);this.owner.onRequestTimeout();};/**
 * @private
 */_DTMF.prototype.onTransportError=function(){this.emit('failed',null,SIP.C.causes.CONNECTION_ERROR);this.owner.onTransportError();};/**
 * @private
 */_DTMF.prototype.onDialogError=function(response){this.emit('failed',response,SIP.C.causes.DIALOG_ERROR);this.owner.onDialogError(response);};/**
 * @private
 */_DTMF.prototype.init_incoming=function(request){this.direction='incoming';this.request=request;request.reply(200);if(!this.tone||!this.duration){this.logger.warn('invalid INFO DTMF received, discarded');}else{this.owner.emit('dtmf',request,this);}};_DTMF.C=C;return _DTMF;};},{}],97:[function(require,module,exports){"use strict";/**
 * @fileoverview SIP Subscriber (SIP-Specific Event Notifications RFC6665)
 *//**
 * @augments SIP
 * @class Class creating a SIP Subscription.
 */module.exports=function(SIP){SIP.Subscription=function(ua,target,event,options){options=Object.create(options||Object.prototype);this.extraHeaders=options.extraHeaders=(options.extraHeaders||[]).slice();this.id=null;this.state='init';if(!event){throw new TypeError('Event necessary to create a subscription.');}else{//TODO: check for valid events here probably make a list in SIP.C; or leave it up to app to check?
//The check may need to/should probably occur on the other side,
this.event=event;}if(typeof options.expires!=='number'){ua.logger.warn('expires must be a number. Using default of 3600.');this.expires=3600;}else{this.expires=options.expires;}options.extraHeaders.push('Event: '+this.event);options.extraHeaders.push('Expires: '+this.expires);if(options.body){this.body=options.body;}this.contact=ua.contact.toString();options.extraHeaders.push('Contact: '+this.contact);options.extraHeaders.push('Allow: '+SIP.UA.C.ALLOWED_METHODS.toString());SIP.Utils.augment(this,SIP.ClientContext,[ua,SIP.C.SUBSCRIBE,target,options]);this.logger=ua.getLogger('sip.subscription');this.dialog=null;this.timers={N:null,sub_duration:null};this.errorCodes=[404,405,410,416,480,481,482,483,484,485,489,501,604];};SIP.Subscription.prototype={subscribe:function subscribe(){var sub=this;//these states point to an existing subscription, no subscribe is necessary
if(this.state==='active'){this.refresh();return this;}else if(this.state==='notify_wait'){return this;}SIP.Timers.clearTimeout(this.timers.sub_duration);SIP.Timers.clearTimeout(this.timers.N);this.timers.N=SIP.Timers.setTimeout(sub.timer_fire.bind(sub),SIP.Timers.TIMER_N);this.send();this.state='notify_wait';return this;},refresh:function refresh(){if(this.state==='terminated'||this.state==='pending'||this.state==='notify_wait'){return;}this.dialog.sendRequest(this,SIP.C.SUBSCRIBE,{extraHeaders:this.extraHeaders,body:this.body});},receiveResponse:function receiveResponse(response){var expires,sub=this,cause=SIP.Utils.getReasonPhrase(response.status_code);if(this.state==='notify_wait'&&response.status_code>=300||this.state!=='notify_wait'&&this.errorCodes.indexOf(response.status_code)!==-1){this.failed(response,null);}else if(/^2[0-9]{2}$/.test(response.status_code)){expires=response.getHeader('Expires');SIP.Timers.clearTimeout(this.timers.N);if(this.createConfirmedDialog(response,'UAC')){this.id=this.dialog.id.toString();this.ua.subscriptions[this.id]=this;this.emit('accepted',response,cause);// UPDATE ROUTE SET TO BE BACKWARDS COMPATIBLE?
}if(expires&&expires<=this.expires){// Preserve new expires value for subsequent requests
this.expires=expires;this.timers.sub_duration=SIP.Timers.setTimeout(sub.refresh.bind(sub),expires*900);}else{if(!expires){this.logger.warn('Expires header missing in a 200-class response to SUBSCRIBE');this.failed(response,SIP.C.EXPIRES_HEADER_MISSING);}else{this.logger.warn('Expires header in a 200-class response to SUBSCRIBE with a higher value than the one in the request');this.failed(response,SIP.C.INVALID_EXPIRES_HEADER);}}}//Used to just ignore provisional responses; now ignores everything except errorCodes and 2xx
},unsubscribe:function unsubscribe(){var extraHeaders=[],sub=this;this.state='terminated';extraHeaders.push('Event: '+this.event);extraHeaders.push('Expires: 0');extraHeaders.push('Contact: '+this.contact);extraHeaders.push('Allow: '+SIP.UA.C.ALLOWED_METHODS.toString());//makes sure expires isn't set, and other typical resubscribe behavior
this.receiveResponse=function(){};this.dialog.sendRequest(this,this.method,{extraHeaders:extraHeaders,body:this.body});SIP.Timers.clearTimeout(this.timers.sub_duration);SIP.Timers.clearTimeout(this.timers.N);this.timers.N=SIP.Timers.setTimeout(sub.timer_fire.bind(sub),SIP.Timers.TIMER_N);},/**
  * @private
  */timer_fire:function timer_fire(){if(this.state==='terminated'){this.terminateDialog();SIP.Timers.clearTimeout(this.timers.N);SIP.Timers.clearTimeout(this.timers.sub_duration);delete this.ua.subscriptions[this.id];}else if(this.state==='pending'||this.state==='notify_wait'){this.close();}else{this.refresh();}},/**
  * @private
  */close:function close(){if(this.state!=='notify_wait'&&this.state!=='terminated'){this.unsubscribe();}},/**
  * @private
  */createConfirmedDialog:function createConfirmedDialog(message,type){var dialog;this.terminateDialog();dialog=new SIP.Dialog(this,message,type);if(!dialog.error){this.dialog=dialog;return true;}// Dialog not created due to an error
else{return false;}},/**
  * @private
  */terminateDialog:function terminateDialog(){if(this.dialog){delete this.ua.subscriptions[this.id];this.dialog.terminate();delete this.dialog;}},/**
  * @private
  */receiveRequest:function receiveRequest(request){var sub_state,sub=this;function setExpiresTimeout(){if(sub_state.expires){SIP.Timers.clearTimeout(sub.timers.sub_duration);sub_state.expires=Math.min(sub.expires,Math.max(sub_state.expires,0));sub.timers.sub_duration=SIP.Timers.setTimeout(sub.refresh.bind(sub),sub_state.expires*900);}}if(!this.matchEvent(request)){//checks event and subscription_state headers
request.reply(489);return;}sub_state=request.parseHeader('Subscription-State');request.reply(200,SIP.C.REASON_200);SIP.Timers.clearTimeout(this.timers.N);this.emit('notify',{request:request});// if we've set state to terminated, no further processing should take place
// and we are only interested in cleaning up after the appropriate NOTIFY
if(this.state==='terminated'){if(sub_state.state==='terminated'){this.terminateDialog();SIP.Timers.clearTimeout(this.timers.N);SIP.Timers.clearTimeout(this.timers.sub_duration);delete this.ua.subscriptions[this.id];}return;}switch(sub_state.state){case'active':this.state='active';setExpiresTimeout();break;case'pending':if(this.state==='notify_wait'){setExpiresTimeout();}this.state='pending';break;case'terminated':SIP.Timers.clearTimeout(this.timers.sub_duration);if(sub_state.reason){this.logger.log('terminating subscription with reason '+sub_state.reason);switch(sub_state.reason){case'deactivated':case'timeout':this.subscribe();return;case'probation':case'giveup':if(sub_state.params&&sub_state.params['retry-after']){this.timers.sub_duration=SIP.Timers.setTimeout(sub.subscribe.bind(sub),sub_state.params['retry-after']);}else{this.subscribe();}return;case'rejected':case'noresource':case'invariant':break;}}this.close();break;}},failed:function failed(response,cause){this.close();this.emit('failed',response,cause);return this;},onDialogError:function onDialogError(response){this.failed(response,SIP.C.causes.DIALOG_ERROR);},/**
  * @private
  */matchEvent:function matchEvent(request){var event;// Check mandatory header Event
if(!request.hasHeader('Event')){this.logger.warn('missing Event header');return false;}// Check mandatory header Subscription-State
if(!request.hasHeader('Subscription-State')){this.logger.warn('missing Subscription-State header');return false;}// Check whether the event in NOTIFY matches the event in SUBSCRIBE
event=request.parseHeader('event').event;if(this.event!==event){this.logger.warn('event match failed');request.reply(481,'Event Match Failed');return false;}else{return true;}}};};},{}],98:[function(require,module,exports){"use strict";/**
 * @fileoverview SIP TIMERS
 *//**
 * @augments SIP
 */var T1=500,T2=4000,T4=5000;module.exports=function(timers){var Timers={T1:T1,T2:T2,T4:T4,TIMER_B:64*T1,TIMER_D:0*T1,TIMER_F:64*T1,TIMER_H:64*T1,TIMER_I:0*T1,TIMER_J:0*T1,TIMER_K:0*T4,TIMER_L:64*T1,TIMER_M:64*T1,TIMER_N:64*T1,PROVISIONAL_RESPONSE_INTERVAL:60000// See RFC 3261 Section 13.3.1.1
};['setTimeout','clearTimeout','setInterval','clearInterval'].forEach(function(name){// can't just use timers[name].bind(timers) since it bypasses jasmine's
// clock-mocking
Timers[name]=function(){return timers[name].apply(timers,arguments);};});return Timers;};},{}],99:[function(require,module,exports){"use strict";/**
 * @fileoverview SIP Transactions
 *//**
 * SIP Transactions module.
 * @augments SIP
 */module.exports=function(SIP){var C={// Transaction states
STATUS_TRYING:1,STATUS_PROCEEDING:2,STATUS_CALLING:3,STATUS_ACCEPTED:4,STATUS_COMPLETED:5,STATUS_TERMINATED:6,STATUS_CONFIRMED:7,// Transaction types
NON_INVITE_CLIENT:'nict',NON_INVITE_SERVER:'nist',INVITE_CLIENT:'ict',INVITE_SERVER:'ist'};function buildViaHeader(request_sender,transport,id){var via;via='SIP/2.0/'+(request_sender.ua.configuration.hackViaTcp?'TCP':transport.server.scheme);via+=' '+request_sender.ua.configuration.viaHost+';branch='+id;if(request_sender.ua.configuration.forceRport){via+=';rport';}return via;}/**
* @augments SIP.Transactions
* @class Non Invite Client Transaction
* @param {SIP.RequestSender} request_sender
* @param {SIP.OutgoingRequest} request
* @param {SIP.Transport} transport
*/var NonInviteClientTransaction=function NonInviteClientTransaction(request_sender,request,transport){var via;this.type=C.NON_INVITE_CLIENT;this.transport=transport;this.id='z9hG4bK'+Math.floor(Math.random()*10000000);this.request_sender=request_sender;this.request=request;this.logger=request_sender.ua.getLogger('sip.transaction.nict',this.id);via=buildViaHeader(request_sender,transport,this.id);this.request.setHeader('via',via);this.request_sender.ua.newTransaction(this);};NonInviteClientTransaction.prototype=Object.create(SIP.EventEmitter.prototype);NonInviteClientTransaction.prototype.stateChanged=function(state){this.state=state;this.emit('stateChanged');};NonInviteClientTransaction.prototype.send=function(){var tr=this;this.stateChanged(C.STATUS_TRYING);this.F=SIP.Timers.setTimeout(tr.timer_F.bind(tr),SIP.Timers.TIMER_F);if(!this.transport.send(this.request)){this.onTransportError();}};NonInviteClientTransaction.prototype.onTransportError=function(){this.logger.log('transport error occurred, deleting non-INVITE client transaction '+this.id);SIP.Timers.clearTimeout(this.F);SIP.Timers.clearTimeout(this.K);this.stateChanged(C.STATUS_TERMINATED);this.request_sender.ua.destroyTransaction(this);this.request_sender.onTransportError();};NonInviteClientTransaction.prototype.timer_F=function(){this.logger.log('Timer F expired for non-INVITE client transaction '+this.id);this.stateChanged(C.STATUS_TERMINATED);this.request_sender.ua.destroyTransaction(this);this.request_sender.onRequestTimeout();};NonInviteClientTransaction.prototype.timer_K=function(){this.stateChanged(C.STATUS_TERMINATED);this.request_sender.ua.destroyTransaction(this);};NonInviteClientTransaction.prototype.receiveResponse=function(response){var tr=this,status_code=response.status_code;if(status_code<200){switch(this.state){case C.STATUS_TRYING:case C.STATUS_PROCEEDING:this.stateChanged(C.STATUS_PROCEEDING);this.request_sender.receiveResponse(response);break;}}else{switch(this.state){case C.STATUS_TRYING:case C.STATUS_PROCEEDING:this.stateChanged(C.STATUS_COMPLETED);SIP.Timers.clearTimeout(this.F);if(status_code===408){this.request_sender.onRequestTimeout();}else{this.request_sender.receiveResponse(response);}this.K=SIP.Timers.setTimeout(tr.timer_K.bind(tr),SIP.Timers.TIMER_K);break;case C.STATUS_COMPLETED:break;}}};/**
* @augments SIP.Transactions
* @class Invite Client Transaction
* @param {SIP.RequestSender} request_sender
* @param {SIP.OutgoingRequest} request
* @param {SIP.Transport} transport
*/var InviteClientTransaction=function InviteClientTransaction(request_sender,request,transport){var via,tr=this;this.type=C.INVITE_CLIENT;this.transport=transport;this.id='z9hG4bK'+Math.floor(Math.random()*10000000);this.request_sender=request_sender;this.request=request;this.logger=request_sender.ua.getLogger('sip.transaction.ict',this.id);via=buildViaHeader(request_sender,transport,this.id);this.request.setHeader('via',via);this.request_sender.ua.newTransaction(this);// Add the cancel property to the request.
//Will be called from the request instance, not the transaction itself.
this.request.cancel=function(reason,extraHeaders){extraHeaders=(extraHeaders||[]).slice();var length=extraHeaders.length;var extraHeadersString=null;for(var idx=0;idx<length;idx++){extraHeadersString=(extraHeadersString||'')+extraHeaders[idx].trim()+'\r\n';}tr.cancel_request(tr,reason,extraHeadersString);};};InviteClientTransaction.prototype=Object.create(SIP.EventEmitter.prototype);InviteClientTransaction.prototype.stateChanged=function(state){this.state=state;this.emit('stateChanged');};InviteClientTransaction.prototype.send=function(){var tr=this;this.stateChanged(C.STATUS_CALLING);this.B=SIP.Timers.setTimeout(tr.timer_B.bind(tr),SIP.Timers.TIMER_B);if(!this.transport.send(this.request)){this.onTransportError();}};InviteClientTransaction.prototype.onTransportError=function(){this.logger.log('transport error occurred, deleting INVITE client transaction '+this.id);SIP.Timers.clearTimeout(this.B);SIP.Timers.clearTimeout(this.D);SIP.Timers.clearTimeout(this.M);this.stateChanged(C.STATUS_TERMINATED);this.request_sender.ua.destroyTransaction(this);if(this.state!==C.STATUS_ACCEPTED){this.request_sender.onTransportError();}};// RFC 6026 7.2
InviteClientTransaction.prototype.timer_M=function(){this.logger.log('Timer M expired for INVITE client transaction '+this.id);if(this.state===C.STATUS_ACCEPTED){SIP.Timers.clearTimeout(this.B);this.stateChanged(C.STATUS_TERMINATED);this.request_sender.ua.destroyTransaction(this);}};// RFC 3261 17.1.1
InviteClientTransaction.prototype.timer_B=function(){this.logger.log('Timer B expired for INVITE client transaction '+this.id);if(this.state===C.STATUS_CALLING){this.stateChanged(C.STATUS_TERMINATED);this.request_sender.ua.destroyTransaction(this);this.request_sender.onRequestTimeout();}};InviteClientTransaction.prototype.timer_D=function(){this.logger.log('Timer D expired for INVITE client transaction '+this.id);SIP.Timers.clearTimeout(this.B);this.stateChanged(C.STATUS_TERMINATED);this.request_sender.ua.destroyTransaction(this);};InviteClientTransaction.prototype.sendACK=function(response){var tr=this;this.ack='ACK '+this.request.ruri+' SIP/2.0\r\n';this.ack+='Via: '+this.request.headers['Via'].toString()+'\r\n';if(this.request.headers['Route']){this.ack+='Route: '+this.request.headers['Route'].toString()+'\r\n';}this.ack+='To: '+response.getHeader('to')+'\r\n';this.ack+='From: '+this.request.headers['From'].toString()+'\r\n';this.ack+='Call-ID: '+this.request.headers['Call-ID'].toString()+'\r\n';this.ack+='Content-Length: 0\r\n';this.ack+='CSeq: '+this.request.headers['CSeq'].toString().split(' ')[0];this.ack+=' ACK\r\n\r\n';this.D=SIP.Timers.setTimeout(tr.timer_D.bind(tr),SIP.Timers.TIMER_D);this.transport.send(this.ack);};InviteClientTransaction.prototype.cancel_request=function(tr,reason,extraHeaders){var request=tr.request;this.cancel=SIP.C.CANCEL+' '+request.ruri+' SIP/2.0\r\n';this.cancel+='Via: '+request.headers['Via'].toString()+'\r\n';if(this.request.headers['Route']){this.cancel+='Route: '+request.headers['Route'].toString()+'\r\n';}this.cancel+='To: '+request.headers['To'].toString()+'\r\n';this.cancel+='From: '+request.headers['From'].toString()+'\r\n';this.cancel+='Call-ID: '+request.headers['Call-ID'].toString()+'\r\n';this.cancel+='CSeq: '+request.headers['CSeq'].toString().split(' ')[0]+' CANCEL\r\n';if(reason){this.cancel+='Reason: '+reason+'\r\n';}if(extraHeaders){this.cancel+=extraHeaders;}this.cancel+='Content-Length: 0\r\n\r\n';// Send only if a provisional response (>100) has been received.
if(this.state===C.STATUS_PROCEEDING){this.transport.send(this.cancel);}};InviteClientTransaction.prototype.receiveResponse=function(response){var tr=this,status_code=response.status_code;if(status_code>=100&&status_code<=199){switch(this.state){case C.STATUS_CALLING:this.stateChanged(C.STATUS_PROCEEDING);this.request_sender.receiveResponse(response);if(this.cancel){this.transport.send(this.cancel);}break;case C.STATUS_PROCEEDING:this.request_sender.receiveResponse(response);break;}}else if(status_code>=200&&status_code<=299){switch(this.state){case C.STATUS_CALLING:case C.STATUS_PROCEEDING:this.stateChanged(C.STATUS_ACCEPTED);this.M=SIP.Timers.setTimeout(tr.timer_M.bind(tr),SIP.Timers.TIMER_M);this.request_sender.receiveResponse(response);break;case C.STATUS_ACCEPTED:this.request_sender.receiveResponse(response);break;}}else if(status_code>=300&&status_code<=699){switch(this.state){case C.STATUS_CALLING:case C.STATUS_PROCEEDING:this.stateChanged(C.STATUS_COMPLETED);this.sendACK(response);this.request_sender.receiveResponse(response);break;case C.STATUS_COMPLETED:this.sendACK(response);break;}}};/**
 * @augments SIP.Transactions
 * @class ACK Client Transaction
 * @param {SIP.RequestSender} request_sender
 * @param {SIP.OutgoingRequest} request
 * @param {SIP.Transport} transport
 */var AckClientTransaction=function AckClientTransaction(request_sender,request,transport){var via;this.transport=transport;this.id='z9hG4bK'+Math.floor(Math.random()*10000000);this.request_sender=request_sender;this.request=request;this.logger=request_sender.ua.getLogger('sip.transaction.nict',this.id);via=buildViaHeader(request_sender,transport,this.id);this.request.setHeader('via',via);};AckClientTransaction.prototype=Object.create(SIP.EventEmitter.prototype);AckClientTransaction.prototype.send=function(){if(!this.transport.send(this.request)){this.onTransportError();}};AckClientTransaction.prototype.onTransportError=function(){this.logger.log('transport error occurred, for an ACK client transaction '+this.id);this.request_sender.onTransportError();};/**
* @augments SIP.Transactions
* @class Non Invite Server Transaction
* @param {SIP.IncomingRequest} request
* @param {SIP.UA} ua
*/var NonInviteServerTransaction=function NonInviteServerTransaction(request,ua){this.type=C.NON_INVITE_SERVER;this.id=request.via_branch;this.request=request;this.transport=request.transport;this.ua=ua;this.last_response='';request.server_transaction=this;this.logger=ua.getLogger('sip.transaction.nist',this.id);this.state=C.STATUS_TRYING;ua.newTransaction(this);};NonInviteServerTransaction.prototype=Object.create(SIP.EventEmitter.prototype);NonInviteServerTransaction.prototype.stateChanged=function(state){this.state=state;this.emit('stateChanged');};NonInviteServerTransaction.prototype.timer_J=function(){this.logger.log('Timer J expired for non-INVITE server transaction '+this.id);this.stateChanged(C.STATUS_TERMINATED);this.ua.destroyTransaction(this);};NonInviteServerTransaction.prototype.onTransportError=function(){if(!this.transportError){this.transportError=true;this.logger.log('transport error occurred, deleting non-INVITE server transaction '+this.id);SIP.Timers.clearTimeout(this.J);this.stateChanged(C.STATUS_TERMINATED);this.ua.destroyTransaction(this);}};NonInviteServerTransaction.prototype.receiveResponse=function(status_code,response){var tr=this;var deferred=SIP.Utils.defer();if(status_code===100){/* RFC 4320 4.1
     * 'A SIP element MUST NOT
     * send any provisional response with a
     * Status-Code other than 100 to a non-INVITE request.'
     */switch(this.state){case C.STATUS_TRYING:this.stateChanged(C.STATUS_PROCEEDING);if(!this.transport.send(response)){this.onTransportError();}break;case C.STATUS_PROCEEDING:this.last_response=response;if(!this.transport.send(response)){this.onTransportError();deferred.reject();}else{deferred.resolve();}break;}}else if(status_code>=200&&status_code<=699){switch(this.state){case C.STATUS_TRYING:case C.STATUS_PROCEEDING:this.stateChanged(C.STATUS_COMPLETED);this.last_response=response;this.J=SIP.Timers.setTimeout(tr.timer_J.bind(tr),SIP.Timers.TIMER_J);if(!this.transport.send(response)){this.onTransportError();deferred.reject();}else{deferred.resolve();}break;case C.STATUS_COMPLETED:break;}}return deferred.promise;};/**
* @augments SIP.Transactions
* @class Invite Server Transaction
* @param {SIP.IncomingRequest} request
* @param {SIP.UA} ua
*/var InviteServerTransaction=function InviteServerTransaction(request,ua){this.type=C.INVITE_SERVER;this.id=request.via_branch;this.request=request;this.transport=request.transport;this.ua=ua;this.last_response='';request.server_transaction=this;this.logger=ua.getLogger('sip.transaction.ist',this.id);this.state=C.STATUS_PROCEEDING;ua.newTransaction(this);this.resendProvisionalTimer=null;request.reply(100);};InviteServerTransaction.prototype=Object.create(SIP.EventEmitter.prototype);InviteServerTransaction.prototype.stateChanged=function(state){this.state=state;this.emit('stateChanged');};InviteServerTransaction.prototype.timer_H=function(){this.logger.log('Timer H expired for INVITE server transaction '+this.id);if(this.state===C.STATUS_COMPLETED){this.logger.warn('transactions','ACK for INVITE server transaction was never received, call will be terminated');}this.stateChanged(C.STATUS_TERMINATED);this.ua.destroyTransaction(this);};InviteServerTransaction.prototype.timer_I=function(){this.stateChanged(C.STATUS_TERMINATED);this.ua.destroyTransaction(this);};// RFC 6026 7.1
InviteServerTransaction.prototype.timer_L=function(){this.logger.log('Timer L expired for INVITE server transaction '+this.id);if(this.state===C.STATUS_ACCEPTED){this.stateChanged(C.STATUS_TERMINATED);this.ua.destroyTransaction(this);}};InviteServerTransaction.prototype.onTransportError=function(){if(!this.transportError){this.transportError=true;this.logger.log('transport error occurred, deleting INVITE server transaction '+this.id);if(this.resendProvisionalTimer!==null){SIP.Timers.clearInterval(this.resendProvisionalTimer);this.resendProvisionalTimer=null;}SIP.Timers.clearTimeout(this.L);SIP.Timers.clearTimeout(this.H);SIP.Timers.clearTimeout(this.I);this.stateChanged(C.STATUS_TERMINATED);this.ua.destroyTransaction(this);}};InviteServerTransaction.prototype.resend_provisional=function(){if(!this.transport.send(this.last_response)){this.onTransportError();}};// INVITE Server Transaction RFC 3261 17.2.1
InviteServerTransaction.prototype.receiveResponse=function(status_code,response){var tr=this;var deferred=SIP.Utils.defer();if(status_code>=100&&status_code<=199){switch(this.state){case C.STATUS_PROCEEDING:if(!this.transport.send(response)){this.onTransportError();}this.last_response=response;break;}}if(status_code>100&&status_code<=199&&this.state===C.STATUS_PROCEEDING){// Trigger the resendProvisionalTimer only for the first non 100 provisional response.
if(this.resendProvisionalTimer===null){this.resendProvisionalTimer=SIP.Timers.setInterval(tr.resend_provisional.bind(tr),SIP.Timers.PROVISIONAL_RESPONSE_INTERVAL);}}else if(status_code>=200&&status_code<=299){switch(this.state){case C.STATUS_PROCEEDING:this.stateChanged(C.STATUS_ACCEPTED);this.last_response=response;this.L=SIP.Timers.setTimeout(tr.timer_L.bind(tr),SIP.Timers.TIMER_L);if(this.resendProvisionalTimer!==null){SIP.Timers.clearInterval(this.resendProvisionalTimer);this.resendProvisionalTimer=null;}/* falls through */case C.STATUS_ACCEPTED:// Note that this point will be reached for proceeding tr.state also.
if(!this.transport.send(response)){this.onTransportError();deferred.reject();}else{deferred.resolve();}break;}}else if(status_code>=300&&status_code<=699){switch(this.state){case C.STATUS_PROCEEDING:if(this.resendProvisionalTimer!==null){SIP.Timers.clearInterval(this.resendProvisionalTimer);this.resendProvisionalTimer=null;}if(!this.transport.send(response)){this.onTransportError();deferred.reject();}else{this.stateChanged(C.STATUS_COMPLETED);this.H=SIP.Timers.setTimeout(tr.timer_H.bind(tr),SIP.Timers.TIMER_H);deferred.resolve();}break;}}return deferred.promise;};/**
 * @function
 * @param {SIP.UA} ua
 * @param {SIP.IncomingRequest} request
 *
 * @return {boolean}
 * INVITE:
 *  _true_ if retransmission
 *  _false_ new request
 *
 * ACK:
 *  _true_  ACK to non2xx response
 *  _false_ ACK must be passed to TU (accepted state)
 *          ACK to 2xx response
 *
 * CANCEL:
 *  _true_  no matching invite transaction
 *  _false_ matching invite transaction and no final response sent
 *
 * OTHER:
 *  _true_  retransmission
 *  _false_ new request
 */var checkTransaction=function checkTransaction(ua,request){var tr;switch(request.method){case SIP.C.INVITE:tr=ua.transactions.ist[request.via_branch];if(tr){switch(tr.state){case C.STATUS_PROCEEDING:tr.transport.send(tr.last_response);break;// RFC 6026 7.1 Invite retransmission
//received while in C.STATUS_ACCEPTED state. Absorb it.
case C.STATUS_ACCEPTED:break;}return true;}break;case SIP.C.ACK:tr=ua.transactions.ist[request.via_branch];// RFC 6026 7.1
if(tr){if(tr.state===C.STATUS_ACCEPTED){return false;}else if(tr.state===C.STATUS_COMPLETED){tr.stateChanged(C.STATUS_CONFIRMED);tr.I=SIP.Timers.setTimeout(tr.timer_I.bind(tr),SIP.Timers.TIMER_I);return true;}}// ACK to 2XX Response.
else{return false;}break;case SIP.C.CANCEL:tr=ua.transactions.ist[request.via_branch];if(tr){request.reply_sl(200);if(tr.state===C.STATUS_PROCEEDING){return false;}else{return true;}}else{request.reply_sl(481);return true;}break;default:// Non-INVITE Server Transaction RFC 3261 17.2.2
tr=ua.transactions.nist[request.via_branch];if(tr){switch(tr.state){case C.STATUS_TRYING:break;case C.STATUS_PROCEEDING:case C.STATUS_COMPLETED:tr.transport.send(tr.last_response);break;}return true;}break;}};SIP.Transactions={C:C,checkTransaction:checkTransaction,NonInviteClientTransaction:NonInviteClientTransaction,InviteClientTransaction:InviteClientTransaction,AckClientTransaction:AckClientTransaction,NonInviteServerTransaction:NonInviteServerTransaction,InviteServerTransaction:InviteServerTransaction};};},{}],100:[function(require,module,exports){"use strict";/**
 * @fileoverview Transport
 *//**
 * @augments SIP
 * @class Transport
 * @param {SIP.UA} ua
 * @param {Object} server ws_server Object
 */module.exports=function(SIP,WebSocket){var Transport,C={// Transport status codes
STATUS_READY:0,STATUS_DISCONNECTED:1,STATUS_ERROR:2};/**
 * Compute an amount of time in seconds to wait before sending another
 * keep-alive.
 * @returns {Number}
 */function computeKeepAliveTimeout(upperBound){var lowerBound=upperBound*0.8;return 1000*(Math.random()*(upperBound-lowerBound)+lowerBound);}Transport=function Transport(ua,server){this.logger=ua.getLogger('sip.transport');this.ua=ua;this.ws=null;this.server=server;this.reconnection_attempts=0;this.closed=false;this.connected=false;this.reconnectTimer=null;this.lastTransportError={};this.keepAliveInterval=ua.configuration.keepAliveInterval;this.keepAliveTimeout=null;this.keepAliveTimer=null;this.ua.transport=this;// Connect
this.connect();};Transport.prototype={/**
   * Send a message.
   * @param {SIP.OutgoingRequest|String} msg
   * @returns {Boolean}
   */send:function send(msg){var message=msg.toString();if(this.ws&&this.ws.readyState===WebSocket.OPEN){if(this.ua.configuration.traceSip===true){this.logger.log('sending WebSocket message:\n\n'+message+'\n');}this.ws.send(message);return true;}else{this.logger.warn('unable to send message, WebSocket is not open');return false;}},/**
   * Send a keep-alive (a double-CRLF sequence).
   * @private
   * @returns {Boolean}
   */sendKeepAlive:function sendKeepAlive(){if(this.keepAliveTimeout){return;}this.keepAliveTimeout=SIP.Timers.setTimeout(function(){this.ua.emit('keepAliveTimeout');}.bind(this),10000);return this.send('\r\n\r\n');},/**
   * Start sending keep-alives.
   * @private
   */startSendingKeepAlives:function startSendingKeepAlives(){if(this.keepAliveInterval&&!this.keepAliveTimer){this.keepAliveTimer=SIP.Timers.setTimeout(function(){this.sendKeepAlive();this.keepAliveTimer=null;this.startSendingKeepAlives();}.bind(this),computeKeepAliveTimeout(this.keepAliveInterval));}},/**
   * Stop sending keep-alives.
   * @private
   */stopSendingKeepAlives:function stopSendingKeepAlives(){SIP.Timers.clearTimeout(this.keepAliveTimer);SIP.Timers.clearTimeout(this.keepAliveTimeout);this.keepAliveTimer=null;this.keepAliveTimeout=null;},/**
  * Disconnect socket.
  */disconnect:function disconnect(){if(this.ws){// Clear reconnectTimer
SIP.Timers.clearTimeout(this.reconnectTimer);this.stopSendingKeepAlives();this.closed=true;this.logger.log('closing WebSocket '+this.server.ws_uri);this.ws.close();}if(this.reconnectTimer!==null){SIP.Timers.clearTimeout(this.reconnectTimer);this.reconnectTimer=null;this.ua.emit('disconnected',{transport:this,code:this.lastTransportError.code,reason:this.lastTransportError.reason});}},/**
  * Connect socket.
  */connect:function connect(){var transport=this;if(this.ws&&(this.ws.readyState===WebSocket.OPEN||this.ws.readyState===WebSocket.CONNECTING)){this.logger.log('WebSocket '+this.server.ws_uri+' is already connected');return false;}if(this.ws){this.ws.close();}this.logger.log('connecting to WebSocket '+this.server.ws_uri);this.ua.onTransportConnecting(this,this.reconnection_attempts===0?1:this.reconnection_attempts);try{this.ws=new WebSocket(this.server.ws_uri,'sip');}catch(e){this.logger.warn('error connecting to WebSocket '+this.server.ws_uri+': '+e);}this.ws.binaryType='arraybuffer';this.ws.onopen=function(){transport.onOpen();};this.ws.onclose=function(e){transport.onClose(e);};this.ws.onmessage=function(e){transport.onMessage(e);};this.ws.onerror=function(e){transport.onError(e);};},// Transport Event Handlers
/**
  * @event
  * @param {event} e
  */onOpen:function onOpen(){this.connected=true;this.logger.log('WebSocket '+this.server.ws_uri+' connected');// Clear reconnectTimer since we are not disconnected
if(this.reconnectTimer!==null){SIP.Timers.clearTimeout(this.reconnectTimer);this.reconnectTimer=null;}// Reset reconnection_attempts
this.reconnection_attempts=0;// Disable closed
this.closed=false;// Trigger onTransportConnected callback
this.ua.onTransportConnected(this);// Start sending keep-alives
this.startSendingKeepAlives();},/**
  * @event
  * @param {event} e
  */onClose:function onClose(e){var connected_before=this.connected;this.lastTransportError.code=e.code;this.lastTransportError.reason=e.reason;this.stopSendingKeepAlives();if(this.reconnection_attempts>0){this.logger.log('Reconnection attempt '+this.reconnection_attempts+' failed (code: '+e.code+(e.reason?'| reason: '+e.reason:'')+')');this.reconnect();}else{this.connected=false;this.logger.log('WebSocket disconnected (code: '+e.code+(e.reason?'| reason: '+e.reason:'')+')');if(e.wasClean===false){this.logger.warn('WebSocket abrupt disconnection');}// Transport was connected
if(connected_before===true){this.ua.onTransportClosed(this);// Check whether the user requested to close.
if(!this.closed){this.reconnect();}else{this.ua.emit('disconnected',{transport:this,code:this.lastTransportError.code,reason:this.lastTransportError.reason});}}else{// This is the first connection attempt
//Network error
this.ua.onTransportError(this);}}},/**
  * @event
  * @param {event} e
  */onMessage:function onMessage(e){var message,transaction,data=e.data;// CRLF Keep Alive response from server. Ignore it.
if(data==='\r\n'){SIP.Timers.clearTimeout(this.keepAliveTimeout);this.keepAliveTimeout=null;if(this.ua.configuration.traceSip===true){this.logger.log('received WebSocket message with CRLF Keep Alive response');}return;}// WebSocket binary message.
else if(typeof data!=='string'){try{data=String.fromCharCode.apply(null,new Uint8Array(data));}catch(evt){this.logger.warn('received WebSocket binary message failed to be converted into string, message discarded');return;}if(this.ua.configuration.traceSip===true){this.logger.log('received WebSocket binary message:\n\n'+data+'\n');}}// WebSocket text message.
else{if(this.ua.configuration.traceSip===true){this.logger.log('received WebSocket text message:\n\n'+data+'\n');}}message=SIP.Parser.parseMessage(data,this.ua);if(!message){return;}if(this.ua.status===SIP.UA.C.STATUS_USER_CLOSED&&message instanceof SIP.IncomingRequest){return;}// Do some sanity check
if(SIP.sanityCheck(message,this.ua,this)){if(message instanceof SIP.IncomingRequest){message.transport=this;this.ua.receiveRequest(message);}else if(message instanceof SIP.IncomingResponse){/* Unike stated in 18.1.2, if a response does not match
        * any transaction, it is discarded here and no passed to the core
        * in order to be discarded there.
        */switch(message.method){case SIP.C.INVITE:transaction=this.ua.transactions.ict[message.via_branch];if(transaction){transaction.receiveResponse(message);}break;case SIP.C.ACK:// Just in case ;-)
break;default:transaction=this.ua.transactions.nict[message.via_branch];if(transaction){transaction.receiveResponse(message);}break;}}}},/**
  * @event
  * @param {event} e
  */onError:function onError(e){this.logger.warn('WebSocket connection error: '+JSON.stringify(e));},/**
  * Reconnection attempt logic.
  * @private
  */reconnect:function reconnect(){var transport=this;this.reconnection_attempts+=1;if(this.reconnection_attempts>this.ua.configuration.wsServerMaxReconnection){this.logger.warn('maximum reconnection attempts for WebSocket '+this.server.ws_uri);this.ua.onTransportError(this);}else if(this.reconnection_attempts===1){this.logger.log('Connection to WebSocket '+this.server.ws_uri+' severed, attempting first reconnect');transport.connect();}else{this.logger.log('trying to reconnect to WebSocket '+this.server.ws_uri+' (reconnection attempt '+this.reconnection_attempts+')');this.reconnectTimer=SIP.Timers.setTimeout(function(){transport.connect();transport.reconnectTimer=null;},this.ua.configuration.wsServerReconnectionTimeout*1000);}}};Transport.C=C;return Transport;};},{}],101:[function(require,module,exports){(function(global){"use strict";/**
 * @augments SIP
 * @class Class creating a SIP User Agent.
 * @param {function returning SIP.MediaHandler} [configuration.mediaHandlerFactory]
 *        A function will be invoked by each of the UA's Sessions to build the MediaHandler for that Session.
 *        If no (or a falsy) value is provided, each Session will use a default (WebRTC) MediaHandler.
 *
 * @param {Object} [configuration.media] gets passed to SIP.MediaHandler.getDescription as mediaHint
 */module.exports=function(SIP,environment){var UA,C={// UA status codes
STATUS_INIT:0,STATUS_STARTING:1,STATUS_READY:2,STATUS_USER_CLOSED:3,STATUS_NOT_READY:4,// UA error codes
CONFIGURATION_ERROR:1,NETWORK_ERROR:2,ALLOWED_METHODS:['ACK','CANCEL','INVITE','MESSAGE','BYE','OPTIONS','INFO','NOTIFY','REFER'],ACCEPTED_BODY_TYPES:['application/sdp','application/dtmf-relay'],MAX_FORWARDS:70,TAG_LENGTH:10};UA=function UA(configuration){var self=this;// Helper function for forwarding events
function selfEmit(type){//registrationFailed handler is invoked with two arguments. Allow event handlers to be invoked with a variable no. of arguments
return self.emit.bind(self,type);}// Set Accepted Body Types
C.ACCEPTED_BODY_TYPES=C.ACCEPTED_BODY_TYPES.toString();this.log=new SIP.LoggerFactory();this.logger=this.getLogger('sip.ua');this.cache={credentials:{}};this.configuration={};this.dialogs={};//User actions outside any session/dialog (MESSAGE)
this.applicants={};this.data={};this.sessions={};this.subscriptions={};this.transport=null;this.contact=null;this.status=C.STATUS_INIT;this.error=null;this.transactions={nist:{},nict:{},ist:{},ict:{}};this.transportRecoverAttempts=0;this.transportRecoveryTimer=null;Object.defineProperties(this,{transactionsCount:{get:function get(){var type,transactions=['nist','nict','ist','ict'],count=0;for(type in transactions){count+=Object.keys(this.transactions[transactions[type]]).length;}return count;}},nictTransactionsCount:{get:function get(){return Object.keys(this.transactions['nict']).length;}},nistTransactionsCount:{get:function get(){return Object.keys(this.transactions['nist']).length;}},ictTransactionsCount:{get:function get(){return Object.keys(this.transactions['ict']).length;}},istTransactionsCount:{get:function get(){return Object.keys(this.transactions['ist']).length;}}});/**
   * Load configuration
   *
   * @throws {SIP.Exceptions.ConfigurationError}
   * @throws {TypeError}
   */if(configuration===undefined){configuration={};}else if(typeof configuration==='string'||configuration instanceof String){configuration={uri:configuration};}// Apply log configuration if present
if(configuration.log){if(configuration.log.hasOwnProperty('builtinEnabled')){this.log.builtinEnabled=configuration.log.builtinEnabled;}if(configuration.log.hasOwnProperty('level')){this.log.level=configuration.log.level;}if(configuration.log.hasOwnProperty('connector')){this.log.connector=configuration.log.connector;}}try{this.loadConfig(configuration);}catch(e){this.status=C.STATUS_NOT_READY;this.error=C.CONFIGURATION_ERROR;throw e;}// Initialize registerContext
this.registerContext=new SIP.RegisterContext(this);this.registerContext.on('failed',selfEmit('registrationFailed'));this.registerContext.on('registered',selfEmit('registered'));this.registerContext.on('unregistered',selfEmit('unregistered'));if(this.configuration.autostart){this.start();}if(typeof environment.addEventListener==='function'){// Google Chrome Packaged Apps don't allow 'unload' listeners:
// unload is not available in packaged apps
if(!(global.chrome&&global.chrome.app&&global.chrome.app.runtime)){environment.addEventListener('unload',this.stop.bind(this));}}};UA.prototype=Object.create(SIP.EventEmitter.prototype);//=================
//  High Level API
//=================
UA.prototype.register=function(options){this.configuration.register=true;this.registerContext.register(options);return this;};/**
 * Unregister.
 *
 * @param {Boolean} [all] unregister all user bindings.
 *
 */UA.prototype.unregister=function(options){this.configuration.register=false;var context=this.registerContext;this.afterConnected(context.unregister.bind(context,options));return this;};UA.prototype.isRegistered=function(){return this.registerContext.registered;};/**
 * Connection state.
 * @param {Boolean}
 */UA.prototype.isConnected=function(){return this.transport?this.transport.connected:false;};UA.prototype.afterConnected=function afterConnected(callback){if(this.isConnected()){callback();}else{this.once('connected',callback);}};/**
 * Make an outgoing call.
 *
 * @param {String} target
 * @param {Object} views
 * @param {Object} [options.media] gets passed to SIP.MediaHandler.getDescription as mediaHint
 *
 * @throws {TypeError}
 *
 */UA.prototype.invite=function(target,options){var context=new SIP.InviteClientContext(this,target,options);this.afterConnected(context.invite.bind(context));return context;};UA.prototype.subscribe=function(target,event,options){var sub=new SIP.Subscription(this,target,event,options);this.afterConnected(sub.subscribe.bind(sub));return sub;};/**
 * Send a message.
 *
 * @param {String} target
 * @param {String} body
 * @param {Object} [options]
 *
 * @throws {TypeError}
 *
 */UA.prototype.message=function(target,body,options){if(body===undefined){throw new TypeError('Not enough arguments');}// There is no Message module, so it is okay that the UA handles defaults here.
options=Object.create(options||Object.prototype);options.contentType||(options.contentType='text/plain');options.body=body;return this.request(SIP.C.MESSAGE,target,options);};UA.prototype.request=function(method,target,options){var req=new SIP.ClientContext(this,method,target,options);this.afterConnected(req.send.bind(req));return req;};/**
 * Gracefully close.
 *
 */UA.prototype.stop=function(){var session,subscription,applicant,ua=this;function transactionsListener(){if(ua.nistTransactionsCount===0&&ua.nictTransactionsCount===0){ua.removeListener('transactionDestroyed',transactionsListener);ua.transport.disconnect();}}this.logger.log('user requested closure...');if(this.status===C.STATUS_USER_CLOSED){this.logger.warn('UA already closed');return this;}// Clear transportRecoveryTimer
SIP.Timers.clearTimeout(this.transportRecoveryTimer);// Close registerContext
this.logger.log('closing registerContext');this.registerContext.close();// Run  _terminate_ on every Session
for(session in this.sessions){this.logger.log('closing session '+session);this.sessions[session].terminate();}//Run _close_ on every Subscription
for(subscription in this.subscriptions){this.logger.log('unsubscribing from subscription '+subscription);this.subscriptions[subscription].close();}// Run  _close_ on every applicant
for(applicant in this.applicants){this.applicants[applicant].close();}this.status=C.STATUS_USER_CLOSED;/*
   * If the remaining transactions are all INVITE transactions, there is no need to
   * wait anymore because every session has already been closed by this method.
   * - locally originated sessions where terminated (CANCEL or BYE)
   * - remotely originated sessions where rejected (4XX) or terminated (BYE)
   * Remaining INVITE transactions belong tho sessions that where answered. This are in
   * 'accepted' state due to timers 'L' and 'M' defined in [RFC 6026]
   */if(this.nistTransactionsCount===0&&this.nictTransactionsCount===0){this.transport.disconnect();}else{this.on('transactionDestroyed',transactionsListener);}return this;};/**
 * Connect to the WS server if status = STATUS_INIT.
 * Resume UA after being closed.
 *
 */UA.prototype.start=function(){var server;this.logger.log('user requested startup...');if(this.status===C.STATUS_INIT){server=this.getNextWsServer();this.status=C.STATUS_STARTING;new SIP.Transport(this,server);}else if(this.status===C.STATUS_USER_CLOSED){this.logger.log('resuming');this.status=C.STATUS_READY;this.transport.connect();}else if(this.status===C.STATUS_STARTING){this.logger.log('UA is in STARTING status, not opening new connection');}else if(this.status===C.STATUS_READY){this.logger.log('UA is in READY status, not resuming');}else{this.logger.error('Connection is down. Auto-Recovery system is trying to connect');}return this;};/**
 * Normalize a string into a valid SIP request URI
 *
 * @param {String} target
 *
 * @returns {SIP.URI|undefined}
 */UA.prototype.normalizeTarget=function(target){return SIP.Utils.normalizeTarget(target,this.configuration.hostportParams);};//===============================
//  Private (For internal use)
//===============================
UA.prototype.saveCredentials=function(credentials){this.cache.credentials[credentials.realm]=this.cache.credentials[credentials.realm]||{};this.cache.credentials[credentials.realm][credentials.uri]=credentials;return this;};UA.prototype.getCredentials=function(request){var realm,credentials;realm=request.ruri.host;if(this.cache.credentials[realm]&&this.cache.credentials[realm][request.ruri]){credentials=this.cache.credentials[realm][request.ruri];credentials.method=request.method;}return credentials;};UA.prototype.getLogger=function(category,label){return this.log.getLogger(category,label);};//==============================
// Event Handlers
//==============================
/**
 * Transport Close event
 * @private
 * @event
 * @param {SIP.Transport} transport.
 */UA.prototype.onTransportClosed=function(transport){// Run _onTransportError_ callback on every client transaction using _transport_
var type,idx,length,client_transactions=['nict','ict','nist','ist'];transport.server.status=SIP.Transport.C.STATUS_DISCONNECTED;this.logger.log('connection state set to '+SIP.Transport.C.STATUS_DISCONNECTED);length=client_transactions.length;for(type=0;type<length;type++){for(idx in this.transactions[client_transactions[type]]){this.transactions[client_transactions[type]][idx].onTransportError();}}// Close sessions if GRUU is not being used
if(!this.contact.pub_gruu){this.closeSessionsOnTransportError();}};/**
 * Unrecoverable transport event.
 * Connection reattempt logic has been done and didn't success.
 * @private
 * @event
 * @param {SIP.Transport} transport.
 */UA.prototype.onTransportError=function(transport){var server;this.logger.log('transport '+transport.server.ws_uri+' failed | connection state set to '+SIP.Transport.C.STATUS_ERROR);// Close sessions.
//Mark this transport as 'down'
transport.server.status=SIP.Transport.C.STATUS_ERROR;this.emit('disconnected',{transport:transport});// try the next transport if the UA isn't closed
if(this.status===C.STATUS_USER_CLOSED){return;}server=this.getNextWsServer();if(server){new SIP.Transport(this,server);}else{this.closeSessionsOnTransportError();if(!this.error||this.error!==C.NETWORK_ERROR){this.status=C.STATUS_NOT_READY;this.error=C.NETWORK_ERROR;}// Transport Recovery process
this.recoverTransport();}};/**
 * Transport connection event.
 * @private
 * @event
 * @param {SIP.Transport} transport.
 */UA.prototype.onTransportConnected=function(transport){this.transport=transport;// Reset transport recovery counter
this.transportRecoverAttempts=0;transport.server.status=SIP.Transport.C.STATUS_READY;this.logger.log('connection state set to '+SIP.Transport.C.STATUS_READY);if(this.status===C.STATUS_USER_CLOSED){return;}this.status=C.STATUS_READY;this.error=null;if(this.configuration.register){this.configuration.authenticationFactory.initialize().then(function(){this.registerContext.onTransportConnected();}.bind(this));}this.emit('connected',{transport:transport});};/**
 * Transport connecting event
 * @private
 * @param {SIP.Transport} transport.
 * #param {Integer} attempts.
 */UA.prototype.onTransportConnecting=function(transport,attempts){this.emit('connecting',{transport:transport,attempts:attempts});};/**
 * new Transaction
 * @private
 * @param {SIP.Transaction} transaction.
 */UA.prototype.newTransaction=function(transaction){this.transactions[transaction.type][transaction.id]=transaction;this.emit('newTransaction',{transaction:transaction});};/**
 * destroy Transaction
 * @private
 * @param {SIP.Transaction} transaction.
 */UA.prototype.destroyTransaction=function(transaction){delete this.transactions[transaction.type][transaction.id];this.emit('transactionDestroyed',{transaction:transaction});};//=========================
// receiveRequest
//=========================
/**
 * Request reception
 * @private
 * @param {SIP.IncomingRequest} request.
 */UA.prototype.receiveRequest=function(request){var dialog,session,message,method=request.method,transaction,replaces,replacedDialog,self=this;function ruriMatches(uri){return uri&&uri.user===request.ruri.user;}// Check that request URI points to us
if(!(ruriMatches(this.configuration.uri)||ruriMatches(this.contact.uri)||ruriMatches(this.contact.pub_gruu)||ruriMatches(this.contact.temp_gruu))){this.logger.warn('Request-URI does not point to us');if(request.method!==SIP.C.ACK){request.reply_sl(404);}return;}// Check request URI scheme
if(request.ruri.scheme===SIP.C.SIPS){request.reply_sl(416);return;}// Check transaction
if(SIP.Transactions.checkTransaction(this,request)){return;}/* RFC3261 12.2.2
   * Requests that do not change in any way the state of a dialog may be
   * received within a dialog (for example, an OPTIONS request).
   * They are processed as if they had been received outside the dialog.
   */if(method===SIP.C.OPTIONS){new SIP.Transactions.NonInviteServerTransaction(request,this);request.reply(200,null,['Allow: '+SIP.UA.C.ALLOWED_METHODS.toString(),'Accept: '+C.ACCEPTED_BODY_TYPES]);}else if(method===SIP.C.MESSAGE){message=new SIP.ServerContext(this,request);message.body=request.body;message.content_type=request.getHeader('Content-Type')||'text/plain';request.reply(200,null);this.emit('message',message);}else if(method!==SIP.C.INVITE&&method!==SIP.C.ACK){// Let those methods pass through to normal processing for now.
transaction=new SIP.ServerContext(this,request);}// Initial Request
if(!request.to_tag){switch(method){case SIP.C.INVITE:replaces=this.configuration.replaces!==SIP.C.supported.UNSUPPORTED&&request.parseHeader('replaces');if(replaces){replacedDialog=this.dialogs[replaces.call_id+replaces.replaces_to_tag+replaces.replaces_from_tag];if(!replacedDialog){//Replaced header without a matching dialog, reject
request.reply_sl(481,null);return;}else if(replacedDialog.owner.status===SIP.Session.C.STATUS_TERMINATED){request.reply_sl(603,null);return;}else if(replacedDialog.state===SIP.Dialog.C.STATUS_CONFIRMED&&replaces.early_only){request.reply_sl(486,null);return;}}var isMediaSupported=this.configuration.mediaHandlerFactory.isSupported;if(!isMediaSupported||isMediaSupported()){session=new SIP.InviteServerContext(this,request);session.replacee=replacedDialog&&replacedDialog.owner;session.on('invite',function(){self.emit('invite',this);});}else{this.logger.warn('INVITE received but WebRTC is not supported');request.reply(488);}break;case SIP.C.BYE:// Out of dialog BYE received
request.reply(481);break;case SIP.C.CANCEL:session=this.findSession(request);if(session){session.receiveRequest(request);}else{this.logger.warn('received CANCEL request for a non existent session');}break;case SIP.C.ACK:/* Absorb it.
         * ACK request without a corresponding Invite Transaction
         * and without To tag.
         */break;case SIP.C.NOTIFY:if(this.configuration.allowLegacyNotifications&&this.listeners('notify').length>0){request.reply(200,null);self.emit('notify',{request:request});}else{request.reply(481,'Subscription does not exist');}break;default:request.reply(405);break;}}// In-dialog request
else{dialog=this.findDialog(request);if(dialog){if(method===SIP.C.INVITE){new SIP.Transactions.InviteServerTransaction(request,this);}dialog.receiveRequest(request);}else if(method===SIP.C.NOTIFY){session=this.findSession(request);if(session){session.receiveRequest(request);}else{this.logger.warn('received NOTIFY request for a non existent session');request.reply(481,'Subscription does not exist');}}/* RFC3261 12.2.2
     * Request with to tag, but no matching dialog found.
     * Exception: ACK for an Invite request for which a dialog has not
     * been created.
     */else{if(method!==SIP.C.ACK){request.reply(481);}}}};//=================
// Utils
//=================
/**
 * Get the session to which the request belongs to, if any.
 * @private
 * @param {SIP.IncomingRequest} request.
 * @returns {SIP.OutgoingSession|SIP.IncomingSession|null}
 */UA.prototype.findSession=function(request){return this.sessions[request.call_id+request.from_tag]||this.sessions[request.call_id+request.to_tag]||null;};/**
 * Get the dialog to which the request belongs to, if any.
 * @private
 * @param {SIP.IncomingRequest}
 * @returns {SIP.Dialog|null}
 */UA.prototype.findDialog=function(request){return this.dialogs[request.call_id+request.from_tag+request.to_tag]||this.dialogs[request.call_id+request.to_tag+request.from_tag]||null;};/**
 * Retrieve the next server to which connect.
 * @private
 * @returns {Object} ws_server
 */UA.prototype.getNextWsServer=function(){// Order servers by weight
var idx,length,ws_server,candidates=[];length=this.configuration.wsServers.length;for(idx=0;idx<length;idx++){ws_server=this.configuration.wsServers[idx];if(ws_server.status===SIP.Transport.C.STATUS_ERROR){continue;}else if(candidates.length===0){candidates.push(ws_server);}else if(ws_server.weight>candidates[0].weight){candidates=[ws_server];}else if(ws_server.weight===candidates[0].weight){candidates.push(ws_server);}}idx=Math.floor(Math.random()*candidates.length);return candidates[idx];};/**
 * Close all sessions on transport error.
 * @private
 */UA.prototype.closeSessionsOnTransportError=function(){var idx;// Run _transportError_ for every Session
for(idx in this.sessions){this.sessions[idx].onTransportError();}// Call registerContext _onTransportClosed_
this.registerContext.onTransportClosed();};UA.prototype.recoverTransport=function(ua){var idx,length,k,nextRetry,count,server;ua=ua||this;count=ua.transportRecoverAttempts;length=ua.configuration.wsServers.length;for(idx=0;idx<length;idx++){ua.configuration.wsServers[idx].status=0;}server=ua.getNextWsServer();k=Math.floor(Math.random()*Math.pow(2,count)+1);nextRetry=k*ua.configuration.connectionRecoveryMinInterval;if(nextRetry>ua.configuration.connectionRecoveryMaxInterval){this.logger.log('time for next connection attempt exceeds connectionRecoveryMaxInterval, resetting counter');nextRetry=ua.configuration.connectionRecoveryMinInterval;count=0;}this.logger.log('next connection attempt in '+nextRetry+' seconds');this.transportRecoveryTimer=SIP.Timers.setTimeout(function(){ua.transportRecoverAttempts=count+1;new SIP.Transport(ua,server);},nextRetry*1000);};function checkAuthenticationFactory(authenticationFactory){if(!(authenticationFactory instanceof Function)){return;}if(!authenticationFactory.initialize){authenticationFactory.initialize=function initialize(){return SIP.Utils.Promise.resolve();};}return authenticationFactory;}/**
 * Configuration load.
 * @private
 * returns {Boolean}
 */UA.prototype.loadConfig=function(configuration){// Settings and default values
var parameter,value,checked_value,hostportParams,registrarServer,settings={/* Host address
      * Value to be set in Via sent_by and host part of Contact FQDN
      */viaHost:SIP.Utils.createRandomToken(12)+'.invalid',uri:new SIP.URI('sip','anonymous.'+SIP.Utils.createRandomToken(6),'anonymous.invalid',null,null),wsServers:[{scheme:'WSS',sip_uri:'<sip:edge.sip.onsip.com;transport=ws;lr>',status:0,weight:0,ws_uri:'wss://edge.sip.onsip.com'}],// Password
password:null,// Registration parameters
registerExpires:600,register:true,registrarServer:null,// Transport related parameters
wsServerMaxReconnection:3,wsServerReconnectionTimeout:4,connectionRecoveryMinInterval:2,connectionRecoveryMaxInterval:30,keepAliveInterval:0,extraSupported:[],usePreloadedRoute:false,//string to be inserted into User-Agent request header
userAgentString:SIP.C.USER_AGENT,// Session parameters
iceCheckingTimeout:5000,noAnswerTimeout:60,stunServers:['stun:stun.l.google.com:19302'],turnServers:[],// Logging parameters
traceSip:false,// Hacks
hackViaTcp:false,hackIpInContact:false,hackWssInTransport:false,hackAllowUnregisteredOptionTags:false,hackCleanJitsiSdpImageattr:false,hackStripTcp:false,contactTransport:'ws',forceRport:false,//autostarting
autostart:true,//Reliable Provisional Responses
rel100:SIP.C.supported.UNSUPPORTED,// Replaces header (RFC 3891)
// http://tools.ietf.org/html/rfc3891
replaces:SIP.C.supported.UNSUPPORTED,mediaHandlerFactory:SIP.WebRTC.MediaHandler.defaultFactory,authenticationFactory:checkAuthenticationFactory(function authenticationFactory(ua){return new SIP.DigestAuthentication(ua);}),allowLegacyNotifications:false};// Pre-Configuration
function aliasUnderscored(parameter,logger){var underscored=parameter.replace(/([a-z][A-Z])/g,function(m){return m[0]+'_'+m[1].toLowerCase();});if(parameter===underscored){return;}var hasParameter=configuration.hasOwnProperty(parameter);if(configuration.hasOwnProperty(underscored)){logger.warn(underscored+' is deprecated, please use '+parameter);if(hasParameter){logger.warn(parameter+' overriding '+underscored);}}configuration[parameter]=hasParameter?configuration[parameter]:configuration[underscored];}// Check Mandatory parameters
for(parameter in UA.configuration_check.mandatory){aliasUnderscored(parameter,this.logger);if(!configuration.hasOwnProperty(parameter)){throw new SIP.Exceptions.ConfigurationError(parameter);}else{value=configuration[parameter];checked_value=UA.configuration_check.mandatory[parameter](value);if(checked_value!==undefined){settings[parameter]=checked_value;}else{throw new SIP.Exceptions.ConfigurationError(parameter,value);}}}SIP.Utils.optionsOverride(configuration,'rel100','reliable',true,this.logger,SIP.C.supported.UNSUPPORTED);var emptyArraysAllowed=['stunServers','turnServers'];// Check Optional parameters
for(parameter in UA.configuration_check.optional){aliasUnderscored(parameter,this.logger);if(configuration.hasOwnProperty(parameter)){value=configuration[parameter];// If the parameter value is an empty array, but shouldn't be, apply its default value.
if(value instanceof Array&&value.length===0&&emptyArraysAllowed.indexOf(parameter)<0){continue;}// If the parameter value is null, empty string, or undefined then apply its default value.
if(value===null||value===""||value===undefined){continue;}// If it's a number with NaN value then also apply its default value.
// NOTE: JS does not allow "value === NaN", the following does the work:
else if(typeof value==='number'&&isNaN(value)){continue;}checked_value=UA.configuration_check.optional[parameter](value);if(checked_value!==undefined){settings[parameter]=checked_value;}else{throw new SIP.Exceptions.ConfigurationError(parameter,value);}}}// Sanity Checks
// Connection recovery intervals
if(settings.connectionRecoveryMaxInterval<settings.connectionRecoveryMinInterval){throw new SIP.Exceptions.ConfigurationError('connectionRecoveryMaxInterval',settings.connectionRecoveryMaxInterval);}// Post Configuration Process
// Allow passing 0 number as displayName.
if(settings.displayName===0){settings.displayName='0';}// Instance-id for GRUU
if(!settings.instanceId){settings.instanceId=SIP.Utils.newUUID();}// sipjsId instance parameter. Static random tag of length 5
settings.sipjsId=SIP.Utils.createRandomToken(5);// String containing settings.uri without scheme and user.
hostportParams=settings.uri.clone();hostportParams.user=null;settings.hostportParams=hostportParams.toRaw().replace(/^sip:/i,'');/* Check whether authorizationUser is explicitly defined.
   * Take 'settings.uri.user' value if not.
   */if(!settings.authorizationUser){settings.authorizationUser=settings.uri.user;}/* If no 'registrarServer' is set use the 'uri' value without user portion. */if(!settings.registrarServer){registrarServer=settings.uri.clone();registrarServer.user=null;settings.registrarServer=registrarServer;}// User noAnswerTimeout
settings.noAnswerTimeout=settings.noAnswerTimeout*1000;// Via Host
if(settings.hackIpInContact){if(typeof settings.hackIpInContact==='boolean'){settings.viaHost=SIP.Utils.getRandomTestNetIP();}else if(typeof settings.hackIpInContact==='string'){settings.viaHost=settings.hackIpInContact;}}// Contact transport parameter
if(settings.hackWssInTransport){settings.contactTransport='wss';}this.contact={pub_gruu:null,temp_gruu:null,uri:new SIP.URI('sip',SIP.Utils.createRandomToken(8),settings.viaHost,null,{transport:settings.contactTransport}),toString:function toString(options){options=options||{};var anonymous=options.anonymous||null,outbound=options.outbound||null,contact='<';if(anonymous){contact+=(this.temp_gruu||'sip:anonymous@anonymous.invalid;transport='+settings.contactTransport).toString();}else{contact+=(this.pub_gruu||this.uri).toString();}if(outbound){contact+=';ob';}contact+='>';return contact;}};// media overrides mediaConstraints
SIP.Utils.optionsOverride(settings,'media','mediaConstraints',true,this.logger);// Fill the value of the configuration_skeleton
for(parameter in settings){UA.configuration_skeleton[parameter].value=settings[parameter];}Object.defineProperties(this.configuration,UA.configuration_skeleton);// Clean UA.configuration_skeleton
for(parameter in settings){UA.configuration_skeleton[parameter].value='';}this.logger.log('configuration parameters after validation:');for(parameter in settings){switch(parameter){case'uri':case'registrarServer':case'mediaHandlerFactory':this.logger.log(' '+parameter+': '+settings[parameter]);break;case'password':this.logger.log(' '+parameter+': '+'NOT SHOWN');break;default:this.logger.log(' '+parameter+': '+JSON.stringify(settings[parameter]));}}return;};/**
 * Configuration Object skeleton.
 * @private
 */UA.configuration_skeleton=function(){var idx,parameter,skeleton={},parameters=[// Internal parameters
"sipjsId","hostportParams",// Optional user configurable parameters
"uri","wsServers","authorizationUser","connectionRecoveryMaxInterval","connectionRecoveryMinInterval","keepAliveInterval","extraSupported","displayName","hackViaTcp",// false.
"hackIpInContact",//false
"hackWssInTransport",//false
"hackAllowUnregisteredOptionTags",//false
"hackCleanJitsiSdpImageattr",//false
"hackStripTcp",//false
"contactTransport",// 'ws'
"forceRport",// false
"iceCheckingTimeout","instanceId","noAnswerTimeout",// 30 seconds.
"password","registerExpires",// 600 seconds.
"registrarServer","reliable","rel100","replaces","userAgentString",//SIP.C.USER_AGENT
"autostart","stunServers","traceSip","turnServers","usePreloadedRoute","wsServerMaxReconnection","wsServerReconnectionTimeout","mediaHandlerFactory","media","mediaConstraints","authenticationFactory","allowLegacyNotifications",// Post-configuration generated parameters
"via_core_value","viaHost"];for(idx in parameters){parameter=parameters[idx];skeleton[parameter]={value:'',writable:false,configurable:false};}skeleton['register']={value:'',writable:true,configurable:false};return skeleton;}();/**
 * Configuration checker.
 * @private
 * @return {Boolean}
 */UA.configuration_check={mandatory:{},optional:{uri:function uri(_uri){var parsed;if(!/^sip:/i.test(_uri)){_uri=SIP.C.SIP+':'+_uri;}parsed=SIP.URI.parse(_uri);if(!parsed){return;}else if(!parsed.user){return;}else{return parsed;}},//Note: this function used to call 'this.logger.error' but calling 'this' with anything here is invalid
wsServers:function wsServers(_wsServers){var idx,length,url;/* Allow defining wsServers parameter as:
       *  String: "host"
       *  Array of Strings: ["host1", "host2"]
       *  Array of Objects: [{ws_uri:"host1", weight:1}, {ws_uri:"host2", weight:0}]
       *  Array of Objects and Strings: [{ws_uri:"host1"}, "host2"]
       */if(typeof _wsServers==='string'){_wsServers=[{ws_uri:_wsServers}];}else if(_wsServers instanceof Array){length=_wsServers.length;for(idx=0;idx<length;idx++){if(typeof _wsServers[idx]==='string'){_wsServers[idx]={ws_uri:_wsServers[idx]};}}}else{return;}if(_wsServers.length===0){return false;}length=_wsServers.length;for(idx=0;idx<length;idx++){if(!_wsServers[idx].ws_uri){return;}if(_wsServers[idx].weight&&!Number(_wsServers[idx].weight)){return;}url=SIP.Grammar.parse(_wsServers[idx].ws_uri,'absoluteURI');if(url===-1){return;}else if(['wss','ws','udp'].indexOf(url.scheme)<0){return;}else{_wsServers[idx].sip_uri='<sip:'+url.host+(url.port?':'+url.port:'')+';transport='+url.scheme.replace(/^wss$/i,'ws')+';lr>';if(!_wsServers[idx].weight){_wsServers[idx].weight=0;}_wsServers[idx].status=0;_wsServers[idx].scheme=url.scheme.toUpperCase();}}return _wsServers;},authorizationUser:function authorizationUser(_authorizationUser){if(SIP.Grammar.parse('"'+_authorizationUser+'"','quoted_string')===-1){return;}else{return _authorizationUser;}},connectionRecoveryMaxInterval:function connectionRecoveryMaxInterval(_connectionRecoveryMaxInterval){var value;if(SIP.Utils.isDecimal(_connectionRecoveryMaxInterval)){value=Number(_connectionRecoveryMaxInterval);if(value>0){return value;}}},connectionRecoveryMinInterval:function connectionRecoveryMinInterval(_connectionRecoveryMinInterval){var value;if(SIP.Utils.isDecimal(_connectionRecoveryMinInterval)){value=Number(_connectionRecoveryMinInterval);if(value>0){return value;}}},displayName:function displayName(_displayName){if(SIP.Grammar.parse('"'+_displayName+'"','displayName')===-1){return;}else{return _displayName;}},hackViaTcp:function hackViaTcp(_hackViaTcp){if(typeof _hackViaTcp==='boolean'){return _hackViaTcp;}},hackIpInContact:function hackIpInContact(_hackIpInContact){if(typeof _hackIpInContact==='boolean'){return _hackIpInContact;}else if(typeof _hackIpInContact==='string'&&SIP.Grammar.parse(_hackIpInContact,'host')!==-1){return _hackIpInContact;}},iceCheckingTimeout:function iceCheckingTimeout(_iceCheckingTimeout){if(SIP.Utils.isDecimal(_iceCheckingTimeout)){return Math.max(500,_iceCheckingTimeout);}},hackWssInTransport:function hackWssInTransport(_hackWssInTransport){if(typeof _hackWssInTransport==='boolean'){return _hackWssInTransport;}},hackAllowUnregisteredOptionTags:function hackAllowUnregisteredOptionTags(_hackAllowUnregisteredOptionTags){if(typeof _hackAllowUnregisteredOptionTags==='boolean'){return _hackAllowUnregisteredOptionTags;}},hackCleanJitsiSdpImageattr:function hackCleanJitsiSdpImageattr(_hackCleanJitsiSdpImageattr){if(typeof _hackCleanJitsiSdpImageattr==='boolean'){return _hackCleanJitsiSdpImageattr;}},hackStripTcp:function hackStripTcp(_hackStripTcp){if(typeof _hackStripTcp==='boolean'){return _hackStripTcp;}},contactTransport:function contactTransport(_contactTransport){if(typeof _contactTransport==='string'){return _contactTransport;}},forceRport:function forceRport(_forceRport){if(typeof _forceRport==='boolean'){return _forceRport;}},instanceId:function instanceId(_instanceId){if(typeof _instanceId!=='string'){return;}if(/^uuid:/i.test(_instanceId)){_instanceId=_instanceId.substr(5);}if(SIP.Grammar.parse(_instanceId,'uuid')===-1){return;}else{return _instanceId;}},keepAliveInterval:function keepAliveInterval(_keepAliveInterval){var value;if(SIP.Utils.isDecimal(_keepAliveInterval)){value=Number(_keepAliveInterval);if(value>0){return value;}}},extraSupported:function extraSupported(optionTags){var idx,length;if(!(optionTags instanceof Array)){return;}length=optionTags.length;for(idx=0;idx<length;idx++){if(typeof optionTags[idx]!=='string'){return;}}return optionTags;},noAnswerTimeout:function noAnswerTimeout(_noAnswerTimeout){var value;if(SIP.Utils.isDecimal(_noAnswerTimeout)){value=Number(_noAnswerTimeout);if(value>0){return value;}}},password:function password(_password){return String(_password);},rel100:function rel100(_rel){if(_rel===SIP.C.supported.REQUIRED){return SIP.C.supported.REQUIRED;}else if(_rel===SIP.C.supported.SUPPORTED){return SIP.C.supported.SUPPORTED;}else{return SIP.C.supported.UNSUPPORTED;}},replaces:function replaces(_replaces){if(_replaces===SIP.C.supported.REQUIRED){return SIP.C.supported.REQUIRED;}else if(_replaces===SIP.C.supported.SUPPORTED){return SIP.C.supported.SUPPORTED;}else{return SIP.C.supported.UNSUPPORTED;}},register:function register(_register){if(typeof _register==='boolean'){return _register;}},registerExpires:function registerExpires(_registerExpires){var value;if(SIP.Utils.isDecimal(_registerExpires)){value=Number(_registerExpires);if(value>0){return value;}}},registrarServer:function registrarServer(_registrarServer){var parsed;if(typeof _registrarServer!=='string'){return;}if(!/^sip:/i.test(_registrarServer)){_registrarServer=SIP.C.SIP+':'+_registrarServer;}parsed=SIP.URI.parse(_registrarServer);if(!parsed){return;}else if(parsed.user){return;}else{return parsed;}},stunServers:function stunServers(_stunServers){var idx,length,stun_server;if(typeof _stunServers==='string'){_stunServers=[_stunServers];}else if(!(_stunServers instanceof Array)){return;}length=_stunServers.length;for(idx=0;idx<length;idx++){stun_server=_stunServers[idx];if(!/^stuns?:/.test(stun_server)){stun_server='stun:'+stun_server;}if(SIP.Grammar.parse(stun_server,'stun_URI')===-1){return;}else{_stunServers[idx]=stun_server;}}return _stunServers;},traceSip:function traceSip(_traceSip){if(typeof _traceSip==='boolean'){return _traceSip;}},turnServers:function turnServers(_turnServers){var idx,jdx,length,turn_server,num_turn_server_urls,url;if(_turnServers instanceof Array){// Do nothing
}else{_turnServers=[_turnServers];}length=_turnServers.length;for(idx=0;idx<length;idx++){turn_server=_turnServers[idx];//Backwards compatibility: Allow defining the turn_server url with the 'server' property.
if(turn_server.server){turn_server.urls=[turn_server.server];}if(!turn_server.urls||!turn_server.username||!turn_server.password){return;}if(turn_server.urls instanceof Array){num_turn_server_urls=turn_server.urls.length;}else{turn_server.urls=[turn_server.urls];num_turn_server_urls=1;}for(jdx=0;jdx<num_turn_server_urls;jdx++){url=turn_server.urls[jdx];if(!/^turns?:/.test(url)){url='turn:'+url;}if(SIP.Grammar.parse(url,'turn_URI')===-1){return;}}}return _turnServers;},userAgentString:function userAgentString(_userAgentString){if(typeof _userAgentString==='string'){return _userAgentString;}},usePreloadedRoute:function usePreloadedRoute(_usePreloadedRoute){if(typeof _usePreloadedRoute==='boolean'){return _usePreloadedRoute;}},wsServerMaxReconnection:function wsServerMaxReconnection(_wsServerMaxReconnection){var value;if(SIP.Utils.isDecimal(_wsServerMaxReconnection)){value=Number(_wsServerMaxReconnection);if(value>0){return value;}}},wsServerReconnectionTimeout:function wsServerReconnectionTimeout(_wsServerReconnectionTimeout){var value;if(SIP.Utils.isDecimal(_wsServerReconnectionTimeout)){value=Number(_wsServerReconnectionTimeout);if(value>0){return value;}}},autostart:function autostart(_autostart){if(typeof _autostart==='boolean'){return _autostart;}},mediaHandlerFactory:function mediaHandlerFactory(_mediaHandlerFactory){if(_mediaHandlerFactory instanceof Function){var promisifiedFactory=function promisifiedFactory(){var mediaHandler=_mediaHandlerFactory.apply(this,arguments);function patchMethod(methodName){var method=mediaHandler[methodName];if(method.length>1){var callbacksFirst=methodName==='getDescription';mediaHandler[methodName]=SIP.Utils.promisify(mediaHandler,methodName,callbacksFirst);}}patchMethod('getDescription');patchMethod('setDescription');return mediaHandler;};promisifiedFactory.isSupported=_mediaHandlerFactory.isSupported;return promisifiedFactory;}},authenticationFactory:checkAuthenticationFactory,allowLegacyNotifications:function allowLegacyNotifications(_allowLegacyNotifications){if(typeof _allowLegacyNotifications==='boolean'){return _allowLegacyNotifications;}}}};UA.C=C;SIP.UA=UA;};}).call(this,typeof global!=="undefined"?global:typeof self!=="undefined"?self:typeof window!=="undefined"?window:{});},{}],102:[function(require,module,exports){"use strict";/**
 * @fileoverview SIP URI
 *//**
 * @augments SIP
 * @class Class creating a SIP URI.
 *
 * @param {String} [scheme]
 * @param {String} [user]
 * @param {String} host
 * @param {String} [port]
 * @param {Object} [parameters]
 * @param {Object} [headers]
 *
 */module.exports=function(SIP){var URI;URI=function URI(scheme,user,host,port,parameters,headers){var param,header,raw,normal;// Checks
if(!host){throw new TypeError('missing or invalid "host" parameter');}// Initialize parameters
scheme=scheme||SIP.C.SIP;this.parameters={};this.headers={};for(param in parameters){this.setParam(param,parameters[param]);}for(header in headers){this.setHeader(header,headers[header]);}// Raw URI
raw={scheme:scheme,user:user,host:host,port:port};// Normalized URI
normal={scheme:scheme.toLowerCase(),user:user,host:host.toLowerCase(),port:port};Object.defineProperties(this,{_normal:{get:function get(){return normal;}},_raw:{get:function get(){return raw;}},scheme:{get:function get(){return normal.scheme;},set:function set(value){raw.scheme=value;normal.scheme=value.toLowerCase();}},user:{get:function get(){return normal.user;},set:function set(value){normal.user=raw.user=value;}},host:{get:function get(){return normal.host;},set:function set(value){raw.host=value;normal.host=value.toLowerCase();}},aor:{get:function get(){return normal.user+'@'+normal.host;}},port:{get:function get(){return normal.port;},set:function set(value){normal.port=raw.port=value===0?value:parseInt(value,10)||null;}}});};URI.prototype={setParam:function setParam(key,value){if(key){this.parameters[key.toLowerCase()]=typeof value==='undefined'||value===null?null:value.toString().toLowerCase();}},getParam:function getParam(key){if(key){return this.parameters[key.toLowerCase()];}},hasParam:function hasParam(key){if(key){return this.parameters.hasOwnProperty(key.toLowerCase())&&true||false;}},deleteParam:function deleteParam(parameter){var value;parameter=parameter.toLowerCase();if(this.parameters.hasOwnProperty(parameter)){value=this.parameters[parameter];delete this.parameters[parameter];return value;}},clearParams:function clearParams(){this.parameters={};},setHeader:function setHeader(name,value){this.headers[SIP.Utils.headerize(name)]=value instanceof Array?value:[value];},getHeader:function getHeader(name){if(name){return this.headers[SIP.Utils.headerize(name)];}},hasHeader:function hasHeader(name){if(name){return this.headers.hasOwnProperty(SIP.Utils.headerize(name))&&true||false;}},deleteHeader:function deleteHeader(header){var value;header=SIP.Utils.headerize(header);if(this.headers.hasOwnProperty(header)){value=this.headers[header];delete this.headers[header];return value;}},clearHeaders:function clearHeaders(){this.headers={};},clone:function clone(){return new URI(this._raw.scheme,this._raw.user,this._raw.host,this._raw.port,JSON.parse(JSON.stringify(this.parameters)),JSON.parse(JSON.stringify(this.headers)));},toRaw:function toRaw(){return this._toString(this._raw);},toString:function toString(){return this._toString(this._normal);},_toString:function _toString(uri){var header,parameter,idx,uriString,headers=[];uriString=uri.scheme+':';// add slashes if it's not a sip(s) URI
if(!uri.scheme.toLowerCase().match("^sips?$")){uriString+="//";}if(uri.user){uriString+=SIP.Utils.escapeUser(uri.user)+'@';}uriString+=uri.host;if(uri.port||uri.port===0){uriString+=':'+uri.port;}for(parameter in this.parameters){uriString+=';'+parameter;if(this.parameters[parameter]!==null){uriString+='='+this.parameters[parameter];}}for(header in this.headers){for(idx in this.headers[header]){headers.push(header+'='+this.headers[header][idx]);}}if(headers.length>0){uriString+='?'+headers.join('&');}return uriString;}};/**
  * Parse the given string and returns a SIP.URI instance or undefined if
  * it is an invalid URI.
  * @public
  * @param {String} uri
  */URI.parse=function(uri){uri=SIP.Grammar.parse(uri,'SIP_URI');if(uri!==-1){return uri;}else{return undefined;}};SIP.URI=URI;};},{}],103:[function(require,module,exports){"use strict";/**
 * @fileoverview Utils
 */module.exports=function(SIP,environment){var Utils;Utils={Promise:environment.Promise,defer:function defer(){var deferred={};deferred.promise=new Utils.Promise(function(resolve,reject){deferred.resolve=resolve;deferred.reject=reject;});return deferred;},promisify:function promisify(object,methodName,callbacksFirst){var oldMethod=object[methodName];return function promisifiedMethod(arg,onSuccess,onFailure){return new Utils.Promise(function(resolve,reject){var oldArgs=[arg,resolve,reject];if(callbacksFirst){oldArgs=[resolve,reject,arg];}oldMethod.apply(object,oldArgs);}).then(onSuccess,onFailure);};},augment:function augment(object,constructor,args,override){var idx,proto;// Add public properties from constructor's prototype onto object
proto=constructor.prototype;for(idx in proto){if(override||object[idx]===undefined){object[idx]=proto[idx];}}// Construct the object as though it were just created by constructor
constructor.apply(object,args);},optionsOverride:function optionsOverride(options,winner,loser,isDeprecated,logger,defaultValue){if(isDeprecated&&options[loser]){logger.warn(loser+' is deprecated, please use '+winner+' instead');}if(options[winner]&&options[loser]){logger.warn(winner+' overriding '+loser);}options[winner]=options[winner]||options[loser]||defaultValue;},str_utf8_length:function str_utf8_length(string){return encodeURIComponent(string).replace(/%[A-F\d]{2}/g,'U').length;},generateFakeSDP:function generateFakeSDP(body){if(!body){return;}var start=body.indexOf('o=');var end=body.indexOf('\r\n',start);return'v=0\r\n'+body.slice(start,end)+'\r\ns=-\r\nt=0 0\r\nc=IN IP4 0.0.0.0';},isFunction:function isFunction(fn){if(fn!==undefined){return Object.prototype.toString.call(fn)==='[object Function]';}else{return false;}},isDecimal:function isDecimal(num){return!isNaN(num)&&parseFloat(num)===parseInt(num,10);},createRandomToken:function createRandomToken(size,base){var i,r,token='';base=base||32;for(i=0;i<size;i++){r=Math.random()*base|0;token+=r.toString(base);}return token;},newTag:function newTag(){return SIP.Utils.createRandomToken(SIP.UA.C.TAG_LENGTH);},// http://stackoverflow.com/users/109538/broofa
newUUID:function newUUID(){var UUID='xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g,function(c){var r=Math.random()*16|0,v=c==='x'?r:r&0x3|0x8;return v.toString(16);});return UUID;},hostType:function hostType(host){if(!host){return;}else{host=SIP.Grammar.parse(host,'host');if(host!==-1){return host.host_type;}}},/**
  * Normalize SIP URI.
  * NOTE: It does not allow a SIP URI without username.
  * Accepts 'sip', 'sips' and 'tel' URIs and convert them into 'sip'.
  * Detects the domain part (if given) and properly hex-escapes the user portion.
  * If the user portion has only 'tel' number symbols the user portion is clean of 'tel' visual separators.
  * @private
  * @param {String} target
  * @param {String} [domain]
  */normalizeTarget:function normalizeTarget(target,domain){var uri,target_array,target_user,target_domain;// If no target is given then raise an error.
if(!target){return;// If a SIP.URI instance is given then return it.
}else if(target instanceof SIP.URI){return target;// If a string is given split it by '@':
// - Last fragment is the desired domain.
// - Otherwise append the given domain argument.
}else if(typeof target==='string'){target_array=target.split('@');switch(target_array.length){case 1:if(!domain){return;}target_user=target;target_domain=domain;break;case 2:target_user=target_array[0];target_domain=target_array[1];break;default:target_user=target_array.slice(0,target_array.length-1).join('@');target_domain=target_array[target_array.length-1];}// Remove the URI scheme (if present).
target_user=target_user.replace(/^(sips?|tel):/i,'');// Remove 'tel' visual separators if the user portion just contains 'tel' number symbols.
if(/^[\-\.\(\)]*\+?[0-9\-\.\(\)]+$/.test(target_user)){target_user=target_user.replace(/[\-\.\(\)]/g,'');}// Build the complete SIP URI.
target=SIP.C.SIP+':'+SIP.Utils.escapeUser(target_user)+'@'+target_domain;// Finally parse the resulting URI.
if(uri=SIP.URI.parse(target)){return uri;}else{return;}}else{return;}},/**
  * Hex-escape a SIP URI user.
  * @private
  * @param {String} user
  */escapeUser:function escapeUser(user){// Don't hex-escape ':' (%3A), '+' (%2B), '?' (%3F"), '/' (%2F).
return encodeURIComponent(decodeURIComponent(user)).replace(/%3A/ig,':').replace(/%2B/ig,'+').replace(/%3F/ig,'?').replace(/%2F/ig,'/');},headerize:function headerize(string){var exceptions={'Call-Id':'Call-ID','Cseq':'CSeq','Min-Se':'Min-SE','Rack':'RAck','Rseq':'RSeq','Www-Authenticate':'WWW-Authenticate'},name=string.toLowerCase().replace(/_/g,'-').split('-'),hname='',parts=name.length,part;for(part=0;part<parts;part++){if(part!==0){hname+='-';}hname+=name[part].charAt(0).toUpperCase()+name[part].substring(1);}if(exceptions[hname]){hname=exceptions[hname];}return hname;},sipErrorCause:function sipErrorCause(status_code){var cause;for(cause in SIP.C.SIP_ERROR_CAUSES){if(SIP.C.SIP_ERROR_CAUSES[cause].indexOf(status_code)!==-1){return SIP.C.causes[cause];}}return SIP.C.causes.SIP_FAILURE_CODE;},getReasonPhrase:function getReasonPhrase(code,specific){return specific||SIP.C.REASON_PHRASE[code]||'';},getReasonHeaderValue:function getReasonHeaderValue(code,reason){reason=SIP.Utils.getReasonPhrase(code,reason);return'SIP ;cause='+code+' ;text="'+reason+'"';},getCancelReason:function getCancelReason(code,reason){if(code&&code<200||code>699){throw new TypeError('Invalid status_code: '+code);}else if(code){return SIP.Utils.getReasonHeaderValue(code,reason);}},buildStatusLine:function buildStatusLine(code,reason){code=code||null;reason=reason||null;// Validate code and reason values
if(!code||code<100||code>699){throw new TypeError('Invalid status_code: '+code);}else if(reason&&typeof reason!=='string'&&!(reason instanceof String)){throw new TypeError('Invalid reason_phrase: '+reason);}reason=Utils.getReasonPhrase(code,reason);return'SIP/2.0 '+code+' '+reason+'\r\n';},/**
  * Generate a random Test-Net IP (http://tools.ietf.org/html/rfc5735)
  * @private
  */getRandomTestNetIP:function getRandomTestNetIP(){function getOctet(from,to){return Math.floor(Math.random()*(to-from+1)+from);}return'192.0.2.'+getOctet(1,254);},// MD5 (Message-Digest Algorithm) http://www.webtoolkit.info
calculateMD5:function calculateMD5(string){function RotateLeft(lValue,iShiftBits){return lValue<<iShiftBits|lValue>>>32-iShiftBits;}function AddUnsigned(lX,lY){var lX4,lY4,lX8,lY8,lResult;lX8=lX&0x80000000;lY8=lY&0x80000000;lX4=lX&0x40000000;lY4=lY&0x40000000;lResult=(lX&0x3FFFFFFF)+(lY&0x3FFFFFFF);if(lX4&lY4){return lResult^0x80000000^lX8^lY8;}if(lX4|lY4){if(lResult&0x40000000){return lResult^0xC0000000^lX8^lY8;}else{return lResult^0x40000000^lX8^lY8;}}else{return lResult^lX8^lY8;}}function F(x,y,z){return x&y|~x&z;}function G(x,y,z){return x&z|y&~z;}function H(x,y,z){return x^y^z;}function I(x,y,z){return y^(x|~z);}function FF(a,b,c,d,x,s,ac){a=AddUnsigned(a,AddUnsigned(AddUnsigned(F(b,c,d),x),ac));return AddUnsigned(RotateLeft(a,s),b);}function GG(a,b,c,d,x,s,ac){a=AddUnsigned(a,AddUnsigned(AddUnsigned(G(b,c,d),x),ac));return AddUnsigned(RotateLeft(a,s),b);}function HH(a,b,c,d,x,s,ac){a=AddUnsigned(a,AddUnsigned(AddUnsigned(H(b,c,d),x),ac));return AddUnsigned(RotateLeft(a,s),b);}function II(a,b,c,d,x,s,ac){a=AddUnsigned(a,AddUnsigned(AddUnsigned(I(b,c,d),x),ac));return AddUnsigned(RotateLeft(a,s),b);}function ConvertToWordArray(string){var lWordCount;var lMessageLength=string.length;var lNumberOfWords_temp1=lMessageLength+8;var lNumberOfWords_temp2=(lNumberOfWords_temp1-lNumberOfWords_temp1%64)/64;var lNumberOfWords=(lNumberOfWords_temp2+1)*16;var lWordArray=Array(lNumberOfWords-1);var lBytePosition=0;var lByteCount=0;while(lByteCount<lMessageLength){lWordCount=(lByteCount-lByteCount%4)/4;lBytePosition=lByteCount%4*8;lWordArray[lWordCount]=lWordArray[lWordCount]|string.charCodeAt(lByteCount)<<lBytePosition;lByteCount++;}lWordCount=(lByteCount-lByteCount%4)/4;lBytePosition=lByteCount%4*8;lWordArray[lWordCount]=lWordArray[lWordCount]|0x80<<lBytePosition;lWordArray[lNumberOfWords-2]=lMessageLength<<3;lWordArray[lNumberOfWords-1]=lMessageLength>>>29;return lWordArray;}function WordToHex(lValue){var WordToHexValue="",WordToHexValue_temp="",lByte,lCount;for(lCount=0;lCount<=3;lCount++){lByte=lValue>>>lCount*8&255;WordToHexValue_temp="0"+lByte.toString(16);WordToHexValue=WordToHexValue+WordToHexValue_temp.substr(WordToHexValue_temp.length-2,2);}return WordToHexValue;}function Utf8Encode(string){string=string.replace(/\r\n/g,"\n");var utftext="";for(var n=0;n<string.length;n++){var c=string.charCodeAt(n);if(c<128){utftext+=String.fromCharCode(c);}else if(c>127&&c<2048){utftext+=String.fromCharCode(c>>6|192);utftext+=String.fromCharCode(c&63|128);}else{utftext+=String.fromCharCode(c>>12|224);utftext+=String.fromCharCode(c>>6&63|128);utftext+=String.fromCharCode(c&63|128);}}return utftext;}var x=[];var k,AA,BB,CC,DD,a,b,c,d;var S11=7,S12=12,S13=17,S14=22;var S21=5,S22=9,S23=14,S24=20;var S31=4,S32=11,S33=16,S34=23;var S41=6,S42=10,S43=15,S44=21;string=Utf8Encode(string);x=ConvertToWordArray(string);a=0x67452301;b=0xEFCDAB89;c=0x98BADCFE;d=0x10325476;for(k=0;k<x.length;k+=16){AA=a;BB=b;CC=c;DD=d;a=FF(a,b,c,d,x[k+0],S11,0xD76AA478);d=FF(d,a,b,c,x[k+1],S12,0xE8C7B756);c=FF(c,d,a,b,x[k+2],S13,0x242070DB);b=FF(b,c,d,a,x[k+3],S14,0xC1BDCEEE);a=FF(a,b,c,d,x[k+4],S11,0xF57C0FAF);d=FF(d,a,b,c,x[k+5],S12,0x4787C62A);c=FF(c,d,a,b,x[k+6],S13,0xA8304613);b=FF(b,c,d,a,x[k+7],S14,0xFD469501);a=FF(a,b,c,d,x[k+8],S11,0x698098D8);d=FF(d,a,b,c,x[k+9],S12,0x8B44F7AF);c=FF(c,d,a,b,x[k+10],S13,0xFFFF5BB1);b=FF(b,c,d,a,x[k+11],S14,0x895CD7BE);a=FF(a,b,c,d,x[k+12],S11,0x6B901122);d=FF(d,a,b,c,x[k+13],S12,0xFD987193);c=FF(c,d,a,b,x[k+14],S13,0xA679438E);b=FF(b,c,d,a,x[k+15],S14,0x49B40821);a=GG(a,b,c,d,x[k+1],S21,0xF61E2562);d=GG(d,a,b,c,x[k+6],S22,0xC040B340);c=GG(c,d,a,b,x[k+11],S23,0x265E5A51);b=GG(b,c,d,a,x[k+0],S24,0xE9B6C7AA);a=GG(a,b,c,d,x[k+5],S21,0xD62F105D);d=GG(d,a,b,c,x[k+10],S22,0x2441453);c=GG(c,d,a,b,x[k+15],S23,0xD8A1E681);b=GG(b,c,d,a,x[k+4],S24,0xE7D3FBC8);a=GG(a,b,c,d,x[k+9],S21,0x21E1CDE6);d=GG(d,a,b,c,x[k+14],S22,0xC33707D6);c=GG(c,d,a,b,x[k+3],S23,0xF4D50D87);b=GG(b,c,d,a,x[k+8],S24,0x455A14ED);a=GG(a,b,c,d,x[k+13],S21,0xA9E3E905);d=GG(d,a,b,c,x[k+2],S22,0xFCEFA3F8);c=GG(c,d,a,b,x[k+7],S23,0x676F02D9);b=GG(b,c,d,a,x[k+12],S24,0x8D2A4C8A);a=HH(a,b,c,d,x[k+5],S31,0xFFFA3942);d=HH(d,a,b,c,x[k+8],S32,0x8771F681);c=HH(c,d,a,b,x[k+11],S33,0x6D9D6122);b=HH(b,c,d,a,x[k+14],S34,0xFDE5380C);a=HH(a,b,c,d,x[k+1],S31,0xA4BEEA44);d=HH(d,a,b,c,x[k+4],S32,0x4BDECFA9);c=HH(c,d,a,b,x[k+7],S33,0xF6BB4B60);b=HH(b,c,d,a,x[k+10],S34,0xBEBFBC70);a=HH(a,b,c,d,x[k+13],S31,0x289B7EC6);d=HH(d,a,b,c,x[k+0],S32,0xEAA127FA);c=HH(c,d,a,b,x[k+3],S33,0xD4EF3085);b=HH(b,c,d,a,x[k+6],S34,0x4881D05);a=HH(a,b,c,d,x[k+9],S31,0xD9D4D039);d=HH(d,a,b,c,x[k+12],S32,0xE6DB99E5);c=HH(c,d,a,b,x[k+15],S33,0x1FA27CF8);b=HH(b,c,d,a,x[k+2],S34,0xC4AC5665);a=II(a,b,c,d,x[k+0],S41,0xF4292244);d=II(d,a,b,c,x[k+7],S42,0x432AFF97);c=II(c,d,a,b,x[k+14],S43,0xAB9423A7);b=II(b,c,d,a,x[k+5],S44,0xFC93A039);a=II(a,b,c,d,x[k+12],S41,0x655B59C3);d=II(d,a,b,c,x[k+3],S42,0x8F0CCC92);c=II(c,d,a,b,x[k+10],S43,0xFFEFF47D);b=II(b,c,d,a,x[k+1],S44,0x85845DD1);a=II(a,b,c,d,x[k+8],S41,0x6FA87E4F);d=II(d,a,b,c,x[k+15],S42,0xFE2CE6E0);c=II(c,d,a,b,x[k+6],S43,0xA3014314);b=II(b,c,d,a,x[k+13],S44,0x4E0811A1);a=II(a,b,c,d,x[k+4],S41,0xF7537E82);d=II(d,a,b,c,x[k+11],S42,0xBD3AF235);c=II(c,d,a,b,x[k+2],S43,0x2AD7D2BB);b=II(b,c,d,a,x[k+9],S44,0xEB86D391);a=AddUnsigned(a,AA);b=AddUnsigned(b,BB);c=AddUnsigned(c,CC);d=AddUnsigned(d,DD);}var temp=WordToHex(a)+WordToHex(b)+WordToHex(c)+WordToHex(d);return temp.toLowerCase();}};SIP.Utils=Utils;};},{}],104:[function(require,module,exports){"use strict";/**
 * @fileoverview WebRTC
 */module.exports=function(SIP,environment){var WebRTC;WebRTC={};WebRTC.MediaHandler=require('./WebRTC/MediaHandler')(SIP);WebRTC.MediaStreamManager=require('./WebRTC/MediaStreamManager')(SIP,environment);var _isSupported;WebRTC.isSupported=function(){if(_isSupported!==undefined){return _isSupported;}WebRTC.MediaStream=environment.MediaStream;WebRTC.getUserMedia=environment.getUserMedia;WebRTC.RTCPeerConnection=environment.RTCPeerConnection;WebRTC.RTCSessionDescription=environment.RTCSessionDescription;if(WebRTC.RTCPeerConnection&&WebRTC.RTCSessionDescription){if(WebRTC.getUserMedia){WebRTC.getUserMedia=SIP.Utils.promisify(environment,'getUserMedia');}_isSupported=true;}else{_isSupported=false;}return _isSupported;};return WebRTC;};},{"./WebRTC/MediaHandler":105,"./WebRTC/MediaStreamManager":106}],105:[function(require,module,exports){"use strict";/**
 * @fileoverview MediaHandler
 *//* MediaHandler
 * @class PeerConnection helper Class.
 * @param {SIP.Session} session
 * @param {Object} [options]
 * @param {SIP.WebRTC.MediaStreamManager} [options.mediaStreamManager]
 *        The MediaStreamManager to acquire/release streams from/to.
 *        If not provided, a default MediaStreamManager will be used.
 */module.exports=function(SIP){var MediaHandler=function MediaHandler(session,options){options=options||{};this.logger=session.ua.getLogger('sip.invitecontext.mediahandler',session.id);this.session=session;this.localMedia=null;this.ready=true;this.mediaStreamManager=options.mediaStreamManager||new SIP.WebRTC.MediaStreamManager(this.logger);this.audioMuted=false;this.videoMuted=false;this.local_hold=false;this.remote_hold=false;// old init() from here on
var servers=this.prepareIceServers(options.stunServers,options.turnServers);this.RTCConstraints=options.RTCConstraints||{};this.initPeerConnection(servers);function selfEmit(mh,event){if(mh.mediaStreamManager.on){mh.mediaStreamManager.on(event,function(){mh.emit.apply(mh,[event].concat(Array.prototype.slice.call(arguments)));});}}selfEmit(this,'userMediaRequest');selfEmit(this,'userMedia');selfEmit(this,'userMediaFailed');};MediaHandler.defaultFactory=function defaultFactory(session,options){return new MediaHandler(session,options);};MediaHandler.defaultFactory.isSupported=function(){return SIP.WebRTC.isSupported();};MediaHandler.prototype=Object.create(SIP.MediaHandler.prototype,{// Functions the session can use
isReady:{writable:true,value:function isReady(){return this.ready;}},close:{writable:true,value:function close(){this.logger.log('closing PeerConnection');this._remoteStreams=[];// have to check signalingState since this.close() gets called multiple times
// TODO figure out why that happens
if(this.peerConnection&&this.peerConnection.signalingState!=='closed'){this.peerConnection.close();if(this.localMedia){this.mediaStreamManager.release(this.localMedia);}}}},/**
   * @param {SIP.WebRTC.MediaStream | (getUserMedia constraints)} [mediaHint]
   *        the MediaStream (or the constraints describing it) to be used for the session
   */getDescription:{writable:true,value:function getDescription(mediaHint){var self=this;var acquire=self.mediaStreamManager.acquire;if(acquire.length>1){acquire=SIP.Utils.promisify(this.mediaStreamManager,'acquire',true);}mediaHint=mediaHint||{};if(mediaHint.dataChannel===true){mediaHint.dataChannel={};}this.mediaHint=mediaHint;/*
     * 1. acquire streams (skip if MediaStreams passed in)
     * 2. addStreams
     * 3. createOffer/createAnswer
     */var streamPromise;if(self.localMedia){self.logger.log('already have local media');streamPromise=SIP.Utils.Promise.resolve(self.localMedia);}else{self.logger.log('acquiring local media');streamPromise=acquire.call(self.mediaStreamManager,mediaHint).then(function acquireSucceeded(streams){self.logger.log('acquired local media streams');self.localMedia=streams;self.session.connecting();return streams;},function acquireFailed(err){self.logger.error('unable to acquire streams');self.logger.error(err);self.session.connecting();throw err;}).then(this.addStreams.bind(this));}return streamPromise.then(function streamAdditionSucceeded(){if(self.hasOffer('remote')){self.peerConnection.ondatachannel=function(evt){self.dataChannel=evt.channel;self.emit('dataChannel',self.dataChannel);};}else if(mediaHint.dataChannel&&self.peerConnection.createDataChannel){self.dataChannel=self.peerConnection.createDataChannel('sipjs',mediaHint.dataChannel);self.emit('dataChannel',self.dataChannel);}self.render();return self.createOfferOrAnswer(self.RTCConstraints);}).then(function(sdp){sdp=SIP.Hacks.Firefox.hasMissingCLineInSDP(sdp);if(self.local_hold){// Don't receive media
// TODO - This will break for media streams with different directions.
if(!/a=(sendrecv|sendonly|recvonly|inactive)/.test(sdp)){sdp=sdp.replace(/(m=[^\r]*\r\n)/g,'$1a=sendonly\r\n');}else{sdp=sdp.replace(/a=sendrecv\r\n/g,'a=sendonly\r\n');sdp=sdp.replace(/a=recvonly\r\n/g,'a=inactive\r\n');}}return{body:sdp,contentType:'application/sdp'};});}},/**
   * Check if a SIP message contains a session description.
   * @param {SIP.SIPMessage} message
   * @returns {boolean}
   */hasDescription:{writeable:true,value:function hasDescription(message){return message.getHeader('Content-Type')==='application/sdp'&&!!message.body;}},/**
   * Set the session description contained in a SIP message.
   * @param {SIP.SIPMessage} message
   * @returns {Promise}
   */setDescription:{writable:true,value:function setDescription(message){var sdp=message.body;this.remote_hold=/a=(sendonly|inactive)/.test(sdp);sdp=SIP.Hacks.Firefox.cannotHandleExtraWhitespace(sdp);sdp=SIP.Hacks.AllBrowsers.maskDtls(sdp);var rawDescription={type:this.hasOffer('local')?'answer':'offer',sdp:sdp};this.emit('setDescription',rawDescription);var description=new SIP.WebRTC.RTCSessionDescription(rawDescription);return SIP.Utils.promisify(this.peerConnection,'setRemoteDescription')(description);}},/**
   * If the Session associated with this MediaHandler were to be referred,
   * what mediaHint should be provided to the UA's invite method?
   */getReferMedia:{writable:true,value:function getReferMedia(){function hasTracks(trackGetter,stream){return stream[trackGetter]().length>0;}function bothHaveTracks(trackGetter){/* jshint validthis:true */return this.getLocalStreams().some(hasTracks.bind(null,trackGetter))&&this.getRemoteStreams().some(hasTracks.bind(null,trackGetter));}return{constraints:{audio:bothHaveTracks.call(this,'getAudioTracks'),video:bothHaveTracks.call(this,'getVideoTracks')}};}},updateIceServers:{writeable:true,value:function value(options){var servers=this.prepareIceServers(options.stunServers,options.turnServers);this.RTCConstraints=options.RTCConstraints||this.RTCConstraints;this.initPeerConnection(servers);/* once updateIce is implemented correctly, this is better than above
    //no op if browser does not support this
    if (!this.peerConnection.updateIce) {
      return;
    }

    this.peerConnection.updateIce({'iceServers': servers}, this.RTCConstraints);
    */}},// Functions the session can use, but only because it's convenient for the application
isMuted:{writable:true,value:function isMuted(){return{audio:this.audioMuted,video:this.videoMuted};}},mute:{writable:true,value:function mute(options){if(this.getLocalStreams().length===0){return;}options=options||{audio:this.getLocalStreams()[0].getAudioTracks().length>0,video:this.getLocalStreams()[0].getVideoTracks().length>0};var audioMuted=false,videoMuted=false;if(options.audio&&!this.audioMuted){audioMuted=true;this.audioMuted=true;this.toggleMuteAudio(true);}if(options.video&&!this.videoMuted){videoMuted=true;this.videoMuted=true;this.toggleMuteVideo(true);}//REVISIT
if(audioMuted||videoMuted){return{audio:audioMuted,video:videoMuted};/*this.session.onmute({
        audio: audioMuted,
        video: videoMuted
      });*/}}},unmute:{writable:true,value:function unmute(options){if(this.getLocalStreams().length===0){return;}options=options||{audio:this.getLocalStreams()[0].getAudioTracks().length>0,video:this.getLocalStreams()[0].getVideoTracks().length>0};var audioUnMuted=false,videoUnMuted=false;if(options.audio&&this.audioMuted){audioUnMuted=true;this.audioMuted=false;this.toggleMuteAudio(false);}if(options.video&&this.videoMuted){videoUnMuted=true;this.videoMuted=false;this.toggleMuteVideo(false);}//REVISIT
if(audioUnMuted||videoUnMuted){return{audio:audioUnMuted,video:videoUnMuted};/*this.session.onunmute({
        audio: audioUnMuted,
        video: videoUnMuted
      });*/}}},hold:{writable:true,value:function hold(){this.local_hold=true;this.toggleMuteAudio(true);this.toggleMuteVideo(true);}},unhold:{writable:true,value:function unhold(){this.local_hold=false;if(!this.audioMuted){this.toggleMuteAudio(false);}if(!this.videoMuted){this.toggleMuteVideo(false);}}},// Functions the application can use, but not the session
getLocalStreams:{writable:true,value:function getLocalStreams(){var pc=this.peerConnection;if(pc&&pc.signalingState==='closed'){this.logger.warn('peerConnection is closed, getLocalStreams returning []');return[];}return pc.getLocalStreams&&pc.getLocalStreams()||pc.localStreams||[];}},getRemoteStreams:{writable:true,value:function getRemoteStreams(){var pc=this.peerConnection;if(pc&&pc.signalingState==='closed'){this.logger.warn('peerConnection is closed, getRemoteStreams returning this._remoteStreams');return this._remoteStreams;}return pc.getRemoteStreams&&pc.getRemoteStreams()||pc.remoteStreams||[];}},render:{writable:true,value:function render(renderHint){renderHint=renderHint||this.mediaHint&&this.mediaHint.render;if(!renderHint){return false;}var streamGetters={local:'getLocalStreams',remote:'getRemoteStreams'};Object.keys(streamGetters).forEach(function(loc){var streamGetter=streamGetters[loc];var streams=this[streamGetter]();SIP.WebRTC.MediaStreamManager.render(streams,renderHint[loc]);}.bind(this));}},// Internal functions
hasOffer:{writable:true,value:function hasOffer(where){var offerState='have-'+where+'-offer';return this.peerConnection.signalingState===offerState;// TODO consider signalingStates with 'pranswer'?
}},prepareIceServers:{writable:true,value:function prepareIceServers(stunServers,turnServers){var servers=[],config=this.session.ua.configuration;stunServers=stunServers||config.stunServers;turnServers=turnServers||config.turnServers;[].concat(stunServers).forEach(function(server){servers.push({'urls':server});});[].concat(turnServers).forEach(function(server){servers.push({'urls':server.urls,'username':server.username,'credential':server.password});});return servers;}},initPeerConnection:{writable:true,value:function initPeerConnection(servers){var self=this,config=this.session.ua.configuration;this.onIceCompleted=SIP.Utils.defer();this.onIceCompleted.promise.then(function(pc){self.emit('iceGatheringComplete',pc);if(self.iceCheckingTimer){SIP.Timers.clearTimeout(self.iceCheckingTimer);self.iceCheckingTimer=null;}});if(this.peerConnection){this.peerConnection.close();}this.peerConnection=new SIP.WebRTC.RTCPeerConnection({'iceServers':servers});// Firefox (35.0.1) sometimes throws on calls to peerConnection.getRemoteStreams
// even if peerConnection.onaddstream was just called. In order to make
// MediaHandler.prototype.getRemoteStreams work, keep track of them manually
this._remoteStreams=[];this.peerConnection.onaddstream=function(e){self.logger.log('stream added: '+e.stream.id);self._remoteStreams.push(e.stream);self.render();self.emit('addStream',e);};this.peerConnection.onremovestream=function(e){self.logger.log('stream removed: '+e.stream.id);};this.startIceCheckingTimer=function(){if(!self.iceCheckingTimer){self.iceCheckingTimer=SIP.Timers.setTimeout(function(){self.logger.log('RTCIceChecking Timeout Triggered after '+config.iceCheckingTimeout+' milliseconds');self.onIceCompleted.resolve(this);}.bind(this.peerConnection),config.iceCheckingTimeout);}};this.peerConnection.onicecandidate=function(e){self.emit('iceCandidate',e);if(e.candidate){self.logger.log('ICE candidate received: '+(e.candidate.candidate===null?null:e.candidate.candidate.trim()));self.startIceCheckingTimer();}else{self.onIceCompleted.resolve(this);}};this.peerConnection.onicegatheringstatechange=function(){self.logger.log('RTCIceGatheringState changed: '+this.iceGatheringState);if(this.iceGatheringState==='gathering'){self.emit('iceGathering',this);}if(this.iceGatheringState==='complete'){self.onIceCompleted.resolve(this);}};this.peerConnection.oniceconnectionstatechange=function(){//need e for commented out case
var stateEvent;if(this.iceConnectionState==='checking'){self.startIceCheckingTimer();}switch(this.iceConnectionState){case'new':stateEvent='iceConnection';break;case'checking':stateEvent='iceConnectionChecking';break;case'connected':stateEvent='iceConnectionConnected';break;case'completed':stateEvent='iceConnectionCompleted';break;case'failed':stateEvent='iceConnectionFailed';break;case'disconnected':stateEvent='iceConnectionDisconnected';break;case'closed':stateEvent='iceConnectionClosed';break;default:self.logger.warn('Unknown iceConnection state:',this.iceConnectionState);return;}self.emit(stateEvent,this);//Bria state changes are always connected -> disconnected -> connected on accept, so session gets terminated
//normal calls switch from failed to connected in some cases, so checking for failed and terminated
/*if (this.iceConnectionState === 'failed') {
        self.session.terminate({
        cause: SIP.C.causes.RTP_TIMEOUT,
        status_code: 200,
        reason_phrase: SIP.C.causes.RTP_TIMEOUT
      });
      } else if (e.currentTarget.iceGatheringState === 'complete' && this.iceConnectionState !== 'closed') {
      self.onIceCompleted(this);
      }*/};this.peerConnection.onstatechange=function(){self.logger.log('PeerConnection state changed to "'+this.readyState+'"');};}},createOfferOrAnswer:{writable:true,value:function createOfferOrAnswer(constraints){var self=this;var methodName;var pc=self.peerConnection;self.ready=false;methodName=self.hasOffer('remote')?'createAnswer':'createOffer';return SIP.Utils.promisify(pc,methodName,true)(constraints).then(SIP.Utils.promisify(pc,'setLocalDescription')).then(function onSetLocalDescriptionSuccess(){var deferred=SIP.Utils.defer();if(pc.iceConnectionState==='complete'||pc.iceConnectionState==='completed'){deferred.resolve();}else{self.onIceCompleted.promise.then(deferred.resolve);}return deferred.promise;}).then(function readySuccess(){var sdp=pc.localDescription.sdp;sdp=SIP.Hacks.Chrome.needsExplicitlyInactiveSDP(sdp);sdp=SIP.Hacks.AllBrowsers.unmaskDtls(sdp);var sdpWrapper={type:methodName==='createOffer'?'offer':'answer',sdp:sdp};self.emit('getDescription',sdpWrapper);if(self.session.ua.configuration.hackStripTcp){sdpWrapper.sdp=sdpWrapper.sdp.replace(/^a=candidate:\d+ \d+ tcp .*?\r\n/img,"");}self.ready=true;return sdpWrapper.sdp;}).catch(function methodFailed(e){self.logger.error(e);self.ready=true;throw new SIP.Exceptions.GetDescriptionError(e);});}},addStreams:{writable:true,value:function addStreams(streams){try{streams=[].concat(streams);streams.forEach(function(stream){this.peerConnection.addStream(stream);},this);}catch(e){this.logger.error('error adding stream');this.logger.error(e);return SIP.Utils.Promise.reject(e);}return SIP.Utils.Promise.resolve();}},toggleMuteHelper:{writable:true,value:function toggleMuteHelper(trackGetter,mute){this.getLocalStreams().forEach(function(stream){stream[trackGetter]().forEach(function(track){track.enabled=!mute;});});}},toggleMuteAudio:{writable:true,value:function toggleMuteAudio(mute){this.toggleMuteHelper('getAudioTracks',mute);}},toggleMuteVideo:{writable:true,value:function toggleMuteVideo(mute){this.toggleMuteHelper('getVideoTracks',mute);}}});// Return since it will be assigned to a variable.
return MediaHandler;};},{}],106:[function(require,module,exports){"use strict";/**
 * @fileoverview MediaStreamManager
 *//* MediaStreamManager
 * @class Manages the acquisition and release of MediaStreams.
 * @param {mediaHint} [defaultMediaHint] The mediaHint to use if none is provided to acquire()
 */module.exports=function(SIP,environment){// Default MediaStreamManager provides single-use streams created with getUserMedia
var MediaStreamManager=function MediaStreamManager(logger,defaultMediaHint){if(!SIP.WebRTC.isSupported()){throw new SIP.Exceptions.NotSupportedError('Media not supported');}this.mediaHint=defaultMediaHint||{constraints:{audio:true,video:true}};// map of streams to acquisition manner:
// true -> passed in as mediaHint.stream
// false -> getUserMedia
this.acquisitions={};};MediaStreamManager.streamId=function(stream){return stream.getAudioTracks().concat(stream.getVideoTracks()).map(function trackId(track){return track.id;}).join('');};/**
 * @param {(Array of) MediaStream} streams - The streams to render
 *
 * @param {(Array of) HTMLMediaElement} elements
 *        - The <audio>/<video> element(s) that should render the streams
 *
 * Each stream in streams renders to the corresponding element in elements,
 * wrapping around elements if needed.
 */MediaStreamManager.render=function render(streams,elements){if(!elements){return false;}if(Array.isArray(elements)&&!elements.length){throw new TypeError('elements must not be empty');}function attachMediaStream(element,stream){element.srcObject=stream;}function ensureMediaPlaying(mediaElement){var interval=100;mediaElement.ensurePlayingIntervalId=SIP.Timers.setInterval(function(){if(mediaElement.paused&&mediaElement.srcObject){mediaElement.play();}else{SIP.Timers.clearInterval(mediaElement.ensurePlayingIntervalId);}},interval);}function attachAndPlay(elements,stream,index){var element=elements[index%elements.length];if(typeof element==='function'){element=element();}(environment.attachMediaStream||attachMediaStream)(element,stream);ensureMediaPlaying(element);}// [].concat "casts" `elements` into an array
// so forEach works even if `elements` was a single element
elements=[].concat(elements);[].concat(streams).forEach(attachAndPlay.bind(null,elements));};MediaStreamManager.prototype=Object.create(SIP.EventEmitter.prototype,{'acquire':{writable:true,value:function acquire(mediaHint){mediaHint=Object.keys(mediaHint||{}).length?mediaHint:this.mediaHint;var saveSuccess=function(isHintStream,streams){streams=[].concat(streams);streams.forEach(function(stream){var streamId=MediaStreamManager.streamId(stream);this.acquisitions[streamId]=!!isHintStream;},this);return SIP.Utils.Promise.resolve(streams);}.bind(this);if(mediaHint.stream){return saveSuccess(true,mediaHint.stream);}else{// Fallback to audio/video enabled if no mediaHint can be found.
var constraints=mediaHint.constraints||this.mediaHint&&this.mediaHint.constraints||{audio:true,video:true};var deferred=SIP.Utils.defer();/*
       * Make the call asynchronous, so that ICCs have a chance
       * to define callbacks to `userMediaRequest`
       */SIP.Timers.setTimeout(function(){this.emit('userMediaRequest',constraints);var emitThenCall=function(eventName,callback){var callbackArgs=Array.prototype.slice.call(arguments,2);// Emit with all of the arguments from the real callback.
var newArgs=[eventName].concat(callbackArgs);this.emit.apply(this,newArgs);return callback.apply(null,callbackArgs);}.bind(this);if(constraints.audio||constraints.video){deferred.resolve(SIP.WebRTC.getUserMedia(constraints).then(emitThenCall.bind(this,'userMedia',saveSuccess.bind(null,false)),emitThenCall.bind(this,'userMediaFailed',function(e){throw e;})));}else{// Local streams were explicitly excluded.
deferred.resolve([]);}}.bind(this),0);return deferred.promise;}}},'release':{writable:true,value:function release(streams){streams=[].concat(streams);streams.forEach(function(stream){var streamId=MediaStreamManager.streamId(stream);if(this.acquisitions[streamId]===false){stream.getTracks().forEach(function(track){track.stop();});}delete this.acquisitions[streamId];},this);}}});// Return since it will be assigned to a variable.
return MediaStreamManager;};},{}],107:[function(require,module,exports){if(typeof Object.create==='function'){// implementation from standard node.js 'util' module
module.exports=function inherits(ctor,superCtor){ctor.super_=superCtor;ctor.prototype=Object.create(superCtor.prototype,{constructor:{value:ctor,enumerable:false,writable:true,configurable:true}});};}else{// old school shim for old browsers
module.exports=function inherits(ctor,superCtor){ctor.super_=superCtor;var TempCtor=function TempCtor(){};TempCtor.prototype=superCtor.prototype;ctor.prototype=new TempCtor();ctor.prototype.constructor=ctor;};}},{}],108:[function(require,module,exports){module.exports=function isBuffer(arg){return arg&&(typeof arg==="undefined"?"undefined":_typeof(arg))==='object'&&typeof arg.copy==='function'&&typeof arg.fill==='function'&&typeof arg.readUInt8==='function';};},{}],109:[function(require,module,exports){(function(process,global){// Copyright Joyent, Inc. and other Node contributors.
//
// Permission is hereby granted, free of charge, to any person obtaining a
// copy of this software and associated documentation files (the
// "Software"), to deal in the Software without restriction, including
// without limitation the rights to use, copy, modify, merge, publish,
// distribute, sublicense, and/or sell copies of the Software, and to permit
// persons to whom the Software is furnished to do so, subject to the
// following conditions:
//
// The above copyright notice and this permission notice shall be included
// in all copies or substantial portions of the Software.
//
// THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS
// OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF
// MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN
// NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM,
// DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR
// OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE
// USE OR OTHER DEALINGS IN THE SOFTWARE.
var formatRegExp=/%[sdj%]/g;exports.format=function(f){if(!isString(f)){var objects=[];for(var i=0;i<arguments.length;i++){objects.push(inspect(arguments[i]));}return objects.join(' ');}var i=1;var args=arguments;var len=args.length;var str=String(f).replace(formatRegExp,function(x){if(x==='%%')return'%';if(i>=len)return x;switch(x){case'%s':return String(args[i++]);case'%d':return Number(args[i++]);case'%j':try{return JSON.stringify(args[i++]);}catch(_){return'[Circular]';}default:return x;}});for(var x=args[i];i<len;x=args[++i]){if(isNull(x)||!isObject(x)){str+=' '+x;}else{str+=' '+inspect(x);}}return str;};// Mark that a method should not be used.
// Returns a modified function which warns once by default.
// If --no-deprecation is set, then it is a no-op.
exports.deprecate=function(fn,msg){// Allow for deprecating things in the process of starting up.
if(isUndefined(global.process)){return function(){return exports.deprecate(fn,msg).apply(this,arguments);};}if(process.noDeprecation===true){return fn;}var warned=false;function deprecated(){if(!warned){if(process.throwDeprecation){throw new Error(msg);}else if(process.traceDeprecation){console.trace(msg);}else{console.error(msg);}warned=true;}return fn.apply(this,arguments);}return deprecated;};var debugs={};var debugEnviron;exports.debuglog=function(set){if(isUndefined(debugEnviron))debugEnviron=process.env.NODE_DEBUG||'';set=set.toUpperCase();if(!debugs[set]){if(new RegExp('\\b'+set+'\\b','i').test(debugEnviron)){var pid=process.pid;debugs[set]=function(){var msg=exports.format.apply(exports,arguments);console.error('%s %d: %s',set,pid,msg);};}else{debugs[set]=function(){};}}return debugs[set];};/**
 * Echos the value of a value. Trys to print the value out
 * in the best way possible given the different types.
 *
 * @param {Object} obj The object to print out.
 * @param {Object} opts Optional options object that alters the output.
 *//* legacy: obj, showHidden, depth, colors*/function inspect(obj,opts){// default options
var ctx={seen:[],stylize:stylizeNoColor};// legacy...
if(arguments.length>=3)ctx.depth=arguments[2];if(arguments.length>=4)ctx.colors=arguments[3];if(isBoolean(opts)){// legacy...
ctx.showHidden=opts;}else if(opts){// got an "options" object
exports._extend(ctx,opts);}// set default options
if(isUndefined(ctx.showHidden))ctx.showHidden=false;if(isUndefined(ctx.depth))ctx.depth=2;if(isUndefined(ctx.colors))ctx.colors=false;if(isUndefined(ctx.customInspect))ctx.customInspect=true;if(ctx.colors)ctx.stylize=stylizeWithColor;return formatValue(ctx,obj,ctx.depth);}exports.inspect=inspect;// http://en.wikipedia.org/wiki/ANSI_escape_code#graphics
inspect.colors={'bold':[1,22],'italic':[3,23],'underline':[4,24],'inverse':[7,27],'white':[37,39],'grey':[90,39],'black':[30,39],'blue':[34,39],'cyan':[36,39],'green':[32,39],'magenta':[35,39],'red':[31,39],'yellow':[33,39]};// Don't use 'blue' not visible on cmd.exe
inspect.styles={'special':'cyan','number':'yellow','boolean':'yellow','undefined':'grey','null':'bold','string':'green','date':'magenta',// "name": intentionally not styling
'regexp':'red'};function stylizeWithColor(str,styleType){var style=inspect.styles[styleType];if(style){return"\x1B["+inspect.colors[style][0]+'m'+str+"\x1B["+inspect.colors[style][1]+'m';}else{return str;}}function stylizeNoColor(str,styleType){return str;}function arrayToHash(array){var hash={};array.forEach(function(val,idx){hash[val]=true;});return hash;}function formatValue(ctx,value,recurseTimes){// Provide a hook for user-specified inspect functions.
// Check that value is an object with an inspect function on it
if(ctx.customInspect&&value&&isFunction(value.inspect)&&// Filter out the util module, it's inspect function is special
value.inspect!==exports.inspect&&// Also filter out any prototype objects using the circular check.
!(value.constructor&&value.constructor.prototype===value)){var ret=value.inspect(recurseTimes,ctx);if(!isString(ret)){ret=formatValue(ctx,ret,recurseTimes);}return ret;}// Primitive types cannot have properties
var primitive=formatPrimitive(ctx,value);if(primitive){return primitive;}// Look up the keys of the object.
var keys=Object.keys(value);var visibleKeys=arrayToHash(keys);if(ctx.showHidden){keys=Object.getOwnPropertyNames(value);}// IE doesn't make error fields non-enumerable
// http://msdn.microsoft.com/en-us/library/ie/dww52sbt(v=vs.94).aspx
if(isError(value)&&(keys.indexOf('message')>=0||keys.indexOf('description')>=0)){return formatError(value);}// Some type of object without properties can be shortcutted.
if(keys.length===0){if(isFunction(value)){var name=value.name?': '+value.name:'';return ctx.stylize('[Function'+name+']','special');}if(isRegExp(value)){return ctx.stylize(RegExp.prototype.toString.call(value),'regexp');}if(isDate(value)){return ctx.stylize(Date.prototype.toString.call(value),'date');}if(isError(value)){return formatError(value);}}var base='',array=false,braces=['{','}'];// Make Array say that they are Array
if(isArray(value)){array=true;braces=['[',']'];}// Make functions say that they are functions
if(isFunction(value)){var n=value.name?': '+value.name:'';base=' [Function'+n+']';}// Make RegExps say that they are RegExps
if(isRegExp(value)){base=' '+RegExp.prototype.toString.call(value);}// Make dates with properties first say the date
if(isDate(value)){base=' '+Date.prototype.toUTCString.call(value);}// Make error with message first say the error
if(isError(value)){base=' '+formatError(value);}if(keys.length===0&&(!array||value.length==0)){return braces[0]+base+braces[1];}if(recurseTimes<0){if(isRegExp(value)){return ctx.stylize(RegExp.prototype.toString.call(value),'regexp');}else{return ctx.stylize('[Object]','special');}}ctx.seen.push(value);var output;if(array){output=formatArray(ctx,value,recurseTimes,visibleKeys,keys);}else{output=keys.map(function(key){return formatProperty(ctx,value,recurseTimes,visibleKeys,key,array);});}ctx.seen.pop();return reduceToSingleString(output,base,braces);}function formatPrimitive(ctx,value){if(isUndefined(value))return ctx.stylize('undefined','undefined');if(isString(value)){var simple='\''+JSON.stringify(value).replace(/^"|"$/g,'').replace(/'/g,"\\'").replace(/\\"/g,'"')+'\'';return ctx.stylize(simple,'string');}if(isNumber(value))return ctx.stylize(''+value,'number');if(isBoolean(value))return ctx.stylize(''+value,'boolean');// For some reason typeof null is "object", so special case here.
if(isNull(value))return ctx.stylize('null','null');}function formatError(value){return'['+Error.prototype.toString.call(value)+']';}function formatArray(ctx,value,recurseTimes,visibleKeys,keys){var output=[];for(var i=0,l=value.length;i<l;++i){if(hasOwnProperty(value,String(i))){output.push(formatProperty(ctx,value,recurseTimes,visibleKeys,String(i),true));}else{output.push('');}}keys.forEach(function(key){if(!key.match(/^\d+$/)){output.push(formatProperty(ctx,value,recurseTimes,visibleKeys,key,true));}});return output;}function formatProperty(ctx,value,recurseTimes,visibleKeys,key,array){var name,str,desc;desc=Object.getOwnPropertyDescriptor(value,key)||{value:value[key]};if(desc.get){if(desc.set){str=ctx.stylize('[Getter/Setter]','special');}else{str=ctx.stylize('[Getter]','special');}}else{if(desc.set){str=ctx.stylize('[Setter]','special');}}if(!hasOwnProperty(visibleKeys,key)){name='['+key+']';}if(!str){if(ctx.seen.indexOf(desc.value)<0){if(isNull(recurseTimes)){str=formatValue(ctx,desc.value,null);}else{str=formatValue(ctx,desc.value,recurseTimes-1);}if(str.indexOf('\n')>-1){if(array){str=str.split('\n').map(function(line){return'  '+line;}).join('\n').substr(2);}else{str='\n'+str.split('\n').map(function(line){return'   '+line;}).join('\n');}}}else{str=ctx.stylize('[Circular]','special');}}if(isUndefined(name)){if(array&&key.match(/^\d+$/)){return str;}name=JSON.stringify(''+key);if(name.match(/^"([a-zA-Z_][a-zA-Z_0-9]*)"$/)){name=name.substr(1,name.length-2);name=ctx.stylize(name,'name');}else{name=name.replace(/'/g,"\\'").replace(/\\"/g,'"').replace(/(^"|"$)/g,"'");name=ctx.stylize(name,'string');}}return name+': '+str;}function reduceToSingleString(output,base,braces){var numLinesEst=0;var length=output.reduce(function(prev,cur){numLinesEst++;if(cur.indexOf('\n')>=0)numLinesEst++;return prev+cur.replace(/\u001b\[\d\d?m/g,'').length+1;},0);if(length>60){return braces[0]+(base===''?'':base+'\n ')+' '+output.join(',\n  ')+' '+braces[1];}return braces[0]+base+' '+output.join(', ')+' '+braces[1];}// NOTE: These type checking functions intentionally don't use `instanceof`
// because it is fragile and can be easily faked with `Object.create()`.
function isArray(ar){return Array.isArray(ar);}exports.isArray=isArray;function isBoolean(arg){return typeof arg==='boolean';}exports.isBoolean=isBoolean;function isNull(arg){return arg===null;}exports.isNull=isNull;function isNullOrUndefined(arg){return arg==null;}exports.isNullOrUndefined=isNullOrUndefined;function isNumber(arg){return typeof arg==='number';}exports.isNumber=isNumber;function isString(arg){return typeof arg==='string';}exports.isString=isString;function isSymbol(arg){return(typeof arg==="undefined"?"undefined":_typeof(arg))==='symbol';}exports.isSymbol=isSymbol;function isUndefined(arg){return arg===void 0;}exports.isUndefined=isUndefined;function isRegExp(re){return isObject(re)&&objectToString(re)==='[object RegExp]';}exports.isRegExp=isRegExp;function isObject(arg){return(typeof arg==="undefined"?"undefined":_typeof(arg))==='object'&&arg!==null;}exports.isObject=isObject;function isDate(d){return isObject(d)&&objectToString(d)==='[object Date]';}exports.isDate=isDate;function isError(e){return isObject(e)&&(objectToString(e)==='[object Error]'||e instanceof Error);}exports.isError=isError;function isFunction(arg){return typeof arg==='function';}exports.isFunction=isFunction;function isPrimitive(arg){return arg===null||typeof arg==='boolean'||typeof arg==='number'||typeof arg==='string'||(typeof arg==="undefined"?"undefined":_typeof(arg))==='symbol'||// ES6 symbol
typeof arg==='undefined';}exports.isPrimitive=isPrimitive;exports.isBuffer=require('./support/isBuffer');function objectToString(o){return Object.prototype.toString.call(o);}function pad(n){return n<10?'0'+n.toString(10):n.toString(10);}var months=['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];// 26 Feb 16:19:34
function timestamp(){var d=new Date();var time=[pad(d.getHours()),pad(d.getMinutes()),pad(d.getSeconds())].join(':');return[d.getDate(),months[d.getMonth()],time].join(' ');}// log is just a thin wrapper to console.log that prepends a timestamp
exports.log=function(){console.log('%s - %s',timestamp(),exports.format.apply(exports,arguments));};/**
 * Inherit the prototype methods from one constructor into another.
 *
 * The Function.prototype.inherits from lang.js rewritten as a standalone
 * function (not on Function.prototype). NOTE: If this file is to be loaded
 * during bootstrapping this function needs to be rewritten using some native
 * functions as prototype setup using normal JavaScript does not work as
 * expected during bootstrapping (see mirror.js in r114903).
 *
 * @param {function} ctor Constructor function which needs to inherit the
 *     prototype.
 * @param {function} superCtor Constructor function to inherit prototype from.
 */exports.inherits=require('inherits');exports._extend=function(origin,add){// Don't do anything if add isn't an object
if(!add||!isObject(add))return origin;var keys=Object.keys(add);var i=keys.length;while(i--){origin[keys[i]]=add[keys[i]];}return origin;};function hasOwnProperty(obj,prop){return Object.prototype.hasOwnProperty.call(obj,prop);}}).call(this,require('_process'),typeof global!=="undefined"?global:typeof self!=="undefined"?self:typeof window!=="undefined"?window:{});},{"./support/isBuffer":108,"_process":72,"inherits":107}],110:[function(require,module,exports){module.exports={"name":"twilio-video","title":"Twilio Video","description":"Twilio Video JavaScript library","version":"1.0.0-beta4","homepage":"https://twilio.com","author":"Mark Andrus Roberts <mroberts@twilio.com>","contributors":["Ryan Rowland <rrowland@twilio.com>","Manjesh Malavalli <mmalavalli@twilio.com>"],"keywords":["twilio","webrtc","library","javascript","video","rooms"],"repository":{"type":"git","url":"https://github.com/twilio/twilio-video.js.git"},"devDependencies":{"browserify":"^9.0.3","cheerio":"^0.18.0","chromedriver":"^2.26.1","eslint":"^2.12.0","ink-docstrap":"^1.3.0","istanbul":"^0.4.5","jsdoc":"^3.4.3","mocha":"^2.2.5","mock-browser":"^0.91.34","npm-run-all":"^4.0.0","phantom":"^2.1.14","release-tool":"^0.2.2","requirejs":"^2.2.0","rimraf":"^2.5.4","selenium-webdriver":"^3.0.1","sinon":"^1.17.7","twilio":"^2.11.1","uglify-js":"^2.7.5","vinyl-fs":"^2.4.4","vinyl-source-stream":"^1.1.0"},"engines":{"node":">=0.12"},"license":"BSD-3-Clause","main":"./lib/index.js","scripts":{"lint":"eslint ./lib","test:unit":"mocha ./test/unit/index.js","test:integration":"mocha ./test/integration/index.js","test:integration:travis":"node ./scripts/integration.js","test:umd":"mocha ./test/umd/index.js","test:framework:angular:install":"cd ./test/framework/twilio-video-angular && rimraf ./node_modules && npm install","test:framework:angular:test":"node ./scripts/framework.js twilio-video-angular","test:framework:angular:run":"mocha ./test/framework/twilio-video-angular.js","test:framework:angular":"npm-run-all test:framework:angular:*","test:framework:meteor:install":"cd ./test/framework/twilio-video-meteor && rimraf ./node_modules && npm install","test:framework:meteor:test":"node ./scripts/framework.js twilio-video-meteor","test:framework:meteor:run":"mocha ./test/framework/twilio-video-meteor.js","test:framework:meteor":"npm-run-all test:framework:meteor:*","test:framework:react:install":"cd ./test/framework/twilio-video-react && rimraf ./node_modules && npm install","test:framework:react:test":"node ./scripts/framework.js twilio-video-react","test:framework:react:build":"cd ./test/framework/twilio-video-react && npm run build","test:framework:react:run":"mocha ./test/framework/twilio-video-react.js","test:framework:react":"npm-run-all test:framework:react:*","test:framework":"npm-run-all test:framework:angular test:framework:meteor test:framework:react","test":"npm-run-all test:unit test:integration","build:js":"node ./scripts/build.js ./src/twilio-video.js ./LICENSE.md ./dist/twilio-video.js","build:min.js":"uglifyjs ./dist/twilio-video.js -o ./dist/twilio-video.min.js --comments \"/^! twilio-video.js/\"","build:test:webrtc":"browserify ./test/webrtc/index.js -o ./test/dist/webrtc.js","build":"npm-run-all clean lint docs cover test:integration build:js build:min.js test:umd","build:travis":"npm-run-all clean lint docs cover test:integration:travis build:js build:min.js test:umd test:framework","docs":"node ./scripts/docs.js ./dist/docs","clean":"rimraf ./coverage ./dist ./test/dist/webrtc.js","cover":"istanbul cover _mocha -- ./test/unit/index.js"},"dependencies":{"sip.js":"twilio/SIP.js.git#420ed46ba6751b32e99950fb6fb84683afb820cc","ws":"^1.0.1","xmlhttprequest":"^1.8.0"},"browser":{"ws":"./src/ws.js","xmlhttprequest":"./src/xmlhttprequest.js"}};},{}],111:[function(require,module,exports){module.exports=WebSocket;},{}],112:[function(require,module,exports){exports.XMLHttpRequest=XMLHttpRequest;},{}]},{},[1]);;var Video=bundle(1);/* globals define */if(true){!(__WEBPACK_AMD_DEFINE_ARRAY__ = [], __WEBPACK_AMD_DEFINE_RESULT__ = function(){return Video;}.apply(exports, __WEBPACK_AMD_DEFINE_ARRAY__),
				__WEBPACK_AMD_DEFINE_RESULT__ !== undefined && (module.exports = __WEBPACK_AMD_DEFINE_RESULT__));}else{var Twilio=root.Twilio=root.Twilio||{};Twilio.Video=Twilio.Video||Video;}})(typeof window!=='undefined'?window:typeof global!=='undefined'?global:this);
/* WEBPACK VAR INJECTION */}.call(exports, __webpack_require__(2), __webpack_require__(36).Buffer))

/***/ }),
/* 34 */
/***/ (function(module, exports, __webpack_require__) {

"use strict";


exports.byteLength = byteLength
exports.toByteArray = toByteArray
exports.fromByteArray = fromByteArray

var lookup = []
var revLookup = []
var Arr = typeof Uint8Array !== 'undefined' ? Uint8Array : Array

var code = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/'
for (var i = 0, len = code.length; i < len; ++i) {
  lookup[i] = code[i]
  revLookup[code.charCodeAt(i)] = i
}

revLookup['-'.charCodeAt(0)] = 62
revLookup['_'.charCodeAt(0)] = 63

function placeHoldersCount (b64) {
  var len = b64.length
  if (len % 4 > 0) {
    throw new Error('Invalid string. Length must be a multiple of 4')
  }

  // the number of equal signs (place holders)
  // if there are two placeholders, than the two characters before it
  // represent one byte
  // if there is only one, then the three characters before it represent 2 bytes
  // this is just a cheap hack to not do indexOf twice
  return b64[len - 2] === '=' ? 2 : b64[len - 1] === '=' ? 1 : 0
}

function byteLength (b64) {
  // base64 is 4/3 + up to two characters of the original data
  return b64.length * 3 / 4 - placeHoldersCount(b64)
}

function toByteArray (b64) {
  var i, j, l, tmp, placeHolders, arr
  var len = b64.length
  placeHolders = placeHoldersCount(b64)

  arr = new Arr(len * 3 / 4 - placeHolders)

  // if there are placeholders, only get up to the last complete 4 chars
  l = placeHolders > 0 ? len - 4 : len

  var L = 0

  for (i = 0, j = 0; i < l; i += 4, j += 3) {
    tmp = (revLookup[b64.charCodeAt(i)] << 18) | (revLookup[b64.charCodeAt(i + 1)] << 12) | (revLookup[b64.charCodeAt(i + 2)] << 6) | revLookup[b64.charCodeAt(i + 3)]
    arr[L++] = (tmp >> 16) & 0xFF
    arr[L++] = (tmp >> 8) & 0xFF
    arr[L++] = tmp & 0xFF
  }

  if (placeHolders === 2) {
    tmp = (revLookup[b64.charCodeAt(i)] << 2) | (revLookup[b64.charCodeAt(i + 1)] >> 4)
    arr[L++] = tmp & 0xFF
  } else if (placeHolders === 1) {
    tmp = (revLookup[b64.charCodeAt(i)] << 10) | (revLookup[b64.charCodeAt(i + 1)] << 4) | (revLookup[b64.charCodeAt(i + 2)] >> 2)
    arr[L++] = (tmp >> 8) & 0xFF
    arr[L++] = tmp & 0xFF
  }

  return arr
}

function tripletToBase64 (num) {
  return lookup[num >> 18 & 0x3F] + lookup[num >> 12 & 0x3F] + lookup[num >> 6 & 0x3F] + lookup[num & 0x3F]
}

function encodeChunk (uint8, start, end) {
  var tmp
  var output = []
  for (var i = start; i < end; i += 3) {
    tmp = (uint8[i] << 16) + (uint8[i + 1] << 8) + (uint8[i + 2])
    output.push(tripletToBase64(tmp))
  }
  return output.join('')
}

function fromByteArray (uint8) {
  var tmp
  var len = uint8.length
  var extraBytes = len % 3 // if we have 1 byte left, pad 2 bytes
  var output = ''
  var parts = []
  var maxChunkLength = 16383 // must be multiple of 3

  // go through the array every three bytes, we'll deal with trailing stuff later
  for (var i = 0, len2 = len - extraBytes; i < len2; i += maxChunkLength) {
    parts.push(encodeChunk(uint8, i, (i + maxChunkLength) > len2 ? len2 : (i + maxChunkLength)))
  }

  // pad the end with zeros, but make sure to not forget the extra bytes
  if (extraBytes === 1) {
    tmp = uint8[len - 1]
    output += lookup[tmp >> 2]
    output += lookup[(tmp << 4) & 0x3F]
    output += '=='
  } else if (extraBytes === 2) {
    tmp = (uint8[len - 2] << 8) + (uint8[len - 1])
    output += lookup[tmp >> 10]
    output += lookup[(tmp >> 4) & 0x3F]
    output += lookup[(tmp << 2) & 0x3F]
    output += '='
  }

  parts.push(output)

  return parts.join('')
}


/***/ }),
/* 35 */,
/* 36 */
/***/ (function(module, exports, __webpack_require__) {

"use strict";
/* WEBPACK VAR INJECTION */(function(global) {/*!
 * The buffer module from node.js, for the browser.
 *
 * @author   Feross Aboukhadijeh <feross@feross.org> <http://feross.org>
 * @license  MIT
 */
/* eslint-disable no-proto */



var base64 = __webpack_require__(34)
var ieee754 = __webpack_require__(38)
var isArray = __webpack_require__(39)

exports.Buffer = Buffer
exports.SlowBuffer = SlowBuffer
exports.INSPECT_MAX_BYTES = 50

/**
 * If `Buffer.TYPED_ARRAY_SUPPORT`:
 *   === true    Use Uint8Array implementation (fastest)
 *   === false   Use Object implementation (most compatible, even IE6)
 *
 * Browsers that support typed arrays are IE 10+, Firefox 4+, Chrome 7+, Safari 5.1+,
 * Opera 11.6+, iOS 4.2+.
 *
 * Due to various browser bugs, sometimes the Object implementation will be used even
 * when the browser supports typed arrays.
 *
 * Note:
 *
 *   - Firefox 4-29 lacks support for adding new properties to `Uint8Array` instances,
 *     See: https://bugzilla.mozilla.org/show_bug.cgi?id=695438.
 *
 *   - Chrome 9-10 is missing the `TypedArray.prototype.subarray` function.
 *
 *   - IE10 has a broken `TypedArray.prototype.subarray` function which returns arrays of
 *     incorrect length in some situations.

 * We detect these buggy browsers and set `Buffer.TYPED_ARRAY_SUPPORT` to `false` so they
 * get the Object implementation, which is slower but behaves correctly.
 */
Buffer.TYPED_ARRAY_SUPPORT = global.TYPED_ARRAY_SUPPORT !== undefined
  ? global.TYPED_ARRAY_SUPPORT
  : typedArraySupport()

/*
 * Export kMaxLength after typed array support is determined.
 */
exports.kMaxLength = kMaxLength()

function typedArraySupport () {
  try {
    var arr = new Uint8Array(1)
    arr.__proto__ = {__proto__: Uint8Array.prototype, foo: function () { return 42 }}
    return arr.foo() === 42 && // typed array instances can be augmented
        typeof arr.subarray === 'function' && // chrome 9-10 lack `subarray`
        arr.subarray(1, 1).byteLength === 0 // ie10 has broken `subarray`
  } catch (e) {
    return false
  }
}

function kMaxLength () {
  return Buffer.TYPED_ARRAY_SUPPORT
    ? 0x7fffffff
    : 0x3fffffff
}

function createBuffer (that, length) {
  if (kMaxLength() < length) {
    throw new RangeError('Invalid typed array length')
  }
  if (Buffer.TYPED_ARRAY_SUPPORT) {
    // Return an augmented `Uint8Array` instance, for best performance
    that = new Uint8Array(length)
    that.__proto__ = Buffer.prototype
  } else {
    // Fallback: Return an object instance of the Buffer class
    if (that === null) {
      that = new Buffer(length)
    }
    that.length = length
  }

  return that
}

/**
 * The Buffer constructor returns instances of `Uint8Array` that have their
 * prototype changed to `Buffer.prototype`. Furthermore, `Buffer` is a subclass of
 * `Uint8Array`, so the returned instances will have all the node `Buffer` methods
 * and the `Uint8Array` methods. Square bracket notation works as expected -- it
 * returns a single octet.
 *
 * The `Uint8Array` prototype remains unmodified.
 */

function Buffer (arg, encodingOrOffset, length) {
  if (!Buffer.TYPED_ARRAY_SUPPORT && !(this instanceof Buffer)) {
    return new Buffer(arg, encodingOrOffset, length)
  }

  // Common case.
  if (typeof arg === 'number') {
    if (typeof encodingOrOffset === 'string') {
      throw new Error(
        'If encoding is specified then the first argument must be a string'
      )
    }
    return allocUnsafe(this, arg)
  }
  return from(this, arg, encodingOrOffset, length)
}

Buffer.poolSize = 8192 // not used by this implementation

// TODO: Legacy, not needed anymore. Remove in next major version.
Buffer._augment = function (arr) {
  arr.__proto__ = Buffer.prototype
  return arr
}

function from (that, value, encodingOrOffset, length) {
  if (typeof value === 'number') {
    throw new TypeError('"value" argument must not be a number')
  }

  if (typeof ArrayBuffer !== 'undefined' && value instanceof ArrayBuffer) {
    return fromArrayBuffer(that, value, encodingOrOffset, length)
  }

  if (typeof value === 'string') {
    return fromString(that, value, encodingOrOffset)
  }

  return fromObject(that, value)
}

/**
 * Functionally equivalent to Buffer(arg, encoding) but throws a TypeError
 * if value is a number.
 * Buffer.from(str[, encoding])
 * Buffer.from(array)
 * Buffer.from(buffer)
 * Buffer.from(arrayBuffer[, byteOffset[, length]])
 **/
Buffer.from = function (value, encodingOrOffset, length) {
  return from(null, value, encodingOrOffset, length)
}

if (Buffer.TYPED_ARRAY_SUPPORT) {
  Buffer.prototype.__proto__ = Uint8Array.prototype
  Buffer.__proto__ = Uint8Array
  if (typeof Symbol !== 'undefined' && Symbol.species &&
      Buffer[Symbol.species] === Buffer) {
    // Fix subarray() in ES2016. See: https://github.com/feross/buffer/pull/97
    Object.defineProperty(Buffer, Symbol.species, {
      value: null,
      configurable: true
    })
  }
}

function assertSize (size) {
  if (typeof size !== 'number') {
    throw new TypeError('"size" argument must be a number')
  } else if (size < 0) {
    throw new RangeError('"size" argument must not be negative')
  }
}

function alloc (that, size, fill, encoding) {
  assertSize(size)
  if (size <= 0) {
    return createBuffer(that, size)
  }
  if (fill !== undefined) {
    // Only pay attention to encoding if it's a string. This
    // prevents accidentally sending in a number that would
    // be interpretted as a start offset.
    return typeof encoding === 'string'
      ? createBuffer(that, size).fill(fill, encoding)
      : createBuffer(that, size).fill(fill)
  }
  return createBuffer(that, size)
}

/**
 * Creates a new filled Buffer instance.
 * alloc(size[, fill[, encoding]])
 **/
Buffer.alloc = function (size, fill, encoding) {
  return alloc(null, size, fill, encoding)
}

function allocUnsafe (that, size) {
  assertSize(size)
  that = createBuffer(that, size < 0 ? 0 : checked(size) | 0)
  if (!Buffer.TYPED_ARRAY_SUPPORT) {
    for (var i = 0; i < size; ++i) {
      that[i] = 0
    }
  }
  return that
}

/**
 * Equivalent to Buffer(num), by default creates a non-zero-filled Buffer instance.
 * */
Buffer.allocUnsafe = function (size) {
  return allocUnsafe(null, size)
}
/**
 * Equivalent to SlowBuffer(num), by default creates a non-zero-filled Buffer instance.
 */
Buffer.allocUnsafeSlow = function (size) {
  return allocUnsafe(null, size)
}

function fromString (that, string, encoding) {
  if (typeof encoding !== 'string' || encoding === '') {
    encoding = 'utf8'
  }

  if (!Buffer.isEncoding(encoding)) {
    throw new TypeError('"encoding" must be a valid string encoding')
  }

  var length = byteLength(string, encoding) | 0
  that = createBuffer(that, length)

  var actual = that.write(string, encoding)

  if (actual !== length) {
    // Writing a hex string, for example, that contains invalid characters will
    // cause everything after the first invalid character to be ignored. (e.g.
    // 'abxxcd' will be treated as 'ab')
    that = that.slice(0, actual)
  }

  return that
}

function fromArrayLike (that, array) {
  var length = array.length < 0 ? 0 : checked(array.length) | 0
  that = createBuffer(that, length)
  for (var i = 0; i < length; i += 1) {
    that[i] = array[i] & 255
  }
  return that
}

function fromArrayBuffer (that, array, byteOffset, length) {
  array.byteLength // this throws if `array` is not a valid ArrayBuffer

  if (byteOffset < 0 || array.byteLength < byteOffset) {
    throw new RangeError('\'offset\' is out of bounds')
  }

  if (array.byteLength < byteOffset + (length || 0)) {
    throw new RangeError('\'length\' is out of bounds')
  }

  if (byteOffset === undefined && length === undefined) {
    array = new Uint8Array(array)
  } else if (length === undefined) {
    array = new Uint8Array(array, byteOffset)
  } else {
    array = new Uint8Array(array, byteOffset, length)
  }

  if (Buffer.TYPED_ARRAY_SUPPORT) {
    // Return an augmented `Uint8Array` instance, for best performance
    that = array
    that.__proto__ = Buffer.prototype
  } else {
    // Fallback: Return an object instance of the Buffer class
    that = fromArrayLike(that, array)
  }
  return that
}

function fromObject (that, obj) {
  if (Buffer.isBuffer(obj)) {
    var len = checked(obj.length) | 0
    that = createBuffer(that, len)

    if (that.length === 0) {
      return that
    }

    obj.copy(that, 0, 0, len)
    return that
  }

  if (obj) {
    if ((typeof ArrayBuffer !== 'undefined' &&
        obj.buffer instanceof ArrayBuffer) || 'length' in obj) {
      if (typeof obj.length !== 'number' || isnan(obj.length)) {
        return createBuffer(that, 0)
      }
      return fromArrayLike(that, obj)
    }

    if (obj.type === 'Buffer' && isArray(obj.data)) {
      return fromArrayLike(that, obj.data)
    }
  }

  throw new TypeError('First argument must be a string, Buffer, ArrayBuffer, Array, or array-like object.')
}

function checked (length) {
  // Note: cannot use `length < kMaxLength()` here because that fails when
  // length is NaN (which is otherwise coerced to zero.)
  if (length >= kMaxLength()) {
    throw new RangeError('Attempt to allocate Buffer larger than maximum ' +
                         'size: 0x' + kMaxLength().toString(16) + ' bytes')
  }
  return length | 0
}

function SlowBuffer (length) {
  if (+length != length) { // eslint-disable-line eqeqeq
    length = 0
  }
  return Buffer.alloc(+length)
}

Buffer.isBuffer = function isBuffer (b) {
  return !!(b != null && b._isBuffer)
}

Buffer.compare = function compare (a, b) {
  if (!Buffer.isBuffer(a) || !Buffer.isBuffer(b)) {
    throw new TypeError('Arguments must be Buffers')
  }

  if (a === b) return 0

  var x = a.length
  var y = b.length

  for (var i = 0, len = Math.min(x, y); i < len; ++i) {
    if (a[i] !== b[i]) {
      x = a[i]
      y = b[i]
      break
    }
  }

  if (x < y) return -1
  if (y < x) return 1
  return 0
}

Buffer.isEncoding = function isEncoding (encoding) {
  switch (String(encoding).toLowerCase()) {
    case 'hex':
    case 'utf8':
    case 'utf-8':
    case 'ascii':
    case 'latin1':
    case 'binary':
    case 'base64':
    case 'ucs2':
    case 'ucs-2':
    case 'utf16le':
    case 'utf-16le':
      return true
    default:
      return false
  }
}

Buffer.concat = function concat (list, length) {
  if (!isArray(list)) {
    throw new TypeError('"list" argument must be an Array of Buffers')
  }

  if (list.length === 0) {
    return Buffer.alloc(0)
  }

  var i
  if (length === undefined) {
    length = 0
    for (i = 0; i < list.length; ++i) {
      length += list[i].length
    }
  }

  var buffer = Buffer.allocUnsafe(length)
  var pos = 0
  for (i = 0; i < list.length; ++i) {
    var buf = list[i]
    if (!Buffer.isBuffer(buf)) {
      throw new TypeError('"list" argument must be an Array of Buffers')
    }
    buf.copy(buffer, pos)
    pos += buf.length
  }
  return buffer
}

function byteLength (string, encoding) {
  if (Buffer.isBuffer(string)) {
    return string.length
  }
  if (typeof ArrayBuffer !== 'undefined' && typeof ArrayBuffer.isView === 'function' &&
      (ArrayBuffer.isView(string) || string instanceof ArrayBuffer)) {
    return string.byteLength
  }
  if (typeof string !== 'string') {
    string = '' + string
  }

  var len = string.length
  if (len === 0) return 0

  // Use a for loop to avoid recursion
  var loweredCase = false
  for (;;) {
    switch (encoding) {
      case 'ascii':
      case 'latin1':
      case 'binary':
        return len
      case 'utf8':
      case 'utf-8':
      case undefined:
        return utf8ToBytes(string).length
      case 'ucs2':
      case 'ucs-2':
      case 'utf16le':
      case 'utf-16le':
        return len * 2
      case 'hex':
        return len >>> 1
      case 'base64':
        return base64ToBytes(string).length
      default:
        if (loweredCase) return utf8ToBytes(string).length // assume utf8
        encoding = ('' + encoding).toLowerCase()
        loweredCase = true
    }
  }
}
Buffer.byteLength = byteLength

function slowToString (encoding, start, end) {
  var loweredCase = false

  // No need to verify that "this.length <= MAX_UINT32" since it's a read-only
  // property of a typed array.

  // This behaves neither like String nor Uint8Array in that we set start/end
  // to their upper/lower bounds if the value passed is out of range.
  // undefined is handled specially as per ECMA-262 6th Edition,
  // Section 13.3.3.7 Runtime Semantics: KeyedBindingInitialization.
  if (start === undefined || start < 0) {
    start = 0
  }
  // Return early if start > this.length. Done here to prevent potential uint32
  // coercion fail below.
  if (start > this.length) {
    return ''
  }

  if (end === undefined || end > this.length) {
    end = this.length
  }

  if (end <= 0) {
    return ''
  }

  // Force coersion to uint32. This will also coerce falsey/NaN values to 0.
  end >>>= 0
  start >>>= 0

  if (end <= start) {
    return ''
  }

  if (!encoding) encoding = 'utf8'

  while (true) {
    switch (encoding) {
      case 'hex':
        return hexSlice(this, start, end)

      case 'utf8':
      case 'utf-8':
        return utf8Slice(this, start, end)

      case 'ascii':
        return asciiSlice(this, start, end)

      case 'latin1':
      case 'binary':
        return latin1Slice(this, start, end)

      case 'base64':
        return base64Slice(this, start, end)

      case 'ucs2':
      case 'ucs-2':
      case 'utf16le':
      case 'utf-16le':
        return utf16leSlice(this, start, end)

      default:
        if (loweredCase) throw new TypeError('Unknown encoding: ' + encoding)
        encoding = (encoding + '').toLowerCase()
        loweredCase = true
    }
  }
}

// The property is used by `Buffer.isBuffer` and `is-buffer` (in Safari 5-7) to detect
// Buffer instances.
Buffer.prototype._isBuffer = true

function swap (b, n, m) {
  var i = b[n]
  b[n] = b[m]
  b[m] = i
}

Buffer.prototype.swap16 = function swap16 () {
  var len = this.length
  if (len % 2 !== 0) {
    throw new RangeError('Buffer size must be a multiple of 16-bits')
  }
  for (var i = 0; i < len; i += 2) {
    swap(this, i, i + 1)
  }
  return this
}

Buffer.prototype.swap32 = function swap32 () {
  var len = this.length
  if (len % 4 !== 0) {
    throw new RangeError('Buffer size must be a multiple of 32-bits')
  }
  for (var i = 0; i < len; i += 4) {
    swap(this, i, i + 3)
    swap(this, i + 1, i + 2)
  }
  return this
}

Buffer.prototype.swap64 = function swap64 () {
  var len = this.length
  if (len % 8 !== 0) {
    throw new RangeError('Buffer size must be a multiple of 64-bits')
  }
  for (var i = 0; i < len; i += 8) {
    swap(this, i, i + 7)
    swap(this, i + 1, i + 6)
    swap(this, i + 2, i + 5)
    swap(this, i + 3, i + 4)
  }
  return this
}

Buffer.prototype.toString = function toString () {
  var length = this.length | 0
  if (length === 0) return ''
  if (arguments.length === 0) return utf8Slice(this, 0, length)
  return slowToString.apply(this, arguments)
}

Buffer.prototype.equals = function equals (b) {
  if (!Buffer.isBuffer(b)) throw new TypeError('Argument must be a Buffer')
  if (this === b) return true
  return Buffer.compare(this, b) === 0
}

Buffer.prototype.inspect = function inspect () {
  var str = ''
  var max = exports.INSPECT_MAX_BYTES
  if (this.length > 0) {
    str = this.toString('hex', 0, max).match(/.{2}/g).join(' ')
    if (this.length > max) str += ' ... '
  }
  return '<Buffer ' + str + '>'
}

Buffer.prototype.compare = function compare (target, start, end, thisStart, thisEnd) {
  if (!Buffer.isBuffer(target)) {
    throw new TypeError('Argument must be a Buffer')
  }

  if (start === undefined) {
    start = 0
  }
  if (end === undefined) {
    end = target ? target.length : 0
  }
  if (thisStart === undefined) {
    thisStart = 0
  }
  if (thisEnd === undefined) {
    thisEnd = this.length
  }

  if (start < 0 || end > target.length || thisStart < 0 || thisEnd > this.length) {
    throw new RangeError('out of range index')
  }

  if (thisStart >= thisEnd && start >= end) {
    return 0
  }
  if (thisStart >= thisEnd) {
    return -1
  }
  if (start >= end) {
    return 1
  }

  start >>>= 0
  end >>>= 0
  thisStart >>>= 0
  thisEnd >>>= 0

  if (this === target) return 0

  var x = thisEnd - thisStart
  var y = end - start
  var len = Math.min(x, y)

  var thisCopy = this.slice(thisStart, thisEnd)
  var targetCopy = target.slice(start, end)

  for (var i = 0; i < len; ++i) {
    if (thisCopy[i] !== targetCopy[i]) {
      x = thisCopy[i]
      y = targetCopy[i]
      break
    }
  }

  if (x < y) return -1
  if (y < x) return 1
  return 0
}

// Finds either the first index of `val` in `buffer` at offset >= `byteOffset`,
// OR the last index of `val` in `buffer` at offset <= `byteOffset`.
//
// Arguments:
// - buffer - a Buffer to search
// - val - a string, Buffer, or number
// - byteOffset - an index into `buffer`; will be clamped to an int32
// - encoding - an optional encoding, relevant is val is a string
// - dir - true for indexOf, false for lastIndexOf
function bidirectionalIndexOf (buffer, val, byteOffset, encoding, dir) {
  // Empty buffer means no match
  if (buffer.length === 0) return -1

  // Normalize byteOffset
  if (typeof byteOffset === 'string') {
    encoding = byteOffset
    byteOffset = 0
  } else if (byteOffset > 0x7fffffff) {
    byteOffset = 0x7fffffff
  } else if (byteOffset < -0x80000000) {
    byteOffset = -0x80000000
  }
  byteOffset = +byteOffset  // Coerce to Number.
  if (isNaN(byteOffset)) {
    // byteOffset: it it's undefined, null, NaN, "foo", etc, search whole buffer
    byteOffset = dir ? 0 : (buffer.length - 1)
  }

  // Normalize byteOffset: negative offsets start from the end of the buffer
  if (byteOffset < 0) byteOffset = buffer.length + byteOffset
  if (byteOffset >= buffer.length) {
    if (dir) return -1
    else byteOffset = buffer.length - 1
  } else if (byteOffset < 0) {
    if (dir) byteOffset = 0
    else return -1
  }

  // Normalize val
  if (typeof val === 'string') {
    val = Buffer.from(val, encoding)
  }

  // Finally, search either indexOf (if dir is true) or lastIndexOf
  if (Buffer.isBuffer(val)) {
    // Special case: looking for empty string/buffer always fails
    if (val.length === 0) {
      return -1
    }
    return arrayIndexOf(buffer, val, byteOffset, encoding, dir)
  } else if (typeof val === 'number') {
    val = val & 0xFF // Search for a byte value [0-255]
    if (Buffer.TYPED_ARRAY_SUPPORT &&
        typeof Uint8Array.prototype.indexOf === 'function') {
      if (dir) {
        return Uint8Array.prototype.indexOf.call(buffer, val, byteOffset)
      } else {
        return Uint8Array.prototype.lastIndexOf.call(buffer, val, byteOffset)
      }
    }
    return arrayIndexOf(buffer, [ val ], byteOffset, encoding, dir)
  }

  throw new TypeError('val must be string, number or Buffer')
}

function arrayIndexOf (arr, val, byteOffset, encoding, dir) {
  var indexSize = 1
  var arrLength = arr.length
  var valLength = val.length

  if (encoding !== undefined) {
    encoding = String(encoding).toLowerCase()
    if (encoding === 'ucs2' || encoding === 'ucs-2' ||
        encoding === 'utf16le' || encoding === 'utf-16le') {
      if (arr.length < 2 || val.length < 2) {
        return -1
      }
      indexSize = 2
      arrLength /= 2
      valLength /= 2
      byteOffset /= 2
    }
  }

  function read (buf, i) {
    if (indexSize === 1) {
      return buf[i]
    } else {
      return buf.readUInt16BE(i * indexSize)
    }
  }

  var i
  if (dir) {
    var foundIndex = -1
    for (i = byteOffset; i < arrLength; i++) {
      if (read(arr, i) === read(val, foundIndex === -1 ? 0 : i - foundIndex)) {
        if (foundIndex === -1) foundIndex = i
        if (i - foundIndex + 1 === valLength) return foundIndex * indexSize
      } else {
        if (foundIndex !== -1) i -= i - foundIndex
        foundIndex = -1
      }
    }
  } else {
    if (byteOffset + valLength > arrLength) byteOffset = arrLength - valLength
    for (i = byteOffset; i >= 0; i--) {
      var found = true
      for (var j = 0; j < valLength; j++) {
        if (read(arr, i + j) !== read(val, j)) {
          found = false
          break
        }
      }
      if (found) return i
    }
  }

  return -1
}

Buffer.prototype.includes = function includes (val, byteOffset, encoding) {
  return this.indexOf(val, byteOffset, encoding) !== -1
}

Buffer.prototype.indexOf = function indexOf (val, byteOffset, encoding) {
  return bidirectionalIndexOf(this, val, byteOffset, encoding, true)
}

Buffer.prototype.lastIndexOf = function lastIndexOf (val, byteOffset, encoding) {
  return bidirectionalIndexOf(this, val, byteOffset, encoding, false)
}

function hexWrite (buf, string, offset, length) {
  offset = Number(offset) || 0
  var remaining = buf.length - offset
  if (!length) {
    length = remaining
  } else {
    length = Number(length)
    if (length > remaining) {
      length = remaining
    }
  }

  // must be an even number of digits
  var strLen = string.length
  if (strLen % 2 !== 0) throw new TypeError('Invalid hex string')

  if (length > strLen / 2) {
    length = strLen / 2
  }
  for (var i = 0; i < length; ++i) {
    var parsed = parseInt(string.substr(i * 2, 2), 16)
    if (isNaN(parsed)) return i
    buf[offset + i] = parsed
  }
  return i
}

function utf8Write (buf, string, offset, length) {
  return blitBuffer(utf8ToBytes(string, buf.length - offset), buf, offset, length)
}

function asciiWrite (buf, string, offset, length) {
  return blitBuffer(asciiToBytes(string), buf, offset, length)
}

function latin1Write (buf, string, offset, length) {
  return asciiWrite(buf, string, offset, length)
}

function base64Write (buf, string, offset, length) {
  return blitBuffer(base64ToBytes(string), buf, offset, length)
}

function ucs2Write (buf, string, offset, length) {
  return blitBuffer(utf16leToBytes(string, buf.length - offset), buf, offset, length)
}

Buffer.prototype.write = function write (string, offset, length, encoding) {
  // Buffer#write(string)
  if (offset === undefined) {
    encoding = 'utf8'
    length = this.length
    offset = 0
  // Buffer#write(string, encoding)
  } else if (length === undefined && typeof offset === 'string') {
    encoding = offset
    length = this.length
    offset = 0
  // Buffer#write(string, offset[, length][, encoding])
  } else if (isFinite(offset)) {
    offset = offset | 0
    if (isFinite(length)) {
      length = length | 0
      if (encoding === undefined) encoding = 'utf8'
    } else {
      encoding = length
      length = undefined
    }
  // legacy write(string, encoding, offset, length) - remove in v0.13
  } else {
    throw new Error(
      'Buffer.write(string, encoding, offset[, length]) is no longer supported'
    )
  }

  var remaining = this.length - offset
  if (length === undefined || length > remaining) length = remaining

  if ((string.length > 0 && (length < 0 || offset < 0)) || offset > this.length) {
    throw new RangeError('Attempt to write outside buffer bounds')
  }

  if (!encoding) encoding = 'utf8'

  var loweredCase = false
  for (;;) {
    switch (encoding) {
      case 'hex':
        return hexWrite(this, string, offset, length)

      case 'utf8':
      case 'utf-8':
        return utf8Write(this, string, offset, length)

      case 'ascii':
        return asciiWrite(this, string, offset, length)

      case 'latin1':
      case 'binary':
        return latin1Write(this, string, offset, length)

      case 'base64':
        // Warning: maxLength not taken into account in base64Write
        return base64Write(this, string, offset, length)

      case 'ucs2':
      case 'ucs-2':
      case 'utf16le':
      case 'utf-16le':
        return ucs2Write(this, string, offset, length)

      default:
        if (loweredCase) throw new TypeError('Unknown encoding: ' + encoding)
        encoding = ('' + encoding).toLowerCase()
        loweredCase = true
    }
  }
}

Buffer.prototype.toJSON = function toJSON () {
  return {
    type: 'Buffer',
    data: Array.prototype.slice.call(this._arr || this, 0)
  }
}

function base64Slice (buf, start, end) {
  if (start === 0 && end === buf.length) {
    return base64.fromByteArray(buf)
  } else {
    return base64.fromByteArray(buf.slice(start, end))
  }
}

function utf8Slice (buf, start, end) {
  end = Math.min(buf.length, end)
  var res = []

  var i = start
  while (i < end) {
    var firstByte = buf[i]
    var codePoint = null
    var bytesPerSequence = (firstByte > 0xEF) ? 4
      : (firstByte > 0xDF) ? 3
      : (firstByte > 0xBF) ? 2
      : 1

    if (i + bytesPerSequence <= end) {
      var secondByte, thirdByte, fourthByte, tempCodePoint

      switch (bytesPerSequence) {
        case 1:
          if (firstByte < 0x80) {
            codePoint = firstByte
          }
          break
        case 2:
          secondByte = buf[i + 1]
          if ((secondByte & 0xC0) === 0x80) {
            tempCodePoint = (firstByte & 0x1F) << 0x6 | (secondByte & 0x3F)
            if (tempCodePoint > 0x7F) {
              codePoint = tempCodePoint
            }
          }
          break
        case 3:
          secondByte = buf[i + 1]
          thirdByte = buf[i + 2]
          if ((secondByte & 0xC0) === 0x80 && (thirdByte & 0xC0) === 0x80) {
            tempCodePoint = (firstByte & 0xF) << 0xC | (secondByte & 0x3F) << 0x6 | (thirdByte & 0x3F)
            if (tempCodePoint > 0x7FF && (tempCodePoint < 0xD800 || tempCodePoint > 0xDFFF)) {
              codePoint = tempCodePoint
            }
          }
          break
        case 4:
          secondByte = buf[i + 1]
          thirdByte = buf[i + 2]
          fourthByte = buf[i + 3]
          if ((secondByte & 0xC0) === 0x80 && (thirdByte & 0xC0) === 0x80 && (fourthByte & 0xC0) === 0x80) {
            tempCodePoint = (firstByte & 0xF) << 0x12 | (secondByte & 0x3F) << 0xC | (thirdByte & 0x3F) << 0x6 | (fourthByte & 0x3F)
            if (tempCodePoint > 0xFFFF && tempCodePoint < 0x110000) {
              codePoint = tempCodePoint
            }
          }
      }
    }

    if (codePoint === null) {
      // we did not generate a valid codePoint so insert a
      // replacement char (U+FFFD) and advance only 1 byte
      codePoint = 0xFFFD
      bytesPerSequence = 1
    } else if (codePoint > 0xFFFF) {
      // encode to utf16 (surrogate pair dance)
      codePoint -= 0x10000
      res.push(codePoint >>> 10 & 0x3FF | 0xD800)
      codePoint = 0xDC00 | codePoint & 0x3FF
    }

    res.push(codePoint)
    i += bytesPerSequence
  }

  return decodeCodePointsArray(res)
}

// Based on http://stackoverflow.com/a/22747272/680742, the browser with
// the lowest limit is Chrome, with 0x10000 args.
// We go 1 magnitude less, for safety
var MAX_ARGUMENTS_LENGTH = 0x1000

function decodeCodePointsArray (codePoints) {
  var len = codePoints.length
  if (len <= MAX_ARGUMENTS_LENGTH) {
    return String.fromCharCode.apply(String, codePoints) // avoid extra slice()
  }

  // Decode in chunks to avoid "call stack size exceeded".
  var res = ''
  var i = 0
  while (i < len) {
    res += String.fromCharCode.apply(
      String,
      codePoints.slice(i, i += MAX_ARGUMENTS_LENGTH)
    )
  }
  return res
}

function asciiSlice (buf, start, end) {
  var ret = ''
  end = Math.min(buf.length, end)

  for (var i = start; i < end; ++i) {
    ret += String.fromCharCode(buf[i] & 0x7F)
  }
  return ret
}

function latin1Slice (buf, start, end) {
  var ret = ''
  end = Math.min(buf.length, end)

  for (var i = start; i < end; ++i) {
    ret += String.fromCharCode(buf[i])
  }
  return ret
}

function hexSlice (buf, start, end) {
  var len = buf.length

  if (!start || start < 0) start = 0
  if (!end || end < 0 || end > len) end = len

  var out = ''
  for (var i = start; i < end; ++i) {
    out += toHex(buf[i])
  }
  return out
}

function utf16leSlice (buf, start, end) {
  var bytes = buf.slice(start, end)
  var res = ''
  for (var i = 0; i < bytes.length; i += 2) {
    res += String.fromCharCode(bytes[i] + bytes[i + 1] * 256)
  }
  return res
}

Buffer.prototype.slice = function slice (start, end) {
  var len = this.length
  start = ~~start
  end = end === undefined ? len : ~~end

  if (start < 0) {
    start += len
    if (start < 0) start = 0
  } else if (start > len) {
    start = len
  }

  if (end < 0) {
    end += len
    if (end < 0) end = 0
  } else if (end > len) {
    end = len
  }

  if (end < start) end = start

  var newBuf
  if (Buffer.TYPED_ARRAY_SUPPORT) {
    newBuf = this.subarray(start, end)
    newBuf.__proto__ = Buffer.prototype
  } else {
    var sliceLen = end - start
    newBuf = new Buffer(sliceLen, undefined)
    for (var i = 0; i < sliceLen; ++i) {
      newBuf[i] = this[i + start]
    }
  }

  return newBuf
}

/*
 * Need to make sure that buffer isn't trying to write out of bounds.
 */
function checkOffset (offset, ext, length) {
  if ((offset % 1) !== 0 || offset < 0) throw new RangeError('offset is not uint')
  if (offset + ext > length) throw new RangeError('Trying to access beyond buffer length')
}

Buffer.prototype.readUIntLE = function readUIntLE (offset, byteLength, noAssert) {
  offset = offset | 0
  byteLength = byteLength | 0
  if (!noAssert) checkOffset(offset, byteLength, this.length)

  var val = this[offset]
  var mul = 1
  var i = 0
  while (++i < byteLength && (mul *= 0x100)) {
    val += this[offset + i] * mul
  }

  return val
}

Buffer.prototype.readUIntBE = function readUIntBE (offset, byteLength, noAssert) {
  offset = offset | 0
  byteLength = byteLength | 0
  if (!noAssert) {
    checkOffset(offset, byteLength, this.length)
  }

  var val = this[offset + --byteLength]
  var mul = 1
  while (byteLength > 0 && (mul *= 0x100)) {
    val += this[offset + --byteLength] * mul
  }

  return val
}

Buffer.prototype.readUInt8 = function readUInt8 (offset, noAssert) {
  if (!noAssert) checkOffset(offset, 1, this.length)
  return this[offset]
}

Buffer.prototype.readUInt16LE = function readUInt16LE (offset, noAssert) {
  if (!noAssert) checkOffset(offset, 2, this.length)
  return this[offset] | (this[offset + 1] << 8)
}

Buffer.prototype.readUInt16BE = function readUInt16BE (offset, noAssert) {
  if (!noAssert) checkOffset(offset, 2, this.length)
  return (this[offset] << 8) | this[offset + 1]
}

Buffer.prototype.readUInt32LE = function readUInt32LE (offset, noAssert) {
  if (!noAssert) checkOffset(offset, 4, this.length)

  return ((this[offset]) |
      (this[offset + 1] << 8) |
      (this[offset + 2] << 16)) +
      (this[offset + 3] * 0x1000000)
}

Buffer.prototype.readUInt32BE = function readUInt32BE (offset, noAssert) {
  if (!noAssert) checkOffset(offset, 4, this.length)

  return (this[offset] * 0x1000000) +
    ((this[offset + 1] << 16) |
    (this[offset + 2] << 8) |
    this[offset + 3])
}

Buffer.prototype.readIntLE = function readIntLE (offset, byteLength, noAssert) {
  offset = offset | 0
  byteLength = byteLength | 0
  if (!noAssert) checkOffset(offset, byteLength, this.length)

  var val = this[offset]
  var mul = 1
  var i = 0
  while (++i < byteLength && (mul *= 0x100)) {
    val += this[offset + i] * mul
  }
  mul *= 0x80

  if (val >= mul) val -= Math.pow(2, 8 * byteLength)

  return val
}

Buffer.prototype.readIntBE = function readIntBE (offset, byteLength, noAssert) {
  offset = offset | 0
  byteLength = byteLength | 0
  if (!noAssert) checkOffset(offset, byteLength, this.length)

  var i = byteLength
  var mul = 1
  var val = this[offset + --i]
  while (i > 0 && (mul *= 0x100)) {
    val += this[offset + --i] * mul
  }
  mul *= 0x80

  if (val >= mul) val -= Math.pow(2, 8 * byteLength)

  return val
}

Buffer.prototype.readInt8 = function readInt8 (offset, noAssert) {
  if (!noAssert) checkOffset(offset, 1, this.length)
  if (!(this[offset] & 0x80)) return (this[offset])
  return ((0xff - this[offset] + 1) * -1)
}

Buffer.prototype.readInt16LE = function readInt16LE (offset, noAssert) {
  if (!noAssert) checkOffset(offset, 2, this.length)
  var val = this[offset] | (this[offset + 1] << 8)
  return (val & 0x8000) ? val | 0xFFFF0000 : val
}

Buffer.prototype.readInt16BE = function readInt16BE (offset, noAssert) {
  if (!noAssert) checkOffset(offset, 2, this.length)
  var val = this[offset + 1] | (this[offset] << 8)
  return (val & 0x8000) ? val | 0xFFFF0000 : val
}

Buffer.prototype.readInt32LE = function readInt32LE (offset, noAssert) {
  if (!noAssert) checkOffset(offset, 4, this.length)

  return (this[offset]) |
    (this[offset + 1] << 8) |
    (this[offset + 2] << 16) |
    (this[offset + 3] << 24)
}

Buffer.prototype.readInt32BE = function readInt32BE (offset, noAssert) {
  if (!noAssert) checkOffset(offset, 4, this.length)

  return (this[offset] << 24) |
    (this[offset + 1] << 16) |
    (this[offset + 2] << 8) |
    (this[offset + 3])
}

Buffer.prototype.readFloatLE = function readFloatLE (offset, noAssert) {
  if (!noAssert) checkOffset(offset, 4, this.length)
  return ieee754.read(this, offset, true, 23, 4)
}

Buffer.prototype.readFloatBE = function readFloatBE (offset, noAssert) {
  if (!noAssert) checkOffset(offset, 4, this.length)
  return ieee754.read(this, offset, false, 23, 4)
}

Buffer.prototype.readDoubleLE = function readDoubleLE (offset, noAssert) {
  if (!noAssert) checkOffset(offset, 8, this.length)
  return ieee754.read(this, offset, true, 52, 8)
}

Buffer.prototype.readDoubleBE = function readDoubleBE (offset, noAssert) {
  if (!noAssert) checkOffset(offset, 8, this.length)
  return ieee754.read(this, offset, false, 52, 8)
}

function checkInt (buf, value, offset, ext, max, min) {
  if (!Buffer.isBuffer(buf)) throw new TypeError('"buffer" argument must be a Buffer instance')
  if (value > max || value < min) throw new RangeError('"value" argument is out of bounds')
  if (offset + ext > buf.length) throw new RangeError('Index out of range')
}

Buffer.prototype.writeUIntLE = function writeUIntLE (value, offset, byteLength, noAssert) {
  value = +value
  offset = offset | 0
  byteLength = byteLength | 0
  if (!noAssert) {
    var maxBytes = Math.pow(2, 8 * byteLength) - 1
    checkInt(this, value, offset, byteLength, maxBytes, 0)
  }

  var mul = 1
  var i = 0
  this[offset] = value & 0xFF
  while (++i < byteLength && (mul *= 0x100)) {
    this[offset + i] = (value / mul) & 0xFF
  }

  return offset + byteLength
}

Buffer.prototype.writeUIntBE = function writeUIntBE (value, offset, byteLength, noAssert) {
  value = +value
  offset = offset | 0
  byteLength = byteLength | 0
  if (!noAssert) {
    var maxBytes = Math.pow(2, 8 * byteLength) - 1
    checkInt(this, value, offset, byteLength, maxBytes, 0)
  }

  var i = byteLength - 1
  var mul = 1
  this[offset + i] = value & 0xFF
  while (--i >= 0 && (mul *= 0x100)) {
    this[offset + i] = (value / mul) & 0xFF
  }

  return offset + byteLength
}

Buffer.prototype.writeUInt8 = function writeUInt8 (value, offset, noAssert) {
  value = +value
  offset = offset | 0
  if (!noAssert) checkInt(this, value, offset, 1, 0xff, 0)
  if (!Buffer.TYPED_ARRAY_SUPPORT) value = Math.floor(value)
  this[offset] = (value & 0xff)
  return offset + 1
}

function objectWriteUInt16 (buf, value, offset, littleEndian) {
  if (value < 0) value = 0xffff + value + 1
  for (var i = 0, j = Math.min(buf.length - offset, 2); i < j; ++i) {
    buf[offset + i] = (value & (0xff << (8 * (littleEndian ? i : 1 - i)))) >>>
      (littleEndian ? i : 1 - i) * 8
  }
}

Buffer.prototype.writeUInt16LE = function writeUInt16LE (value, offset, noAssert) {
  value = +value
  offset = offset | 0
  if (!noAssert) checkInt(this, value, offset, 2, 0xffff, 0)
  if (Buffer.TYPED_ARRAY_SUPPORT) {
    this[offset] = (value & 0xff)
    this[offset + 1] = (value >>> 8)
  } else {
    objectWriteUInt16(this, value, offset, true)
  }
  return offset + 2
}

Buffer.prototype.writeUInt16BE = function writeUInt16BE (value, offset, noAssert) {
  value = +value
  offset = offset | 0
  if (!noAssert) checkInt(this, value, offset, 2, 0xffff, 0)
  if (Buffer.TYPED_ARRAY_SUPPORT) {
    this[offset] = (value >>> 8)
    this[offset + 1] = (value & 0xff)
  } else {
    objectWriteUInt16(this, value, offset, false)
  }
  return offset + 2
}

function objectWriteUInt32 (buf, value, offset, littleEndian) {
  if (value < 0) value = 0xffffffff + value + 1
  for (var i = 0, j = Math.min(buf.length - offset, 4); i < j; ++i) {
    buf[offset + i] = (value >>> (littleEndian ? i : 3 - i) * 8) & 0xff
  }
}

Buffer.prototype.writeUInt32LE = function writeUInt32LE (value, offset, noAssert) {
  value = +value
  offset = offset | 0
  if (!noAssert) checkInt(this, value, offset, 4, 0xffffffff, 0)
  if (Buffer.TYPED_ARRAY_SUPPORT) {
    this[offset + 3] = (value >>> 24)
    this[offset + 2] = (value >>> 16)
    this[offset + 1] = (value >>> 8)
    this[offset] = (value & 0xff)
  } else {
    objectWriteUInt32(this, value, offset, true)
  }
  return offset + 4
}

Buffer.prototype.writeUInt32BE = function writeUInt32BE (value, offset, noAssert) {
  value = +value
  offset = offset | 0
  if (!noAssert) checkInt(this, value, offset, 4, 0xffffffff, 0)
  if (Buffer.TYPED_ARRAY_SUPPORT) {
    this[offset] = (value >>> 24)
    this[offset + 1] = (value >>> 16)
    this[offset + 2] = (value >>> 8)
    this[offset + 3] = (value & 0xff)
  } else {
    objectWriteUInt32(this, value, offset, false)
  }
  return offset + 4
}

Buffer.prototype.writeIntLE = function writeIntLE (value, offset, byteLength, noAssert) {
  value = +value
  offset = offset | 0
  if (!noAssert) {
    var limit = Math.pow(2, 8 * byteLength - 1)

    checkInt(this, value, offset, byteLength, limit - 1, -limit)
  }

  var i = 0
  var mul = 1
  var sub = 0
  this[offset] = value & 0xFF
  while (++i < byteLength && (mul *= 0x100)) {
    if (value < 0 && sub === 0 && this[offset + i - 1] !== 0) {
      sub = 1
    }
    this[offset + i] = ((value / mul) >> 0) - sub & 0xFF
  }

  return offset + byteLength
}

Buffer.prototype.writeIntBE = function writeIntBE (value, offset, byteLength, noAssert) {
  value = +value
  offset = offset | 0
  if (!noAssert) {
    var limit = Math.pow(2, 8 * byteLength - 1)

    checkInt(this, value, offset, byteLength, limit - 1, -limit)
  }

  var i = byteLength - 1
  var mul = 1
  var sub = 0
  this[offset + i] = value & 0xFF
  while (--i >= 0 && (mul *= 0x100)) {
    if (value < 0 && sub === 0 && this[offset + i + 1] !== 0) {
      sub = 1
    }
    this[offset + i] = ((value / mul) >> 0) - sub & 0xFF
  }

  return offset + byteLength
}

Buffer.prototype.writeInt8 = function writeInt8 (value, offset, noAssert) {
  value = +value
  offset = offset | 0
  if (!noAssert) checkInt(this, value, offset, 1, 0x7f, -0x80)
  if (!Buffer.TYPED_ARRAY_SUPPORT) value = Math.floor(value)
  if (value < 0) value = 0xff + value + 1
  this[offset] = (value & 0xff)
  return offset + 1
}

Buffer.prototype.writeInt16LE = function writeInt16LE (value, offset, noAssert) {
  value = +value
  offset = offset | 0
  if (!noAssert) checkInt(this, value, offset, 2, 0x7fff, -0x8000)
  if (Buffer.TYPED_ARRAY_SUPPORT) {
    this[offset] = (value & 0xff)
    this[offset + 1] = (value >>> 8)
  } else {
    objectWriteUInt16(this, value, offset, true)
  }
  return offset + 2
}

Buffer.prototype.writeInt16BE = function writeInt16BE (value, offset, noAssert) {
  value = +value
  offset = offset | 0
  if (!noAssert) checkInt(this, value, offset, 2, 0x7fff, -0x8000)
  if (Buffer.TYPED_ARRAY_SUPPORT) {
    this[offset] = (value >>> 8)
    this[offset + 1] = (value & 0xff)
  } else {
    objectWriteUInt16(this, value, offset, false)
  }
  return offset + 2
}

Buffer.prototype.writeInt32LE = function writeInt32LE (value, offset, noAssert) {
  value = +value
  offset = offset | 0
  if (!noAssert) checkInt(this, value, offset, 4, 0x7fffffff, -0x80000000)
  if (Buffer.TYPED_ARRAY_SUPPORT) {
    this[offset] = (value & 0xff)
    this[offset + 1] = (value >>> 8)
    this[offset + 2] = (value >>> 16)
    this[offset + 3] = (value >>> 24)
  } else {
    objectWriteUInt32(this, value, offset, true)
  }
  return offset + 4
}

Buffer.prototype.writeInt32BE = function writeInt32BE (value, offset, noAssert) {
  value = +value
  offset = offset | 0
  if (!noAssert) checkInt(this, value, offset, 4, 0x7fffffff, -0x80000000)
  if (value < 0) value = 0xffffffff + value + 1
  if (Buffer.TYPED_ARRAY_SUPPORT) {
    this[offset] = (value >>> 24)
    this[offset + 1] = (value >>> 16)
    this[offset + 2] = (value >>> 8)
    this[offset + 3] = (value & 0xff)
  } else {
    objectWriteUInt32(this, value, offset, false)
  }
  return offset + 4
}

function checkIEEE754 (buf, value, offset, ext, max, min) {
  if (offset + ext > buf.length) throw new RangeError('Index out of range')
  if (offset < 0) throw new RangeError('Index out of range')
}

function writeFloat (buf, value, offset, littleEndian, noAssert) {
  if (!noAssert) {
    checkIEEE754(buf, value, offset, 4, 3.4028234663852886e+38, -3.4028234663852886e+38)
  }
  ieee754.write(buf, value, offset, littleEndian, 23, 4)
  return offset + 4
}

Buffer.prototype.writeFloatLE = function writeFloatLE (value, offset, noAssert) {
  return writeFloat(this, value, offset, true, noAssert)
}

Buffer.prototype.writeFloatBE = function writeFloatBE (value, offset, noAssert) {
  return writeFloat(this, value, offset, false, noAssert)
}

function writeDouble (buf, value, offset, littleEndian, noAssert) {
  if (!noAssert) {
    checkIEEE754(buf, value, offset, 8, 1.7976931348623157E+308, -1.7976931348623157E+308)
  }
  ieee754.write(buf, value, offset, littleEndian, 52, 8)
  return offset + 8
}

Buffer.prototype.writeDoubleLE = function writeDoubleLE (value, offset, noAssert) {
  return writeDouble(this, value, offset, true, noAssert)
}

Buffer.prototype.writeDoubleBE = function writeDoubleBE (value, offset, noAssert) {
  return writeDouble(this, value, offset, false, noAssert)
}

// copy(targetBuffer, targetStart=0, sourceStart=0, sourceEnd=buffer.length)
Buffer.prototype.copy = function copy (target, targetStart, start, end) {
  if (!start) start = 0
  if (!end && end !== 0) end = this.length
  if (targetStart >= target.length) targetStart = target.length
  if (!targetStart) targetStart = 0
  if (end > 0 && end < start) end = start

  // Copy 0 bytes; we're done
  if (end === start) return 0
  if (target.length === 0 || this.length === 0) return 0

  // Fatal error conditions
  if (targetStart < 0) {
    throw new RangeError('targetStart out of bounds')
  }
  if (start < 0 || start >= this.length) throw new RangeError('sourceStart out of bounds')
  if (end < 0) throw new RangeError('sourceEnd out of bounds')

  // Are we oob?
  if (end > this.length) end = this.length
  if (target.length - targetStart < end - start) {
    end = target.length - targetStart + start
  }

  var len = end - start
  var i

  if (this === target && start < targetStart && targetStart < end) {
    // descending copy from end
    for (i = len - 1; i >= 0; --i) {
      target[i + targetStart] = this[i + start]
    }
  } else if (len < 1000 || !Buffer.TYPED_ARRAY_SUPPORT) {
    // ascending copy from start
    for (i = 0; i < len; ++i) {
      target[i + targetStart] = this[i + start]
    }
  } else {
    Uint8Array.prototype.set.call(
      target,
      this.subarray(start, start + len),
      targetStart
    )
  }

  return len
}

// Usage:
//    buffer.fill(number[, offset[, end]])
//    buffer.fill(buffer[, offset[, end]])
//    buffer.fill(string[, offset[, end]][, encoding])
Buffer.prototype.fill = function fill (val, start, end, encoding) {
  // Handle string cases:
  if (typeof val === 'string') {
    if (typeof start === 'string') {
      encoding = start
      start = 0
      end = this.length
    } else if (typeof end === 'string') {
      encoding = end
      end = this.length
    }
    if (val.length === 1) {
      var code = val.charCodeAt(0)
      if (code < 256) {
        val = code
      }
    }
    if (encoding !== undefined && typeof encoding !== 'string') {
      throw new TypeError('encoding must be a string')
    }
    if (typeof encoding === 'string' && !Buffer.isEncoding(encoding)) {
      throw new TypeError('Unknown encoding: ' + encoding)
    }
  } else if (typeof val === 'number') {
    val = val & 255
  }

  // Invalid ranges are not set to a default, so can range check early.
  if (start < 0 || this.length < start || this.length < end) {
    throw new RangeError('Out of range index')
  }

  if (end <= start) {
    return this
  }

  start = start >>> 0
  end = end === undefined ? this.length : end >>> 0

  if (!val) val = 0

  var i
  if (typeof val === 'number') {
    for (i = start; i < end; ++i) {
      this[i] = val
    }
  } else {
    var bytes = Buffer.isBuffer(val)
      ? val
      : utf8ToBytes(new Buffer(val, encoding).toString())
    var len = bytes.length
    for (i = 0; i < end - start; ++i) {
      this[i + start] = bytes[i % len]
    }
  }

  return this
}

// HELPER FUNCTIONS
// ================

var INVALID_BASE64_RE = /[^+\/0-9A-Za-z-_]/g

function base64clean (str) {
  // Node strips out invalid characters like \n and \t from the string, base64-js does not
  str = stringtrim(str).replace(INVALID_BASE64_RE, '')
  // Node converts strings with length < 2 to ''
  if (str.length < 2) return ''
  // Node allows for non-padded base64 strings (missing trailing ===), base64-js does not
  while (str.length % 4 !== 0) {
    str = str + '='
  }
  return str
}

function stringtrim (str) {
  if (str.trim) return str.trim()
  return str.replace(/^\s+|\s+$/g, '')
}

function toHex (n) {
  if (n < 16) return '0' + n.toString(16)
  return n.toString(16)
}

function utf8ToBytes (string, units) {
  units = units || Infinity
  var codePoint
  var length = string.length
  var leadSurrogate = null
  var bytes = []

  for (var i = 0; i < length; ++i) {
    codePoint = string.charCodeAt(i)

    // is surrogate component
    if (codePoint > 0xD7FF && codePoint < 0xE000) {
      // last char was a lead
      if (!leadSurrogate) {
        // no lead yet
        if (codePoint > 0xDBFF) {
          // unexpected trail
          if ((units -= 3) > -1) bytes.push(0xEF, 0xBF, 0xBD)
          continue
        } else if (i + 1 === length) {
          // unpaired lead
          if ((units -= 3) > -1) bytes.push(0xEF, 0xBF, 0xBD)
          continue
        }

        // valid lead
        leadSurrogate = codePoint

        continue
      }

      // 2 leads in a row
      if (codePoint < 0xDC00) {
        if ((units -= 3) > -1) bytes.push(0xEF, 0xBF, 0xBD)
        leadSurrogate = codePoint
        continue
      }

      // valid surrogate pair
      codePoint = (leadSurrogate - 0xD800 << 10 | codePoint - 0xDC00) + 0x10000
    } else if (leadSurrogate) {
      // valid bmp char, but last char was a lead
      if ((units -= 3) > -1) bytes.push(0xEF, 0xBF, 0xBD)
    }

    leadSurrogate = null

    // encode utf8
    if (codePoint < 0x80) {
      if ((units -= 1) < 0) break
      bytes.push(codePoint)
    } else if (codePoint < 0x800) {
      if ((units -= 2) < 0) break
      bytes.push(
        codePoint >> 0x6 | 0xC0,
        codePoint & 0x3F | 0x80
      )
    } else if (codePoint < 0x10000) {
      if ((units -= 3) < 0) break
      bytes.push(
        codePoint >> 0xC | 0xE0,
        codePoint >> 0x6 & 0x3F | 0x80,
        codePoint & 0x3F | 0x80
      )
    } else if (codePoint < 0x110000) {
      if ((units -= 4) < 0) break
      bytes.push(
        codePoint >> 0x12 | 0xF0,
        codePoint >> 0xC & 0x3F | 0x80,
        codePoint >> 0x6 & 0x3F | 0x80,
        codePoint & 0x3F | 0x80
      )
    } else {
      throw new Error('Invalid code point')
    }
  }

  return bytes
}

function asciiToBytes (str) {
  var byteArray = []
  for (var i = 0; i < str.length; ++i) {
    // Node's code seems to be doing this and not & 0x7F..
    byteArray.push(str.charCodeAt(i) & 0xFF)
  }
  return byteArray
}

function utf16leToBytes (str, units) {
  var c, hi, lo
  var byteArray = []
  for (var i = 0; i < str.length; ++i) {
    if ((units -= 2) < 0) break

    c = str.charCodeAt(i)
    hi = c >> 8
    lo = c % 256
    byteArray.push(lo)
    byteArray.push(hi)
  }

  return byteArray
}

function base64ToBytes (str) {
  return base64.toByteArray(base64clean(str))
}

function blitBuffer (src, dst, offset, length) {
  for (var i = 0; i < length; ++i) {
    if ((i + offset >= dst.length) || (i >= src.length)) break
    dst[i + offset] = src[i]
  }
  return i
}

function isnan (val) {
  return val !== val // eslint-disable-line no-self-compare
}

/* WEBPACK VAR INJECTION */}.call(exports, __webpack_require__(2)))

/***/ }),
/* 37 */,
/* 38 */
/***/ (function(module, exports) {

exports.read = function (buffer, offset, isLE, mLen, nBytes) {
  var e, m
  var eLen = nBytes * 8 - mLen - 1
  var eMax = (1 << eLen) - 1
  var eBias = eMax >> 1
  var nBits = -7
  var i = isLE ? (nBytes - 1) : 0
  var d = isLE ? -1 : 1
  var s = buffer[offset + i]

  i += d

  e = s & ((1 << (-nBits)) - 1)
  s >>= (-nBits)
  nBits += eLen
  for (; nBits > 0; e = e * 256 + buffer[offset + i], i += d, nBits -= 8) {}

  m = e & ((1 << (-nBits)) - 1)
  e >>= (-nBits)
  nBits += mLen
  for (; nBits > 0; m = m * 256 + buffer[offset + i], i += d, nBits -= 8) {}

  if (e === 0) {
    e = 1 - eBias
  } else if (e === eMax) {
    return m ? NaN : ((s ? -1 : 1) * Infinity)
  } else {
    m = m + Math.pow(2, mLen)
    e = e - eBias
  }
  return (s ? -1 : 1) * m * Math.pow(2, e - mLen)
}

exports.write = function (buffer, value, offset, isLE, mLen, nBytes) {
  var e, m, c
  var eLen = nBytes * 8 - mLen - 1
  var eMax = (1 << eLen) - 1
  var eBias = eMax >> 1
  var rt = (mLen === 23 ? Math.pow(2, -24) - Math.pow(2, -77) : 0)
  var i = isLE ? 0 : (nBytes - 1)
  var d = isLE ? 1 : -1
  var s = value < 0 || (value === 0 && 1 / value < 0) ? 1 : 0

  value = Math.abs(value)

  if (isNaN(value) || value === Infinity) {
    m = isNaN(value) ? 1 : 0
    e = eMax
  } else {
    e = Math.floor(Math.log(value) / Math.LN2)
    if (value * (c = Math.pow(2, -e)) < 1) {
      e--
      c *= 2
    }
    if (e + eBias >= 1) {
      value += rt / c
    } else {
      value += rt * Math.pow(2, 1 - eBias)
    }
    if (value * c >= 2) {
      e++
      c /= 2
    }

    if (e + eBias >= eMax) {
      m = 0
      e = eMax
    } else if (e + eBias >= 1) {
      m = (value * c - 1) * Math.pow(2, mLen)
      e = e + eBias
    } else {
      m = value * Math.pow(2, eBias - 1) * Math.pow(2, mLen)
      e = 0
    }
  }

  for (; mLen >= 8; buffer[offset + i] = m & 0xff, i += d, m /= 256, mLen -= 8) {}

  e = (e << mLen) | m
  eLen += mLen
  for (; eLen > 0; buffer[offset + i] = e & 0xff, i += d, e /= 256, eLen -= 8) {}

  buffer[offset + i - d] |= s * 128
}


/***/ }),
/* 39 */
/***/ (function(module, exports) {

var toString = {}.toString;

module.exports = Array.isArray || function (arr) {
  return toString.call(arr) == '[object Array]';
};


/***/ }),
/* 40 */,
/* 41 */
/***/ (function(module, exports, __webpack_require__) {

var __WEBPACK_AMD_DEFINE_ARRAY__, __WEBPACK_AMD_DEFINE_RESULT__;// ==========================================================================
// Plyr
// plyr.js v2.0.11
// https://github.com/selz/plyr
// License: The MIT License (MIT)
// ==========================================================================
// Credits: http://paypal.github.io/accessible-html5-video-player/
// ==========================================================================

;(function(root, factory) {
    'use strict';
    /*global define,module*/

    if (typeof module === 'object' && typeof module.exports === 'object') {
        // Node, CommonJS-like
        module.exports = factory(root, document);
    } else if (true) {
        // AMD
        !(__WEBPACK_AMD_DEFINE_ARRAY__ = [], __WEBPACK_AMD_DEFINE_RESULT__ = function () { return factory(root, document); }.apply(exports, __WEBPACK_AMD_DEFINE_ARRAY__),
				__WEBPACK_AMD_DEFINE_RESULT__ !== undefined && (module.exports = __WEBPACK_AMD_DEFINE_RESULT__));
    } else {
        // Browser globals (root is window)
        root.plyr = factory(root, document);
    }
}(typeof window !== 'undefined' ? window : this, function(window, document) {
    'use strict';

    // Globals
    var fullscreen,
    scroll = { x: 0, y: 0 },

    // Default config
    defaults = {
        enabled:                true,
        debug:                  false,
        autoplay:               false,
        loop:                   false,
        seekTime:               10,
        volume:                 10,
        volumeMin:              0,
        volumeMax:              10,
        volumeStep:             1,
        duration:               null,
        displayDuration:        true,
        loadSprite:             true,
        iconPrefix:             'plyr',
        iconUrl:                'https://cdn.plyr.io/2.0.11/plyr.svg',
        clickToPlay:            true,
        hideControls:           true,
        showPosterOnEnd:        false,
        disableContextMenu:     true,
        keyboardShorcuts:       {
            focused:            true,
            global:             false
        },
        tooltips: {
            controls:           false,
            seek:               true
        },
        selectors: {
            html5:              'video, audio',
            embed:              '[data-type]',
            editable:           'input, textarea, select, [contenteditable]',
            container:          '.plyr',
            controls: {
                container:      null,
                wrapper:        '.plyr__controls'
            },
            labels:             '[data-plyr]',
            buttons: {
                seek:           '[data-plyr="seek"]',
                play:           '[data-plyr="play"]',
                pause:          '[data-plyr="pause"]',
                restart:        '[data-plyr="restart"]',
                rewind:         '[data-plyr="rewind"]',
                forward:        '[data-plyr="fast-forward"]',
                mute:           '[data-plyr="mute"]',
                captions:       '[data-plyr="captions"]',
                fullscreen:     '[data-plyr="fullscreen"]'
            },
            volume: {
                input:          '[data-plyr="volume"]',
                display:        '.plyr__volume--display'
            },
            progress: {
                container:      '.plyr__progress',
                buffer:         '.plyr__progress--buffer',
                played:         '.plyr__progress--played'
            },
            captions:           '.plyr__captions',
            currentTime:        '.plyr__time--current',
            duration:           '.plyr__time--duration'
        },
        classes: {
            setup:              'plyr--setup',
            ready:              'plyr--ready',
            videoWrapper:       'plyr__video-wrapper',
            embedWrapper:       'plyr__video-embed',
            type:               'plyr--{0}',
            stopped:            'plyr--stopped',
            playing:            'plyr--playing',
            muted:              'plyr--muted',
            loading:            'plyr--loading',
            hover:              'plyr--hover',
            tooltip:            'plyr__tooltip',
            hidden:             'plyr__sr-only',
            hideControls:       'plyr--hide-controls',
            isIos:              'plyr--is-ios',
            isTouch:            'plyr--is-touch',
            captions: {
                enabled:        'plyr--captions-enabled',
                active:         'plyr--captions-active'
            },
            fullscreen: {
                enabled:        'plyr--fullscreen-enabled',
                active:         'plyr--fullscreen-active'
            },
            tabFocus:           'tab-focus'
        },
        captions: {
            defaultActive:      false
        },
        fullscreen: {
            enabled:            true,
            fallback:           true,
            allowAudio:         false
        },
        storage: {
            enabled:            true,
            key:                'plyr'
        },
        controls:               ['play-large', 'play', 'progress', 'current-time', 'mute', 'volume', 'captions', 'fullscreen'],
        i18n: {
            restart:            'Restart',
            rewind:             'Rewind {seektime} secs',
            play:               'Play',
            pause:              'Pause',
            forward:            'Forward {seektime} secs',
            played:             'played',
            buffered:           'buffered',
            currentTime:        'Current time',
            duration:           'Duration',
            volume:             'Volume',
            toggleMute:         'Toggle Mute',
            toggleCaptions:     'Toggle Captions',
            toggleFullscreen:   'Toggle Fullscreen',
            frameTitle:         'Player for {title}'
        },
        types: {
            embed:              ['youtube', 'vimeo', 'soundcloud'],
            html5:              ['video', 'audio']
        },
        // URLs
        urls: {
            vimeo: {
                api:            'https://player.vimeo.com/api/player.js',
            },
            youtube: {
                api:            'https://www.youtube.com/iframe_api'
            },
            soundcloud: {
                api:            'https://w.soundcloud.com/player/api.js'
            }
        },
        // Custom control listeners
        listeners: {
            seek:               null,
            play:               null,
            pause:              null,
            restart:            null,
            rewind:             null,
            forward:            null,
            mute:               null,
            volume:             null,
            captions:           null,
            fullscreen:         null
        },
        // Events to watch on HTML5 media elements
        events:                 ['ready', 'ended', 'progress', 'stalled', 'playing', 'waiting', 'canplay', 'canplaythrough', 'loadstart', 'loadeddata', 'loadedmetadata', 'timeupdate', 'volumechange', 'play', 'pause', 'error', 'seeking', 'seeked', 'emptied'],
        // Logging
        logPrefix:              '[Plyr]'
    };

    // Credits: http://paypal.github.io/accessible-html5-video-player/
    // Unfortunately, due to mixed support, UA sniffing is required
    function _browserSniff() {
        var ua = navigator.userAgent,
            name = navigator.appName,
            fullVersion = '' + parseFloat(navigator.appVersion),
            majorVersion = parseInt(navigator.appVersion, 10),
            nameOffset,
            verOffset,
            ix,
            isIE = false,
            isFirefox = false,
            isChrome = false,
            isSafari = false;

        if ((navigator.appVersion.indexOf('Windows NT') !== -1) && (navigator.appVersion.indexOf('rv:11') !== -1)) {
            // MSIE 11
            isIE = true;
            name = 'IE';
            fullVersion = '11';
        } else if ((verOffset = ua.indexOf('MSIE')) !== -1) {
            // MSIE
            isIE = true;
            name = 'IE';
            fullVersion = ua.substring(verOffset + 5);
        } else if ((verOffset = ua.indexOf('Chrome')) !== -1) {
            // Chrome
            isChrome = true;
            name = 'Chrome';
            fullVersion = ua.substring(verOffset + 7);
        } else if ((verOffset = ua.indexOf('Safari')) !== -1) {
            // Safari
            isSafari = true;
            name = 'Safari';
            fullVersion = ua.substring(verOffset + 7);
            if ((verOffset = ua.indexOf('Version')) !== -1) {
                fullVersion = ua.substring(verOffset + 8);
            }
        } else if ((verOffset = ua.indexOf('Firefox')) !== -1) {
            // Firefox
            isFirefox = true;
            name = 'Firefox';
            fullVersion = ua.substring(verOffset + 8);
        } else if ((nameOffset = ua.lastIndexOf(' ') + 1) < (verOffset = ua.lastIndexOf('/'))) {
            // In most other browsers, 'name/version' is at the end of userAgent
            name = ua.substring(nameOffset,verOffset);
            fullVersion = ua.substring(verOffset + 1);

            if (name.toLowerCase() === name.toUpperCase()) {
                name = navigator.appName;
            }
        }

        // Trim the fullVersion string at semicolon/space if present
        if ((ix = fullVersion.indexOf(';')) !== -1) {
            fullVersion = fullVersion.substring(0, ix);
        }
        if ((ix = fullVersion.indexOf(' ')) !== -1) {
            fullVersion = fullVersion.substring(0, ix);
        }

        // Get major version
        majorVersion = parseInt('' + fullVersion, 10);
        if (isNaN(majorVersion)) {
            fullVersion = '' + parseFloat(navigator.appVersion);
            majorVersion = parseInt(navigator.appVersion, 10);
        }

        // Return data
        return {
            name:       name,
            version:    majorVersion,
            isIE:       isIE,
            isFirefox:  isFirefox,
            isChrome:   isChrome,
            isSafari:   isSafari,
            isIos:      /(iPad|iPhone|iPod)/g.test(navigator.platform),
            isIphone:   /(iPhone|iPod)/g.test(navigator.userAgent),
            isTouch:    'ontouchstart' in document.documentElement
        };
    }

    // Check for mime type support against a player instance
    // Credits: http://diveintohtml5.info/everything.html
    // Related: http://www.leanbackplyr.com/test/h5mt.html
    function _supportMime(plyr, mimeType) {
        var media = plyr.media;

        if (plyr.type === 'video') {
            // Check type
            switch (mimeType) {
                case 'video/webm':   return !!(media.canPlayType && media.canPlayType('video/webm; codecs="vp8, vorbis"').replace(/no/, ''));
                case 'video/mp4':    return !!(media.canPlayType && media.canPlayType('video/mp4; codecs="avc1.42E01E, mp4a.40.2"').replace(/no/, ''));
                case 'video/ogg':    return !!(media.canPlayType && media.canPlayType('video/ogg; codecs="theora"').replace(/no/, ''));
            }
        } else if (plyr.type === 'audio') {
            // Check type
            switch (mimeType) {
                case 'audio/mpeg':   return !!(media.canPlayType && media.canPlayType('audio/mpeg;').replace(/no/, ''));
                case 'audio/ogg':    return !!(media.canPlayType && media.canPlayType('audio/ogg; codecs="vorbis"').replace(/no/, ''));
                case 'audio/wav':    return !!(media.canPlayType && media.canPlayType('audio/wav; codecs="1"').replace(/no/, ''));
            }
        }

        // If we got this far, we're stuffed
        return false;
    }

    // Inject a script
    function _injectScript(source) {
        if (document.querySelectorAll('script[src="' + source + '"]').length) {
            return;
        }

        var tag = document.createElement('script');
        tag.src = source;
        var firstScriptTag = document.getElementsByTagName('script')[0];
        firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);
    }

    // Element exists in an array
    function _inArray(haystack, needle) {
        return Array.prototype.indexOf && (haystack.indexOf(needle) !== -1);
    }

    // Replace all
    function _replaceAll(string, find, replace) {
        return string.replace(new RegExp(find.replace(/([.*+?\^=!:${}()|\[\]\/\\])/g, '\\$1'), 'g'), replace);
    }

    // Wrap an element
    function _wrap(elements, wrapper) {
        // Convert `elements` to an array, if necessary.
        if (!elements.length) {
            elements = [elements];
        }

        // Loops backwards to prevent having to clone the wrapper on the
        // first element (see `child` below).
        for (var i = elements.length - 1; i >= 0; i--) {
            var child   = (i > 0) ? wrapper.cloneNode(true) : wrapper;
            var element = elements[i];

            // Cache the current parent and sibling.
            var parent  = element.parentNode;
            var sibling = element.nextSibling;

            // Wrap the element (is automatically removed from its current
            // parent).
            child.appendChild(element);

            // If the element had a sibling, insert the wrapper before
            // the sibling to maintain the HTML structure; otherwise, just
            // append it to the parent.
            if (sibling) {
                parent.insertBefore(child, sibling);
            } else {
                parent.appendChild(child);
            }

            return child;
        }
    }

    // Unwrap an element
    // http://plainjs.com/javascript/manipulation/unwrap-a-dom-element-35/
    /*function _unwrap(wrapper) {
        // Get the element's parent node
        var parent = wrapper.parentNode;

        // Move all children out of the element
        while (wrapper.firstChild) {
            parent.insertBefore(wrapper.firstChild, wrapper);
        }

        // Remove the empty element
        parent.removeChild(wrapper);
    }*/

    // Remove an element
    function _remove(element) {
        if (!element) {
            return;
        }
        element.parentNode.removeChild(element);
    }

    // Prepend child
    function _prependChild(parent, element) {
        parent.insertBefore(element, parent.firstChild);
    }

    // Set attributes
    function _setAttributes(element, attributes) {
        for (var key in attributes) {
            element.setAttribute(key, (_is.boolean(attributes[key]) && attributes[key]) ? '' : attributes[key]);
        }
    }

    // Insert a HTML element
    function _insertElement(type, parent, attributes) {
        // Create a new <element>
        var element = document.createElement(type);

        // Set all passed attributes
        _setAttributes(element, attributes);

        // Inject the new element
        _prependChild(parent, element);
    }

    // Get a classname from selector
    function _getClassname(selector) {
        return selector.replace('.', '');
    }

    // Toggle class on an element
    function _toggleClass(element, className, state) {
        if (element) {
            if (element.classList) {
                element.classList[state ? 'add' : 'remove'](className);
            } else {
                var name = (' ' + element.className + ' ').replace(/\s+/g, ' ').replace(' ' + className + ' ', '');
                element.className = name + (state ? ' ' + className : '');
            }
        }
    }

    // Has class name
    function _hasClass(element, className) {
        if (element) {
            if (element.classList) {
                return element.classList.contains(className);
            } else {
                return new RegExp('(\\s|^)' + className + '(\\s|$)').test(element.className);
            }
        }
        return false;
    }

    // Element matches selector
    function _matches(element, selector) {
        var p = Element.prototype;

        var f = p.matches || p.webkitMatchesSelector || p.mozMatchesSelector || p.msMatchesSelector || function(s) {
            return [].indexOf.call(document.querySelectorAll(s), this) !== -1;
        };

        return f.call(element, selector);
    }

    // Bind along with custom handler
    function _proxyListener(element, eventName, userListener, defaultListener, useCapture) {
        _on(element, eventName, function(event) {
            if (userListener) {
                userListener.apply(element, [event]);
            }
            defaultListener.apply(element, [event]);
        }, useCapture);
    }

    // Toggle event listener
    function _toggleListener(element, events, callback, toggle, useCapture) {
        var eventList = events.split(' ');

        // Whether the listener is a capturing listener or not
        // Default to false
        if (!_is.boolean(useCapture)) {
            useCapture = false;
        }

        // If a nodelist is passed, call itself on each node
        if (element instanceof NodeList) {
            for (var x = 0; x < element.length; x++) {
                if (element[x] instanceof Node) {
                    _toggleListener(element[x], arguments[1], arguments[2], arguments[3]);
                }
            }
            return;
        }

        // If a single node is passed, bind the event listener
        for (var i = 0; i < eventList.length; i++) {
            element[toggle ? 'addEventListener' : 'removeEventListener'](eventList[i], callback, useCapture);
        }
    }

    // Bind event
    function _on(element, events, callback, useCapture) {
        if (element) {
            _toggleListener(element, events, callback, true, useCapture);
        }
    }

    // Unbind event
    /*function _off(element, events, callback, useCapture) {
        if (element) {
            _toggleListener(element, events, callback, false, useCapture);
        }
    }*/

    // Trigger event
    function _event(element, type, bubbles, properties) {
        // Bail if no element
        if (!element || !type) {
            return;
        }

        // Default bubbles to false
        if (!_is.boolean(bubbles)) {
            bubbles = false;
        }

        // Create and dispatch the event
        var event = new CustomEvent(type, {
            bubbles:    bubbles,
            detail:     properties
        });

        // Dispatch the event
        element.dispatchEvent(event);
    }

    // Toggle aria-pressed state on a toggle button
    // http://www.ssbbartgroup.com/blog/how-not-to-misuse-aria-states-properties-and-roles
    function _toggleState(target, state) {
        // Bail if no target
        if (!target) {
            return;
        }

        // Get state
        state = (_is.boolean(state) ? state : !target.getAttribute('aria-pressed'));

        // Set the attribute on target
        target.setAttribute('aria-pressed', state);

        return state;
    }

    // Get percentage
    function _getPercentage(current, max) {
        if (current === 0 || max === 0 || isNaN(current) || isNaN(max)) {
            return 0;
        }
        return ((current / max) * 100).toFixed(2);
    }

    // Deep extend/merge destination object with N more objects
    // http://andrewdupont.net/2009/08/28/deep-extending-objects-in-javascript/
    // Removed call to arguments.callee (used explicit function name instead)
    function _extend() {
        // Get arguments
        var objects = arguments;

        // Bail if nothing to merge
        if (!objects.length) {
            return;
        }

        // Return first if specified but nothing to merge
        if (objects.length === 1) {
            return objects[0];
        }

        // First object is the destination
        var destination = Array.prototype.shift.call(objects),
            length      = objects.length;

        // Loop through all objects to merge
        for (var i = 0; i < length; i++) {
            var source = objects[i];

            for (var property in source) {
                if (source[property] && source[property].constructor && source[property].constructor === Object) {
                    destination[property] = destination[property] || {};
                    _extend(destination[property], source[property]);
                } else {
                    destination[property] = source[property];
                }
            }
        }

        return destination;
    }

    // Check variable types
    var _is = {
        object: function(input) {
            return input !== null && typeof(input) === 'object';
        },
        array: function(input) {
            return input !== null && (typeof(input) === 'object' && input.constructor === Array);
        },
        number: function(input) {
            return input !== null && (typeof(input) === 'number' && !isNaN(input - 0) || (typeof input === 'object' && input.constructor === Number));
        },
        string: function(input) {
            return input !== null && (typeof input === 'string' || (typeof input === 'object' && input.constructor === String));
        },
        boolean: function(input) {
            return input !== null && typeof input === 'boolean';
        },
        nodeList: function(input) {
            return input !== null && input instanceof NodeList;
        },
        htmlElement: function(input) {
            return input !== null && input instanceof HTMLElement;
        },
        function: function(input) {
            return input !== null && typeof input === 'function';
        },
        undefined: function(input) {
            return input !== null && typeof input === 'undefined';
        }
    };

    // Parse YouTube ID from url
    function _parseYouTubeId(url) {
        var regex = /^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|\&v=)([^#\&\?]*).*/;
        return (url.match(regex)) ? RegExp.$2 : url;
    }

    // Parse Vimeo ID from url
    function _parseVimeoId(url) {
        var regex = /^.*(vimeo.com\/|video\/)(\d+).*/;
        return (url.match(regex)) ? RegExp.$2 : url;
    }

    // Fullscreen API
    function _fullscreen() {
        var fullscreen = {
                supportsFullScreen: false,
                isFullScreen: function() { return false; },
                requestFullScreen: function() {},
                cancelFullScreen: function() {},
                fullScreenEventName: '',
                element: null,
                prefix: ''
            },
            browserPrefixes = 'webkit o moz ms khtml'.split(' ');

        // Check for native support
        if (!_is.undefined(document.cancelFullScreen)) {
            fullscreen.supportsFullScreen = true;
        } else {
            // Check for fullscreen support by vendor prefix
            for (var i = 0, il = browserPrefixes.length; i < il; i++ ) {
                fullscreen.prefix = browserPrefixes[i];

                if (!_is.undefined(document[fullscreen.prefix + 'CancelFullScreen'])) {
                    fullscreen.supportsFullScreen = true;
                    break;
                } else if (!_is.undefined(document.msExitFullscreen) && document.msFullscreenEnabled) {
                    // Special case for MS (when isn't it?)
                    fullscreen.prefix = 'ms';
                    fullscreen.supportsFullScreen = true;
                    break;
                }
            }
        }

        // Update methods to do something useful
        if (fullscreen.supportsFullScreen) {
            // Yet again Microsoft awesomeness,
            // Sometimes the prefix is 'ms', sometimes 'MS' to keep you on your toes
            fullscreen.fullScreenEventName = (fullscreen.prefix === 'ms' ? 'MSFullscreenChange' : fullscreen.prefix + 'fullscreenchange');

            fullscreen.isFullScreen = function(element) {
                if (_is.undefined(element)) {
                    element = document.body;
                }
                switch (this.prefix) {
                    case '':
                        return document.fullscreenElement === element;
                    case 'moz':
                        return document.mozFullScreenElement === element;
                    default:
                        return document[this.prefix + 'FullscreenElement'] === element;
                }
            };
            fullscreen.requestFullScreen = function(element) {
                if (_is.undefined(element)) {
                    element = document.body;
                }
                return (this.prefix === '') ? element.requestFullScreen() : element[this.prefix + (this.prefix === 'ms' ? 'RequestFullscreen' : 'RequestFullScreen')]();
            };
            fullscreen.cancelFullScreen = function() {
                return (this.prefix === '') ? document.cancelFullScreen() : document[this.prefix + (this.prefix === 'ms' ? 'ExitFullscreen' : 'CancelFullScreen')]();
            };
            fullscreen.element = function() {
                return (this.prefix === '') ? document.fullscreenElement : document[this.prefix + 'FullscreenElement'];
            };
        }

        return fullscreen;
    }

    // Local storage
    var _storage = {
        supported: (function() {
            if (!('localStorage' in window)) {
                return false;
            }

            // Try to use it (it might be disabled, e.g. user is in private/porn mode)
            // see: https://github.com/Selz/plyr/issues/131
            try {
                // Add test item
                window.localStorage.setItem('___test', 'OK');

                // Get the test item
                var result = window.localStorage.getItem('___test');

                // Clean up
                window.localStorage.removeItem('___test');

                // Check if value matches
                return (result === 'OK');
            }
            catch (e) {
                return false;
            }

            return false;
        })()
    };

    // Player instance
    function Plyr(media, config) {
        var plyr = this,
        timers = {},
        api;

        // Set media
        plyr.media = media;
        var original = media.cloneNode(true);

        // Trigger events, with plyr instance passed
        function _triggerEvent(element, type, bubbles, properties) {
            _event(element, type, bubbles, _extend({}, properties, {
                plyr: api
            }));
        }

        // Debugging
        function _console(type, args) {
            if (config.debug && window.console) {
                args = Array.prototype.slice.call(args);

                if (_is.string(config.logPrefix) && config.logPrefix.length) {
                    args.unshift(config.logPrefix);
                }

                console[type].apply(console, args);
            }
        }
        var _log = function() { _console('log', arguments) },
            _warn = function() { _console('warn', arguments) };

        // Log config options
        _log('Config', config);

        // Get icon URL
        function _getIconUrl() {
            return {
                url:        config.iconUrl,
                absolute:   (config.iconUrl.indexOf("http") === 0) || plyr.browser.isIE
            };
        }

        // Build the default HTML
        function _buildControls() {
            // Create html array
            var html        = [],
                iconUrl     = _getIconUrl(),
                iconPath    = (!iconUrl.absolute ? iconUrl.url : '') + '#' + config.iconPrefix;

            // Larger overlaid play button
            if (_inArray(config.controls, 'play-large')) {
                html.push(
                    '<button type="button" data-plyr="play" class="plyr__play-large">',
                        '<svg><use xlink:href="' + iconPath + '-play" /></svg>',
                        '<span class="plyr__sr-only">' + config.i18n.play + '</span>',
                    '</button>'
                );
            }

            html.push('<div class="plyr__controls">');

            // Restart button
            if (_inArray(config.controls, 'restart')) {
                html.push(
                    '<button type="button" data-plyr="restart">',
                        '<svg><use xlink:href="' + iconPath + '-restart" /></svg>',
                        '<span class="plyr__sr-only">' + config.i18n.restart + '</span>',
                    '</button>'
                );
            }

            // Rewind button
            if (_inArray(config.controls, 'rewind')) {
                html.push(
                    '<button type="button" data-plyr="rewind">',
                        '<svg><use xlink:href="' + iconPath + '-rewind" /></svg>',
                        '<span class="plyr__sr-only">' + config.i18n.rewind + '</span>',
                    '</button>'
                );
            }

            // Play Pause button
            // TODO: This should be a toggle button really?
            if (_inArray(config.controls, 'play')) {
                html.push(
                    '<button type="button" data-plyr="play">',
                        '<svg><use xlink:href="' + iconPath + '-play" /></svg>',
                        '<span class="plyr__sr-only">' + config.i18n.play + '</span>',
                    '</button>',
                    '<button type="button" data-plyr="pause">',
                        '<svg><use xlink:href="' + iconPath + '-pause" /></svg>',
                        '<span class="plyr__sr-only">' + config.i18n.pause + '</span>',
                    '</button>'
                );
            }

            // Fast forward button
            if (_inArray(config.controls, 'fast-forward')) {
                html.push(
                    '<button type="button" data-plyr="fast-forward">',
                        '<svg><use xlink:href="' + iconPath + '-fast-forward" /></svg>',
                        '<span class="plyr__sr-only">' + config.i18n.forward + '</span>',
                    '</button>'
                );
            }

            // Progress
            if (_inArray(config.controls, 'progress')) {
                // Create progress
                html.push('<span class="plyr__progress">',
                    '<label for="seek{id}" class="plyr__sr-only">Seek</label>',
                    '<input id="seek{id}" class="plyr__progress--seek" type="range" min="0" max="100" step="0.1" value="0" data-plyr="seek">',
                    '<progress class="plyr__progress--played" max="100" value="0" role="presentation"></progress>',
                    '<progress class="plyr__progress--buffer" max="100" value="0">',
                        '<span>0</span>% ' + config.i18n.buffered,
                    '</progress>');

                // Seek tooltip
                if (config.tooltips.seek) {
                    html.push('<span class="plyr__tooltip">00:00</span>');
                }

                // Close
                html.push('</span>');
            }

            // Media current time display
            if (_inArray(config.controls, 'current-time')) {
                html.push(
                    '<span class="plyr__time">',
                        '<span class="plyr__sr-only">' + config.i18n.currentTime + '</span>',
                        '<span class="plyr__time--current">00:00</span>',
                    '</span>'
                );
            }

            // Media duration display
            if (_inArray(config.controls, 'duration')) {
                html.push(
                    '<span class="plyr__time">',
                        '<span class="plyr__sr-only">' + config.i18n.duration + '</span>',
                        '<span class="plyr__time--duration">00:00</span>',
                    '</span>'
                );
            }

            // Toggle mute button
            if (_inArray(config.controls, 'mute')) {
                html.push(
                    '<button type="button" data-plyr="mute">',
                        '<svg class="icon--muted"><use xlink:href="' + iconPath + '-muted" /></svg>',
                        '<svg><use xlink:href="' + iconPath + '-volume" /></svg>',
                        '<span class="plyr__sr-only">' + config.i18n.toggleMute + '</span>',
                    '</button>'
                );
            }

            // Volume range control
            if (_inArray(config.controls, 'volume')) {
                html.push(
                    '<span class="plyr__volume">',
                        '<label for="volume{id}" class="plyr__sr-only">' + config.i18n.volume + '</label>',
                        '<input id="volume{id}" class="plyr__volume--input" type="range" min="' + config.volumeMin + '" max="' + config.volumeMax + '" value="' + config.volume + '" data-plyr="volume">',
                        '<progress class="plyr__volume--display" max="' + config.volumeMax + '" value="' + config.volumeMin + '" role="presentation"></progress>',
                    '</span>'
                );
            }

            // Toggle captions button
            if (_inArray(config.controls, 'captions')) {
                html.push(
                    '<button type="button" data-plyr="captions">',
                        '<svg class="icon--captions-on"><use xlink:href="' + iconPath + '-captions-on" /></svg>',
                        '<svg><use xlink:href="' + iconPath+ '-captions-off" /></svg>',
                        '<span class="plyr__sr-only">' + config.i18n.toggleCaptions + '</span>',
                    '</button>'
                );
            }

            // Toggle fullscreen button
            if (_inArray(config.controls, 'fullscreen')) {
                html.push(
                    '<button type="button" data-plyr="fullscreen">',
                        '<svg class="icon--exit-fullscreen"><use xlink:href="' + iconPath + '-exit-fullscreen" /></svg>',
                        '<svg><use xlink:href="' + iconPath + '-enter-fullscreen" /></svg>',
                        '<span class="plyr__sr-only">' + config.i18n.toggleFullscreen + '</span>',
                    '</button>'
                );
            }

            // Close everything
            html.push('</div>');

            return html.join('');
        }

        // Setup fullscreen
        function _setupFullscreen() {
            if (!plyr.supported.full) {
                return;
            }

            if ((plyr.type !== 'audio' || config.fullscreen.allowAudio) && config.fullscreen.enabled) {
                // Check for native support
                var nativeSupport = fullscreen.supportsFullScreen;

                if (nativeSupport || (config.fullscreen.fallback && !_inFrame())) {
                    _log((nativeSupport ? 'Native' : 'Fallback') + ' fullscreen enabled');

                    // Add styling hook
                    _toggleClass(plyr.container, config.classes.fullscreen.enabled, true);
                } else {
                    _log('Fullscreen not supported and fallback disabled');
                }

                // Toggle state
                if (plyr.buttons && plyr.buttons.fullscreen) {
                    _toggleState(plyr.buttons.fullscreen, false);
                }

                // Setup focus trap
                _focusTrap();
            }
        }

        // Setup captions
        function _setupCaptions() {
            // Bail if not HTML5 video
            if (plyr.type !== 'video') {
                return;
            }

            // Inject the container
            if (!_getElement(config.selectors.captions)) {
                plyr.videoContainer.insertAdjacentHTML('afterbegin', '<div class="' + _getClassname(config.selectors.captions) + '"></div>');
            }

            // Determine if HTML5 textTracks is supported
            plyr.usingTextTracks = false;
            if (plyr.media.textTracks) {
                plyr.usingTextTracks = true;
            }

            // Get URL of caption file if exists
            var captionSrc = '',
                kind,
                children = plyr.media.childNodes;

            for (var i = 0; i < children.length; i++) {
                if (children[i].nodeName.toLowerCase() === 'track') {
                    kind = children[i].kind;
                    if (kind === 'captions' || kind === 'subtitles') {
                        captionSrc = children[i].getAttribute('src');
                    }
                }
            }

            // Record if caption file exists or not
            plyr.captionExists = true;
            if (captionSrc === '') {
                plyr.captionExists = false;
                _log('No caption track found');
            } else {
                _log('Caption track found; URI: ' + captionSrc);
            }

            // If no caption file exists, hide container for caption text
            if (!plyr.captionExists) {
                _toggleClass(plyr.container, config.classes.captions.enabled);
            } else {
                // Turn off native caption rendering to avoid double captions
                // This doesn't seem to work in Safari 7+, so the <track> elements are removed from the dom below
                var tracks = plyr.media.textTracks;
                for (var x = 0; x < tracks.length; x++) {
                    tracks[x].mode = 'hidden';
                }

                // Enable UI
                _showCaptions(plyr);

                // Disable unsupported browsers than report false positive
                // Firefox bug: https://bugzilla.mozilla.org/show_bug.cgi?id=1033144
                if ((plyr.browser.isIE && plyr.browser.version >= 10) ||
                    (plyr.browser.isFirefox && plyr.browser.version >= 31)) {

                    // Debugging
                    _log('Detected browser with known TextTrack issues - using manual fallback');

                    // Set to false so skips to 'manual' captioning
                    plyr.usingTextTracks = false;
                }

                // Rendering caption tracks
                // Native support required - http://caniuse.com/webvtt
                if (plyr.usingTextTracks) {
                    _log('TextTracks supported');

                    for (var y = 0; y < tracks.length; y++) {
                        var track = tracks[y];

                        if (track.kind === 'captions' || track.kind === 'subtitles') {
                            _on(track, 'cuechange', function() {
                                // Display a cue, if there is one
                                if (this.activeCues[0] && 'text' in this.activeCues[0]) {
                                    _setCaption(this.activeCues[0].getCueAsHTML());
                                } else {
                                    _setCaption();
                                }
                            });
                        }
                    }
                } else {
                    // Caption tracks not natively supported
                    _log('TextTracks not supported so rendering captions manually');

                    // Render captions from array at appropriate time
                    plyr.currentCaption = '';
                    plyr.captions = [];

                    if (captionSrc !== '') {
                        // Create XMLHttpRequest Object
                        var xhr = new XMLHttpRequest();

                        xhr.onreadystatechange = function() {
                            if (xhr.readyState === 4) {
                                if (xhr.status === 200) {
                                    var captions = [],
                                        caption,
                                        req = xhr.responseText;

                                    //According to webvtt spec, line terminator consists of one of the following
                                    // CRLF (U+000D U+000A), LF (U+000A) or CR (U+000D)
                                    var lineSeparator = '\r\n';
                                    if(req.indexOf(lineSeparator+lineSeparator) === -1) {
                                        if(req.indexOf('\r\r') !== -1){
                                            lineSeparator = '\r';
                                        } else {
                                            lineSeparator = '\n';
                                        }
                                    }

                                    captions = req.split(lineSeparator+lineSeparator);

                                    for (var r = 0; r < captions.length; r++) {
                                        caption = captions[r];
                                        plyr.captions[r] = [];

                                        // Get the parts of the captions
                                        var parts = caption.split(lineSeparator),
                                            index = 0;

                                        // Incase caption numbers are added
                                        if (parts[index].indexOf(":") === -1) {
                                            index = 1;
                                        }

                                        plyr.captions[r] = [parts[index], parts[index + 1]];
                                    }

                                    // Remove first element ('VTT')
                                    plyr.captions.shift();

                                    _log('Successfully loaded the caption file via AJAX');
                                } else {
                                    _warn(config.logPrefix + 'There was a problem loading the caption file via AJAX');
                                }
                            }
                        };

                        xhr.open('get', captionSrc, true);

                        xhr.send();
                    }
                }
            }
        }

        // Set the current caption
        function _setCaption(caption) {
            /* jshint unused:false */
            var container = _getElement(config.selectors.captions),
                content = document.createElement('span');

            // Empty the container
            container.innerHTML = '';

            // Default to empty
            if (_is.undefined(caption)) {
                caption = '';
            }

            // Set the span content
            if (_is.string(caption)) {
                content.innerHTML = caption.trim();
            } else {
                content.appendChild(caption);
            }

            // Set new caption text
            container.appendChild(content);

            // Force redraw (for Safari)
            var redraw = container.offsetHeight;
        }

        // Captions functions
        // Seek the manual caption time and update UI
        function _seekManualCaptions(time) {
            // Utilities for caption time codes
            function _timecodeCommon(tc, pos) {
                var tcpair = [];
                tcpair = tc.split(' --> ');
                for(var i = 0; i < tcpair.length; i++) {
                    // WebVTT allows for extra meta data after the timestamp line
                    // So get rid of this if it exists
                    tcpair[i] = tcpair[i].replace(/(\d+:\d+:\d+\.\d+).*/, "$1");
                }
                return _subTcSecs(tcpair[pos]);
            }
            function _timecodeMin(tc) {
                return _timecodeCommon(tc, 0);
            }
            function _timecodeMax(tc) {
                return _timecodeCommon(tc, 1);
            }
            function _subTcSecs(tc) {
                if (tc === null || tc === undefined) {
                    return 0;
                } else {
                    var tc1 = [],
                        tc2 = [],
                        seconds;
                    tc1 = tc.split(',');
                    tc2 = tc1[0].split(':');
                    seconds = Math.floor(tc2[0]*60*60) + Math.floor(tc2[1]*60) + Math.floor(tc2[2]);
                    return seconds;
                }
            }

            // If it's not video, or we're using textTracks, bail.
            if (plyr.usingTextTracks || plyr.type !== 'video' || !plyr.supported.full) {
                return;
            }

            // Reset subcount
            plyr.subcount = 0;

            // Check time is a number, if not use currentTime
            // IE has a bug where currentTime doesn't go to 0
            // https://twitter.com/Sam_Potts/status/573715746506731521
            time = _is.number(time) ? time : plyr.media.currentTime;

            // If there's no subs available, bail
            if (!plyr.captions[plyr.subcount]) {
                return;
            }

            while (_timecodeMax(plyr.captions[plyr.subcount][0]) < time.toFixed(1)) {
                plyr.subcount++;
                if (plyr.subcount > plyr.captions.length - 1) {
                    plyr.subcount = plyr.captions.length - 1;
                    break;
                }
            }

            // Check if the next caption is in the current time range
            if (plyr.media.currentTime.toFixed(1) >= _timecodeMin(plyr.captions[plyr.subcount][0]) &&
                plyr.media.currentTime.toFixed(1) <= _timecodeMax(plyr.captions[plyr.subcount][0])) {
                    plyr.currentCaption = plyr.captions[plyr.subcount][1];

                // Render the caption
                _setCaption(plyr.currentCaption);
            } else {
                _setCaption();
            }
        }

        // Display captions container and button (for initialization)
        function _showCaptions() {
            // If there's no caption toggle, bail
            if (!plyr.buttons.captions) {
                return;
            }

            _toggleClass(plyr.container, config.classes.captions.enabled, true);

            // Try to load the value from storage
            var active = plyr.storage.captionsEnabled;

            // Otherwise fall back to the default config
            if (!_is.boolean(active)) {
                active = config.captions.defaultActive;
            }

            if (active) {
                _toggleClass(plyr.container, config.classes.captions.active, true);
                _toggleState(plyr.buttons.captions, true);
            }
        }

        // Find all elements
        function _getElements(selector) {
            return plyr.container.querySelectorAll(selector);
        }

        // Find a single element
        function _getElement(selector) {
            return _getElements(selector)[0];
        }

        // Determine if we're in an iframe
        function _inFrame() {
            try {
                return window.self !== window.top;
            }
            catch (e) {
                return true;
            }
        }

        // Trap focus inside container
        function _focusTrap() {
            var tabbables   = _getElements('input:not([disabled]), button:not([disabled])'),
                first       = tabbables[0],
                last        = tabbables[tabbables.length - 1];

            function _checkFocus(event) {
                // If it is TAB
                if (event.which === 9 && plyr.isFullscreen) {
                    if (event.target === last && !event.shiftKey) {
                        // Move focus to first element that can be tabbed if Shift isn't used
                        event.preventDefault();
                        first.focus();
                    } else if (event.target === first && event.shiftKey) {
                        // Move focus to last element that can be tabbed if Shift is used
                        event.preventDefault();
                        last.focus();
                    }
                }
            }

            // Bind the handler
            _on(plyr.container, 'keydown', _checkFocus);
        }

        // Add elements to HTML5 media (source, tracks, etc)
        function _insertChildElements(type, attributes) {
            if (_is.string(attributes)) {
               _insertElement(type, plyr.media, { src: attributes });
            } else if (attributes.constructor === Array) {
                for (var i = attributes.length - 1; i >= 0; i--) {
                    _insertElement(type, plyr.media, attributes[i]);
                }
            }
        }

        // Insert controls
        function _injectControls() {
            // Sprite
            if (config.loadSprite) {
                var iconUrl = _getIconUrl();

                // Only load external sprite using AJAX
                if (iconUrl.absolute) {
                    _log('AJAX loading absolute SVG sprite' + (plyr.browser.isIE ? ' (due to IE)' : ''));
                    loadSprite(iconUrl.url, "sprite-plyr");
                } else {
                    _log('Sprite will be used as external resource directly');
                }
            }

            // Make a copy of the html
            var html = config.html;

            // Insert custom video controls
            _log('Injecting custom controls');

            // If no controls are specified, create default
            if (!html) {
                html = _buildControls();
            }

            // Replace seek time instances
            html = _replaceAll(html, '{seektime}', config.seekTime);

            // Replace all id references with random numbers
            html = _replaceAll(html, '{id}', Math.floor(Math.random() * (10000)));

            // Controls container
            var target;

            // Inject to custom location
            if (_is.string(config.selectors.controls.container)) {
                target = document.querySelector(config.selectors.controls.container);
            }

            // Inject into the container by default
            if (!_is.htmlElement(target)) {
                target = plyr.container
            }

            // Inject controls HTML
            target.insertAdjacentHTML('beforeend', html);

            // Setup tooltips
            if (config.tooltips.controls) {
                var labels = _getElements([config.selectors.controls.wrapper, ' ', config.selectors.labels, ' .', config.classes.hidden].join(''));

                for (var i = labels.length - 1; i >= 0; i--) {
                    var label = labels[i];

                    _toggleClass(label, config.classes.hidden, false);
                    _toggleClass(label, config.classes.tooltip, true);
                }
            }
        }

        // Find the UI controls and store references
        function _findElements() {
            try {
                plyr.controls                 = _getElement(config.selectors.controls.wrapper);

                // Buttons
                plyr.buttons = {};
                plyr.buttons.seek             = _getElement(config.selectors.buttons.seek);
                plyr.buttons.play             = _getElements(config.selectors.buttons.play);
                plyr.buttons.pause            = _getElement(config.selectors.buttons.pause);
                plyr.buttons.restart          = _getElement(config.selectors.buttons.restart);
                plyr.buttons.rewind           = _getElement(config.selectors.buttons.rewind);
                plyr.buttons.forward          = _getElement(config.selectors.buttons.forward);
                plyr.buttons.fullscreen       = _getElement(config.selectors.buttons.fullscreen);

                // Inputs
                plyr.buttons.mute             = _getElement(config.selectors.buttons.mute);
                plyr.buttons.captions         = _getElement(config.selectors.buttons.captions);

                // Progress
                plyr.progress = {};
                plyr.progress.container       = _getElement(config.selectors.progress.container);

                // Progress - Buffering
                plyr.progress.buffer          = {};
                plyr.progress.buffer.bar      = _getElement(config.selectors.progress.buffer);
                plyr.progress.buffer.text     = plyr.progress.buffer.bar && plyr.progress.buffer.bar.getElementsByTagName('span')[0];

                // Progress - Played
                plyr.progress.played          = _getElement(config.selectors.progress.played);

                // Seek tooltip
                plyr.progress.tooltip         = plyr.progress.container && plyr.progress.container.querySelector('.' + config.classes.tooltip);

                // Volume
                plyr.volume                   = {};
                plyr.volume.input             = _getElement(config.selectors.volume.input);
                plyr.volume.display           = _getElement(config.selectors.volume.display);

                // Timing
                plyr.duration                 = _getElement(config.selectors.duration);
                plyr.currentTime              = _getElement(config.selectors.currentTime);
                plyr.seekTime                 = _getElements(config.selectors.seekTime);

                return true;
            }
            catch(e) {
                _warn('It looks like there is a problem with your controls HTML');

                // Restore native video controls
                _toggleNativeControls(true);

                return false;
            }
        }

        // Toggle style hook
        function _toggleStyleHook() {
            _toggleClass(plyr.container, config.selectors.container.replace('.', ''), plyr.supported.full);
        }

        // Toggle native controls
        function _toggleNativeControls(toggle) {
            if (toggle && _inArray(config.types.html5, plyr.type)) {
                plyr.media.setAttribute('controls', '');
            } else {
                plyr.media.removeAttribute('controls');
            }
        }

        // Setup aria attribute for play and iframe title
        function _setTitle(iframe) {
            // Find the current text
            var label = config.i18n.play;

            // If there's a media title set, use that for the label
            if (_is.string(config.title) && config.title.length) {
                label += ', ' + config.title;

                // Set container label
                plyr.container.setAttribute('aria-label', config.title);
            }

            // If there's a play button, set label
            if (plyr.supported.full && plyr.buttons.play) {
                for (var i = plyr.buttons.play.length - 1; i >= 0; i--) {
                    plyr.buttons.play[i].setAttribute('aria-label', label);
                }
            }

            // Set iframe title
            // https://github.com/Selz/plyr/issues/124
            if (_is.htmlElement(iframe)) {
                iframe.setAttribute('title', config.i18n.frameTitle.replace('{title}', config.title));
            }
        }

        // Setup localStorage
        function _setupStorage() {
            var value = null;
            plyr.storage = {};

            // Bail if we don't have localStorage support or it's disabled
            if (!_storage.supported || !config.storage.enabled) {
                return;
            }

            // Clean up old volume
            // https://github.com/Selz/plyr/issues/171
            window.localStorage.removeItem('plyr-volume');

            // load value from the current key
            value = window.localStorage.getItem(config.storage.key);

            if (!value) {
                // Key wasn't set (or had been cleared), move along
                return;
            } else if (/^\d+(\.\d+)?$/.test(value)) {
                // If value is a number, it's probably volume from an older
                // version of plyr. See: https://github.com/Selz/plyr/pull/313
                // Update the key to be JSON
                _updateStorage({volume: parseFloat(value)});
            } else {
                // Assume it's JSON from this or a later version of plyr
                plyr.storage = JSON.parse(value);
            }
        }

        // Save a value back to local storage
        function _updateStorage(value) {
            // Bail if we don't have localStorage support or it's disabled
            if (!_storage.supported || !config.storage.enabled) {
                return;
            }

            // Update the working copy of the values
            _extend(plyr.storage, value);

            // Update storage
            window.localStorage.setItem(config.storage.key, JSON.stringify(plyr.storage));
        }

        // Setup media
        function _setupMedia() {
            // If there's no media, bail
            if (!plyr.media) {
                _warn('No media element found!');
                return;
            }

            if (plyr.supported.full) {
                // Add type class
                _toggleClass(plyr.container, config.classes.type.replace('{0}', plyr.type), true);

                // Add video class for embeds
                // This will require changes if audio embeds are added
                if (_inArray(config.types.embed, plyr.type)) {
                    _toggleClass(plyr.container, config.classes.type.replace('{0}', 'video'), true);
                }

                // If there's no autoplay attribute, assume the video is stopped and add state class
                _toggleClass(plyr.container, config.classes.stopped, config.autoplay);

                // Add iOS class
                _toggleClass(plyr.ontainer, config.classes.isIos, plyr.browser.isIos);

                // Add touch class
                _toggleClass(plyr.container, config.classes.isTouch, plyr.browser.isTouch);

                // Inject the player wrapper
                if (plyr.type === 'video') {
                    // Create the wrapper div
                    var wrapper = document.createElement('div');
                    wrapper.setAttribute('class', config.classes.videoWrapper);

                    // Wrap the video in a container
                    _wrap(plyr.media, wrapper);

                    // Cache the container
                    plyr.videoContainer = wrapper;
                }
            }

            // Embeds
            if (_inArray(config.types.embed, plyr.type)) {
                _setupEmbed();
            }
        }

        // Setup YouTube/Vimeo
        function _setupEmbed() {
            var container = document.createElement('div'),
                mediaId,
                id = plyr.type + '-' + Math.floor(Math.random() * (10000));

            // Parse IDs from URLs if supplied
            switch (plyr.type) {
                case 'youtube':
                    mediaId = _parseYouTubeId(plyr.embedId);
                    break;

                case 'vimeo':
                    mediaId = _parseVimeoId(plyr.embedId);
                    break;

                default:
                    mediaId = plyr.embedId;
            }

            // Remove old containers
            var containers = _getElements('[id^="' + plyr.type + '-"]');
            for (var i = containers.length - 1; i >= 0; i--) {
                _remove(containers[i]);
            }

            // Add embed class for responsive
            _toggleClass(plyr.media, config.classes.videoWrapper, true);
            _toggleClass(plyr.media, config.classes.embedWrapper, true);

            if (plyr.type === 'youtube') {
                // Create the YouTube container
                plyr.media.appendChild(container);

                // Set ID
                container.setAttribute('id', id);

                // Setup API
                if (_is.object(window.YT)) {
                    _youTubeReady(mediaId, container);
                } else {
                    // Load the API
                    _injectScript(config.urls.youtube.api);

                    // Setup callback for the API
                    window.onYouTubeReadyCallbacks = window.onYouTubeReadyCallbacks || [];

                    // Add to queue
                    window.onYouTubeReadyCallbacks.push(function() { _youTubeReady(mediaId, container); });

                    // Set callback to process queue
                    window.onYouTubeIframeAPIReady = function () {
                        window.onYouTubeReadyCallbacks.forEach(function(callback) { callback(); });
                    };
                }
            } else if (plyr.type === 'vimeo') {
                // Vimeo needs an extra div to hide controls on desktop (which has full support)
                if (plyr.supported.full) {
                    plyr.media.appendChild(container);
                } else {
                    container = plyr.media;
                }

                // Set ID
                container.setAttribute('id', id);

                // Load the API if not already
                if (!_is.object(window.Vimeo)) {
                    _injectScript(config.urls.vimeo.api);

                    // Wait for fragaloop load
                    var vimeoTimer = window.setInterval(function() {
                        if (_is.object(window.Vimeo)) {
                            window.clearInterval(vimeoTimer);
                            _vimeoReady(mediaId, container);
                        }
                    }, 50);
                } else {
                    _vimeoReady(mediaId, container);
                }
            } else if (plyr.type === 'soundcloud') {
                // TODO: Currently unsupported and undocumented
                // Inject the iframe
                var soundCloud = document.createElement('iframe');

                // Watch for iframe load
                soundCloud.loaded = false;
                _on(soundCloud, 'load', function() { soundCloud.loaded = true; });

                _setAttributes(soundCloud, {
                    'src':  'https://w.soundcloud.com/player/?url=https://api.soundcloud.com/tracks/' + mediaId,
                    'id':   id
                });

                container.appendChild(soundCloud);
                plyr.media.appendChild(container);

                // Load the API if not already
                if (!window.SC) {
                    _injectScript(config.urls.soundcloud.api);
                }

                // Wait for SC load
                var soundCloudTimer = window.setInterval(function() {
                    if (window.SC && soundCloud.loaded) {
                        window.clearInterval(soundCloudTimer);
                        _soundcloudReady.call(soundCloud);
                    }
                }, 50);
            }
        }

        // When embeds are ready
        function _embedReady() {
            // Setup the UI and call ready if full support
            if (plyr.supported.full) {
                _setupInterface();
                _ready();
            }

            // Set title
            _setTitle(_getElement('iframe'));
        }

        // Handle YouTube API ready
        function _youTubeReady(videoId, container) {
            // Setup instance
            // https://developers.google.com/youtube/iframe_api_reference
            plyr.embed = new window.YT.Player(container.id, {
                videoId: videoId,
                playerVars: {
                    autoplay:       (config.autoplay ? 1 : 0),
                    controls:       (plyr.supported.full ? 0 : 1),
                    rel:            0,
                    showinfo:       0,
                    iv_load_policy: 3,
                    cc_load_policy: (config.captions.defaultActive ? 1 : 0),
                    cc_lang_pref:   'en',
                    wmode:          'transparent',
                    modestbranding: 1,
                    disablekb:      1,
                    origin:         '*' // https://code.google.com/p/gdata-issues/issues/detail?id=5788#c45
                },
                events: {
                    'onError': function(event) {
                        _triggerEvent(plyr.container, 'error', true, {
                            code:   event.data,
                            embed:  event.target
                        });
                    },
                    'onReady': function(event) {
                        // Get the instance
                        var instance = event.target;

                        // Create a faux HTML5 API using the YouTube API
                        plyr.media.play = function() {
                            instance.playVideo();
                            plyr.media.paused = false;
                        };
                        plyr.media.pause = function() {
                            instance.pauseVideo();
                            plyr.media.paused = true;
                        };
                        plyr.media.stop = function() {
                            instance.stopVideo();
                            plyr.media.paused = true;
                        };
                        plyr.media.duration = instance.getDuration();
                        plyr.media.paused = true;
                        plyr.media.currentTime = 0;
                        plyr.media.muted = instance.isMuted();

                        // Set title
                        config.title = instance.getVideoData().title;

                        // Set the tabindex
                        if (plyr.supported.full) {
                            plyr.media.querySelector('iframe').setAttribute('tabindex', '-1');
                        }

                        // Update UI
                        _embedReady();

                        // Trigger timeupdate
                        _triggerEvent(plyr.media, 'timeupdate');

                        // Trigger timeupdate
                        _triggerEvent(plyr.media, 'durationchange');

                        // Reset timer
                        window.clearInterval(timers.buffering);

                        // Setup buffering
                        timers.buffering = window.setInterval(function() {
                            // Get loaded % from YouTube
                            plyr.media.buffered = instance.getVideoLoadedFraction();

                            // Trigger progress only when we actually buffer something
                            if (plyr.media.lastBuffered === null || plyr.media.lastBuffered < plyr.media.buffered) {
                                _triggerEvent(plyr.media, 'progress');
                            }

                            // Set last buffer point
                            plyr.media.lastBuffered = plyr.media.buffered;

                            // Bail if we're at 100%
                            if (plyr.media.buffered === 1) {
                                window.clearInterval(timers.buffering);

                                // Trigger event
                                _triggerEvent(plyr.media, 'canplaythrough');
                            }
                        }, 200);
                    },
                    'onStateChange': function(event) {
                        // Get the instance
                        var instance = event.target;

                        // Reset timer
                        window.clearInterval(timers.playing);

                        // Handle events
                        // -1   Unstarted
                        // 0    Ended
                        // 1    Playing
                        // 2    Paused
                        // 3    Buffering
                        // 5    Video cued
                        switch (event.data) {
                            case 0:
                                plyr.media.paused = true;
                                _triggerEvent(plyr.media, 'ended');
                                break;

                            case 1:
                                plyr.media.paused = false;

                                // If we were seeking, fire seeked event
                                if (plyr.media.seeking) {
                                    _triggerEvent(plyr.media, 'seeked');
                                }

                                plyr.media.seeking = false;
                                _triggerEvent(plyr.media, 'play');
                                _triggerEvent(plyr.media, 'playing');

                                // Poll to get playback progress
                                timers.playing = window.setInterval(function() {
                                    // Set the current time
                                    plyr.media.currentTime = instance.getCurrentTime();

                                    // Trigger timeupdate
                                    _triggerEvent(plyr.media, 'timeupdate');
                                }, 100);

                                // Check duration again due to YouTube bug
                                // https://github.com/Selz/plyr/issues/374
                                // https://code.google.com/p/gdata-issues/issues/detail?id=8690
                                if (plyr.media.duration !== instance.getDuration()) {
                                    plyr.media.duration = instance.getDuration();
                                    _triggerEvent(plyr.media, 'durationchange');
                                }

                                break;

                            case 2:
                                plyr.media.paused = true;
                                _triggerEvent(plyr.media, 'pause');
                                break;
                        }

                        _triggerEvent(plyr.container, 'statechange', false, {
                            code: event.data
                        });
                    }
                }
            });
        }

        // Vimeo ready
        function _vimeoReady(mediaId, container) {
            // Setup instance
            // https://github.com/vimeo/player.js
            plyr.embed = new window.Vimeo.Player(container, {
                id:         parseInt(mediaId),
                loop:       config.loop,
                autoplay:   config.autoplay,
                byline:     false,
                portrait:   false,
                title:      false
            });

            // Create a faux HTML5 API using the Vimeo API
            plyr.media.play = function() {
                plyr.embed.play();
                plyr.media.paused = false;
            };
            plyr.media.pause = function() {
                plyr.embed.pause();
                plyr.media.paused = true;
            };
            plyr.media.stop = function() {
                plyr.embed.stop();
                plyr.media.paused = true;
            };

            plyr.media.paused = true;
            plyr.media.currentTime = 0;

            // Update UI
            _embedReady();

            plyr.embed.getCurrentTime().then(function(value) {
                plyr.media.currentTime = value;

                // Trigger timeupdate
                _triggerEvent(plyr.media, 'timeupdate');
            });

            plyr.embed.getDuration().then(function(value) {
                plyr.media.duration = value;

                // Trigger timeupdate
                _triggerEvent(plyr.media, 'durationchange');
            });

            // TODO: Captions
            /*if (config.captions.defaultActive) {
                plyr.embed.enableTextTrack('en');
            }*/

            plyr.embed.on('loaded', function() {
                // Fix keyboard focus issues
                // https://github.com/Selz/plyr/issues/317
                if (_is.htmlElement(plyr.embed.element) && plyr.supported.full) {
                    plyr.embed.element.setAttribute('tabindex', '-1');
                }
            });

            plyr.embed.on('play', function() {
                plyr.media.paused = false;
                _triggerEvent(plyr.media, 'play');
                _triggerEvent(plyr.media, 'playing');
            });

            plyr.embed.on('pause', function() {
                plyr.media.paused = true;
                _triggerEvent(plyr.media, 'pause');
            });

            plyr.embed.on('timeupdate', function(data) {
                plyr.media.seeking = false;
                plyr.media.currentTime = data.seconds;
                _triggerEvent(plyr.media, 'timeupdate');
            });

            plyr.embed.on('progress', function(data) {
                plyr.media.buffered = data.percent;
                _triggerEvent(plyr.media, 'progress');

                if (parseInt(data.percent) === 1) {
                    // Trigger event
                    _triggerEvent(plyr.media, 'canplaythrough');
                }
            });

            plyr.embed.on('seeked', function() {
                plyr.media.seeking = false;
                _triggerEvent(plyr.media, 'seeked');
                _triggerEvent(plyr.media, 'play');
            });

            plyr.embed.on('ended', function() {
                plyr.media.paused = true;
                _triggerEvent(plyr.media, 'ended');
            });
        }

        // Soundcloud ready
        function _soundcloudReady() {
            /* jshint validthis: true */
            plyr.embed = window.SC.Widget(this);

            // Setup on ready
            plyr.embed.bind(window.SC.Widget.Events.READY, function() {
                // Create a faux HTML5 API using the Soundcloud API
                plyr.media.play = function() {
                    plyr.embed.play();
                    plyr.media.paused = false;
                };
                plyr.media.pause = function() {
                    plyr.embed.pause();
                    plyr.media.paused = true;
                };
                plyr.media.stop = function() {
                    plyr.embed.seekTo(0);
                    plyr.embed.pause();
                    plyr.media.paused = true;
                };

                plyr.media.paused = true;
                plyr.media.currentTime = 0;

                plyr.embed.getDuration(function(value) {
                    plyr.media.duration = value/1000;

                    // Update UI
                    _embedReady();
                });

                plyr.embed.getPosition(function(value) {
                    plyr.media.currentTime = value;

                    // Trigger timeupdate
                    _triggerEvent(plyr.media, 'timeupdate');
                });

                plyr.embed.bind(window.SC.Widget.Events.PLAY, function() {
                    plyr.media.paused = false;
                    _triggerEvent(plyr.media, 'play');
                    _triggerEvent(plyr.media, 'playing');
                });

                plyr.embed.bind(window.SC.Widget.Events.PAUSE, function() {
                    plyr.media.paused = true;
                    _triggerEvent(plyr.media, 'pause');
                });

                plyr.embed.bind(window.SC.Widget.Events.PLAY_PROGRESS, function(data) {
                    plyr.media.seeking = false;
                    plyr.media.currentTime = data.currentPosition/1000;
                    _triggerEvent(plyr.media, 'timeupdate');
                });

                plyr.embed.bind(window.SC.Widget.Events.LOAD_PROGRESS, function(data) {
                    plyr.media.buffered = data.loadProgress;
                    _triggerEvent(plyr.media, 'progress');

                    if (parseInt(data.loadProgress) === 1) {
                        // Trigger event
                        _triggerEvent(plyr.media, 'canplaythrough');
                    }
                });

                plyr.embed.bind(window.SC.Widget.Events.FINISH, function() {
                    plyr.media.paused = true;
                    _triggerEvent(plyr.media, 'ended');
                });
            });
        }

        // Play media
        function _play() {
            if ('play' in plyr.media) {
                plyr.media.play();
            }
        }

        // Pause media
        function _pause() {
            if ('pause' in plyr.media) {
                plyr.media.pause();
            }
        }

        // Toggle playback
        function _togglePlay(toggle) {
            // True toggle
            if (!_is.boolean(toggle)) {
                toggle = plyr.media.paused;
            }

            if (toggle) {
                _play();
            } else {
                _pause();
            }

            return toggle;
        }

        // Rewind
        function _rewind(seekTime) {
            // Use default if needed
            if (!_is.number(seekTime)) {
                seekTime = config.seekTime;
            }
            _seek(plyr.media.currentTime - seekTime);
        }

        // Fast forward
        function _forward(seekTime) {
            // Use default if needed
            if (!_is.number(seekTime)) {
                seekTime = config.seekTime;
            }
            _seek(plyr.media.currentTime + seekTime);
        }

        // Seek to time
        // The input parameter can be an event or a number
        function _seek(input) {
            var targetTime  = 0,
                paused      = plyr.media.paused,
                duration    = _getDuration();

            if (_is.number(input)) {
                targetTime = input;
            } else if (_is.object(input) && _inArray(['input', 'change'], input.type)) {
                // It's the seek slider
                // Seek to the selected time
                targetTime = ((input.target.value / input.target.max) * duration);
            }

            // Normalise targetTime
            if (targetTime < 0) {
                targetTime = 0;
            } else if (targetTime > duration) {
                targetTime = duration;
            }

            // Update seek range and progress
            _updateSeekDisplay(targetTime);

            // Set the current time
            // Try/catch incase the media isn't set and we're calling seek() from source() and IE moans
            try {
                plyr.media.currentTime = targetTime.toFixed(4);
            }
            catch(e) {}

            // Embeds
            if (_inArray(config.types.embed, plyr.type)) {
                switch(plyr.type) {
                    case 'youtube':
                        plyr.embed.seekTo(targetTime);
                        break;

                    case 'vimeo':
                        // Round to nearest second for vimeo
                        plyr.embed.setCurrentTime(targetTime.toFixed(0));
                        break;

                    case 'soundcloud':
                        plyr.embed.seekTo(targetTime * 1000);
                        break;
                }

                if (paused) {
                    _pause();
                }

                // Trigger timeupdate
                _triggerEvent(plyr.media, 'timeupdate');

                // Set seeking flag
                plyr.media.seeking = true;

                // Trigger seeking
                _triggerEvent(plyr.media, 'seeking');
            }

            // Logging
            _log('Seeking to ' + plyr.media.currentTime + ' seconds');

            // Special handling for 'manual' captions
            _seekManualCaptions(targetTime);
        }

        // Get the duration (or custom if set)
        function _getDuration() {
            // It should be a number, but parse it just incase
            var duration = parseInt(config.duration),

            // True duration
            mediaDuration = 0;

            // Only if duration available
            if (plyr.media.duration !== null && !isNaN(plyr.media.duration)) {
                mediaDuration = plyr.media.duration;
            }

            // If custom duration is funky, use regular duration
            return (isNaN(duration) ? mediaDuration : duration);
        }

        // Check playing state
        function _checkPlaying() {
            _toggleClass(plyr.container, config.classes.playing, !plyr.media.paused);

            _toggleClass(plyr.container, config.classes.stopped, plyr.media.paused);

            _toggleControls(plyr.media.paused);
        }

        // Save scroll position
        function _saveScrollPosition() {
            scroll = {
                x: window.pageXOffset || 0,
                y: window.pageYOffset || 0
            };
        }

        // Restore scroll position
        function _restoreScrollPosition() {
            window.scrollTo(scroll.x, scroll.y);
        }

        // Toggle fullscreen
        function _toggleFullscreen(event) {
            // Check for native support
            var nativeSupport = fullscreen.supportsFullScreen;

            if (nativeSupport) {
                // If it's a fullscreen change event, update the UI
                if (event && event.type === fullscreen.fullScreenEventName) {
                    plyr.isFullscreen = fullscreen.isFullScreen(plyr.container);
                } else {
                    // Else it's a user request to enter or exit
                    if (!fullscreen.isFullScreen(plyr.container)) {
                        // Save scroll position
                        _saveScrollPosition();

                        // Request full screen
                        fullscreen.requestFullScreen(plyr.container);
                    } else {
                        // Bail from fullscreen
                        fullscreen.cancelFullScreen();
                    }

                    // Check if we're actually full screen (it could fail)
                    plyr.isFullscreen = fullscreen.isFullScreen(plyr.container);

                    return;
                }
            } else {
                // Otherwise, it's a simple toggle
                plyr.isFullscreen = !plyr.isFullscreen;

                // Bind/unbind escape key
                document.body.style.overflow = plyr.isFullscreen ? 'hidden' : '';
            }

            // Set class hook
            _toggleClass(plyr.container, config.classes.fullscreen.active, plyr.isFullscreen);

            // Trap focus
            _focusTrap(plyr.isFullscreen);

            // Set button state
            if (plyr.buttons && plyr.buttons.fullscreen) {
                _toggleState(plyr.buttons.fullscreen, plyr.isFullscreen);
            }

            // Trigger an event
            _triggerEvent(plyr.container, plyr.isFullscreen ? 'enterfullscreen' : 'exitfullscreen', true);

            // Restore scroll position
            if (!plyr.isFullscreen && nativeSupport) {
                _restoreScrollPosition();
            }
        }

        // Mute
        function _toggleMute(muted) {
            // If the method is called without parameter, toggle based on current value
            if (!_is.boolean(muted)) {
                muted = !plyr.media.muted;
            }

            // Set button state
            _toggleState(plyr.buttons.mute, muted);

            // Set mute on the player
            plyr.media.muted = muted;

            // If volume is 0 after unmuting, set to default
            if (plyr.media.volume === 0) {
                _setVolume(config.volume);
            }

            // Embeds
            if (_inArray(config.types.embed, plyr.type)) {
                // YouTube
                switch(plyr.type) {
                    case 'youtube':
                        plyr.embed[plyr.media.muted ? 'mute' : 'unMute']();
                        break;

                    case 'vimeo':
                    case 'soundcloud':
                        plyr.embed.setVolume(plyr.media.muted ? 0 : parseFloat(config.volume / config.volumeMax));
                        break;
                }

                // Trigger volumechange for embeds
                _triggerEvent(plyr.media, 'volumechange');
            }
        }

        // Set volume
        function _setVolume(volume) {
            var max = config.volumeMax,
                min = config.volumeMin;

            // Load volume from storage if no value specified
            if (_is.undefined(volume)) {
                volume = plyr.storage.volume;
            }

            // Use config if all else fails
            if (volume === null || isNaN(volume)) {
                volume = config.volume;
            }

            // Maximum is volumeMax
            if (volume > max) {
                volume = max;
            }
            // Minimum is volumeMin
            if (volume < min) {
                volume = min;
            }

            // Set the player volume
            plyr.media.volume = parseFloat(volume / max);

            // Set the display
            if (plyr.volume.display) {
                plyr.volume.display.value = volume;
            }

            // Embeds
            if (_inArray(config.types.embed, plyr.type)) {
                switch(plyr.type) {
                    case 'youtube':
                        plyr.embed.setVolume(plyr.media.volume * 100);
                        break;

                    case 'vimeo':
                    case 'soundcloud':
                        plyr.embed.setVolume(plyr.media.volume);
                        break;
                }

                // Trigger volumechange for embeds
                _triggerEvent(plyr.media, 'volumechange');
            }

            // Toggle muted state
            if (volume === 0) {
                plyr.media.muted = true;
            } else if (plyr.media.muted && volume > 0) {
                _toggleMute();
            }
        }

        // Increase volume
        function _increaseVolume(step) {
            var volume = plyr.media.muted ? 0 : (plyr.media.volume * config.volumeMax);

            if (!_is.number(step)) {
                step = config.volumeStep;
            }

            _setVolume(volume + step);
        }

        // Decrease volume
        function _decreaseVolume(step) {
            var volume = plyr.media.muted ? 0 : (plyr.media.volume * config.volumeMax);

            if (!_is.number(step)) {
                step = config.volumeStep;
            }

            _setVolume(volume - step);
        }

        // Update volume UI and storage
        function _updateVolume() {
            // Get the current volume
            var volume = plyr.media.muted ? 0 : (plyr.media.volume * config.volumeMax);

            // Update the <input type="range"> if present
            if (plyr.supported.full) {
                if (plyr.volume.input) {
                    plyr.volume.input.value = volume;
                }
                if (plyr.volume.display) {
                    plyr.volume.display.value = volume;
                }
            }

            // Update the volume in storage
            _updateStorage({volume: volume});

            // Toggle class if muted
            _toggleClass(plyr.container, config.classes.muted, (volume === 0));

            // Update checkbox for mute state
            if (plyr.supported.full && plyr.buttons.mute) {
                _toggleState(plyr.buttons.mute, (volume === 0));
            }
        }

        // Toggle captions
        function _toggleCaptions(show) {
            // If there's no full support, or there's no caption toggle
            if (!plyr.supported.full || !plyr.buttons.captions) {
                return;
            }

            // If the method is called without parameter, toggle based on current value
            if (!_is.boolean(show)) {
                show = (plyr.container.className.indexOf(config.classes.captions.active) === -1);
            }

            // Set global
            plyr.captionsEnabled = show;

            // Toggle state
            _toggleState(plyr.buttons.captions, plyr.captionsEnabled);

            // Add class hook
            _toggleClass(plyr.container, config.classes.captions.active, plyr.captionsEnabled);

            // Trigger an event
            _triggerEvent(plyr.container, plyr.captionsEnabled ? 'captionsenabled' : 'captionsdisabled', true);

            // Save captions state to localStorage
            _updateStorage({captionsEnabled: plyr.captionsEnabled});
        }

        // Check if media is loading
        function _checkLoading(event) {
            var loading = (event.type === 'waiting');

            // Clear timer
            clearTimeout(timers.loading);

            // Timer to prevent flicker when seeking
            timers.loading = setTimeout(function() {
                // Toggle container class hook
                _toggleClass(plyr.container, config.classes.loading, loading);

                // Show controls if loading, hide if done
                _toggleControls(loading);
            }, (loading ? 250 : 0));
        }

        // Update <progress> elements
        function _updateProgress(event) {
            if (!plyr.supported.full) {
                return;
            }

            var progress    = plyr.progress.played,
                value       = 0,
                duration    = _getDuration();

            if (event) {
                switch (event.type) {
                    // Video playing
                    case 'timeupdate':
                    case 'seeking':
                        if (plyr.controls.pressed) {
                            return;
                        }

                        value = _getPercentage(plyr.media.currentTime, duration);

                        // Set seek range value only if it's a 'natural' time event
                        if (event.type === 'timeupdate' && plyr.buttons.seek) {
                            plyr.buttons.seek.value = value;
                        }

                        break;

                    // Check buffer status
                    case 'playing':
                    case 'progress':
                        progress    = plyr.progress.buffer;
                        value       = (function() {
                            var buffered = plyr.media.buffered;

                            if (buffered && buffered.length) {
                                // HTML5
                                return _getPercentage(buffered.end(0), duration);
                            } else if (_is.number(buffered)) {
                                // YouTube returns between 0 and 1
                                return (buffered * 100);
                            }

                            return 0;
                        })();

                        break;
                }
            }

            // Set values
            _setProgress(progress, value);
        }

        // Set <progress> value
        function _setProgress(progress, value) {
            if (!plyr.supported.full) {
                return;
            }

            // Default to 0
            if (_is.undefined(value)) {
                value = 0;
            }
            // Default to buffer or bail
            if (_is.undefined(progress)) {
                if (plyr.progress && plyr.progress.buffer) {
                    progress = plyr.progress.buffer;
                } else {
                    return;
                }
            }

            // One progress element passed
            if (_is.htmlElement(progress)) {
                progress.value = value;
            } else if (progress) {
                // Object of progress + text element
                if (progress.bar) {
                    progress.bar.value = value;
                }
                if (progress.text) {
                    progress.text.innerHTML = value;
                }
            }
        }

        // Update the displayed time
        function _updateTimeDisplay(time, element) {
            // Bail if there's no duration display
            if (!element) {
                return;
            }

            // Fallback to 0
            if (isNaN(time)) {
                time = 0;
            }

            plyr.secs = parseInt(time % 60);
            plyr.mins = parseInt((time / 60) % 60);
            plyr.hours = parseInt(((time / 60) / 60) % 60);

            // Do we need to display hours?
            var displayHours = (parseInt(((_getDuration() / 60) / 60) % 60) > 0);

            // Ensure it's two digits. For example, 03 rather than 3.
            plyr.secs = ('0' + plyr.secs).slice(-2);
            plyr.mins = ('0' + plyr.mins).slice(-2);

            // Render
            element.innerHTML = (displayHours ? plyr.hours + ':' : '') + plyr.mins + ':' + plyr.secs;
        }

        // Show the duration on metadataloaded
        function _displayDuration() {
            if (!plyr.supported.full) {
                return;
            }

            // Determine duration
            var duration = _getDuration() || 0;

            // If there's only one time display, display duration there
            if (!plyr.duration && config.displayDuration && plyr.media.paused) {
                _updateTimeDisplay(duration, plyr.currentTime);
            }

            // If there's a duration element, update content
            if (plyr.duration) {
                _updateTimeDisplay(duration, plyr.duration);
            }

            // Update the tooltip (if visible)
            _updateSeekTooltip();
        }

        // Handle time change event
        function _timeUpdate(event) {
            // Duration
            _updateTimeDisplay(plyr.media.currentTime, plyr.currentTime);

            // Ignore updates while seeking
            if (event && event.type === 'timeupdate' && plyr.media.seeking) {
                return;
            }

            // Playing progress
            _updateProgress(event);
        }

        // Update seek range and progress
        function _updateSeekDisplay(time) {
            // Default to 0
            if (!_is.number(time)) {
                time = 0;
            }

            var duration    = _getDuration(),
                value       = _getPercentage(time, duration);

            // Update progress
            if (plyr.progress && plyr.progress.played) {
                plyr.progress.played.value = value;
            }

            // Update seek range input
            if (plyr.buttons && plyr.buttons.seek) {
                plyr.buttons.seek.value = value;
            }
        }

        // Update hover tooltip for seeking
        function _updateSeekTooltip(event) {
            var duration = _getDuration();

            // Bail if setting not true
            if (!config.tooltips.seek || !plyr.progress.container || duration === 0) {
                return;
            }

            // Calculate percentage
            var clientRect  = plyr.progress.container.getBoundingClientRect(),
                percent     = 0,
                visible     = config.classes.tooltip + '--visible';

            // Determine percentage, if already visible
            if (!event) {
                if (_hasClass(plyr.progress.tooltip, visible)) {
                    percent = plyr.progress.tooltip.style.left.replace('%', '');
                } else {
                    return;
                }
            } else {
                percent = ((100 / clientRect.width) * (event.pageX - clientRect.left));
            }

            // Set bounds
            if (percent < 0) {
                percent = 0;
            } else if (percent > 100) {
                percent = 100;
            }

            // Display the time a click would seek to
            _updateTimeDisplay(((duration / 100) * percent), plyr.progress.tooltip);

            // Set position
            plyr.progress.tooltip.style.left = percent + "%";

            // Show/hide the tooltip
            // If the event is a moues in/out and percentage is inside bounds
            if (event && _inArray(['mouseenter', 'mouseleave'], event.type)) {
                _toggleClass(plyr.progress.tooltip, visible, (event.type === 'mouseenter'));
            }
        }

        // Show the player controls in fullscreen mode
        function _toggleControls(toggle) {
            // Don't hide if config says not to, it's audio, or not ready or loading
            if (!config.hideControls || plyr.type === 'audio') {
                return;
            }

            var delay = 0,
                isEnterFullscreen = false,
                show = toggle,
                loading = _hasClass(plyr.container, config.classes.loading);

            // Default to false if no boolean
            if (!_is.boolean(toggle)) {
                if (toggle && toggle.type) {
                    // Is the enter fullscreen event
                    isEnterFullscreen = (toggle.type === 'enterfullscreen');

                    // Whether to show controls
                    show = _inArray(['mousemove', 'touchstart', 'mouseenter', 'focus'], toggle.type);

                    // Delay hiding on move events
                    if (_inArray(['mousemove', 'touchmove'], toggle.type)) {
                        delay = 2000;
                    }

                    // Delay a little more for keyboard users
                    if (toggle.type === 'focus') {
                        delay = 3000;
                    }
                } else {
                    show = _hasClass(plyr.container, config.classes.hideControls);
                }
            }

            // Clear timer every movement
            window.clearTimeout(timers.hover);

            // If the mouse is not over the controls, set a timeout to hide them
            if (show || plyr.media.paused || loading) {
                _toggleClass(plyr.container, config.classes.hideControls, false);

                // Always show controls when paused or if touch
                if (plyr.media.paused || loading) {
                    return;
                }

                // Delay for hiding on touch
                if (plyr.browser.isTouch) {
                    delay = 3000;
                }
            }

            // If toggle is false or if we're playing (regardless of toggle),
            // then set the timer to hide the controls
            if (!show || !plyr.media.paused) {
                timers.hover = window.setTimeout(function() {
                    // If the mouse is over the controls (and not entering fullscreen), bail
                    if ((plyr.controls.pressed || plyr.controls.hover) && !isEnterFullscreen) {
                        return;
                    }

                    _toggleClass(plyr.container, config.classes.hideControls, true);
                }, delay);
            }
        }

        // Add common function to retrieve media source
        function _source(source) {
            // If not null or undefined, parse it
            if (!_is.undefined(source)) {
                _updateSource(source);
                return;
            }

            // Return the current source
            var url;
            switch(plyr.type) {
                case 'youtube':
                    url = plyr.embed.getVideoUrl();
                    break;

                case 'vimeo':
                    plyr.embed.getVideoUrl.then(function (value) {
                        url = value;
                    });
                    break;

                case 'soundcloud':
                    plyr.embed.getCurrentSound(function(object) {
                        url = object.permalink_url;
                    });
                    break;

                default:
                    url = plyr.media.currentSrc;
                    break;
            }

            return url || '';
        }

        // Update source
        // Sources are not checked for support so be careful
        function _updateSource(source) {
            if (!_is.object(source) || !('sources' in source) || !source.sources.length) {
                _warn('Invalid source format');
                return;
            }

            // Remove ready class hook
            _toggleClass(plyr.container, config.classes.ready, false);

            // Pause playback
            _pause();

            // Update seek range and progress
            _updateSeekDisplay();

            // Reset buffer progress
            _setProgress();

            // Cancel current network requests
            _cancelRequests();

            // Setup new source
            function setup() {
                // Remove embed object
                plyr.embed = null;

                // Remove the old media
                _remove(plyr.media);

                // Remove video container
                if (plyr.type === 'video' && plyr.videoContainer) {
                    _remove(plyr.videoContainer);
                }

                // Reset class name
                if (plyr.container) {
                    plyr.container.removeAttribute('class');
                }

                // Set the type
                if ('type' in source) {
                    plyr.type = source.type;

                    // Get child type for video (it might be an embed)
                    if (plyr.type === 'video') {
                        var firstSource = source.sources[0];

                        if ('type' in firstSource && _inArray(config.types.embed, firstSource.type)) {
                            plyr.type = firstSource.type;
                        }
                    }
                }

                // Check for support
                plyr.supported = supported(plyr.type);

                // Create new markup
                switch(plyr.type) {
                    case 'video':
                        plyr.media = document.createElement('video');
                        break;

                    case 'audio':
                        plyr.media = document.createElement('audio');
                        break;

                    case 'youtube':
                    case 'vimeo':
                    case 'soundcloud':
                        plyr.media = document.createElement('div');
                        plyr.embedId = source.sources[0].src;
                        break;
                }

                // Inject the new element
                _prependChild(plyr.container, plyr.media);

                // Autoplay the new source?
                if (_is.boolean(source.autoplay)) {
                    config.autoplay = source.autoplay;
                }

                // Set attributes for audio and video
                if (_inArray(config.types.html5, plyr.type)) {
                    if (config.crossorigin) {
                        plyr.media.setAttribute('crossorigin', '');
                    }
                    if (config.autoplay) {
                        plyr.media.setAttribute('autoplay', '');
                    }
                    if ('poster' in source) {
                        plyr.media.setAttribute('poster', source.poster);
                    }
                    if (config.loop) {
                        plyr.media.setAttribute('loop', '');
                    }
                }

                // Restore class hooks
                _toggleClass(plyr.container, config.classes.fullscreen.active, plyr.isFullscreen);
                _toggleClass(plyr.container, config.classes.captions.active, plyr.captionsEnabled);
                _toggleStyleHook();

                // Set new sources for html5
                if (_inArray(config.types.html5, plyr.type)) {
                    _insertChildElements('source', source.sources);
                }

                // Set up from scratch
                _setupMedia();

                // HTML5 stuff
                if (_inArray(config.types.html5, plyr.type)) {
                    // Setup captions
                    if ('tracks' in source) {
                        _insertChildElements('track', source.tracks);
                    }

                    // Load HTML5 sources
                    plyr.media.load();
                }

                // If HTML5 or embed but not fully supported, setupInterface and call ready now
                if (_inArray(config.types.html5, plyr.type) || (_inArray(config.types.embed, plyr.type) && !plyr.supported.full)) {
                    // Setup interface
                    _setupInterface();

                    // Call ready
                    _ready();
                }

                // Set aria title and iframe title
                config.title = source.title;
                _setTitle();
            }

            // Destroy instance adn wait for callback
            // Vimeo throws a wobbly if you don't wait
            _destroy(setup, false);
        }

        // Update poster
        function _updatePoster(source) {
            if (plyr.type === 'video') {
                plyr.media.setAttribute('poster', source);
            }
        }

        // Listen for control events
        function _controlListeners() {
            // IE doesn't support input event, so we fallback to change
            var inputEvent = (plyr.browser.isIE ? 'change' : 'input');

            // Click play/pause helper
            function togglePlay() {
                var play = _togglePlay();

                // Determine which buttons
                var trigger = plyr.buttons[play ? 'play' : 'pause'],
                    target = plyr.buttons[play ? 'pause' : 'play'];

                // Get the last play button to account for the large play button
                if (target && target.length > 1) {
                    target = target[target.length - 1];
                } else {
                    target = target[0];
                }

                // Setup focus and tab focus
                if (target) {
                    var hadTabFocus = _hasClass(trigger, config.classes.tabFocus);

                    setTimeout(function() {
                        target.focus();

                        if (hadTabFocus) {
                            _toggleClass(trigger, config.classes.tabFocus, false);
                            _toggleClass(target, config.classes.tabFocus, true);
                        }
                    }, 100);
                }
            }

            // Get the focused element
            function getFocusElement() {
                var focused = document.activeElement;

                if (!focused || focused === document.body) {
                    focused = null;
                } else {
                    focused = document.querySelector(':focus');
                }

                return focused;
            }

            // Get the key code for an event
            function getKeyCode(event) {
                return event.keyCode ? event.keyCode : event.which;
            }

            // Detect tab focus
            function checkTabFocus(focused) {
                for (var button in plyr.buttons) {
                    var element = plyr.buttons[button];

                    if (_is.nodeList(element)) {
                        for (var i = 0; i < element.length; i++) {
                            _toggleClass(element[i], config.classes.tabFocus, (element[i] === focused));
                        }
                    } else {
                        _toggleClass(element, config.classes.tabFocus, (element === focused));
                    }
                }
            }

            // Keyboard shortcuts
            if (config.keyboardShorcuts.focused) {
                var last = null;

                // Handle global presses
                if (config.keyboardShorcuts.global) {
                    _on(window, 'keydown keyup', function(event) {
                        var code = getKeyCode(event),
                        focused = getFocusElement(),
                        allowed = [48,49,50,51,52,53,54,56,57,75,77,70,67],
                        count   = get().length;

                        // Only handle global key press if there's only one player
                        // and the key is in the allowed keys
                        // and if the focused element is not editable (e.g. text input)
                        // and any that accept key input http://webaim.org/techniques/keyboard/
                        if (count === 1 && _inArray(allowed, code) && (!_is.htmlElement(focused) || !_matches(focused, config.selectors.editable))) {
                            handleKey(event);
                        }
                    });
                }

                // Handle presses on focused
                _on(plyr.container, 'keydown keyup', handleKey);
            }

            function handleKey(event) {
                var code = getKeyCode(event),
                    pressed = event.type === 'keydown',
                    held = pressed && code === last;

                // If the event is bubbled from the media element
                // Firefox doesn't get the keycode for whatever reason
                if (!_is.number(code)) {
                    return;
                }

                // Seek by the number keys
                function seekByKey() {
                    // Get current duration
                    var duration = plyr.media.duration;

                    // Bail if we have no duration set
                    if (!_is.number(duration)) {
                        return;
                    }

                    // Divide the max duration into 10th's and times by the number value
                    _seek((duration / 10) * (code - 48));
                }

                // Handle the key on keydown
                // Reset on keyup
                if (pressed) {
                    // Which keycodes should we prevent default
                    var preventDefault = [48,49,50,51,52,53,54,56,57,32,75,38,40,77,39,37,70,67];

                    // If the code is found prevent default (e.g. prevent scrolling for arrows)
                    if (_inArray(preventDefault, code)) {
                        event.preventDefault();
                        event.stopPropagation();
                    }

                    switch(code) {
                        // 0-9
                        case 48:
                        case 49:
                        case 50:
                        case 51:
                        case 52:
                        case 53:
                        case 54:
                        case 55:
                        case 56:
                        case 57: if (!held) { seekByKey(); } break;
                        // Space and K key
                        case 32:
                        case 75: if (!held) { _togglePlay(); } break;
                        // Arrow up
                        case 38: _increaseVolume(); break;
                        // Arrow down
                        case 40: _decreaseVolume(); break;
                        // M key
                        case 77: if (!held) { _toggleMute() } break;
                        // Arrow forward
                        case 39: _forward(); break;
                        // Arrow back
                        case 37: _rewind(); break;
                        // F key
                        case 70: _toggleFullscreen(); break;
                        // C key
                        case 67: if (!held) { _toggleCaptions(); } break;
                    }

                    // Escape is handle natively when in full screen
                    // So we only need to worry about non native
                    if (!fullscreen.supportsFullScreen && plyr.isFullscreen && code === 27) {
                        _toggleFullscreen();
                    }

                    // Store last code for next cycle
                    last = code;
                } else {
                    last = null;
                }
            }

            // Focus/tab management
            _on(window, 'keyup', function(event) {
                var code = getKeyCode(event),
                    focused = getFocusElement();

                if (code === 9) {
                    checkTabFocus(focused);
                }
            });
            _on(document.body, 'click', function() {
                _toggleClass(_getElement('.' + config.classes.tabFocus), config.classes.tabFocus, false);
            });
            for (var button in plyr.buttons) {
                var element = plyr.buttons[button];

                _on(element, 'blur', function() {
                    _toggleClass(element, 'tab-focus', false);
                });
            }

            // Play
            _proxyListener(plyr.buttons.play, 'click', config.listeners.play, togglePlay);

            // Pause
            _proxyListener(plyr.buttons.pause, 'click', config.listeners.pause, togglePlay);

            // Restart
            _proxyListener(plyr.buttons.restart, 'click', config.listeners.restart, _seek);

            // Rewind
            _proxyListener(plyr.buttons.rewind, 'click', config.listeners.rewind, _rewind);

            // Fast forward
            _proxyListener(plyr.buttons.forward, 'click', config.listeners.forward, _forward);

            // Seek
            _proxyListener(plyr.buttons.seek, inputEvent, config.listeners.seek, _seek);

            // Set volume
            _proxyListener(plyr.volume.input, inputEvent, config.listeners.volume, function() {
                _setVolume(plyr.volume.input.value);
            });

            // Mute
            _proxyListener(plyr.buttons.mute, 'click', config.listeners.mute, _toggleMute);

            // Fullscreen
            _proxyListener(plyr.buttons.fullscreen, 'click', config.listeners.fullscreen, _toggleFullscreen);

            // Handle user exiting fullscreen by escaping etc
            if (fullscreen.supportsFullScreen) {
                _on(document, fullscreen.fullScreenEventName, _toggleFullscreen);
            }

            // Captions
            _on(plyr.buttons.captions, 'click', _toggleCaptions);

            // Seek tooltip
            _on(plyr.progress.container, 'mouseenter mouseleave mousemove', _updateSeekTooltip);

            // Toggle controls visibility based on mouse movement
            if (config.hideControls) {
                // Toggle controls on mouse events and entering fullscreen
                _on(plyr.container, 'mouseenter mouseleave mousemove touchstart touchend touchcancel touchmove enterfullscreen', _toggleControls);

                // Watch for cursor over controls so they don't hide when trying to interact
                _on(plyr.controls, 'mouseenter mouseleave', function(event) {
                    plyr.controls.hover = event.type === 'mouseenter';
                });

                 // Watch for cursor over controls so they don't hide when trying to interact
                _on(plyr.controls, 'mousedown mouseup touchstart touchend touchcancel', function(event) {
                    plyr.controls.pressed = _inArray(['mousedown', 'touchstart'], event.type);
                });

                // Focus in/out on controls
                _on(plyr.controls, 'focus blur', _toggleControls, true);
            }

            // Adjust volume on scroll
            _on(plyr.volume.input, 'wheel', function(event) {
                event.preventDefault();

                // Detect "natural" scroll - suppored on OS X Safari only
                // Other browsers on OS X will be inverted until support improves
                var inverted = event.webkitDirectionInvertedFromDevice,
                    step = (config.volumeStep / 5);

                // Scroll down (or up on natural) to decrease
                if (event.deltaY < 0 || event.deltaX > 0) {
                    if (inverted) {
                        _decreaseVolume(step);
                    } else {
                        _increaseVolume(step);
                    }
                }

                // Scroll up (or down on natural) to increase
                if (event.deltaY > 0 || event.deltaX < 0) {
                    if (inverted) {
                        _increaseVolume(step);
                    } else {
                        _decreaseVolume(step);
                    }
                }
            });
        }

        // Listen for media events
        function _mediaListeners() {
            // Time change on media
            _on(plyr.media, 'timeupdate seeking', _timeUpdate);

            // Update manual captions
            _on(plyr.media, 'timeupdate', _seekManualCaptions);

            // Display duration
            _on(plyr.media, 'durationchange loadedmetadata', _displayDuration);

            // Handle the media finishing
            _on(plyr.media, 'ended', function() {
                // Show poster on end
                if (plyr.type === 'video' && config.showPosterOnEnd) {
                    // Clear
                    if (plyr.type === 'video') {
                        _setCaption();
                    }

                    // Restart
                    _seek();

                    // Re-load media
                    plyr.media.load();
                }
            });

            // Check for buffer progress
            _on(plyr.media, 'progress playing', _updateProgress);

            // Handle native mute
            _on(plyr.media, 'volumechange', _updateVolume);

            // Handle native play/pause
            _on(plyr.media, 'play pause ended', _checkPlaying);

            // Loading
            _on(plyr.media, 'waiting canplay seeked', _checkLoading);

            // Click video
            if (config.clickToPlay && plyr.type !== 'audio') {
                // Re-fetch the wrapper
                var wrapper = _getElement('.' + config.classes.videoWrapper);

                // Bail if there's no wrapper (this should never happen)
                if (!wrapper) {
                    return;
                }

                // Set cursor
                wrapper.style.cursor = "pointer";

                // On click play, pause ore restart
                _on(wrapper, 'click', function() {
                    // Touch devices will just show controls (if we're hiding controls)
                    if (config.hideControls && plyr.browser.isTouch && !plyr.media.paused) {
                        return;
                    }

                    if (plyr.media.paused) {
                        _play();
                    } else if (plyr.media.ended) {
                        _seek();
                        _play();
                    } else {
                        _pause();
                    }
                });
            }

            // Disable right click
            if (config.disableContextMenu) {
                _on(plyr.media, 'contextmenu', function(event) { event.preventDefault(); });
            }

            // Proxy events to container
            // Bubble up key events for Edge
            _on(plyr.media, config.events.concat(['keyup', 'keydown']).join(' '), function(event) {
                _triggerEvent(plyr.container, event.type, true);
            });
        }

        // Cancel current network requests
        // See https://github.com/Selz/plyr/issues/174
        function _cancelRequests() {
            if (!_inArray(config.types.html5, plyr.type)) {
                return;
            }

            // Remove child sources
            var sources = plyr.media.querySelectorAll('source');
            for (var i = 0; i < sources.length; i++) {
                _remove(sources[i]);
            }

            // Set blank video src attribute
            // This is to prevent a MEDIA_ERR_SRC_NOT_SUPPORTED error
            // Info: http://stackoverflow.com/questions/32231579/how-to-properly-dispose-of-an-html5-video-and-close-socket-or-connection
            plyr.media.setAttribute('src', 'https://cdn.selz.com/plyr/blank.mp4');

            // Load the new empty source
            // This will cancel existing requests
            // See https://github.com/Selz/plyr/issues/174
            plyr.media.load();

            // Debugging
            _log('Cancelled network requests');
        }

        // Destroy an instance
        // Event listeners are removed when elements are removed
        // http://stackoverflow.com/questions/12528049/if-a-dom-element-is-removed-are-its-listeners-also-removed-from-memory
        function _destroy(callback, restore) {
            // Bail if the element is not initialized
            if (!plyr.init) {
                return null;
            }

            // Type specific stuff
            switch (plyr.type) {
                case 'youtube':
                    // Clear timers
                    window.clearInterval(timers.buffering);
                    window.clearInterval(timers.playing);

                    // Destroy YouTube API
                    plyr.embed.destroy();

                    // Clean up
                    cleanUp();

                    break;

                case 'vimeo':
                    // Destroy Vimeo API
                    // then clean up (wait, to prevent postmessage errors)
                    plyr.embed.unload().then(cleanUp);

                    // Vimeo does not always return
                    timers.cleanUp = window.setTimeout(cleanUp, 200);

                    break;

                case 'video':
                case 'audio':
                    // Restore native video controls
                    _toggleNativeControls(true);

                    // Clean up
                    cleanUp();

                    break;
            }

            function cleanUp() {
                clearTimeout(timers.cleanUp);

                // Default to restore original element
                if (!_is.boolean(restore)) {
                    restore = true;
                }

                // Callback
                if (_is.function(callback)) {
                    callback.call(original);
                }

                // Bail if we don't need to restore the original element
                if (!restore) {
                    return;
                }

                // Remove init flag
                plyr.init = false;

                // Replace the container with the original element provided
                plyr.container.parentNode.replaceChild(original, plyr.container);

                // Allow overflow (set on fullscreen)
                document.body.style.overflow = '';

                // Event
                _triggerEvent(original, 'destroyed', true);
            }
        }

        // Setup a player
        function _init() {
            // Bail if the element is initialized
            if (plyr.init) {
                return null;
            }

            // Setup the fullscreen api
            fullscreen = _fullscreen();

            // Sniff out the browser
            plyr.browser = _browserSniff();

            // Bail if nothing to setup
            if (!_is.htmlElement(plyr.media)) {
                return;
            }

            // Load saved settings from localStorage
            _setupStorage();

            // Set media type based on tag or data attribute
            // Supported: video, audio, vimeo, youtube
            var tagName = media.tagName.toLowerCase();
            if (tagName === 'div') {
                plyr.type     = media.getAttribute('data-type');
                plyr.embedId  = media.getAttribute('data-video-id');

                // Clean up
                media.removeAttribute('data-type');
                media.removeAttribute('data-video-id');
            } else {
                plyr.type           = tagName;
                config.crossorigin  = (media.getAttribute('crossorigin') !== null);
                config.autoplay     = (config.autoplay || (media.getAttribute('autoplay') !== null));
                config.loop         = (config.loop || (media.getAttribute('loop') !== null));
            }

            // Check for support
            plyr.supported = supported(plyr.type);

            // If no native support, bail
            if (!plyr.supported.basic) {
                return;
            }

            // Wrap media
            plyr.container = _wrap(media, document.createElement('div'));

            // Allow focus to be captured
            plyr.container.setAttribute('tabindex', 0);

            // Add style hook
            _toggleStyleHook();

            // Debug info
            _log('' + plyr.browser.name + ' ' + plyr.browser.version);

            // Setup media
            _setupMedia();

            // Setup interface
            // If embed but not fully supported, setupInterface (to avoid flash of controls) and call ready now
            if (_inArray(config.types.html5, plyr.type) || (_inArray(config.types.embed, plyr.type) && !plyr.supported.full)) {
                // Setup UI
                _setupInterface();

                // Call ready
                _ready();

                // Set title on button and frame
                _setTitle();
            }

            // Successful setup
            plyr.init = true;
        }

        // Setup the UI
        function _setupInterface() {
            // Don't setup interface if no support
            if (!plyr.supported.full) {
                _warn('Basic support only', plyr.type);

                // Remove controls
                _remove(_getElement(config.selectors.controls.wrapper));

                // Remove large play
                _remove(_getElement(config.selectors.buttons.play));

                // Restore native controls
                _toggleNativeControls(true);

                // Bail
                return;
            }

            // Inject custom controls if not present
            var controlsMissing = !_getElements(config.selectors.controls.wrapper).length;
            if (controlsMissing) {
                // Inject custom controls
                _injectControls();
            }

            // Find the elements
            if (!_findElements()) {
                return;
            }

            // If the controls are injected, re-bind listeners for controls
            if (controlsMissing) {
                _controlListeners();
            }

            // Media element listeners
            _mediaListeners();

            // Remove native controls
            _toggleNativeControls();

            // Setup fullscreen
            _setupFullscreen();

            // Captions
            _setupCaptions();

            // Set volume
            _setVolume();
            _updateVolume();

            // Reset time display
            _timeUpdate();

            // Update the UI
            _checkPlaying();
        }

        api = {
            getOriginal:        function() { return original; },
            getContainer:       function() { return plyr.container },
            getEmbed:           function() { return plyr.embed; },
            getMedia:           function() { return plyr.media; },
            getType:            function() { return plyr.type; },
            getDuration:        _getDuration,
            getCurrentTime:     function() { return plyr.media.currentTime; },
            getVolume:          function() { return plyr.media.volume; },
            isMuted:            function() { return plyr.media.muted; },
            isReady:            function() { return _hasClass(plyr.container, config.classes.ready); },
            isLoading:          function() { return _hasClass(plyr.container, config.classes.loading); },
            isPaused:           function() { return plyr.media.paused; },
            on:                 function(event, callback) { _on(plyr.container, event, callback); return this; },
            play:               _play,
            pause:              _pause,
            stop:               function() { _pause(); _seek(); },
            restart:            _seek,
            rewind:             _rewind,
            forward:            _forward,
            seek:               _seek,
            source:             _source,
            poster:             _updatePoster,
            setVolume:          _setVolume,
            togglePlay:         _togglePlay,
            toggleMute:         _toggleMute,
            toggleCaptions:     _toggleCaptions,
            toggleFullscreen:   _toggleFullscreen,
            toggleControls:     _toggleControls,
            isFullscreen:       function() { return plyr.isFullscreen || false; },
            support:            function(mimeType) { return _supportMime(plyr, mimeType); },
            destroy:            _destroy
        };

        // Everything done
        function _ready() {
            // Ready event at end of execution stack
            window.setTimeout(function() {
                _triggerEvent(plyr.media, 'ready');
            }, 0);

            // Set class hook on media element
            _toggleClass(plyr.media, defaults.classes.setup, true);

            // Set container class for ready
            _toggleClass(plyr.container, config.classes.ready, true);

            // Store a refernce to instance
            plyr.media.plyr = api;

            // Autoplay
            if (config.autoplay) {
                _play();
            }
        }

        // Initialize instance
        _init();

        // If init failed, return null
        if (!plyr.init) {
            return null;
        }

        return api;
    }

    // Load a sprite
    function loadSprite(url, id) {
        var x = new XMLHttpRequest();

        // If the id is set and sprite exists, bail
        if (_is.string(id) && _is.htmlElement(document.querySelector('#' + id))) {
            return;
        }

        // Create placeholder (to prevent loading twice)
        var container = document.createElement('div');
        container.setAttribute('hidden', '');
        if (_is.string(id)) {
            container.setAttribute('id', id);
        }
        document.body.insertBefore(container, document.body.childNodes[0]);

        // Check for CORS support
        if ('withCredentials' in x) {
            x.open('GET', url, true);
        } else {
            return;
        }

        // Inject hidden div with sprite on load
        x.onload = function() {
            container.innerHTML = x.responseText;
        }

        x.send();
    }

    // Check for support
    function supported(type) {
        var browser     = _browserSniff(),
            isOldIE     = (browser.isIE && browser.version <= 9),
            isIos       = browser.isIos,
            isIphone    = browser.isIphone,
            audioSupport = !!document.createElement('audio').canPlayType,
            videoSupport = !!document.createElement('video').canPlayType,
            basic       = false,
            full        = false;

        switch (type) {
            case 'video':
                basic = videoSupport;
                full  = (basic && (!isOldIE && !isIphone));
                break;

            case 'audio':
                basic = audioSupport;
                full  = (basic && !isOldIE);
                break;

            // Vimeo does not seem to be supported on iOS via API
            // Issue raised https://github.com/vimeo/player.js/issues/87
            case 'vimeo':
                basic = true;
                full = (!isOldIE && !isIos);
                break;

            case 'youtube':
                basic = true;
                full = (!isOldIE && !isIos);

                // YouTube seems to work on iOS 10+ on iPad
                if (isIos && !isIphone && browser.version >= 10) {
                    full = true;
                }

                break;

            case 'soundcloud':
                basic = true;
                full  = (!isOldIE && !isIphone);
                break;

            default:
                basic = (audioSupport && videoSupport);
                full  = (basic && !isOldIE);
        }

        return {
            basic:  basic,
            full:   full
        };
    }

    // Setup function
    function setup(targets, options) {
        // Get the players
        var players     = [],
            instances   = [],
            selector    = [defaults.selectors.html5, defaults.selectors.embed].join(',');

        // Select the elements
        if (_is.string(targets)) {
            // String selector passed
            targets = document.querySelectorAll(targets);
        }  else if (_is.htmlElement(targets)) {
            // Single HTMLElement passed
            targets = [targets];
        }  else if (!_is.nodeList(targets) && !_is.array(targets) && !_is.string(targets))  {
            // No selector passed, possibly options as first argument
            // If options are the first argument
            if (_is.undefined(options) && _is.object(targets)) {
                options = targets;
            }

            // Use default selector
            targets = document.querySelectorAll(selector);
        }

        // Convert NodeList to array
        if (_is.nodeList(targets)) {
            targets = Array.prototype.slice.call(targets);
        }

        // Bail if disabled or no basic support
        // You may want to disable certain UAs etc
        if (!supported().basic || !targets.length) {
            return false;
        }

        // Add to container list
        function add(target, media) {
            if (!_hasClass(media, defaults.classes.hook)) {
                players.push({
                    // Always wrap in a <div> for styling
                    //container:  _wrap(media, document.createElement('div')),
                    // Could be a container or the media itself
                    target:     target,
                    // This should be the <video>, <audio> or <div> (YouTube/Vimeo)
                    media:      media
                });
            }
        }

        // Check if the targets have multiple media elements
        for (var i = 0; i < targets.length; i++) {
            var target = targets[i];

            // Get children
            var children = target.querySelectorAll(selector);

            // If there's more than one media element child, wrap them
            if (children.length) {
                for (var x = 0; x < children.length; x++) {
                    add(target, children[x]);
                }
            } else if (_matches(target, selector)) {
                // Target is media element
                add(target, target);
            }
        }

        // Create a player instance for each element
        players.forEach(function(player) {
            var element     = player.target,
                media       = player.media,
                match       = false;

            // The target element can also be the media element
            if (media === element) {
                match = true;
            }

            // Setup a player instance and add to the element
            // Create instance-specific config
            var data = {};

            // Try parsing data attribute config
            try { data = JSON.parse(element.getAttribute('data-plyr')); }
            catch(e) { }

            var config = _extend({}, defaults, options, data);

            // Bail if not enabled
            if (!config.enabled) {
                return null;
            }

            // Create new instance
            var instance = new Plyr(media, config);

            // Go to next if setup failed
            if (!_is.object(instance)) {
                return;
            }

            // Listen for events if debugging
            if (config.debug) {
                var events = config.events.concat(['setup', 'statechange', 'enterfullscreen', 'exitfullscreen', 'captionsenabled', 'captionsdisabled']);

                _on(instance.getContainer(), events.join(' '), function(event) {
                    console.log([config.logPrefix, 'event:', event.type].join(' '), event.detail.plyr);
                });
            }

            // Callback
            _event(instance.getContainer(), 'setup', true, {
                plyr: instance
            });

            // Add to return array even if it's already setup
            instances.push(instance);
        });

        return instances;
    }

    // Get all instances within a provided container
    function get(container) {
        if (_is.string(container)) {
            // Get selector if string passed
            container = document.querySelector(container);
        } else if (_is.undefined(container)) {
            // Use body by default to get all on page
            container = document.body;
        }

        // If we have a HTML element
        if (_is.htmlElement(container)) {
            var elements = container.querySelectorAll('.' + defaults.classes.setup),
                instances = [];

            Array.prototype.slice.call(elements).forEach(function(element) {
                if (_is.object(element.plyr)) {
                    instances.push(element.plyr);
                }
            });

            return instances;
        }

        return [];
    }

    return {
        setup:      setup,
        supported:  supported,
        loadSprite: loadSprite,
        get:        get
    };
}));

// Custom event polyfill
// https://developer.mozilla.org/en-US/docs/Web/API/CustomEvent/CustomEvent
(function () {
    if (typeof window.CustomEvent === 'function') {
        return;
    }

    function CustomEvent(event, params) {
        params = params || { bubbles: false, cancelable: false, detail: undefined };
        var evt = document.createEvent('CustomEvent');
        evt.initCustomEvent(event, params.bubbles, params.cancelable, params.detail);
        return evt;
    }

    CustomEvent.prototype = window.Event.prototype;

    window.CustomEvent = CustomEvent;
})();


/***/ }),
/* 42 */,
/* 43 */,
/* 44 */
/***/ (function(module, exports, __webpack_require__) {

__webpack_require__(4);
module.exports = __webpack_require__(12);


/***/ }),
/* 45 */,
/* 46 */,
/* 47 */,
/* 48 */,
/* 49 */,
/* 50 */,
/* 51 */,
/* 52 */,
/* 53 */
/***/ (function(module, exports, __webpack_require__) {

/* WEBPACK VAR INJECTION */(function(global, setImmediate) {var __WEBPACK_AMD_DEFINE_FACTORY__, __WEBPACK_AMD_DEFINE_ARRAY__, __WEBPACK_AMD_DEFINE_RESULT__;var require;var require;var _typeof4=typeof Symbol==="function"&&typeof Symbol.iterator==="symbol"?function(obj){return typeof obj;}:function(obj){return obj&&typeof Symbol==="function"&&obj.constructor===Symbol&&obj!==Symbol.prototype?"symbol":typeof obj;};/* twilio-chat.js 0.12.0
The following license applies to all parts of this software except as
documented below.

    Copyright (c) 2016, Twilio, inc.
    All rights reserved.

    Redistribution and use in source and binary forms, with or without
    modification, are permitted provided that the following conditions are
    met:

      1. Redistributions of source code must retain the above copyright
         notice, this list of conditions and the following disclaimer.

      2. Redistributions in binary form must reproduce the above copyright
         notice, this list of conditions and the following disclaimer in
         the documentation and/or other materials provided with the
         distribution.

      3. Neither the name of Twilio nor the names of its contributors may
         be used to endorse or promote products derived from this software
         without specific prior written permission.

    THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS
    "AS IS" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT
    LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR
    A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT
    HOLDER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,
    SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT
    LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,
    DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY
    THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
    (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE
    OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.

This software includes javascript-state-machine under the following license.

    Copyright (c) 2012, 2013, 2014, 2015, Jake Gordon and contributors

    Permission is hereby granted, free of charge, to any person obtaining a copy
    of this software and associated documentation files (the "Software"), to deal
    in the Software without restriction, including without limitation the rights
    to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
    copies of the Software, and to permit persons to whom the Software is
    furnished to do so, subject to the following conditions:

    The above copyright notice and this permission notice shall be included in all
    copies or substantial portions of the Software.

    THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
    IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
    FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
    AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
    LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
    OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE

This software includes durational under the following license.

    Copyright (c) 2014 Micheil Smith

    Permission is hereby granted, free of charge, to any person obtaining a copy
    of this software and associated documentation files (the "Software"), to deal
    in the Software without restriction, including without limitation the rights
    to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
    copies of the Software, and to permit persons to whom the Software is
    furnished to do so, subject to the following conditions:

    The above copyright notice and this permission notice shall be included in all
    copies or substantial portions of the Software.

    THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
    IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
    FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
    AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
    LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
    OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
    SOFTWARE.

This software includes loglevel under the following license.

    Copyright (c) 2013 Tim Perry

    Permission is hereby granted, free of charge, to any person
    obtaining a copy of this software and associated documentation
    files (the "Software"), to deal in the Software without
    restriction, including without limitation the rights to use,
    copy, modify, merge, publish, distribute, sublicense, and/or sell
    copies of the Software, and to permit persons to whom the
    Software is furnished to do so, subject to the following
    conditions:

    The above copyright notice and this permission notice shall be
    included in all copies or substantial portions of the Software.

    THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND,
    EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES
    OF MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND
    NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT
    HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY,
    WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING
    FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR
    OTHER DEALINGS IN THE SOFTWARE.

This software includes q under the following license.

    Copyright 20092014 Kristopher Michael Kowal. All rights reserved.
    Permission is hereby granted, free of charge, to any person obtaining a copy
    of this software and associated documentation files (the "Software"), to
    deal in the Software without restriction, including without limitation the
    rights to use, copy, modify, merge, publish, distribute, sublicense, and/or
    sell copies of the Software, and to permit persons to whom the Software is
    furnished to do so, subject to the following conditions:

    The above copyright notice and this permission notice shall be included in
    all copies or substantial portions of the Software.

    THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
    IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
    FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
    AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
    LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING
    FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS
    IN THE SOFTWARE.

This software includes platform.js under the following license.

    Copyright 2014 Benjamin Tan <https://d10.github.io/>
    Copyright 2011-2015 John-David Dalton <http://allyoucanleet.com/>

    Permission is hereby granted, free of charge, to any person obtaining
    a copy of this software and associated documentation files (the
    "Software"), to deal in the Software without restriction, including
    without limitation the rights to use, copy, modify, merge, publish,
    distribute, sublicense, and/or sell copies of the Software, and to
    permit persons to whom the Software is furnished to do so, subject to
    the following conditions:

    The above copyright notice and this permission notice shall be
    included in all copies or substantial portions of the Software.

    THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND,
    EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF
    MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND
    NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE
    LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION
    OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION
    WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.
*/(function(f){if(( false?"undefined":_typeof4(exports))==="object"&&typeof module!=="undefined"){module.exports=f();}else if(true){!(__WEBPACK_AMD_DEFINE_ARRAY__ = [], __WEBPACK_AMD_DEFINE_FACTORY__ = (f),
				__WEBPACK_AMD_DEFINE_RESULT__ = (typeof __WEBPACK_AMD_DEFINE_FACTORY__ === 'function' ?
				(__WEBPACK_AMD_DEFINE_FACTORY__.apply(exports, __WEBPACK_AMD_DEFINE_ARRAY__)) : __WEBPACK_AMD_DEFINE_FACTORY__),
				__WEBPACK_AMD_DEFINE_RESULT__ !== undefined && (module.exports = __WEBPACK_AMD_DEFINE_RESULT__));}else{var g;if(typeof window!=="undefined"){g=window;}else if(typeof global!=="undefined"){g=global;}else if(typeof self!=="undefined"){g=self;}else{g=this;}g=g.Twilio||(g.Twilio={});g=g.Chat||(g.Chat={});g.Client=f();}})(function(){var define,module,exports;return function e(t,n,r){function s(o,u){if(!n[o]){if(!t[o]){var a=typeof require=="function"&&require;if(!u&&a)return require(o,!0);if(i)return i(o,!0);var f=new Error("Cannot find module '"+o+"'");throw f.code="MODULE_NOT_FOUND",f;}var l=n[o]={exports:{}};t[o][0].call(l.exports,function(e){var n=t[o][1][e];return s(n?n:e);},l,l.exports,e,t,n,r);}return n[o].exports;}var i=typeof require=="function"&&require;for(var o=0;o<r.length;o++){s(r[o]);}return s;}({1:[function(_dereq_,module,exports){module.exports={"default":_dereq_("core-js/library/fn/array/from"),__esModule:true};},{"core-js/library/fn/array/from":41}],2:[function(_dereq_,module,exports){module.exports={"default":_dereq_("core-js/library/fn/get-iterator"),__esModule:true};},{"core-js/library/fn/get-iterator":42}],3:[function(_dereq_,module,exports){module.exports={"default":_dereq_("core-js/library/fn/is-iterable"),__esModule:true};},{"core-js/library/fn/is-iterable":43}],4:[function(_dereq_,module,exports){module.exports={"default":_dereq_("core-js/library/fn/json/stringify"),__esModule:true};},{"core-js/library/fn/json/stringify":44}],5:[function(_dereq_,module,exports){module.exports={"default":_dereq_("core-js/library/fn/map"),__esModule:true};},{"core-js/library/fn/map":45}],6:[function(_dereq_,module,exports){module.exports={"default":_dereq_("core-js/library/fn/number/is-integer"),__esModule:true};},{"core-js/library/fn/number/is-integer":46}],7:[function(_dereq_,module,exports){module.exports={"default":_dereq_("core-js/library/fn/object/assign"),__esModule:true};},{"core-js/library/fn/object/assign":47}],8:[function(_dereq_,module,exports){module.exports={"default":_dereq_("core-js/library/fn/object/create"),__esModule:true};},{"core-js/library/fn/object/create":48}],9:[function(_dereq_,module,exports){module.exports={"default":_dereq_("core-js/library/fn/object/define-properties"),__esModule:true};},{"core-js/library/fn/object/define-properties":49}],10:[function(_dereq_,module,exports){module.exports={"default":_dereq_("core-js/library/fn/object/define-property"),__esModule:true};},{"core-js/library/fn/object/define-property":50}],11:[function(_dereq_,module,exports){module.exports={"default":_dereq_("core-js/library/fn/object/freeze"),__esModule:true};},{"core-js/library/fn/object/freeze":51}],12:[function(_dereq_,module,exports){module.exports={"default":_dereq_("core-js/library/fn/object/get-prototype-of"),__esModule:true};},{"core-js/library/fn/object/get-prototype-of":52}],13:[function(_dereq_,module,exports){module.exports={"default":_dereq_("core-js/library/fn/object/keys"),__esModule:true};},{"core-js/library/fn/object/keys":53}],14:[function(_dereq_,module,exports){module.exports={"default":_dereq_("core-js/library/fn/object/set-prototype-of"),__esModule:true};},{"core-js/library/fn/object/set-prototype-of":54}],15:[function(_dereq_,module,exports){module.exports={"default":_dereq_("core-js/library/fn/promise"),__esModule:true};},{"core-js/library/fn/promise":55}],16:[function(_dereq_,module,exports){module.exports={"default":_dereq_("core-js/library/fn/reflect/construct"),__esModule:true};},{"core-js/library/fn/reflect/construct":56}],17:[function(_dereq_,module,exports){module.exports={"default":_dereq_("core-js/library/fn/set"),__esModule:true};},{"core-js/library/fn/set":57}],18:[function(_dereq_,module,exports){module.exports={"default":_dereq_("core-js/library/fn/symbol"),__esModule:true};},{"core-js/library/fn/symbol":58}],19:[function(_dereq_,module,exports){module.exports={"default":_dereq_("core-js/library/fn/symbol/iterator"),__esModule:true};},{"core-js/library/fn/symbol/iterator":59}],20:[function(_dereq_,module,exports){"use strict";exports.__esModule=true;var _promise=_dereq_("../core-js/promise");var _promise2=_interopRequireDefault(_promise);function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj};}exports.default=function(fn){return function(){var gen=fn.apply(this,arguments);return new _promise2.default(function(resolve,reject){function step(key,arg){try{var info=gen[key](arg);var value=info.value;}catch(error){reject(error);return;}if(info.done){resolve(value);}else{return _promise2.default.resolve(value).then(function(value){step("next",value);},function(err){step("throw",err);});}}return step("next");});};};},{"../core-js/promise":15}],21:[function(_dereq_,module,exports){"use strict";exports.__esModule=true;exports.default=function(instance,Constructor){if(!(instance instanceof Constructor)){throw new TypeError("Cannot call a class as a function");}};},{}],22:[function(_dereq_,module,exports){"use strict";exports.__esModule=true;var _defineProperty=_dereq_("../core-js/object/define-property");var _defineProperty2=_interopRequireDefault(_defineProperty);function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj};}exports.default=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||false;descriptor.configurable=true;if("value"in descriptor)descriptor.writable=true;(0,_defineProperty2.default)(target,descriptor.key,descriptor);}}return function(Constructor,protoProps,staticProps){if(protoProps)defineProperties(Constructor.prototype,protoProps);if(staticProps)defineProperties(Constructor,staticProps);return Constructor;};}();},{"../core-js/object/define-property":10}],23:[function(_dereq_,module,exports){"use strict";exports.__esModule=true;var _assign=_dereq_("../core-js/object/assign");var _assign2=_interopRequireDefault(_assign);function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj};}exports.default=_assign2.default||function(target){for(var i=1;i<arguments.length;i++){var source=arguments[i];for(var key in source){if(Object.prototype.hasOwnProperty.call(source,key)){target[key]=source[key];}}}return target;};},{"../core-js/object/assign":7}],24:[function(_dereq_,module,exports){"use strict";exports.__esModule=true;var _setPrototypeOf=_dereq_("../core-js/object/set-prototype-of");var _setPrototypeOf2=_interopRequireDefault(_setPrototypeOf);var _create=_dereq_("../core-js/object/create");var _create2=_interopRequireDefault(_create);var _typeof2=_dereq_("../helpers/typeof");var _typeof3=_interopRequireDefault(_typeof2);function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj};}exports.default=function(subClass,superClass){if(typeof superClass!=="function"&&superClass!==null){throw new TypeError("Super expression must either be null or a function, not "+(typeof superClass==="undefined"?"undefined":(0,_typeof3.default)(superClass)));}subClass.prototype=(0,_create2.default)(superClass&&superClass.prototype,{constructor:{value:subClass,enumerable:false,writable:true,configurable:true}});if(superClass)_setPrototypeOf2.default?(0,_setPrototypeOf2.default)(subClass,superClass):subClass.__proto__=superClass;};},{"../core-js/object/create":8,"../core-js/object/set-prototype-of":14,"../helpers/typeof":27}],25:[function(_dereq_,module,exports){"use strict";exports.__esModule=true;var _typeof2=_dereq_("../helpers/typeof");var _typeof3=_interopRequireDefault(_typeof2);function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj};}exports.default=function(self,call){if(!self){throw new ReferenceError("this hasn't been initialised - super() hasn't been called");}return call&&((typeof call==="undefined"?"undefined":(0,_typeof3.default)(call))==="object"||typeof call==="function")?call:self;};},{"../helpers/typeof":27}],26:[function(_dereq_,module,exports){"use strict";exports.__esModule=true;var _isIterable2=_dereq_("../core-js/is-iterable");var _isIterable3=_interopRequireDefault(_isIterable2);var _getIterator2=_dereq_("../core-js/get-iterator");var _getIterator3=_interopRequireDefault(_getIterator2);function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj};}exports.default=function(){function sliceIterator(arr,i){var _arr=[];var _n=true;var _d=false;var _e=undefined;try{for(var _i=(0,_getIterator3.default)(arr),_s;!(_n=(_s=_i.next()).done);_n=true){_arr.push(_s.value);if(i&&_arr.length===i)break;}}catch(err){_d=true;_e=err;}finally{try{if(!_n&&_i["return"])_i["return"]();}finally{if(_d)throw _e;}}return _arr;}return function(arr,i){if(Array.isArray(arr)){return arr;}else if((0,_isIterable3.default)(Object(arr))){return sliceIterator(arr,i);}else{throw new TypeError("Invalid attempt to destructure non-iterable instance");}};}();},{"../core-js/get-iterator":2,"../core-js/is-iterable":3}],27:[function(_dereq_,module,exports){"use strict";exports.__esModule=true;var _iterator=_dereq_("../core-js/symbol/iterator");var _iterator2=_interopRequireDefault(_iterator);var _symbol=_dereq_("../core-js/symbol");var _symbol2=_interopRequireDefault(_symbol);var _typeof=typeof _symbol2.default==="function"&&_typeof4(_iterator2.default)==="symbol"?function(obj){return typeof obj==="undefined"?"undefined":_typeof4(obj);}:function(obj){return obj&&typeof _symbol2.default==="function"&&obj.constructor===_symbol2.default&&obj!==_symbol2.default.prototype?"symbol":typeof obj==="undefined"?"undefined":_typeof4(obj);};function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj};}exports.default=typeof _symbol2.default==="function"&&_typeof(_iterator2.default)==="symbol"?function(obj){return typeof obj==="undefined"?"undefined":_typeof(obj);}:function(obj){return obj&&typeof _symbol2.default==="function"&&obj.constructor===_symbol2.default&&obj!==_symbol2.default.prototype?"symbol":typeof obj==="undefined"?"undefined":_typeof(obj);};},{"../core-js/symbol":18,"../core-js/symbol/iterator":19}],28:[function(_dereq_,module,exports){module.exports=_dereq_("regenerator-runtime");},{"regenerator-runtime":179}],29:[function(_dereq_,module,exports){//      Copyright (c) 2012 Mathieu Turcotte
//      Licensed under the MIT license.
var Backoff=_dereq_('./lib/backoff');var ExponentialBackoffStrategy=_dereq_('./lib/strategy/exponential');var FibonacciBackoffStrategy=_dereq_('./lib/strategy/fibonacci');var FunctionCall=_dereq_('./lib/function_call.js');module.exports.Backoff=Backoff;module.exports.FunctionCall=FunctionCall;module.exports.FibonacciStrategy=FibonacciBackoffStrategy;module.exports.ExponentialStrategy=ExponentialBackoffStrategy;// Constructs a Fibonacci backoff.
module.exports.fibonacci=function(options){return new Backoff(new FibonacciBackoffStrategy(options));};// Constructs an exponential backoff.
module.exports.exponential=function(options){return new Backoff(new ExponentialBackoffStrategy(options));};// Constructs a FunctionCall for the given function and arguments.
module.exports.call=function(fn,vargs,callback){var args=Array.prototype.slice.call(arguments);fn=args[0];vargs=args.slice(1,args.length-1);callback=args[args.length-1];return new FunctionCall(fn,vargs,callback);};},{"./lib/backoff":30,"./lib/function_call.js":31,"./lib/strategy/exponential":32,"./lib/strategy/fibonacci":33}],30:[function(_dereq_,module,exports){//      Copyright (c) 2012 Mathieu Turcotte
//      Licensed under the MIT license.
var events=_dereq_('events');var precond=_dereq_('precond');var util=_dereq_('util');// A class to hold the state of a backoff operation. Accepts a backoff strategy
// to generate the backoff delays.
function Backoff(backoffStrategy){events.EventEmitter.call(this);this.backoffStrategy_=backoffStrategy;this.maxNumberOfRetry_=-1;this.backoffNumber_=0;this.backoffDelay_=0;this.timeoutID_=-1;this.handlers={backoff:this.onBackoff_.bind(this)};}util.inherits(Backoff,events.EventEmitter);// Sets a limit, greater than 0, on the maximum number of backoffs. A 'fail'
// event will be emitted when the limit is reached.
Backoff.prototype.failAfter=function(maxNumberOfRetry){precond.checkArgument(maxNumberOfRetry>0,'Expected a maximum number of retry greater than 0 but got %s.',maxNumberOfRetry);this.maxNumberOfRetry_=maxNumberOfRetry;};// Starts a backoff operation. Accepts an optional parameter to let the
// listeners know why the backoff operation was started.
Backoff.prototype.backoff=function(err){precond.checkState(this.timeoutID_===-1,'Backoff in progress.');if(this.backoffNumber_===this.maxNumberOfRetry_){this.emit('fail',err);this.reset();}else{this.backoffDelay_=this.backoffStrategy_.next();this.timeoutID_=setTimeout(this.handlers.backoff,this.backoffDelay_);this.emit('backoff',this.backoffNumber_,this.backoffDelay_,err);}};// Handles the backoff timeout completion.
Backoff.prototype.onBackoff_=function(){this.timeoutID_=-1;this.emit('ready',this.backoffNumber_,this.backoffDelay_);this.backoffNumber_++;};// Stops any backoff operation and resets the backoff delay to its inital value.
Backoff.prototype.reset=function(){this.backoffNumber_=0;this.backoffStrategy_.reset();clearTimeout(this.timeoutID_);this.timeoutID_=-1;};module.exports=Backoff;},{"events":169,"precond":175,"util":223}],31:[function(_dereq_,module,exports){//      Copyright (c) 2012 Mathieu Turcotte
//      Licensed under the MIT license.
var events=_dereq_('events');var precond=_dereq_('precond');var util=_dereq_('util');var Backoff=_dereq_('./backoff');var FibonacciBackoffStrategy=_dereq_('./strategy/fibonacci');// Wraps a function to be called in a backoff loop.
function FunctionCall(fn,args,callback){events.EventEmitter.call(this);precond.checkIsFunction(fn,'Expected fn to be a function.');precond.checkIsArray(args,'Expected args to be an array.');precond.checkIsFunction(callback,'Expected callback to be a function.');this.function_=fn;this.arguments_=args;this.callback_=callback;this.lastResult_=[];this.numRetries_=0;this.backoff_=null;this.strategy_=null;this.failAfter_=-1;this.retryPredicate_=FunctionCall.DEFAULT_RETRY_PREDICATE_;this.state_=FunctionCall.State_.PENDING;}util.inherits(FunctionCall,events.EventEmitter);// States in which the call can be.
FunctionCall.State_={// Call isn't started yet.
PENDING:0,// Call is in progress.
RUNNING:1,// Call completed successfully which means that either the wrapped function
// returned successfully or the maximal number of backoffs was reached.
COMPLETED:2,// The call was aborted.
ABORTED:3};// The default retry predicate which considers any error as retriable.
FunctionCall.DEFAULT_RETRY_PREDICATE_=function(err){return true;};// Checks whether the call is pending.
FunctionCall.prototype.isPending=function(){return this.state_==FunctionCall.State_.PENDING;};// Checks whether the call is in progress.
FunctionCall.prototype.isRunning=function(){return this.state_==FunctionCall.State_.RUNNING;};// Checks whether the call is completed.
FunctionCall.prototype.isCompleted=function(){return this.state_==FunctionCall.State_.COMPLETED;};// Checks whether the call is aborted.
FunctionCall.prototype.isAborted=function(){return this.state_==FunctionCall.State_.ABORTED;};// Sets the backoff strategy to use. Can only be called before the call is
// started otherwise an exception will be thrown.
FunctionCall.prototype.setStrategy=function(strategy){precond.checkState(this.isPending(),'FunctionCall in progress.');this.strategy_=strategy;return this;// Return this for chaining.
};// Sets the predicate which will be used to determine whether the errors
// returned from the wrapped function should be retried or not, e.g. a
// network error would be retriable while a type error would stop the
// function call.
FunctionCall.prototype.retryIf=function(retryPredicate){precond.checkState(this.isPending(),'FunctionCall in progress.');this.retryPredicate_=retryPredicate;return this;};// Returns all intermediary results returned by the wrapped function since
// the initial call.
FunctionCall.prototype.getLastResult=function(){return this.lastResult_.concat();};// Returns the number of times the wrapped function call was retried.
FunctionCall.prototype.getNumRetries=function(){return this.numRetries_;};// Sets the backoff limit.
FunctionCall.prototype.failAfter=function(maxNumberOfRetry){precond.checkState(this.isPending(),'FunctionCall in progress.');this.failAfter_=maxNumberOfRetry;return this;// Return this for chaining.
};// Aborts the call.
FunctionCall.prototype.abort=function(){if(this.isCompleted()||this.isAborted()){return;}if(this.isRunning()){this.backoff_.reset();}this.state_=FunctionCall.State_.ABORTED;this.lastResult_=[new Error('Backoff aborted.')];this.emit('abort');this.doCallback_();};// Initiates the call to the wrapped function. Accepts an optional factory
// function used to create the backoff instance; used when testing.
FunctionCall.prototype.start=function(backoffFactory){precond.checkState(!this.isAborted(),'FunctionCall is aborted.');precond.checkState(this.isPending(),'FunctionCall already started.');var strategy=this.strategy_||new FibonacciBackoffStrategy();this.backoff_=backoffFactory?backoffFactory(strategy):new Backoff(strategy);this.backoff_.on('ready',this.doCall_.bind(this,true/* isRetry */));this.backoff_.on('fail',this.doCallback_.bind(this));this.backoff_.on('backoff',this.handleBackoff_.bind(this));if(this.failAfter_>0){this.backoff_.failAfter(this.failAfter_);}this.state_=FunctionCall.State_.RUNNING;this.doCall_(false/* isRetry */);};// Calls the wrapped function.
FunctionCall.prototype.doCall_=function(isRetry){if(isRetry){this.numRetries_++;}var eventArgs=['call'].concat(this.arguments_);events.EventEmitter.prototype.emit.apply(this,eventArgs);var callback=this.handleFunctionCallback_.bind(this);this.function_.apply(null,this.arguments_.concat(callback));};// Calls the wrapped function's callback with the last result returned by the
// wrapped function.
FunctionCall.prototype.doCallback_=function(){this.callback_.apply(null,this.lastResult_);};// Handles wrapped function's completion. This method acts as a replacement
// for the original callback function.
FunctionCall.prototype.handleFunctionCallback_=function(){if(this.isAborted()){return;}var args=Array.prototype.slice.call(arguments);this.lastResult_=args;// Save last callback arguments.
events.EventEmitter.prototype.emit.apply(this,['callback'].concat(args));var err=args[0];if(err&&this.retryPredicate_(err)){this.backoff_.backoff(err);}else{this.state_=FunctionCall.State_.COMPLETED;this.doCallback_();}};// Handles the backoff event by reemitting it.
FunctionCall.prototype.handleBackoff_=function(number,delay,err){this.emit('backoff',number,delay,err);};module.exports=FunctionCall;},{"./backoff":30,"./strategy/fibonacci":33,"events":169,"precond":175,"util":223}],32:[function(_dereq_,module,exports){//      Copyright (c) 2012 Mathieu Turcotte
//      Licensed under the MIT license.
var util=_dereq_('util');var precond=_dereq_('precond');var BackoffStrategy=_dereq_('./strategy');// Exponential backoff strategy.
function ExponentialBackoffStrategy(options){BackoffStrategy.call(this,options);this.backoffDelay_=0;this.nextBackoffDelay_=this.getInitialDelay();this.factor_=ExponentialBackoffStrategy.DEFAULT_FACTOR;if(options&&options.factor!==undefined){precond.checkArgument(options.factor>1,'Exponential factor should be greater than 1 but got %s.',options.factor);this.factor_=options.factor;}}util.inherits(ExponentialBackoffStrategy,BackoffStrategy);// Default multiplication factor used to compute the next backoff delay from
// the current one. The value can be overridden by passing a custom factor as
// part of the options.
ExponentialBackoffStrategy.DEFAULT_FACTOR=2;ExponentialBackoffStrategy.prototype.next_=function(){this.backoffDelay_=Math.min(this.nextBackoffDelay_,this.getMaxDelay());this.nextBackoffDelay_=this.backoffDelay_*this.factor_;return this.backoffDelay_;};ExponentialBackoffStrategy.prototype.reset_=function(){this.backoffDelay_=0;this.nextBackoffDelay_=this.getInitialDelay();};module.exports=ExponentialBackoffStrategy;},{"./strategy":34,"precond":175,"util":223}],33:[function(_dereq_,module,exports){//      Copyright (c) 2012 Mathieu Turcotte
//      Licensed under the MIT license.
var util=_dereq_('util');var BackoffStrategy=_dereq_('./strategy');// Fibonacci backoff strategy.
function FibonacciBackoffStrategy(options){BackoffStrategy.call(this,options);this.backoffDelay_=0;this.nextBackoffDelay_=this.getInitialDelay();}util.inherits(FibonacciBackoffStrategy,BackoffStrategy);FibonacciBackoffStrategy.prototype.next_=function(){var backoffDelay=Math.min(this.nextBackoffDelay_,this.getMaxDelay());this.nextBackoffDelay_+=this.backoffDelay_;this.backoffDelay_=backoffDelay;return backoffDelay;};FibonacciBackoffStrategy.prototype.reset_=function(){this.nextBackoffDelay_=this.getInitialDelay();this.backoffDelay_=0;};module.exports=FibonacciBackoffStrategy;},{"./strategy":34,"util":223}],34:[function(_dereq_,module,exports){//      Copyright (c) 2012 Mathieu Turcotte
//      Licensed under the MIT license.
var events=_dereq_('events');var util=_dereq_('util');function isDef(value){return value!==undefined&&value!==null;}// Abstract class defining the skeleton for the backoff strategies. Accepts an
// object holding the options for the backoff strategy:
//
//  * `randomisationFactor`: The randomisation factor which must be between 0
//     and 1 where 1 equates to a randomization factor of 100% and 0 to no
//     randomization.
//  * `initialDelay`: The backoff initial delay in milliseconds.
//  * `maxDelay`: The backoff maximal delay in milliseconds.
function BackoffStrategy(options){options=options||{};if(isDef(options.initialDelay)&&options.initialDelay<1){throw new Error('The initial timeout must be greater than 0.');}else if(isDef(options.maxDelay)&&options.maxDelay<1){throw new Error('The maximal timeout must be greater than 0.');}this.initialDelay_=options.initialDelay||100;this.maxDelay_=options.maxDelay||10000;if(this.maxDelay_<=this.initialDelay_){throw new Error('The maximal backoff delay must be '+'greater than the initial backoff delay.');}if(isDef(options.randomisationFactor)&&(options.randomisationFactor<0||options.randomisationFactor>1)){throw new Error('The randomisation factor must be between 0 and 1.');}this.randomisationFactor_=options.randomisationFactor||0;}// Gets the maximal backoff delay.
BackoffStrategy.prototype.getMaxDelay=function(){return this.maxDelay_;};// Gets the initial backoff delay.
BackoffStrategy.prototype.getInitialDelay=function(){return this.initialDelay_;};// Template method that computes and returns the next backoff delay in
// milliseconds.
BackoffStrategy.prototype.next=function(){var backoffDelay=this.next_();var randomisationMultiple=1+Math.random()*this.randomisationFactor_;var randomizedDelay=Math.round(backoffDelay*randomisationMultiple);return randomizedDelay;};// Computes and returns the next backoff delay. Intended to be overridden by
// subclasses.
BackoffStrategy.prototype.next_=function(){throw new Error('BackoffStrategy.next_() unimplemented.');};// Template method that resets the backoff delay to its initial value.
BackoffStrategy.prototype.reset=function(){this.reset_();};// Resets the backoff delay to its initial value. Intended to be overridden by
// subclasses.
BackoffStrategy.prototype.reset_=function(){throw new Error('BackoffStrategy.reset_() unimplemented.');};module.exports=BackoffStrategy;},{"events":169,"util":223}],35:[function(_dereq_,module,exports){(function(process,global){/* @preserve
 * The MIT License (MIT)
 * 
 * Copyright (c) 2013-2015 Petka Antonov
 * 
 * Permission is hereby granted, free of charge, to any person obtaining a copy
 * of this software and associated documentation files (the "Software"), to deal
 * in the Software without restriction, including without limitation the rights
 * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
 * copies of the Software, and to permit persons to whom the Software is
 * furnished to do so, subject to the following conditions:
 * 
 * The above copyright notice and this permission notice shall be included in
 * all copies or substantial portions of the Software.
 * 
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL THE
 * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN
 * THE SOFTWARE.
 * 
 *//**
 * bluebird build version 3.4.7
 * Features enabled: core, race, call_get, generators, map, nodeify, promisify, props, reduce, settle, some, using, timers, filter, any, each
*/!function(e){if("object"==(typeof exports==="undefined"?"undefined":_typeof4(exports))&&"undefined"!=typeof module)module.exports=e();else if("function"==typeof define&&define.amd)define([],e);else{var f;"undefined"!=typeof window?f=window:"undefined"!=typeof global?f=global:"undefined"!=typeof self&&(f=self),f.Promise=e();}}(function(){var define,module,exports;return function e(t,n,r){function s(o,u){if(!n[o]){if(!t[o]){var a=typeof _dereq_=="function"&&_dereq_;if(!u&&a)return a(o,!0);if(i)return i(o,!0);var f=new Error("Cannot find module '"+o+"'");throw f.code="MODULE_NOT_FOUND",f;}var l=n[o]={exports:{}};t[o][0].call(l.exports,function(e){var n=t[o][1][e];return s(n?n:e);},l,l.exports,e,t,n,r);}return n[o].exports;}var i=typeof _dereq_=="function"&&_dereq_;for(var o=0;o<r.length;o++){s(r[o]);}return s;}({1:[function(_dereq_,module,exports){"use strict";module.exports=function(Promise){var SomePromiseArray=Promise._SomePromiseArray;function any(promises){var ret=new SomePromiseArray(promises);var promise=ret.promise();ret.setHowMany(1);ret.setUnwrap();ret.init();return promise;}Promise.any=function(promises){return any(promises);};Promise.prototype.any=function(){return any(this);};};},{}],2:[function(_dereq_,module,exports){"use strict";var firstLineError;try{throw new Error();}catch(e){firstLineError=e;}var schedule=_dereq_("./schedule");var Queue=_dereq_("./queue");var util=_dereq_("./util");function Async(){this._customScheduler=false;this._isTickUsed=false;this._lateQueue=new Queue(16);this._normalQueue=new Queue(16);this._haveDrainedQueues=false;this._trampolineEnabled=true;var self=this;this.drainQueues=function(){self._drainQueues();};this._schedule=schedule;}Async.prototype.setScheduler=function(fn){var prev=this._schedule;this._schedule=fn;this._customScheduler=true;return prev;};Async.prototype.hasCustomScheduler=function(){return this._customScheduler;};Async.prototype.enableTrampoline=function(){this._trampolineEnabled=true;};Async.prototype.disableTrampolineIfNecessary=function(){if(util.hasDevTools){this._trampolineEnabled=false;}};Async.prototype.haveItemsQueued=function(){return this._isTickUsed||this._haveDrainedQueues;};Async.prototype.fatalError=function(e,isNode){if(isNode){process.stderr.write("Fatal "+(e instanceof Error?e.stack:e)+"\n");process.exit(2);}else{this.throwLater(e);}};Async.prototype.throwLater=function(fn,arg){if(arguments.length===1){arg=fn;fn=function fn(){throw arg;};}if(typeof setTimeout!=="undefined"){setTimeout(function(){fn(arg);},0);}else try{this._schedule(function(){fn(arg);});}catch(e){throw new Error("No async scheduler available\n\n    See http://goo.gl/MqrFmX\n");}};function AsyncInvokeLater(fn,receiver,arg){this._lateQueue.push(fn,receiver,arg);this._queueTick();}function AsyncInvoke(fn,receiver,arg){this._normalQueue.push(fn,receiver,arg);this._queueTick();}function AsyncSettlePromises(promise){this._normalQueue._pushOne(promise);this._queueTick();}if(!util.hasDevTools){Async.prototype.invokeLater=AsyncInvokeLater;Async.prototype.invoke=AsyncInvoke;Async.prototype.settlePromises=AsyncSettlePromises;}else{Async.prototype.invokeLater=function(fn,receiver,arg){if(this._trampolineEnabled){AsyncInvokeLater.call(this,fn,receiver,arg);}else{this._schedule(function(){setTimeout(function(){fn.call(receiver,arg);},100);});}};Async.prototype.invoke=function(fn,receiver,arg){if(this._trampolineEnabled){AsyncInvoke.call(this,fn,receiver,arg);}else{this._schedule(function(){fn.call(receiver,arg);});}};Async.prototype.settlePromises=function(promise){if(this._trampolineEnabled){AsyncSettlePromises.call(this,promise);}else{this._schedule(function(){promise._settlePromises();});}};}Async.prototype._drainQueue=function(queue){while(queue.length()>0){var fn=queue.shift();if(typeof fn!=="function"){fn._settlePromises();continue;}var receiver=queue.shift();var arg=queue.shift();fn.call(receiver,arg);}};Async.prototype._drainQueues=function(){this._drainQueue(this._normalQueue);this._reset();this._haveDrainedQueues=true;this._drainQueue(this._lateQueue);};Async.prototype._queueTick=function(){if(!this._isTickUsed){this._isTickUsed=true;this._schedule(this.drainQueues);}};Async.prototype._reset=function(){this._isTickUsed=false;};module.exports=Async;module.exports.firstLineError=firstLineError;},{"./queue":26,"./schedule":29,"./util":36}],3:[function(_dereq_,module,exports){"use strict";module.exports=function(Promise,INTERNAL,tryConvertToPromise,debug){var calledBind=false;var rejectThis=function rejectThis(_,e){this._reject(e);};var targetRejected=function targetRejected(e,context){context.promiseRejectionQueued=true;context.bindingPromise._then(rejectThis,rejectThis,null,this,e);};var bindingResolved=function bindingResolved(thisArg,context){if((this._bitField&50397184)===0){this._resolveCallback(context.target);}};var bindingRejected=function bindingRejected(e,context){if(!context.promiseRejectionQueued)this._reject(e);};Promise.prototype.bind=function(thisArg){if(!calledBind){calledBind=true;Promise.prototype._propagateFrom=debug.propagateFromFunction();Promise.prototype._boundValue=debug.boundValueFunction();}var maybePromise=tryConvertToPromise(thisArg);var ret=new Promise(INTERNAL);ret._propagateFrom(this,1);var target=this._target();ret._setBoundTo(maybePromise);if(maybePromise instanceof Promise){var context={promiseRejectionQueued:false,promise:ret,target:target,bindingPromise:maybePromise};target._then(INTERNAL,targetRejected,undefined,ret,context);maybePromise._then(bindingResolved,bindingRejected,undefined,ret,context);ret._setOnCancel(maybePromise);}else{ret._resolveCallback(target);}return ret;};Promise.prototype._setBoundTo=function(obj){if(obj!==undefined){this._bitField=this._bitField|2097152;this._boundTo=obj;}else{this._bitField=this._bitField&~2097152;}};Promise.prototype._isBound=function(){return(this._bitField&2097152)===2097152;};Promise.bind=function(thisArg,value){return Promise.resolve(value).bind(thisArg);};};},{}],4:[function(_dereq_,module,exports){"use strict";var old;if(typeof Promise!=="undefined")old=Promise;function noConflict(){try{if(Promise===bluebird)Promise=old;}catch(e){}return bluebird;}var bluebird=_dereq_("./promise")();bluebird.noConflict=noConflict;module.exports=bluebird;},{"./promise":22}],5:[function(_dereq_,module,exports){"use strict";var cr=Object.create;if(cr){var callerCache=cr(null);var getterCache=cr(null);callerCache[" size"]=getterCache[" size"]=0;}module.exports=function(Promise){var util=_dereq_("./util");var canEvaluate=util.canEvaluate;var isIdentifier=util.isIdentifier;var getMethodCaller;var getGetter;if(false){var makeMethodCaller=function makeMethodCaller(methodName){return new Function("ensureMethod","                                    \n\
        return function(obj) {                                               \n\
            'use strict'                                                     \n\
            var len = this.length;                                           \n\
            ensureMethod(obj, 'methodName');                                 \n\
            switch(len) {                                                    \n\
                case 1: return obj.methodName(this[0]);                      \n\
                case 2: return obj.methodName(this[0], this[1]);             \n\
                case 3: return obj.methodName(this[0], this[1], this[2]);    \n\
                case 0: return obj.methodName();                             \n\
                default:                                                     \n\
                    return obj.methodName.apply(obj, this);                  \n\
            }                                                                \n\
        };                                                                   \n\
        ".replace(/methodName/g,methodName))(ensureMethod);};var makeGetter=function makeGetter(propertyName){return new Function("obj","                                             \n\
        'use strict';                                                        \n\
        return obj.propertyName;                                             \n\
        ".replace("propertyName",propertyName));};var getCompiled=function getCompiled(name,compiler,cache){var ret=cache[name];if(typeof ret!=="function"){if(!isIdentifier(name)){return null;}ret=compiler(name);cache[name]=ret;cache[" size"]++;if(cache[" size"]>512){var keys=Object.keys(cache);for(var i=0;i<256;++i){delete cache[keys[i]];}cache[" size"]=keys.length-256;}}return ret;};getMethodCaller=function getMethodCaller(name){return getCompiled(name,makeMethodCaller,callerCache);};getGetter=function getGetter(name){return getCompiled(name,makeGetter,getterCache);};}function ensureMethod(obj,methodName){var fn;if(obj!=null)fn=obj[methodName];if(typeof fn!=="function"){var message="Object "+util.classString(obj)+" has no method '"+util.toString(methodName)+"'";throw new Promise.TypeError(message);}return fn;}function caller(obj){var methodName=this.pop();var fn=ensureMethod(obj,methodName);return fn.apply(obj,this);}Promise.prototype.call=function(methodName){var args=[].slice.call(arguments,1);;if(false){if(canEvaluate){var maybeCaller=getMethodCaller(methodName);if(maybeCaller!==null){return this._then(maybeCaller,undefined,undefined,args,undefined);}}}args.push(methodName);return this._then(caller,undefined,undefined,args,undefined);};function namedGetter(obj){return obj[this];}function indexedGetter(obj){var index=+this;if(index<0)index=Math.max(0,index+obj.length);return obj[index];}Promise.prototype.get=function(propertyName){var isIndex=typeof propertyName==="number";var getter;if(!isIndex){if(canEvaluate){var maybeGetter=getGetter(propertyName);getter=maybeGetter!==null?maybeGetter:namedGetter;}else{getter=namedGetter;}}else{getter=indexedGetter;}return this._then(getter,undefined,undefined,propertyName,undefined);};};},{"./util":36}],6:[function(_dereq_,module,exports){"use strict";module.exports=function(Promise,PromiseArray,apiRejection,debug){var util=_dereq_("./util");var tryCatch=util.tryCatch;var errorObj=util.errorObj;var async=Promise._async;Promise.prototype["break"]=Promise.prototype.cancel=function(){if(!debug.cancellation())return this._warn("cancellation is disabled");var promise=this;var child=promise;while(promise._isCancellable()){if(!promise._cancelBy(child)){if(child._isFollowing()){child._followee().cancel();}else{child._cancelBranched();}break;}var parent=promise._cancellationParent;if(parent==null||!parent._isCancellable()){if(promise._isFollowing()){promise._followee().cancel();}else{promise._cancelBranched();}break;}else{if(promise._isFollowing())promise._followee().cancel();promise._setWillBeCancelled();child=promise;promise=parent;}}};Promise.prototype._branchHasCancelled=function(){this._branchesRemainingToCancel--;};Promise.prototype._enoughBranchesHaveCancelled=function(){return this._branchesRemainingToCancel===undefined||this._branchesRemainingToCancel<=0;};Promise.prototype._cancelBy=function(canceller){if(canceller===this){this._branchesRemainingToCancel=0;this._invokeOnCancel();return true;}else{this._branchHasCancelled();if(this._enoughBranchesHaveCancelled()){this._invokeOnCancel();return true;}}return false;};Promise.prototype._cancelBranched=function(){if(this._enoughBranchesHaveCancelled()){this._cancel();}};Promise.prototype._cancel=function(){if(!this._isCancellable())return;this._setCancelled();async.invoke(this._cancelPromises,this,undefined);};Promise.prototype._cancelPromises=function(){if(this._length()>0)this._settlePromises();};Promise.prototype._unsetOnCancel=function(){this._onCancelField=undefined;};Promise.prototype._isCancellable=function(){return this.isPending()&&!this._isCancelled();};Promise.prototype.isCancellable=function(){return this.isPending()&&!this.isCancelled();};Promise.prototype._doInvokeOnCancel=function(onCancelCallback,internalOnly){if(util.isArray(onCancelCallback)){for(var i=0;i<onCancelCallback.length;++i){this._doInvokeOnCancel(onCancelCallback[i],internalOnly);}}else if(onCancelCallback!==undefined){if(typeof onCancelCallback==="function"){if(!internalOnly){var e=tryCatch(onCancelCallback).call(this._boundValue());if(e===errorObj){this._attachExtraTrace(e.e);async.throwLater(e.e);}}}else{onCancelCallback._resultCancelled(this);}}};Promise.prototype._invokeOnCancel=function(){var onCancelCallback=this._onCancel();this._unsetOnCancel();async.invoke(this._doInvokeOnCancel,this,onCancelCallback);};Promise.prototype._invokeInternalOnCancel=function(){if(this._isCancellable()){this._doInvokeOnCancel(this._onCancel(),true);this._unsetOnCancel();}};Promise.prototype._resultCancelled=function(){this.cancel();};};},{"./util":36}],7:[function(_dereq_,module,exports){"use strict";module.exports=function(NEXT_FILTER){var util=_dereq_("./util");var getKeys=_dereq_("./es5").keys;var tryCatch=util.tryCatch;var errorObj=util.errorObj;function catchFilter(instances,cb,promise){return function(e){var boundTo=promise._boundValue();predicateLoop:for(var i=0;i<instances.length;++i){var item=instances[i];if(item===Error||item!=null&&item.prototype instanceof Error){if(e instanceof item){return tryCatch(cb).call(boundTo,e);}}else if(typeof item==="function"){var matchesPredicate=tryCatch(item).call(boundTo,e);if(matchesPredicate===errorObj){return matchesPredicate;}else if(matchesPredicate){return tryCatch(cb).call(boundTo,e);}}else if(util.isObject(e)){var keys=getKeys(item);for(var j=0;j<keys.length;++j){var key=keys[j];if(item[key]!=e[key]){continue predicateLoop;}}return tryCatch(cb).call(boundTo,e);}}return NEXT_FILTER;};}return catchFilter;};},{"./es5":13,"./util":36}],8:[function(_dereq_,module,exports){"use strict";module.exports=function(Promise){var longStackTraces=false;var contextStack=[];Promise.prototype._promiseCreated=function(){};Promise.prototype._pushContext=function(){};Promise.prototype._popContext=function(){return null;};Promise._peekContext=Promise.prototype._peekContext=function(){};function Context(){this._trace=new Context.CapturedTrace(peekContext());}Context.prototype._pushContext=function(){if(this._trace!==undefined){this._trace._promiseCreated=null;contextStack.push(this._trace);}};Context.prototype._popContext=function(){if(this._trace!==undefined){var trace=contextStack.pop();var ret=trace._promiseCreated;trace._promiseCreated=null;return ret;}return null;};function createContext(){if(longStackTraces)return new Context();}function peekContext(){var lastIndex=contextStack.length-1;if(lastIndex>=0){return contextStack[lastIndex];}return undefined;}Context.CapturedTrace=null;Context.create=createContext;Context.deactivateLongStackTraces=function(){};Context.activateLongStackTraces=function(){var Promise_pushContext=Promise.prototype._pushContext;var Promise_popContext=Promise.prototype._popContext;var Promise_PeekContext=Promise._peekContext;var Promise_peekContext=Promise.prototype._peekContext;var Promise_promiseCreated=Promise.prototype._promiseCreated;Context.deactivateLongStackTraces=function(){Promise.prototype._pushContext=Promise_pushContext;Promise.prototype._popContext=Promise_popContext;Promise._peekContext=Promise_PeekContext;Promise.prototype._peekContext=Promise_peekContext;Promise.prototype._promiseCreated=Promise_promiseCreated;longStackTraces=false;};longStackTraces=true;Promise.prototype._pushContext=Context.prototype._pushContext;Promise.prototype._popContext=Context.prototype._popContext;Promise._peekContext=Promise.prototype._peekContext=peekContext;Promise.prototype._promiseCreated=function(){var ctx=this._peekContext();if(ctx&&ctx._promiseCreated==null)ctx._promiseCreated=this;};};return Context;};},{}],9:[function(_dereq_,module,exports){"use strict";module.exports=function(Promise,Context){var getDomain=Promise._getDomain;var async=Promise._async;var Warning=_dereq_("./errors").Warning;var util=_dereq_("./util");var canAttachTrace=util.canAttachTrace;var unhandledRejectionHandled;var possiblyUnhandledRejection;var bluebirdFramePattern=/[\\\/]bluebird[\\\/]js[\\\/](release|debug|instrumented)/;var nodeFramePattern=/\((?:timers\.js):\d+:\d+\)/;var parseLinePattern=/[\/<\(](.+?):(\d+):(\d+)\)?\s*$/;var stackFramePattern=null;var formatStack=null;var indentStackFrames=false;var printWarning;var debugging=!!(util.env("BLUEBIRD_DEBUG")!=0&&(true||util.env("BLUEBIRD_DEBUG")||util.env("NODE_ENV")==="development"));var warnings=!!(util.env("BLUEBIRD_WARNINGS")!=0&&(debugging||util.env("BLUEBIRD_WARNINGS")));var longStackTraces=!!(util.env("BLUEBIRD_LONG_STACK_TRACES")!=0&&(debugging||util.env("BLUEBIRD_LONG_STACK_TRACES")));var wForgottenReturn=util.env("BLUEBIRD_W_FORGOTTEN_RETURN")!=0&&(warnings||!!util.env("BLUEBIRD_W_FORGOTTEN_RETURN"));Promise.prototype.suppressUnhandledRejections=function(){var target=this._target();target._bitField=target._bitField&~1048576|524288;};Promise.prototype._ensurePossibleRejectionHandled=function(){if((this._bitField&524288)!==0)return;this._setRejectionIsUnhandled();async.invokeLater(this._notifyUnhandledRejection,this,undefined);};Promise.prototype._notifyUnhandledRejectionIsHandled=function(){fireRejectionEvent("rejectionHandled",unhandledRejectionHandled,undefined,this);};Promise.prototype._setReturnedNonUndefined=function(){this._bitField=this._bitField|268435456;};Promise.prototype._returnedNonUndefined=function(){return(this._bitField&268435456)!==0;};Promise.prototype._notifyUnhandledRejection=function(){if(this._isRejectionUnhandled()){var reason=this._settledValue();this._setUnhandledRejectionIsNotified();fireRejectionEvent("unhandledRejection",possiblyUnhandledRejection,reason,this);}};Promise.prototype._setUnhandledRejectionIsNotified=function(){this._bitField=this._bitField|262144;};Promise.prototype._unsetUnhandledRejectionIsNotified=function(){this._bitField=this._bitField&~262144;};Promise.prototype._isUnhandledRejectionNotified=function(){return(this._bitField&262144)>0;};Promise.prototype._setRejectionIsUnhandled=function(){this._bitField=this._bitField|1048576;};Promise.prototype._unsetRejectionIsUnhandled=function(){this._bitField=this._bitField&~1048576;if(this._isUnhandledRejectionNotified()){this._unsetUnhandledRejectionIsNotified();this._notifyUnhandledRejectionIsHandled();}};Promise.prototype._isRejectionUnhandled=function(){return(this._bitField&1048576)>0;};Promise.prototype._warn=function(message,shouldUseOwnTrace,promise){return warn(message,shouldUseOwnTrace,promise||this);};Promise.onPossiblyUnhandledRejection=function(fn){var domain=getDomain();possiblyUnhandledRejection=typeof fn==="function"?domain===null?fn:util.domainBind(domain,fn):undefined;};Promise.onUnhandledRejectionHandled=function(fn){var domain=getDomain();unhandledRejectionHandled=typeof fn==="function"?domain===null?fn:util.domainBind(domain,fn):undefined;};var disableLongStackTraces=function disableLongStackTraces(){};Promise.longStackTraces=function(){if(async.haveItemsQueued()&&!config.longStackTraces){throw new Error("cannot enable long stack traces after promises have been created\n\n    See http://goo.gl/MqrFmX\n");}if(!config.longStackTraces&&longStackTracesIsSupported()){var Promise_captureStackTrace=Promise.prototype._captureStackTrace;var Promise_attachExtraTrace=Promise.prototype._attachExtraTrace;config.longStackTraces=true;disableLongStackTraces=function disableLongStackTraces(){if(async.haveItemsQueued()&&!config.longStackTraces){throw new Error("cannot enable long stack traces after promises have been created\n\n    See http://goo.gl/MqrFmX\n");}Promise.prototype._captureStackTrace=Promise_captureStackTrace;Promise.prototype._attachExtraTrace=Promise_attachExtraTrace;Context.deactivateLongStackTraces();async.enableTrampoline();config.longStackTraces=false;};Promise.prototype._captureStackTrace=longStackTracesCaptureStackTrace;Promise.prototype._attachExtraTrace=longStackTracesAttachExtraTrace;Context.activateLongStackTraces();async.disableTrampolineIfNecessary();}};Promise.hasLongStackTraces=function(){return config.longStackTraces&&longStackTracesIsSupported();};var fireDomEvent=function(){try{if(typeof CustomEvent==="function"){var event=new CustomEvent("CustomEvent");util.global.dispatchEvent(event);return function(name,event){var domEvent=new CustomEvent(name.toLowerCase(),{detail:event,cancelable:true});return!util.global.dispatchEvent(domEvent);};}else if(typeof Event==="function"){var event=new Event("CustomEvent");util.global.dispatchEvent(event);return function(name,event){var domEvent=new Event(name.toLowerCase(),{cancelable:true});domEvent.detail=event;return!util.global.dispatchEvent(domEvent);};}else{var event=document.createEvent("CustomEvent");event.initCustomEvent("testingtheevent",false,true,{});util.global.dispatchEvent(event);return function(name,event){var domEvent=document.createEvent("CustomEvent");domEvent.initCustomEvent(name.toLowerCase(),false,true,event);return!util.global.dispatchEvent(domEvent);};}}catch(e){}return function(){return false;};}();var fireGlobalEvent=function(){if(util.isNode){return function(){return process.emit.apply(process,arguments);};}else{if(!util.global){return function(){return false;};}return function(name){var methodName="on"+name.toLowerCase();var method=util.global[methodName];if(!method)return false;method.apply(util.global,[].slice.call(arguments,1));return true;};}}();function generatePromiseLifecycleEventObject(name,promise){return{promise:promise};}var eventToObjectGenerator={promiseCreated:generatePromiseLifecycleEventObject,promiseFulfilled:generatePromiseLifecycleEventObject,promiseRejected:generatePromiseLifecycleEventObject,promiseResolved:generatePromiseLifecycleEventObject,promiseCancelled:generatePromiseLifecycleEventObject,promiseChained:function promiseChained(name,promise,child){return{promise:promise,child:child};},warning:function warning(name,_warning){return{warning:_warning};},unhandledRejection:function unhandledRejection(name,reason,promise){return{reason:reason,promise:promise};},rejectionHandled:generatePromiseLifecycleEventObject};var activeFireEvent=function activeFireEvent(name){var globalEventFired=false;try{globalEventFired=fireGlobalEvent.apply(null,arguments);}catch(e){async.throwLater(e);globalEventFired=true;}var domEventFired=false;try{domEventFired=fireDomEvent(name,eventToObjectGenerator[name].apply(null,arguments));}catch(e){async.throwLater(e);domEventFired=true;}return domEventFired||globalEventFired;};Promise.config=function(opts){opts=Object(opts);if("longStackTraces"in opts){if(opts.longStackTraces){Promise.longStackTraces();}else if(!opts.longStackTraces&&Promise.hasLongStackTraces()){disableLongStackTraces();}}if("warnings"in opts){var warningsOption=opts.warnings;config.warnings=!!warningsOption;wForgottenReturn=config.warnings;if(util.isObject(warningsOption)){if("wForgottenReturn"in warningsOption){wForgottenReturn=!!warningsOption.wForgottenReturn;}}}if("cancellation"in opts&&opts.cancellation&&!config.cancellation){if(async.haveItemsQueued()){throw new Error("cannot enable cancellation after promises are in use");}Promise.prototype._clearCancellationData=cancellationClearCancellationData;Promise.prototype._propagateFrom=cancellationPropagateFrom;Promise.prototype._onCancel=cancellationOnCancel;Promise.prototype._setOnCancel=cancellationSetOnCancel;Promise.prototype._attachCancellationCallback=cancellationAttachCancellationCallback;Promise.prototype._execute=cancellationExecute;_propagateFromFunction=cancellationPropagateFrom;config.cancellation=true;}if("monitoring"in opts){if(opts.monitoring&&!config.monitoring){config.monitoring=true;Promise.prototype._fireEvent=activeFireEvent;}else if(!opts.monitoring&&config.monitoring){config.monitoring=false;Promise.prototype._fireEvent=defaultFireEvent;}}return Promise;};function defaultFireEvent(){return false;}Promise.prototype._fireEvent=defaultFireEvent;Promise.prototype._execute=function(executor,resolve,reject){try{executor(resolve,reject);}catch(e){return e;}};Promise.prototype._onCancel=function(){};Promise.prototype._setOnCancel=function(handler){;};Promise.prototype._attachCancellationCallback=function(onCancel){;};Promise.prototype._captureStackTrace=function(){};Promise.prototype._attachExtraTrace=function(){};Promise.prototype._clearCancellationData=function(){};Promise.prototype._propagateFrom=function(parent,flags){;;};function cancellationExecute(executor,resolve,reject){var promise=this;try{executor(resolve,reject,function(onCancel){if(typeof onCancel!=="function"){throw new TypeError("onCancel must be a function, got: "+util.toString(onCancel));}promise._attachCancellationCallback(onCancel);});}catch(e){return e;}}function cancellationAttachCancellationCallback(onCancel){if(!this._isCancellable())return this;var previousOnCancel=this._onCancel();if(previousOnCancel!==undefined){if(util.isArray(previousOnCancel)){previousOnCancel.push(onCancel);}else{this._setOnCancel([previousOnCancel,onCancel]);}}else{this._setOnCancel(onCancel);}}function cancellationOnCancel(){return this._onCancelField;}function cancellationSetOnCancel(onCancel){this._onCancelField=onCancel;}function cancellationClearCancellationData(){this._cancellationParent=undefined;this._onCancelField=undefined;}function cancellationPropagateFrom(parent,flags){if((flags&1)!==0){this._cancellationParent=parent;var branchesRemainingToCancel=parent._branchesRemainingToCancel;if(branchesRemainingToCancel===undefined){branchesRemainingToCancel=0;}parent._branchesRemainingToCancel=branchesRemainingToCancel+1;}if((flags&2)!==0&&parent._isBound()){this._setBoundTo(parent._boundTo);}}function bindingPropagateFrom(parent,flags){if((flags&2)!==0&&parent._isBound()){this._setBoundTo(parent._boundTo);}}var _propagateFromFunction=bindingPropagateFrom;function _boundValueFunction(){var ret=this._boundTo;if(ret!==undefined){if(ret instanceof Promise){if(ret.isFulfilled()){return ret.value();}else{return undefined;}}}return ret;}function longStackTracesCaptureStackTrace(){this._trace=new CapturedTrace(this._peekContext());}function longStackTracesAttachExtraTrace(error,ignoreSelf){if(canAttachTrace(error)){var trace=this._trace;if(trace!==undefined){if(ignoreSelf)trace=trace._parent;}if(trace!==undefined){trace.attachExtraTrace(error);}else if(!error.__stackCleaned__){var parsed=parseStackAndMessage(error);util.notEnumerableProp(error,"stack",parsed.message+"\n"+parsed.stack.join("\n"));util.notEnumerableProp(error,"__stackCleaned__",true);}}}function checkForgottenReturns(returnValue,promiseCreated,name,promise,parent){if(returnValue===undefined&&promiseCreated!==null&&wForgottenReturn){if(parent!==undefined&&parent._returnedNonUndefined())return;if((promise._bitField&65535)===0)return;if(name)name=name+" ";var handlerLine="";var creatorLine="";if(promiseCreated._trace){var traceLines=promiseCreated._trace.stack.split("\n");var stack=cleanStack(traceLines);for(var i=stack.length-1;i>=0;--i){var line=stack[i];if(!nodeFramePattern.test(line)){var lineMatches=line.match(parseLinePattern);if(lineMatches){handlerLine="at "+lineMatches[1]+":"+lineMatches[2]+":"+lineMatches[3]+" ";}break;}}if(stack.length>0){var firstUserLine=stack[0];for(var i=0;i<traceLines.length;++i){if(traceLines[i]===firstUserLine){if(i>0){creatorLine="\n"+traceLines[i-1];}break;}}}}var msg="a promise was created in a "+name+"handler "+handlerLine+"but was not returned from it, "+"see http://goo.gl/rRqMUw"+creatorLine;promise._warn(msg,true,promiseCreated);}}function deprecated(name,replacement){var message=name+" is deprecated and will be removed in a future version.";if(replacement)message+=" Use "+replacement+" instead.";return warn(message);}function warn(message,shouldUseOwnTrace,promise){if(!config.warnings)return;var warning=new Warning(message);var ctx;if(shouldUseOwnTrace){promise._attachExtraTrace(warning);}else if(config.longStackTraces&&(ctx=Promise._peekContext())){ctx.attachExtraTrace(warning);}else{var parsed=parseStackAndMessage(warning);warning.stack=parsed.message+"\n"+parsed.stack.join("\n");}if(!activeFireEvent("warning",warning)){formatAndLogError(warning,"",true);}}function reconstructStack(message,stacks){for(var i=0;i<stacks.length-1;++i){stacks[i].push("From previous event:");stacks[i]=stacks[i].join("\n");}if(i<stacks.length){stacks[i]=stacks[i].join("\n");}return message+"\n"+stacks.join("\n");}function removeDuplicateOrEmptyJumps(stacks){for(var i=0;i<stacks.length;++i){if(stacks[i].length===0||i+1<stacks.length&&stacks[i][0]===stacks[i+1][0]){stacks.splice(i,1);i--;}}}function removeCommonRoots(stacks){var current=stacks[0];for(var i=1;i<stacks.length;++i){var prev=stacks[i];var currentLastIndex=current.length-1;var currentLastLine=current[currentLastIndex];var commonRootMeetPoint=-1;for(var j=prev.length-1;j>=0;--j){if(prev[j]===currentLastLine){commonRootMeetPoint=j;break;}}for(var j=commonRootMeetPoint;j>=0;--j){var line=prev[j];if(current[currentLastIndex]===line){current.pop();currentLastIndex--;}else{break;}}current=prev;}}function cleanStack(stack){var ret=[];for(var i=0;i<stack.length;++i){var line=stack[i];var isTraceLine="    (No stack trace)"===line||stackFramePattern.test(line);var isInternalFrame=isTraceLine&&shouldIgnore(line);if(isTraceLine&&!isInternalFrame){if(indentStackFrames&&line.charAt(0)!==" "){line="    "+line;}ret.push(line);}}return ret;}function stackFramesAsArray(error){var stack=error.stack.replace(/\s+$/g,"").split("\n");for(var i=0;i<stack.length;++i){var line=stack[i];if("    (No stack trace)"===line||stackFramePattern.test(line)){break;}}if(i>0&&error.name!="SyntaxError"){stack=stack.slice(i);}return stack;}function parseStackAndMessage(error){var stack=error.stack;var message=error.toString();stack=typeof stack==="string"&&stack.length>0?stackFramesAsArray(error):["    (No stack trace)"];return{message:message,stack:error.name=="SyntaxError"?stack:cleanStack(stack)};}function formatAndLogError(error,title,isSoft){if(typeof console!=="undefined"){var message;if(util.isObject(error)){var stack=error.stack;message=title+formatStack(stack,error);}else{message=title+String(error);}if(typeof printWarning==="function"){printWarning(message,isSoft);}else if(typeof console.log==="function"||_typeof4(console.log)==="object"){console.log(message);}}}function fireRejectionEvent(name,localHandler,reason,promise){var localEventFired=false;try{if(typeof localHandler==="function"){localEventFired=true;if(name==="rejectionHandled"){localHandler(promise);}else{localHandler(reason,promise);}}}catch(e){async.throwLater(e);}if(name==="unhandledRejection"){if(!activeFireEvent(name,reason,promise)&&!localEventFired){formatAndLogError(reason,"Unhandled rejection ");}}else{activeFireEvent(name,promise);}}function formatNonError(obj){var str;if(typeof obj==="function"){str="[function "+(obj.name||"anonymous")+"]";}else{str=obj&&typeof obj.toString==="function"?obj.toString():util.toString(obj);var ruselessToString=/\[object [a-zA-Z0-9$_]+\]/;if(ruselessToString.test(str)){try{var newStr=JSON.stringify(obj);str=newStr;}catch(e){}}if(str.length===0){str="(empty array)";}}return"(<"+snip(str)+">, no stack trace)";}function snip(str){var maxChars=41;if(str.length<maxChars){return str;}return str.substr(0,maxChars-3)+"...";}function longStackTracesIsSupported(){return typeof captureStackTrace==="function";}var shouldIgnore=function shouldIgnore(){return false;};var parseLineInfoRegex=/[\/<\(]([^:\/]+):(\d+):(?:\d+)\)?\s*$/;function parseLineInfo(line){var matches=line.match(parseLineInfoRegex);if(matches){return{fileName:matches[1],line:parseInt(matches[2],10)};}}function setBounds(firstLineError,lastLineError){if(!longStackTracesIsSupported())return;var firstStackLines=firstLineError.stack.split("\n");var lastStackLines=lastLineError.stack.split("\n");var firstIndex=-1;var lastIndex=-1;var firstFileName;var lastFileName;for(var i=0;i<firstStackLines.length;++i){var result=parseLineInfo(firstStackLines[i]);if(result){firstFileName=result.fileName;firstIndex=result.line;break;}}for(var i=0;i<lastStackLines.length;++i){var result=parseLineInfo(lastStackLines[i]);if(result){lastFileName=result.fileName;lastIndex=result.line;break;}}if(firstIndex<0||lastIndex<0||!firstFileName||!lastFileName||firstFileName!==lastFileName||firstIndex>=lastIndex){return;}shouldIgnore=function shouldIgnore(line){if(bluebirdFramePattern.test(line))return true;var info=parseLineInfo(line);if(info){if(info.fileName===firstFileName&&firstIndex<=info.line&&info.line<=lastIndex){return true;}}return false;};}function CapturedTrace(parent){this._parent=parent;this._promisesCreated=0;var length=this._length=1+(parent===undefined?0:parent._length);captureStackTrace(this,CapturedTrace);if(length>32)this.uncycle();}util.inherits(CapturedTrace,Error);Context.CapturedTrace=CapturedTrace;CapturedTrace.prototype.uncycle=function(){var length=this._length;if(length<2)return;var nodes=[];var stackToIndex={};for(var i=0,node=this;node!==undefined;++i){nodes.push(node);node=node._parent;}length=this._length=i;for(var i=length-1;i>=0;--i){var stack=nodes[i].stack;if(stackToIndex[stack]===undefined){stackToIndex[stack]=i;}}for(var i=0;i<length;++i){var currentStack=nodes[i].stack;var index=stackToIndex[currentStack];if(index!==undefined&&index!==i){if(index>0){nodes[index-1]._parent=undefined;nodes[index-1]._length=1;}nodes[i]._parent=undefined;nodes[i]._length=1;var cycleEdgeNode=i>0?nodes[i-1]:this;if(index<length-1){cycleEdgeNode._parent=nodes[index+1];cycleEdgeNode._parent.uncycle();cycleEdgeNode._length=cycleEdgeNode._parent._length+1;}else{cycleEdgeNode._parent=undefined;cycleEdgeNode._length=1;}var currentChildLength=cycleEdgeNode._length+1;for(var j=i-2;j>=0;--j){nodes[j]._length=currentChildLength;currentChildLength++;}return;}}};CapturedTrace.prototype.attachExtraTrace=function(error){if(error.__stackCleaned__)return;this.uncycle();var parsed=parseStackAndMessage(error);var message=parsed.message;var stacks=[parsed.stack];var trace=this;while(trace!==undefined){stacks.push(cleanStack(trace.stack.split("\n")));trace=trace._parent;}removeCommonRoots(stacks);removeDuplicateOrEmptyJumps(stacks);util.notEnumerableProp(error,"stack",reconstructStack(message,stacks));util.notEnumerableProp(error,"__stackCleaned__",true);};var captureStackTrace=function stackDetection(){var v8stackFramePattern=/^\s*at\s*/;var v8stackFormatter=function v8stackFormatter(stack,error){if(typeof stack==="string")return stack;if(error.name!==undefined&&error.message!==undefined){return error.toString();}return formatNonError(error);};if(typeof Error.stackTraceLimit==="number"&&typeof Error.captureStackTrace==="function"){Error.stackTraceLimit+=6;stackFramePattern=v8stackFramePattern;formatStack=v8stackFormatter;var captureStackTrace=Error.captureStackTrace;shouldIgnore=function shouldIgnore(line){return bluebirdFramePattern.test(line);};return function(receiver,ignoreUntil){Error.stackTraceLimit+=6;captureStackTrace(receiver,ignoreUntil);Error.stackTraceLimit-=6;};}var err=new Error();if(typeof err.stack==="string"&&err.stack.split("\n")[0].indexOf("stackDetection@")>=0){stackFramePattern=/@/;formatStack=v8stackFormatter;indentStackFrames=true;return function captureStackTrace(o){o.stack=new Error().stack;};}var hasStackAfterThrow;try{throw new Error();}catch(e){hasStackAfterThrow="stack"in e;}if(!("stack"in err)&&hasStackAfterThrow&&typeof Error.stackTraceLimit==="number"){stackFramePattern=v8stackFramePattern;formatStack=v8stackFormatter;return function captureStackTrace(o){Error.stackTraceLimit+=6;try{throw new Error();}catch(e){o.stack=e.stack;}Error.stackTraceLimit-=6;};}formatStack=function formatStack(stack,error){if(typeof stack==="string")return stack;if(((typeof error==="undefined"?"undefined":_typeof4(error))==="object"||typeof error==="function")&&error.name!==undefined&&error.message!==undefined){return error.toString();}return formatNonError(error);};return null;}([]);if(typeof console!=="undefined"&&typeof console.warn!=="undefined"){printWarning=function printWarning(message){console.warn(message);};if(util.isNode&&process.stderr.isTTY){printWarning=function printWarning(message,isSoft){var color=isSoft?"\x1B[33m":"\x1B[31m";console.warn(color+message+"\x1B[0m\n");};}else if(!util.isNode&&typeof new Error().stack==="string"){printWarning=function printWarning(message,isSoft){console.warn("%c"+message,isSoft?"color: darkorange":"color: red");};}}var config={warnings:warnings,longStackTraces:false,cancellation:false,monitoring:false};if(longStackTraces)Promise.longStackTraces();return{longStackTraces:function longStackTraces(){return config.longStackTraces;},warnings:function warnings(){return config.warnings;},cancellation:function cancellation(){return config.cancellation;},monitoring:function monitoring(){return config.monitoring;},propagateFromFunction:function propagateFromFunction(){return _propagateFromFunction;},boundValueFunction:function boundValueFunction(){return _boundValueFunction;},checkForgottenReturns:checkForgottenReturns,setBounds:setBounds,warn:warn,deprecated:deprecated,CapturedTrace:CapturedTrace,fireDomEvent:fireDomEvent,fireGlobalEvent:fireGlobalEvent};};},{"./errors":12,"./util":36}],10:[function(_dereq_,module,exports){"use strict";module.exports=function(Promise){function returner(){return this.value;}function thrower(){throw this.reason;}Promise.prototype["return"]=Promise.prototype.thenReturn=function(value){if(value instanceof Promise)value.suppressUnhandledRejections();return this._then(returner,undefined,undefined,{value:value},undefined);};Promise.prototype["throw"]=Promise.prototype.thenThrow=function(reason){return this._then(thrower,undefined,undefined,{reason:reason},undefined);};Promise.prototype.catchThrow=function(reason){if(arguments.length<=1){return this._then(undefined,thrower,undefined,{reason:reason},undefined);}else{var _reason=arguments[1];var handler=function handler(){throw _reason;};return this.caught(reason,handler);}};Promise.prototype.catchReturn=function(value){if(arguments.length<=1){if(value instanceof Promise)value.suppressUnhandledRejections();return this._then(undefined,returner,undefined,{value:value},undefined);}else{var _value=arguments[1];if(_value instanceof Promise)_value.suppressUnhandledRejections();var handler=function handler(){return _value;};return this.caught(value,handler);}};};},{}],11:[function(_dereq_,module,exports){"use strict";module.exports=function(Promise,INTERNAL){var PromiseReduce=Promise.reduce;var PromiseAll=Promise.all;function promiseAllThis(){return PromiseAll(this);}function PromiseMapSeries(promises,fn){return PromiseReduce(promises,fn,INTERNAL,INTERNAL);}Promise.prototype.each=function(fn){return PromiseReduce(this,fn,INTERNAL,0)._then(promiseAllThis,undefined,undefined,this,undefined);};Promise.prototype.mapSeries=function(fn){return PromiseReduce(this,fn,INTERNAL,INTERNAL);};Promise.each=function(promises,fn){return PromiseReduce(promises,fn,INTERNAL,0)._then(promiseAllThis,undefined,undefined,promises,undefined);};Promise.mapSeries=PromiseMapSeries;};},{}],12:[function(_dereq_,module,exports){"use strict";var es5=_dereq_("./es5");var Objectfreeze=es5.freeze;var util=_dereq_("./util");var inherits=util.inherits;var notEnumerableProp=util.notEnumerableProp;function subError(nameProperty,defaultMessage){function SubError(message){if(!(this instanceof SubError))return new SubError(message);notEnumerableProp(this,"message",typeof message==="string"?message:defaultMessage);notEnumerableProp(this,"name",nameProperty);if(Error.captureStackTrace){Error.captureStackTrace(this,this.constructor);}else{Error.call(this);}}inherits(SubError,Error);return SubError;}var _TypeError,_RangeError;var Warning=subError("Warning","warning");var CancellationError=subError("CancellationError","cancellation error");var TimeoutError=subError("TimeoutError","timeout error");var AggregateError=subError("AggregateError","aggregate error");try{_TypeError=TypeError;_RangeError=RangeError;}catch(e){_TypeError=subError("TypeError","type error");_RangeError=subError("RangeError","range error");}var methods=("join pop push shift unshift slice filter forEach some "+"every map indexOf lastIndexOf reduce reduceRight sort reverse").split(" ");for(var i=0;i<methods.length;++i){if(typeof Array.prototype[methods[i]]==="function"){AggregateError.prototype[methods[i]]=Array.prototype[methods[i]];}}es5.defineProperty(AggregateError.prototype,"length",{value:0,configurable:false,writable:true,enumerable:true});AggregateError.prototype["isOperational"]=true;var level=0;AggregateError.prototype.toString=function(){var indent=Array(level*4+1).join(" ");var ret="\n"+indent+"AggregateError of:"+"\n";level++;indent=Array(level*4+1).join(" ");for(var i=0;i<this.length;++i){var str=this[i]===this?"[Circular AggregateError]":this[i]+"";var lines=str.split("\n");for(var j=0;j<lines.length;++j){lines[j]=indent+lines[j];}str=lines.join("\n");ret+=str+"\n";}level--;return ret;};function OperationalError(message){if(!(this instanceof OperationalError))return new OperationalError(message);notEnumerableProp(this,"name","OperationalError");notEnumerableProp(this,"message",message);this.cause=message;this["isOperational"]=true;if(message instanceof Error){notEnumerableProp(this,"message",message.message);notEnumerableProp(this,"stack",message.stack);}else if(Error.captureStackTrace){Error.captureStackTrace(this,this.constructor);}}inherits(OperationalError,Error);var errorTypes=Error["__BluebirdErrorTypes__"];if(!errorTypes){errorTypes=Objectfreeze({CancellationError:CancellationError,TimeoutError:TimeoutError,OperationalError:OperationalError,RejectionError:OperationalError,AggregateError:AggregateError});es5.defineProperty(Error,"__BluebirdErrorTypes__",{value:errorTypes,writable:false,enumerable:false,configurable:false});}module.exports={Error:Error,TypeError:_TypeError,RangeError:_RangeError,CancellationError:errorTypes.CancellationError,OperationalError:errorTypes.OperationalError,TimeoutError:errorTypes.TimeoutError,AggregateError:errorTypes.AggregateError,Warning:Warning};},{"./es5":13,"./util":36}],13:[function(_dereq_,module,exports){var isES5=function(){"use strict";return this===undefined;}();if(isES5){module.exports={freeze:Object.freeze,defineProperty:Object.defineProperty,getDescriptor:Object.getOwnPropertyDescriptor,keys:Object.keys,names:Object.getOwnPropertyNames,getPrototypeOf:Object.getPrototypeOf,isArray:Array.isArray,isES5:isES5,propertyIsWritable:function propertyIsWritable(obj,prop){var descriptor=Object.getOwnPropertyDescriptor(obj,prop);return!!(!descriptor||descriptor.writable||descriptor.set);}};}else{var has={}.hasOwnProperty;var str={}.toString;var proto={}.constructor.prototype;var ObjectKeys=function ObjectKeys(o){var ret=[];for(var key in o){if(has.call(o,key)){ret.push(key);}}return ret;};var ObjectGetDescriptor=function ObjectGetDescriptor(o,key){return{value:o[key]};};var ObjectDefineProperty=function ObjectDefineProperty(o,key,desc){o[key]=desc.value;return o;};var ObjectFreeze=function ObjectFreeze(obj){return obj;};var ObjectGetPrototypeOf=function ObjectGetPrototypeOf(obj){try{return Object(obj).constructor.prototype;}catch(e){return proto;}};var ArrayIsArray=function ArrayIsArray(obj){try{return str.call(obj)==="[object Array]";}catch(e){return false;}};module.exports={isArray:ArrayIsArray,keys:ObjectKeys,names:ObjectKeys,defineProperty:ObjectDefineProperty,getDescriptor:ObjectGetDescriptor,freeze:ObjectFreeze,getPrototypeOf:ObjectGetPrototypeOf,isES5:isES5,propertyIsWritable:function propertyIsWritable(){return true;}};}},{}],14:[function(_dereq_,module,exports){"use strict";module.exports=function(Promise,INTERNAL){var PromiseMap=Promise.map;Promise.prototype.filter=function(fn,options){return PromiseMap(this,fn,options,INTERNAL);};Promise.filter=function(promises,fn,options){return PromiseMap(promises,fn,options,INTERNAL);};};},{}],15:[function(_dereq_,module,exports){"use strict";module.exports=function(Promise,tryConvertToPromise){var util=_dereq_("./util");var CancellationError=Promise.CancellationError;var errorObj=util.errorObj;function PassThroughHandlerContext(promise,type,handler){this.promise=promise;this.type=type;this.handler=handler;this.called=false;this.cancelPromise=null;}PassThroughHandlerContext.prototype.isFinallyHandler=function(){return this.type===0;};function FinallyHandlerCancelReaction(finallyHandler){this.finallyHandler=finallyHandler;}FinallyHandlerCancelReaction.prototype._resultCancelled=function(){checkCancel(this.finallyHandler);};function checkCancel(ctx,reason){if(ctx.cancelPromise!=null){if(arguments.length>1){ctx.cancelPromise._reject(reason);}else{ctx.cancelPromise._cancel();}ctx.cancelPromise=null;return true;}return false;}function succeed(){return finallyHandler.call(this,this.promise._target()._settledValue());}function fail(reason){if(checkCancel(this,reason))return;errorObj.e=reason;return errorObj;}function finallyHandler(reasonOrValue){var promise=this.promise;var handler=this.handler;if(!this.called){this.called=true;var ret=this.isFinallyHandler()?handler.call(promise._boundValue()):handler.call(promise._boundValue(),reasonOrValue);if(ret!==undefined){promise._setReturnedNonUndefined();var maybePromise=tryConvertToPromise(ret,promise);if(maybePromise instanceof Promise){if(this.cancelPromise!=null){if(maybePromise._isCancelled()){var reason=new CancellationError("late cancellation observer");promise._attachExtraTrace(reason);errorObj.e=reason;return errorObj;}else if(maybePromise.isPending()){maybePromise._attachCancellationCallback(new FinallyHandlerCancelReaction(this));}}return maybePromise._then(succeed,fail,undefined,this,undefined);}}}if(promise.isRejected()){checkCancel(this);errorObj.e=reasonOrValue;return errorObj;}else{checkCancel(this);return reasonOrValue;}}Promise.prototype._passThrough=function(handler,type,success,fail){if(typeof handler!=="function")return this.then();return this._then(success,fail,undefined,new PassThroughHandlerContext(this,type,handler),undefined);};Promise.prototype.lastly=Promise.prototype["finally"]=function(handler){return this._passThrough(handler,0,finallyHandler,finallyHandler);};Promise.prototype.tap=function(handler){return this._passThrough(handler,1,finallyHandler);};return PassThroughHandlerContext;};},{"./util":36}],16:[function(_dereq_,module,exports){"use strict";module.exports=function(Promise,apiRejection,INTERNAL,tryConvertToPromise,Proxyable,debug){var errors=_dereq_("./errors");var TypeError=errors.TypeError;var util=_dereq_("./util");var errorObj=util.errorObj;var tryCatch=util.tryCatch;var yieldHandlers=[];function promiseFromYieldHandler(value,yieldHandlers,traceParent){for(var i=0;i<yieldHandlers.length;++i){traceParent._pushContext();var result=tryCatch(yieldHandlers[i])(value);traceParent._popContext();if(result===errorObj){traceParent._pushContext();var ret=Promise.reject(errorObj.e);traceParent._popContext();return ret;}var maybePromise=tryConvertToPromise(result,traceParent);if(maybePromise instanceof Promise)return maybePromise;}return null;}function PromiseSpawn(generatorFunction,receiver,yieldHandler,stack){if(debug.cancellation()){var internal=new Promise(INTERNAL);var _finallyPromise=this._finallyPromise=new Promise(INTERNAL);this._promise=internal.lastly(function(){return _finallyPromise;});internal._captureStackTrace();internal._setOnCancel(this);}else{var promise=this._promise=new Promise(INTERNAL);promise._captureStackTrace();}this._stack=stack;this._generatorFunction=generatorFunction;this._receiver=receiver;this._generator=undefined;this._yieldHandlers=typeof yieldHandler==="function"?[yieldHandler].concat(yieldHandlers):yieldHandlers;this._yieldedPromise=null;this._cancellationPhase=false;}util.inherits(PromiseSpawn,Proxyable);PromiseSpawn.prototype._isResolved=function(){return this._promise===null;};PromiseSpawn.prototype._cleanup=function(){this._promise=this._generator=null;if(debug.cancellation()&&this._finallyPromise!==null){this._finallyPromise._fulfill();this._finallyPromise=null;}};PromiseSpawn.prototype._promiseCancelled=function(){if(this._isResolved())return;var implementsReturn=typeof this._generator["return"]!=="undefined";var result;if(!implementsReturn){var reason=new Promise.CancellationError("generator .return() sentinel");Promise.coroutine.returnSentinel=reason;this._promise._attachExtraTrace(reason);this._promise._pushContext();result=tryCatch(this._generator["throw"]).call(this._generator,reason);this._promise._popContext();}else{this._promise._pushContext();result=tryCatch(this._generator["return"]).call(this._generator,undefined);this._promise._popContext();}this._cancellationPhase=true;this._yieldedPromise=null;this._continue(result);};PromiseSpawn.prototype._promiseFulfilled=function(value){this._yieldedPromise=null;this._promise._pushContext();var result=tryCatch(this._generator.next).call(this._generator,value);this._promise._popContext();this._continue(result);};PromiseSpawn.prototype._promiseRejected=function(reason){this._yieldedPromise=null;this._promise._attachExtraTrace(reason);this._promise._pushContext();var result=tryCatch(this._generator["throw"]).call(this._generator,reason);this._promise._popContext();this._continue(result);};PromiseSpawn.prototype._resultCancelled=function(){if(this._yieldedPromise instanceof Promise){var promise=this._yieldedPromise;this._yieldedPromise=null;promise.cancel();}};PromiseSpawn.prototype.promise=function(){return this._promise;};PromiseSpawn.prototype._run=function(){this._generator=this._generatorFunction.call(this._receiver);this._receiver=this._generatorFunction=undefined;this._promiseFulfilled(undefined);};PromiseSpawn.prototype._continue=function(result){var promise=this._promise;if(result===errorObj){this._cleanup();if(this._cancellationPhase){return promise.cancel();}else{return promise._rejectCallback(result.e,false);}}var value=result.value;if(result.done===true){this._cleanup();if(this._cancellationPhase){return promise.cancel();}else{return promise._resolveCallback(value);}}else{var maybePromise=tryConvertToPromise(value,this._promise);if(!(maybePromise instanceof Promise)){maybePromise=promiseFromYieldHandler(maybePromise,this._yieldHandlers,this._promise);if(maybePromise===null){this._promiseRejected(new TypeError("A value %s was yielded that could not be treated as a promise\n\n    See http://goo.gl/MqrFmX\n\n".replace("%s",value)+"From coroutine:\n"+this._stack.split("\n").slice(1,-7).join("\n")));return;}}maybePromise=maybePromise._target();var bitField=maybePromise._bitField;;if((bitField&50397184)===0){this._yieldedPromise=maybePromise;maybePromise._proxy(this,null);}else if((bitField&33554432)!==0){Promise._async.invoke(this._promiseFulfilled,this,maybePromise._value());}else if((bitField&16777216)!==0){Promise._async.invoke(this._promiseRejected,this,maybePromise._reason());}else{this._promiseCancelled();}}};Promise.coroutine=function(generatorFunction,options){if(typeof generatorFunction!=="function"){throw new TypeError("generatorFunction must be a function\n\n    See http://goo.gl/MqrFmX\n");}var yieldHandler=Object(options).yieldHandler;var PromiseSpawn$=PromiseSpawn;var stack=new Error().stack;return function(){var generator=generatorFunction.apply(this,arguments);var spawn=new PromiseSpawn$(undefined,undefined,yieldHandler,stack);var ret=spawn.promise();spawn._generator=generator;spawn._promiseFulfilled(undefined);return ret;};};Promise.coroutine.addYieldHandler=function(fn){if(typeof fn!=="function"){throw new TypeError("expecting a function but got "+util.classString(fn));}yieldHandlers.push(fn);};Promise.spawn=function(generatorFunction){debug.deprecated("Promise.spawn()","Promise.coroutine()");if(typeof generatorFunction!=="function"){return apiRejection("generatorFunction must be a function\n\n    See http://goo.gl/MqrFmX\n");}var spawn=new PromiseSpawn(generatorFunction,this);var ret=spawn.promise();spawn._run(Promise.spawn);return ret;};};},{"./errors":12,"./util":36}],17:[function(_dereq_,module,exports){"use strict";module.exports=function(Promise,PromiseArray,tryConvertToPromise,INTERNAL,async,getDomain){var util=_dereq_("./util");var canEvaluate=util.canEvaluate;var tryCatch=util.tryCatch;var errorObj=util.errorObj;var reject;if(false){if(canEvaluate){var thenCallback=function thenCallback(i){return new Function("value","holder","                             \n\
            'use strict';                                                    \n\
            holder.pIndex = value;                                           \n\
            holder.checkFulfillment(this);                                   \n\
            ".replace(/Index/g,i));};var promiseSetter=function promiseSetter(i){return new Function("promise","holder","                           \n\
            'use strict';                                                    \n\
            holder.pIndex = promise;                                         \n\
            ".replace(/Index/g,i));};var generateHolderClass=function generateHolderClass(total){var props=new Array(total);for(var i=0;i<props.length;++i){props[i]="this.p"+(i+1);}var assignment=props.join(" = ")+" = null;";var cancellationCode="var promise;\n"+props.map(function(prop){return"                                                         \n\
                promise = "+prop+";                                      \n\
                if (promise instanceof Promise) {                            \n\
                    promise.cancel();                                        \n\
                }                                                            \n\
            ";}).join("\n");var passedArguments=props.join(", ");var name="Holder$"+total;var code="return function(tryCatch, errorObj, Promise, async) {    \n\
            'use strict';                                                    \n\
            function [TheName](fn) {                                         \n\
                [TheProperties]                                              \n\
                this.fn = fn;                                                \n\
                this.asyncNeeded = true;                                     \n\
                this.now = 0;                                                \n\
            }                                                                \n\
                                                                             \n\
            [TheName].prototype._callFunction = function(promise) {          \n\
                promise._pushContext();                                      \n\
                var ret = tryCatch(this.fn)([ThePassedArguments]);           \n\
                promise._popContext();                                       \n\
                if (ret === errorObj) {                                      \n\
                    promise._rejectCallback(ret.e, false);                   \n\
                } else {                                                     \n\
                    promise._resolveCallback(ret);                           \n\
                }                                                            \n\
            };                                                               \n\
                                                                             \n\
            [TheName].prototype.checkFulfillment = function(promise) {       \n\
                var now = ++this.now;                                        \n\
                if (now === [TheTotal]) {                                    \n\
                    if (this.asyncNeeded) {                                  \n\
                        async.invoke(this._callFunction, this, promise);     \n\
                    } else {                                                 \n\
                        this._callFunction(promise);                         \n\
                    }                                                        \n\
                                                                             \n\
                }                                                            \n\
            };                                                               \n\
                                                                             \n\
            [TheName].prototype._resultCancelled = function() {              \n\
                [CancellationCode]                                           \n\
            };                                                               \n\
                                                                             \n\
            return [TheName];                                                \n\
        }(tryCatch, errorObj, Promise, async);                               \n\
        ";code=code.replace(/\[TheName\]/g,name).replace(/\[TheTotal\]/g,total).replace(/\[ThePassedArguments\]/g,passedArguments).replace(/\[TheProperties\]/g,assignment).replace(/\[CancellationCode\]/g,cancellationCode);return new Function("tryCatch","errorObj","Promise","async",code)(tryCatch,errorObj,Promise,async);};var holderClasses=[];var thenCallbacks=[];var promiseSetters=[];for(var i=0;i<8;++i){holderClasses.push(generateHolderClass(i+1));thenCallbacks.push(thenCallback(i+1));promiseSetters.push(promiseSetter(i+1));}reject=function reject(reason){this._reject(reason);};}}Promise.join=function(){var last=arguments.length-1;var fn;if(last>0&&typeof arguments[last]==="function"){fn=arguments[last];if(false){if(last<=8&&canEvaluate){var ret=new Promise(INTERNAL);ret._captureStackTrace();var HolderClass=holderClasses[last-1];var holder=new HolderClass(fn);var callbacks=thenCallbacks;for(var i=0;i<last;++i){var maybePromise=tryConvertToPromise(arguments[i],ret);if(maybePromise instanceof Promise){maybePromise=maybePromise._target();var bitField=maybePromise._bitField;;if((bitField&50397184)===0){maybePromise._then(callbacks[i],reject,undefined,ret,holder);promiseSetters[i](maybePromise,holder);holder.asyncNeeded=false;}else if((bitField&33554432)!==0){callbacks[i].call(ret,maybePromise._value(),holder);}else if((bitField&16777216)!==0){ret._reject(maybePromise._reason());}else{ret._cancel();}}else{callbacks[i].call(ret,maybePromise,holder);}}if(!ret._isFateSealed()){if(holder.asyncNeeded){var domain=getDomain();if(domain!==null){holder.fn=util.domainBind(domain,holder.fn);}}ret._setAsyncGuaranteed();ret._setOnCancel(holder);}return ret;}}}var args=[].slice.call(arguments);;if(fn)args.pop();var ret=new PromiseArray(args).promise();return fn!==undefined?ret.spread(fn):ret;};};},{"./util":36}],18:[function(_dereq_,module,exports){"use strict";module.exports=function(Promise,PromiseArray,apiRejection,tryConvertToPromise,INTERNAL,debug){var getDomain=Promise._getDomain;var util=_dereq_("./util");var tryCatch=util.tryCatch;var errorObj=util.errorObj;var async=Promise._async;function MappingPromiseArray(promises,fn,limit,_filter){this.constructor$(promises);this._promise._captureStackTrace();var domain=getDomain();this._callback=domain===null?fn:util.domainBind(domain,fn);this._preservedValues=_filter===INTERNAL?new Array(this.length()):null;this._limit=limit;this._inFlight=0;this._queue=[];async.invoke(this._asyncInit,this,undefined);}util.inherits(MappingPromiseArray,PromiseArray);MappingPromiseArray.prototype._asyncInit=function(){this._init$(undefined,-2);};MappingPromiseArray.prototype._init=function(){};MappingPromiseArray.prototype._promiseFulfilled=function(value,index){var values=this._values;var length=this.length();var preservedValues=this._preservedValues;var limit=this._limit;if(index<0){index=index*-1-1;values[index]=value;if(limit>=1){this._inFlight--;this._drainQueue();if(this._isResolved())return true;}}else{if(limit>=1&&this._inFlight>=limit){values[index]=value;this._queue.push(index);return false;}if(preservedValues!==null)preservedValues[index]=value;var promise=this._promise;var callback=this._callback;var receiver=promise._boundValue();promise._pushContext();var ret=tryCatch(callback).call(receiver,value,index,length);var promiseCreated=promise._popContext();debug.checkForgottenReturns(ret,promiseCreated,preservedValues!==null?"Promise.filter":"Promise.map",promise);if(ret===errorObj){this._reject(ret.e);return true;}var maybePromise=tryConvertToPromise(ret,this._promise);if(maybePromise instanceof Promise){maybePromise=maybePromise._target();var bitField=maybePromise._bitField;;if((bitField&50397184)===0){if(limit>=1)this._inFlight++;values[index]=maybePromise;maybePromise._proxy(this,(index+1)*-1);return false;}else if((bitField&33554432)!==0){ret=maybePromise._value();}else if((bitField&16777216)!==0){this._reject(maybePromise._reason());return true;}else{this._cancel();return true;}}values[index]=ret;}var totalResolved=++this._totalResolved;if(totalResolved>=length){if(preservedValues!==null){this._filter(values,preservedValues);}else{this._resolve(values);}return true;}return false;};MappingPromiseArray.prototype._drainQueue=function(){var queue=this._queue;var limit=this._limit;var values=this._values;while(queue.length>0&&this._inFlight<limit){if(this._isResolved())return;var index=queue.pop();this._promiseFulfilled(values[index],index);}};MappingPromiseArray.prototype._filter=function(booleans,values){var len=values.length;var ret=new Array(len);var j=0;for(var i=0;i<len;++i){if(booleans[i])ret[j++]=values[i];}ret.length=j;this._resolve(ret);};MappingPromiseArray.prototype.preservedValues=function(){return this._preservedValues;};function map(promises,fn,options,_filter){if(typeof fn!=="function"){return apiRejection("expecting a function but got "+util.classString(fn));}var limit=0;if(options!==undefined){if((typeof options==="undefined"?"undefined":_typeof4(options))==="object"&&options!==null){if(typeof options.concurrency!=="number"){return Promise.reject(new TypeError("'concurrency' must be a number but it is "+util.classString(options.concurrency)));}limit=options.concurrency;}else{return Promise.reject(new TypeError("options argument must be an object but it is "+util.classString(options)));}}limit=typeof limit==="number"&&isFinite(limit)&&limit>=1?limit:0;return new MappingPromiseArray(promises,fn,limit,_filter).promise();}Promise.prototype.map=function(fn,options){return map(this,fn,options,null);};Promise.map=function(promises,fn,options,_filter){return map(promises,fn,options,_filter);};};},{"./util":36}],19:[function(_dereq_,module,exports){"use strict";module.exports=function(Promise,INTERNAL,tryConvertToPromise,apiRejection,debug){var util=_dereq_("./util");var tryCatch=util.tryCatch;Promise.method=function(fn){if(typeof fn!=="function"){throw new Promise.TypeError("expecting a function but got "+util.classString(fn));}return function(){var ret=new Promise(INTERNAL);ret._captureStackTrace();ret._pushContext();var value=tryCatch(fn).apply(this,arguments);var promiseCreated=ret._popContext();debug.checkForgottenReturns(value,promiseCreated,"Promise.method",ret);ret._resolveFromSyncValue(value);return ret;};};Promise.attempt=Promise["try"]=function(fn){if(typeof fn!=="function"){return apiRejection("expecting a function but got "+util.classString(fn));}var ret=new Promise(INTERNAL);ret._captureStackTrace();ret._pushContext();var value;if(arguments.length>1){debug.deprecated("calling Promise.try with more than 1 argument");var arg=arguments[1];var ctx=arguments[2];value=util.isArray(arg)?tryCatch(fn).apply(ctx,arg):tryCatch(fn).call(ctx,arg);}else{value=tryCatch(fn)();}var promiseCreated=ret._popContext();debug.checkForgottenReturns(value,promiseCreated,"Promise.try",ret);ret._resolveFromSyncValue(value);return ret;};Promise.prototype._resolveFromSyncValue=function(value){if(value===util.errorObj){this._rejectCallback(value.e,false);}else{this._resolveCallback(value,true);}};};},{"./util":36}],20:[function(_dereq_,module,exports){"use strict";var util=_dereq_("./util");var maybeWrapAsError=util.maybeWrapAsError;var errors=_dereq_("./errors");var OperationalError=errors.OperationalError;var es5=_dereq_("./es5");function isUntypedError(obj){return obj instanceof Error&&es5.getPrototypeOf(obj)===Error.prototype;}var rErrorKey=/^(?:name|message|stack|cause)$/;function wrapAsOperationalError(obj){var ret;if(isUntypedError(obj)){ret=new OperationalError(obj);ret.name=obj.name;ret.message=obj.message;ret.stack=obj.stack;var keys=es5.keys(obj);for(var i=0;i<keys.length;++i){var key=keys[i];if(!rErrorKey.test(key)){ret[key]=obj[key];}}return ret;}util.markAsOriginatingFromRejection(obj);return obj;}function nodebackForPromise(promise,multiArgs){return function(err,value){if(promise===null)return;if(err){var wrapped=wrapAsOperationalError(maybeWrapAsError(err));promise._attachExtraTrace(wrapped);promise._reject(wrapped);}else if(!multiArgs){promise._fulfill(value);}else{var args=[].slice.call(arguments,1);;promise._fulfill(args);}promise=null;};}module.exports=nodebackForPromise;},{"./errors":12,"./es5":13,"./util":36}],21:[function(_dereq_,module,exports){"use strict";module.exports=function(Promise){var util=_dereq_("./util");var async=Promise._async;var tryCatch=util.tryCatch;var errorObj=util.errorObj;function spreadAdapter(val,nodeback){var promise=this;if(!util.isArray(val))return successAdapter.call(promise,val,nodeback);var ret=tryCatch(nodeback).apply(promise._boundValue(),[null].concat(val));if(ret===errorObj){async.throwLater(ret.e);}}function successAdapter(val,nodeback){var promise=this;var receiver=promise._boundValue();var ret=val===undefined?tryCatch(nodeback).call(receiver,null):tryCatch(nodeback).call(receiver,null,val);if(ret===errorObj){async.throwLater(ret.e);}}function errorAdapter(reason,nodeback){var promise=this;if(!reason){var newReason=new Error(reason+"");newReason.cause=reason;reason=newReason;}var ret=tryCatch(nodeback).call(promise._boundValue(),reason);if(ret===errorObj){async.throwLater(ret.e);}}Promise.prototype.asCallback=Promise.prototype.nodeify=function(nodeback,options){if(typeof nodeback=="function"){var adapter=successAdapter;if(options!==undefined&&Object(options).spread){adapter=spreadAdapter;}this._then(adapter,errorAdapter,undefined,this,nodeback);}return this;};};},{"./util":36}],22:[function(_dereq_,module,exports){"use strict";module.exports=function(){var makeSelfResolutionError=function makeSelfResolutionError(){return new TypeError("circular promise resolution chain\n\n    See http://goo.gl/MqrFmX\n");};var reflectHandler=function reflectHandler(){return new Promise.PromiseInspection(this._target());};var apiRejection=function apiRejection(msg){return Promise.reject(new TypeError(msg));};function Proxyable(){}var UNDEFINED_BINDING={};var util=_dereq_("./util");var getDomain;if(util.isNode){getDomain=function getDomain(){var ret=process.domain;if(ret===undefined)ret=null;return ret;};}else{getDomain=function getDomain(){return null;};}util.notEnumerableProp(Promise,"_getDomain",getDomain);var es5=_dereq_("./es5");var Async=_dereq_("./async");var async=new Async();es5.defineProperty(Promise,"_async",{value:async});var errors=_dereq_("./errors");var TypeError=Promise.TypeError=errors.TypeError;Promise.RangeError=errors.RangeError;var CancellationError=Promise.CancellationError=errors.CancellationError;Promise.TimeoutError=errors.TimeoutError;Promise.OperationalError=errors.OperationalError;Promise.RejectionError=errors.OperationalError;Promise.AggregateError=errors.AggregateError;var INTERNAL=function INTERNAL(){};var APPLY={};var NEXT_FILTER={};var tryConvertToPromise=_dereq_("./thenables")(Promise,INTERNAL);var PromiseArray=_dereq_("./promise_array")(Promise,INTERNAL,tryConvertToPromise,apiRejection,Proxyable);var Context=_dereq_("./context")(Promise);/*jshint unused:false*/var createContext=Context.create;var debug=_dereq_("./debuggability")(Promise,Context);var CapturedTrace=debug.CapturedTrace;var PassThroughHandlerContext=_dereq_("./finally")(Promise,tryConvertToPromise);var catchFilter=_dereq_("./catch_filter")(NEXT_FILTER);var nodebackForPromise=_dereq_("./nodeback");var errorObj=util.errorObj;var tryCatch=util.tryCatch;function check(self,executor){if(typeof executor!=="function"){throw new TypeError("expecting a function but got "+util.classString(executor));}if(self.constructor!==Promise){throw new TypeError("the promise constructor cannot be invoked directly\n\n    See http://goo.gl/MqrFmX\n");}}function Promise(executor){this._bitField=0;this._fulfillmentHandler0=undefined;this._rejectionHandler0=undefined;this._promise0=undefined;this._receiver0=undefined;if(executor!==INTERNAL){check(this,executor);this._resolveFromExecutor(executor);}this._promiseCreated();this._fireEvent("promiseCreated",this);}Promise.prototype.toString=function(){return"[object Promise]";};Promise.prototype.caught=Promise.prototype["catch"]=function(fn){var len=arguments.length;if(len>1){var catchInstances=new Array(len-1),j=0,i;for(i=0;i<len-1;++i){var item=arguments[i];if(util.isObject(item)){catchInstances[j++]=item;}else{return apiRejection("expecting an object but got "+"A catch statement predicate "+util.classString(item));}}catchInstances.length=j;fn=arguments[i];return this.then(undefined,catchFilter(catchInstances,fn,this));}return this.then(undefined,fn);};Promise.prototype.reflect=function(){return this._then(reflectHandler,reflectHandler,undefined,this,undefined);};Promise.prototype.then=function(didFulfill,didReject){if(debug.warnings()&&arguments.length>0&&typeof didFulfill!=="function"&&typeof didReject!=="function"){var msg=".then() only accepts functions but was passed: "+util.classString(didFulfill);if(arguments.length>1){msg+=", "+util.classString(didReject);}this._warn(msg);}return this._then(didFulfill,didReject,undefined,undefined,undefined);};Promise.prototype.done=function(didFulfill,didReject){var promise=this._then(didFulfill,didReject,undefined,undefined,undefined);promise._setIsFinal();};Promise.prototype.spread=function(fn){if(typeof fn!=="function"){return apiRejection("expecting a function but got "+util.classString(fn));}return this.all()._then(fn,undefined,undefined,APPLY,undefined);};Promise.prototype.toJSON=function(){var ret={isFulfilled:false,isRejected:false,fulfillmentValue:undefined,rejectionReason:undefined};if(this.isFulfilled()){ret.fulfillmentValue=this.value();ret.isFulfilled=true;}else if(this.isRejected()){ret.rejectionReason=this.reason();ret.isRejected=true;}return ret;};Promise.prototype.all=function(){if(arguments.length>0){this._warn(".all() was passed arguments but it does not take any");}return new PromiseArray(this).promise();};Promise.prototype.error=function(fn){return this.caught(util.originatesFromRejection,fn);};Promise.getNewLibraryCopy=module.exports;Promise.is=function(val){return val instanceof Promise;};Promise.fromNode=Promise.fromCallback=function(fn){var ret=new Promise(INTERNAL);ret._captureStackTrace();var multiArgs=arguments.length>1?!!Object(arguments[1]).multiArgs:false;var result=tryCatch(fn)(nodebackForPromise(ret,multiArgs));if(result===errorObj){ret._rejectCallback(result.e,true);}if(!ret._isFateSealed())ret._setAsyncGuaranteed();return ret;};Promise.all=function(promises){return new PromiseArray(promises).promise();};Promise.cast=function(obj){var ret=tryConvertToPromise(obj);if(!(ret instanceof Promise)){ret=new Promise(INTERNAL);ret._captureStackTrace();ret._setFulfilled();ret._rejectionHandler0=obj;}return ret;};Promise.resolve=Promise.fulfilled=Promise.cast;Promise.reject=Promise.rejected=function(reason){var ret=new Promise(INTERNAL);ret._captureStackTrace();ret._rejectCallback(reason,true);return ret;};Promise.setScheduler=function(fn){if(typeof fn!=="function"){throw new TypeError("expecting a function but got "+util.classString(fn));}return async.setScheduler(fn);};Promise.prototype._then=function(didFulfill,didReject,_,receiver,internalData){var haveInternalData=internalData!==undefined;var promise=haveInternalData?internalData:new Promise(INTERNAL);var target=this._target();var bitField=target._bitField;if(!haveInternalData){promise._propagateFrom(this,3);promise._captureStackTrace();if(receiver===undefined&&(this._bitField&2097152)!==0){if(!((bitField&50397184)===0)){receiver=this._boundValue();}else{receiver=target===this?undefined:this._boundTo;}}this._fireEvent("promiseChained",this,promise);}var domain=getDomain();if(!((bitField&50397184)===0)){var handler,value,settler=target._settlePromiseCtx;if((bitField&33554432)!==0){value=target._rejectionHandler0;handler=didFulfill;}else if((bitField&16777216)!==0){value=target._fulfillmentHandler0;handler=didReject;target._unsetRejectionIsUnhandled();}else{settler=target._settlePromiseLateCancellationObserver;value=new CancellationError("late cancellation observer");target._attachExtraTrace(value);handler=didReject;}async.invoke(settler,target,{handler:domain===null?handler:typeof handler==="function"&&util.domainBind(domain,handler),promise:promise,receiver:receiver,value:value});}else{target._addCallbacks(didFulfill,didReject,promise,receiver,domain);}return promise;};Promise.prototype._length=function(){return this._bitField&65535;};Promise.prototype._isFateSealed=function(){return(this._bitField&117506048)!==0;};Promise.prototype._isFollowing=function(){return(this._bitField&67108864)===67108864;};Promise.prototype._setLength=function(len){this._bitField=this._bitField&-65536|len&65535;};Promise.prototype._setFulfilled=function(){this._bitField=this._bitField|33554432;this._fireEvent("promiseFulfilled",this);};Promise.prototype._setRejected=function(){this._bitField=this._bitField|16777216;this._fireEvent("promiseRejected",this);};Promise.prototype._setFollowing=function(){this._bitField=this._bitField|67108864;this._fireEvent("promiseResolved",this);};Promise.prototype._setIsFinal=function(){this._bitField=this._bitField|4194304;};Promise.prototype._isFinal=function(){return(this._bitField&4194304)>0;};Promise.prototype._unsetCancelled=function(){this._bitField=this._bitField&~65536;};Promise.prototype._setCancelled=function(){this._bitField=this._bitField|65536;this._fireEvent("promiseCancelled",this);};Promise.prototype._setWillBeCancelled=function(){this._bitField=this._bitField|8388608;};Promise.prototype._setAsyncGuaranteed=function(){if(async.hasCustomScheduler())return;this._bitField=this._bitField|134217728;};Promise.prototype._receiverAt=function(index){var ret=index===0?this._receiver0:this[index*4-4+3];if(ret===UNDEFINED_BINDING){return undefined;}else if(ret===undefined&&this._isBound()){return this._boundValue();}return ret;};Promise.prototype._promiseAt=function(index){return this[index*4-4+2];};Promise.prototype._fulfillmentHandlerAt=function(index){return this[index*4-4+0];};Promise.prototype._rejectionHandlerAt=function(index){return this[index*4-4+1];};Promise.prototype._boundValue=function(){};Promise.prototype._migrateCallback0=function(follower){var bitField=follower._bitField;var fulfill=follower._fulfillmentHandler0;var reject=follower._rejectionHandler0;var promise=follower._promise0;var receiver=follower._receiverAt(0);if(receiver===undefined)receiver=UNDEFINED_BINDING;this._addCallbacks(fulfill,reject,promise,receiver,null);};Promise.prototype._migrateCallbackAt=function(follower,index){var fulfill=follower._fulfillmentHandlerAt(index);var reject=follower._rejectionHandlerAt(index);var promise=follower._promiseAt(index);var receiver=follower._receiverAt(index);if(receiver===undefined)receiver=UNDEFINED_BINDING;this._addCallbacks(fulfill,reject,promise,receiver,null);};Promise.prototype._addCallbacks=function(fulfill,reject,promise,receiver,domain){var index=this._length();if(index>=65535-4){index=0;this._setLength(0);}if(index===0){this._promise0=promise;this._receiver0=receiver;if(typeof fulfill==="function"){this._fulfillmentHandler0=domain===null?fulfill:util.domainBind(domain,fulfill);}if(typeof reject==="function"){this._rejectionHandler0=domain===null?reject:util.domainBind(domain,reject);}}else{var base=index*4-4;this[base+2]=promise;this[base+3]=receiver;if(typeof fulfill==="function"){this[base+0]=domain===null?fulfill:util.domainBind(domain,fulfill);}if(typeof reject==="function"){this[base+1]=domain===null?reject:util.domainBind(domain,reject);}}this._setLength(index+1);return index;};Promise.prototype._proxy=function(proxyable,arg){this._addCallbacks(undefined,undefined,arg,proxyable,null);};Promise.prototype._resolveCallback=function(value,shouldBind){if((this._bitField&117506048)!==0)return;if(value===this)return this._rejectCallback(makeSelfResolutionError(),false);var maybePromise=tryConvertToPromise(value,this);if(!(maybePromise instanceof Promise))return this._fulfill(value);if(shouldBind)this._propagateFrom(maybePromise,2);var promise=maybePromise._target();if(promise===this){this._reject(makeSelfResolutionError());return;}var bitField=promise._bitField;if((bitField&50397184)===0){var len=this._length();if(len>0)promise._migrateCallback0(this);for(var i=1;i<len;++i){promise._migrateCallbackAt(this,i);}this._setFollowing();this._setLength(0);this._setFollowee(promise);}else if((bitField&33554432)!==0){this._fulfill(promise._value());}else if((bitField&16777216)!==0){this._reject(promise._reason());}else{var reason=new CancellationError("late cancellation observer");promise._attachExtraTrace(reason);this._reject(reason);}};Promise.prototype._rejectCallback=function(reason,synchronous,ignoreNonErrorWarnings){var trace=util.ensureErrorObject(reason);var hasStack=trace===reason;if(!hasStack&&!ignoreNonErrorWarnings&&debug.warnings()){var message="a promise was rejected with a non-error: "+util.classString(reason);this._warn(message,true);}this._attachExtraTrace(trace,synchronous?hasStack:false);this._reject(reason);};Promise.prototype._resolveFromExecutor=function(executor){var promise=this;this._captureStackTrace();this._pushContext();var synchronous=true;var r=this._execute(executor,function(value){promise._resolveCallback(value);},function(reason){promise._rejectCallback(reason,synchronous);});synchronous=false;this._popContext();if(r!==undefined){promise._rejectCallback(r,true);}};Promise.prototype._settlePromiseFromHandler=function(handler,receiver,value,promise){var bitField=promise._bitField;if((bitField&65536)!==0)return;promise._pushContext();var x;if(receiver===APPLY){if(!value||typeof value.length!=="number"){x=errorObj;x.e=new TypeError("cannot .spread() a non-array: "+util.classString(value));}else{x=tryCatch(handler).apply(this._boundValue(),value);}}else{x=tryCatch(handler).call(receiver,value);}var promiseCreated=promise._popContext();bitField=promise._bitField;if((bitField&65536)!==0)return;if(x===NEXT_FILTER){promise._reject(value);}else if(x===errorObj){promise._rejectCallback(x.e,false);}else{debug.checkForgottenReturns(x,promiseCreated,"",promise,this);promise._resolveCallback(x);}};Promise.prototype._target=function(){var ret=this;while(ret._isFollowing()){ret=ret._followee();}return ret;};Promise.prototype._followee=function(){return this._rejectionHandler0;};Promise.prototype._setFollowee=function(promise){this._rejectionHandler0=promise;};Promise.prototype._settlePromise=function(promise,handler,receiver,value){var isPromise=promise instanceof Promise;var bitField=this._bitField;var asyncGuaranteed=(bitField&134217728)!==0;if((bitField&65536)!==0){if(isPromise)promise._invokeInternalOnCancel();if(receiver instanceof PassThroughHandlerContext&&receiver.isFinallyHandler()){receiver.cancelPromise=promise;if(tryCatch(handler).call(receiver,value)===errorObj){promise._reject(errorObj.e);}}else if(handler===reflectHandler){promise._fulfill(reflectHandler.call(receiver));}else if(receiver instanceof Proxyable){receiver._promiseCancelled(promise);}else if(isPromise||promise instanceof PromiseArray){promise._cancel();}else{receiver.cancel();}}else if(typeof handler==="function"){if(!isPromise){handler.call(receiver,value,promise);}else{if(asyncGuaranteed)promise._setAsyncGuaranteed();this._settlePromiseFromHandler(handler,receiver,value,promise);}}else if(receiver instanceof Proxyable){if(!receiver._isResolved()){if((bitField&33554432)!==0){receiver._promiseFulfilled(value,promise);}else{receiver._promiseRejected(value,promise);}}}else if(isPromise){if(asyncGuaranteed)promise._setAsyncGuaranteed();if((bitField&33554432)!==0){promise._fulfill(value);}else{promise._reject(value);}}};Promise.prototype._settlePromiseLateCancellationObserver=function(ctx){var handler=ctx.handler;var promise=ctx.promise;var receiver=ctx.receiver;var value=ctx.value;if(typeof handler==="function"){if(!(promise instanceof Promise)){handler.call(receiver,value,promise);}else{this._settlePromiseFromHandler(handler,receiver,value,promise);}}else if(promise instanceof Promise){promise._reject(value);}};Promise.prototype._settlePromiseCtx=function(ctx){this._settlePromise(ctx.promise,ctx.handler,ctx.receiver,ctx.value);};Promise.prototype._settlePromise0=function(handler,value,bitField){var promise=this._promise0;var receiver=this._receiverAt(0);this._promise0=undefined;this._receiver0=undefined;this._settlePromise(promise,handler,receiver,value);};Promise.prototype._clearCallbackDataAtIndex=function(index){var base=index*4-4;this[base+2]=this[base+3]=this[base+0]=this[base+1]=undefined;};Promise.prototype._fulfill=function(value){var bitField=this._bitField;if((bitField&117506048)>>>16)return;if(value===this){var err=makeSelfResolutionError();this._attachExtraTrace(err);return this._reject(err);}this._setFulfilled();this._rejectionHandler0=value;if((bitField&65535)>0){if((bitField&134217728)!==0){this._settlePromises();}else{async.settlePromises(this);}}};Promise.prototype._reject=function(reason){var bitField=this._bitField;if((bitField&117506048)>>>16)return;this._setRejected();this._fulfillmentHandler0=reason;if(this._isFinal()){return async.fatalError(reason,util.isNode);}if((bitField&65535)>0){async.settlePromises(this);}else{this._ensurePossibleRejectionHandled();}};Promise.prototype._fulfillPromises=function(len,value){for(var i=1;i<len;i++){var handler=this._fulfillmentHandlerAt(i);var promise=this._promiseAt(i);var receiver=this._receiverAt(i);this._clearCallbackDataAtIndex(i);this._settlePromise(promise,handler,receiver,value);}};Promise.prototype._rejectPromises=function(len,reason){for(var i=1;i<len;i++){var handler=this._rejectionHandlerAt(i);var promise=this._promiseAt(i);var receiver=this._receiverAt(i);this._clearCallbackDataAtIndex(i);this._settlePromise(promise,handler,receiver,reason);}};Promise.prototype._settlePromises=function(){var bitField=this._bitField;var len=bitField&65535;if(len>0){if((bitField&16842752)!==0){var reason=this._fulfillmentHandler0;this._settlePromise0(this._rejectionHandler0,reason,bitField);this._rejectPromises(len,reason);}else{var value=this._rejectionHandler0;this._settlePromise0(this._fulfillmentHandler0,value,bitField);this._fulfillPromises(len,value);}this._setLength(0);}this._clearCancellationData();};Promise.prototype._settledValue=function(){var bitField=this._bitField;if((bitField&33554432)!==0){return this._rejectionHandler0;}else if((bitField&16777216)!==0){return this._fulfillmentHandler0;}};function deferResolve(v){this.promise._resolveCallback(v);}function deferReject(v){this.promise._rejectCallback(v,false);}Promise.defer=Promise.pending=function(){debug.deprecated("Promise.defer","new Promise");var promise=new Promise(INTERNAL);return{promise:promise,resolve:deferResolve,reject:deferReject};};util.notEnumerableProp(Promise,"_makeSelfResolutionError",makeSelfResolutionError);_dereq_("./method")(Promise,INTERNAL,tryConvertToPromise,apiRejection,debug);_dereq_("./bind")(Promise,INTERNAL,tryConvertToPromise,debug);_dereq_("./cancel")(Promise,PromiseArray,apiRejection,debug);_dereq_("./direct_resolve")(Promise);_dereq_("./synchronous_inspection")(Promise);_dereq_("./join")(Promise,PromiseArray,tryConvertToPromise,INTERNAL,async,getDomain);Promise.Promise=Promise;Promise.version="3.4.7";_dereq_('./map.js')(Promise,PromiseArray,apiRejection,tryConvertToPromise,INTERNAL,debug);_dereq_('./call_get.js')(Promise);_dereq_('./using.js')(Promise,apiRejection,tryConvertToPromise,createContext,INTERNAL,debug);_dereq_('./timers.js')(Promise,INTERNAL,debug);_dereq_('./generators.js')(Promise,apiRejection,INTERNAL,tryConvertToPromise,Proxyable,debug);_dereq_('./nodeify.js')(Promise);_dereq_('./promisify.js')(Promise,INTERNAL);_dereq_('./props.js')(Promise,PromiseArray,tryConvertToPromise,apiRejection);_dereq_('./race.js')(Promise,INTERNAL,tryConvertToPromise,apiRejection);_dereq_('./reduce.js')(Promise,PromiseArray,apiRejection,tryConvertToPromise,INTERNAL,debug);_dereq_('./settle.js')(Promise,PromiseArray,debug);_dereq_('./some.js')(Promise,PromiseArray,apiRejection);_dereq_('./filter.js')(Promise,INTERNAL);_dereq_('./each.js')(Promise,INTERNAL);_dereq_('./any.js')(Promise);util.toFastProperties(Promise);util.toFastProperties(Promise.prototype);function fillTypes(value){var p=new Promise(INTERNAL);p._fulfillmentHandler0=value;p._rejectionHandler0=value;p._promise0=value;p._receiver0=value;}// Complete slack tracking, opt out of field-type tracking and           
// stabilize map                                                         
fillTypes({a:1});fillTypes({b:2});fillTypes({c:3});fillTypes(1);fillTypes(function(){});fillTypes(undefined);fillTypes(false);fillTypes(new Promise(INTERNAL));debug.setBounds(Async.firstLineError,util.lastLineError);return Promise;};},{"./any.js":1,"./async":2,"./bind":3,"./call_get.js":5,"./cancel":6,"./catch_filter":7,"./context":8,"./debuggability":9,"./direct_resolve":10,"./each.js":11,"./errors":12,"./es5":13,"./filter.js":14,"./finally":15,"./generators.js":16,"./join":17,"./map.js":18,"./method":19,"./nodeback":20,"./nodeify.js":21,"./promise_array":23,"./promisify.js":24,"./props.js":25,"./race.js":27,"./reduce.js":28,"./settle.js":30,"./some.js":31,"./synchronous_inspection":32,"./thenables":33,"./timers.js":34,"./using.js":35,"./util":36}],23:[function(_dereq_,module,exports){"use strict";module.exports=function(Promise,INTERNAL,tryConvertToPromise,apiRejection,Proxyable){var util=_dereq_("./util");var isArray=util.isArray;function toResolutionValue(val){switch(val){case-2:return[];case-3:return{};}}function PromiseArray(values){var promise=this._promise=new Promise(INTERNAL);if(values instanceof Promise){promise._propagateFrom(values,3);}promise._setOnCancel(this);this._values=values;this._length=0;this._totalResolved=0;this._init(undefined,-2);}util.inherits(PromiseArray,Proxyable);PromiseArray.prototype.length=function(){return this._length;};PromiseArray.prototype.promise=function(){return this._promise;};PromiseArray.prototype._init=function init(_,resolveValueIfEmpty){var values=tryConvertToPromise(this._values,this._promise);if(values instanceof Promise){values=values._target();var bitField=values._bitField;;this._values=values;if((bitField&50397184)===0){this._promise._setAsyncGuaranteed();return values._then(init,this._reject,undefined,this,resolveValueIfEmpty);}else if((bitField&33554432)!==0){values=values._value();}else if((bitField&16777216)!==0){return this._reject(values._reason());}else{return this._cancel();}}values=util.asArray(values);if(values===null){var err=apiRejection("expecting an array or an iterable object but got "+util.classString(values)).reason();this._promise._rejectCallback(err,false);return;}if(values.length===0){if(resolveValueIfEmpty===-5){this._resolveEmptyArray();}else{this._resolve(toResolutionValue(resolveValueIfEmpty));}return;}this._iterate(values);};PromiseArray.prototype._iterate=function(values){var len=this.getActualLength(values.length);this._length=len;this._values=this.shouldCopyValues()?new Array(len):this._values;var result=this._promise;var isResolved=false;var bitField=null;for(var i=0;i<len;++i){var maybePromise=tryConvertToPromise(values[i],result);if(maybePromise instanceof Promise){maybePromise=maybePromise._target();bitField=maybePromise._bitField;}else{bitField=null;}if(isResolved){if(bitField!==null){maybePromise.suppressUnhandledRejections();}}else if(bitField!==null){if((bitField&50397184)===0){maybePromise._proxy(this,i);this._values[i]=maybePromise;}else if((bitField&33554432)!==0){isResolved=this._promiseFulfilled(maybePromise._value(),i);}else if((bitField&16777216)!==0){isResolved=this._promiseRejected(maybePromise._reason(),i);}else{isResolved=this._promiseCancelled(i);}}else{isResolved=this._promiseFulfilled(maybePromise,i);}}if(!isResolved)result._setAsyncGuaranteed();};PromiseArray.prototype._isResolved=function(){return this._values===null;};PromiseArray.prototype._resolve=function(value){this._values=null;this._promise._fulfill(value);};PromiseArray.prototype._cancel=function(){if(this._isResolved()||!this._promise._isCancellable())return;this._values=null;this._promise._cancel();};PromiseArray.prototype._reject=function(reason){this._values=null;this._promise._rejectCallback(reason,false);};PromiseArray.prototype._promiseFulfilled=function(value,index){this._values[index]=value;var totalResolved=++this._totalResolved;if(totalResolved>=this._length){this._resolve(this._values);return true;}return false;};PromiseArray.prototype._promiseCancelled=function(){this._cancel();return true;};PromiseArray.prototype._promiseRejected=function(reason){this._totalResolved++;this._reject(reason);return true;};PromiseArray.prototype._resultCancelled=function(){if(this._isResolved())return;var values=this._values;this._cancel();if(values instanceof Promise){values.cancel();}else{for(var i=0;i<values.length;++i){if(values[i]instanceof Promise){values[i].cancel();}}}};PromiseArray.prototype.shouldCopyValues=function(){return true;};PromiseArray.prototype.getActualLength=function(len){return len;};return PromiseArray;};},{"./util":36}],24:[function(_dereq_,module,exports){"use strict";module.exports=function(Promise,INTERNAL){var THIS={};var util=_dereq_("./util");var nodebackForPromise=_dereq_("./nodeback");var withAppended=util.withAppended;var maybeWrapAsError=util.maybeWrapAsError;var canEvaluate=util.canEvaluate;var TypeError=_dereq_("./errors").TypeError;var defaultSuffix="Async";var defaultPromisified={__isPromisified__:true};var noCopyProps=["arity","length","name","arguments","caller","callee","prototype","__isPromisified__"];var noCopyPropsPattern=new RegExp("^(?:"+noCopyProps.join("|")+")$");var defaultFilter=function defaultFilter(name){return util.isIdentifier(name)&&name.charAt(0)!=="_"&&name!=="constructor";};function propsFilter(key){return!noCopyPropsPattern.test(key);}function isPromisified(fn){try{return fn.__isPromisified__===true;}catch(e){return false;}}function hasPromisified(obj,key,suffix){var val=util.getDataPropertyOrDefault(obj,key+suffix,defaultPromisified);return val?isPromisified(val):false;}function checkValid(ret,suffix,suffixRegexp){for(var i=0;i<ret.length;i+=2){var key=ret[i];if(suffixRegexp.test(key)){var keyWithoutAsyncSuffix=key.replace(suffixRegexp,"");for(var j=0;j<ret.length;j+=2){if(ret[j]===keyWithoutAsyncSuffix){throw new TypeError("Cannot promisify an API that has normal methods with '%s'-suffix\n\n    See http://goo.gl/MqrFmX\n".replace("%s",suffix));}}}}}function promisifiableMethods(obj,suffix,suffixRegexp,filter){var keys=util.inheritedDataKeys(obj);var ret=[];for(var i=0;i<keys.length;++i){var key=keys[i];var value=obj[key];var passesDefaultFilter=filter===defaultFilter?true:defaultFilter(key,value,obj);if(typeof value==="function"&&!isPromisified(value)&&!hasPromisified(obj,key,suffix)&&filter(key,value,obj,passesDefaultFilter)){ret.push(key,value);}}checkValid(ret,suffix,suffixRegexp);return ret;}var escapeIdentRegex=function escapeIdentRegex(str){return str.replace(/([$])/,"\\$");};var makeNodePromisifiedEval;if(false){var switchCaseArgumentOrder=function switchCaseArgumentOrder(likelyArgumentCount){var ret=[likelyArgumentCount];var min=Math.max(0,likelyArgumentCount-1-3);for(var i=likelyArgumentCount-1;i>=min;--i){ret.push(i);}for(var i=likelyArgumentCount+1;i<=3;++i){ret.push(i);}return ret;};var argumentSequence=function argumentSequence(argumentCount){return util.filledRange(argumentCount,"_arg","");};var parameterDeclaration=function parameterDeclaration(parameterCount){return util.filledRange(Math.max(parameterCount,3),"_arg","");};var parameterCount=function parameterCount(fn){if(typeof fn.length==="number"){return Math.max(Math.min(fn.length,1023+1),0);}return 0;};makeNodePromisifiedEval=function makeNodePromisifiedEval(callback,receiver,originalName,fn,_,multiArgs){var newParameterCount=Math.max(0,parameterCount(fn)-1);var argumentOrder=switchCaseArgumentOrder(newParameterCount);var shouldProxyThis=typeof callback==="string"||receiver===THIS;function generateCallForArgumentCount(count){var args=argumentSequence(count).join(", ");var comma=count>0?", ":"";var ret;if(shouldProxyThis){ret="ret = callback.call(this, {{args}}, nodeback); break;\n";}else{ret=receiver===undefined?"ret = callback({{args}}, nodeback); break;\n":"ret = callback.call(receiver, {{args}}, nodeback); break;\n";}return ret.replace("{{args}}",args).replace(", ",comma);}function generateArgumentSwitchCase(){var ret="";for(var i=0;i<argumentOrder.length;++i){ret+="case "+argumentOrder[i]+":"+generateCallForArgumentCount(argumentOrder[i]);}ret+="                                                             \n\
        default:                                                             \n\
            var args = new Array(len + 1);                                   \n\
            var i = 0;                                                       \n\
            for (var i = 0; i < len; ++i) {                                  \n\
               args[i] = arguments[i];                                       \n\
            }                                                                \n\
            args[i] = nodeback;                                              \n\
            [CodeForCall]                                                    \n\
            break;                                                           \n\
        ".replace("[CodeForCall]",shouldProxyThis?"ret = callback.apply(this, args);\n":"ret = callback.apply(receiver, args);\n");return ret;}var getFunctionCode=typeof callback==="string"?"this != null ? this['"+callback+"'] : fn":"fn";var body="'use strict';                                                \n\
        var ret = function (Parameters) {                                    \n\
            'use strict';                                                    \n\
            var len = arguments.length;                                      \n\
            var promise = new Promise(INTERNAL);                             \n\
            promise._captureStackTrace();                                    \n\
            var nodeback = nodebackForPromise(promise, "+multiArgs+");   \n\
            var ret;                                                         \n\
            var callback = tryCatch([GetFunctionCode]);                      \n\
            switch(len) {                                                    \n\
                [CodeForSwitchCase]                                          \n\
            }                                                                \n\
            if (ret === errorObj) {                                          \n\
                promise._rejectCallback(maybeWrapAsError(ret.e), true, true);\n\
            }                                                                \n\
            if (!promise._isFateSealed()) promise._setAsyncGuaranteed();     \n\
            return promise;                                                  \n\
        };                                                                   \n\
        notEnumerableProp(ret, '__isPromisified__', true);                   \n\
        return ret;                                                          \n\
    ".replace("[CodeForSwitchCase]",generateArgumentSwitchCase()).replace("[GetFunctionCode]",getFunctionCode);body=body.replace("Parameters",parameterDeclaration(newParameterCount));return new Function("Promise","fn","receiver","withAppended","maybeWrapAsError","nodebackForPromise","tryCatch","errorObj","notEnumerableProp","INTERNAL",body)(Promise,fn,receiver,withAppended,maybeWrapAsError,nodebackForPromise,util.tryCatch,util.errorObj,util.notEnumerableProp,INTERNAL);};}function makeNodePromisifiedClosure(callback,receiver,_,fn,__,multiArgs){var defaultThis=function(){return this;}();var method=callback;if(typeof method==="string"){callback=fn;}function promisified(){var _receiver=receiver;if(receiver===THIS)_receiver=this;var promise=new Promise(INTERNAL);promise._captureStackTrace();var cb=typeof method==="string"&&this!==defaultThis?this[method]:callback;var fn=nodebackForPromise(promise,multiArgs);try{cb.apply(_receiver,withAppended(arguments,fn));}catch(e){promise._rejectCallback(maybeWrapAsError(e),true,true);}if(!promise._isFateSealed())promise._setAsyncGuaranteed();return promise;}util.notEnumerableProp(promisified,"__isPromisified__",true);return promisified;}var makeNodePromisified=canEvaluate?makeNodePromisifiedEval:makeNodePromisifiedClosure;function promisifyAll(obj,suffix,filter,promisifier,multiArgs){var suffixRegexp=new RegExp(escapeIdentRegex(suffix)+"$");var methods=promisifiableMethods(obj,suffix,suffixRegexp,filter);for(var i=0,len=methods.length;i<len;i+=2){var key=methods[i];var fn=methods[i+1];var promisifiedKey=key+suffix;if(promisifier===makeNodePromisified){obj[promisifiedKey]=makeNodePromisified(key,THIS,key,fn,suffix,multiArgs);}else{var promisified=promisifier(fn,function(){return makeNodePromisified(key,THIS,key,fn,suffix,multiArgs);});util.notEnumerableProp(promisified,"__isPromisified__",true);obj[promisifiedKey]=promisified;}}util.toFastProperties(obj);return obj;}function promisify(callback,receiver,multiArgs){return makeNodePromisified(callback,receiver,undefined,callback,null,multiArgs);}Promise.promisify=function(fn,options){if(typeof fn!=="function"){throw new TypeError("expecting a function but got "+util.classString(fn));}if(isPromisified(fn)){return fn;}options=Object(options);var receiver=options.context===undefined?THIS:options.context;var multiArgs=!!options.multiArgs;var ret=promisify(fn,receiver,multiArgs);util.copyDescriptors(fn,ret,propsFilter);return ret;};Promise.promisifyAll=function(target,options){if(typeof target!=="function"&&(typeof target==="undefined"?"undefined":_typeof4(target))!=="object"){throw new TypeError("the target of promisifyAll must be an object or a function\n\n    See http://goo.gl/MqrFmX\n");}options=Object(options);var multiArgs=!!options.multiArgs;var suffix=options.suffix;if(typeof suffix!=="string")suffix=defaultSuffix;var filter=options.filter;if(typeof filter!=="function")filter=defaultFilter;var promisifier=options.promisifier;if(typeof promisifier!=="function")promisifier=makeNodePromisified;if(!util.isIdentifier(suffix)){throw new RangeError("suffix must be a valid identifier\n\n    See http://goo.gl/MqrFmX\n");}var keys=util.inheritedDataKeys(target);for(var i=0;i<keys.length;++i){var value=target[keys[i]];if(keys[i]!=="constructor"&&util.isClass(value)){promisifyAll(value.prototype,suffix,filter,promisifier,multiArgs);promisifyAll(value,suffix,filter,promisifier,multiArgs);}}return promisifyAll(target,suffix,filter,promisifier,multiArgs);};};},{"./errors":12,"./nodeback":20,"./util":36}],25:[function(_dereq_,module,exports){"use strict";module.exports=function(Promise,PromiseArray,tryConvertToPromise,apiRejection){var util=_dereq_("./util");var isObject=util.isObject;var es5=_dereq_("./es5");var Es6Map;if(typeof Map==="function")Es6Map=Map;var mapToEntries=function(){var index=0;var size=0;function extractEntry(value,key){this[index]=value;this[index+size]=key;index++;}return function mapToEntries(map){size=map.size;index=0;var ret=new Array(map.size*2);map.forEach(extractEntry,ret);return ret;};}();var entriesToMap=function entriesToMap(entries){var ret=new Es6Map();var length=entries.length/2|0;for(var i=0;i<length;++i){var key=entries[length+i];var value=entries[i];ret.set(key,value);}return ret;};function PropertiesPromiseArray(obj){var isMap=false;var entries;if(Es6Map!==undefined&&obj instanceof Es6Map){entries=mapToEntries(obj);isMap=true;}else{var keys=es5.keys(obj);var len=keys.length;entries=new Array(len*2);for(var i=0;i<len;++i){var key=keys[i];entries[i]=obj[key];entries[i+len]=key;}}this.constructor$(entries);this._isMap=isMap;this._init$(undefined,-3);}util.inherits(PropertiesPromiseArray,PromiseArray);PropertiesPromiseArray.prototype._init=function(){};PropertiesPromiseArray.prototype._promiseFulfilled=function(value,index){this._values[index]=value;var totalResolved=++this._totalResolved;if(totalResolved>=this._length){var val;if(this._isMap){val=entriesToMap(this._values);}else{val={};var keyOffset=this.length();for(var i=0,len=this.length();i<len;++i){val[this._values[i+keyOffset]]=this._values[i];}}this._resolve(val);return true;}return false;};PropertiesPromiseArray.prototype.shouldCopyValues=function(){return false;};PropertiesPromiseArray.prototype.getActualLength=function(len){return len>>1;};function props(promises){var ret;var castValue=tryConvertToPromise(promises);if(!isObject(castValue)){return apiRejection("cannot await properties of a non-object\n\n    See http://goo.gl/MqrFmX\n");}else if(castValue instanceof Promise){ret=castValue._then(Promise.props,undefined,undefined,undefined,undefined);}else{ret=new PropertiesPromiseArray(castValue).promise();}if(castValue instanceof Promise){ret._propagateFrom(castValue,2);}return ret;}Promise.prototype.props=function(){return props(this);};Promise.props=function(promises){return props(promises);};};},{"./es5":13,"./util":36}],26:[function(_dereq_,module,exports){"use strict";function arrayMove(src,srcIndex,dst,dstIndex,len){for(var j=0;j<len;++j){dst[j+dstIndex]=src[j+srcIndex];src[j+srcIndex]=void 0;}}function Queue(capacity){this._capacity=capacity;this._length=0;this._front=0;}Queue.prototype._willBeOverCapacity=function(size){return this._capacity<size;};Queue.prototype._pushOne=function(arg){var length=this.length();this._checkCapacity(length+1);var i=this._front+length&this._capacity-1;this[i]=arg;this._length=length+1;};Queue.prototype.push=function(fn,receiver,arg){var length=this.length()+3;if(this._willBeOverCapacity(length)){this._pushOne(fn);this._pushOne(receiver);this._pushOne(arg);return;}var j=this._front+length-3;this._checkCapacity(length);var wrapMask=this._capacity-1;this[j+0&wrapMask]=fn;this[j+1&wrapMask]=receiver;this[j+2&wrapMask]=arg;this._length=length;};Queue.prototype.shift=function(){var front=this._front,ret=this[front];this[front]=undefined;this._front=front+1&this._capacity-1;this._length--;return ret;};Queue.prototype.length=function(){return this._length;};Queue.prototype._checkCapacity=function(size){if(this._capacity<size){this._resizeTo(this._capacity<<1);}};Queue.prototype._resizeTo=function(capacity){var oldCapacity=this._capacity;this._capacity=capacity;var front=this._front;var length=this._length;var moveItemsCount=front+length&oldCapacity-1;arrayMove(this,0,this,oldCapacity,moveItemsCount);};module.exports=Queue;},{}],27:[function(_dereq_,module,exports){"use strict";module.exports=function(Promise,INTERNAL,tryConvertToPromise,apiRejection){var util=_dereq_("./util");var raceLater=function raceLater(promise){return promise.then(function(array){return race(array,promise);});};function race(promises,parent){var maybePromise=tryConvertToPromise(promises);if(maybePromise instanceof Promise){return raceLater(maybePromise);}else{promises=util.asArray(promises);if(promises===null)return apiRejection("expecting an array or an iterable object but got "+util.classString(promises));}var ret=new Promise(INTERNAL);if(parent!==undefined){ret._propagateFrom(parent,3);}var fulfill=ret._fulfill;var reject=ret._reject;for(var i=0,len=promises.length;i<len;++i){var val=promises[i];if(val===undefined&&!(i in promises)){continue;}Promise.cast(val)._then(fulfill,reject,undefined,ret,null);}return ret;}Promise.race=function(promises){return race(promises,undefined);};Promise.prototype.race=function(){return race(this,undefined);};};},{"./util":36}],28:[function(_dereq_,module,exports){"use strict";module.exports=function(Promise,PromiseArray,apiRejection,tryConvertToPromise,INTERNAL,debug){var getDomain=Promise._getDomain;var util=_dereq_("./util");var tryCatch=util.tryCatch;function ReductionPromiseArray(promises,fn,initialValue,_each){this.constructor$(promises);var domain=getDomain();this._fn=domain===null?fn:util.domainBind(domain,fn);if(initialValue!==undefined){initialValue=Promise.resolve(initialValue);initialValue._attachCancellationCallback(this);}this._initialValue=initialValue;this._currentCancellable=null;if(_each===INTERNAL){this._eachValues=Array(this._length);}else if(_each===0){this._eachValues=null;}else{this._eachValues=undefined;}this._promise._captureStackTrace();this._init$(undefined,-5);}util.inherits(ReductionPromiseArray,PromiseArray);ReductionPromiseArray.prototype._gotAccum=function(accum){if(this._eachValues!==undefined&&this._eachValues!==null&&accum!==INTERNAL){this._eachValues.push(accum);}};ReductionPromiseArray.prototype._eachComplete=function(value){if(this._eachValues!==null){this._eachValues.push(value);}return this._eachValues;};ReductionPromiseArray.prototype._init=function(){};ReductionPromiseArray.prototype._resolveEmptyArray=function(){this._resolve(this._eachValues!==undefined?this._eachValues:this._initialValue);};ReductionPromiseArray.prototype.shouldCopyValues=function(){return false;};ReductionPromiseArray.prototype._resolve=function(value){this._promise._resolveCallback(value);this._values=null;};ReductionPromiseArray.prototype._resultCancelled=function(sender){if(sender===this._initialValue)return this._cancel();if(this._isResolved())return;this._resultCancelled$();if(this._currentCancellable instanceof Promise){this._currentCancellable.cancel();}if(this._initialValue instanceof Promise){this._initialValue.cancel();}};ReductionPromiseArray.prototype._iterate=function(values){this._values=values;var value;var i;var length=values.length;if(this._initialValue!==undefined){value=this._initialValue;i=0;}else{value=Promise.resolve(values[0]);i=1;}this._currentCancellable=value;if(!value.isRejected()){for(;i<length;++i){var ctx={accum:null,value:values[i],index:i,length:length,array:this};value=value._then(gotAccum,undefined,undefined,ctx,undefined);}}if(this._eachValues!==undefined){value=value._then(this._eachComplete,undefined,undefined,this,undefined);}value._then(completed,completed,undefined,value,this);};Promise.prototype.reduce=function(fn,initialValue){return reduce(this,fn,initialValue,null);};Promise.reduce=function(promises,fn,initialValue,_each){return reduce(promises,fn,initialValue,_each);};function completed(valueOrReason,array){if(this.isFulfilled()){array._resolve(valueOrReason);}else{array._reject(valueOrReason);}}function reduce(promises,fn,initialValue,_each){if(typeof fn!=="function"){return apiRejection("expecting a function but got "+util.classString(fn));}var array=new ReductionPromiseArray(promises,fn,initialValue,_each);return array.promise();}function gotAccum(accum){this.accum=accum;this.array._gotAccum(accum);var value=tryConvertToPromise(this.value,this.array._promise);if(value instanceof Promise){this.array._currentCancellable=value;return value._then(gotValue,undefined,undefined,this,undefined);}else{return gotValue.call(this,value);}}function gotValue(value){var array=this.array;var promise=array._promise;var fn=tryCatch(array._fn);promise._pushContext();var ret;if(array._eachValues!==undefined){ret=fn.call(promise._boundValue(),value,this.index,this.length);}else{ret=fn.call(promise._boundValue(),this.accum,value,this.index,this.length);}if(ret instanceof Promise){array._currentCancellable=ret;}var promiseCreated=promise._popContext();debug.checkForgottenReturns(ret,promiseCreated,array._eachValues!==undefined?"Promise.each":"Promise.reduce",promise);return ret;}};},{"./util":36}],29:[function(_dereq_,module,exports){"use strict";var util=_dereq_("./util");var schedule;var noAsyncScheduler=function noAsyncScheduler(){throw new Error("No async scheduler available\n\n    See http://goo.gl/MqrFmX\n");};var NativePromise=util.getNativePromise();if(util.isNode&&typeof MutationObserver==="undefined"){var GlobalSetImmediate=global.setImmediate;var ProcessNextTick=process.nextTick;schedule=util.isRecentNode?function(fn){GlobalSetImmediate.call(global,fn);}:function(fn){ProcessNextTick.call(process,fn);};}else if(typeof NativePromise==="function"&&typeof NativePromise.resolve==="function"){var nativePromise=NativePromise.resolve();schedule=function schedule(fn){nativePromise.then(fn);};}else if(typeof MutationObserver!=="undefined"&&!(typeof window!=="undefined"&&window.navigator&&(window.navigator.standalone||window.cordova))){schedule=function(){var div=document.createElement("div");var opts={attributes:true};var toggleScheduled=false;var div2=document.createElement("div");var o2=new MutationObserver(function(){div.classList.toggle("foo");toggleScheduled=false;});o2.observe(div2,opts);var scheduleToggle=function scheduleToggle(){if(toggleScheduled)return;toggleScheduled=true;div2.classList.toggle("foo");};return function schedule(fn){var o=new MutationObserver(function(){o.disconnect();fn();});o.observe(div,opts);scheduleToggle();};}();}else if(typeof setImmediate!=="undefined"){schedule=function schedule(fn){setImmediate(fn);};}else if(typeof setTimeout!=="undefined"){schedule=function schedule(fn){setTimeout(fn,0);};}else{schedule=noAsyncScheduler;}module.exports=schedule;},{"./util":36}],30:[function(_dereq_,module,exports){"use strict";module.exports=function(Promise,PromiseArray,debug){var PromiseInspection=Promise.PromiseInspection;var util=_dereq_("./util");function SettledPromiseArray(values){this.constructor$(values);}util.inherits(SettledPromiseArray,PromiseArray);SettledPromiseArray.prototype._promiseResolved=function(index,inspection){this._values[index]=inspection;var totalResolved=++this._totalResolved;if(totalResolved>=this._length){this._resolve(this._values);return true;}return false;};SettledPromiseArray.prototype._promiseFulfilled=function(value,index){var ret=new PromiseInspection();ret._bitField=33554432;ret._settledValueField=value;return this._promiseResolved(index,ret);};SettledPromiseArray.prototype._promiseRejected=function(reason,index){var ret=new PromiseInspection();ret._bitField=16777216;ret._settledValueField=reason;return this._promiseResolved(index,ret);};Promise.settle=function(promises){debug.deprecated(".settle()",".reflect()");return new SettledPromiseArray(promises).promise();};Promise.prototype.settle=function(){return Promise.settle(this);};};},{"./util":36}],31:[function(_dereq_,module,exports){"use strict";module.exports=function(Promise,PromiseArray,apiRejection){var util=_dereq_("./util");var RangeError=_dereq_("./errors").RangeError;var AggregateError=_dereq_("./errors").AggregateError;var isArray=util.isArray;var CANCELLATION={};function SomePromiseArray(values){this.constructor$(values);this._howMany=0;this._unwrap=false;this._initialized=false;}util.inherits(SomePromiseArray,PromiseArray);SomePromiseArray.prototype._init=function(){if(!this._initialized){return;}if(this._howMany===0){this._resolve([]);return;}this._init$(undefined,-5);var isArrayResolved=isArray(this._values);if(!this._isResolved()&&isArrayResolved&&this._howMany>this._canPossiblyFulfill()){this._reject(this._getRangeError(this.length()));}};SomePromiseArray.prototype.init=function(){this._initialized=true;this._init();};SomePromiseArray.prototype.setUnwrap=function(){this._unwrap=true;};SomePromiseArray.prototype.howMany=function(){return this._howMany;};SomePromiseArray.prototype.setHowMany=function(count){this._howMany=count;};SomePromiseArray.prototype._promiseFulfilled=function(value){this._addFulfilled(value);if(this._fulfilled()===this.howMany()){this._values.length=this.howMany();if(this.howMany()===1&&this._unwrap){this._resolve(this._values[0]);}else{this._resolve(this._values);}return true;}return false;};SomePromiseArray.prototype._promiseRejected=function(reason){this._addRejected(reason);return this._checkOutcome();};SomePromiseArray.prototype._promiseCancelled=function(){if(this._values instanceof Promise||this._values==null){return this._cancel();}this._addRejected(CANCELLATION);return this._checkOutcome();};SomePromiseArray.prototype._checkOutcome=function(){if(this.howMany()>this._canPossiblyFulfill()){var e=new AggregateError();for(var i=this.length();i<this._values.length;++i){if(this._values[i]!==CANCELLATION){e.push(this._values[i]);}}if(e.length>0){this._reject(e);}else{this._cancel();}return true;}return false;};SomePromiseArray.prototype._fulfilled=function(){return this._totalResolved;};SomePromiseArray.prototype._rejected=function(){return this._values.length-this.length();};SomePromiseArray.prototype._addRejected=function(reason){this._values.push(reason);};SomePromiseArray.prototype._addFulfilled=function(value){this._values[this._totalResolved++]=value;};SomePromiseArray.prototype._canPossiblyFulfill=function(){return this.length()-this._rejected();};SomePromiseArray.prototype._getRangeError=function(count){var message="Input array must contain at least "+this._howMany+" items but contains only "+count+" items";return new RangeError(message);};SomePromiseArray.prototype._resolveEmptyArray=function(){this._reject(this._getRangeError(0));};function some(promises,howMany){if((howMany|0)!==howMany||howMany<0){return apiRejection("expecting a positive integer\n\n    See http://goo.gl/MqrFmX\n");}var ret=new SomePromiseArray(promises);var promise=ret.promise();ret.setHowMany(howMany);ret.init();return promise;}Promise.some=function(promises,howMany){return some(promises,howMany);};Promise.prototype.some=function(howMany){return some(this,howMany);};Promise._SomePromiseArray=SomePromiseArray;};},{"./errors":12,"./util":36}],32:[function(_dereq_,module,exports){"use strict";module.exports=function(Promise){function PromiseInspection(promise){if(promise!==undefined){promise=promise._target();this._bitField=promise._bitField;this._settledValueField=promise._isFateSealed()?promise._settledValue():undefined;}else{this._bitField=0;this._settledValueField=undefined;}}PromiseInspection.prototype._settledValue=function(){return this._settledValueField;};var value=PromiseInspection.prototype.value=function(){if(!this.isFulfilled()){throw new TypeError("cannot get fulfillment value of a non-fulfilled promise\n\n    See http://goo.gl/MqrFmX\n");}return this._settledValue();};var reason=PromiseInspection.prototype.error=PromiseInspection.prototype.reason=function(){if(!this.isRejected()){throw new TypeError("cannot get rejection reason of a non-rejected promise\n\n    See http://goo.gl/MqrFmX\n");}return this._settledValue();};var isFulfilled=PromiseInspection.prototype.isFulfilled=function(){return(this._bitField&33554432)!==0;};var isRejected=PromiseInspection.prototype.isRejected=function(){return(this._bitField&16777216)!==0;};var isPending=PromiseInspection.prototype.isPending=function(){return(this._bitField&50397184)===0;};var isResolved=PromiseInspection.prototype.isResolved=function(){return(this._bitField&50331648)!==0;};PromiseInspection.prototype.isCancelled=function(){return(this._bitField&8454144)!==0;};Promise.prototype.__isCancelled=function(){return(this._bitField&65536)===65536;};Promise.prototype._isCancelled=function(){return this._target().__isCancelled();};Promise.prototype.isCancelled=function(){return(this._target()._bitField&8454144)!==0;};Promise.prototype.isPending=function(){return isPending.call(this._target());};Promise.prototype.isRejected=function(){return isRejected.call(this._target());};Promise.prototype.isFulfilled=function(){return isFulfilled.call(this._target());};Promise.prototype.isResolved=function(){return isResolved.call(this._target());};Promise.prototype.value=function(){return value.call(this._target());};Promise.prototype.reason=function(){var target=this._target();target._unsetRejectionIsUnhandled();return reason.call(target);};Promise.prototype._value=function(){return this._settledValue();};Promise.prototype._reason=function(){this._unsetRejectionIsUnhandled();return this._settledValue();};Promise.PromiseInspection=PromiseInspection;};},{}],33:[function(_dereq_,module,exports){"use strict";module.exports=function(Promise,INTERNAL){var util=_dereq_("./util");var errorObj=util.errorObj;var isObject=util.isObject;function tryConvertToPromise(obj,context){if(isObject(obj)){if(obj instanceof Promise)return obj;var then=getThen(obj);if(then===errorObj){if(context)context._pushContext();var ret=Promise.reject(then.e);if(context)context._popContext();return ret;}else if(typeof then==="function"){if(isAnyBluebirdPromise(obj)){var ret=new Promise(INTERNAL);obj._then(ret._fulfill,ret._reject,undefined,ret,null);return ret;}return doThenable(obj,then,context);}}return obj;}function doGetThen(obj){return obj.then;}function getThen(obj){try{return doGetThen(obj);}catch(e){errorObj.e=e;return errorObj;}}var hasProp={}.hasOwnProperty;function isAnyBluebirdPromise(obj){try{return hasProp.call(obj,"_promise0");}catch(e){return false;}}function doThenable(x,then,context){var promise=new Promise(INTERNAL);var ret=promise;if(context)context._pushContext();promise._captureStackTrace();if(context)context._popContext();var synchronous=true;var result=util.tryCatch(then).call(x,resolve,reject);synchronous=false;if(promise&&result===errorObj){promise._rejectCallback(result.e,true,true);promise=null;}function resolve(value){if(!promise)return;promise._resolveCallback(value);promise=null;}function reject(reason){if(!promise)return;promise._rejectCallback(reason,synchronous,true);promise=null;}return ret;}return tryConvertToPromise;};},{"./util":36}],34:[function(_dereq_,module,exports){"use strict";module.exports=function(Promise,INTERNAL,debug){var util=_dereq_("./util");var TimeoutError=Promise.TimeoutError;function HandleWrapper(handle){this.handle=handle;}HandleWrapper.prototype._resultCancelled=function(){clearTimeout(this.handle);};var afterValue=function afterValue(value){return delay(+this).thenReturn(value);};var delay=Promise.delay=function(ms,value){var ret;var handle;if(value!==undefined){ret=Promise.resolve(value)._then(afterValue,null,null,ms,undefined);if(debug.cancellation()&&value instanceof Promise){ret._setOnCancel(value);}}else{ret=new Promise(INTERNAL);handle=setTimeout(function(){ret._fulfill();},+ms);if(debug.cancellation()){ret._setOnCancel(new HandleWrapper(handle));}ret._captureStackTrace();}ret._setAsyncGuaranteed();return ret;};Promise.prototype.delay=function(ms){return delay(ms,this);};var afterTimeout=function afterTimeout(promise,message,parent){var err;if(typeof message!=="string"){if(message instanceof Error){err=message;}else{err=new TimeoutError("operation timed out");}}else{err=new TimeoutError(message);}util.markAsOriginatingFromRejection(err);promise._attachExtraTrace(err);promise._reject(err);if(parent!=null){parent.cancel();}};function successClear(value){clearTimeout(this.handle);return value;}function failureClear(reason){clearTimeout(this.handle);throw reason;}Promise.prototype.timeout=function(ms,message){ms=+ms;var ret,parent;var handleWrapper=new HandleWrapper(setTimeout(function timeoutTimeout(){if(ret.isPending()){afterTimeout(ret,message,parent);}},ms));if(debug.cancellation()){parent=this.then();ret=parent._then(successClear,failureClear,undefined,handleWrapper,undefined);ret._setOnCancel(handleWrapper);}else{ret=this._then(successClear,failureClear,undefined,handleWrapper,undefined);}return ret;};};},{"./util":36}],35:[function(_dereq_,module,exports){"use strict";module.exports=function(Promise,apiRejection,tryConvertToPromise,createContext,INTERNAL,debug){var util=_dereq_("./util");var TypeError=_dereq_("./errors").TypeError;var inherits=_dereq_("./util").inherits;var errorObj=util.errorObj;var tryCatch=util.tryCatch;var NULL={};function thrower(e){setTimeout(function(){throw e;},0);}function castPreservingDisposable(thenable){var maybePromise=tryConvertToPromise(thenable);if(maybePromise!==thenable&&typeof thenable._isDisposable==="function"&&typeof thenable._getDisposer==="function"&&thenable._isDisposable()){maybePromise._setDisposable(thenable._getDisposer());}return maybePromise;}function dispose(resources,inspection){var i=0;var len=resources.length;var ret=new Promise(INTERNAL);function iterator(){if(i>=len)return ret._fulfill();var maybePromise=castPreservingDisposable(resources[i++]);if(maybePromise instanceof Promise&&maybePromise._isDisposable()){try{maybePromise=tryConvertToPromise(maybePromise._getDisposer().tryDispose(inspection),resources.promise);}catch(e){return thrower(e);}if(maybePromise instanceof Promise){return maybePromise._then(iterator,thrower,null,null,null);}}iterator();}iterator();return ret;}function Disposer(data,promise,context){this._data=data;this._promise=promise;this._context=context;}Disposer.prototype.data=function(){return this._data;};Disposer.prototype.promise=function(){return this._promise;};Disposer.prototype.resource=function(){if(this.promise().isFulfilled()){return this.promise().value();}return NULL;};Disposer.prototype.tryDispose=function(inspection){var resource=this.resource();var context=this._context;if(context!==undefined)context._pushContext();var ret=resource!==NULL?this.doDispose(resource,inspection):null;if(context!==undefined)context._popContext();this._promise._unsetDisposable();this._data=null;return ret;};Disposer.isDisposer=function(d){return d!=null&&typeof d.resource==="function"&&typeof d.tryDispose==="function";};function FunctionDisposer(fn,promise,context){this.constructor$(fn,promise,context);}inherits(FunctionDisposer,Disposer);FunctionDisposer.prototype.doDispose=function(resource,inspection){var fn=this.data();return fn.call(resource,resource,inspection);};function maybeUnwrapDisposer(value){if(Disposer.isDisposer(value)){this.resources[this.index]._setDisposable(value);return value.promise();}return value;}function ResourceList(length){this.length=length;this.promise=null;this[length-1]=null;}ResourceList.prototype._resultCancelled=function(){var len=this.length;for(var i=0;i<len;++i){var item=this[i];if(item instanceof Promise){item.cancel();}}};Promise.using=function(){var len=arguments.length;if(len<2)return apiRejection("you must pass at least 2 arguments to Promise.using");var fn=arguments[len-1];if(typeof fn!=="function"){return apiRejection("expecting a function but got "+util.classString(fn));}var input;var spreadArgs=true;if(len===2&&Array.isArray(arguments[0])){input=arguments[0];len=input.length;spreadArgs=false;}else{input=arguments;len--;}var resources=new ResourceList(len);for(var i=0;i<len;++i){var resource=input[i];if(Disposer.isDisposer(resource)){var disposer=resource;resource=resource.promise();resource._setDisposable(disposer);}else{var maybePromise=tryConvertToPromise(resource);if(maybePromise instanceof Promise){resource=maybePromise._then(maybeUnwrapDisposer,null,null,{resources:resources,index:i},undefined);}}resources[i]=resource;}var reflectedResources=new Array(resources.length);for(var i=0;i<reflectedResources.length;++i){reflectedResources[i]=Promise.resolve(resources[i]).reflect();}var resultPromise=Promise.all(reflectedResources).then(function(inspections){for(var i=0;i<inspections.length;++i){var inspection=inspections[i];if(inspection.isRejected()){errorObj.e=inspection.error();return errorObj;}else if(!inspection.isFulfilled()){resultPromise.cancel();return;}inspections[i]=inspection.value();}promise._pushContext();fn=tryCatch(fn);var ret=spreadArgs?fn.apply(undefined,inspections):fn(inspections);var promiseCreated=promise._popContext();debug.checkForgottenReturns(ret,promiseCreated,"Promise.using",promise);return ret;});var promise=resultPromise.lastly(function(){var inspection=new Promise.PromiseInspection(resultPromise);return dispose(resources,inspection);});resources.promise=promise;promise._setOnCancel(resources);return promise;};Promise.prototype._setDisposable=function(disposer){this._bitField=this._bitField|131072;this._disposer=disposer;};Promise.prototype._isDisposable=function(){return(this._bitField&131072)>0;};Promise.prototype._getDisposer=function(){return this._disposer;};Promise.prototype._unsetDisposable=function(){this._bitField=this._bitField&~131072;this._disposer=undefined;};Promise.prototype.disposer=function(fn){if(typeof fn==="function"){return new FunctionDisposer(fn,this,createContext());}throw new TypeError();};};},{"./errors":12,"./util":36}],36:[function(_dereq_,module,exports){"use strict";var es5=_dereq_("./es5");var canEvaluate=typeof navigator=="undefined";var errorObj={e:{}};var tryCatchTarget;var globalObject=typeof self!=="undefined"?self:typeof window!=="undefined"?window:typeof global!=="undefined"?global:this!==undefined?this:null;function tryCatcher(){try{var target=tryCatchTarget;tryCatchTarget=null;return target.apply(this,arguments);}catch(e){errorObj.e=e;return errorObj;}}function tryCatch(fn){tryCatchTarget=fn;return tryCatcher;}var inherits=function inherits(Child,Parent){var hasProp={}.hasOwnProperty;function T(){this.constructor=Child;this.constructor$=Parent;for(var propertyName in Parent.prototype){if(hasProp.call(Parent.prototype,propertyName)&&propertyName.charAt(propertyName.length-1)!=="$"){this[propertyName+"$"]=Parent.prototype[propertyName];}}}T.prototype=Parent.prototype;Child.prototype=new T();return Child.prototype;};function isPrimitive(val){return val==null||val===true||val===false||typeof val==="string"||typeof val==="number";}function isObject(value){return typeof value==="function"||(typeof value==="undefined"?"undefined":_typeof4(value))==="object"&&value!==null;}function maybeWrapAsError(maybeError){if(!isPrimitive(maybeError))return maybeError;return new Error(safeToString(maybeError));}function withAppended(target,appendee){var len=target.length;var ret=new Array(len+1);var i;for(i=0;i<len;++i){ret[i]=target[i];}ret[i]=appendee;return ret;}function getDataPropertyOrDefault(obj,key,defaultValue){if(es5.isES5){var desc=Object.getOwnPropertyDescriptor(obj,key);if(desc!=null){return desc.get==null&&desc.set==null?desc.value:defaultValue;}}else{return{}.hasOwnProperty.call(obj,key)?obj[key]:undefined;}}function notEnumerableProp(obj,name,value){if(isPrimitive(obj))return obj;var descriptor={value:value,configurable:true,enumerable:false,writable:true};es5.defineProperty(obj,name,descriptor);return obj;}function thrower(r){throw r;}var inheritedDataKeys=function(){var excludedPrototypes=[Array.prototype,Object.prototype,Function.prototype];var isExcludedProto=function isExcludedProto(val){for(var i=0;i<excludedPrototypes.length;++i){if(excludedPrototypes[i]===val){return true;}}return false;};if(es5.isES5){var getKeys=Object.getOwnPropertyNames;return function(obj){var ret=[];var visitedKeys=Object.create(null);while(obj!=null&&!isExcludedProto(obj)){var keys;try{keys=getKeys(obj);}catch(e){return ret;}for(var i=0;i<keys.length;++i){var key=keys[i];if(visitedKeys[key])continue;visitedKeys[key]=true;var desc=Object.getOwnPropertyDescriptor(obj,key);if(desc!=null&&desc.get==null&&desc.set==null){ret.push(key);}}obj=es5.getPrototypeOf(obj);}return ret;};}else{var hasProp={}.hasOwnProperty;return function(obj){if(isExcludedProto(obj))return[];var ret=[];/*jshint forin:false */enumeration:for(var key in obj){if(hasProp.call(obj,key)){ret.push(key);}else{for(var i=0;i<excludedPrototypes.length;++i){if(hasProp.call(excludedPrototypes[i],key)){continue enumeration;}}ret.push(key);}}return ret;};}}();var thisAssignmentPattern=/this\s*\.\s*\S+\s*=/;function isClass(fn){try{if(typeof fn==="function"){var keys=es5.names(fn.prototype);var hasMethods=es5.isES5&&keys.length>1;var hasMethodsOtherThanConstructor=keys.length>0&&!(keys.length===1&&keys[0]==="constructor");var hasThisAssignmentAndStaticMethods=thisAssignmentPattern.test(fn+"")&&es5.names(fn).length>0;if(hasMethods||hasMethodsOtherThanConstructor||hasThisAssignmentAndStaticMethods){return true;}}return false;}catch(e){return false;}}function toFastProperties(obj){/*jshint -W027,-W055,-W031*/function FakeConstructor(){}FakeConstructor.prototype=obj;var l=8;while(l--){new FakeConstructor();}return obj;eval(obj);}var rident=/^[a-z$_][a-z$_0-9]*$/i;function isIdentifier(str){return rident.test(str);}function filledRange(count,prefix,suffix){var ret=new Array(count);for(var i=0;i<count;++i){ret[i]=prefix+i+suffix;}return ret;}function safeToString(obj){try{return obj+"";}catch(e){return"[no string representation]";}}function isError(obj){return obj!==null&&(typeof obj==="undefined"?"undefined":_typeof4(obj))==="object"&&typeof obj.message==="string"&&typeof obj.name==="string";}function markAsOriginatingFromRejection(e){try{notEnumerableProp(e,"isOperational",true);}catch(ignore){}}function originatesFromRejection(e){if(e==null)return false;return e instanceof Error["__BluebirdErrorTypes__"].OperationalError||e["isOperational"]===true;}function canAttachTrace(obj){return isError(obj)&&es5.propertyIsWritable(obj,"stack");}var ensureErrorObject=function(){if(!("stack"in new Error())){return function(value){if(canAttachTrace(value))return value;try{throw new Error(safeToString(value));}catch(err){return err;}};}else{return function(value){if(canAttachTrace(value))return value;return new Error(safeToString(value));};}}();function classString(obj){return{}.toString.call(obj);}function copyDescriptors(from,to,filter){var keys=es5.names(from);for(var i=0;i<keys.length;++i){var key=keys[i];if(filter(key)){try{es5.defineProperty(to,key,es5.getDescriptor(from,key));}catch(ignore){}}}}var asArray=function asArray(v){if(es5.isArray(v)){return v;}return null;};if(typeof Symbol!=="undefined"&&Symbol.iterator){var ArrayFrom=typeof Array.from==="function"?function(v){return Array.from(v);}:function(v){var ret=[];var it=v[Symbol.iterator]();var itResult;while(!(itResult=it.next()).done){ret.push(itResult.value);}return ret;};asArray=function asArray(v){if(es5.isArray(v)){return v;}else if(v!=null&&typeof v[Symbol.iterator]==="function"){return ArrayFrom(v);}return null;};}var isNode=typeof process!=="undefined"&&classString(process).toLowerCase()==="[object process]";var hasEnvVariables=typeof process!=="undefined"&&typeof process.env!=="undefined";function env(key){return hasEnvVariables?process.env[key]:undefined;}function getNativePromise(){if(typeof Promise==="function"){try{var promise=new Promise(function(){});if({}.toString.call(promise)==="[object Promise]"){return Promise;}}catch(e){}}}function domainBind(self,cb){return self.bind(cb);}var ret={isClass:isClass,isIdentifier:isIdentifier,inheritedDataKeys:inheritedDataKeys,getDataPropertyOrDefault:getDataPropertyOrDefault,thrower:thrower,isArray:es5.isArray,asArray:asArray,notEnumerableProp:notEnumerableProp,isPrimitive:isPrimitive,isObject:isObject,isError:isError,canEvaluate:canEvaluate,errorObj:errorObj,tryCatch:tryCatch,inherits:inherits,withAppended:withAppended,maybeWrapAsError:maybeWrapAsError,toFastProperties:toFastProperties,filledRange:filledRange,toString:safeToString,canAttachTrace:canAttachTrace,ensureErrorObject:ensureErrorObject,originatesFromRejection:originatesFromRejection,markAsOriginatingFromRejection:markAsOriginatingFromRejection,classString:classString,copyDescriptors:copyDescriptors,hasDevTools:typeof chrome!=="undefined"&&chrome&&typeof chrome.loadTimes==="function",isNode:isNode,hasEnvVariables:hasEnvVariables,env:env,global:globalObject,getNativePromise:getNativePromise,domainBind:domainBind};ret.isRecentNode=ret.isNode&&function(){var version=process.versions.node.split(".").map(Number);return version[0]===0&&version[1]>10||version[0]>0;}();if(ret.isNode)ret.toFastProperties(process);try{throw new Error();}catch(e){ret.lastLineError=e;}module.exports=ret;},{"./es5":13}]},{},[4])(4);});;if(typeof window!=='undefined'&&window!==null){window.P=window.Promise;}else if(typeof self!=='undefined'&&self!==null){self.P=self.Promise;}}).call(this,_dereq_('_process'),typeof global!=="undefined"?global:typeof self!=="undefined"?self:typeof window!=="undefined"?window:{});},{"_process":178}],36:[function(_dereq_,module,exports){// Generated by CoffeeScript 1.11.0
(function(){var Bottleneck,MIDDLE_PRIORITY,NB_PRIORITIES,bind=function bind(fn,me){return function(){return fn.apply(me,arguments);};},slice=[].slice;NB_PRIORITIES=10;MIDDLE_PRIORITY=5;Bottleneck=function(){var e;Bottleneck.strategy=Bottleneck.prototype.strategy={LEAK:1,OVERFLOW:2,OVERFLOW_PRIORITY:4,BLOCK:3};Bottleneck.Cluster=Bottleneck.prototype.Cluster=_dereq_("./Cluster");Bottleneck.DLList=Bottleneck.prototype.DLList=_dereq_("./DLList");Bottleneck.Promise=Bottleneck.prototype.Promise=function(){try{return _dereq_("bluebird");}catch(error){e=error;return typeof Promise!=="undefined"&&Promise!==null?Promise:function(){throw new Error("Bottleneck: install 'bluebird' or use Node 0.12 or higher for Promise support");};}}();function Bottleneck(maxNb,minTime,highWater,strategy,rejectOnDrop){this.maxNb=maxNb!=null?maxNb:0;this.minTime=minTime!=null?minTime:0;this.highWater=highWater!=null?highWater:-1;this.strategy=strategy!=null?strategy:Bottleneck.prototype.strategy.LEAK;this.rejectOnDrop=rejectOnDrop!=null?rejectOnDrop:false;this.schedulePriority=bind(this.schedulePriority,this);this.submitPriority=bind(this.submitPriority,this);this.submit=bind(this.submit,this);this._nextRequest=Date.now();this._nbRunning=0;this._queues=this._makeQueues();this._running={};this._nextIndex=0;this._unblockTime=0;this.penalty=15*this.minTime||5000;this.interrupt=false;this.reservoir=null;this.limiter=null;this.events={};}Bottleneck.prototype._trigger=function(name,args){if(this.rejectOnDrop&&name==="dropped"){args[0].cb.apply({},[new Error("This job has been dropped by Bottleneck")]);}return setTimeout(function(_this){return function(){var ref;return(ref=_this.events[name])!=null?ref.forEach(function(e){return e.apply({},args);}):void 0;};}(this),0);};Bottleneck.prototype._makeQueues=function(){var i,j,ref,results;results=[];for(i=j=1,ref=NB_PRIORITIES;1<=ref?j<=ref:j>=ref;i=1<=ref?++j:--j){results.push(new Bottleneck.prototype.DLList());}return results;};Bottleneck.prototype.chain=function(limiter){this.limiter=limiter;return this;};Bottleneck.prototype.isBlocked=function(){return this._unblockTime>=Date.now();};Bottleneck.prototype._sanitizePriority=function(priority){var sProperty;sProperty=~~priority!==priority?MIDDLE_PRIORITY:priority;if(sProperty<0){return 0;}else if(sProperty>NB_PRIORITIES-1){return NB_PRIORITIES-1;}else{return sProperty;}};Bottleneck.prototype._find=function(arr,fn){var i,j,len,x;for(i=j=0,len=arr.length;j<len;i=++j){x=arr[i];if(fn(x)){return x;}}return[];};Bottleneck.prototype.nbQueued=function(priority){if(priority!=null){return this._queues[this._sanitizePriority(priority)].length;}else{return this._queues.reduce(function(a,b){return a+b.length;},0);}};Bottleneck.prototype.nbRunning=function(){return this._nbRunning;};Bottleneck.prototype._getFirst=function(arr){return this._find(arr,function(x){return x.length>0;});};Bottleneck.prototype._conditionsCheck=function(){return(this.nbRunning()<this.maxNb||this.maxNb<=0)&&(this.reservoir==null||this.reservoir>0);};Bottleneck.prototype.check=function(){return this._conditionsCheck()&&this._nextRequest-Date.now()<=0;};Bottleneck.prototype._tryToRun=function(){var done,index,next,queued,wait;if(this._conditionsCheck()&&(queued=this.nbQueued())>0){this._nbRunning++;if(this.reservoir!=null){this.reservoir--;}wait=Math.max(this._nextRequest-Date.now(),0);this._nextRequest=Date.now()+wait+this.minTime;next=this._getFirst(this._queues).shift();if(queued===1){this._trigger("empty",[]);}done=false;index=this._nextIndex++;this._running[index]={timeout:setTimeout(function(_this){return function(){var completed;completed=function completed(){var ref;if(!done){done=true;delete _this._running[index];_this._nbRunning--;_this._tryToRun();if(_this.nbRunning()===0&&_this.nbQueued()===0){_this._trigger("idle",[]);}if(!_this.interrupt){return(ref=next.cb)!=null?ref.apply({},Array.prototype.slice.call(arguments,0)):void 0;}}};if(_this.limiter!=null){return _this.limiter.submit.apply(_this.limiter,Array.prototype.concat(next.task,next.args,completed));}else{return next.task.apply({},next.args.concat(completed));}};}(this),wait),job:next};return true;}else{return false;}};Bottleneck.prototype.submit=function(){var args;args=1<=arguments.length?slice.call(arguments,0):[];return this.submitPriority.apply({},Array.prototype.concat(MIDDLE_PRIORITY,args));};Bottleneck.prototype.submitPriority=function(){var args,cb,j,job,priority,reachedHighWaterMark,shifted,task;priority=arguments[0],task=arguments[1],args=4<=arguments.length?slice.call(arguments,2,j=arguments.length-1):(j=2,[]),cb=arguments[j++];job={task:task,args:args,cb:cb};priority=this._sanitizePriority(priority);reachedHighWaterMark=this.highWater>=0&&this.nbQueued()===this.highWater&&!this.check();if(this.strategy===Bottleneck.prototype.strategy.BLOCK&&(reachedHighWaterMark||this.isBlocked())){this._unblockTime=Date.now()+this.penalty;this._nextRequest=this._unblockTime+this.minTime;this._queues=this._makeQueues();this._trigger("dropped",[job]);return true;}else if(reachedHighWaterMark){shifted=this.strategy===Bottleneck.prototype.strategy.LEAK?this._getFirst(this._queues.slice(priority).reverse()).shift():this.strategy===Bottleneck.prototype.strategy.OVERFLOW_PRIORITY?this._getFirst(this._queues.slice(priority+1).reverse()).shift():this.strategy===Bottleneck.prototype.strategy.OVERFLOW?job:void 0;if(shifted!=null){this._trigger("dropped",[shifted]);}if(shifted==null||this.strategy===Bottleneck.prototype.strategy.OVERFLOW){return reachedHighWaterMark;}}this._queues[priority].push(job);this._tryToRun();return reachedHighWaterMark;};Bottleneck.prototype.schedule=function(){var args;args=1<=arguments.length?slice.call(arguments,0):[];return this.schedulePriority.apply({},Array.prototype.concat(MIDDLE_PRIORITY,args));};Bottleneck.prototype.schedulePriority=function(){var args,priority,task,wrapped;priority=arguments[0],task=arguments[1],args=3<=arguments.length?slice.call(arguments,2):[];wrapped=function wrapped(){var args,cb,j;args=2<=arguments.length?slice.call(arguments,0,j=arguments.length-1):(j=0,[]),cb=arguments[j++];return task.apply({},args).then(function(){var args;args=1<=arguments.length?slice.call(arguments,0):[];return cb.apply({},Array.prototype.concat(null,args));})["catch"](function(){var args;args=1<=arguments.length?slice.call(arguments,0):[];return cb.apply({},args);});};return new Bottleneck.prototype.Promise(function(_this){return function(resolve,reject){return _this.submitPriority.apply({},Array.prototype.concat(priority,wrapped,args,function(){var args;args=1<=arguments.length?slice.call(arguments,0):[];return(args[0]!=null?reject:(args.shift(),resolve)).apply({},args);}));};}(this));};Bottleneck.prototype.changeSettings=function(maxNb,minTime,highWater,strategy,rejectOnDrop){this.maxNb=maxNb!=null?maxNb:this.maxNb;this.minTime=minTime!=null?minTime:this.minTime;this.highWater=highWater!=null?highWater:this.highWater;this.strategy=strategy!=null?strategy:this.strategy;this.rejectOnDrop=rejectOnDrop!=null?rejectOnDrop:this.rejectOnDrop;while(this._tryToRun()){}return this;};Bottleneck.prototype.changePenalty=function(penalty){this.penalty=penalty!=null?penalty:this.penalty;return this;};Bottleneck.prototype.changeReservoir=function(reservoir){this.reservoir=reservoir;while(this._tryToRun()){}return this;};Bottleneck.prototype.incrementReservoir=function(incr){if(incr==null){incr=0;}this.changeReservoir(this.reservoir+incr);return this;};Bottleneck.prototype.on=function(name,cb){if(this.events[name]!=null){this.events[name].push(cb);}else{this.events[name]=[cb];}return this;};Bottleneck.prototype.removeAllListeners=function(name){if(name==null){name=null;}if(name!=null){delete this.events[name];}else{this.events={};}return this;};Bottleneck.prototype.stopAll=function(interrupt){var j,job,k,keys,l,len,len1;this.interrupt=interrupt!=null?interrupt:this.interrupt;keys=Object.keys(this._running);for(j=0,len=keys.length;j<len;j++){k=keys[j];clearTimeout(this._running[k].timeout);}this._tryToRun=function(){};this.check=function(){return false;};this.submit=this.submitPriority=function(){var args,cb,l;args=2<=arguments.length?slice.call(arguments,0,l=arguments.length-1):(l=0,[]),cb=arguments[l++];return cb(new Error("This limiter is stopped"));};this.schedule=this.schedulePriority=function(){return Promise.reject(new Error("This limiter is stopped"));};if(this.interrupt){for(l=0,len1=keys.length;l<len1;l++){k=keys[l];this._trigger("dropped",[this._running[k].job]);}}while(job=this._getFirst(this._queues).shift()){this._trigger("dropped",[job]);}this._trigger("empty",[]);if(this.nbRunning()===0){this._trigger("idle",[]);}return this;};return Bottleneck;}();module.exports=Bottleneck;}).call(this);},{"./Cluster":37,"./DLList":38,"bluebird":35}],37:[function(_dereq_,module,exports){// Generated by CoffeeScript 1.11.0
(function(){var Cluster,hasProp={}.hasOwnProperty;Cluster=function(){function Cluster(maxNb,minTime,highWater,strategy,rejectOnDrop){this.maxNb=maxNb;this.minTime=minTime;this.highWater=highWater;this.strategy=strategy;this.rejectOnDrop=rejectOnDrop;this.limiters={};this.Bottleneck=_dereq_("./Bottleneck");this.startAutoCleanup();}Cluster.prototype.key=function(key){var ref;if(key==null){key="";}return(ref=this.limiters[key])!=null?ref:this.limiters[key]=new this.Bottleneck(this.maxNb,this.minTime,this.highWater,this.strategy,this.rejectOnDrop);};Cluster.prototype.deleteKey=function(key){if(key==null){key="";}return delete this.limiters[key];};Cluster.prototype.all=function(cb){var k,ref,results,v;ref=this.limiters;results=[];for(k in ref){if(!hasProp.call(ref,k))continue;v=ref[k];results.push(cb(v));}return results;};Cluster.prototype.keys=function(){return Object.keys(this.limiters);};Cluster.prototype.startAutoCleanup=function(){var base;this.stopAutoCleanup();return typeof(base=this.interval=setInterval(function(_this){return function(){var k,ref,results,time,v;time=Date.now();ref=_this.limiters;results=[];for(k in ref){v=ref[k];if(v._nextRequest+1000*60*5<time){results.push(_this.deleteKey(k));}else{results.push(void 0);}}return results;};}(this),1000*30)).unref==="function"?base.unref():void 0;};Cluster.prototype.stopAutoCleanup=function(){return clearInterval(this.interval);};return Cluster;}();module.exports=Cluster;}).call(this);},{"./Bottleneck":36}],38:[function(_dereq_,module,exports){// Generated by CoffeeScript 1.11.0
(function(){var DLList;DLList=function(){function DLList(){this._first=null;this._last=null;this.length=0;}DLList.prototype.push=function(value){var node;this.length++;node={value:value,next:null};if(this._last!=null){this._last.next=node;this._last=node;}else{this._first=this._last=node;}return void 0;};DLList.prototype.shift=function(){var ref1,value;if(this._first==null){return void 0;}else{this.length--;}value=this._first.value;this._first=(ref1=this._first.next)!=null?ref1:this._last=null;return value;};DLList.prototype.getArray=function(){var node,ref,results;node=this._first;results=[];while(node!=null){results.push((ref=node,node=node.next,ref.value));}return results;};return DLList;}();module.exports=DLList;}).call(this);},{}],39:[function(_dereq_,module,exports){(function(global){// Generated by CoffeeScript 1.11.0
(function(){module.exports=_dereq_("./Bottleneck");if(global.window!=null){global.window.Bottleneck=module.exports;}}).call(this);}).call(this,typeof global!=="undefined"?global:typeof self!=="undefined"?self:typeof window!=="undefined"?window:{});},{"./Bottleneck":36}],40:[function(_dereq_,module,exports){},{}],41:[function(_dereq_,module,exports){_dereq_('../../modules/es6.string.iterator');_dereq_('../../modules/es6.array.from');module.exports=_dereq_('../../modules/_core').Array.from;},{"../../modules/_core":75,"../../modules/es6.array.from":144,"../../modules/es6.string.iterator":160}],42:[function(_dereq_,module,exports){_dereq_('../modules/web.dom.iterable');_dereq_('../modules/es6.string.iterator');module.exports=_dereq_('../modules/core.get-iterator');},{"../modules/core.get-iterator":142,"../modules/es6.string.iterator":160,"../modules/web.dom.iterable":166}],43:[function(_dereq_,module,exports){_dereq_('../modules/web.dom.iterable');_dereq_('../modules/es6.string.iterator');module.exports=_dereq_('../modules/core.is-iterable');},{"../modules/core.is-iterable":143,"../modules/es6.string.iterator":160,"../modules/web.dom.iterable":166}],44:[function(_dereq_,module,exports){var core=_dereq_('../../modules/_core'),$JSON=core.JSON||(core.JSON={stringify:JSON.stringify});module.exports=function stringify(it){// eslint-disable-line no-unused-vars
return $JSON.stringify.apply($JSON,arguments);};},{"../../modules/_core":75}],45:[function(_dereq_,module,exports){_dereq_('../modules/es6.object.to-string');_dereq_('../modules/es6.string.iterator');_dereq_('../modules/web.dom.iterable');_dereq_('../modules/es6.map');_dereq_('../modules/es7.map.to-json');module.exports=_dereq_('../modules/_core').Map;},{"../modules/_core":75,"../modules/es6.map":146,"../modules/es6.object.to-string":156,"../modules/es6.string.iterator":160,"../modules/es7.map.to-json":162,"../modules/web.dom.iterable":166}],46:[function(_dereq_,module,exports){_dereq_('../../modules/es6.number.is-integer');module.exports=_dereq_('../../modules/_core').Number.isInteger;},{"../../modules/_core":75,"../../modules/es6.number.is-integer":147}],47:[function(_dereq_,module,exports){_dereq_('../../modules/es6.object.assign');module.exports=_dereq_('../../modules/_core').Object.assign;},{"../../modules/_core":75,"../../modules/es6.object.assign":148}],48:[function(_dereq_,module,exports){_dereq_('../../modules/es6.object.create');var $Object=_dereq_('../../modules/_core').Object;module.exports=function create(P,D){return $Object.create(P,D);};},{"../../modules/_core":75,"../../modules/es6.object.create":149}],49:[function(_dereq_,module,exports){_dereq_('../../modules/es6.object.define-properties');var $Object=_dereq_('../../modules/_core').Object;module.exports=function defineProperties(T,D){return $Object.defineProperties(T,D);};},{"../../modules/_core":75,"../../modules/es6.object.define-properties":150}],50:[function(_dereq_,module,exports){_dereq_('../../modules/es6.object.define-property');var $Object=_dereq_('../../modules/_core').Object;module.exports=function defineProperty(it,key,desc){return $Object.defineProperty(it,key,desc);};},{"../../modules/_core":75,"../../modules/es6.object.define-property":151}],51:[function(_dereq_,module,exports){_dereq_('../../modules/es6.object.freeze');module.exports=_dereq_('../../modules/_core').Object.freeze;},{"../../modules/_core":75,"../../modules/es6.object.freeze":152}],52:[function(_dereq_,module,exports){_dereq_('../../modules/es6.object.get-prototype-of');module.exports=_dereq_('../../modules/_core').Object.getPrototypeOf;},{"../../modules/_core":75,"../../modules/es6.object.get-prototype-of":153}],53:[function(_dereq_,module,exports){_dereq_('../../modules/es6.object.keys');module.exports=_dereq_('../../modules/_core').Object.keys;},{"../../modules/_core":75,"../../modules/es6.object.keys":154}],54:[function(_dereq_,module,exports){_dereq_('../../modules/es6.object.set-prototype-of');module.exports=_dereq_('../../modules/_core').Object.setPrototypeOf;},{"../../modules/_core":75,"../../modules/es6.object.set-prototype-of":155}],55:[function(_dereq_,module,exports){_dereq_('../modules/es6.object.to-string');_dereq_('../modules/es6.string.iterator');_dereq_('../modules/web.dom.iterable');_dereq_('../modules/es6.promise');module.exports=_dereq_('../modules/_core').Promise;},{"../modules/_core":75,"../modules/es6.object.to-string":156,"../modules/es6.promise":157,"../modules/es6.string.iterator":160,"../modules/web.dom.iterable":166}],56:[function(_dereq_,module,exports){_dereq_('../../modules/es6.reflect.construct');module.exports=_dereq_('../../modules/_core').Reflect.construct;},{"../../modules/_core":75,"../../modules/es6.reflect.construct":158}],57:[function(_dereq_,module,exports){_dereq_('../modules/es6.object.to-string');_dereq_('../modules/es6.string.iterator');_dereq_('../modules/web.dom.iterable');_dereq_('../modules/es6.set');_dereq_('../modules/es7.set.to-json');module.exports=_dereq_('../modules/_core').Set;},{"../modules/_core":75,"../modules/es6.object.to-string":156,"../modules/es6.set":159,"../modules/es6.string.iterator":160,"../modules/es7.set.to-json":163,"../modules/web.dom.iterable":166}],58:[function(_dereq_,module,exports){_dereq_('../../modules/es6.symbol');_dereq_('../../modules/es6.object.to-string');_dereq_('../../modules/es7.symbol.async-iterator');_dereq_('../../modules/es7.symbol.observable');module.exports=_dereq_('../../modules/_core').Symbol;},{"../../modules/_core":75,"../../modules/es6.object.to-string":156,"../../modules/es6.symbol":161,"../../modules/es7.symbol.async-iterator":164,"../../modules/es7.symbol.observable":165}],59:[function(_dereq_,module,exports){_dereq_('../../modules/es6.string.iterator');_dereq_('../../modules/web.dom.iterable');module.exports=_dereq_('../../modules/_wks-ext').f('iterator');},{"../../modules/_wks-ext":139,"../../modules/es6.string.iterator":160,"../../modules/web.dom.iterable":166}],60:[function(_dereq_,module,exports){module.exports=function(it){if(typeof it!='function')throw TypeError(it+' is not a function!');return it;};},{}],61:[function(_dereq_,module,exports){module.exports=function(){/* empty */};},{}],62:[function(_dereq_,module,exports){module.exports=function(it,Constructor,name,forbiddenField){if(!(it instanceof Constructor)||forbiddenField!==undefined&&forbiddenField in it){throw TypeError(name+': incorrect invocation!');}return it;};},{}],63:[function(_dereq_,module,exports){var isObject=_dereq_('./_is-object');module.exports=function(it){if(!isObject(it))throw TypeError(it+' is not an object!');return it;};},{"./_is-object":96}],64:[function(_dereq_,module,exports){var forOf=_dereq_('./_for-of');module.exports=function(iter,ITERATOR){var result=[];forOf(iter,false,result.push,result,ITERATOR);return result;};},{"./_for-of":85}],65:[function(_dereq_,module,exports){// false -> Array#indexOf
// true  -> Array#includes
var toIObject=_dereq_('./_to-iobject'),toLength=_dereq_('./_to-length'),toIndex=_dereq_('./_to-index');module.exports=function(IS_INCLUDES){return function($this,el,fromIndex){var O=toIObject($this),length=toLength(O.length),index=toIndex(fromIndex,length),value;// Array#includes uses SameValueZero equality algorithm
if(IS_INCLUDES&&el!=el)while(length>index){value=O[index++];if(value!=value)return true;// Array#toIndex ignores holes, Array#includes - not
}else for(;length>index;index++){if(IS_INCLUDES||index in O){if(O[index]===el)return IS_INCLUDES||index||0;}}return!IS_INCLUDES&&-1;};};},{"./_to-index":131,"./_to-iobject":133,"./_to-length":134}],66:[function(_dereq_,module,exports){// 0 -> Array#forEach
// 1 -> Array#map
// 2 -> Array#filter
// 3 -> Array#some
// 4 -> Array#every
// 5 -> Array#find
// 6 -> Array#findIndex
var ctx=_dereq_('./_ctx'),IObject=_dereq_('./_iobject'),toObject=_dereq_('./_to-object'),toLength=_dereq_('./_to-length'),asc=_dereq_('./_array-species-create');module.exports=function(TYPE,$create){var IS_MAP=TYPE==1,IS_FILTER=TYPE==2,IS_SOME=TYPE==3,IS_EVERY=TYPE==4,IS_FIND_INDEX=TYPE==6,NO_HOLES=TYPE==5||IS_FIND_INDEX,create=$create||asc;return function($this,callbackfn,that){var O=toObject($this),self=IObject(O),f=ctx(callbackfn,that,3),length=toLength(self.length),index=0,result=IS_MAP?create($this,length):IS_FILTER?create($this,0):undefined,val,res;for(;length>index;index++){if(NO_HOLES||index in self){val=self[index];res=f(val,index,O);if(TYPE){if(IS_MAP)result[index]=res;// map
else if(res)switch(TYPE){case 3:return true;// some
case 5:return val;// find
case 6:return index;// findIndex
case 2:result.push(val);// filter
}else if(IS_EVERY)return false;// every
}}}return IS_FIND_INDEX?-1:IS_SOME||IS_EVERY?IS_EVERY:result;};};},{"./_array-species-create":68,"./_ctx":77,"./_iobject":92,"./_to-length":134,"./_to-object":135}],67:[function(_dereq_,module,exports){var isObject=_dereq_('./_is-object'),isArray=_dereq_('./_is-array'),SPECIES=_dereq_('./_wks')('species');module.exports=function(original){var C;if(isArray(original)){C=original.constructor;// cross-realm fallback
if(typeof C=='function'&&(C===Array||isArray(C.prototype)))C=undefined;if(isObject(C)){C=C[SPECIES];if(C===null)C=undefined;}}return C===undefined?Array:C;};},{"./_is-array":94,"./_is-object":96,"./_wks":140}],68:[function(_dereq_,module,exports){// 9.4.2.3 ArraySpeciesCreate(originalArray, length)
var speciesConstructor=_dereq_('./_array-species-constructor');module.exports=function(original,length){return new(speciesConstructor(original))(length);};},{"./_array-species-constructor":67}],69:[function(_dereq_,module,exports){'use strict';var aFunction=_dereq_('./_a-function'),isObject=_dereq_('./_is-object'),invoke=_dereq_('./_invoke'),arraySlice=[].slice,factories={};var construct=function construct(F,len,args){if(!(len in factories)){for(var n=[],i=0;i<len;i++){n[i]='a['+i+']';}factories[len]=Function('F,a','return new F('+n.join(',')+')');}return factories[len](F,args);};module.exports=Function.bind||function bind(that/*, args... */){var fn=aFunction(this),partArgs=arraySlice.call(arguments,1);var bound=function bound()/* args... */{var args=partArgs.concat(arraySlice.call(arguments));return this instanceof bound?construct(fn,args.length,args):invoke(fn,args,that);};if(isObject(fn.prototype))bound.prototype=fn.prototype;return bound;};},{"./_a-function":60,"./_invoke":91,"./_is-object":96}],70:[function(_dereq_,module,exports){// getting tag from 19.1.3.6 Object.prototype.toString()
var cof=_dereq_('./_cof'),TAG=_dereq_('./_wks')('toStringTag')// ES3 wrong here
,ARG=cof(function(){return arguments;}())=='Arguments';// fallback for IE11 Script Access Denied error
var tryGet=function tryGet(it,key){try{return it[key];}catch(e){/* empty */}};module.exports=function(it){var O,T,B;return it===undefined?'Undefined':it===null?'Null'// @@toStringTag case
:typeof(T=tryGet(O=Object(it),TAG))=='string'?T// builtinTag case
:ARG?cof(O)// ES3 arguments fallback
:(B=cof(O))=='Object'&&typeof O.callee=='function'?'Arguments':B;};},{"./_cof":71,"./_wks":140}],71:[function(_dereq_,module,exports){var toString={}.toString;module.exports=function(it){return toString.call(it).slice(8,-1);};},{}],72:[function(_dereq_,module,exports){'use strict';var dP=_dereq_('./_object-dp').f,create=_dereq_('./_object-create'),redefineAll=_dereq_('./_redefine-all'),ctx=_dereq_('./_ctx'),anInstance=_dereq_('./_an-instance'),defined=_dereq_('./_defined'),forOf=_dereq_('./_for-of'),$iterDefine=_dereq_('./_iter-define'),step=_dereq_('./_iter-step'),setSpecies=_dereq_('./_set-species'),DESCRIPTORS=_dereq_('./_descriptors'),fastKey=_dereq_('./_meta').fastKey,SIZE=DESCRIPTORS?'_s':'size';var getEntry=function getEntry(that,key){// fast case
var index=fastKey(key),entry;if(index!=='F')return that._i[index];// frozen object case
for(entry=that._f;entry;entry=entry.n){if(entry.k==key)return entry;}};module.exports={getConstructor:function getConstructor(wrapper,NAME,IS_MAP,ADDER){var C=wrapper(function(that,iterable){anInstance(that,C,NAME,'_i');that._i=create(null);// index
that._f=undefined;// first entry
that._l=undefined;// last entry
that[SIZE]=0;// size
if(iterable!=undefined)forOf(iterable,IS_MAP,that[ADDER],that);});redefineAll(C.prototype,{// 23.1.3.1 Map.prototype.clear()
// 23.2.3.2 Set.prototype.clear()
clear:function clear(){for(var that=this,data=that._i,entry=that._f;entry;entry=entry.n){entry.r=true;if(entry.p)entry.p=entry.p.n=undefined;delete data[entry.i];}that._f=that._l=undefined;that[SIZE]=0;},// 23.1.3.3 Map.prototype.delete(key)
// 23.2.3.4 Set.prototype.delete(value)
'delete':function _delete(key){var that=this,entry=getEntry(that,key);if(entry){var next=entry.n,prev=entry.p;delete that._i[entry.i];entry.r=true;if(prev)prev.n=next;if(next)next.p=prev;if(that._f==entry)that._f=next;if(that._l==entry)that._l=prev;that[SIZE]--;}return!!entry;},// 23.2.3.6 Set.prototype.forEach(callbackfn, thisArg = undefined)
// 23.1.3.5 Map.prototype.forEach(callbackfn, thisArg = undefined)
forEach:function forEach(callbackfn/*, that = undefined */){anInstance(this,C,'forEach');var f=ctx(callbackfn,arguments.length>1?arguments[1]:undefined,3),entry;while(entry=entry?entry.n:this._f){f(entry.v,entry.k,this);// revert to the last existing entry
while(entry&&entry.r){entry=entry.p;}}},// 23.1.3.7 Map.prototype.has(key)
// 23.2.3.7 Set.prototype.has(value)
has:function has(key){return!!getEntry(this,key);}});if(DESCRIPTORS)dP(C.prototype,'size',{get:function get(){return defined(this[SIZE]);}});return C;},def:function def(that,key,value){var entry=getEntry(that,key),prev,index;// change existing entry
if(entry){entry.v=value;// create new entry
}else{that._l=entry={i:index=fastKey(key,true),// <- index
k:key,// <- key
v:value,// <- value
p:prev=that._l,// <- previous entry
n:undefined,// <- next entry
r:false// <- removed
};if(!that._f)that._f=entry;if(prev)prev.n=entry;that[SIZE]++;// add to index
if(index!=='F')that._i[index]=entry;}return that;},getEntry:getEntry,setStrong:function setStrong(C,NAME,IS_MAP){// add .keys, .values, .entries, [@@iterator]
// 23.1.3.4, 23.1.3.8, 23.1.3.11, 23.1.3.12, 23.2.3.5, 23.2.3.8, 23.2.3.10, 23.2.3.11
$iterDefine(C,NAME,function(iterated,kind){this._t=iterated;// target
this._k=kind;// kind
this._l=undefined;// previous
},function(){var that=this,kind=that._k,entry=that._l;// revert to the last existing entry
while(entry&&entry.r){entry=entry.p;}// get next entry
if(!that._t||!(that._l=entry=entry?entry.n:that._t._f)){// or finish the iteration
that._t=undefined;return step(1);}// return step by kind
if(kind=='keys')return step(0,entry.k);if(kind=='values')return step(0,entry.v);return step(0,[entry.k,entry.v]);},IS_MAP?'entries':'values',!IS_MAP,true);// add [@@species], 23.1.2.2, 23.2.2.2
setSpecies(NAME);}};},{"./_an-instance":62,"./_ctx":77,"./_defined":78,"./_descriptors":79,"./_for-of":85,"./_iter-define":99,"./_iter-step":101,"./_meta":105,"./_object-create":108,"./_object-dp":109,"./_redefine-all":121,"./_set-species":124}],73:[function(_dereq_,module,exports){// https://github.com/DavidBruant/Map-Set.prototype.toJSON
var classof=_dereq_('./_classof'),from=_dereq_('./_array-from-iterable');module.exports=function(NAME){return function toJSON(){if(classof(this)!=NAME)throw TypeError(NAME+"#toJSON isn't generic");return from(this);};};},{"./_array-from-iterable":64,"./_classof":70}],74:[function(_dereq_,module,exports){'use strict';var global=_dereq_('./_global'),$export=_dereq_('./_export'),meta=_dereq_('./_meta'),fails=_dereq_('./_fails'),hide=_dereq_('./_hide'),redefineAll=_dereq_('./_redefine-all'),forOf=_dereq_('./_for-of'),anInstance=_dereq_('./_an-instance'),isObject=_dereq_('./_is-object'),setToStringTag=_dereq_('./_set-to-string-tag'),dP=_dereq_('./_object-dp').f,each=_dereq_('./_array-methods')(0),DESCRIPTORS=_dereq_('./_descriptors');module.exports=function(NAME,wrapper,methods,common,IS_MAP,IS_WEAK){var Base=global[NAME],C=Base,ADDER=IS_MAP?'set':'add',proto=C&&C.prototype,O={};if(!DESCRIPTORS||typeof C!='function'||!(IS_WEAK||proto.forEach&&!fails(function(){new C().entries().next();}))){// create collection constructor
C=common.getConstructor(wrapper,NAME,IS_MAP,ADDER);redefineAll(C.prototype,methods);meta.NEED=true;}else{C=wrapper(function(target,iterable){anInstance(target,C,NAME,'_c');target._c=new Base();if(iterable!=undefined)forOf(iterable,IS_MAP,target[ADDER],target);});each('add,clear,delete,forEach,get,has,set,keys,values,entries,toJSON'.split(','),function(KEY){var IS_ADDER=KEY=='add'||KEY=='set';if(KEY in proto&&!(IS_WEAK&&KEY=='clear'))hide(C.prototype,KEY,function(a,b){anInstance(this,C,KEY);if(!IS_ADDER&&IS_WEAK&&!isObject(a))return KEY=='get'?undefined:false;var result=this._c[KEY](a===0?0:a,b);return IS_ADDER?this:result;});});if('size'in proto)dP(C.prototype,'size',{get:function get(){return this._c.size;}});}setToStringTag(C,NAME);O[NAME]=C;$export($export.G+$export.W+$export.F,O);if(!IS_WEAK)common.setStrong(C,NAME,IS_MAP);return C;};},{"./_an-instance":62,"./_array-methods":66,"./_descriptors":79,"./_export":83,"./_fails":84,"./_for-of":85,"./_global":86,"./_hide":88,"./_is-object":96,"./_meta":105,"./_object-dp":109,"./_redefine-all":121,"./_set-to-string-tag":125}],75:[function(_dereq_,module,exports){var core=module.exports={version:'2.4.0'};if(typeof __e=='number')__e=core;// eslint-disable-line no-undef
},{}],76:[function(_dereq_,module,exports){'use strict';var $defineProperty=_dereq_('./_object-dp'),createDesc=_dereq_('./_property-desc');module.exports=function(object,index,value){if(index in object)$defineProperty.f(object,index,createDesc(0,value));else object[index]=value;};},{"./_object-dp":109,"./_property-desc":120}],77:[function(_dereq_,module,exports){// optional / simple context binding
var aFunction=_dereq_('./_a-function');module.exports=function(fn,that,length){aFunction(fn);if(that===undefined)return fn;switch(length){case 1:return function(a){return fn.call(that,a);};case 2:return function(a,b){return fn.call(that,a,b);};case 3:return function(a,b,c){return fn.call(that,a,b,c);};}return function()/* ...args */{return fn.apply(that,arguments);};};},{"./_a-function":60}],78:[function(_dereq_,module,exports){// 7.2.1 RequireObjectCoercible(argument)
module.exports=function(it){if(it==undefined)throw TypeError("Can't call method on  "+it);return it;};},{}],79:[function(_dereq_,module,exports){// Thank's IE8 for his funny defineProperty
module.exports=!_dereq_('./_fails')(function(){return Object.defineProperty({},'a',{get:function get(){return 7;}}).a!=7;});},{"./_fails":84}],80:[function(_dereq_,module,exports){var isObject=_dereq_('./_is-object'),document=_dereq_('./_global').document// in old IE typeof document.createElement is 'object'
,is=isObject(document)&&isObject(document.createElement);module.exports=function(it){return is?document.createElement(it):{};};},{"./_global":86,"./_is-object":96}],81:[function(_dereq_,module,exports){// IE 8- don't enum bug keys
module.exports='constructor,hasOwnProperty,isPrototypeOf,propertyIsEnumerable,toLocaleString,toString,valueOf'.split(',');},{}],82:[function(_dereq_,module,exports){// all enumerable object keys, includes symbols
var getKeys=_dereq_('./_object-keys'),gOPS=_dereq_('./_object-gops'),pIE=_dereq_('./_object-pie');module.exports=function(it){var result=getKeys(it),getSymbols=gOPS.f;if(getSymbols){var symbols=getSymbols(it),isEnum=pIE.f,i=0,key;while(symbols.length>i){if(isEnum.call(it,key=symbols[i++]))result.push(key);}}return result;};},{"./_object-gops":114,"./_object-keys":117,"./_object-pie":118}],83:[function(_dereq_,module,exports){var global=_dereq_('./_global'),core=_dereq_('./_core'),ctx=_dereq_('./_ctx'),hide=_dereq_('./_hide'),PROTOTYPE='prototype';var $export=function $export(type,name,source){var IS_FORCED=type&$export.F,IS_GLOBAL=type&$export.G,IS_STATIC=type&$export.S,IS_PROTO=type&$export.P,IS_BIND=type&$export.B,IS_WRAP=type&$export.W,exports=IS_GLOBAL?core:core[name]||(core[name]={}),expProto=exports[PROTOTYPE],target=IS_GLOBAL?global:IS_STATIC?global[name]:(global[name]||{})[PROTOTYPE],key,own,out;if(IS_GLOBAL)source=name;for(key in source){// contains in native
own=!IS_FORCED&&target&&target[key]!==undefined;if(own&&key in exports)continue;// export native or passed
out=own?target[key]:source[key];// prevent global pollution for namespaces
exports[key]=IS_GLOBAL&&typeof target[key]!='function'?source[key]// bind timers to global for call from export context
:IS_BIND&&own?ctx(out,global)// wrap global constructors for prevent change them in library
:IS_WRAP&&target[key]==out?function(C){var F=function F(a,b,c){if(this instanceof C){switch(arguments.length){case 0:return new C();case 1:return new C(a);case 2:return new C(a,b);}return new C(a,b,c);}return C.apply(this,arguments);};F[PROTOTYPE]=C[PROTOTYPE];return F;// make static versions for prototype methods
}(out):IS_PROTO&&typeof out=='function'?ctx(Function.call,out):out;// export proto methods to core.%CONSTRUCTOR%.methods.%NAME%
if(IS_PROTO){(exports.virtual||(exports.virtual={}))[key]=out;// export proto methods to core.%CONSTRUCTOR%.prototype.%NAME%
if(type&$export.R&&expProto&&!expProto[key])hide(expProto,key,out);}}};// type bitmap
$export.F=1;// forced
$export.G=2;// global
$export.S=4;// static
$export.P=8;// proto
$export.B=16;// bind
$export.W=32;// wrap
$export.U=64;// safe
$export.R=128;// real proto method for `library` 
module.exports=$export;},{"./_core":75,"./_ctx":77,"./_global":86,"./_hide":88}],84:[function(_dereq_,module,exports){module.exports=function(exec){try{return!!exec();}catch(e){return true;}};},{}],85:[function(_dereq_,module,exports){var ctx=_dereq_('./_ctx'),call=_dereq_('./_iter-call'),isArrayIter=_dereq_('./_is-array-iter'),anObject=_dereq_('./_an-object'),toLength=_dereq_('./_to-length'),getIterFn=_dereq_('./core.get-iterator-method'),BREAK={},RETURN={};var exports=module.exports=function(iterable,entries,fn,that,ITERATOR){var iterFn=ITERATOR?function(){return iterable;}:getIterFn(iterable),f=ctx(fn,that,entries?2:1),index=0,length,step,iterator,result;if(typeof iterFn!='function')throw TypeError(iterable+' is not iterable!');// fast case for arrays with default iterator
if(isArrayIter(iterFn))for(length=toLength(iterable.length);length>index;index++){result=entries?f(anObject(step=iterable[index])[0],step[1]):f(iterable[index]);if(result===BREAK||result===RETURN)return result;}else for(iterator=iterFn.call(iterable);!(step=iterator.next()).done;){result=call(iterator,f,step.value,entries);if(result===BREAK||result===RETURN)return result;}};exports.BREAK=BREAK;exports.RETURN=RETURN;},{"./_an-object":63,"./_ctx":77,"./_is-array-iter":93,"./_iter-call":97,"./_to-length":134,"./core.get-iterator-method":141}],86:[function(_dereq_,module,exports){// https://github.com/zloirock/core-js/issues/86#issuecomment-115759028
var global=module.exports=typeof window!='undefined'&&window.Math==Math?window:typeof self!='undefined'&&self.Math==Math?self:Function('return this')();if(typeof __g=='number')__g=global;// eslint-disable-line no-undef
},{}],87:[function(_dereq_,module,exports){var hasOwnProperty={}.hasOwnProperty;module.exports=function(it,key){return hasOwnProperty.call(it,key);};},{}],88:[function(_dereq_,module,exports){var dP=_dereq_('./_object-dp'),createDesc=_dereq_('./_property-desc');module.exports=_dereq_('./_descriptors')?function(object,key,value){return dP.f(object,key,createDesc(1,value));}:function(object,key,value){object[key]=value;return object;};},{"./_descriptors":79,"./_object-dp":109,"./_property-desc":120}],89:[function(_dereq_,module,exports){module.exports=_dereq_('./_global').document&&document.documentElement;},{"./_global":86}],90:[function(_dereq_,module,exports){module.exports=!_dereq_('./_descriptors')&&!_dereq_('./_fails')(function(){return Object.defineProperty(_dereq_('./_dom-create')('div'),'a',{get:function get(){return 7;}}).a!=7;});},{"./_descriptors":79,"./_dom-create":80,"./_fails":84}],91:[function(_dereq_,module,exports){// fast apply, http://jsperf.lnkit.com/fast-apply/5
module.exports=function(fn,args,that){var un=that===undefined;switch(args.length){case 0:return un?fn():fn.call(that);case 1:return un?fn(args[0]):fn.call(that,args[0]);case 2:return un?fn(args[0],args[1]):fn.call(that,args[0],args[1]);case 3:return un?fn(args[0],args[1],args[2]):fn.call(that,args[0],args[1],args[2]);case 4:return un?fn(args[0],args[1],args[2],args[3]):fn.call(that,args[0],args[1],args[2],args[3]);}return fn.apply(that,args);};},{}],92:[function(_dereq_,module,exports){// fallback for non-array-like ES3 and non-enumerable old V8 strings
var cof=_dereq_('./_cof');module.exports=Object('z').propertyIsEnumerable(0)?Object:function(it){return cof(it)=='String'?it.split(''):Object(it);};},{"./_cof":71}],93:[function(_dereq_,module,exports){// check on default Array iterator
var Iterators=_dereq_('./_iterators'),ITERATOR=_dereq_('./_wks')('iterator'),ArrayProto=Array.prototype;module.exports=function(it){return it!==undefined&&(Iterators.Array===it||ArrayProto[ITERATOR]===it);};},{"./_iterators":102,"./_wks":140}],94:[function(_dereq_,module,exports){// 7.2.2 IsArray(argument)
var cof=_dereq_('./_cof');module.exports=Array.isArray||function isArray(arg){return cof(arg)=='Array';};},{"./_cof":71}],95:[function(_dereq_,module,exports){// 20.1.2.3 Number.isInteger(number)
var isObject=_dereq_('./_is-object'),floor=Math.floor;module.exports=function isInteger(it){return!isObject(it)&&isFinite(it)&&floor(it)===it;};},{"./_is-object":96}],96:[function(_dereq_,module,exports){module.exports=function(it){return(typeof it==="undefined"?"undefined":_typeof4(it))==='object'?it!==null:typeof it==='function';};},{}],97:[function(_dereq_,module,exports){// call something on iterator step with safe closing on error
var anObject=_dereq_('./_an-object');module.exports=function(iterator,fn,value,entries){try{return entries?fn(anObject(value)[0],value[1]):fn(value);// 7.4.6 IteratorClose(iterator, completion)
}catch(e){var ret=iterator['return'];if(ret!==undefined)anObject(ret.call(iterator));throw e;}};},{"./_an-object":63}],98:[function(_dereq_,module,exports){'use strict';var create=_dereq_('./_object-create'),descriptor=_dereq_('./_property-desc'),setToStringTag=_dereq_('./_set-to-string-tag'),IteratorPrototype={};// 25.1.2.1.1 %IteratorPrototype%[@@iterator]()
_dereq_('./_hide')(IteratorPrototype,_dereq_('./_wks')('iterator'),function(){return this;});module.exports=function(Constructor,NAME,next){Constructor.prototype=create(IteratorPrototype,{next:descriptor(1,next)});setToStringTag(Constructor,NAME+' Iterator');};},{"./_hide":88,"./_object-create":108,"./_property-desc":120,"./_set-to-string-tag":125,"./_wks":140}],99:[function(_dereq_,module,exports){'use strict';var LIBRARY=_dereq_('./_library'),$export=_dereq_('./_export'),redefine=_dereq_('./_redefine'),hide=_dereq_('./_hide'),has=_dereq_('./_has'),Iterators=_dereq_('./_iterators'),$iterCreate=_dereq_('./_iter-create'),setToStringTag=_dereq_('./_set-to-string-tag'),getPrototypeOf=_dereq_('./_object-gpo'),ITERATOR=_dereq_('./_wks')('iterator'),BUGGY=!([].keys&&'next'in[].keys())// Safari has buggy iterators w/o `next`
,FF_ITERATOR='@@iterator',KEYS='keys',VALUES='values';var returnThis=function returnThis(){return this;};module.exports=function(Base,NAME,Constructor,next,DEFAULT,IS_SET,FORCED){$iterCreate(Constructor,NAME,next);var getMethod=function getMethod(kind){if(!BUGGY&&kind in proto)return proto[kind];switch(kind){case KEYS:return function keys(){return new Constructor(this,kind);};case VALUES:return function values(){return new Constructor(this,kind);};}return function entries(){return new Constructor(this,kind);};};var TAG=NAME+' Iterator',DEF_VALUES=DEFAULT==VALUES,VALUES_BUG=false,proto=Base.prototype,$native=proto[ITERATOR]||proto[FF_ITERATOR]||DEFAULT&&proto[DEFAULT],$default=$native||getMethod(DEFAULT),$entries=DEFAULT?!DEF_VALUES?$default:getMethod('entries'):undefined,$anyNative=NAME=='Array'?proto.entries||$native:$native,methods,key,IteratorPrototype;// Fix native
if($anyNative){IteratorPrototype=getPrototypeOf($anyNative.call(new Base()));if(IteratorPrototype!==Object.prototype){// Set @@toStringTag to native iterators
setToStringTag(IteratorPrototype,TAG,true);// fix for some old engines
if(!LIBRARY&&!has(IteratorPrototype,ITERATOR))hide(IteratorPrototype,ITERATOR,returnThis);}}// fix Array#{values, @@iterator}.name in V8 / FF
if(DEF_VALUES&&$native&&$native.name!==VALUES){VALUES_BUG=true;$default=function values(){return $native.call(this);};}// Define iterator
if((!LIBRARY||FORCED)&&(BUGGY||VALUES_BUG||!proto[ITERATOR])){hide(proto,ITERATOR,$default);}// Plug for library
Iterators[NAME]=$default;Iterators[TAG]=returnThis;if(DEFAULT){methods={values:DEF_VALUES?$default:getMethod(VALUES),keys:IS_SET?$default:getMethod(KEYS),entries:$entries};if(FORCED)for(key in methods){if(!(key in proto))redefine(proto,key,methods[key]);}else $export($export.P+$export.F*(BUGGY||VALUES_BUG),NAME,methods);}return methods;};},{"./_export":83,"./_has":87,"./_hide":88,"./_iter-create":98,"./_iterators":102,"./_library":104,"./_object-gpo":115,"./_redefine":122,"./_set-to-string-tag":125,"./_wks":140}],100:[function(_dereq_,module,exports){var ITERATOR=_dereq_('./_wks')('iterator'),SAFE_CLOSING=false;try{var riter=[7][ITERATOR]();riter['return']=function(){SAFE_CLOSING=true;};Array.from(riter,function(){throw 2;});}catch(e){/* empty */}module.exports=function(exec,skipClosing){if(!skipClosing&&!SAFE_CLOSING)return false;var safe=false;try{var arr=[7],iter=arr[ITERATOR]();iter.next=function(){return{done:safe=true};};arr[ITERATOR]=function(){return iter;};exec(arr);}catch(e){/* empty */}return safe;};},{"./_wks":140}],101:[function(_dereq_,module,exports){module.exports=function(done,value){return{value:value,done:!!done};};},{}],102:[function(_dereq_,module,exports){module.exports={};},{}],103:[function(_dereq_,module,exports){var getKeys=_dereq_('./_object-keys'),toIObject=_dereq_('./_to-iobject');module.exports=function(object,el){var O=toIObject(object),keys=getKeys(O),length=keys.length,index=0,key;while(length>index){if(O[key=keys[index++]]===el)return key;}};},{"./_object-keys":117,"./_to-iobject":133}],104:[function(_dereq_,module,exports){module.exports=true;},{}],105:[function(_dereq_,module,exports){var META=_dereq_('./_uid')('meta'),isObject=_dereq_('./_is-object'),has=_dereq_('./_has'),setDesc=_dereq_('./_object-dp').f,id=0;var isExtensible=Object.isExtensible||function(){return true;};var FREEZE=!_dereq_('./_fails')(function(){return isExtensible(Object.preventExtensions({}));});var setMeta=function setMeta(it){setDesc(it,META,{value:{i:'O'+ ++id,// object ID
w:{}// weak collections IDs
}});};var fastKey=function fastKey(it,create){// return primitive with prefix
if(!isObject(it))return(typeof it==="undefined"?"undefined":_typeof4(it))=='symbol'?it:(typeof it=='string'?'S':'P')+it;if(!has(it,META)){// can't set metadata to uncaught frozen object
if(!isExtensible(it))return'F';// not necessary to add metadata
if(!create)return'E';// add missing metadata
setMeta(it);// return object ID
}return it[META].i;};var getWeak=function getWeak(it,create){if(!has(it,META)){// can't set metadata to uncaught frozen object
if(!isExtensible(it))return true;// not necessary to add metadata
if(!create)return false;// add missing metadata
setMeta(it);// return hash weak collections IDs
}return it[META].w;};// add metadata on freeze-family methods calling
var onFreeze=function onFreeze(it){if(FREEZE&&meta.NEED&&isExtensible(it)&&!has(it,META))setMeta(it);return it;};var meta=module.exports={KEY:META,NEED:false,fastKey:fastKey,getWeak:getWeak,onFreeze:onFreeze};},{"./_fails":84,"./_has":87,"./_is-object":96,"./_object-dp":109,"./_uid":137}],106:[function(_dereq_,module,exports){var global=_dereq_('./_global'),macrotask=_dereq_('./_task').set,Observer=global.MutationObserver||global.WebKitMutationObserver,process=global.process,Promise=global.Promise,isNode=_dereq_('./_cof')(process)=='process';module.exports=function(){var head,last,notify;var flush=function flush(){var parent,fn;if(isNode&&(parent=process.domain))parent.exit();while(head){fn=head.fn;head=head.next;try{fn();}catch(e){if(head)notify();else last=undefined;throw e;}}last=undefined;if(parent)parent.enter();};// Node.js
if(isNode){notify=function notify(){process.nextTick(flush);};// browsers with MutationObserver
}else if(Observer){var toggle=true,node=document.createTextNode('');new Observer(flush).observe(node,{characterData:true});// eslint-disable-line no-new
notify=function notify(){node.data=toggle=!toggle;};// environments with maybe non-completely correct, but existent Promise
}else if(Promise&&Promise.resolve){var promise=Promise.resolve();notify=function notify(){promise.then(flush);};// for other environments - macrotask based on:
// - setImmediate
// - MessageChannel
// - window.postMessag
// - onreadystatechange
// - setTimeout
}else{notify=function notify(){// strange IE + webpack dev server bug - use .call(global)
macrotask.call(global,flush);};}return function(fn){var task={fn:fn,next:undefined};if(last)last.next=task;if(!head){head=task;notify();}last=task;};};},{"./_cof":71,"./_global":86,"./_task":130}],107:[function(_dereq_,module,exports){'use strict';// 19.1.2.1 Object.assign(target, source, ...)
var getKeys=_dereq_('./_object-keys'),gOPS=_dereq_('./_object-gops'),pIE=_dereq_('./_object-pie'),toObject=_dereq_('./_to-object'),IObject=_dereq_('./_iobject'),$assign=Object.assign;// should work with symbols and should have deterministic property order (V8 bug)
module.exports=!$assign||_dereq_('./_fails')(function(){var A={},B={},S=Symbol(),K='abcdefghijklmnopqrst';A[S]=7;K.split('').forEach(function(k){B[k]=k;});return $assign({},A)[S]!=7||Object.keys($assign({},B)).join('')!=K;})?function assign(target,source){// eslint-disable-line no-unused-vars
var T=toObject(target),aLen=arguments.length,index=1,getSymbols=gOPS.f,isEnum=pIE.f;while(aLen>index){var S=IObject(arguments[index++]),keys=getSymbols?getKeys(S).concat(getSymbols(S)):getKeys(S),length=keys.length,j=0,key;while(length>j){if(isEnum.call(S,key=keys[j++]))T[key]=S[key];}}return T;}:$assign;},{"./_fails":84,"./_iobject":92,"./_object-gops":114,"./_object-keys":117,"./_object-pie":118,"./_to-object":135}],108:[function(_dereq_,module,exports){// 19.1.2.2 / 15.2.3.5 Object.create(O [, Properties])
var anObject=_dereq_('./_an-object'),dPs=_dereq_('./_object-dps'),enumBugKeys=_dereq_('./_enum-bug-keys'),IE_PROTO=_dereq_('./_shared-key')('IE_PROTO'),Empty=function Empty(){/* empty */},PROTOTYPE='prototype';// Create object with fake `null` prototype: use iframe Object with cleared prototype
var _createDict=function createDict(){// Thrash, waste and sodomy: IE GC bug
var iframe=_dereq_('./_dom-create')('iframe'),i=enumBugKeys.length,lt='<',gt='>',iframeDocument;iframe.style.display='none';_dereq_('./_html').appendChild(iframe);iframe.src='javascript:';// eslint-disable-line no-script-url
// createDict = iframe.contentWindow.Object;
// html.removeChild(iframe);
iframeDocument=iframe.contentWindow.document;iframeDocument.open();iframeDocument.write(lt+'script'+gt+'document.F=Object'+lt+'/script'+gt);iframeDocument.close();_createDict=iframeDocument.F;while(i--){delete _createDict[PROTOTYPE][enumBugKeys[i]];}return _createDict();};module.exports=Object.create||function create(O,Properties){var result;if(O!==null){Empty[PROTOTYPE]=anObject(O);result=new Empty();Empty[PROTOTYPE]=null;// add "__proto__" for Object.getPrototypeOf polyfill
result[IE_PROTO]=O;}else result=_createDict();return Properties===undefined?result:dPs(result,Properties);};},{"./_an-object":63,"./_dom-create":80,"./_enum-bug-keys":81,"./_html":89,"./_object-dps":110,"./_shared-key":126}],109:[function(_dereq_,module,exports){var anObject=_dereq_('./_an-object'),IE8_DOM_DEFINE=_dereq_('./_ie8-dom-define'),toPrimitive=_dereq_('./_to-primitive'),dP=Object.defineProperty;exports.f=_dereq_('./_descriptors')?Object.defineProperty:function defineProperty(O,P,Attributes){anObject(O);P=toPrimitive(P,true);anObject(Attributes);if(IE8_DOM_DEFINE)try{return dP(O,P,Attributes);}catch(e){/* empty */}if('get'in Attributes||'set'in Attributes)throw TypeError('Accessors not supported!');if('value'in Attributes)O[P]=Attributes.value;return O;};},{"./_an-object":63,"./_descriptors":79,"./_ie8-dom-define":90,"./_to-primitive":136}],110:[function(_dereq_,module,exports){var dP=_dereq_('./_object-dp'),anObject=_dereq_('./_an-object'),getKeys=_dereq_('./_object-keys');module.exports=_dereq_('./_descriptors')?Object.defineProperties:function defineProperties(O,Properties){anObject(O);var keys=getKeys(Properties),length=keys.length,i=0,P;while(length>i){dP.f(O,P=keys[i++],Properties[P]);}return O;};},{"./_an-object":63,"./_descriptors":79,"./_object-dp":109,"./_object-keys":117}],111:[function(_dereq_,module,exports){var pIE=_dereq_('./_object-pie'),createDesc=_dereq_('./_property-desc'),toIObject=_dereq_('./_to-iobject'),toPrimitive=_dereq_('./_to-primitive'),has=_dereq_('./_has'),IE8_DOM_DEFINE=_dereq_('./_ie8-dom-define'),gOPD=Object.getOwnPropertyDescriptor;exports.f=_dereq_('./_descriptors')?gOPD:function getOwnPropertyDescriptor(O,P){O=toIObject(O);P=toPrimitive(P,true);if(IE8_DOM_DEFINE)try{return gOPD(O,P);}catch(e){/* empty */}if(has(O,P))return createDesc(!pIE.f.call(O,P),O[P]);};},{"./_descriptors":79,"./_has":87,"./_ie8-dom-define":90,"./_object-pie":118,"./_property-desc":120,"./_to-iobject":133,"./_to-primitive":136}],112:[function(_dereq_,module,exports){// fallback for IE11 buggy Object.getOwnPropertyNames with iframe and window
var toIObject=_dereq_('./_to-iobject'),gOPN=_dereq_('./_object-gopn').f,toString={}.toString;var windowNames=(typeof window==="undefined"?"undefined":_typeof4(window))=='object'&&window&&Object.getOwnPropertyNames?Object.getOwnPropertyNames(window):[];var getWindowNames=function getWindowNames(it){try{return gOPN(it);}catch(e){return windowNames.slice();}};module.exports.f=function getOwnPropertyNames(it){return windowNames&&toString.call(it)=='[object Window]'?getWindowNames(it):gOPN(toIObject(it));};},{"./_object-gopn":113,"./_to-iobject":133}],113:[function(_dereq_,module,exports){// 19.1.2.7 / 15.2.3.4 Object.getOwnPropertyNames(O)
var $keys=_dereq_('./_object-keys-internal'),hiddenKeys=_dereq_('./_enum-bug-keys').concat('length','prototype');exports.f=Object.getOwnPropertyNames||function getOwnPropertyNames(O){return $keys(O,hiddenKeys);};},{"./_enum-bug-keys":81,"./_object-keys-internal":116}],114:[function(_dereq_,module,exports){exports.f=Object.getOwnPropertySymbols;},{}],115:[function(_dereq_,module,exports){// 19.1.2.9 / 15.2.3.2 Object.getPrototypeOf(O)
var has=_dereq_('./_has'),toObject=_dereq_('./_to-object'),IE_PROTO=_dereq_('./_shared-key')('IE_PROTO'),ObjectProto=Object.prototype;module.exports=Object.getPrototypeOf||function(O){O=toObject(O);if(has(O,IE_PROTO))return O[IE_PROTO];if(typeof O.constructor=='function'&&O instanceof O.constructor){return O.constructor.prototype;}return O instanceof Object?ObjectProto:null;};},{"./_has":87,"./_shared-key":126,"./_to-object":135}],116:[function(_dereq_,module,exports){var has=_dereq_('./_has'),toIObject=_dereq_('./_to-iobject'),arrayIndexOf=_dereq_('./_array-includes')(false),IE_PROTO=_dereq_('./_shared-key')('IE_PROTO');module.exports=function(object,names){var O=toIObject(object),i=0,result=[],key;for(key in O){if(key!=IE_PROTO)has(O,key)&&result.push(key);}// Don't enum bug & hidden keys
while(names.length>i){if(has(O,key=names[i++])){~arrayIndexOf(result,key)||result.push(key);}}return result;};},{"./_array-includes":65,"./_has":87,"./_shared-key":126,"./_to-iobject":133}],117:[function(_dereq_,module,exports){// 19.1.2.14 / 15.2.3.14 Object.keys(O)
var $keys=_dereq_('./_object-keys-internal'),enumBugKeys=_dereq_('./_enum-bug-keys');module.exports=Object.keys||function keys(O){return $keys(O,enumBugKeys);};},{"./_enum-bug-keys":81,"./_object-keys-internal":116}],118:[function(_dereq_,module,exports){exports.f={}.propertyIsEnumerable;},{}],119:[function(_dereq_,module,exports){// most Object methods by ES6 should accept primitives
var $export=_dereq_('./_export'),core=_dereq_('./_core'),fails=_dereq_('./_fails');module.exports=function(KEY,exec){var fn=(core.Object||{})[KEY]||Object[KEY],exp={};exp[KEY]=exec(fn);$export($export.S+$export.F*fails(function(){fn(1);}),'Object',exp);};},{"./_core":75,"./_export":83,"./_fails":84}],120:[function(_dereq_,module,exports){module.exports=function(bitmap,value){return{enumerable:!(bitmap&1),configurable:!(bitmap&2),writable:!(bitmap&4),value:value};};},{}],121:[function(_dereq_,module,exports){var hide=_dereq_('./_hide');module.exports=function(target,src,safe){for(var key in src){if(safe&&target[key])target[key]=src[key];else hide(target,key,src[key]);}return target;};},{"./_hide":88}],122:[function(_dereq_,module,exports){module.exports=_dereq_('./_hide');},{"./_hide":88}],123:[function(_dereq_,module,exports){// Works with __proto__ only. Old v8 can't work with null proto objects.
/* eslint-disable no-proto */var isObject=_dereq_('./_is-object'),anObject=_dereq_('./_an-object');var check=function check(O,proto){anObject(O);if(!isObject(proto)&&proto!==null)throw TypeError(proto+": can't set as prototype!");};module.exports={set:Object.setPrototypeOf||('__proto__'in{}?// eslint-disable-line
function(test,buggy,set){try{set=_dereq_('./_ctx')(Function.call,_dereq_('./_object-gopd').f(Object.prototype,'__proto__').set,2);set(test,[]);buggy=!(test instanceof Array);}catch(e){buggy=true;}return function setPrototypeOf(O,proto){check(O,proto);if(buggy)O.__proto__=proto;else set(O,proto);return O;};}({},false):undefined),check:check};},{"./_an-object":63,"./_ctx":77,"./_is-object":96,"./_object-gopd":111}],124:[function(_dereq_,module,exports){'use strict';var global=_dereq_('./_global'),core=_dereq_('./_core'),dP=_dereq_('./_object-dp'),DESCRIPTORS=_dereq_('./_descriptors'),SPECIES=_dereq_('./_wks')('species');module.exports=function(KEY){var C=typeof core[KEY]=='function'?core[KEY]:global[KEY];if(DESCRIPTORS&&C&&!C[SPECIES])dP.f(C,SPECIES,{configurable:true,get:function get(){return this;}});};},{"./_core":75,"./_descriptors":79,"./_global":86,"./_object-dp":109,"./_wks":140}],125:[function(_dereq_,module,exports){var def=_dereq_('./_object-dp').f,has=_dereq_('./_has'),TAG=_dereq_('./_wks')('toStringTag');module.exports=function(it,tag,stat){if(it&&!has(it=stat?it:it.prototype,TAG))def(it,TAG,{configurable:true,value:tag});};},{"./_has":87,"./_object-dp":109,"./_wks":140}],126:[function(_dereq_,module,exports){var shared=_dereq_('./_shared')('keys'),uid=_dereq_('./_uid');module.exports=function(key){return shared[key]||(shared[key]=uid(key));};},{"./_shared":127,"./_uid":137}],127:[function(_dereq_,module,exports){var global=_dereq_('./_global'),SHARED='__core-js_shared__',store=global[SHARED]||(global[SHARED]={});module.exports=function(key){return store[key]||(store[key]={});};},{"./_global":86}],128:[function(_dereq_,module,exports){// 7.3.20 SpeciesConstructor(O, defaultConstructor)
var anObject=_dereq_('./_an-object'),aFunction=_dereq_('./_a-function'),SPECIES=_dereq_('./_wks')('species');module.exports=function(O,D){var C=anObject(O).constructor,S;return C===undefined||(S=anObject(C)[SPECIES])==undefined?D:aFunction(S);};},{"./_a-function":60,"./_an-object":63,"./_wks":140}],129:[function(_dereq_,module,exports){var toInteger=_dereq_('./_to-integer'),defined=_dereq_('./_defined');// true  -> String#at
// false -> String#codePointAt
module.exports=function(TO_STRING){return function(that,pos){var s=String(defined(that)),i=toInteger(pos),l=s.length,a,b;if(i<0||i>=l)return TO_STRING?'':undefined;a=s.charCodeAt(i);return a<0xd800||a>0xdbff||i+1===l||(b=s.charCodeAt(i+1))<0xdc00||b>0xdfff?TO_STRING?s.charAt(i):a:TO_STRING?s.slice(i,i+2):(a-0xd800<<10)+(b-0xdc00)+0x10000;};};},{"./_defined":78,"./_to-integer":132}],130:[function(_dereq_,module,exports){var ctx=_dereq_('./_ctx'),invoke=_dereq_('./_invoke'),html=_dereq_('./_html'),cel=_dereq_('./_dom-create'),global=_dereq_('./_global'),process=global.process,setTask=global.setImmediate,clearTask=global.clearImmediate,MessageChannel=global.MessageChannel,counter=0,queue={},ONREADYSTATECHANGE='onreadystatechange',defer,channel,port;var run=function run(){var id=+this;if(queue.hasOwnProperty(id)){var fn=queue[id];delete queue[id];fn();}};var listener=function listener(event){run.call(event.data);};// Node.js 0.9+ & IE10+ has setImmediate, otherwise:
if(!setTask||!clearTask){setTask=function setImmediate(fn){var args=[],i=1;while(arguments.length>i){args.push(arguments[i++]);}queue[++counter]=function(){invoke(typeof fn=='function'?fn:Function(fn),args);};defer(counter);return counter;};clearTask=function clearImmediate(id){delete queue[id];};// Node.js 0.8-
if(_dereq_('./_cof')(process)=='process'){defer=function defer(id){process.nextTick(ctx(run,id,1));};// Browsers with MessageChannel, includes WebWorkers
}else if(MessageChannel){channel=new MessageChannel();port=channel.port2;channel.port1.onmessage=listener;defer=ctx(port.postMessage,port,1);// Browsers with postMessage, skip WebWorkers
// IE8 has postMessage, but it's sync & typeof its postMessage is 'object'
}else if(global.addEventListener&&typeof postMessage=='function'&&!global.importScripts){defer=function defer(id){global.postMessage(id+'','*');};global.addEventListener('message',listener,false);// IE8-
}else if(ONREADYSTATECHANGE in cel('script')){defer=function defer(id){html.appendChild(cel('script'))[ONREADYSTATECHANGE]=function(){html.removeChild(this);run.call(id);};};// Rest old browsers
}else{defer=function defer(id){setTimeout(ctx(run,id,1),0);};}}module.exports={set:setTask,clear:clearTask};},{"./_cof":71,"./_ctx":77,"./_dom-create":80,"./_global":86,"./_html":89,"./_invoke":91}],131:[function(_dereq_,module,exports){var toInteger=_dereq_('./_to-integer'),max=Math.max,min=Math.min;module.exports=function(index,length){index=toInteger(index);return index<0?max(index+length,0):min(index,length);};},{"./_to-integer":132}],132:[function(_dereq_,module,exports){// 7.1.4 ToInteger
var ceil=Math.ceil,floor=Math.floor;module.exports=function(it){return isNaN(it=+it)?0:(it>0?floor:ceil)(it);};},{}],133:[function(_dereq_,module,exports){// to indexed object, toObject with fallback for non-array-like ES3 strings
var IObject=_dereq_('./_iobject'),defined=_dereq_('./_defined');module.exports=function(it){return IObject(defined(it));};},{"./_defined":78,"./_iobject":92}],134:[function(_dereq_,module,exports){// 7.1.15 ToLength
var toInteger=_dereq_('./_to-integer'),min=Math.min;module.exports=function(it){return it>0?min(toInteger(it),0x1fffffffffffff):0;// pow(2, 53) - 1 == 9007199254740991
};},{"./_to-integer":132}],135:[function(_dereq_,module,exports){// 7.1.13 ToObject(argument)
var defined=_dereq_('./_defined');module.exports=function(it){return Object(defined(it));};},{"./_defined":78}],136:[function(_dereq_,module,exports){// 7.1.1 ToPrimitive(input [, PreferredType])
var isObject=_dereq_('./_is-object');// instead of the ES6 spec version, we didn't implement @@toPrimitive case
// and the second argument - flag - preferred type is a string
module.exports=function(it,S){if(!isObject(it))return it;var fn,val;if(S&&typeof(fn=it.toString)=='function'&&!isObject(val=fn.call(it)))return val;if(typeof(fn=it.valueOf)=='function'&&!isObject(val=fn.call(it)))return val;if(!S&&typeof(fn=it.toString)=='function'&&!isObject(val=fn.call(it)))return val;throw TypeError("Can't convert object to primitive value");};},{"./_is-object":96}],137:[function(_dereq_,module,exports){var id=0,px=Math.random();module.exports=function(key){return'Symbol('.concat(key===undefined?'':key,')_',(++id+px).toString(36));};},{}],138:[function(_dereq_,module,exports){var global=_dereq_('./_global'),core=_dereq_('./_core'),LIBRARY=_dereq_('./_library'),wksExt=_dereq_('./_wks-ext'),defineProperty=_dereq_('./_object-dp').f;module.exports=function(name){var $Symbol=core.Symbol||(core.Symbol=LIBRARY?{}:global.Symbol||{});if(name.charAt(0)!='_'&&!(name in $Symbol))defineProperty($Symbol,name,{value:wksExt.f(name)});};},{"./_core":75,"./_global":86,"./_library":104,"./_object-dp":109,"./_wks-ext":139}],139:[function(_dereq_,module,exports){exports.f=_dereq_('./_wks');},{"./_wks":140}],140:[function(_dereq_,module,exports){var store=_dereq_('./_shared')('wks'),uid=_dereq_('./_uid'),_Symbol=_dereq_('./_global').Symbol,USE_SYMBOL=typeof _Symbol=='function';var $exports=module.exports=function(name){return store[name]||(store[name]=USE_SYMBOL&&_Symbol[name]||(USE_SYMBOL?_Symbol:uid)('Symbol.'+name));};$exports.store=store;},{"./_global":86,"./_shared":127,"./_uid":137}],141:[function(_dereq_,module,exports){var classof=_dereq_('./_classof'),ITERATOR=_dereq_('./_wks')('iterator'),Iterators=_dereq_('./_iterators');module.exports=_dereq_('./_core').getIteratorMethod=function(it){if(it!=undefined)return it[ITERATOR]||it['@@iterator']||Iterators[classof(it)];};},{"./_classof":70,"./_core":75,"./_iterators":102,"./_wks":140}],142:[function(_dereq_,module,exports){var anObject=_dereq_('./_an-object'),get=_dereq_('./core.get-iterator-method');module.exports=_dereq_('./_core').getIterator=function(it){var iterFn=get(it);if(typeof iterFn!='function')throw TypeError(it+' is not iterable!');return anObject(iterFn.call(it));};},{"./_an-object":63,"./_core":75,"./core.get-iterator-method":141}],143:[function(_dereq_,module,exports){var classof=_dereq_('./_classof'),ITERATOR=_dereq_('./_wks')('iterator'),Iterators=_dereq_('./_iterators');module.exports=_dereq_('./_core').isIterable=function(it){var O=Object(it);return O[ITERATOR]!==undefined||'@@iterator'in O||Iterators.hasOwnProperty(classof(O));};},{"./_classof":70,"./_core":75,"./_iterators":102,"./_wks":140}],144:[function(_dereq_,module,exports){'use strict';var ctx=_dereq_('./_ctx'),$export=_dereq_('./_export'),toObject=_dereq_('./_to-object'),call=_dereq_('./_iter-call'),isArrayIter=_dereq_('./_is-array-iter'),toLength=_dereq_('./_to-length'),createProperty=_dereq_('./_create-property'),getIterFn=_dereq_('./core.get-iterator-method');$export($export.S+$export.F*!_dereq_('./_iter-detect')(function(iter){Array.from(iter);}),'Array',{// 22.1.2.1 Array.from(arrayLike, mapfn = undefined, thisArg = undefined)
from:function from(arrayLike/*, mapfn = undefined, thisArg = undefined*/){var O=toObject(arrayLike),C=typeof this=='function'?this:Array,aLen=arguments.length,mapfn=aLen>1?arguments[1]:undefined,mapping=mapfn!==undefined,index=0,iterFn=getIterFn(O),length,result,step,iterator;if(mapping)mapfn=ctx(mapfn,aLen>2?arguments[2]:undefined,2);// if object isn't iterable or it's array with default iterator - use simple case
if(iterFn!=undefined&&!(C==Array&&isArrayIter(iterFn))){for(iterator=iterFn.call(O),result=new C();!(step=iterator.next()).done;index++){createProperty(result,index,mapping?call(iterator,mapfn,[step.value,index],true):step.value);}}else{length=toLength(O.length);for(result=new C(length);length>index;index++){createProperty(result,index,mapping?mapfn(O[index],index):O[index]);}}result.length=index;return result;}});},{"./_create-property":76,"./_ctx":77,"./_export":83,"./_is-array-iter":93,"./_iter-call":97,"./_iter-detect":100,"./_to-length":134,"./_to-object":135,"./core.get-iterator-method":141}],145:[function(_dereq_,module,exports){'use strict';var addToUnscopables=_dereq_('./_add-to-unscopables'),step=_dereq_('./_iter-step'),Iterators=_dereq_('./_iterators'),toIObject=_dereq_('./_to-iobject');// 22.1.3.4 Array.prototype.entries()
// 22.1.3.13 Array.prototype.keys()
// 22.1.3.29 Array.prototype.values()
// 22.1.3.30 Array.prototype[@@iterator]()
module.exports=_dereq_('./_iter-define')(Array,'Array',function(iterated,kind){this._t=toIObject(iterated);// target
this._i=0;// next index
this._k=kind;// kind
// 22.1.5.2.1 %ArrayIteratorPrototype%.next()
},function(){var O=this._t,kind=this._k,index=this._i++;if(!O||index>=O.length){this._t=undefined;return step(1);}if(kind=='keys')return step(0,index);if(kind=='values')return step(0,O[index]);return step(0,[index,O[index]]);},'values');// argumentsList[@@iterator] is %ArrayProto_values% (9.4.4.6, 9.4.4.7)
Iterators.Arguments=Iterators.Array;addToUnscopables('keys');addToUnscopables('values');addToUnscopables('entries');},{"./_add-to-unscopables":61,"./_iter-define":99,"./_iter-step":101,"./_iterators":102,"./_to-iobject":133}],146:[function(_dereq_,module,exports){'use strict';var strong=_dereq_('./_collection-strong');// 23.1 Map Objects
module.exports=_dereq_('./_collection')('Map',function(get){return function Map(){return get(this,arguments.length>0?arguments[0]:undefined);};},{// 23.1.3.6 Map.prototype.get(key)
get:function get(key){var entry=strong.getEntry(this,key);return entry&&entry.v;},// 23.1.3.9 Map.prototype.set(key, value)
set:function set(key,value){return strong.def(this,key===0?0:key,value);}},strong,true);},{"./_collection":74,"./_collection-strong":72}],147:[function(_dereq_,module,exports){// 20.1.2.3 Number.isInteger(number)
var $export=_dereq_('./_export');$export($export.S,'Number',{isInteger:_dereq_('./_is-integer')});},{"./_export":83,"./_is-integer":95}],148:[function(_dereq_,module,exports){// 19.1.3.1 Object.assign(target, source)
var $export=_dereq_('./_export');$export($export.S+$export.F,'Object',{assign:_dereq_('./_object-assign')});},{"./_export":83,"./_object-assign":107}],149:[function(_dereq_,module,exports){var $export=_dereq_('./_export');// 19.1.2.2 / 15.2.3.5 Object.create(O [, Properties])
$export($export.S,'Object',{create:_dereq_('./_object-create')});},{"./_export":83,"./_object-create":108}],150:[function(_dereq_,module,exports){var $export=_dereq_('./_export');// 19.1.2.3 / 15.2.3.7 Object.defineProperties(O, Properties)
$export($export.S+$export.F*!_dereq_('./_descriptors'),'Object',{defineProperties:_dereq_('./_object-dps')});},{"./_descriptors":79,"./_export":83,"./_object-dps":110}],151:[function(_dereq_,module,exports){var $export=_dereq_('./_export');// 19.1.2.4 / 15.2.3.6 Object.defineProperty(O, P, Attributes)
$export($export.S+$export.F*!_dereq_('./_descriptors'),'Object',{defineProperty:_dereq_('./_object-dp').f});},{"./_descriptors":79,"./_export":83,"./_object-dp":109}],152:[function(_dereq_,module,exports){// 19.1.2.5 Object.freeze(O)
var isObject=_dereq_('./_is-object'),meta=_dereq_('./_meta').onFreeze;_dereq_('./_object-sap')('freeze',function($freeze){return function freeze(it){return $freeze&&isObject(it)?$freeze(meta(it)):it;};});},{"./_is-object":96,"./_meta":105,"./_object-sap":119}],153:[function(_dereq_,module,exports){// 19.1.2.9 Object.getPrototypeOf(O)
var toObject=_dereq_('./_to-object'),$getPrototypeOf=_dereq_('./_object-gpo');_dereq_('./_object-sap')('getPrototypeOf',function(){return function getPrototypeOf(it){return $getPrototypeOf(toObject(it));};});},{"./_object-gpo":115,"./_object-sap":119,"./_to-object":135}],154:[function(_dereq_,module,exports){// 19.1.2.14 Object.keys(O)
var toObject=_dereq_('./_to-object'),$keys=_dereq_('./_object-keys');_dereq_('./_object-sap')('keys',function(){return function keys(it){return $keys(toObject(it));};});},{"./_object-keys":117,"./_object-sap":119,"./_to-object":135}],155:[function(_dereq_,module,exports){// 19.1.3.19 Object.setPrototypeOf(O, proto)
var $export=_dereq_('./_export');$export($export.S,'Object',{setPrototypeOf:_dereq_('./_set-proto').set});},{"./_export":83,"./_set-proto":123}],156:[function(_dereq_,module,exports){arguments[4][40][0].apply(exports,arguments);},{"dup":40}],157:[function(_dereq_,module,exports){'use strict';var LIBRARY=_dereq_('./_library'),global=_dereq_('./_global'),ctx=_dereq_('./_ctx'),classof=_dereq_('./_classof'),$export=_dereq_('./_export'),isObject=_dereq_('./_is-object'),aFunction=_dereq_('./_a-function'),anInstance=_dereq_('./_an-instance'),forOf=_dereq_('./_for-of'),speciesConstructor=_dereq_('./_species-constructor'),task=_dereq_('./_task').set,microtask=_dereq_('./_microtask')(),PROMISE='Promise',TypeError=global.TypeError,process=global.process,$Promise=global[PROMISE],process=global.process,isNode=classof(process)=='process',empty=function empty(){/* empty */},Internal,GenericPromiseCapability,Wrapper;var USE_NATIVE=!!function(){try{// correct subclassing with @@species support
var promise=$Promise.resolve(1),FakePromise=(promise.constructor={})[_dereq_('./_wks')('species')]=function(exec){exec(empty,empty);};// unhandled rejections tracking support, NodeJS Promise without it fails @@species test
return(isNode||typeof PromiseRejectionEvent=='function')&&promise.then(empty)instanceof FakePromise;}catch(e){/* empty */}}();// helpers
var sameConstructor=function sameConstructor(a,b){// with library wrapper special case
return a===b||a===$Promise&&b===Wrapper;};var isThenable=function isThenable(it){var then;return isObject(it)&&typeof(then=it.then)=='function'?then:false;};var newPromiseCapability=function newPromiseCapability(C){return sameConstructor($Promise,C)?new PromiseCapability(C):new GenericPromiseCapability(C);};var PromiseCapability=GenericPromiseCapability=function GenericPromiseCapability(C){var resolve,reject;this.promise=new C(function($$resolve,$$reject){if(resolve!==undefined||reject!==undefined)throw TypeError('Bad Promise constructor');resolve=$$resolve;reject=$$reject;});this.resolve=aFunction(resolve);this.reject=aFunction(reject);};var perform=function perform(exec){try{exec();}catch(e){return{error:e};}};var notify=function notify(promise,isReject){if(promise._n)return;promise._n=true;var chain=promise._c;microtask(function(){var value=promise._v,ok=promise._s==1,i=0;var run=function run(reaction){var handler=ok?reaction.ok:reaction.fail,resolve=reaction.resolve,reject=reaction.reject,domain=reaction.domain,result,then;try{if(handler){if(!ok){if(promise._h==2)onHandleUnhandled(promise);promise._h=1;}if(handler===true)result=value;else{if(domain)domain.enter();result=handler(value);if(domain)domain.exit();}if(result===reaction.promise){reject(TypeError('Promise-chain cycle'));}else if(then=isThenable(result)){then.call(result,resolve,reject);}else resolve(result);}else reject(value);}catch(e){reject(e);}};while(chain.length>i){run(chain[i++]);}// variable length - can't use forEach
promise._c=[];promise._n=false;if(isReject&&!promise._h)onUnhandled(promise);});};var onUnhandled=function onUnhandled(promise){task.call(global,function(){var value=promise._v,abrupt,handler,console;if(isUnhandled(promise)){abrupt=perform(function(){if(isNode){process.emit('unhandledRejection',value,promise);}else if(handler=global.onunhandledrejection){handler({promise:promise,reason:value});}else if((console=global.console)&&console.error){console.error('Unhandled promise rejection',value);}});// Browsers should not trigger `rejectionHandled` event if it was handled here, NodeJS - should
promise._h=isNode||isUnhandled(promise)?2:1;}promise._a=undefined;if(abrupt)throw abrupt.error;});};var isUnhandled=function isUnhandled(promise){if(promise._h==1)return false;var chain=promise._a||promise._c,i=0,reaction;while(chain.length>i){reaction=chain[i++];if(reaction.fail||!isUnhandled(reaction.promise))return false;}return true;};var onHandleUnhandled=function onHandleUnhandled(promise){task.call(global,function(){var handler;if(isNode){process.emit('rejectionHandled',promise);}else if(handler=global.onrejectionhandled){handler({promise:promise,reason:promise._v});}});};var $reject=function $reject(value){var promise=this;if(promise._d)return;promise._d=true;promise=promise._w||promise;// unwrap
promise._v=value;promise._s=2;if(!promise._a)promise._a=promise._c.slice();notify(promise,true);};var $resolve=function $resolve(value){var promise=this,then;if(promise._d)return;promise._d=true;promise=promise._w||promise;// unwrap
try{if(promise===value)throw TypeError("Promise can't be resolved itself");if(then=isThenable(value)){microtask(function(){var wrapper={_w:promise,_d:false};// wrap
try{then.call(value,ctx($resolve,wrapper,1),ctx($reject,wrapper,1));}catch(e){$reject.call(wrapper,e);}});}else{promise._v=value;promise._s=1;notify(promise,false);}}catch(e){$reject.call({_w:promise,_d:false},e);// wrap
}};// constructor polyfill
if(!USE_NATIVE){// 25.4.3.1 Promise(executor)
$Promise=function Promise(executor){anInstance(this,$Promise,PROMISE,'_h');aFunction(executor);Internal.call(this);try{executor(ctx($resolve,this,1),ctx($reject,this,1));}catch(err){$reject.call(this,err);}};Internal=function Promise(executor){this._c=[];// <- awaiting reactions
this._a=undefined;// <- checked in isUnhandled reactions
this._s=0;// <- state
this._d=false;// <- done
this._v=undefined;// <- value
this._h=0;// <- rejection state, 0 - default, 1 - handled, 2 - unhandled
this._n=false;// <- notify
};Internal.prototype=_dereq_('./_redefine-all')($Promise.prototype,{// 25.4.5.3 Promise.prototype.then(onFulfilled, onRejected)
then:function then(onFulfilled,onRejected){var reaction=newPromiseCapability(speciesConstructor(this,$Promise));reaction.ok=typeof onFulfilled=='function'?onFulfilled:true;reaction.fail=typeof onRejected=='function'&&onRejected;reaction.domain=isNode?process.domain:undefined;this._c.push(reaction);if(this._a)this._a.push(reaction);if(this._s)notify(this,false);return reaction.promise;},// 25.4.5.1 Promise.prototype.catch(onRejected)
'catch':function _catch(onRejected){return this.then(undefined,onRejected);}});PromiseCapability=function PromiseCapability(){var promise=new Internal();this.promise=promise;this.resolve=ctx($resolve,promise,1);this.reject=ctx($reject,promise,1);};}$export($export.G+$export.W+$export.F*!USE_NATIVE,{Promise:$Promise});_dereq_('./_set-to-string-tag')($Promise,PROMISE);_dereq_('./_set-species')(PROMISE);Wrapper=_dereq_('./_core')[PROMISE];// statics
$export($export.S+$export.F*!USE_NATIVE,PROMISE,{// 25.4.4.5 Promise.reject(r)
reject:function reject(r){var capability=newPromiseCapability(this),$$reject=capability.reject;$$reject(r);return capability.promise;}});$export($export.S+$export.F*(LIBRARY||!USE_NATIVE),PROMISE,{// 25.4.4.6 Promise.resolve(x)
resolve:function resolve(x){// instanceof instead of internal slot check because we should fix it without replacement native Promise core
if(x instanceof $Promise&&sameConstructor(x.constructor,this))return x;var capability=newPromiseCapability(this),$$resolve=capability.resolve;$$resolve(x);return capability.promise;}});$export($export.S+$export.F*!(USE_NATIVE&&_dereq_('./_iter-detect')(function(iter){$Promise.all(iter)['catch'](empty);})),PROMISE,{// 25.4.4.1 Promise.all(iterable)
all:function all(iterable){var C=this,capability=newPromiseCapability(C),resolve=capability.resolve,reject=capability.reject;var abrupt=perform(function(){var values=[],index=0,remaining=1;forOf(iterable,false,function(promise){var $index=index++,alreadyCalled=false;values.push(undefined);remaining++;C.resolve(promise).then(function(value){if(alreadyCalled)return;alreadyCalled=true;values[$index]=value;--remaining||resolve(values);},reject);});--remaining||resolve(values);});if(abrupt)reject(abrupt.error);return capability.promise;},// 25.4.4.4 Promise.race(iterable)
race:function race(iterable){var C=this,capability=newPromiseCapability(C),reject=capability.reject;var abrupt=perform(function(){forOf(iterable,false,function(promise){C.resolve(promise).then(capability.resolve,reject);});});if(abrupt)reject(abrupt.error);return capability.promise;}});},{"./_a-function":60,"./_an-instance":62,"./_classof":70,"./_core":75,"./_ctx":77,"./_export":83,"./_for-of":85,"./_global":86,"./_is-object":96,"./_iter-detect":100,"./_library":104,"./_microtask":106,"./_redefine-all":121,"./_set-species":124,"./_set-to-string-tag":125,"./_species-constructor":128,"./_task":130,"./_wks":140}],158:[function(_dereq_,module,exports){// 26.1.2 Reflect.construct(target, argumentsList [, newTarget])
var $export=_dereq_('./_export'),create=_dereq_('./_object-create'),aFunction=_dereq_('./_a-function'),anObject=_dereq_('./_an-object'),isObject=_dereq_('./_is-object'),fails=_dereq_('./_fails'),bind=_dereq_('./_bind'),rConstruct=(_dereq_('./_global').Reflect||{}).construct;// MS Edge supports only 2 arguments and argumentsList argument is optional
// FF Nightly sets third argument as `new.target`, but does not create `this` from it
var NEW_TARGET_BUG=fails(function(){function F(){}return!(rConstruct(function(){},[],F)instanceof F);});var ARGS_BUG=!fails(function(){rConstruct(function(){});});$export($export.S+$export.F*(NEW_TARGET_BUG||ARGS_BUG),'Reflect',{construct:function construct(Target,args/*, newTarget*/){aFunction(Target);anObject(args);var newTarget=arguments.length<3?Target:aFunction(arguments[2]);if(ARGS_BUG&&!NEW_TARGET_BUG)return rConstruct(Target,args,newTarget);if(Target==newTarget){// w/o altered newTarget, optimization for 0-4 arguments
switch(args.length){case 0:return new Target();case 1:return new Target(args[0]);case 2:return new Target(args[0],args[1]);case 3:return new Target(args[0],args[1],args[2]);case 4:return new Target(args[0],args[1],args[2],args[3]);}// w/o altered newTarget, lot of arguments case
var $args=[null];$args.push.apply($args,args);return new(bind.apply(Target,$args))();}// with altered newTarget, not support built-in constructors
var proto=newTarget.prototype,instance=create(isObject(proto)?proto:Object.prototype),result=Function.apply.call(Target,instance,args);return isObject(result)?result:instance;}});},{"./_a-function":60,"./_an-object":63,"./_bind":69,"./_export":83,"./_fails":84,"./_global":86,"./_is-object":96,"./_object-create":108}],159:[function(_dereq_,module,exports){'use strict';var strong=_dereq_('./_collection-strong');// 23.2 Set Objects
module.exports=_dereq_('./_collection')('Set',function(get){return function Set(){return get(this,arguments.length>0?arguments[0]:undefined);};},{// 23.2.3.1 Set.prototype.add(value)
add:function add(value){return strong.def(this,value=value===0?0:value,value);}},strong);},{"./_collection":74,"./_collection-strong":72}],160:[function(_dereq_,module,exports){'use strict';var $at=_dereq_('./_string-at')(true);// 21.1.3.27 String.prototype[@@iterator]()
_dereq_('./_iter-define')(String,'String',function(iterated){this._t=String(iterated);// target
this._i=0;// next index
// 21.1.5.2.1 %StringIteratorPrototype%.next()
},function(){var O=this._t,index=this._i,point;if(index>=O.length)return{value:undefined,done:true};point=$at(O,index);this._i+=point.length;return{value:point,done:false};});},{"./_iter-define":99,"./_string-at":129}],161:[function(_dereq_,module,exports){'use strict';// ECMAScript 6 symbols shim
var global=_dereq_('./_global'),has=_dereq_('./_has'),DESCRIPTORS=_dereq_('./_descriptors'),$export=_dereq_('./_export'),redefine=_dereq_('./_redefine'),META=_dereq_('./_meta').KEY,$fails=_dereq_('./_fails'),shared=_dereq_('./_shared'),setToStringTag=_dereq_('./_set-to-string-tag'),uid=_dereq_('./_uid'),wks=_dereq_('./_wks'),wksExt=_dereq_('./_wks-ext'),wksDefine=_dereq_('./_wks-define'),keyOf=_dereq_('./_keyof'),enumKeys=_dereq_('./_enum-keys'),isArray=_dereq_('./_is-array'),anObject=_dereq_('./_an-object'),toIObject=_dereq_('./_to-iobject'),toPrimitive=_dereq_('./_to-primitive'),createDesc=_dereq_('./_property-desc'),_create=_dereq_('./_object-create'),gOPNExt=_dereq_('./_object-gopn-ext'),$GOPD=_dereq_('./_object-gopd'),$DP=_dereq_('./_object-dp'),$keys=_dereq_('./_object-keys'),gOPD=$GOPD.f,dP=$DP.f,gOPN=gOPNExt.f,$Symbol=global.Symbol,$JSON=global.JSON,_stringify=$JSON&&$JSON.stringify,PROTOTYPE='prototype',HIDDEN=wks('_hidden'),TO_PRIMITIVE=wks('toPrimitive'),isEnum={}.propertyIsEnumerable,SymbolRegistry=shared('symbol-registry'),AllSymbols=shared('symbols'),OPSymbols=shared('op-symbols'),ObjectProto=Object[PROTOTYPE],USE_NATIVE=typeof $Symbol=='function',QObject=global.QObject;// Don't use setters in Qt Script, https://github.com/zloirock/core-js/issues/173
var setter=!QObject||!QObject[PROTOTYPE]||!QObject[PROTOTYPE].findChild;// fallback for old Android, https://code.google.com/p/v8/issues/detail?id=687
var setSymbolDesc=DESCRIPTORS&&$fails(function(){return _create(dP({},'a',{get:function get(){return dP(this,'a',{value:7}).a;}})).a!=7;})?function(it,key,D){var protoDesc=gOPD(ObjectProto,key);if(protoDesc)delete ObjectProto[key];dP(it,key,D);if(protoDesc&&it!==ObjectProto)dP(ObjectProto,key,protoDesc);}:dP;var wrap=function wrap(tag){var sym=AllSymbols[tag]=_create($Symbol[PROTOTYPE]);sym._k=tag;return sym;};var isSymbol=USE_NATIVE&&_typeof4($Symbol.iterator)=='symbol'?function(it){return(typeof it==="undefined"?"undefined":_typeof4(it))=='symbol';}:function(it){return it instanceof $Symbol;};var $defineProperty=function defineProperty(it,key,D){if(it===ObjectProto)$defineProperty(OPSymbols,key,D);anObject(it);key=toPrimitive(key,true);anObject(D);if(has(AllSymbols,key)){if(!D.enumerable){if(!has(it,HIDDEN))dP(it,HIDDEN,createDesc(1,{}));it[HIDDEN][key]=true;}else{if(has(it,HIDDEN)&&it[HIDDEN][key])it[HIDDEN][key]=false;D=_create(D,{enumerable:createDesc(0,false)});}return setSymbolDesc(it,key,D);}return dP(it,key,D);};var $defineProperties=function defineProperties(it,P){anObject(it);var keys=enumKeys(P=toIObject(P)),i=0,l=keys.length,key;while(l>i){$defineProperty(it,key=keys[i++],P[key]);}return it;};var $create=function create(it,P){return P===undefined?_create(it):$defineProperties(_create(it),P);};var $propertyIsEnumerable=function propertyIsEnumerable(key){var E=isEnum.call(this,key=toPrimitive(key,true));if(this===ObjectProto&&has(AllSymbols,key)&&!has(OPSymbols,key))return false;return E||!has(this,key)||!has(AllSymbols,key)||has(this,HIDDEN)&&this[HIDDEN][key]?E:true;};var $getOwnPropertyDescriptor=function getOwnPropertyDescriptor(it,key){it=toIObject(it);key=toPrimitive(key,true);if(it===ObjectProto&&has(AllSymbols,key)&&!has(OPSymbols,key))return;var D=gOPD(it,key);if(D&&has(AllSymbols,key)&&!(has(it,HIDDEN)&&it[HIDDEN][key]))D.enumerable=true;return D;};var $getOwnPropertyNames=function getOwnPropertyNames(it){var names=gOPN(toIObject(it)),result=[],i=0,key;while(names.length>i){if(!has(AllSymbols,key=names[i++])&&key!=HIDDEN&&key!=META)result.push(key);}return result;};var $getOwnPropertySymbols=function getOwnPropertySymbols(it){var IS_OP=it===ObjectProto,names=gOPN(IS_OP?OPSymbols:toIObject(it)),result=[],i=0,key;while(names.length>i){if(has(AllSymbols,key=names[i++])&&(IS_OP?has(ObjectProto,key):true))result.push(AllSymbols[key]);}return result;};// 19.4.1.1 Symbol([description])
if(!USE_NATIVE){$Symbol=function _Symbol2(){if(this instanceof $Symbol)throw TypeError('Symbol is not a constructor!');var tag=uid(arguments.length>0?arguments[0]:undefined);var $set=function $set(value){if(this===ObjectProto)$set.call(OPSymbols,value);if(has(this,HIDDEN)&&has(this[HIDDEN],tag))this[HIDDEN][tag]=false;setSymbolDesc(this,tag,createDesc(1,value));};if(DESCRIPTORS&&setter)setSymbolDesc(ObjectProto,tag,{configurable:true,set:$set});return wrap(tag);};redefine($Symbol[PROTOTYPE],'toString',function toString(){return this._k;});$GOPD.f=$getOwnPropertyDescriptor;$DP.f=$defineProperty;_dereq_('./_object-gopn').f=gOPNExt.f=$getOwnPropertyNames;_dereq_('./_object-pie').f=$propertyIsEnumerable;_dereq_('./_object-gops').f=$getOwnPropertySymbols;if(DESCRIPTORS&&!_dereq_('./_library')){redefine(ObjectProto,'propertyIsEnumerable',$propertyIsEnumerable,true);}wksExt.f=function(name){return wrap(wks(name));};}$export($export.G+$export.W+$export.F*!USE_NATIVE,{Symbol:$Symbol});for(var symbols=// 19.4.2.2, 19.4.2.3, 19.4.2.4, 19.4.2.6, 19.4.2.8, 19.4.2.9, 19.4.2.10, 19.4.2.11, 19.4.2.12, 19.4.2.13, 19.4.2.14
'hasInstance,isConcatSpreadable,iterator,match,replace,search,species,split,toPrimitive,toStringTag,unscopables'.split(','),i=0;symbols.length>i;){wks(symbols[i++]);}for(var symbols=$keys(wks.store),i=0;symbols.length>i;){wksDefine(symbols[i++]);}$export($export.S+$export.F*!USE_NATIVE,'Symbol',{// 19.4.2.1 Symbol.for(key)
'for':function _for(key){return has(SymbolRegistry,key+='')?SymbolRegistry[key]:SymbolRegistry[key]=$Symbol(key);},// 19.4.2.5 Symbol.keyFor(sym)
keyFor:function keyFor(key){if(isSymbol(key))return keyOf(SymbolRegistry,key);throw TypeError(key+' is not a symbol!');},useSetter:function useSetter(){setter=true;},useSimple:function useSimple(){setter=false;}});$export($export.S+$export.F*!USE_NATIVE,'Object',{// 19.1.2.2 Object.create(O [, Properties])
create:$create,// 19.1.2.4 Object.defineProperty(O, P, Attributes)
defineProperty:$defineProperty,// 19.1.2.3 Object.defineProperties(O, Properties)
defineProperties:$defineProperties,// 19.1.2.6 Object.getOwnPropertyDescriptor(O, P)
getOwnPropertyDescriptor:$getOwnPropertyDescriptor,// 19.1.2.7 Object.getOwnPropertyNames(O)
getOwnPropertyNames:$getOwnPropertyNames,// 19.1.2.8 Object.getOwnPropertySymbols(O)
getOwnPropertySymbols:$getOwnPropertySymbols});// 24.3.2 JSON.stringify(value [, replacer [, space]])
$JSON&&$export($export.S+$export.F*(!USE_NATIVE||$fails(function(){var S=$Symbol();// MS Edge converts symbol values to JSON as {}
// WebKit converts symbol values to JSON as null
// V8 throws on boxed symbols
return _stringify([S])!='[null]'||_stringify({a:S})!='{}'||_stringify(Object(S))!='{}';})),'JSON',{stringify:function stringify(it){if(it===undefined||isSymbol(it))return;// IE8 returns string on undefined
var args=[it],i=1,replacer,$replacer;while(arguments.length>i){args.push(arguments[i++]);}replacer=args[1];if(typeof replacer=='function')$replacer=replacer;if($replacer||!isArray(replacer))replacer=function replacer(key,value){if($replacer)value=$replacer.call(this,key,value);if(!isSymbol(value))return value;};args[1]=replacer;return _stringify.apply($JSON,args);}});// 19.4.3.4 Symbol.prototype[@@toPrimitive](hint)
$Symbol[PROTOTYPE][TO_PRIMITIVE]||_dereq_('./_hide')($Symbol[PROTOTYPE],TO_PRIMITIVE,$Symbol[PROTOTYPE].valueOf);// 19.4.3.5 Symbol.prototype[@@toStringTag]
setToStringTag($Symbol,'Symbol');// 20.2.1.9 Math[@@toStringTag]
setToStringTag(Math,'Math',true);// 24.3.3 JSON[@@toStringTag]
setToStringTag(global.JSON,'JSON',true);},{"./_an-object":63,"./_descriptors":79,"./_enum-keys":82,"./_export":83,"./_fails":84,"./_global":86,"./_has":87,"./_hide":88,"./_is-array":94,"./_keyof":103,"./_library":104,"./_meta":105,"./_object-create":108,"./_object-dp":109,"./_object-gopd":111,"./_object-gopn":113,"./_object-gopn-ext":112,"./_object-gops":114,"./_object-keys":117,"./_object-pie":118,"./_property-desc":120,"./_redefine":122,"./_set-to-string-tag":125,"./_shared":127,"./_to-iobject":133,"./_to-primitive":136,"./_uid":137,"./_wks":140,"./_wks-define":138,"./_wks-ext":139}],162:[function(_dereq_,module,exports){// https://github.com/DavidBruant/Map-Set.prototype.toJSON
var $export=_dereq_('./_export');$export($export.P+$export.R,'Map',{toJSON:_dereq_('./_collection-to-json')('Map')});},{"./_collection-to-json":73,"./_export":83}],163:[function(_dereq_,module,exports){// https://github.com/DavidBruant/Map-Set.prototype.toJSON
var $export=_dereq_('./_export');$export($export.P+$export.R,'Set',{toJSON:_dereq_('./_collection-to-json')('Set')});},{"./_collection-to-json":73,"./_export":83}],164:[function(_dereq_,module,exports){_dereq_('./_wks-define')('asyncIterator');},{"./_wks-define":138}],165:[function(_dereq_,module,exports){_dereq_('./_wks-define')('observable');},{"./_wks-define":138}],166:[function(_dereq_,module,exports){_dereq_('./es6.array.iterator');var global=_dereq_('./_global'),hide=_dereq_('./_hide'),Iterators=_dereq_('./_iterators'),TO_STRING_TAG=_dereq_('./_wks')('toStringTag');for(var collections=['NodeList','DOMTokenList','MediaList','StyleSheetList','CSSRuleList'],i=0;i<5;i++){var NAME=collections[i],Collection=global[NAME],proto=Collection&&Collection.prototype;if(proto&&!proto[TO_STRING_TAG])hide(proto,TO_STRING_TAG,NAME);Iterators[NAME]=Iterators.Array;}},{"./_global":86,"./_hide":88,"./_iterators":102,"./_wks":140,"./es6.array.iterator":145}],167:[function(_dereq_,module,exports){module.exports=_dereq_('./lib');},{"./lib":168}],168:[function(_dereq_,module,exports){var FORMAT_REGEXP=/^PT(?:(\d+)H)?(?:(\d+)M)?(?:(\d+)S)?$/;function matchToInteger(match){return match===undefined?0:parseInt(match,10);}exports.fromSeconds=function(seconds){if(typeof seconds!=='number'){throw new TypeError('Argument `seconds` must be a number');}var fullSeconds=seconds%60;var fullMinutesInSeconds=(seconds-fullSeconds)%3600;return{hours:(seconds-fullSeconds-fullMinutesInSeconds)/3600,minutes:fullMinutesInSeconds/60,seconds:fullSeconds};};exports.fromString=function(string){if(typeof string!=='string'){throw new TypeError('Argument `string` must be a string');}var matches=string.match(FORMAT_REGEXP);if(matches===null||matches[1]===undefined&&matches[2]===undefined&&matches[3]===undefined){throw new Error('Could not parse "'+string+'" as a duration.');}return{hours:matchToInteger(matches[1]),minutes:matchToInteger(matches[2]),seconds:matchToInteger(matches[3])};};exports.toString=function(duration){if(typeof duration==='number'){duration=exports.fromSeconds(duration);}var result='PT';if(duration.hours>0){result+=duration.hours+'H';}if(duration.minutes>0){result+=duration.minutes+'M';}if(duration.seconds>0){result+=duration.seconds+'S';}if(result==='PT'){result+='0S';}return result;};exports.toSeconds=function(stringOrDuration){var duration=stringOrDuration;if(typeof stringOrDuration==='string'){duration=exports.fromString(stringOrDuration);}return duration.hours*3600+duration.minutes*60+duration.seconds;};},{}],169:[function(_dereq_,module,exports){// Copyright Joyent, Inc. and other Node contributors.
//
// Permission is hereby granted, free of charge, to any person obtaining a
// copy of this software and associated documentation files (the
// "Software"), to deal in the Software without restriction, including
// without limitation the rights to use, copy, modify, merge, publish,
// distribute, sublicense, and/or sell copies of the Software, and to permit
// persons to whom the Software is furnished to do so, subject to the
// following conditions:
//
// The above copyright notice and this permission notice shall be included
// in all copies or substantial portions of the Software.
//
// THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS
// OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF
// MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN
// NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM,
// DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR
// OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE
// USE OR OTHER DEALINGS IN THE SOFTWARE.
function EventEmitter(){this._events=this._events||{};this._maxListeners=this._maxListeners||undefined;}module.exports=EventEmitter;// Backwards-compat with node 0.10.x
EventEmitter.EventEmitter=EventEmitter;EventEmitter.prototype._events=undefined;EventEmitter.prototype._maxListeners=undefined;// By default EventEmitters will print a warning if more than 10 listeners are
// added to it. This is a useful default which helps finding memory leaks.
EventEmitter.defaultMaxListeners=10;// Obviously not all Emitters should be limited to 10. This function allows
// that to be increased. Set to zero for unlimited.
EventEmitter.prototype.setMaxListeners=function(n){if(!isNumber(n)||n<0||isNaN(n))throw TypeError('n must be a positive number');this._maxListeners=n;return this;};EventEmitter.prototype.emit=function(type){var er,handler,len,args,i,listeners;if(!this._events)this._events={};// If there is no 'error' event listener then throw.
if(type==='error'){if(!this._events.error||isObject(this._events.error)&&!this._events.error.length){er=arguments[1];if(er instanceof Error){throw er;// Unhandled 'error' event
}else{// At least give some kind of context to the user
var err=new Error('Uncaught, unspecified "error" event. ('+er+')');err.context=er;throw err;}}}handler=this._events[type];if(isUndefined(handler))return false;if(isFunction(handler)){switch(arguments.length){// fast cases
case 1:handler.call(this);break;case 2:handler.call(this,arguments[1]);break;case 3:handler.call(this,arguments[1],arguments[2]);break;// slower
default:args=Array.prototype.slice.call(arguments,1);handler.apply(this,args);}}else if(isObject(handler)){args=Array.prototype.slice.call(arguments,1);listeners=handler.slice();len=listeners.length;for(i=0;i<len;i++){listeners[i].apply(this,args);}}return true;};EventEmitter.prototype.addListener=function(type,listener){var m;if(!isFunction(listener))throw TypeError('listener must be a function');if(!this._events)this._events={};// To avoid recursion in the case that type === "newListener"! Before
// adding it to the listeners, first emit "newListener".
if(this._events.newListener)this.emit('newListener',type,isFunction(listener.listener)?listener.listener:listener);if(!this._events[type])// Optimize the case of one listener. Don't need the extra array object.
this._events[type]=listener;else if(isObject(this._events[type]))// If we've already got an array, just append.
this._events[type].push(listener);else// Adding the second element, need to change to array.
this._events[type]=[this._events[type],listener];// Check for listener leak
if(isObject(this._events[type])&&!this._events[type].warned){if(!isUndefined(this._maxListeners)){m=this._maxListeners;}else{m=EventEmitter.defaultMaxListeners;}if(m&&m>0&&this._events[type].length>m){this._events[type].warned=true;console.error('(node) warning: possible EventEmitter memory '+'leak detected. %d listeners added. '+'Use emitter.setMaxListeners() to increase limit.',this._events[type].length);if(typeof console.trace==='function'){// not supported in IE 10
console.trace();}}}return this;};EventEmitter.prototype.on=EventEmitter.prototype.addListener;EventEmitter.prototype.once=function(type,listener){if(!isFunction(listener))throw TypeError('listener must be a function');var fired=false;function g(){this.removeListener(type,g);if(!fired){fired=true;listener.apply(this,arguments);}}g.listener=listener;this.on(type,g);return this;};// emits a 'removeListener' event iff the listener was removed
EventEmitter.prototype.removeListener=function(type,listener){var list,position,length,i;if(!isFunction(listener))throw TypeError('listener must be a function');if(!this._events||!this._events[type])return this;list=this._events[type];length=list.length;position=-1;if(list===listener||isFunction(list.listener)&&list.listener===listener){delete this._events[type];if(this._events.removeListener)this.emit('removeListener',type,listener);}else if(isObject(list)){for(i=length;i-->0;){if(list[i]===listener||list[i].listener&&list[i].listener===listener){position=i;break;}}if(position<0)return this;if(list.length===1){list.length=0;delete this._events[type];}else{list.splice(position,1);}if(this._events.removeListener)this.emit('removeListener',type,listener);}return this;};EventEmitter.prototype.removeAllListeners=function(type){var key,listeners;if(!this._events)return this;// not listening for removeListener, no need to emit
if(!this._events.removeListener){if(arguments.length===0)this._events={};else if(this._events[type])delete this._events[type];return this;}// emit removeListener for all listeners on all events
if(arguments.length===0){for(key in this._events){if(key==='removeListener')continue;this.removeAllListeners(key);}this.removeAllListeners('removeListener');this._events={};return this;}listeners=this._events[type];if(isFunction(listeners)){this.removeListener(type,listeners);}else if(listeners){// LIFO order
while(listeners.length){this.removeListener(type,listeners[listeners.length-1]);}}delete this._events[type];return this;};EventEmitter.prototype.listeners=function(type){var ret;if(!this._events||!this._events[type])ret=[];else if(isFunction(this._events[type]))ret=[this._events[type]];else ret=this._events[type].slice();return ret;};EventEmitter.prototype.listenerCount=function(type){if(this._events){var evlistener=this._events[type];if(isFunction(evlistener))return 1;else if(evlistener)return evlistener.length;}return 0;};EventEmitter.listenerCount=function(emitter,type){return emitter.listenerCount(type);};function isFunction(arg){return typeof arg==='function';}function isNumber(arg){return typeof arg==='number';}function isObject(arg){return(typeof arg==="undefined"?"undefined":_typeof4(arg))==='object'&&arg!==null;}function isUndefined(arg){return arg===void 0;}},{}],170:[function(_dereq_,module,exports){/*

  Javascript State Machine Library - https://github.com/jakesgordon/javascript-state-machine

  Copyright (c) 2012, 2013, 2014, 2015, Jake Gordon and contributors
  Released under the MIT license - https://github.com/jakesgordon/javascript-state-machine/blob/master/LICENSE

*/(function(){var StateMachine={//---------------------------------------------------------------------------
VERSION:"2.4.0",//---------------------------------------------------------------------------
Result:{SUCCEEDED:1,// the event transitioned successfully from one state to another
NOTRANSITION:2,// the event was successfull but no state transition was necessary
CANCELLED:3,// the event was cancelled by the caller in a beforeEvent callback
PENDING:4// the event is asynchronous and the caller is in control of when the transition occurs
},Error:{INVALID_TRANSITION:100,// caller tried to fire an event that was innapropriate in the current state
PENDING_TRANSITION:200,// caller tried to fire an event while an async transition was still pending
INVALID_CALLBACK:300// caller provided callback function threw an exception
},WILDCARD:'*',ASYNC:'async',//---------------------------------------------------------------------------
create:function create(cfg,target){var initial=typeof cfg.initial=='string'?{state:cfg.initial}:cfg.initial;// allow for a simple string, or an object with { state: 'foo', event: 'setup', defer: true|false }
var terminal=cfg.terminal||cfg['final'];var fsm=target||cfg.target||{};var events=cfg.events||[];var callbacks=cfg.callbacks||{};var map={};// track state transitions allowed for an event { event: { from: [ to ] } }
var transitions={};// track events allowed from a state            { state: [ event ] }
var add=function add(e){var from=Array.isArray(e.from)?e.from:e.from?[e.from]:[StateMachine.WILDCARD];// allow 'wildcard' transition if 'from' is not specified
map[e.name]=map[e.name]||{};for(var n=0;n<from.length;n++){transitions[from[n]]=transitions[from[n]]||[];transitions[from[n]].push(e.name);map[e.name][from[n]]=e.to||from[n];// allow no-op transition if 'to' is not specified
}if(e.to)transitions[e.to]=transitions[e.to]||[];};if(initial){initial.event=initial.event||'startup';add({name:initial.event,from:'none',to:initial.state});}for(var n=0;n<events.length;n++){add(events[n]);}for(var name in map){if(map.hasOwnProperty(name))fsm[name]=StateMachine.buildEvent(name,map[name]);}for(var name in callbacks){if(callbacks.hasOwnProperty(name))fsm[name]=callbacks[name];}fsm.current='none';fsm.is=function(state){return Array.isArray(state)?state.indexOf(this.current)>=0:this.current===state;};fsm.can=function(event){return!this.transition&&map[event]!==undefined&&(map[event].hasOwnProperty(this.current)||map[event].hasOwnProperty(StateMachine.WILDCARD));};fsm.cannot=function(event){return!this.can(event);};fsm.transitions=function(){return(transitions[this.current]||[]).concat(transitions[StateMachine.WILDCARD]||[]);};fsm.isFinished=function(){return this.is(terminal);};fsm.error=cfg.error||function(name,from,to,args,error,msg,e){throw e||msg;};// default behavior when something unexpected happens is to throw an exception, but caller can override this behavior if desired (see github issue #3 and #17)
fsm.states=function(){return Object.keys(transitions).sort();};if(initial&&!initial.defer)fsm[initial.event]();return fsm;},//===========================================================================
doCallback:function doCallback(fsm,func,name,from,to,args){if(func){try{return func.apply(fsm,[name,from,to].concat(args));}catch(e){return fsm.error(name,from,to,args,StateMachine.Error.INVALID_CALLBACK,"an exception occurred in a caller-provided callback function",e);}}},beforeAnyEvent:function beforeAnyEvent(fsm,name,from,to,args){return StateMachine.doCallback(fsm,fsm['onbeforeevent'],name,from,to,args);},afterAnyEvent:function afterAnyEvent(fsm,name,from,to,args){return StateMachine.doCallback(fsm,fsm['onafterevent']||fsm['onevent'],name,from,to,args);},leaveAnyState:function leaveAnyState(fsm,name,from,to,args){return StateMachine.doCallback(fsm,fsm['onleavestate'],name,from,to,args);},enterAnyState:function enterAnyState(fsm,name,from,to,args){return StateMachine.doCallback(fsm,fsm['onenterstate']||fsm['onstate'],name,from,to,args);},changeState:function changeState(fsm,name,from,to,args){return StateMachine.doCallback(fsm,fsm['onchangestate'],name,from,to,args);},beforeThisEvent:function beforeThisEvent(fsm,name,from,to,args){return StateMachine.doCallback(fsm,fsm['onbefore'+name],name,from,to,args);},afterThisEvent:function afterThisEvent(fsm,name,from,to,args){return StateMachine.doCallback(fsm,fsm['onafter'+name]||fsm['on'+name],name,from,to,args);},leaveThisState:function leaveThisState(fsm,name,from,to,args){return StateMachine.doCallback(fsm,fsm['onleave'+from],name,from,to,args);},enterThisState:function enterThisState(fsm,name,from,to,args){return StateMachine.doCallback(fsm,fsm['onenter'+to]||fsm['on'+to],name,from,to,args);},beforeEvent:function beforeEvent(fsm,name,from,to,args){if(false===StateMachine.beforeThisEvent(fsm,name,from,to,args)||false===StateMachine.beforeAnyEvent(fsm,name,from,to,args))return false;},afterEvent:function afterEvent(fsm,name,from,to,args){StateMachine.afterThisEvent(fsm,name,from,to,args);StateMachine.afterAnyEvent(fsm,name,from,to,args);},leaveState:function leaveState(fsm,name,from,to,args){var specific=StateMachine.leaveThisState(fsm,name,from,to,args),general=StateMachine.leaveAnyState(fsm,name,from,to,args);if(false===specific||false===general)return false;else if(StateMachine.ASYNC===specific||StateMachine.ASYNC===general)return StateMachine.ASYNC;},enterState:function enterState(fsm,name,from,to,args){StateMachine.enterThisState(fsm,name,from,to,args);StateMachine.enterAnyState(fsm,name,from,to,args);},//===========================================================================
buildEvent:function buildEvent(name,map){return function(){var from=this.current;var to=map[from]||(map[StateMachine.WILDCARD]!=StateMachine.WILDCARD?map[StateMachine.WILDCARD]:from)||from;var args=Array.prototype.slice.call(arguments);// turn arguments into pure array
if(this.transition)return this.error(name,from,to,args,StateMachine.Error.PENDING_TRANSITION,"event "+name+" inappropriate because previous transition did not complete");if(this.cannot(name))return this.error(name,from,to,args,StateMachine.Error.INVALID_TRANSITION,"event "+name+" inappropriate in current state "+this.current);if(false===StateMachine.beforeEvent(this,name,from,to,args))return StateMachine.Result.CANCELLED;if(from===to){StateMachine.afterEvent(this,name,from,to,args);return StateMachine.Result.NOTRANSITION;}// prepare a transition method for use EITHER lower down, or by caller if they want an async transition (indicated by an ASYNC return value from leaveState)
var fsm=this;this.transition=function(){fsm.transition=null;// this method should only ever be called once
fsm.current=to;StateMachine.enterState(fsm,name,from,to,args);StateMachine.changeState(fsm,name,from,to,args);StateMachine.afterEvent(fsm,name,from,to,args);return StateMachine.Result.SUCCEEDED;};this.transition.cancel=function(){// provide a way for caller to cancel async transition if desired (issue #22)
fsm.transition=null;StateMachine.afterEvent(fsm,name,from,to,args);};var leave=StateMachine.leaveState(this,name,from,to,args);if(false===leave){this.transition=null;return StateMachine.Result.CANCELLED;}else if(StateMachine.ASYNC===leave){return StateMachine.Result.PENDING;}else{if(this.transition)// need to check in case user manually called transition() but forgot to return StateMachine.ASYNC
return this.transition();}};}};// StateMachine
//===========================================================================
//======
// NODE
//======
if(typeof exports!=='undefined'){if(typeof module!=='undefined'&&module.exports){exports=module.exports=StateMachine;}exports.StateMachine=StateMachine;}//============
// AMD/REQUIRE
//============
else if(typeof define==='function'&&define.amd){define(function(_dereq_){return StateMachine;});}//========
// BROWSER
//========
else if(typeof window!=='undefined'){window.StateMachine=StateMachine;}//===========
// WEB WORKER
//===========
else if(typeof self!=='undefined'){self.StateMachine=StateMachine;}})();},{}],171:[function(_dereq_,module,exports){"use strict";var _regenerator=_dereq_("babel-runtime/regenerator");var _regenerator2=_interopRequireDefault(_regenerator);var _iterator=_dereq_("babel-runtime/core-js/symbol/iterator");var _iterator2=_interopRequireDefault(_iterator);var _classCallCheck2=_dereq_("babel-runtime/helpers/classCallCheck");var _classCallCheck3=_interopRequireDefault(_classCallCheck2);var _createClass2=_dereq_("babel-runtime/helpers/createClass");var _createClass3=_interopRequireDefault(_createClass2);function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj};}var Node=function(){function Node(key,value){(0,_classCallCheck3.default)(this,Node);this.balanceFactor=0;this.key=key;this.value=value;this.parent=null;this.left=null;this.right=null;}(0,_createClass3.default)(Node,[{key:"update",value:function update(value){this.value=value;}},{key:"replace",value:function replace(target,replacement){if(!target){return;}if(this.left===replacement){this.left=replacement;}else if(this.right===replacement){this.right=replacement;}}},{key:"isRoot",get:function get(){return this.parent===null;}},{key:"isLeaf",get:function get(){return this.left===null&&this.right===null;}},{key:"isLeftChild",get:function get(){return this.parent.left===this;}}]);return Node;}();/**
 * @property length
 */var TreeMap=function(){function TreeMap(less,equal){(0,_classCallCheck3.default)(this,TreeMap);this.isLessThan=less||function(x,y){return x<y;};this.isEqual=equal||function(x,y){return x===y;};this.root=null;this.count=null;}(0,_createClass3.default)(TreeMap,[{key:"clear",value:function clear(){this.root=null;this.count=0;}},{key:"set",value:function set(key,value){var node=this.getNode(key);if(node){node.update(value);}else{this.insert(key,value);}// return node;
}},{key:"insert",value:function insert(key,value){var node=new Node(key,value);this.count++;if(!this.root){this.root=node;// return node;
return;}var currNode=this.root;for(;;){if(this.isLessThan(key,currNode.key)){if(currNode.left){currNode=currNode.left;}else{currNode.left=node;break;}}else{if(currNode.right){currNode=currNode.right;}else{currNode.right=node;break;}}}node.parent=currNode;currNode=node;while(currNode.parent){var parent=currNode.parent;var prevBalanceFactor=parent.balanceFactor;if(currNode.isLeftChild){parent.balanceFactor++;}else{parent.balanceFactor--;}if(Math.abs(parent.balanceFactor)<Math.abs(prevBalanceFactor)){break;}if(parent.balanceFactor<-1||parent.balanceFactor>1){this.rebalance(parent);break;}currNode=parent;}// return node;
}},{key:"get",value:function get(key){var currentNode=this.root;while(currentNode){if(this.isEqual(key,currentNode.key)){return currentNode.value;}if(this.isLessThan(key,currentNode.key)){currentNode=currentNode.left;}else{currentNode=currentNode.right;}}return null;}},{key:"delete",value:function _delete(key){// update this algorithm and remove any
var node=this.getNode(key);if(!node||node.key!==key){return null;}var parent=node.parent;var left=node.left;var right=node.right;if(!!left!==!!right){var child=left||right;if(!parent&&!child){this.root=null;}else if(parent&&!child){this.root=child;}else{parent.replace(node,null);this.rebalance(parent);}}else{var maxLeft=node.left;while(maxLeft.right){maxLeft=maxLeft.right;}if(node.left===maxLeft){if(node.isRoot){this.root=maxLeft;maxLeft.parent=null;}else{if(node.isLeftChild){node.parent.left=maxLeft;}else{node.parent.right=maxLeft;}maxLeft.parent=node.parent;}maxLeft.right=node.right;maxLeft.right.parent=maxLeft;maxLeft.balanceFactor=node.balanceFactor;node={parent:maxLeft,isLeftChild:true};}else{var mlParent=maxLeft.parent;var mlLeft=maxLeft.left;mlParent.right=mlLeft;if(mlLeft){mlLeft.parent=mlParent;}if(node.isRoot){this.root=maxLeft;maxLeft.parent=null;}else{if(node.isLeftChild){node.parent.left=maxLeft;}else{node.parent.right=maxLeft;}maxLeft.parent=node.parent;}maxLeft.right=node.right;maxLeft.right.parent=maxLeft;maxLeft.left=node.left;maxLeft.left.parent=maxLeft;maxLeft.balanceFactor=node.balanceFactor;node={parent:mlParent,isLeftChild:false};}}this.count--;while(node.parent){var _parent=node.parent;var prevBalanceFactor=_parent.balanceFactor;if(node.isLeftChild){_parent.balanceFactor-=1;}else{_parent.balanceFactor+=1;}if(Math.abs(_parent.balanceFactor)>Math.abs(prevBalanceFactor)){if(_parent.balanceFactor<-1||_parent.balanceFactor>1){this.rebalance(_parent);if(_parent.parent.balanceFactor===0){node=_parent.parent;}else{break;}}else{break;}}else{node=_parent;}}return null;}},{key:"getNode",value:function getNode(key){var currentNode=this.root;while(currentNode){if(this.isEqual(key,currentNode.key)){return currentNode;}if(this.isLessThan(key,currentNode.key)){currentNode=currentNode.left;}else{currentNode=currentNode.right;}}return null;}},{key:"rebalance",value:function rebalance(node){if(node.balanceFactor<0){if(node.right.balanceFactor>0){this.rotateRight(node.right);this.rotateLeft(node);}else{this.rotateLeft(node);}}else if(node.balanceFactor>0){if(node.left.balanceFactor<0){this.rotateLeft(node.left);this.rotateRight(node);}else{this.rotateRight(node);}}}},{key:"rotateLeft",value:function rotateLeft(pivot){var root=pivot.right;pivot.right=root.left;if(root.left!==null){root.left.parent=pivot;}root.parent=pivot.parent;if(root.parent===null){this.root=root;}else if(pivot.isLeftChild){root.parent.left=root;}else{root.parent.right=root;}root.left=pivot;pivot.parent=root;pivot.balanceFactor=pivot.balanceFactor+1-Math.min(root.balanceFactor,0);root.balanceFactor=root.balanceFactor+1-Math.max(pivot.balanceFactor,0);}},{key:"rotateRight",value:function rotateRight(pivot){var root=pivot.left;pivot.left=root.right;if(root.right!==null){root.right.parent=pivot;}root.parent=pivot.parent;if(root.parent===null){this.root=root;}else if(pivot.isLeftChild){root.parent.left=root;}else{root.parent.right=root;}root.right=pivot;pivot.parent=root;pivot.balanceFactor=pivot.balanceFactor-1-Math.min(root.balanceFactor,0);root.balanceFactor=root.balanceFactor-1-Math.max(pivot.balanceFactor,0);}},{key:_iterator2.default,value:_regenerator2.default.mark(function value(){var fromleft,current;return _regenerator2.default.wrap(function value$(_context){while(1){switch(_context.prev=_context.next){case 0:if(this.root){_context.next=2;break;}return _context.abrupt("return",null);case 2:fromleft=true;current=this.root;while(current.left){current=current.left;}case 5:if(!fromleft){_context.next=23;break;}_context.next=8;return[current.key,current.value];case 8:fromleft=false;if(!current.right){_context.next=15;break;}current=current.right;while(current.left){current=current.left;}fromleft=true;_context.next=21;break;case 15:if(!current.parent){_context.next=20;break;}fromleft=current.parent.left===current;current=current.parent;_context.next=21;break;case 20:return _context.abrupt("break",31);case 21:_context.next=29;break;case 23:if(!current.parent){_context.next=28;break;}fromleft=current.parent.left===current;current=current.parent;_context.next=29;break;case 28:return _context.abrupt("break",31);case 29:_context.next=5;break;case 31:return _context.abrupt("return",null);case 32:case"end":return _context.stop();}}},value,this);})},{key:"getIterator",value:_regenerator2.default.mark(function getIterator(key){var currentNode,fromleft;return _regenerator2.default.wrap(function getIterator$(_context2){while(1){switch(_context2.prev=_context2.next){case 0:currentNode=this.root;case 1:if(!currentNode){_context2.next=7;break;}if(!this.isEqual(key,currentNode.key)){_context2.next=4;break;}return _context2.abrupt("break",7);case 4:if(this.isLessThan(key,currentNode.key)){currentNode=currentNode.left;}else{currentNode=currentNode.right;}_context2.next=1;break;case 7:fromleft=true;case 8:if(!fromleft){_context2.next=26;break;}_context2.next=11;return[currentNode.key,currentNode.value];case 11:fromleft=false;if(!currentNode.right){_context2.next=18;break;}currentNode=currentNode.right;while(currentNode.left){currentNode=currentNode.left;}fromleft=true;_context2.next=24;break;case 18:if(!currentNode.parent){_context2.next=23;break;}fromleft=currentNode.parent.left===currentNode;currentNode=currentNode.parent;_context2.next=24;break;case 23:return _context2.abrupt("break",34);case 24:_context2.next=32;break;case 26:if(!currentNode.parent){_context2.next=31;break;}fromleft=currentNode.parent.left===currentNode;currentNode=currentNode.parent;_context2.next=32;break;case 31:return _context2.abrupt("break",34);case 32:_context2.next=8;break;case 34:return _context2.abrupt("return",null);case 35:case"end":return _context2.stop();}}},getIterator,this);})},{key:"getReverseIterator",value:_regenerator2.default.mark(function getReverseIterator(key){var currentNode,fromright;return _regenerator2.default.wrap(function getReverseIterator$(_context3){while(1){switch(_context3.prev=_context3.next){case 0:currentNode=this.root;case 1:if(!currentNode){_context3.next=7;break;}if(!this.isEqual(key,currentNode.key)){_context3.next=4;break;}return _context3.abrupt("break",7);case 4:if(!this.isLessThan(key,currentNode.key)){currentNode=currentNode.left;}else{currentNode=currentNode.right;}_context3.next=1;break;case 7:fromright=true;case 8:if(!fromright){_context3.next=26;break;}_context3.next=11;return[currentNode.key,currentNode.value];case 11:fromright=false;if(!currentNode.left){_context3.next=18;break;}currentNode=currentNode.left;while(currentNode.right){currentNode=currentNode.right;}fromright=true;_context3.next=24;break;case 18:if(!currentNode.parent){_context3.next=23;break;}fromright=currentNode.parent.right===currentNode;currentNode=currentNode.parent;_context3.next=24;break;case 23:return _context3.abrupt("break",34);case 24:_context3.next=32;break;case 26:if(!currentNode.parent){_context3.next=31;break;}fromright=currentNode.parent.right===currentNode;currentNode=currentNode.parent;_context3.next=32;break;case 31:return _context3.abrupt("break",34);case 32:_context3.next=8;break;case 34:return _context3.abrupt("return",null);case 35:case"end":return _context3.stop();}}},getReverseIterator,this);})},{key:"size",get:function get(){return this.count;}}]);return TreeMap;}();exports.TreeMap=TreeMap;},{"babel-runtime/core-js/symbol/iterator":19,"babel-runtime/helpers/classCallCheck":21,"babel-runtime/helpers/createClass":22,"babel-runtime/regenerator":28}],172:[function(_dereq_,module,exports){/*
* loglevel - https://github.com/pimterry/loglevel
*
* Copyright (c) 2013 Tim Perry
* Licensed under the MIT license.
*/(function(root,definition){"use strict";if(typeof define==='function'&&define.amd){define(definition);}else if((typeof module==="undefined"?"undefined":_typeof4(module))==='object'&&module.exports){module.exports=definition();}else{root.log=definition();}})(this,function(){"use strict";var noop=function noop(){};var undefinedType="undefined";function realMethod(methodName){if((typeof console==="undefined"?"undefined":_typeof4(console))===undefinedType){return false;// We can't build a real method without a console to log to
}else if(console[methodName]!==undefined){return bindMethod(console,methodName);}else if(console.log!==undefined){return bindMethod(console,'log');}else{return noop;}}function bindMethod(obj,methodName){var method=obj[methodName];if(typeof method.bind==='function'){return method.bind(obj);}else{try{return Function.prototype.bind.call(method,obj);}catch(e){// Missing bind shim or IE8 + Modernizr, fallback to wrapping
return function(){return Function.prototype.apply.apply(method,[obj,arguments]);};}}}// these private functions always need `this` to be set properly
function enableLoggingWhenConsoleArrives(methodName,level,loggerName){return function(){if((typeof console==="undefined"?"undefined":_typeof4(console))!==undefinedType){replaceLoggingMethods.call(this,level,loggerName);this[methodName].apply(this,arguments);}};}function replaceLoggingMethods(level,loggerName){/*jshint validthis:true */for(var i=0;i<logMethods.length;i++){var methodName=logMethods[i];this[methodName]=i<level?noop:this.methodFactory(methodName,level,loggerName);}}function defaultMethodFactory(methodName,level,loggerName){/*jshint validthis:true */return realMethod(methodName)||enableLoggingWhenConsoleArrives.apply(this,arguments);}var logMethods=["trace","debug","info","warn","error"];function Logger(name,defaultLevel,factory){var self=this;var currentLevel;var storageKey="loglevel";if(name){storageKey+=":"+name;}function persistLevelIfPossible(levelNum){var levelName=(logMethods[levelNum]||'silent').toUpperCase();// Use localStorage if available
try{window.localStorage[storageKey]=levelName;return;}catch(ignore){}// Use session cookie as fallback
try{window.document.cookie=encodeURIComponent(storageKey)+"="+levelName+";";}catch(ignore){}}function getPersistedLevel(){var storedLevel;try{storedLevel=window.localStorage[storageKey];}catch(ignore){}if((typeof storedLevel==="undefined"?"undefined":_typeof4(storedLevel))===undefinedType){try{var cookie=window.document.cookie;var location=cookie.indexOf(encodeURIComponent(storageKey)+"=");if(location){storedLevel=/^([^;]+)/.exec(cookie.slice(location))[1];}}catch(ignore){}}// If the stored level is not valid, treat it as if nothing was stored.
if(self.levels[storedLevel]===undefined){storedLevel=undefined;}return storedLevel;}/*
       *
       * Public API
       *
       */self.levels={"TRACE":0,"DEBUG":1,"INFO":2,"WARN":3,"ERROR":4,"SILENT":5};self.methodFactory=factory||defaultMethodFactory;self.getLevel=function(){return currentLevel;};self.setLevel=function(level,persist){if(typeof level==="string"&&self.levels[level.toUpperCase()]!==undefined){level=self.levels[level.toUpperCase()];}if(typeof level==="number"&&level>=0&&level<=self.levels.SILENT){currentLevel=level;if(persist!==false){// defaults to true
persistLevelIfPossible(level);}replaceLoggingMethods.call(self,level,name);if((typeof console==="undefined"?"undefined":_typeof4(console))===undefinedType&&level<self.levels.SILENT){return"No console available for logging";}}else{throw"log.setLevel() called with invalid level: "+level;}};self.setDefaultLevel=function(level){if(!getPersistedLevel()){self.setLevel(level,false);}};self.enableAll=function(persist){self.setLevel(self.levels.TRACE,persist);};self.disableAll=function(persist){self.setLevel(self.levels.SILENT,persist);};// Initialize with the right level
var initialLevel=getPersistedLevel();if(initialLevel==null){initialLevel=defaultLevel==null?"WARN":defaultLevel;}self.setLevel(initialLevel,false);}/*
     *
     * Package-level API
     *
     */var defaultLogger=new Logger();var _loggersByName={};defaultLogger.getLogger=function getLogger(name){if(typeof name!=="string"||name===""){throw new TypeError("You must supply a name when creating a logger.");}var logger=_loggersByName[name];if(!logger){logger=_loggersByName[name]=new Logger(name,defaultLogger.getLevel(),defaultLogger.methodFactory);}return logger;};// Grab the current global log variable in case of overwrite
var _log=(typeof window==="undefined"?"undefined":_typeof4(window))!==undefinedType?window.log:undefined;defaultLogger.noConflict=function(){if((typeof window==="undefined"?"undefined":_typeof4(window))!==undefinedType&&window.log===defaultLogger){window.log=_log;}return defaultLogger;};return defaultLogger;});},{}],173:[function(_dereq_,module,exports){"use strict";var __extends=this&&this.__extends||function(d,b){for(var p in b){if(b.hasOwnProperty(p))d[p]=b[p];}function __(){this.constructor=d;}d.prototype=b===null?Object.create(b):(__.prototype=b.prototype,new __());};var events_1=_dereq_("events");/**
 *
 */var Retrier=function(_super){__extends(Retrier,_super);/**
     * Creates a new Retrier instance
     */function Retrier(options){var _this=_super.call(this)||this;_this.minDelay=options.min;_this.maxDelay=options.max;_this.initialDelay=options.initial||0;_this.maxAttemptsCount=options.maxAttemptsCount||0;_this.maxAttemptsTime=options.maxAttemptsTime||0;_this.inProgress=false;_this.attemptNum=0;_this.prevDelay=0;_this.currDelay=0;return _this;}Retrier.prototype.attempt=function(){clearTimeout(this.timeout);this.attemptNum++;this.timeout=null;this.emit("attempt");};Retrier.prototype.nextDelay=function(){if(this.attemptNum==0){return this.initialDelay;}if(this.attemptNum==1){this.currDelay=this.minDelay;return this.currDelay;}var delay=this.currDelay+this.prevDelay;this.prevDelay=this.currDelay;this.currDelay=delay;return delay;};Retrier.prototype.scheduleAttempt=function(){var _this=this;if(this.maxAttemptsCount&&this.attemptNum>=this.maxAttemptsCount){this.cleanup();this.emit('failed',new Error('Maximum attempt count limit reached'));this.reject(new Error('Maximum attempt count reached'));return;}var delay=this.nextDelay();if(this.maxAttemptsTime&&this.startTimestamp+this.maxAttemptsTime<Date.now()+delay){this.cleanup();this.emit('failed',new Error('Maximum attempt time limit reached'));this.reject(new Error('Maximum attempt time limit reached'));}this.timeout=setTimeout(function(){return _this.attempt();},delay);};Retrier.prototype.cleanup=function(){clearTimeout(this.timeout);this.timeout=null;this.inProgress=false;this.attemptNum=0;this.prevDelay=0;this.currDelay=0;};Retrier.prototype.start=function(){var _this=this;if(this.inProgress){throw new Error('Retrier is already in progress');}this.inProgress=true;return new Promise(function(resolve,reject){_this.resolve=resolve;_this.reject=reject;_this.startTimestamp=Date.now();_this.scheduleAttempt();});};Retrier.prototype.cancel=function(){if(this.timeout){clearTimeout(this.timeout);this.timeout=null;this.inProgress=false;this.emit("cancelled");this.reject(new Error("Cancelled"));}};Retrier.prototype.succeeded=function(arg){this.emit("succeeded",arg);this.resolve(arg);};Retrier.prototype.failed=function(err){if(this.timeout){throw new Error("Retrier attempt is already in progress");}this.scheduleAttempt();};Retrier.prototype.run=function(handler){var _this=this;this.on('attempt',function(){handler().then(function(v){return _this.succeeded(v);}).catch(function(e){return _this.failed(e);});});return this.start();};return Retrier;}(events_1.EventEmitter);Object.defineProperty(exports,"__esModule",{value:true});exports.default=Retrier;},{"events":169}],174:[function(_dereq_,module,exports){(function(global){/*!
 * Platform.js <https://mths.be/platform>
 * Copyright 2014-2016 Benjamin Tan <https://demoneaux.github.io/>
 * Copyright 2011-2013 John-David Dalton <http://allyoucanleet.com/>
 * Available under MIT license <https://mths.be/mit>
 */;(function(){'use strict';/** Used to determine if values are of the language type `Object`. */var objectTypes={'function':true,'object':true};/** Used as a reference to the global object. */var root=objectTypes[typeof window==="undefined"?"undefined":_typeof4(window)]&&window||this;/** Backup possible global object. */var oldRoot=root;/** Detect free variable `exports`. */var freeExports=objectTypes[typeof exports==="undefined"?"undefined":_typeof4(exports)]&&exports;/** Detect free variable `module`. */var freeModule=objectTypes[typeof module==="undefined"?"undefined":_typeof4(module)]&&module&&!module.nodeType&&module;/** Detect free variable `global` from Node.js or Browserified code and use it as `root`. */var freeGlobal=freeExports&&freeModule&&(typeof global==="undefined"?"undefined":_typeof4(global))=='object'&&global;if(freeGlobal&&(freeGlobal.global===freeGlobal||freeGlobal.window===freeGlobal||freeGlobal.self===freeGlobal)){root=freeGlobal;}/**
   * Used as the maximum length of an array-like object.
   * See the [ES6 spec](http://people.mozilla.org/~jorendorff/es6-draft.html#sec-tolength)
   * for more details.
   */var maxSafeInteger=Math.pow(2,53)-1;/** Regular expression to detect Opera. */var reOpera=/\bOpera/;/** Possible global object. */var thisBinding=this;/** Used for native method references. */var objectProto=Object.prototype;/** Used to check for own properties of an object. */var hasOwnProperty=objectProto.hasOwnProperty;/** Used to resolve the internal `[[Class]]` of values. */var toString=objectProto.toString;/*--------------------------------------------------------------------------*//**
   * Capitalizes a string value.
   *
   * @private
   * @param {string} string The string to capitalize.
   * @returns {string} The capitalized string.
   */function capitalize(string){string=String(string);return string.charAt(0).toUpperCase()+string.slice(1);}/**
   * A utility function to clean up the OS name.
   *
   * @private
   * @param {string} os The OS name to clean up.
   * @param {string} [pattern] A `RegExp` pattern matching the OS name.
   * @param {string} [label] A label for the OS.
   */function cleanupOS(os,pattern,label){// Platform tokens are defined at:
// http://msdn.microsoft.com/en-us/library/ms537503(VS.85).aspx
// http://web.archive.org/web/20081122053950/http://msdn.microsoft.com/en-us/library/ms537503(VS.85).aspx
var data={'10.0':'10','6.4':'10 Technical Preview','6.3':'8.1','6.2':'8','6.1':'Server 2008 R2 / 7','6.0':'Server 2008 / Vista','5.2':'Server 2003 / XP 64-bit','5.1':'XP','5.01':'2000 SP1','5.0':'2000','4.0':'NT','4.90':'ME'};// Detect Windows version from platform tokens.
if(pattern&&label&&/^Win/i.test(os)&&!/^Windows Phone /i.test(os)&&(data=data[/[\d.]+$/.exec(os)])){os='Windows '+data;}// Correct character case and cleanup string.
os=String(os);if(pattern&&label){os=os.replace(RegExp(pattern,'i'),label);}os=format(os.replace(/ ce$/i,' CE').replace(/\bhpw/i,'web').replace(/\bMacintosh\b/,'Mac OS').replace(/_PowerPC\b/i,' OS').replace(/\b(OS X) [^ \d]+/i,'$1').replace(/\bMac (OS X)\b/,'$1').replace(/\/(\d)/,' $1').replace(/_/g,'.').replace(/(?: BePC|[ .]*fc[ \d.]+)$/i,'').replace(/\bx86\.64\b/gi,'x86_64').replace(/\b(Windows Phone) OS\b/,'$1').replace(/\b(Chrome OS \w+) [\d.]+\b/,'$1').split(' on ')[0]);return os;}/**
   * An iteration utility for arrays and objects.
   *
   * @private
   * @param {Array|Object} object The object to iterate over.
   * @param {Function} callback The function called per iteration.
   */function each(object,callback){var index=-1,length=object?object.length:0;if(typeof length=='number'&&length>-1&&length<=maxSafeInteger){while(++index<length){callback(object[index],index,object);}}else{forOwn(object,callback);}}/**
   * Trim and conditionally capitalize string values.
   *
   * @private
   * @param {string} string The string to format.
   * @returns {string} The formatted string.
   */function format(string){string=trim(string);return /^(?:webOS|i(?:OS|P))/.test(string)?string:capitalize(string);}/**
   * Iterates over an object's own properties, executing the `callback` for each.
   *
   * @private
   * @param {Object} object The object to iterate over.
   * @param {Function} callback The function executed per own property.
   */function forOwn(object,callback){for(var key in object){if(hasOwnProperty.call(object,key)){callback(object[key],key,object);}}}/**
   * Gets the internal `[[Class]]` of a value.
   *
   * @private
   * @param {*} value The value.
   * @returns {string} The `[[Class]]`.
   */function getClassOf(value){return value==null?capitalize(value):toString.call(value).slice(8,-1);}/**
   * Host objects can return type values that are different from their actual
   * data type. The objects we are concerned with usually return non-primitive
   * types of "object", "function", or "unknown".
   *
   * @private
   * @param {*} object The owner of the property.
   * @param {string} property The property to check.
   * @returns {boolean} Returns `true` if the property value is a non-primitive, else `false`.
   */function isHostType(object,property){var type=object!=null?_typeof4(object[property]):'number';return!/^(?:boolean|number|string|undefined)$/.test(type)&&(type=='object'?!!object[property]:true);}/**
   * Prepares a string for use in a `RegExp` by making hyphens and spaces optional.
   *
   * @private
   * @param {string} string The string to qualify.
   * @returns {string} The qualified string.
   */function qualify(string){return String(string).replace(/([ -])(?!$)/g,'$1?');}/**
   * A bare-bones `Array#reduce` like utility function.
   *
   * @private
   * @param {Array} array The array to iterate over.
   * @param {Function} callback The function called per iteration.
   * @returns {*} The accumulated result.
   */function reduce(array,callback){var accumulator=null;each(array,function(value,index){accumulator=callback(accumulator,value,index,array);});return accumulator;}/**
   * Removes leading and trailing whitespace from a string.
   *
   * @private
   * @param {string} string The string to trim.
   * @returns {string} The trimmed string.
   */function trim(string){return String(string).replace(/^ +| +$/g,'');}/*--------------------------------------------------------------------------*//**
   * Creates a new platform object.
   *
   * @memberOf platform
   * @param {Object|string} [ua=navigator.userAgent] The user agent string or
   *  context object.
   * @returns {Object} A platform object.
   */function parse(ua){/** The environment context object. */var context=root;/** Used to flag when a custom context is provided. */var isCustomContext=ua&&(typeof ua==="undefined"?"undefined":_typeof4(ua))=='object'&&getClassOf(ua)!='String';// Juggle arguments.
if(isCustomContext){context=ua;ua=null;}/** Browser navigator object. */var nav=context.navigator||{};/** Browser user agent string. */var userAgent=nav.userAgent||'';ua||(ua=userAgent);/** Used to flag when `thisBinding` is the [ModuleScope]. */var isModuleScope=isCustomContext||thisBinding==oldRoot;/** Used to detect if browser is like Chrome. */var likeChrome=isCustomContext?!!nav.likeChrome:/\bChrome\b/.test(ua)&&!/internal|\n/i.test(toString.toString());/** Internal `[[Class]]` value shortcuts. */var objectClass='Object',airRuntimeClass=isCustomContext?objectClass:'ScriptBridgingProxyObject',enviroClass=isCustomContext?objectClass:'Environment',javaClass=isCustomContext&&context.java?'JavaPackage':getClassOf(context.java),phantomClass=isCustomContext?objectClass:'RuntimeObject';/** Detect Java environments. */var java=/\bJava/.test(javaClass)&&context.java;/** Detect Rhino. */var rhino=java&&getClassOf(context.environment)==enviroClass;/** A character to represent alpha. */var alpha=java?'a':"\u03B1";/** A character to represent beta. */var beta=java?'b':"\u03B2";/** Browser document object. */var doc=context.document||{};/**
     * Detect Opera browser (Presto-based).
     * http://www.howtocreate.co.uk/operaStuff/operaObject.html
     * http://dev.opera.com/articles/view/opera-mini-web-content-authoring-guidelines/#operamini
     */var opera=context.operamini||context.opera;/** Opera `[[Class]]`. */var operaClass=reOpera.test(operaClass=isCustomContext&&opera?opera['[[Class]]']:getClassOf(opera))?operaClass:opera=null;/*------------------------------------------------------------------------*//** Temporary variable used over the script's lifetime. */var data;/** The CPU architecture. */var arch=ua;/** Platform description array. */var description=[];/** Platform alpha/beta indicator. */var prerelease=null;/** A flag to indicate that environment features should be used to resolve the platform. */var useFeatures=ua==userAgent;/** The browser/environment version. */var version=useFeatures&&opera&&typeof opera.version=='function'&&opera.version();/** A flag to indicate if the OS ends with "/ Version" */var isSpecialCasedOS;/* Detectable layout engines (order is important). */var layout=getLayout([{'label':'EdgeHTML','pattern':'Edge'},'Trident',{'label':'WebKit','pattern':'AppleWebKit'},'iCab','Presto','NetFront','Tasman','KHTML','Gecko']);/* Detectable browser names (order is important). */var name=getName(['Adobe AIR','Arora','Avant Browser','Breach','Camino','Epiphany','Fennec','Flock','Galeon','GreenBrowser','iCab','Iceweasel','K-Meleon','Konqueror','Lunascape','Maxthon',{'label':'Microsoft Edge','pattern':'Edge'},'Midori','Nook Browser','PaleMoon','PhantomJS','Raven','Rekonq','RockMelt','SeaMonkey',{'label':'Silk','pattern':'(?:Cloud9|Silk-Accelerated)'},'Sleipnir','SlimBrowser',{'label':'SRWare Iron','pattern':'Iron'},'Sunrise','Swiftfox','WebPositive','Opera Mini',{'label':'Opera Mini','pattern':'OPiOS'},'Opera',{'label':'Opera','pattern':'OPR'},'Chrome',{'label':'Chrome Mobile','pattern':'(?:CriOS|CrMo)'},{'label':'Firefox','pattern':'(?:Firefox|Minefield)'},{'label':'Firefox for iOS','pattern':'FxiOS'},{'label':'IE','pattern':'IEMobile'},{'label':'IE','pattern':'MSIE'},'Safari']);/* Detectable products (order is important). */var product=getProduct([{'label':'BlackBerry','pattern':'BB10'},'BlackBerry',{'label':'Galaxy S','pattern':'GT-I9000'},{'label':'Galaxy S2','pattern':'GT-I9100'},{'label':'Galaxy S3','pattern':'GT-I9300'},{'label':'Galaxy S4','pattern':'GT-I9500'},'Google TV','Lumia','iPad','iPod','iPhone','Kindle',{'label':'Kindle Fire','pattern':'(?:Cloud9|Silk-Accelerated)'},'Nexus','Nook','PlayBook','PlayStation 3','PlayStation 4','PlayStation Vita','TouchPad','Transformer',{'label':'Wii U','pattern':'WiiU'},'Wii','Xbox One',{'label':'Xbox 360','pattern':'Xbox'},'Xoom']);/* Detectable manufacturers. */var manufacturer=getManufacturer({'Apple':{'iPad':1,'iPhone':1,'iPod':1},'Archos':{},'Amazon':{'Kindle':1,'Kindle Fire':1},'Asus':{'Transformer':1},'Barnes & Noble':{'Nook':1},'BlackBerry':{'PlayBook':1},'Google':{'Google TV':1,'Nexus':1},'HP':{'TouchPad':1},'HTC':{},'LG':{},'Microsoft':{'Xbox':1,'Xbox One':1},'Motorola':{'Xoom':1},'Nintendo':{'Wii U':1,'Wii':1},'Nokia':{'Lumia':1},'Samsung':{'Galaxy S':1,'Galaxy S2':1,'Galaxy S3':1,'Galaxy S4':1},'Sony':{'PlayStation 4':1,'PlayStation 3':1,'PlayStation Vita':1}});/* Detectable operating systems (order is important). */var os=getOS(['Windows Phone','Android','CentOS',{'label':'Chrome OS','pattern':'CrOS'},'Debian','Fedora','FreeBSD','Gentoo','Haiku','Kubuntu','Linux Mint','OpenBSD','Red Hat','SuSE','Ubuntu','Xubuntu','Cygwin','Symbian OS','hpwOS','webOS ','webOS','Tablet OS','Linux','Mac OS X','Macintosh','Mac','Windows 98;','Windows ']);/*------------------------------------------------------------------------*//**
     * Picks the layout engine from an array of guesses.
     *
     * @private
     * @param {Array} guesses An array of guesses.
     * @returns {null|string} The detected layout engine.
     */function getLayout(guesses){return reduce(guesses,function(result,guess){return result||RegExp('\\b'+(guess.pattern||qualify(guess))+'\\b','i').exec(ua)&&(guess.label||guess);});}/**
     * Picks the manufacturer from an array of guesses.
     *
     * @private
     * @param {Array} guesses An object of guesses.
     * @returns {null|string} The detected manufacturer.
     */function getManufacturer(guesses){return reduce(guesses,function(result,value,key){// Lookup the manufacturer by product or scan the UA for the manufacturer.
return result||(value[product]||value[/^[a-z]+(?: +[a-z]+\b)*/i.exec(product)]||RegExp('\\b'+qualify(key)+'(?:\\b|\\w*\\d)','i').exec(ua))&&key;});}/**
     * Picks the browser name from an array of guesses.
     *
     * @private
     * @param {Array} guesses An array of guesses.
     * @returns {null|string} The detected browser name.
     */function getName(guesses){return reduce(guesses,function(result,guess){return result||RegExp('\\b'+(guess.pattern||qualify(guess))+'\\b','i').exec(ua)&&(guess.label||guess);});}/**
     * Picks the OS name from an array of guesses.
     *
     * @private
     * @param {Array} guesses An array of guesses.
     * @returns {null|string} The detected OS name.
     */function getOS(guesses){return reduce(guesses,function(result,guess){var pattern=guess.pattern||qualify(guess);if(!result&&(result=RegExp('\\b'+pattern+'(?:/[\\d.]+|[ \\w.]*)','i').exec(ua))){result=cleanupOS(result,pattern,guess.label||guess);}return result;});}/**
     * Picks the product name from an array of guesses.
     *
     * @private
     * @param {Array} guesses An array of guesses.
     * @returns {null|string} The detected product name.
     */function getProduct(guesses){return reduce(guesses,function(result,guess){var pattern=guess.pattern||qualify(guess);if(!result&&(result=RegExp('\\b'+pattern+' *\\d+[.\\w_]*','i').exec(ua)||RegExp('\\b'+pattern+'(?:; *(?:[a-z]+[_-])?[a-z]+\\d+|[^ ();-]*)','i').exec(ua))){// Split by forward slash and append product version if needed.
if((result=String(guess.label&&!RegExp(pattern,'i').test(guess.label)?guess.label:result).split('/'))[1]&&!/[\d.]+/.test(result[0])){result[0]+=' '+result[1];}// Correct character case and cleanup string.
guess=guess.label||guess;result=format(result[0].replace(RegExp(pattern,'i'),guess).replace(RegExp('; *(?:'+guess+'[_-])?','i'),' ').replace(RegExp('('+guess+')[-_.]?(\\w)','i'),'$1 $2'));}return result;});}/**
     * Resolves the version using an array of UA patterns.
     *
     * @private
     * @param {Array} patterns An array of UA patterns.
     * @returns {null|string} The detected version.
     */function getVersion(patterns){return reduce(patterns,function(result,pattern){return result||(RegExp(pattern+'(?:-[\\d.]+/|(?: for [\\w-]+)?[ /-])([\\d.]+[^ ();/_-]*)','i').exec(ua)||0)[1]||null;});}/**
     * Returns `platform.description` when the platform object is coerced to a string.
     *
     * @name toString
     * @memberOf platform
     * @returns {string} Returns `platform.description` if available, else an empty string.
     */function toStringPlatform(){return this.description||'';}/*------------------------------------------------------------------------*/// Convert layout to an array so we can add extra details.
layout&&(layout=[layout]);// Detect product names that contain their manufacturer's name.
if(manufacturer&&!product){product=getProduct([manufacturer]);}// Clean up Google TV.
if(data=/\bGoogle TV\b/.exec(product)){product=data[0];}// Detect simulators.
if(/\bSimulator\b/i.test(ua)){product=(product?product+' ':'')+'Simulator';}// Detect Opera Mini 8+ running in Turbo/Uncompressed mode on iOS.
if(name=='Opera Mini'&&/\bOPiOS\b/.test(ua)){description.push('running in Turbo/Uncompressed mode');}// Detect IE Mobile 11.
if(name=='IE'&&/\blike iPhone OS\b/.test(ua)){data=parse(ua.replace(/like iPhone OS/,''));manufacturer=data.manufacturer;product=data.product;}// Detect iOS.
else if(/^iP/.test(product)){name||(name='Safari');os='iOS'+((data=/ OS ([\d_]+)/i.exec(ua))?' '+data[1].replace(/_/g,'.'):'');}// Detect Kubuntu.
else if(name=='Konqueror'&&!/buntu/i.test(os)){os='Kubuntu';}// Detect Android browsers.
else if(manufacturer&&manufacturer!='Google'&&(/Chrome/.test(name)&&!/\bMobile Safari\b/i.test(ua)||/\bVita\b/.test(product))||/\bAndroid\b/.test(os)&&/^Chrome/.test(name)&&/\bVersion\//i.test(ua)){name='Android Browser';os=/\bAndroid\b/.test(os)?os:'Android';}// Detect Silk desktop/accelerated modes.
else if(name=='Silk'){if(!/\bMobi/i.test(ua)){os='Android';description.unshift('desktop mode');}if(/Accelerated *= *true/i.test(ua)){description.unshift('accelerated');}}// Detect PaleMoon identifying as Firefox.
else if(name=='PaleMoon'&&(data=/\bFirefox\/([\d.]+)\b/.exec(ua))){description.push('identifying as Firefox '+data[1]);}// Detect Firefox OS and products running Firefox.
else if(name=='Firefox'&&(data=/\b(Mobile|Tablet|TV)\b/i.exec(ua))){os||(os='Firefox OS');product||(product=data[1]);}// Detect false positives for Firefox/Safari.
else if(!name||(data=!/\bMinefield\b/i.test(ua)&&/\b(?:Firefox|Safari)\b/.exec(name))){// Escape the `/` for Firefox 1.
if(name&&!product&&/[\/,]|^[^(]+?\)/.test(ua.slice(ua.indexOf(data+'/')+8))){// Clear name of false positives.
name=null;}// Reassign a generic name.
if((data=product||manufacturer||os)&&(product||manufacturer||/\b(?:Android|Symbian OS|Tablet OS|webOS)\b/.test(os))){name=/[a-z]+(?: Hat)?/i.exec(/\bAndroid\b/.test(os)?os:data)+' Browser';}}// Detect non-Opera (Presto-based) versions (order is important).
if(!version){version=getVersion(['(?:Cloud9|CriOS|CrMo|Edge|FxiOS|IEMobile|Iron|Opera ?Mini|OPiOS|OPR|Raven|Silk(?!/[\\d.]+$))','Version',qualify(name),'(?:Firefox|Minefield|NetFront)']);}// Detect stubborn layout engines.
if(data=layout=='iCab'&&parseFloat(version)>3&&'WebKit'||/\bOpera\b/.test(name)&&(/\bOPR\b/.test(ua)?'Blink':'Presto')||/\b(?:Midori|Nook|Safari)\b/i.test(ua)&&!/^(?:Trident|EdgeHTML)$/.test(layout)&&'WebKit'||!layout&&/\bMSIE\b/i.test(ua)&&(os=='Mac OS'?'Tasman':'Trident')||layout=='WebKit'&&/\bPlayStation\b(?! Vita\b)/i.test(name)&&'NetFront'){layout=[data];}// Detect Windows Phone 7 desktop mode.
if(name=='IE'&&(data=(/; *(?:XBLWP|ZuneWP)(\d+)/i.exec(ua)||0)[1])){name+=' Mobile';os='Windows Phone '+(/\+$/.test(data)?data:data+'.x');description.unshift('desktop mode');}// Detect Windows Phone 8.x desktop mode.
else if(/\bWPDesktop\b/i.test(ua)){name='IE Mobile';os='Windows Phone 8.x';description.unshift('desktop mode');version||(version=(/\brv:([\d.]+)/.exec(ua)||0)[1]);}// Detect IE 11.
else if(name!='IE'&&layout=='Trident'&&(data=/\brv:([\d.]+)/.exec(ua))){if(name){description.push('identifying as '+name+(version?' '+version:''));}name='IE';version=data[1];}// Leverage environment features.
if(useFeatures){// Detect server-side environments.
// Rhino has a global function while others have a global object.
if(isHostType(context,'global')){if(java){data=java.lang.System;arch=data.getProperty('os.arch');os=os||data.getProperty('os.name')+' '+data.getProperty('os.version');}if(isModuleScope&&isHostType(context,'system')&&(data=[context.system])[0]){os||(os=data[0].os||null);try{data[1]=context.require('ringo/engine').version;version=data[1].join('.');name='RingoJS';}catch(e){if(data[0].global.system==context.system){name='Narwhal';}}}else if(_typeof4(context.process)=='object'&&!context.process.browser&&(data=context.process)){name='Node.js';arch=data.arch;os=data.platform;version=/[\d.]+/.exec(data.version)[0];}else if(rhino){name='Rhino';}}// Detect Adobe AIR.
else if(getClassOf(data=context.runtime)==airRuntimeClass){name='Adobe AIR';os=data.flash.system.Capabilities.os;}// Detect PhantomJS.
else if(getClassOf(data=context.phantom)==phantomClass){name='PhantomJS';version=(data=data.version||null)&&data.major+'.'+data.minor+'.'+data.patch;}// Detect IE compatibility modes.
else if(typeof doc.documentMode=='number'&&(data=/\bTrident\/(\d+)/i.exec(ua))){// We're in compatibility mode when the Trident version + 4 doesn't
// equal the document mode.
version=[version,doc.documentMode];if((data=+data[1]+4)!=version[1]){description.push('IE '+version[1]+' mode');layout&&(layout[1]='');version[1]=data;}version=name=='IE'?String(version[1].toFixed(1)):version[0];}os=os&&format(os);}// Detect prerelease phases.
if(version&&(data=/(?:[ab]|dp|pre|[ab]\d+pre)(?:\d+\+?)?$/i.exec(version)||/(?:alpha|beta)(?: ?\d)?/i.exec(ua+';'+(useFeatures&&nav.appMinorVersion))||/\bMinefield\b/i.test(ua)&&'a')){prerelease=/b/i.test(data)?'beta':'alpha';version=version.replace(RegExp(data+'\\+?$'),'')+(prerelease=='beta'?beta:alpha)+(/\d+\+?/.exec(data)||'');}// Detect Firefox Mobile.
if(name=='Fennec'||name=='Firefox'&&/\b(?:Android|Firefox OS)\b/.test(os)){name='Firefox Mobile';}// Obscure Maxthon's unreliable version.
else if(name=='Maxthon'&&version){version=version.replace(/\.[\d.]+/,'.x');}// Detect Xbox 360 and Xbox One.
else if(/\bXbox\b/i.test(product)){os=null;if(product=='Xbox 360'&&/\bIEMobile\b/.test(ua)){description.unshift('mobile mode');}}// Add mobile postfix.
else if((/^(?:Chrome|IE|Opera)$/.test(name)||name&&!product&&!/Browser|Mobi/.test(name))&&(os=='Windows CE'||/Mobi/i.test(ua))){name+=' Mobile';}// Detect IE platform preview.
else if(name=='IE'&&useFeatures&&context.external===null){description.unshift('platform preview');}// Detect BlackBerry OS version.
// http://docs.blackberry.com/en/developers/deliverables/18169/HTTP_headers_sent_by_BB_Browser_1234911_11.jsp
else if((/\bBlackBerry\b/.test(product)||/\bBB10\b/.test(ua))&&(data=(RegExp(product.replace(/ +/g,' *')+'/([.\\d]+)','i').exec(ua)||0)[1]||version)){data=[data,/BB10/.test(ua)];os=(data[1]?(product=null,manufacturer='BlackBerry'):'Device Software')+' '+data[0];version=null;}// Detect Opera identifying/masking itself as another browser.
// http://www.opera.com/support/kb/view/843/
else if(this!=forOwn&&product!='Wii'&&(useFeatures&&opera||/Opera/.test(name)&&/\b(?:MSIE|Firefox)\b/i.test(ua)||name=='Firefox'&&/\bOS X (?:\d+\.){2,}/.test(os)||name=='IE'&&(os&&!/^Win/.test(os)&&version>5.5||/\bWindows XP\b/.test(os)&&version>8||version==8&&!/\bTrident\b/.test(ua)))&&!reOpera.test(data=parse.call(forOwn,ua.replace(reOpera,'')+';'))&&data.name){// When "identifying", the UA contains both Opera and the other browser's name.
data='ing as '+data.name+((data=data.version)?' '+data:'');if(reOpera.test(name)){if(/\bIE\b/.test(data)&&os=='Mac OS'){os=null;}data='identify'+data;}// When "masking", the UA contains only the other browser's name.
else{data='mask'+data;if(operaClass){name=format(operaClass.replace(/([a-z])([A-Z])/g,'$1 $2'));}else{name='Opera';}if(/\bIE\b/.test(data)){os=null;}if(!useFeatures){version=null;}}layout=['Presto'];description.push(data);}// Detect WebKit Nightly and approximate Chrome/Safari versions.
if(data=(/\bAppleWebKit\/([\d.]+\+?)/i.exec(ua)||0)[1]){// Correct build number for numeric comparison.
// (e.g. "532.5" becomes "532.05")
data=[parseFloat(data.replace(/\.(\d)$/,'.0$1')),data];// Nightly builds are postfixed with a "+".
if(name=='Safari'&&data[1].slice(-1)=='+'){name='WebKit Nightly';prerelease='alpha';version=data[1].slice(0,-1);}// Clear incorrect browser versions.
else if(version==data[1]||version==(data[2]=(/\bSafari\/([\d.]+\+?)/i.exec(ua)||0)[1])){version=null;}// Use the full Chrome version when available.
data[1]=(/\bChrome\/([\d.]+)/i.exec(ua)||0)[1];// Detect Blink layout engine.
if(data[0]==537.36&&data[2]==537.36&&parseFloat(data[1])>=28&&layout=='WebKit'){layout=['Blink'];}// Detect JavaScriptCore.
// http://stackoverflow.com/questions/6768474/how-can-i-detect-which-javascript-engine-v8-or-jsc-is-used-at-runtime-in-androi
if(!useFeatures||!likeChrome&&!data[1]){layout&&(layout[1]='like Safari');data=(data=data[0],data<400?1:data<500?2:data<526?3:data<533?4:data<534?'4+':data<535?5:data<537?6:data<538?7:data<601?8:'8');}else{layout&&(layout[1]='like Chrome');data=data[1]||(data=data[0],data<530?1:data<532?2:data<532.05?3:data<533?4:data<534.03?5:data<534.07?6:data<534.10?7:data<534.13?8:data<534.16?9:data<534.24?10:data<534.30?11:data<535.01?12:data<535.02?'13+':data<535.07?15:data<535.11?16:data<535.19?17:data<536.05?18:data<536.10?19:data<537.01?20:data<537.11?'21+':data<537.13?23:data<537.18?24:data<537.24?25:data<537.36?26:layout!='Blink'?'27':'28');}// Add the postfix of ".x" or "+" for approximate versions.
layout&&(layout[1]+=' '+(data+=typeof data=='number'?'.x':/[.+]/.test(data)?'':'+'));// Obscure version for some Safari 1-2 releases.
if(name=='Safari'&&(!version||parseInt(version)>45)){version=data;}}// Detect Opera desktop modes.
if(name=='Opera'&&(data=/\bzbov|zvav$/.exec(os))){name+=' ';description.unshift('desktop mode');if(data=='zvav'){name+='Mini';version=null;}else{name+='Mobile';}os=os.replace(RegExp(' *'+data+'$'),'');}// Detect Chrome desktop mode.
else if(name=='Safari'&&/\bChrome\b/.exec(layout&&layout[1])){description.unshift('desktop mode');name='Chrome Mobile';version=null;if(/\bOS X\b/.test(os)){manufacturer='Apple';os='iOS 4.3+';}else{os=null;}}// Strip incorrect OS versions.
if(version&&version.indexOf(data=/[\d.]+$/.exec(os))==0&&ua.indexOf('/'+data+'-')>-1){os=trim(os.replace(data,''));}// Add layout engine.
if(layout&&!/\b(?:Avant|Nook)\b/.test(name)&&(/Browser|Lunascape|Maxthon/.test(name)||name!='Safari'&&/^iOS/.test(os)&&/\bSafari\b/.test(layout[1])||/^(?:Adobe|Arora|Breach|Midori|Opera|Phantom|Rekonq|Rock|Sleipnir|Web)/.test(name)&&layout[1])){// Don't add layout details to description if they are falsey.
(data=layout[layout.length-1])&&description.push(data);}// Combine contextual information.
if(description.length){description=['('+description.join('; ')+')'];}// Append manufacturer to description.
if(manufacturer&&product&&product.indexOf(manufacturer)<0){description.push('on '+manufacturer);}// Append product to description.
if(product){description.push((/^on /.test(description[description.length-1])?'':'on ')+product);}// Parse the OS into an object.
if(os){data=/ ([\d.+]+)$/.exec(os);isSpecialCasedOS=data&&os.charAt(os.length-data[0].length-1)=='/';os={'architecture':32,'family':data&&!isSpecialCasedOS?os.replace(data[0],''):os,'version':data?data[1]:null,'toString':function toString(){var version=this.version;return this.family+(version&&!isSpecialCasedOS?' '+version:'')+(this.architecture==64?' 64-bit':'');}};}// Add browser/OS architecture.
if((data=/\b(?:AMD|IA|Win|WOW|x86_|x)64\b/i.exec(arch))&&!/\bi686\b/i.test(arch)){if(os){os.architecture=64;os.family=os.family.replace(RegExp(' *'+data),'');}if(name&&(/\bWOW64\b/i.test(ua)||useFeatures&&/\w(?:86|32)$/.test(nav.cpuClass||nav.platform)&&!/\bWin64; x64\b/i.test(ua))){description.unshift('32-bit');}}// Chrome 39 and above on OS X is always 64-bit.
else if(os&&/^OS X/.test(os.family)&&name=='Chrome'&&parseFloat(version)>=39){os.architecture=64;}ua||(ua=null);/*------------------------------------------------------------------------*//**
     * The platform object.
     *
     * @name platform
     * @type Object
     */var platform={};/**
     * The platform description.
     *
     * @memberOf platform
     * @type string|null
     */platform.description=ua;/**
     * The name of the browser's layout engine.
     *
     * @memberOf platform
     * @type string|null
     */platform.layout=layout&&layout[0];/**
     * The name of the product's manufacturer.
     *
     * @memberOf platform
     * @type string|null
     */platform.manufacturer=manufacturer;/**
     * The name of the browser/environment.
     *
     * @memberOf platform
     * @type string|null
     */platform.name=name;/**
     * The alpha/beta release indicator.
     *
     * @memberOf platform
     * @type string|null
     */platform.prerelease=prerelease;/**
     * The name of the product hosting the browser.
     *
     * @memberOf platform
     * @type string|null
     */platform.product=product;/**
     * The browser's user agent string.
     *
     * @memberOf platform
     * @type string|null
     */platform.ua=ua;/**
     * The browser/environment version.
     *
     * @memberOf platform
     * @type string|null
     */platform.version=name&&version;/**
     * The name of the operating system.
     *
     * @memberOf platform
     * @type Object
     */platform.os=os||{/**
       * The CPU architecture the OS is built for.
       *
       * @memberOf platform.os
       * @type number|null
       */'architecture':null,/**
       * The family of the OS.
       *
       * Common values include:
       * "Windows", "Windows Server 2008 R2 / 7", "Windows Server 2008 / Vista",
       * "Windows XP", "OS X", "Ubuntu", "Debian", "Fedora", "Red Hat", "SuSE",
       * "Android", "iOS" and "Windows Phone"
       *
       * @memberOf platform.os
       * @type string|null
       */'family':null,/**
       * The version of the OS.
       *
       * @memberOf platform.os
       * @type string|null
       */'version':null,/**
       * Returns the OS string.
       *
       * @memberOf platform.os
       * @returns {string} The OS string.
       */'toString':function toString(){return'null';}};platform.parse=parse;platform.toString=toStringPlatform;if(platform.version){description.unshift(version);}if(platform.name){description.unshift(name);}if(os&&name&&!(os==String(os).split(' ')[0]&&(os==name.split(' ')[0]||product))){description.push(product?'('+os+')':'on '+os);}if(description.length){platform.description=description.join(' ');}return platform;}/*--------------------------------------------------------------------------*/// Export platform.
var platform=parse();// Some AMD build optimizers, like r.js, check for condition patterns like the following:
if(typeof define=='function'&&_typeof4(define.amd)=='object'&&define.amd){// Expose platform on the global object to prevent errors when platform is
// loaded by a script tag in the presence of an AMD loader.
// See http://requirejs.org/docs/errors.html#mismatch for more details.
root.platform=platform;// Define as an anonymous module so platform can be aliased through path mapping.
define(function(){return platform;});}// Check for `exports` after `define` in case a build optimizer adds an `exports` object.
else if(freeExports&&freeModule){// Export for CommonJS support.
forOwn(platform,function(value,key){freeExports[key]=value;});}else{// Export to the global object.
root.platform=platform;}}).call(this);}).call(this,typeof global!=="undefined"?global:typeof self!=="undefined"?self:typeof window!=="undefined"?window:{});},{}],175:[function(_dereq_,module,exports){/*
 * Copyright (c) 2012 Mathieu Turcotte
 * Licensed under the MIT license.
 */module.exports=_dereq_('./lib/checks');},{"./lib/checks":176}],176:[function(_dereq_,module,exports){/*
 * Copyright (c) 2012 Mathieu Turcotte
 * Licensed under the MIT license.
 */var util=_dereq_('util');var errors=module.exports=_dereq_('./errors');function failCheck(ExceptionConstructor,callee,messageFormat,formatArgs){messageFormat=messageFormat||'';var message=util.format.apply(this,[messageFormat].concat(formatArgs));var error=new ExceptionConstructor(message);Error.captureStackTrace(error,callee);throw error;}function failArgumentCheck(callee,message,formatArgs){failCheck(errors.IllegalArgumentError,callee,message,formatArgs);}function failStateCheck(callee,message,formatArgs){failCheck(errors.IllegalStateError,callee,message,formatArgs);}module.exports.checkArgument=function(value,message){if(!value){failArgumentCheck(arguments.callee,message,Array.prototype.slice.call(arguments,2));}};module.exports.checkState=function(value,message){if(!value){failStateCheck(arguments.callee,message,Array.prototype.slice.call(arguments,2));}};module.exports.checkIsDef=function(value,message){if(value!==undefined){return value;}failArgumentCheck(arguments.callee,message||'Expected value to be defined but was undefined.',Array.prototype.slice.call(arguments,2));};module.exports.checkIsDefAndNotNull=function(value,message){// Note that undefined == null.
if(value!=null){return value;}failArgumentCheck(arguments.callee,message||'Expected value to be defined and not null but got "'+typeOf(value)+'".',Array.prototype.slice.call(arguments,2));};// Fixed version of the typeOf operator which returns 'null' for null values
// and 'array' for arrays.
function typeOf(value){var s=typeof value==="undefined"?"undefined":_typeof4(value);if(s=='object'){if(!value){return'null';}else if(value instanceof Array){return'array';}}return s;}function typeCheck(expect){return function(value,message){var type=typeOf(value);if(type==expect){return value;}failArgumentCheck(arguments.callee,message||'Expected "'+expect+'" but got "'+type+'".',Array.prototype.slice.call(arguments,2));};}module.exports.checkIsString=typeCheck('string');module.exports.checkIsArray=typeCheck('array');module.exports.checkIsNumber=typeCheck('number');module.exports.checkIsBoolean=typeCheck('boolean');module.exports.checkIsFunction=typeCheck('function');module.exports.checkIsObject=typeCheck('object');},{"./errors":177,"util":223}],177:[function(_dereq_,module,exports){/*
 * Copyright (c) 2012 Mathieu Turcotte
 * Licensed under the MIT license.
 */var util=_dereq_('util');function IllegalArgumentError(message){Error.call(this,message);this.message=message;}util.inherits(IllegalArgumentError,Error);IllegalArgumentError.prototype.name='IllegalArgumentError';function IllegalStateError(message){Error.call(this,message);this.message=message;}util.inherits(IllegalStateError,Error);IllegalStateError.prototype.name='IllegalStateError';module.exports.IllegalStateError=IllegalStateError;module.exports.IllegalArgumentError=IllegalArgumentError;},{"util":223}],178:[function(_dereq_,module,exports){// shim for using process in browser
var process=module.exports={};// cached from whatever global is present so that test runners that stub it
// don't break things.  But we need to wrap it in a try catch in case it is
// wrapped in strict mode code which doesn't define any globals.  It's inside a
// function because try/catches deoptimize in certain engines.
var cachedSetTimeout;var cachedClearTimeout;function defaultSetTimout(){throw new Error('setTimeout has not been defined');}function defaultClearTimeout(){throw new Error('clearTimeout has not been defined');}(function(){try{if(typeof setTimeout==='function'){cachedSetTimeout=setTimeout;}else{cachedSetTimeout=defaultSetTimout;}}catch(e){cachedSetTimeout=defaultSetTimout;}try{if(typeof clearTimeout==='function'){cachedClearTimeout=clearTimeout;}else{cachedClearTimeout=defaultClearTimeout;}}catch(e){cachedClearTimeout=defaultClearTimeout;}})();function runTimeout(fun){if(cachedSetTimeout===setTimeout){//normal enviroments in sane situations
return setTimeout(fun,0);}// if setTimeout wasn't available but was latter defined
if((cachedSetTimeout===defaultSetTimout||!cachedSetTimeout)&&setTimeout){cachedSetTimeout=setTimeout;return setTimeout(fun,0);}try{// when when somebody has screwed with setTimeout but no I.E. maddness
return cachedSetTimeout(fun,0);}catch(e){try{// When we are in I.E. but the script has been evaled so I.E. doesn't trust the global object when called normally
return cachedSetTimeout.call(null,fun,0);}catch(e){// same as above but when it's a version of I.E. that must have the global object for 'this', hopfully our context correct otherwise it will throw a global error
return cachedSetTimeout.call(this,fun,0);}}}function runClearTimeout(marker){if(cachedClearTimeout===clearTimeout){//normal enviroments in sane situations
return clearTimeout(marker);}// if clearTimeout wasn't available but was latter defined
if((cachedClearTimeout===defaultClearTimeout||!cachedClearTimeout)&&clearTimeout){cachedClearTimeout=clearTimeout;return clearTimeout(marker);}try{// when when somebody has screwed with setTimeout but no I.E. maddness
return cachedClearTimeout(marker);}catch(e){try{// When we are in I.E. but the script has been evaled so I.E. doesn't  trust the global object when called normally
return cachedClearTimeout.call(null,marker);}catch(e){// same as above but when it's a version of I.E. that must have the global object for 'this', hopfully our context correct otherwise it will throw a global error.
// Some versions of I.E. have different rules for clearTimeout vs setTimeout
return cachedClearTimeout.call(this,marker);}}}var queue=[];var draining=false;var currentQueue;var queueIndex=-1;function cleanUpNextTick(){if(!draining||!currentQueue){return;}draining=false;if(currentQueue.length){queue=currentQueue.concat(queue);}else{queueIndex=-1;}if(queue.length){drainQueue();}}function drainQueue(){if(draining){return;}var timeout=runTimeout(cleanUpNextTick);draining=true;var len=queue.length;while(len){currentQueue=queue;queue=[];while(++queueIndex<len){if(currentQueue){currentQueue[queueIndex].run();}}queueIndex=-1;len=queue.length;}currentQueue=null;draining=false;runClearTimeout(timeout);}process.nextTick=function(fun){var args=new Array(arguments.length-1);if(arguments.length>1){for(var i=1;i<arguments.length;i++){args[i-1]=arguments[i];}}queue.push(new Item(fun,args));if(queue.length===1&&!draining){runTimeout(drainQueue);}};// v8 likes predictible objects
function Item(fun,array){this.fun=fun;this.array=array;}Item.prototype.run=function(){this.fun.apply(null,this.array);};process.title='browser';process.browser=true;process.env={};process.argv=[];process.version='';// empty string to avoid regexp issues
process.versions={};function noop(){}process.on=noop;process.addListener=noop;process.once=noop;process.off=noop;process.removeListener=noop;process.removeAllListeners=noop;process.emit=noop;process.binding=function(name){throw new Error('process.binding is not supported');};process.cwd=function(){return'/';};process.chdir=function(dir){throw new Error('process.chdir is not supported');};process.umask=function(){return 0;};},{}],179:[function(_dereq_,module,exports){(function(global){// This method of obtaining a reference to the global object needs to be
// kept identical to the way it is obtained in runtime.js
var g=(typeof global==="undefined"?"undefined":_typeof4(global))==="object"?global:(typeof window==="undefined"?"undefined":_typeof4(window))==="object"?window:(typeof self==="undefined"?"undefined":_typeof4(self))==="object"?self:this;// Use `getOwnPropertyNames` because not all browsers support calling
// `hasOwnProperty` on the global `self` object in a worker. See #183.
var hadRuntime=g.regeneratorRuntime&&Object.getOwnPropertyNames(g).indexOf("regeneratorRuntime")>=0;// Save the old regeneratorRuntime in case it needs to be restored later.
var oldRuntime=hadRuntime&&g.regeneratorRuntime;// Force reevalutation of runtime.js.
g.regeneratorRuntime=undefined;module.exports=_dereq_("./runtime");if(hadRuntime){// Restore the original runtime.
g.regeneratorRuntime=oldRuntime;}else{// Remove the global property added by runtime.js.
try{delete g.regeneratorRuntime;}catch(e){g.regeneratorRuntime=undefined;}}}).call(this,typeof global!=="undefined"?global:typeof self!=="undefined"?self:typeof window!=="undefined"?window:{});},{"./runtime":180}],180:[function(_dereq_,module,exports){(function(process,global){/**
 * Copyright (c) 2014, Facebook, Inc.
 * All rights reserved.
 *
 * This source code is licensed under the BSD-style license found in the
 * https://raw.github.com/facebook/regenerator/master/LICENSE file. An
 * additional grant of patent rights can be found in the PATENTS file in
 * the same directory.
 */!function(global){"use strict";var Op=Object.prototype;var hasOwn=Op.hasOwnProperty;var undefined;// More compressible than void 0.
var $Symbol=typeof Symbol==="function"?Symbol:{};var iteratorSymbol=$Symbol.iterator||"@@iterator";var toStringTagSymbol=$Symbol.toStringTag||"@@toStringTag";var inModule=(typeof module==="undefined"?"undefined":_typeof4(module))==="object";var runtime=global.regeneratorRuntime;if(runtime){if(inModule){// If regeneratorRuntime is defined globally and we're in a module,
// make the exports object identical to regeneratorRuntime.
module.exports=runtime;}// Don't bother evaluating the rest of this file if the runtime was
// already defined globally.
return;}// Define the runtime globally (as expected by generated code) as either
// module.exports (if we're in a module) or a new, empty object.
runtime=global.regeneratorRuntime=inModule?module.exports:{};function wrap(innerFn,outerFn,self,tryLocsList){// If outerFn provided and outerFn.prototype is a Generator, then outerFn.prototype instanceof Generator.
var protoGenerator=outerFn&&outerFn.prototype instanceof Generator?outerFn:Generator;var generator=Object.create(protoGenerator.prototype);var context=new Context(tryLocsList||[]);// The ._invoke method unifies the implementations of the .next,
// .throw, and .return methods.
generator._invoke=makeInvokeMethod(innerFn,self,context);return generator;}runtime.wrap=wrap;// Try/catch helper to minimize deoptimizations. Returns a completion
// record like context.tryEntries[i].completion. This interface could
// have been (and was previously) designed to take a closure to be
// invoked without arguments, but in all the cases we care about we
// already have an existing method we want to call, so there's no need
// to create a new function object. We can even get away with assuming
// the method takes exactly one argument, since that happens to be true
// in every case, so we don't have to touch the arguments object. The
// only additional allocation required is the completion record, which
// has a stable shape and so hopefully should be cheap to allocate.
function tryCatch(fn,obj,arg){try{return{type:"normal",arg:fn.call(obj,arg)};}catch(err){return{type:"throw",arg:err};}}var GenStateSuspendedStart="suspendedStart";var GenStateSuspendedYield="suspendedYield";var GenStateExecuting="executing";var GenStateCompleted="completed";// Returning this object from the innerFn has the same effect as
// breaking out of the dispatch switch statement.
var ContinueSentinel={};// Dummy constructor functions that we use as the .constructor and
// .constructor.prototype properties for functions that return Generator
// objects. For full spec compliance, you may wish to configure your
// minifier not to mangle the names of these two functions.
function Generator(){}function GeneratorFunction(){}function GeneratorFunctionPrototype(){}// This is a polyfill for %IteratorPrototype% for environments that
// don't natively support it.
var IteratorPrototype={};IteratorPrototype[iteratorSymbol]=function(){return this;};var getProto=Object.getPrototypeOf;var NativeIteratorPrototype=getProto&&getProto(getProto(values([])));if(NativeIteratorPrototype&&NativeIteratorPrototype!==Op&&hasOwn.call(NativeIteratorPrototype,iteratorSymbol)){// This environment has a native %IteratorPrototype%; use it instead
// of the polyfill.
IteratorPrototype=NativeIteratorPrototype;}var Gp=GeneratorFunctionPrototype.prototype=Generator.prototype=Object.create(IteratorPrototype);GeneratorFunction.prototype=Gp.constructor=GeneratorFunctionPrototype;GeneratorFunctionPrototype.constructor=GeneratorFunction;GeneratorFunctionPrototype[toStringTagSymbol]=GeneratorFunction.displayName="GeneratorFunction";// Helper for defining the .next, .throw, and .return methods of the
// Iterator interface in terms of a single ._invoke method.
function defineIteratorMethods(prototype){["next","throw","return"].forEach(function(method){prototype[method]=function(arg){return this._invoke(method,arg);};});}runtime.isGeneratorFunction=function(genFun){var ctor=typeof genFun==="function"&&genFun.constructor;return ctor?ctor===GeneratorFunction||// For the native GeneratorFunction constructor, the best we can
// do is to check its .name property.
(ctor.displayName||ctor.name)==="GeneratorFunction":false;};runtime.mark=function(genFun){if(Object.setPrototypeOf){Object.setPrototypeOf(genFun,GeneratorFunctionPrototype);}else{genFun.__proto__=GeneratorFunctionPrototype;if(!(toStringTagSymbol in genFun)){genFun[toStringTagSymbol]="GeneratorFunction";}}genFun.prototype=Object.create(Gp);return genFun;};// Within the body of any async function, `await x` is transformed to
// `yield regeneratorRuntime.awrap(x)`, so that the runtime can test
// `hasOwn.call(value, "__await")` to determine if the yielded value is
// meant to be awaited.
runtime.awrap=function(arg){return{__await:arg};};function AsyncIterator(generator){function invoke(method,arg,resolve,reject){var record=tryCatch(generator[method],generator,arg);if(record.type==="throw"){reject(record.arg);}else{var result=record.arg;var value=result.value;if(value&&(typeof value==="undefined"?"undefined":_typeof4(value))==="object"&&hasOwn.call(value,"__await")){return Promise.resolve(value.__await).then(function(value){invoke("next",value,resolve,reject);},function(err){invoke("throw",err,resolve,reject);});}return Promise.resolve(value).then(function(unwrapped){// When a yielded Promise is resolved, its final value becomes
// the .value of the Promise<{value,done}> result for the
// current iteration. If the Promise is rejected, however, the
// result for this iteration will be rejected with the same
// reason. Note that rejections of yielded Promises are not
// thrown back into the generator function, as is the case
// when an awaited Promise is rejected. This difference in
// behavior between yield and await is important, because it
// allows the consumer to decide what to do with the yielded
// rejection (swallow it and continue, manually .throw it back
// into the generator, abandon iteration, whatever). With
// await, by contrast, there is no opportunity to examine the
// rejection reason outside the generator function, so the
// only option is to throw it from the await expression, and
// let the generator function handle the exception.
result.value=unwrapped;resolve(result);},reject);}}if((typeof process==="undefined"?"undefined":_typeof4(process))==="object"&&process.domain){invoke=process.domain.bind(invoke);}var previousPromise;function enqueue(method,arg){function callInvokeWithMethodAndArg(){return new Promise(function(resolve,reject){invoke(method,arg,resolve,reject);});}return previousPromise=// If enqueue has been called before, then we want to wait until
// all previous Promises have been resolved before calling invoke,
// so that results are always delivered in the correct order. If
// enqueue has not been called before, then it is important to
// call invoke immediately, without waiting on a callback to fire,
// so that the async generator function has the opportunity to do
// any necessary setup in a predictable way. This predictability
// is why the Promise constructor synchronously invokes its
// executor callback, and why async functions synchronously
// execute code before the first await. Since we implement simple
// async functions in terms of async generators, it is especially
// important to get this right, even though it requires care.
previousPromise?previousPromise.then(callInvokeWithMethodAndArg,// Avoid propagating failures to Promises returned by later
// invocations of the iterator.
callInvokeWithMethodAndArg):callInvokeWithMethodAndArg();}// Define the unified helper method that is used to implement .next,
// .throw, and .return (see defineIteratorMethods).
this._invoke=enqueue;}defineIteratorMethods(AsyncIterator.prototype);runtime.AsyncIterator=AsyncIterator;// Note that simple async functions are implemented on top of
// AsyncIterator objects; they just return a Promise for the value of
// the final result produced by the iterator.
runtime.async=function(innerFn,outerFn,self,tryLocsList){var iter=new AsyncIterator(wrap(innerFn,outerFn,self,tryLocsList));return runtime.isGeneratorFunction(outerFn)?iter// If outerFn is a generator, return the full iterator.
:iter.next().then(function(result){return result.done?result.value:iter.next();});};function makeInvokeMethod(innerFn,self,context){var state=GenStateSuspendedStart;return function invoke(method,arg){if(state===GenStateExecuting){throw new Error("Generator is already running");}if(state===GenStateCompleted){if(method==="throw"){throw arg;}// Be forgiving, per 25.3.3.3.3 of the spec:
// https://people.mozilla.org/~jorendorff/es6-draft.html#sec-generatorresume
return doneResult();}context.method=method;context.arg=arg;while(true){var delegate=context.delegate;if(delegate){var delegateResult=maybeInvokeDelegate(delegate,context);if(delegateResult){if(delegateResult===ContinueSentinel)continue;return delegateResult;}}if(context.method==="next"){// Setting context._sent for legacy support of Babel's
// function.sent implementation.
context.sent=context._sent=context.arg;}else if(context.method==="throw"){if(state===GenStateSuspendedStart){state=GenStateCompleted;throw context.arg;}context.dispatchException(context.arg);}else if(context.method==="return"){context.abrupt("return",context.arg);}state=GenStateExecuting;var record=tryCatch(innerFn,self,context);if(record.type==="normal"){// If an exception is thrown from innerFn, we leave state ===
// GenStateExecuting and loop back for another invocation.
state=context.done?GenStateCompleted:GenStateSuspendedYield;if(record.arg===ContinueSentinel){continue;}return{value:record.arg,done:context.done};}else if(record.type==="throw"){state=GenStateCompleted;// Dispatch the exception by looping back around to the
// context.dispatchException(context.arg) call above.
context.method="throw";context.arg=record.arg;}}};}// Call delegate.iterator[context.method](context.arg) and handle the
// result, either by returning a { value, done } result from the
// delegate iterator, or by modifying context.method and context.arg,
// setting context.delegate to null, and returning the ContinueSentinel.
function maybeInvokeDelegate(delegate,context){var method=delegate.iterator[context.method];if(method===undefined){// A .throw or .return when the delegate iterator has no .throw
// method always terminates the yield* loop.
context.delegate=null;if(context.method==="throw"){if(delegate.iterator.return){// If the delegate iterator has a return method, give it a
// chance to clean up.
context.method="return";context.arg=undefined;maybeInvokeDelegate(delegate,context);if(context.method==="throw"){// If maybeInvokeDelegate(context) changed context.method from
// "return" to "throw", let that override the TypeError below.
return ContinueSentinel;}}context.method="throw";context.arg=new TypeError("The iterator does not provide a 'throw' method");}return ContinueSentinel;}var record=tryCatch(method,delegate.iterator,context.arg);if(record.type==="throw"){context.method="throw";context.arg=record.arg;context.delegate=null;return ContinueSentinel;}var info=record.arg;if(!info){context.method="throw";context.arg=new TypeError("iterator result is not an object");context.delegate=null;return ContinueSentinel;}if(info.done){// Assign the result of the finished delegate to the temporary
// variable specified by delegate.resultName (see delegateYield).
context[delegate.resultName]=info.value;// Resume execution at the desired location (see delegateYield).
context.next=delegate.nextLoc;// If context.method was "throw" but the delegate handled the
// exception, let the outer generator proceed normally. If
// context.method was "next", forget context.arg since it has been
// "consumed" by the delegate iterator. If context.method was
// "return", allow the original .return call to continue in the
// outer generator.
if(context.method!=="return"){context.method="next";context.arg=undefined;}}else{// Re-yield the result returned by the delegate method.
return info;}// The delegate iterator is finished, so forget it and continue with
// the outer generator.
context.delegate=null;return ContinueSentinel;}// Define Generator.prototype.{next,throw,return} in terms of the
// unified ._invoke helper method.
defineIteratorMethods(Gp);Gp[toStringTagSymbol]="Generator";Gp.toString=function(){return"[object Generator]";};function pushTryEntry(locs){var entry={tryLoc:locs[0]};if(1 in locs){entry.catchLoc=locs[1];}if(2 in locs){entry.finallyLoc=locs[2];entry.afterLoc=locs[3];}this.tryEntries.push(entry);}function resetTryEntry(entry){var record=entry.completion||{};record.type="normal";delete record.arg;entry.completion=record;}function Context(tryLocsList){// The root entry object (effectively a try statement without a catch
// or a finally block) gives us a place to store values thrown from
// locations where there is no enclosing try statement.
this.tryEntries=[{tryLoc:"root"}];tryLocsList.forEach(pushTryEntry,this);this.reset(true);}runtime.keys=function(object){var keys=[];for(var key in object){keys.push(key);}keys.reverse();// Rather than returning an object with a next method, we keep
// things simple and return the next function itself.
return function next(){while(keys.length){var key=keys.pop();if(key in object){next.value=key;next.done=false;return next;}}// To avoid creating an additional object, we just hang the .value
// and .done properties off the next function object itself. This
// also ensures that the minifier will not anonymize the function.
next.done=true;return next;};};function values(iterable){if(iterable){var iteratorMethod=iterable[iteratorSymbol];if(iteratorMethod){return iteratorMethod.call(iterable);}if(typeof iterable.next==="function"){return iterable;}if(!isNaN(iterable.length)){var i=-1,next=function next(){while(++i<iterable.length){if(hasOwn.call(iterable,i)){next.value=iterable[i];next.done=false;return next;}}next.value=undefined;next.done=true;return next;};return next.next=next;}}// Return an iterator with no values.
return{next:doneResult};}runtime.values=values;function doneResult(){return{value:undefined,done:true};}Context.prototype={constructor:Context,reset:function reset(skipTempReset){this.prev=0;this.next=0;// Resetting context._sent for legacy support of Babel's
// function.sent implementation.
this.sent=this._sent=undefined;this.done=false;this.delegate=null;this.method="next";this.arg=undefined;this.tryEntries.forEach(resetTryEntry);if(!skipTempReset){for(var name in this){// Not sure about the optimal order of these conditions:
if(name.charAt(0)==="t"&&hasOwn.call(this,name)&&!isNaN(+name.slice(1))){this[name]=undefined;}}}},stop:function stop(){this.done=true;var rootEntry=this.tryEntries[0];var rootRecord=rootEntry.completion;if(rootRecord.type==="throw"){throw rootRecord.arg;}return this.rval;},dispatchException:function dispatchException(exception){if(this.done){throw exception;}var context=this;function handle(loc,caught){record.type="throw";record.arg=exception;context.next=loc;if(caught){// If the dispatched exception was caught by a catch block,
// then let that catch block handle the exception normally.
context.method="next";context.arg=undefined;}return!!caught;}for(var i=this.tryEntries.length-1;i>=0;--i){var entry=this.tryEntries[i];var record=entry.completion;if(entry.tryLoc==="root"){// Exception thrown outside of any try block that could handle
// it, so set the completion value of the entire function to
// throw the exception.
return handle("end");}if(entry.tryLoc<=this.prev){var hasCatch=hasOwn.call(entry,"catchLoc");var hasFinally=hasOwn.call(entry,"finallyLoc");if(hasCatch&&hasFinally){if(this.prev<entry.catchLoc){return handle(entry.catchLoc,true);}else if(this.prev<entry.finallyLoc){return handle(entry.finallyLoc);}}else if(hasCatch){if(this.prev<entry.catchLoc){return handle(entry.catchLoc,true);}}else if(hasFinally){if(this.prev<entry.finallyLoc){return handle(entry.finallyLoc);}}else{throw new Error("try statement without catch or finally");}}}},abrupt:function abrupt(type,arg){for(var i=this.tryEntries.length-1;i>=0;--i){var entry=this.tryEntries[i];if(entry.tryLoc<=this.prev&&hasOwn.call(entry,"finallyLoc")&&this.prev<entry.finallyLoc){var finallyEntry=entry;break;}}if(finallyEntry&&(type==="break"||type==="continue")&&finallyEntry.tryLoc<=arg&&arg<=finallyEntry.finallyLoc){// Ignore the finally entry if control is not jumping to a
// location outside the try/catch block.
finallyEntry=null;}var record=finallyEntry?finallyEntry.completion:{};record.type=type;record.arg=arg;if(finallyEntry){this.method="next";this.next=finallyEntry.finallyLoc;return ContinueSentinel;}return this.complete(record);},complete:function complete(record,afterLoc){if(record.type==="throw"){throw record.arg;}if(record.type==="break"||record.type==="continue"){this.next=record.arg;}else if(record.type==="return"){this.rval=this.arg=record.arg;this.method="return";this.next="end";}else if(record.type==="normal"&&afterLoc){this.next=afterLoc;}return ContinueSentinel;},finish:function finish(finallyLoc){for(var i=this.tryEntries.length-1;i>=0;--i){var entry=this.tryEntries[i];if(entry.finallyLoc===finallyLoc){this.complete(entry.completion,entry.afterLoc);resetTryEntry(entry);return ContinueSentinel;}}},"catch":function _catch(tryLoc){for(var i=this.tryEntries.length-1;i>=0;--i){var entry=this.tryEntries[i];if(entry.tryLoc===tryLoc){var record=entry.completion;if(record.type==="throw"){var thrown=record.arg;resetTryEntry(entry);}return thrown;}}// The context.catch method must only be called with a location
// argument that corresponds to a known catch block.
throw new Error("illegal catch attempt");},delegateYield:function delegateYield(iterable,resultName,nextLoc){this.delegate={iterator:values(iterable),resultName:resultName,nextLoc:nextLoc};if(this.method==="next"){// Deliberately forget the last sent value so that we don't
// accidentally pass it on to the delegate.
this.arg=undefined;}return ContinueSentinel;}};}(// Among the various tricks for obtaining a reference to the global
// object, this seems to be the most reliable technique that does not
// use indirect eval (which violates Content Security Policy).
(typeof global==="undefined"?"undefined":_typeof4(global))==="object"?global:(typeof window==="undefined"?"undefined":_typeof4(window))==="object"?window:(typeof self==="undefined"?"undefined":_typeof4(self))==="object"?self:this);}).call(this,_dereq_('_process'),typeof global!=="undefined"?global:typeof self!=="undefined"?self:typeof window!=="undefined"?window:{});},{"_process":178}],181:[function(_dereq_,module,exports){(function(global){(function(f){if((typeof exports==="undefined"?"undefined":_typeof4(exports))==="object"&&typeof module!=="undefined"){module.exports=f();}else if(typeof define==="function"&&define.amd){define([],f);}else{var g;if(typeof window!=="undefined"){g=window;}else if(typeof global!=="undefined"){g=global;}else if(typeof self!=="undefined"){g=self;}else{g=this;}g.rfc6902=f();}})(function(){var define,module,exports;return function e(t,n,r){function s(o,u){if(!n[o]){if(!t[o]){var a=typeof _dereq_=="function"&&_dereq_;if(!u&&a)return a(o,!0);if(i)return i(o,!0);var f=new Error("Cannot find module '"+o+"'");throw f.code="MODULE_NOT_FOUND",f;}var l=n[o]={exports:{}};t[o][0].call(l.exports,function(e){var n=t[o][1][e];return s(n?n:e);},l,l.exports,e,t,n,r);}return n[o].exports;}var i=typeof _dereq_=="function"&&_dereq_;for(var o=0;o<r.length;o++){s(r[o]);}return s;}({1:[function(_dereq_,module,exports){"use strict";var _slicedToArray=function _slicedToArray(arr,i){if(Array.isArray(arr)){return arr;}else if(Symbol.iterator in Object(arr)){var _arr=[];for(var _iterator=arr[Symbol.iterator](),_step;!(_step=_iterator.next()).done;){_arr.push(_step.value);if(i&&_arr.length===i)break;}return _arr;}else{throw new TypeError("Invalid attempt to destructure non-iterable instance");}};var _toConsumableArray=function _toConsumableArray(arr){if(Array.isArray(arr)){for(var i=0,arr2=Array(arr.length);i<arr.length;i++){arr2[i]=arr[i];}return arr2;}else{return Array.from(arr);}};exports.isDestructive=isDestructive;/**
subtract(a, b) returns the keys in `a` that are not in `b`.
*/exports.subtract=subtract;/**
intersection(objects) returns the keys that shared by all given `objects`.
*/exports.intersection=intersection;exports.objectType=objectType;/**
Array-diffing smarter (levenshtein-like) diffing here

To get from the input ABC to the output AZ we could just delete all the input
and say "insert A, insert Z" and be done with it. That's what we do if the
input is empty. But we can be smarter.

          output
               A   Z
               -   -
          [0]  1   2
input A |  1  [0]  1
      B |  2  [1]  1
      C |  3   2  [2]

1) start at 0,0 (+0)
2) keep A (+0)
3) remove B (+1)
4) replace C with Z (+1)

if input (source) is empty, they'll all be in the top row, just a bunch of
additions. If the output is empty, everything will be in the left column, as a
bunch of deletions.
*/exports.diffArrays=diffArrays;exports.diffObjects=diffObjects;exports.diffValues=diffValues;exports.diffAny=diffAny;Object.defineProperty(exports,"__esModule",{value:true});var compare=_dereq_("./equal").compare;function isDestructive(_ref){var op=_ref.op;return op==="remove"||op==="replace"||op==="copy"||op==="move";}function subtract(a,b){var obj={};for(var add_key in a){obj[add_key]=1;}for(var del_key in b){delete obj[del_key];}return Object.keys(obj);}function intersection(objects){// initialize like union()
var key_counts={};objects.forEach(function(object){for(var key in object){key_counts[key]=(key_counts[key]||0)+1;}});// but then, extra requirement: delete less commonly-seen keys
var threshold=objects.length;for(var key in key_counts){if(key_counts[key]<threshold){delete key_counts[key];}}return Object.keys(key_counts);}function objectType(object){if(object===undefined){return"undefined";}if(object===null){return"null";}if(Array.isArray(object)){return"array";}return typeof object==="undefined"?"undefined":_typeof4(object);}function isArrayAdd(array_operation){return array_operation.op==="add";}function isArrayRemove(array_operation){return array_operation.op==="remove";}function isArrayReplace(array_operation){return array_operation.op==="replace";}function diffArrays(input,output,ptr){// set up cost matrix (very simple initialization: just a map)
var memo={"0,0":{operations:[],cost:0}};/**
    input[i's] -> output[j's]
       Given the layout above, i is the row, j is the col
       returns a list of Operations needed to get to from input.slice(0, i) to
    output.slice(0, j), the each marked with the total cost of getting there.
    `cost` is a non-negative integer.
    Recursive.
    */function dist(i,j){// memoized
var memoized=memo[i+","+j];if(memoized===undefined){if(compare(input[i-1],output[j-1])){// equal (no operations => no cost)
memoized=dist(i-1,j-1);}else{var alternatives=[];if(i>0){// NOT topmost row
var remove_alternative=dist(i-1,j);alternatives.push({// the new operation must be pushed on the end
operations:remove_alternative.operations.concat({op:"remove",index:i-1}),cost:remove_alternative.cost+1});}if(j>0){// NOT leftmost column
var add_alternative=dist(i,j-1);alternatives.push({operations:add_alternative.operations.concat({op:"add",index:i-1,value:output[j-1]}),cost:add_alternative.cost+1});}if(i>0&&j>0){// TABLE MIDDLE
// supposing we replaced it, compute the rest of the costs:
var replace_alternative=dist(i-1,j-1);// okay, the general plan is to replace it, but we can be smarter,
// recursing into the structure and replacing only part of it if
// possible, but to do so we'll need the original value
alternatives.push({operations:replace_alternative.operations.concat({op:"replace",index:i-1,original:input[i-1],value:output[j-1]}),cost:replace_alternative.cost+1});}// the only other case, i === 0 && j === 0, has already been memoized
// the meat of the algorithm:
// sort by cost to find the lowest one (might be several ties for lowest)
// [4, 6, 7, 1, 2].sort((a, b) => a - b); -> [ 1, 2, 4, 6, 7 ]
var best=alternatives.sort(function(a,b){return a.cost-b.cost;})[0];memoized=best;}memo[i+","+j]=memoized;}return memoized;}// handle weird objects masquerading as Arrays that don't have proper length
// properties by using 0 for everything but positive numbers
var input_length=isNaN(input.length)||input.length<=0?0:input.length;var output_length=isNaN(output.length)||output.length<=0?0:output.length;var array_operations=dist(input_length,output_length).operations;var _array_operations$reduce=array_operations.reduce(function(_ref,array_operation){var _ref2=_slicedToArray(_ref,2);var operations=_ref2[0];var padding=_ref2[1];if(isArrayAdd(array_operation)){var padded_index=array_operation.index+1+padding;var index_token=padded_index<input_length+padding?String(padded_index):"-";var operation={op:array_operation.op,path:ptr.add(index_token).toString(),value:array_operation.value};// padding++; // maybe only if array_operation.index > -1 ?
return[operations.concat(operation),padding+1];}else if(isArrayRemove(array_operation)){var operation={op:array_operation.op,path:ptr.add(String(array_operation.index+padding)).toString()};// padding--;
return[operations.concat(operation),padding-1];}else{var replace_ptr=ptr.add(String(array_operation.index+padding));var replace_operations=diffAny(array_operation.original,array_operation.value,replace_ptr);return[operations.concat.apply(operations,_toConsumableArray(replace_operations)),padding];}},[[],0]);var _array_operations$reduce2=_slicedToArray(_array_operations$reduce,2);var operations=_array_operations$reduce2[0];var padding=_array_operations$reduce2[1];return operations;}function diffObjects(input,output,ptr){// if a key is in input but not output -> remove it
var operations=[];subtract(input,output).forEach(function(key){operations.push({op:"remove",path:ptr.add(key).toString()});});// if a key is in output but not input -> add it
subtract(output,input).forEach(function(key){operations.push({op:"add",path:ptr.add(key).toString(),value:output[key]});});// if a key is in both, diff it recursively
intersection([input,output]).forEach(function(key){operations.push.apply(operations,_toConsumableArray(diffAny(input[key],output[key],ptr.add(key))));});return operations;}function diffValues(input,output,ptr){if(!compare(input,output)){return[{op:"replace",path:ptr.toString(),value:output}];}return[];}function diffAny(input,output,ptr){var input_type=objectType(input);var output_type=objectType(output);if(input_type=="array"&&output_type=="array"){return diffArrays(input,output,ptr);}if(input_type=="object"&&output_type=="object"){return diffObjects(input,output,ptr);}// only pairs of arrays and objects can go down a path to produce a smaller
// diff; everything else must be wholesale replaced if inequal
return diffValues(input,output,ptr);}},{"./equal":2}],2:[function(_dereq_,module,exports){/**
`compare()` returns true if `left` and `right` are materially equal
(i.e., would produce equivalent JSON), false otherwise.

> Here, "equal" means that the value at the target location and the
> value conveyed by "value" are of the same JSON type, and that they
> are considered equal by the following rules for that type:
> o  strings: are considered equal if they contain the same number of
>    Unicode characters and their code points are byte-by-byte equal.
> o  numbers: are considered equal if their values are numerically
>    equal.
> o  arrays: are considered equal if they contain the same number of
>    values, and if each value can be considered equal to the value at
>    the corresponding position in the other array, using this list of
>    type-specific rules.
> o  objects: are considered equal if they contain the same number of
>    members, and if each member can be considered equal to a member in
>    the other object, by comparing their keys (as strings) and their
>    values (using this list of type-specific rules).
> o  literals (false, true, and null): are considered equal if they are
>    the same.
*/"use strict";exports.compare=compare;Object.defineProperty(exports,"__esModule",{value:true});/**
zip(a, b) assumes that a.length === b.length.
*/function zip(a,b){var zipped=[];for(var i=0,l=a.length;i<l;i++){zipped.push([a[i],b[i]]);}return zipped;}/**
compareArrays(left, right) assumes that `left` and `right` are both Arrays.
*/function compareArrays(left,right){if(left.length!==right.length){return false;}return zip(left,right).every(function(pair){return compare(pair[0],pair[1]);});}/**
compareObjects(left, right) assumes that `left` and `right` are both Objects.
*/function compareObjects(left,right){var left_keys=Object.keys(left);var right_keys=Object.keys(right);if(!compareArrays(left_keys,right_keys)){return false;}return left_keys.every(function(key){return compare(left[key],right[key]);});}function compare(left,right){// strict equality handles literals, numbers, and strings (a sufficient but not necessary cause)
if(left===right){return true;}// check arrays
if(Array.isArray(left)&&Array.isArray(right)){return compareArrays(left,right);}// check objects
if(Object(left)===left&&Object(right)===right){return compareObjects(left,right);}// mismatched arrays & objects, etc., are always inequal
return false;}},{}],3:[function(_dereq_,module,exports){"use strict";var _get=function get(object,property,receiver){var desc=Object.getOwnPropertyDescriptor(object,property);if(desc===undefined){var parent=Object.getPrototypeOf(object);if(parent===null){return undefined;}else{return get(parent,property,receiver);}}else if("value"in desc&&desc.writable){return desc.value;}else{var getter=desc.get;if(getter===undefined){return undefined;}return getter.call(receiver);}};var _inherits=function _inherits(subClass,superClass){if(typeof superClass!=="function"&&superClass!==null){throw new TypeError("Super expression must either be null or a function, not "+(typeof superClass==="undefined"?"undefined":_typeof4(superClass)));}subClass.prototype=Object.create(superClass&&superClass.prototype,{constructor:{value:subClass,enumerable:false,writable:true,configurable:true}});if(superClass)subClass.__proto__=superClass;};var _classCallCheck=function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor)){throw new TypeError("Cannot call a class as a function");}};Object.defineProperty(exports,"__esModule",{value:true});var MissingError=exports.MissingError=function(_Error){function MissingError(path){_classCallCheck(this,MissingError);_get(Object.getPrototypeOf(MissingError.prototype),"constructor",this).call(this,"Value required at path: "+path);this.path=path;this.name=this.constructor.name;}_inherits(MissingError,_Error);return MissingError;}(Error);var InvalidOperationError=exports.InvalidOperationError=function(_Error2){function InvalidOperationError(op){_classCallCheck(this,InvalidOperationError);_get(Object.getPrototypeOf(InvalidOperationError.prototype),"constructor",this).call(this,"Invalid operation: "+op);this.op=op;this.name=this.constructor.name;}_inherits(InvalidOperationError,_Error2);return InvalidOperationError;}(Error);var TestError=exports.TestError=function(_Error3){function TestError(actual,expected){_classCallCheck(this,TestError);_get(Object.getPrototypeOf(TestError.prototype),"constructor",this).call(this,"Test failed: "+actual+" != "+expected);this.actual=actual;this.expected=expected;this.name=this.constructor.name;this.actual=actual;this.expected=expected;}_inherits(TestError,_Error3);return TestError;}(Error);},{}],4:[function(_dereq_,module,exports){"use strict";var _interopRequireWildcard=function _interopRequireWildcard(obj){return obj&&obj.__esModule?obj:{"default":obj};};/**
Apply a 'application/json-patch+json'-type patch to an object.

`patch` *must* be an array of operations.

> Operation objects MUST have exactly one "op" member, whose value
> indicates the operation to perform.  Its value MUST be one of "add",
> "remove", "replace", "move", "copy", or "test"; other values are
> errors.

This method currently operates on the target object in-place.

Returns list of results, one for each operation.
  - `null` indicated success.
  - otherwise, the result will be an instance of one of the Error classe
    defined in errors.js.
*/exports.applyPatch=applyPatch;/**
Produce a 'application/json-patch+json'-type patch to get from one object to
another.

This does not alter `input` or `output` unless they have a property getter with
side-effects (which is not a good idea anyway).

Returns list of operations to perform on `input` to produce `output`.
*/exports.createPatch=createPatch;/**
Produce an 'application/json-patch+json'-type list of tests, to verify that
existing values in an object are identical to the those captured at some
checkpoint (whenever this function is called).

This does not alter `input` or `output` unless they have a property getter with
side-effects (which is not a good idea anyway).

Returns list of test operations.
*/exports.createTests=createTests;Object.defineProperty(exports,"__esModule",{value:true});var InvalidOperationError=_dereq_("./errors").InvalidOperationError;var Pointer=_dereq_("./pointer").Pointer;var operationFunctions=_interopRequireWildcard(_dereq_("./patch"));var _diff=_dereq_("./diff");var diffAny=_diff.diffAny;var isDestructive=_diff.isDestructive;function applyPatch(object,patch){return patch.map(function(operation){var operationFunction=operationFunctions[operation.op];// speedy exit if we don't recognize the operation name
if(operationFunction===undefined){return new InvalidOperationError(operation.op);}return operationFunction(object,operation);});}function createPatch(input,output){var ptr=new Pointer();// a new Pointer gets a default path of [''] if not specified
return diffAny(input,output,ptr);}function createTest(input,path){var endpoint=Pointer.fromJSON(path).evaluate(input);if(endpoint!==undefined){return{op:"test",path:path,value:endpoint.value};}}function createTests(input,patch){var tests=new Array();patch.filter(isDestructive).forEach(function(operation){var pathTest=createTest(input,operation.path);if(pathTest)tests.push(pathTest);if("from"in operation){var fromTest=createTest(input,operation.from);if(fromTest)tests.push(fromTest);}});return tests;}},{"./diff":1,"./errors":3,"./patch":5,"./pointer":6}],5:[function(_dereq_,module,exports){/**
>  o  If the target location specifies an array index, a new value is
>     inserted into the array at the specified index.
>  o  If the target location specifies an object member that does not
>     already exist, a new member is added to the object.
>  o  If the target location specifies an object member that does exist,
>     that member's value is replaced.
*/"use strict";exports.add=add;/**
> The "remove" operation removes the value at the target location.
> The target location MUST exist for the operation to be successful.
*/exports.remove=remove;/**
> The "replace" operation replaces the value at the target location
> with a new value.  The operation object MUST contain a "value" member
> whose content specifies the replacement value.
> The target location MUST exist for the operation to be successful.

> This operation is functionally identical to a "remove" operation for
> a value, followed immediately by an "add" operation at the same
> location with the replacement value.

Even more simply, it's like the add operation with an existence check.
*/exports.replace=replace;/**
> The "move" operation removes the value at a specified location and
> adds it to the target location.
> The operation object MUST contain a "from" member, which is a string
> containing a JSON Pointer value that references the location in the
> target document to move the value from.
> This operation is functionally identical to a "remove" operation on
> the "from" location, followed immediately by an "add" operation at
> the target location with the value that was just removed.

> The "from" location MUST NOT be a proper prefix of the "path"
> location; i.e., a location cannot be moved into one of its children.

TODO: throw if the check described in the previous paragraph fails.
*/exports.move=move;/**
> The "copy" operation copies the value at a specified location to the
> target location.
> The operation object MUST contain a "from" member, which is a string
> containing a JSON Pointer value that references the location in the
> target document to copy the value from.
> The "from" location MUST exist for the operation to be successful.

> This operation is functionally identical to an "add" operation at the
> target location using the value specified in the "from" member.

Alternatively, it's like 'move' without the 'remove'.
*/exports.copy=copy;/**
> The "test" operation tests that a value at the target location is
> equal to a specified value.
> The operation object MUST contain a "value" member that conveys the
> value to be compared to the target location's value.
> The target location MUST be equal to the "value" value for the
> operation to be considered successful.
*/exports.test=test;Object.defineProperty(exports,"__esModule",{value:true});var Pointer=_dereq_("./pointer").Pointer;var compare=_dereq_("./equal").compare;var _errors=_dereq_("./errors");var MissingError=_errors.MissingError;var TestError=_errors.TestError;function _add(object,key,value){if(Array.isArray(object)){// `key` must be an index
if(key=="-"){object.push(value);}else{object.splice(key,0,value);}}else{object[key]=value;}}function _remove(object,key){if(Array.isArray(object)){// '-' syntax doesn't make sense when removing
object.splice(key,1);}else{// not sure what the proper behavior is when path = ''
delete object[key];}}function add(object,operation){var endpoint=Pointer.fromJSON(operation.path).evaluate(object);// it's not exactly a "MissingError" in the same way that `remove` is -- more like a MissingParent, or something
if(endpoint.parent===undefined){return new MissingError(operation.path);}_add(endpoint.parent,endpoint.key,operation.value);return null;}function remove(object,operation){// endpoint has parent, key, and value properties
var endpoint=Pointer.fromJSON(operation.path).evaluate(object);if(endpoint.value===undefined){return new MissingError(operation.path);}// not sure what the proper behavior is when path = ''
_remove(endpoint.parent,endpoint.key);return null;}function replace(object,operation){var endpoint=Pointer.fromJSON(operation.path).evaluate(object);if(endpoint.value===undefined){return new MissingError(operation.path);}endpoint.parent[endpoint.key]=operation.value;return null;}function move(object,operation){var from_endpoint=Pointer.fromJSON(operation.from).evaluate(object);if(from_endpoint.value===undefined){return new MissingError(operation.from);}var endpoint=Pointer.fromJSON(operation.path).evaluate(object);if(endpoint.parent===undefined){return new MissingError(operation.path);}_remove(from_endpoint.parent,from_endpoint.key);_add(endpoint.parent,endpoint.key,from_endpoint.value);return null;}function copy(object,operation){var from_endpoint=Pointer.fromJSON(operation.from).evaluate(object);if(from_endpoint.value===undefined){return new MissingError(operation.from);}var endpoint=Pointer.fromJSON(operation.path).evaluate(object);if(endpoint.parent===undefined){return new MissingError(operation.path);}_remove(from_endpoint.parent,from_endpoint.key);_add(endpoint.parent,endpoint.key,from_endpoint.value);return null;}function test(object,operation){var endpoint=Pointer.fromJSON(operation.path).evaluate(object);var result=compare(endpoint.value,operation.value);if(!result){return new TestError(endpoint.value,operation.value);}return null;}},{"./equal":2,"./errors":3,"./pointer":6}],6:[function(_dereq_,module,exports){"use strict";var _createClass=function(){function defineProperties(target,props){for(var key in props){var prop=props[key];prop.configurable=true;if(prop.value)prop.writable=true;}Object.defineProperties(target,props);}return function(Constructor,protoProps,staticProps){if(protoProps)defineProperties(Constructor.prototype,protoProps);if(staticProps)defineProperties(Constructor,staticProps);return Constructor;};}();var _classCallCheck=function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor)){throw new TypeError("Cannot call a class as a function");}};Object.defineProperty(exports,"__esModule",{value:true});/**
Unescape token part of a JSON Pointer string

`token` should *not* contain any '/' characters.

> Evaluation of each reference token begins by decoding any escaped
> character sequence.  This is performed by first transforming any
> occurrence of the sequence '~1' to '/', and then transforming any
> occurrence of the sequence '~0' to '~'.  By performing the
> substitutions in this order, an implementation avoids the error of
> turning '~01' first into '~1' and then into '/', which would be
> incorrect (the string '~01' correctly becomes '~1' after
> transformation).

Here's my take:

~1 is unescaped with higher priority than ~0 because it is a lower-order escape character.
I say "lower order" because '/' needs escaping due to the JSON Pointer serialization technique.
Whereas, '~' is escaped because escaping '/' uses the '~' character.
*/function unescape(token){return token.replace(/~1/g,"/").replace(/~0/g,"~");}/** Escape token part of a JSON Pointer string

> '~' needs to be encoded as '~0' and '/'
> needs to be encoded as '~1' when these characters appear in a
> reference token.

This is the exact inverse of `unescape()`, so the reverse replacements must take place in reverse order.
*/function escape(token){return token.replace(/~/g,"~0").replace(/\//g,"~1");}/**
JSON Pointer representation
*/var Pointer=exports.Pointer=function(){function Pointer(){var tokens=arguments[0]===undefined?[""]:arguments[0];_classCallCheck(this,Pointer);this.tokens=tokens;}_createClass(Pointer,{toString:{value:function toString(){return this.tokens.map(escape).join("/");}},evaluate:{/**
            Returns an object with 'parent', 'key', and 'value' properties.
            In the special case that pointer = "", parent and key will be null, and `value = obj`
            Otherwise, parent will be the such that `parent[key] == value`
            */value:function evaluate(object){var parent=null;var token=null;for(var i=1,l=this.tokens.length;i<l;i++){parent=object;token=this.tokens[i];// not sure if this the best way to handle non-existant paths...
object=(parent||{})[token];}return{parent:parent,key:token,value:object};}},push:{value:function push(token){// mutable
this.tokens.push(token);}},add:{/**
            `token` should be a String. It'll be coerced to one anyway.
               immutable (shallowly)
            */value:function add(token){var tokens=this.tokens.concat(String(token));return new Pointer(tokens);}}},{fromJSON:{/**
            `path` *must* be a properly escaped string.
            */value:function fromJSON(path){var tokens=path.split("/").map(unescape);if(tokens[0]!=="")throw new Error("Invalid JSON Pointer: "+path);return new Pointer(tokens);}}});return Pointer;}();},{}]},{},[4])(4);});}).call(this,typeof global!=="undefined"?global:typeof self!=="undefined"?self:typeof window!=="undefined"?window:{});},{}],182:[function(_dereq_,module,exports){"use strict";var _regenerator=_dereq_("babel-runtime/regenerator");var _regenerator2=_interopRequireDefault(_regenerator);var _getPrototypeOf=_dereq_("babel-runtime/core-js/object/get-prototype-of");var _getPrototypeOf2=_interopRequireDefault(_getPrototypeOf);var _createClass2=_dereq_("babel-runtime/helpers/createClass");var _createClass3=_interopRequireDefault(_createClass2);var _possibleConstructorReturn2=_dereq_("babel-runtime/helpers/possibleConstructorReturn");var _possibleConstructorReturn3=_interopRequireDefault(_possibleConstructorReturn2);var _inherits2=_dereq_("babel-runtime/helpers/inherits");var _inherits3=_interopRequireDefault(_inherits2);var _classCallCheck2=_dereq_("babel-runtime/helpers/classCallCheck");var _classCallCheck3=_interopRequireDefault(_classCallCheck2);var _promise=_dereq_("babel-runtime/core-js/promise");var _promise2=_interopRequireDefault(_promise);function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj};}var __awaiter=undefined&&undefined.__awaiter||function(thisArg,_arguments,P,generator){return new(P||(P=_promise2.default))(function(resolve,reject){function fulfilled(value){try{step(generator.next(value));}catch(e){reject(e);}}function rejected(value){try{step(generator["throw"](value));}catch(e){reject(e);}}function step(result){result.done?resolve(result.value):new P(function(resolve){resolve(result.value);}).then(fulfilled,rejected);}step((generator=generator.apply(thisArg,_arguments||[])).next());});};var events_1=_dereq_("events");var operation_retrier_1=_dereq_("operation-retrier");var configuration_1=_dereq_("./configuration");var logger_1=_dereq_("./logger");var twilio_transport_1=_dereq_("twilio-transport");var TWILIO_ENDPOINT_ID='Twilio::RTD::EndpointId';function createPromise(){var pd={promise:null,resolve:null,reject:null};pd.promise=new _promise2.default(function(resolve,reject){pd.resolve=resolve;pd.reject=reject;});return pd;}var TokenRequest=function TokenRequest(){(0,_classCallCheck3.default)(this,TokenRequest);};/**
 * Client for Twilio Endpoint Management service (EMS).
 */var EmsClient=function(_events_1$EventEmitte){(0,_inherits3.default)(EmsClient,_events_1$EventEmitte);/**
     * @param config Configuration structure
     */function EmsClient(config){(0,_classCallCheck3.default)(this,EmsClient);var _this=(0,_possibleConstructorReturn3.default)(this,(EmsClient.__proto__||(0,_getPrototypeOf2.default)(EmsClient)).call(this));_this.myInstanceNumber=EmsClient.instancesCounter++;config=config||{};config.transport=config.transport||new twilio_transport_1.Transport(config.twilsockClient||null);_this.config=new configuration_1.default(config);_this.twilsock=config.twilsockClient;_this.transport=config.transport;_this.cachedContinuationToken=null;return _this;}(0,_createClass3.default)(EmsClient,[{key:"setToken",/**
         * Set new FPA token
         * @param fpaToken <String> new FPA token to use
         * @return Promise<EMSClient#TokenInfo>
         */value:function setToken(fpaToken){return __awaiter(this,void 0,void 0,_regenerator2.default.mark(function _callee(){var oldTokenRequest;return _regenerator2.default.wrap(function _callee$(_context){while(1){switch(_context.prev=_context.next){case 0:if(this.currentFpaToken!==fpaToken){this.currentFpaToken=fpaToken;oldTokenRequest=this.currentTokenRequest;this.currentTokenRequest=this.establishToken(fpaToken);this.notifyRejected(oldTokenRequest);}return _context.abrupt("return",this.currentTokenRequest.promise);case 2:case"end":return _context.stop();}}},_callee,this);}));}},{key:"notifyRejected",value:function notifyRejected(request){if(request){setTimeout(function(){return request.reject(new Error('Operation has been cancelled by next token'));},0);}}},{key:"establishToken",value:function establishToken(fpaToken){var _this2=this;var tokenRequest=new TokenRequest();var promise=new _promise2.default(function(resolve,reject){_this2.establishTokenImpl(fpaToken).then(resolve).catch(reject);tokenRequest.resolve=resolve;tokenRequest.reject=reject;});tokenRequest.promise=promise;return tokenRequest;}},{key:"establishTokenImpl",value:function establishTokenImpl(fpaToken){return __awaiter(this,void 0,void 0,_regenerator2.default.mark(function _callee2(){var _this3=this;return _regenerator2.default.wrap(function _callee2$(_context2){while(1){switch(_context2.prev=_context2.next){case 0:return _context2.abrupt("return",new operation_retrier_1.default({min:500,max:2000}).run(function(){return _this3.requestRtdToken(fpaToken);}).then(function(res){if(res.status!='ok'){throw res.exception;}if(_this3.currentFpaToken!==fpaToken){// user has already set new token. ignoring
return;}_this3.continuationToken=res.response.continuation_token;var rtdToken=res.response.twilio_rtd_token;if(res.response.status.status==='NEW'){_this3.emit('tokenCreated',rtdToken);}else{_this3.emit('tokenUpdated',rtdToken);}_this3.emit('token',rtdToken);return{token:res.response.twilio_rtd_token,ttl:res.response.ttl,status:res.response.status.status,reason:res.response.status.reason||null,identity:res.response.identity||null,accountSid:res.response.account_sid,serviceSids:res.response.instance_sids};}).catch(function(e){logger_1.default.error(e);throw e;}));case 1:case"end":return _context2.stop();}}},_callee2,this);}));}},{key:"requestRtdToken",value:function requestRtdToken(fpaToken){return __awaiter(this,void 0,void 0,_regenerator2.default.mark(function _callee3(){var headers,body,response;return _regenerator2.default.wrap(function _callee3$(_context3){while(1){switch(_context3.prev=_context3.next){case 0:headers={'Content-Type':'application/json'};body={fpa_token:fpaToken,continuation_token:this.continuationToken};logger_1.default.debug('Token request',body);_context3.prev=3;_context3.next=6;return this.transport.post(this.config.url,headers,body);case 6:response=_context3.sent;logger_1.default.debug('Token response:',response);return _context3.abrupt("return",{status:'ok',token:fpaToken,response:response.body});case 11:_context3.prev=11;_context3.t0=_context3["catch"](3);if(!(_context3.t0.status===401||_context3.t0.status===403)){_context3.next=15;break;}return _context3.abrupt("return",{status:'denied',exeception:_context3.t0,token:null,response:null});case 15:throw _context3.t0;case 16:case"end":return _context3.stop();}}},_callee3,this,[[3,11]]);}));}},{key:"shouldUsePersistentToken",get:function get(){return this.myInstanceNumber===0;}},{key:"continuationToken",get:function get(){if(this.cachedContinuationToken){return this.cachedContinuationToken;}try{if(this.shouldUsePersistentToken&&sessionStorage){this.cachedContinuationToken=sessionStorage.getItem(TWILIO_ENDPOINT_ID);return this.cachedContinuationToken;}}catch(e){logger_1.default.warn('Can\'t access persistent storage',e);}return null;},set:function set(rtdContinuationToken){this.cachedContinuationToken=rtdContinuationToken;try{if(this.shouldUsePersistentToken&&sessionStorage){sessionStorage.setItem(TWILIO_ENDPOINT_ID,rtdContinuationToken);}}catch(e){logger_1.default.warn('Can\'t access persistent storage',e);}}}]);return EmsClient;}(events_1.EventEmitter);EmsClient.instancesCounter=0;exports.EmsClient=EmsClient;/**
 * This structure describes an RTD token
 * @typedef {Object} EMSClient#TokenInfo
 * @property {String} token - RTD token generated for given FPA token
 * @property {Number} ttl - ttl to calculate expiration token time
 * @property {String} status - Indicates did server generated new token or extended existing. Valid values are ['NEW', 'UPDATED'].
 * @property {String} reason - If service issued a new RTD token, this field describes a reason
 */// for backward compatibility
var EMSClient=EmsClient;exports.EMSClient=EMSClient;Object.defineProperty(exports,"__esModule",{value:true});exports.default=EMSClient;},{"./configuration":183,"./logger":184,"babel-runtime/core-js/object/get-prototype-of":12,"babel-runtime/core-js/promise":15,"babel-runtime/helpers/classCallCheck":21,"babel-runtime/helpers/createClass":22,"babel-runtime/helpers/inherits":24,"babel-runtime/helpers/possibleConstructorReturn":25,"babel-runtime/regenerator":28,"events":169,"operation-retrier":173,"twilio-transport":214}],183:[function(_dereq_,module,exports){"use strict";var _classCallCheck2=_dereq_('babel-runtime/helpers/classCallCheck');var _classCallCheck3=_interopRequireDefault(_classCallCheck2);function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj};}var DEFAULT_EMS_HOST='https://ems.us1.twilio.com';var EMS_PATH='/v1/token';var Configuration=function Configuration(config){(0,_classCallCheck3.default)(this,Configuration);var host=config.host||DEFAULT_EMS_HOST;this.url=host+EMS_PATH;};Object.defineProperty(exports,"__esModule",{value:true});exports.default=Configuration;},{"babel-runtime/helpers/classCallCheck":21}],184:[function(_dereq_,module,exports){"use strict";var _from=_dereq_("babel-runtime/core-js/array/from");var _from2=_interopRequireDefault(_from);function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj};}var log=_dereq_("loglevel");function prepareLine(prefix,args){return[prefix].concat((0,_from2.default)(args));}Object.defineProperty(exports,"__esModule",{value:true});exports.default={setLevel:function setLevel(level){log.setLevel(level);},trace:function trace(){for(var _len=arguments.length,args=Array(_len),_key=0;_key<_len;_key++){args[_key]=arguments[_key];}log.trace.apply(null,prepareLine('EMS T:',args));},debug:function debug(){for(var _len2=arguments.length,args=Array(_len2),_key2=0;_key2<_len2;_key2++){args[_key2]=arguments[_key2];}log.debug.apply(null,prepareLine('EMS D:',args));},info:function info(){for(var _len3=arguments.length,args=Array(_len3),_key3=0;_key3<_len3;_key3++){args[_key3]=arguments[_key3];}log.info.apply(null,prepareLine('EMS I:',args));},warn:function warn(){for(var _len4=arguments.length,args=Array(_len4),_key4=0;_key4<_len4;_key4++){args[_key4]=arguments[_key4];}log.warn.apply(null,prepareLine('EMS W:',args));},error:function error(){for(var _len5=arguments.length,args=Array(_len5),_key5=0;_key5<_len5;_key5++){args[_key5]=arguments[_key5];}log.error.apply(null,prepareLine('EMS E:',args));}};},{"babel-runtime/core-js/array/from":1,"loglevel":172}],185:[function(_dereq_,module,exports){'use strict';Object.defineProperty(exports,"__esModule",{value:true});var _promise=_dereq_('babel-runtime/core-js/promise');var _promise2=_interopRequireDefault(_promise);var _defineProperties=_dereq_('babel-runtime/core-js/object/define-properties');var _defineProperties2=_interopRequireDefault(_defineProperties);var _getPrototypeOf=_dereq_('babel-runtime/core-js/object/get-prototype-of');var _getPrototypeOf2=_interopRequireDefault(_getPrototypeOf);var _classCallCheck2=_dereq_('babel-runtime/helpers/classCallCheck');var _classCallCheck3=_interopRequireDefault(_classCallCheck2);var _createClass2=_dereq_('babel-runtime/helpers/createClass');var _createClass3=_interopRequireDefault(_createClass2);var _possibleConstructorReturn2=_dereq_('babel-runtime/helpers/possibleConstructorReturn');var _possibleConstructorReturn3=_interopRequireDefault(_possibleConstructorReturn2);var _inherits2=_dereq_('babel-runtime/helpers/inherits');var _inherits3=_interopRequireDefault(_inherits2);var _configuration=_dereq_('./configuration');var _configuration2=_interopRequireDefault(_configuration);var _events=_dereq_('events');var _events2=_interopRequireDefault(_events);var _logger=_dereq_('./logger');var _logger2=_interopRequireDefault(_logger);var _bottleneck=_dereq_('bottleneck');var _bottleneck2=_interopRequireDefault(_bottleneck);var _registrar=_dereq_('./registrar');var _registrar2=_interopRequireDefault(_registrar);var _twilsock=_dereq_('twilsock');var _twilsock2=_interopRequireDefault(_twilsock);var _twilioTransport=_dereq_('twilio-transport');var _twilioTransport2=_interopRequireDefault(_twilioTransport);var _twilioEmsClient=_dereq_('twilio-ems-client');function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj};}function limit(fn,to,per){// overflow since no token is passed to arguments
var limiter=new _bottleneck2.default(to,per,1,_bottleneck2.default.strategy.LEAK);return function(){var args=Array.prototype.slice.call(arguments,0);args.unshift(fn);return limiter.schedule.apply(limiter,args);};}/**
 * @class
 * @alias Notifications
 * @classdesc The helper library for the notification service.
 * Provides high level api for creating and managing notification subscriptions and receiving messages
 * Creates the instance of Notification helper library
 *
 * @constructor
 * @param {string} token - Twilio access token
 * @param {Notifications#ClientOptions} options - Options to customize client behavior
 */var Client=function(_EventEmitter){(0,_inherits3.default)(Client,_EventEmitter);function Client(fpaToken,options){(0,_classCallCheck3.default)(this,Client);var _this=(0,_possibleConstructorReturn3.default)(this,(Client.__proto__||(0,_getPrototypeOf2.default)(Client)).call(this));if(!fpaToken){throw new Error('Token is required for Notifications client');}options=options||{};options.logLevel=options.logLevel||'error';_logger2.default.setLevel(options.logLevel);var minTokenRefreshInterval=options.minTokenRefreshInterval||10000;var productId=options.productId||'notifications';options.twilsockClient=options.twilsockClient||new _twilsock2.default(fpaToken,options);options.transport=options.transport||new _twilioTransport2.default(options.twilsockClient);options.emsClient=options.emsClient||new _twilioEmsClient.EMSClient(options);var twilsock=options.twilsockClient;var transport=options.transport;var reliableTransportState={overall:false,transport:false,registration:false};var config=new _configuration2.default(null,options);(0,_defineProperties2.default)(_this,{_config:{value:config},_emsClient:{value:options.emsClient},_registrar:{value:new _registrar2.default(productId,transport,twilsock,config)},_twilsock:{value:twilsock},_reliableTransportState:{value:reliableTransportState},updateToken:{value:limit(_this._updateToken.bind(_this),1,minTokenRefreshInterval),enumerable:true},connectionState:{get:function get(){if(_this._twilsock.state==='disconnected'){return'disconnected';}else if(_this._twilsock.state==='disconnecting'){return'disconnecting';}else if(_this._twilsock.state==='connected'&&_this._reliableTransportState.registration){return'connected';}else if(_this._twilsock.state==='rejected'){return'denied';}return'connecting';}}});_this._emsClient.setToken(fpaToken).then(function(response){return response.token;}).then(function(token){_this._config.updateToken(token);_this._registrar.updateToken();});_this._onTransportStateChange(_this._twilsock.connected);_this._registrar.on('transportReady',function(state){_this._onRegistrationStateChange(state?'registered':'');});_this._registrar.on('stateChanged',function(state){_this._onRegistrationStateChange(state);});_this._registrar.on('needReliableTransport',_this._onNeedReliableTransport.bind(_this));_this._twilsock.on('message',function(type,message){return _this._routeMessage(type,message);});_this._twilsock.on('connected',function(notificationId){_this._onTransportStateChange(true);_this._registrar.setNotificationId('twilsock',notificationId);});_this._twilsock.on('disconnected',function(){_this._onTransportStateChange(false);});return _this;}/**
   * Routes messages to the external subscribers
   * @private
   */(0,_createClass3.default)(Client,[{key:'_routeMessage',value:function _routeMessage(type,message){_logger2.default.trace('Message arrived: ',type,message);this.emit('message',type,message);}},{key:'_onNeedReliableTransport',value:function _onNeedReliableTransport(isNeeded){if(isNeeded){this._twilsock.connect();}else{this._twilsock.disconnect();}}},{key:'_onRegistrationStateChange',value:function _onRegistrationStateChange(state){this._reliableTransportState.registration=state==='registered';this._updateTransportState();}},{key:'_onTransportStateChange',value:function _onTransportStateChange(connected){this._reliableTransportState.transport=connected;this._updateTransportState();}},{key:'_updateTransportState',value:function _updateTransportState(){var overallState=this._reliableTransportState.transport&&this._reliableTransportState.registration;if(this._reliableTransportState.overall!==overallState){this._reliableTransportState.overall=overallState;_logger2.default.info('Transport ready '+overallState);this.emit('transportReady',overallState);this.emit('connectionStateChanged',this.connectionState);}}/**
     * Adds the subscription for the given message type
     * @param {string} messageType The type of message that you want to receive
     * @param {string} channelType. Supported are 'twilsock', 'gcm' and 'fcm'
     * @public
     */},{key:'subscribe',value:function subscribe(messageType,channelType){channelType=channelType||'twilsock';_logger2.default.trace('Add subscriptions for message type: ',messageType,channelType);return this._registrar.subscribe(messageType,channelType);}/**
     * Remove the subscription for the particular message type
     * @param {string} messageType The type of message that you don't want to receive anymore
     * @param {string} channelType. Supported are 'twilsock', 'gcm' and 'fcm'
     * @public
     */},{key:'unsubscribe',value:function unsubscribe(messageType,channelType){channelType=channelType||'twilsock';_logger2.default.trace('Remove subscriptions for message type: ',messageType,channelType);return this._registrar.unsubscribe(messageType,channelType);}/**
     * Handle incoming push notification.
     * Client application should call this method when it receives push notifications and pass the received data
     * @param {Object} msg - push message object
     * @public
     */},{key:'handlePushNotification',value:function handlePushNotification(msg){_logger2.default.warn('Push message passed, but no functionality implemented yet: '+msg);}/**
     * Set GCM/FCM token to enable application register for a push messages
     * @param {string} gcmToken/fcmToken Token received from GCM/FCM system
     * @public
     */},{key:'setPushRegistrationId',value:function setPushRegistrationId(registrationId,type){this._registrar.setNotificationId(type||'gcm',registrationId);}/**
     * Updates auth token for registration
     * @param {string} token Authentication token for registrations
     * @alias updateToken
     * @public
     */},{key:'_updateToken',value:function _updateToken(fpaToken){var _this2=this;_logger2.default.info('authTokenUpdated');if(this._fpaToken===fpaToken){return _promise2.default.resolve();}this._twilsock.updateToken(fpaToken);return this._emsClient.setToken(fpaToken).then(function(response){return response.token;}).then(function(token){_this2._config.updateToken(token);_this2._registrar.updateToken();});}}]);return Client;}(_events2.default);/**
 * Fired when new message arrived.
 * @param {Object} message`
 * @event NotificationsClient#message
 *//**
 * Fired when transport state has changed
 * @param {boolean} transport state
 * @event NotificationsClient#transportReady
 *//**
 * Fired when transport state has been changed
 * @param {string} transport state
 * @event NotificationsClient#connectionStateChanged
 *//**
 * These options can be passed to Client constructor
 * @typedef {Object} Notifications#ClientOptions
 * @property {String} [logLevel='error'] - The level of logging to enable. Valid options
 *   (from strictest to broadest): ['silent', 'error', 'warn', 'info', 'debug', 'trace']
 */exports.default=Client;module.exports=exports['default'];},{"./configuration":186,"./logger":188,"./registrar":190,"babel-runtime/core-js/object/define-properties":9,"babel-runtime/core-js/object/get-prototype-of":12,"babel-runtime/core-js/promise":15,"babel-runtime/helpers/classCallCheck":21,"babel-runtime/helpers/createClass":22,"babel-runtime/helpers/inherits":24,"babel-runtime/helpers/possibleConstructorReturn":25,"bottleneck":39,"events":169,"twilio-ems-client":182,"twilio-transport":214,"twilsock":217}],186:[function(_dereq_,module,exports){'use strict';Object.defineProperty(exports,"__esModule",{value:true});var _defineProperties=_dereq_('babel-runtime/core-js/object/define-properties');var _defineProperties2=_interopRequireDefault(_defineProperties);var _classCallCheck2=_dereq_('babel-runtime/helpers/classCallCheck');var _classCallCheck3=_interopRequireDefault(_classCallCheck2);var _createClass2=_dereq_('babel-runtime/helpers/createClass');var _createClass3=_interopRequireDefault(_createClass2);function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj};}var ERS_URI='https://ers.twilio.com';var ERS_PATH='/v1/registrations';var NotificationConfig=function(){function NotificationConfig(token,options){var _this=this;(0,_classCallCheck3.default)(this,NotificationConfig);options=(options||{}).Notification||{};var uri=options.ersUri||ERS_URI;(0,_defineProperties2.default)(this,{_registrarUri:{value:uri+ERS_PATH},_token:{value:token,writable:true},registrarUri:{get:function get(){return _this._registrarUri;}},token:{get:function get(){return _this._token;}}});}(0,_createClass3.default)(NotificationConfig,[{key:'updateToken',value:function updateToken(token){this._token=token;}}]);return NotificationConfig;}();exports.default=NotificationConfig;module.exports=exports['default'];},{"babel-runtime/core-js/object/define-properties":9,"babel-runtime/helpers/classCallCheck":21,"babel-runtime/helpers/createClass":22}],187:[function(_dereq_,module,exports){'use strict';Object.defineProperty(exports,"__esModule",{value:true});var _client=_dereq_('./client');var _client2=_interopRequireDefault(_client);function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj};}exports.default=_client2.default;module.exports=exports['default'];},{"./client":185}],188:[function(_dereq_,module,exports){'use strict';Object.defineProperty(exports,"__esModule",{value:true});var _from=_dereq_('babel-runtime/core-js/array/from');var _from2=_interopRequireDefault(_from);var _loglevel=_dereq_('loglevel');var _loglevel2=_interopRequireDefault(_loglevel);function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj};}function prepareLine(prefix,args){return[prefix].concat((0,_from2.default)(args));}exports.default={setLevel:function setLevel(level){_loglevel2.default.setLevel(level);},trace:function trace(){_loglevel2.default.trace.apply(null,prepareLine('Notify T:',arguments));},debug:function debug(){_loglevel2.default.debug.apply(null,prepareLine('Notify D:',arguments));},info:function info(){_loglevel2.default.info.apply(null,prepareLine('Notify I:',arguments));},warn:function warn(){_loglevel2.default.warn.apply(null,prepareLine('Notify W:',arguments));},error:function error(){_loglevel2.default.error.apply(null,prepareLine('Notify E:',arguments));}};module.exports=exports['default'];},{"babel-runtime/core-js/array/from":1,"loglevel":172}],189:[function(_dereq_,module,exports){'use strict';Object.defineProperty(exports,"__esModule",{value:true});var _freeze=_dereq_('babel-runtime/core-js/object/freeze');var _freeze2=_interopRequireDefault(_freeze);var _promise=_dereq_('babel-runtime/core-js/promise');var _promise2=_interopRequireDefault(_promise);var _set2=_dereq_('babel-runtime/core-js/set');var _set3=_interopRequireDefault(_set2);var _defineProperties=_dereq_('babel-runtime/core-js/object/define-properties');var _defineProperties2=_interopRequireDefault(_defineProperties);var _getPrototypeOf=_dereq_('babel-runtime/core-js/object/get-prototype-of');var _getPrototypeOf2=_interopRequireDefault(_getPrototypeOf);var _classCallCheck2=_dereq_('babel-runtime/helpers/classCallCheck');var _classCallCheck3=_interopRequireDefault(_classCallCheck2);var _createClass2=_dereq_('babel-runtime/helpers/createClass');var _createClass3=_interopRequireDefault(_createClass2);var _possibleConstructorReturn2=_dereq_('babel-runtime/helpers/possibleConstructorReturn');var _possibleConstructorReturn3=_interopRequireDefault(_possibleConstructorReturn2);var _inherits2=_dereq_('babel-runtime/helpers/inherits');var _inherits3=_interopRequireDefault(_inherits2);var _events=_dereq_('events');var _events2=_interopRequireDefault(_events);var _logger=_dereq_('./logger');var _logger2=_interopRequireDefault(_logger);var _javascriptStateMachine=_dereq_('javascript-state-machine');var _javascriptStateMachine2=_interopRequireDefault(_javascriptStateMachine);var _backoff=_dereq_('backoff');var _backoff2=_interopRequireDefault(_backoff);function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj};}function toArray(_set){var arr=[];_set.forEach(function(v){return arr.push(v);});return arr;}/**
 * Creates new instance of the ERS registrar
 *
 * @class RegistrarConnector
 * @classdesc Manages the registrations on ERS service.
 * It deduplicates registrations and manages them automatically
 *
 * @param Object configuration
 * @param string notificationId
 * @param string channelType
 * @param Array messageTypes
 */var RegistrarConnector=function(_EventEmitter){(0,_inherits3.default)(RegistrarConnector,_EventEmitter);function RegistrarConnector(context,transport,config,channelType){(0,_classCallCheck3.default)(this,RegistrarConnector);var _this=(0,_possibleConstructorReturn3.default)(this,(RegistrarConnector.__proto__||(0,_getPrototypeOf2.default)(RegistrarConnector)).call(this));var fsm=_javascriptStateMachine2.default.create({initial:{state:'unregistered',event:'init',defer:true},events:[{name:'userUpdate',from:['unregistered'],to:'registering'},{name:'userUpdate',from:['registered'],to:'unregistering'},{name:'registered',from:['registering','retrying'],to:'registered'},{name:'unregistered',from:['unregistering'],to:'unregistered'},{name:'retry',from:['retrying'],to:'retrying'},{name:'failure',from:['registering'],to:'retrying'},{name:'failure',from:['retrying'],to:'retrying'},{name:'failure',from:['unregistering'],to:'unregistered'}],callbacks:{onregistering:function onregistering(event,from,to,arg){return _this._register(arg);},onunregistering:function onunregistering(){return _this._unregister();},onregistered:function onregistered(){return _this._onRegistered();},onunregistered:function onunregistered(){return _this._onUnregistered();},onretrying:function onretrying(event,from,to,arg){return _this._initRetry(arg);},onfailure:function onfailure(event,from,to,arg){if(from==='retrying'){_this._initRetry(arg);}}}});var backoff=_backoff2.default.exponential({randomisationFactor:0.2,initialDelay:2*1000,maxDelay:2*60*1000});backoff.on('ready',function(){_this._retry();});(0,_defineProperties2.default)(_this,{_transport:{value:transport},_context:{value:context},_url:{value:config.registrarUri,writable:false},_config:{value:config},_fsm:{value:fsm},_backoff:{value:backoff},_channelType:{value:channelType},_registrationId:{value:false,writable:true},_notificationId:{value:false,writable:true},_messageTypes:{value:new _set3.default(),writable:true},_pendingUpdate:{value:null,writable:true}});fsm.init();return _this;}(0,_createClass3.default)(RegistrarConnector,[{key:'setNotificationId',value:function setNotificationId(notificationId){if(this._notificationId===notificationId){return;}this._notificationId=notificationId;this._updateRegistration();}},{key:'updateToken',value:function updateToken(){return this._updateRegistration();}},{key:'has',value:function has(messageType){return this._messageTypes.has(messageType);}},{key:'subscribe',value:function subscribe(messageType){if(this._messageTypes.has(messageType)){_logger2.default.debug('Message type already registered ',messageType);return false;}this._messageTypes.add(messageType);this._updateRegistration();return true;}},{key:'unsubscribe',value:function unsubscribe(messageType){if(!this._messageTypes.has(messageType)){return false;}this._messageTypes.delete(messageType);if(this._messageTypes.size>0){this._updateRegistration();}else{this._removeRegistration();}return true;}},{key:'_updateRegistration',value:function _updateRegistration(){if(this._notificationId){this._update(this._notificationId,toArray(this._messageTypes));}}},{key:'_removeRegistration',value:function _removeRegistration(){if(this._notificationId){this._update(this._notificationId,toArray(this._messageTypes));}}/**
     * Update service registration
     * @param {Array} messageTypes Array of message type names
     * @private
     */},{key:'_update',value:function _update(notificationId,messageTypes){var regData={notificationId:notificationId,messageTypes:messageTypes};if(this._fsm.is('unregistered')){if(regData.notificationId&&regData.messageTypes.length>0){this._fsm.userUpdate(regData);}}else if(this._fsm.is('registered')){this._fsm.userUpdate(regData);this._setPendingUpdate(regData);}else{this._setPendingUpdate(regData);}}},{key:'_setPendingUpdate',value:function _setPendingUpdate(regData){this._pendingUpdate=regData;}},{key:'_checkPendingUpdate',value:function _checkPendingUpdate(){if(!this._pendingUpdate){return;}var pendingUpdate=this._pendingUpdate;this._pendingUpdate=null;this._updateRegistration(pendingUpdate.notificationId,pendingUpdate.messageTypes);}},{key:'_initRetry',value:function _initRetry(regData){if(!this._pendingUpdate){this._setPendingUpdate(regData);}this._backoff.backoff();}},{key:'_retry',value:function _retry(){if(!this._pendingUpdate){return;}var pendingUpdate=this._pendingUpdate;this._pendingUpdate=null;this._register(pendingUpdate);}},{key:'_onRegistered',value:function _onRegistered(){this._backoff.reset();this.emit('stateChanged','registered');this._checkPendingUpdate();}},{key:'_onUnregistered',value:function _onUnregistered(){this._backoff.reset();this.emit('stateChanged','unregistered');this._checkPendingUpdate();}},{key:'_register',value:function _register(regData){var _this2=this;/* eslint-disable camelcase */var registrarRequest={endpoint_platform:this._context.platform,channel_type:this._channelType,version:'2',message_types:regData.messageTypes,data:{},ttl:'PT24H'};if(this._channelType==='twilsock'){registrarRequest.data.url=regData.notificationId;}else{registrarRequest.data.registration_id=regData.notificationId;}var uri=this._url+'?productId='+this._context.productId;var headers={'Content-Type':'application/json','X-Twilio-Token':this._config.token};/* eslint-enable camelcase */_logger2.default.trace('Creating registration for channel ',this._channelType);return this._transport.post(uri,headers,registrarRequest).then(function(response){_this2._registrationId=response.body.id;_this2._registrationData=regData;_logger2.default.debug('Registration created: ',response);_this2._fsm.registered();}).catch(function(error){_logger2.default.error('Registration failed: ',error);_this2._fsm.failure(regData);return error;});}},{key:'_unregister',value:function _unregister(){var _this3=this;if(!this._registrationId){return _promise2.default.resolve();}var uri=this._url+'/'+this._registrationId+'?productId='+this._context.productId;var headers={'Content-Type':'application/json','X-Twilio-Token':this._config.token};_logger2.default.trace('Removing registration for ',this._channelType);return this._transport.delete(uri,headers).then(function(){_logger2.default.debug('Registration removed for ',_this3._channelType);_this3._registrationId=false;_this3._fsm.unregistered();}).catch(function(reason){// failure to remove registration since being treated as "unregistered" state
// because it is indicates that something wrong with server/connection
_logger2.default.error('Failed to remove of registration ',_this3.channelType,reason);_this3._fsm.failure();return reason;});}}]);return RegistrarConnector;}(_events2.default);exports.default=RegistrarConnector;(0,_freeze2.default)(RegistrarConnector);module.exports=exports['default'];},{"./logger":188,"babel-runtime/core-js/object/define-properties":9,"babel-runtime/core-js/object/freeze":11,"babel-runtime/core-js/object/get-prototype-of":12,"babel-runtime/core-js/promise":15,"babel-runtime/core-js/set":17,"babel-runtime/helpers/classCallCheck":21,"babel-runtime/helpers/createClass":22,"babel-runtime/helpers/inherits":24,"babel-runtime/helpers/possibleConstructorReturn":25,"backoff":29,"events":169,"javascript-state-machine":170}],190:[function(_dereq_,module,exports){'use strict';Object.defineProperty(exports,"__esModule",{value:true});var _freeze=_dereq_('babel-runtime/core-js/object/freeze');var _freeze2=_interopRequireDefault(_freeze);var _map=_dereq_('babel-runtime/core-js/map');var _map2=_interopRequireDefault(_map);var _defineProperties=_dereq_('babel-runtime/core-js/object/define-properties');var _defineProperties2=_interopRequireDefault(_defineProperties);var _getPrototypeOf=_dereq_('babel-runtime/core-js/object/get-prototype-of');var _getPrototypeOf2=_interopRequireDefault(_getPrototypeOf);var _classCallCheck2=_dereq_('babel-runtime/helpers/classCallCheck');var _classCallCheck3=_interopRequireDefault(_classCallCheck2);var _createClass2=_dereq_('babel-runtime/helpers/createClass');var _createClass3=_interopRequireDefault(_createClass2);var _possibleConstructorReturn2=_dereq_('babel-runtime/helpers/possibleConstructorReturn');var _possibleConstructorReturn3=_interopRequireDefault(_possibleConstructorReturn2);var _inherits2=_dereq_('babel-runtime/helpers/inherits');var _inherits3=_interopRequireDefault(_inherits2);var _events=_dereq_('events');var _events2=_interopRequireDefault(_events);var _registrar=_dereq_('./registrar.connector');var _registrar2=_interopRequireDefault(_registrar);var _twilsock=_dereq_('./twilsock.connector');var _twilsock2=_interopRequireDefault(_twilsock);function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj};}/**
 * Creates the new instance of ERS registrar client
 *
 * @class Registrar
 * @classdesc Provides an interface to the ERS registrar
 */var Registrar=function(_EventEmitter){(0,_inherits3.default)(Registrar,_EventEmitter);function Registrar(productId,transport,twilsock,config){(0,_classCallCheck3.default)(this,Registrar);var _this=(0,_possibleConstructorReturn3.default)(this,(Registrar.__proto__||(0,_getPrototypeOf2.default)(Registrar)).call(this));(0,_defineProperties2.default)(_this,{_conf:{value:config},_connectors:{value:new _map2.default()}});var platform=(typeof navigator!=='undefined'?navigator.userAgent:'web').substring(0,128);_this._connectors.set('twilsock',new _twilsock2.default({productId:productId,platform:platform},twilsock,config));_this._connectors.set('gcm',new _registrar2.default({productId:productId,platform:platform},transport,config,'gcm'));_this._connectors.set('fcm',new _registrar2.default({productId:productId,platform:platform},transport,config,'fcm'));_this._connectors.set('apn',new _registrar2.default({productId:productId,platform:platform},transport,config,'apn'));_this._connectors.get('twilsock').on('transportReady',function(state){return _this.emit('transportReady',state);});return _this;}/**
   *  Sets notification ID.
   *  If new URI is different from previous, it triggers updating of registration for given channel
   *
   *  @param {string} channelType channel type (apn|gcm|fcm|twilsock)
   *  @param {string} notificationId The notification ID
   */(0,_createClass3.default)(Registrar,[{key:'setNotificationId',value:function setNotificationId(channelType,notificationId){this._connector(channelType).setNotificationId(notificationId);}/**
     * Checks if subscription for given message and channel already exists
     */},{key:'hasSubscription',value:function hasSubscription(messageType,channelType){this._connector(channelType).has(messageType);}/**
     * Subscribe for given type of message
     *
     * @param {String} messageType Message type identifier
     * @param {String} channelType Channel type, can be 'twilsock', 'gcm' or 'fcm'
     * @public
     */},{key:'subscribe',value:function subscribe(messageType,channelType){this._connector(channelType).subscribe(messageType);}/**
     * Remove subscription
     * @param {String} messageType Message type
     * @param {String} channelType Channel type (twilsock or gcm/fcm)
     * @public
     */},{key:'unsubscribe',value:function unsubscribe(messageType,channelType){this._connector(channelType).unsubscribe(messageType);}},{key:'updateToken',value:function updateToken(){this._connectors.forEach(function(connector){return connector.updateToken();});}/**
     * @param {String} type Channel type
     * @throws {Error} Error with description
     * @private
     */},{key:'_connector',value:function _connector(type){var connector=this._connectors.get(type);if(!connector){throw new Error('Unknown channel type: '+type);}return connector;}}]);return Registrar;}(_events2.default);exports.default=Registrar;(0,_freeze2.default)(Registrar);module.exports=exports['default'];},{"./registrar.connector":189,"./twilsock.connector":191,"babel-runtime/core-js/map":5,"babel-runtime/core-js/object/define-properties":9,"babel-runtime/core-js/object/freeze":11,"babel-runtime/core-js/object/get-prototype-of":12,"babel-runtime/helpers/classCallCheck":21,"babel-runtime/helpers/createClass":22,"babel-runtime/helpers/inherits":24,"babel-runtime/helpers/possibleConstructorReturn":25,"events":169}],191:[function(_dereq_,module,exports){'use strict';Object.defineProperty(exports,"__esModule",{value:true});var _freeze=_dereq_('babel-runtime/core-js/object/freeze');var _freeze2=_interopRequireDefault(_freeze);var _set2=_dereq_('babel-runtime/core-js/set');var _set3=_interopRequireDefault(_set2);var _defineProperties=_dereq_('babel-runtime/core-js/object/define-properties');var _defineProperties2=_interopRequireDefault(_defineProperties);var _getPrototypeOf=_dereq_('babel-runtime/core-js/object/get-prototype-of');var _getPrototypeOf2=_interopRequireDefault(_getPrototypeOf);var _classCallCheck2=_dereq_('babel-runtime/helpers/classCallCheck');var _classCallCheck3=_interopRequireDefault(_classCallCheck2);var _createClass2=_dereq_('babel-runtime/helpers/createClass');var _createClass3=_interopRequireDefault(_createClass2);var _possibleConstructorReturn2=_dereq_('babel-runtime/helpers/possibleConstructorReturn');var _possibleConstructorReturn3=_interopRequireDefault(_possibleConstructorReturn2);var _inherits2=_dereq_('babel-runtime/helpers/inherits');var _inherits3=_interopRequireDefault(_inherits2);var _uuid=_dereq_('uuid');var _uuid2=_interopRequireDefault(_uuid);var _logger=_dereq_('./logger');var _logger2=_interopRequireDefault(_logger);var _events=_dereq_('events');var _events2=_interopRequireDefault(_events);function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj};}var DEFAULT_TTL=60*60*48;function toArray(_set){var arr=[];_set.forEach(function(v){return arr.push(v);});return arr;}/**
 * @class
 * @classdesc Registrar connector implementation for twilsock
 *
 * @constructor
 */var TwilsockConnector=function(_EventEmitter){(0,_inherits3.default)(TwilsockConnector,_EventEmitter);function TwilsockConnector(context,twilsock,config){(0,_classCallCheck3.default)(this,TwilsockConnector);var _this=(0,_possibleConstructorReturn3.default)(this,(TwilsockConnector.__proto__||(0,_getPrototypeOf2.default)(TwilsockConnector)).call(this));context.id=_uuid2.default.v4();(0,_defineProperties2.default)(_this,{_twilsock:{value:twilsock},_messageTypes:{value:new _set3.default()},config:{value:config},context:{value:context}});twilsock.on('stateChanged',function(state){if(state!=='connected'){_this.emit('transportReady',false);}});twilsock.on('registered',function(id){if(context&&id===context.id&&twilsock.state==='connected'){_this.emit('transportReady',true);}});return _this;}/**
   * @public
   */(0,_createClass3.default)(TwilsockConnector,[{key:'setNotificationId',value:function setNotificationId(){return false;}/**
     * @public
     */},{key:'updateToken',value:function updateToken(){this._twilsock.removeNotificationsContext(this.context.id);this.context.id=_uuid2.default.v4();this._updateContext();}/**
     * @public
     */},{key:'has',value:function has(messageType){return this._messageTypes.has(messageType);}/**
     * @public
     */},{key:'subscribe',value:function subscribe(messageType){if(this._messageTypes.has(messageType)){_logger2.default.trace('Message type already registered ',messageType);return false;}this._messageTypes.add(messageType);this._updateContext();return true;}/**
     * @public
     */},{key:'unsubscribe',value:function unsubscribe(messageType){if(!this._messageTypes.has(messageType)){return false;}this._messageTypes.delete(messageType);if(this._messageTypes.size>0){this._updateContext();}else{this._twilsock.removeNotificationsContext(this.context.id);}return true;}/**
     * @private
     */},{key:'_updateContext',value:function _updateContext(){if(!this.config.token){// no token, can't do anything, ignore
return;}var messageTypes=toArray(this._messageTypes);/* eslint-disable camelcase */var context={product_id:this.context.productId,notification_protocol_version:4,endpoint_platform:this.context.platform,ttl:DEFAULT_TTL,token:this.config.token,message_types:messageTypes};/* eslint-enable camelcase */this.emit('transportReady',false);this._twilsock.setNotificationsContext(this.context.id,context);}}]);return TwilsockConnector;}(_events2.default);exports.default=TwilsockConnector;(0,_freeze2.default)(TwilsockConnector);module.exports=exports['default'];},{"./logger":188,"babel-runtime/core-js/object/define-properties":9,"babel-runtime/core-js/object/freeze":11,"babel-runtime/core-js/object/get-prototype-of":12,"babel-runtime/core-js/set":17,"babel-runtime/helpers/classCallCheck":21,"babel-runtime/helpers/createClass":22,"babel-runtime/helpers/inherits":24,"babel-runtime/helpers/possibleConstructorReturn":25,"events":169,"uuid":224}],192:[function(_dereq_,module,exports){"use strict";var _classCallCheck2=_dereq_("babel-runtime/helpers/classCallCheck");var _classCallCheck3=_interopRequireDefault(_classCallCheck2);var _createClass2=_dereq_("babel-runtime/helpers/createClass");var _createClass3=_interopRequireDefault(_createClass2);function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj};}var karibu_1=_dereq_("karibu");var Entry=function(){function Entry(value,revision){(0,_classCallCheck3.default)(this,Entry);this.value=value;this.revision=revision;}(0,_createClass3.default)(Entry,[{key:"isValid",get:function get(){return true;}}]);return Entry;}();var Tombstone=function(){function Tombstone(revision){(0,_classCallCheck3.default)(this,Tombstone);this.revision=revision;}(0,_createClass3.default)(Tombstone,[{key:"isValid",get:function get(){return false;}}]);return Tombstone;}();var Cache=function(){function Cache(){(0,_classCallCheck3.default)(this,Cache);this.items=new karibu_1.TreeMap();}(0,_createClass3.default)(Cache,[{key:"store",value:function store(key,value,revision){var entry=this.items.get(key);if(entry&&entry.revision>revision){if(entry.isValid){return entry.value;}return null;}this.items.set(key,new Entry(value,revision));return value;}},{key:"delete",value:function _delete(key,revision){var curr=this.items.get(key);if(!curr||curr.revision<revision){this.items.set(key,new Tombstone(revision));}}},{key:"isKnown",value:function isKnown(key,revision){var curr=this.items.get(key);return curr&&curr.revision>=revision;}},{key:"get",value:function get(key){var entry=this.items.get(key);if(entry&&entry.isValid){return entry.value;}return null;}},{key:"has",value:function has(key){var entry=this.items.get(key);return entry&&entry.isValid;}}]);return Cache;}();exports.Cache=Cache;Object.defineProperty(exports,"__esModule",{value:true});exports.default=Cache;},{"babel-runtime/helpers/classCallCheck":21,"babel-runtime/helpers/createClass":22,"karibu":171}],193:[function(_dereq_,module,exports){"use strict";var _regenerator=_dereq_("babel-runtime/regenerator");var _regenerator2=_interopRequireDefault(_regenerator);var _getPrototypeOf=_dereq_("babel-runtime/core-js/object/get-prototype-of");var _getPrototypeOf2=_interopRequireDefault(_getPrototypeOf);var _classCallCheck2=_dereq_("babel-runtime/helpers/classCallCheck");var _classCallCheck3=_interopRequireDefault(_classCallCheck2);var _createClass2=_dereq_("babel-runtime/helpers/createClass");var _createClass3=_interopRequireDefault(_createClass2);var _possibleConstructorReturn2=_dereq_("babel-runtime/helpers/possibleConstructorReturn");var _possibleConstructorReturn3=_interopRequireDefault(_possibleConstructorReturn2);var _inherits2=_dereq_("babel-runtime/helpers/inherits");var _inherits3=_interopRequireDefault(_inherits2);var _promise=_dereq_("babel-runtime/core-js/promise");var _promise2=_interopRequireDefault(_promise);function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj};}var __awaiter=undefined&&undefined.__awaiter||function(thisArg,_arguments,P,generator){return new(P||(P=_promise2.default))(function(resolve,reject){function fulfilled(value){try{step(generator.next(value));}catch(e){reject(e);}}function rejected(value){try{step(generator["throw"](value));}catch(e){reject(e);}}function step(result){result.done?resolve(result.value):new P(function(resolve){resolve(result.value);}).then(fulfilled,rejected);}step((generator=generator.apply(thisArg,_arguments||[])).next());});};var events_1=_dereq_("events");var Twilsock=_dereq_("twilsock");var twilio_transport_1=_dereq_("twilio-transport");var twilio_ems_client_1=_dereq_("twilio-ems-client");var Notifications=_dereq_("twilio-notifications");var utils_1=_dereq_("./utils");var logger_1=_dereq_("./logger");var configuration_1=_dereq_("./configuration");var subscriptions_1=_dereq_("./subscriptions");var router_1=_dereq_("./router");var network_1=_dereq_("./network");var syncdocument_1=_dereq_("./syncdocument");var synclist_1=_dereq_("./synclist");var syncmap_1=_dereq_("./syncmap");var clientInfo_1=_dereq_("./clientInfo");var entitiesCache_1=_dereq_("./entitiesCache");var syncerror_1=_dereq_("./syncerror");var SYNC_PRODUCT_ID='data_sync';var SDK_VERSION=_dereq_('../package.json').version;function subscribe(subscribable){subscribable._subscribe();return subscribable;}function createPayload(name,purpose,context,data){return{unique_name:name,purpose:purpose,context:context,data:data};}function decompose(arg){if(!arg){return{id:null,purpose:null,data:null,context:null,mode:null};}if(typeof arg==='string'){return{id:arg,purpose:null,data:null,context:null,mode:null};}return{id:arg.uniqueName||arg.sid||arg.id,purpose:arg.purpose,data:arg.data,context:arg.context,mode:arg.mode};}/**
 * @class Client
 * @classdesc
 * Client for the Twilio Sync service
 *
 * @property {Client#connectionState} connectionState - Connection state info
 */var SyncClient=function(_events_1$EventEmitte){(0,_inherits3.default)(SyncClient,_events_1$EventEmitte);/*
     * @constructor
     * @param {string} Token Twilio access token
     * @param {Client#ClientOptions} options - Options to customize the Client
     */function SyncClient(fpaToken){var options=arguments.length>1&&arguments[1]!==undefined?arguments[1]:{};(0,_classCallCheck3.default)(this,SyncClient);var _this=(0,_possibleConstructorReturn3.default)(this,(SyncClient.__proto__||(0,_getPrototypeOf2.default)(SyncClient)).call(this));if(!fpaToken){throw new Error('Sync library needs a valid Twilio token to be passed');}if(options.hasOwnProperty('logLevel')){logger_1.default.setLevel(options.logLevel);}var productId=options.productId=options.productId||SYNC_PRODUCT_ID;var twilsock=options.twilsockClient=options.twilsockClient||new Twilsock(fpaToken,options);var transport=options.transport=options.transport||new twilio_transport_1.Transport(options.twilsockClient);var emsClient=options.emsClient=options.emsClient||new twilio_ems_client_1.EmsClient(options);var notifications=options.notificationsClient=options.notificationsClient||new Notifications(fpaToken,options);var config=new configuration_1.Configuration(null,options);var network=new network_1.Network(productId,new clientInfo_1.ClientInfo(SDK_VERSION),config,transport);_this.fpaToken=fpaToken;emsClient.setToken(fpaToken).then(function(response){return _this.services.config.updateToken(response.token);});twilsock.connect();_this.services={config:config,twilsock:twilsock,notifications:notifications,network:network,emsClient:emsClient,router:null,subscriptions:null};var subscriptions=new subscriptions_1.Subscriptions(_this.services);var router=new router_1.Router({config:config,subscriptions:subscriptions,notifications:notifications});_this.services.router=router;_this.services.subscriptions=subscriptions;_this.entities=new entitiesCache_1.EntitiesCache();notifications.on('connectionStateChanged',function(){_this.emit('connectionStateChanged',_this.services.notifications.connectionState);});return _this;}/**
     * Current version of Sync client.
     * @name Client#version
     * @type String
     * @readonly
     */(0,_createClass3.default)(SyncClient,[{key:"ensureReady",/**
         * Returns promise which resolves when library is correctly initialized
         * Or throws if initialization is impossible
         */value:function ensureReady(){var _this2=this;if(this.services.config.token){return _promise2.default.resolve(this.services.config.token);}return new _promise2.default(function(resolve,reject){_this2.services.emsClient.once('token',function(token){setTimeout(function(){return resolve(token);},0);});});}},{key:"_get",value:function _get(baseUri,id){return __awaiter(this,void 0,void 0,_regenerator2.default.mark(function _callee(){var uri,response,objects;return _regenerator2.default.wrap(function _callee$(_context){while(1){switch(_context.prev=_context.next){case 0:if(id){_context.next=2;break;}return _context.abrupt("return",null);case 2:uri=new utils_1.UriBuilder(baseUri).arg('Deep',true).arg('Id',id).build();_context.next=5;return this.services.network.get(uri);case 5:response=_context.sent;objects=response.body.documents||response.body.lists||response.body.maps||[];return _context.abrupt("return",objects.length===0?null:objects[0]);case 8:case"end":return _context.stop();}}},_callee,this);}));}},{key:"_createDocument",value:function _createDocument(id,purpose,data){var payload=createPayload(id,purpose,null,data);return this.services.network.post(this.services.config.documentsUri,payload).then(function(response){return response.body;});}},{key:"_getDocument",value:function _getDocument(id){return this._get(this.services.config.documentsUri,id);}},{key:"_createList",value:function _createList(id,purpose,context){var payload=createPayload(id,purpose,context);return this.services.network.post(this.services.config.listsUri,payload).then(function(response){return response.body;});}},{key:"_getList",value:function _getList(id){return this._get(this.services.config.listsUri,id);}},{key:"_createMap",value:function _createMap(id,purpose,context){var payload=createPayload(id,purpose,context);return this.services.network.post(this.services.config.mapsUri,payload).then(function(response){return response.body;});}},{key:"_getMap",value:function _getMap(id){return this._get(this.services.config.mapsUri,id);}},{key:"getCached",value:function getCached(id,type){return this.entities.get(id,type)||null;}},{key:"removeFromCache",value:function removeFromCache(sid){this.entities.remove(sid);}/**
         * Open a SyncDocument by identifier, or create one if none exists
         * @param {string} id Document identifier. Unique name or sid.
         * @return {Promise<Document>}
         * @public
         */},{key:"document",value:function document(arg){return __awaiter(this,void 0,void 0,_regenerator2.default.mark(function _callee2(){var _this3=this;var _decompose,id,purpose,data,mode;return _regenerator2.default.wrap(function _callee2$(_context2){while(1){switch(_context2.prev=_context2.next){case 0:_context2.next=2;return this.ensureReady();case 2:_decompose=decompose(arg),id=_decompose.id,purpose=_decompose.purpose,data=_decompose.data,mode=_decompose.mode;return _context2.abrupt("return",this.getCached(id,'document')||this._getDocument(id).then(function(body){if(body){return body;}else if(mode!=='open'){return _this3._createDocument(id,purpose,data);}throw new syncerror_1.default('Not found',404);}).then(function(body){return new syncdocument_1.SyncDocument(_this3.services,body,function(sid){return _this3.removeFromCache(sid);});}).then(function(entity){return _this3.entities.store(entity);}).then(subscribe));case 4:case"end":return _context2.stop();}}},_callee2,this);}));}/**
         * Open a Map by identifier, or create one if none exists
         * @param {string} id Map identifier. Unique name or sid.
         * @return {Promise<Map>}
         * @public
         */},{key:"map",value:function map(arg){return __awaiter(this,void 0,void 0,_regenerator2.default.mark(function _callee3(){var _this4=this;var _decompose2,id,purpose,context,mode;return _regenerator2.default.wrap(function _callee3$(_context3){while(1){switch(_context3.prev=_context3.next){case 0:_context3.next=2;return this.ensureReady();case 2:_decompose2=decompose(arg),id=_decompose2.id,purpose=_decompose2.purpose,context=_decompose2.context,mode=_decompose2.mode;return _context3.abrupt("return",this.getCached(id,'map')||this._getMap(id).then(function(body){if(body){return body;}else if(mode!=='open'){return _this4._createMap(id,purpose,context);}throw new syncerror_1.default('Not found',404);}).then(function(body){return new syncmap_1.SyncMap(_this4.services,body,function(sid){return _this4.removeFromCache(sid);});}).then(function(entity){return _this4.entities.store(entity);}).then(subscribe));case 4:case"end":return _context3.stop();}}},_callee3,this);}));}/**
         * Open a List by identifier, or create one if none exists
         * @param {string} id List identifier. Unique name or sid.
         * @return {Promise<List>}
         * @public
         */},{key:"list",value:function list(arg){return __awaiter(this,void 0,void 0,_regenerator2.default.mark(function _callee4(){var _this5=this;var _decompose3,id,purpose,context,mode;return _regenerator2.default.wrap(function _callee4$(_context4){while(1){switch(_context4.prev=_context4.next){case 0:_context4.next=2;return this.ensureReady();case 2:_decompose3=decompose(arg),id=_decompose3.id,purpose=_decompose3.purpose,context=_decompose3.context,mode=_decompose3.mode;return _context4.abrupt("return",this.getCached(id,'list')||this._getList(id).then(function(body){if(body){return body;}else if(mode!=='open'){return _this5._createList(id,purpose,context);}throw new syncerror_1.default('Not found',404);}).then(function(body){return new synclist_1.SyncList(_this5.services,body,function(sid){return _this5.removeFromCache(sid);});}).then(function(entity){return _this5.entities.store(entity);}).then(subscribe));case 4:case"end":return _context4.stop();}}},_callee4,this);}));}/**
         * Gracefully shutdown the libray
         * Currently it is not properly implemented and being used only in tests
         * But should be made a part of public API
         * @private
         */},{key:"shutdown",value:function shutdown(){return __awaiter(this,void 0,void 0,_regenerator2.default.mark(function _callee5(){return _regenerator2.default.wrap(function _callee5$(_context5){while(1){switch(_context5.prev=_context5.next){case 0:_context5.next=2;return this.services.subscriptions.shutdown();case 2:_context5.next=4;return this.services.twilsock.disconnect();case 4:case"end":return _context5.stop();}}},_callee5,this);}));}/**
         * Set new auth token
         * @param {string} token New token to set
         * @return {Promise}
         * @public
         */},{key:"updateToken",value:function updateToken(fpaToken){return __awaiter(this,void 0,void 0,_regenerator2.default.mark(function _callee6(){var response;return _regenerator2.default.wrap(function _callee6$(_context6){while(1){switch(_context6.prev=_context6.next){case 0:_context6.next=2;return this.services.emsClient.setToken(fpaToken);case 2:response=_context6.sent;this.services.config.updateToken(response.token);_context6.next=6;return _promise2.default.all([this.services.notifications.updateToken(fpaToken),this.services.twilsock.updateToken(fpaToken)]);case 6:this.fpaToken=fpaToken;case 7:case"end":return _context6.stop();}}},_callee6,this);}));}},{key:"connectionState",get:function get(){return this.services.notifications.connectionState;}}],[{key:"version",get:function get(){return SDK_VERSION;}}]);return SyncClient;}(events_1.EventEmitter);exports.SyncClient=SyncClient;exports.Client=SyncClient;Object.defineProperty(exports,"__esModule",{value:true});exports.default=SyncClient;/**
 * These options can be passed to Client constructor
 * @typedef {Object} Client#ClientOptions
 * @property {String} [logLevel='error'] - The level of logging to enable. Valid options
 *   (from strictest to broadest): ['silent', 'error', 'warn', 'info', 'debug', 'trace']
 *//**
 * Fired when connection state has been changed.
 * @param {Client#connectionState} ConnectionState
 * @event Client#connectionStateChanged
 */},{"../package.json":212,"./clientInfo":194,"./configuration":195,"./entitiesCache":196,"./logger":200,"./network":202,"./router":205,"./subscriptions":206,"./syncdocument":207,"./syncerror":208,"./synclist":209,"./syncmap":210,"./utils":211,"babel-runtime/core-js/object/get-prototype-of":12,"babel-runtime/core-js/promise":15,"babel-runtime/helpers/classCallCheck":21,"babel-runtime/helpers/createClass":22,"babel-runtime/helpers/inherits":24,"babel-runtime/helpers/possibleConstructorReturn":25,"babel-runtime/regenerator":28,"events":169,"twilio-ems-client":182,"twilio-notifications":187,"twilio-transport":214,"twilsock":217}],194:[function(_dereq_,module,exports){"use strict";var _classCallCheck2=_dereq_("babel-runtime/helpers/classCallCheck");var _classCallCheck3=_interopRequireDefault(_classCallCheck2);function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj};}var platform=_dereq_("platform");var ClientInfo=function ClientInfo(version){(0,_classCallCheck3.default)(this,ClientInfo);this.sdk='js';this.sdkVer=version;this.os=platform.os.family;this.osVer=platform.os.version;this.pl=platform.name;this.plVer=platform.version;};exports.ClientInfo=ClientInfo;Object.defineProperty(exports,"__esModule",{value:true});exports.default=ClientInfo;},{"babel-runtime/helpers/classCallCheck":21,"platform":174}],195:[function(_dereq_,module,exports){"use strict";var _classCallCheck2=_dereq_('babel-runtime/helpers/classCallCheck');var _classCallCheck3=_interopRequireDefault(_classCallCheck2);var _createClass2=_dereq_('babel-runtime/helpers/createClass');var _createClass3=_interopRequireDefault(_createClass2);function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj};}var CDS_URI='https://cds.twilio.com';var SUBSCRIPTIONS_PATH='/v4/Subscriptions';var MAPS_PATH='/v3/Maps';var LISTS_PATH='/v3/Lists';var DOCUMENTS_PATH='/v3/Documents';/**
 * Settings container for Sync library
 */var Configuration=function(){/**
     * @param {String} token - authentication token
     */function Configuration(token,options){(0,_classCallCheck3.default)(this,Configuration);options=(options||{}).DataSync||{};var baseUri=options.cdsUri||CDS_URI;this._token=token;this.settings={subscriptionsUri:baseUri+SUBSCRIPTIONS_PATH,documentsUri:baseUri+DOCUMENTS_PATH,listsUri:baseUri+LISTS_PATH,mapsUri:baseUri+MAPS_PATH};}(0,_createClass3.default)(Configuration,[{key:'updateToken',value:function updateToken(token){this._token=token;}},{key:'token',get:function get(){return this._token;}},{key:'subscriptionsUri',get:function get(){return this.settings.subscriptionsUri;}},{key:'documentsUri',get:function get(){return this.settings.documentsUri;}},{key:'listsUri',get:function get(){return this.settings.listsUri;}},{key:'mapsUri',get:function get(){return this.settings.mapsUri;}},{key:'backoffConfig',get:function get(){return this.settings.backoffConfig||{};}}]);return Configuration;}();exports.Configuration=Configuration;},{"babel-runtime/helpers/classCallCheck":21,"babel-runtime/helpers/createClass":22}],196:[function(_dereq_,module,exports){"use strict";/**
 * Container for entities which are known by the client
 * It's needed for deduplication when client obtain the same object several times
 */var _map=_dereq_('babel-runtime/core-js/map');var _map2=_interopRequireDefault(_map);var _classCallCheck2=_dereq_('babel-runtime/helpers/classCallCheck');var _classCallCheck3=_interopRequireDefault(_classCallCheck2);var _createClass2=_dereq_('babel-runtime/helpers/createClass');var _createClass3=_interopRequireDefault(_createClass2);function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj};}var EntitiesCache=function(){function EntitiesCache(){(0,_classCallCheck3.default)(this,EntitiesCache);this.names=new _map2.default();this.entities=new _map2.default();}(0,_createClass3.default)(EntitiesCache,[{key:'store',value:function store(entity){var stored=this.entities.get(entity.sid);if(stored){return stored;}this.entities.set(entity.sid,entity);if(entity.uniqueName){this.names.set(entity.type+'::'+entity.uniqueName,entity.sid);}return entity;}},{key:'getResolved',value:function getResolved(id,type){var resolvedSid=this.names.get(type+'::'+id);return resolvedSid?this.entities.get(resolvedSid):null;}},{key:'get',value:function get(id,type){return this.entities.get(id)||this.getResolved(id,type)||null;}},{key:'remove',value:function remove(sid){var cached=this.entities.get(sid);if(cached){this.entities.delete(sid);if(cached.uniqueName){this.names.delete(cached.type+'::'+cached.uniqueName);}}}}]);return EntitiesCache;}();exports.EntitiesCache=EntitiesCache;},{"babel-runtime/core-js/map":5,"babel-runtime/helpers/classCallCheck":21,"babel-runtime/helpers/createClass":22}],197:[function(_dereq_,module,exports){"use strict";var _getPrototypeOf=_dereq_("babel-runtime/core-js/object/get-prototype-of");var _getPrototypeOf2=_interopRequireDefault(_getPrototypeOf);var _classCallCheck2=_dereq_("babel-runtime/helpers/classCallCheck");var _classCallCheck3=_interopRequireDefault(_classCallCheck2);var _createClass2=_dereq_("babel-runtime/helpers/createClass");var _createClass3=_interopRequireDefault(_createClass2);var _possibleConstructorReturn2=_dereq_("babel-runtime/helpers/possibleConstructorReturn");var _possibleConstructorReturn3=_interopRequireDefault(_possibleConstructorReturn2);var _inherits2=_dereq_("babel-runtime/helpers/inherits");var _inherits3=_interopRequireDefault(_inherits2);function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj};}var events_1=_dereq_("events");var SyncEntity=function(_events_1$EventEmitte){(0,_inherits3.default)(SyncEntity,_events_1$EventEmitte);function SyncEntity(services){(0,_classCallCheck3.default)(this,SyncEntity);var _this=(0,_possibleConstructorReturn3.default)(this,(SyncEntity.__proto__||(0,_getPrototypeOf2.default)(SyncEntity)).call(this));_this.services=services;return _this;}(0,_createClass3.default)(SyncEntity,[{key:"reportFailure",value:function reportFailure(err){if(err.status===404){// assume that 404 means that entity has been removed while we were away
this.onRemoved(false);}else{this.emit('failure',err);}}/**
         * Subscribe to changes of data entity
         * @private
         */},{key:"_subscribe",value:function _subscribe(){this.services.router.subscribe(this.sid,this);return this;}/**
         * Unsubscribe from changes of current data entity
         * @private
         */},{key:"_unsubscribe",value:function _unsubscribe(){this.services.router.unsubscribe(this.sid,this);return this;}/**
         * @public
         */},{key:"close",value:function close(){this._unsubscribe();}}]);return SyncEntity;}(events_1.EventEmitter);exports.SyncEntity=SyncEntity;Object.defineProperty(exports,"__esModule",{value:true});exports.default=SyncEntity;},{"babel-runtime/core-js/object/get-prototype-of":12,"babel-runtime/helpers/classCallCheck":21,"babel-runtime/helpers/createClass":22,"babel-runtime/helpers/inherits":24,"babel-runtime/helpers/possibleConstructorReturn":25,"events":169}],198:[function(_dereq_,module,exports){"use strict";var client_1=_dereq_("./client");exports.SyncClient=client_1.SyncClient;Object.defineProperty(exports,"__esModule",{value:true});exports.default=client_1.SyncClient;},{"./client":193}],199:[function(_dereq_,module,exports){"use strict";/**
 * @class
 * @classdesc List item
 * Represents a data for each element in a collection
 * @alias ListItem
 * @property {Number} index  - identifier of an item
 * @property {Object} value - value of an item
 */var _classCallCheck2=_dereq_("babel-runtime/helpers/classCallCheck");var _classCallCheck3=_interopRequireDefault(_classCallCheck2);var _createClass2=_dereq_("babel-runtime/helpers/createClass");var _createClass3=_interopRequireDefault(_createClass2);function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj};}var ListItem=function(){/**
   * @private
   * @constructor
   * @param {Object} data Item descriptor
   * @param {Number} data.index Item identifier
   * @param {String} data.uri Item URI
   * @param {Object} data.value Item data
   */function ListItem(data){(0,_classCallCheck3.default)(this,ListItem);this.data=data;}(0,_createClass3.default)(ListItem,[{key:"update",/**
     * Update item data
     * @param {Number} EventId Update event id
     * @param {String} Revision Updated item revision
     * @param {Object} Value Updated item data
     * @private
     */value:function update(eventId,revision,value){this.data.lastEventId=eventId;this.data.revision=revision;this.data.value=value;return this;}},{key:"uri",get:function get(){return this.data.uri;}},{key:"revision",get:function get(){return this.data.revision;}},{key:"lastEventId",get:function get(){return this.data.lastEventId;}},{key:"index",get:function get(){return this.data.index;}},{key:"value",get:function get(){return this.data.value;}}]);return ListItem;}();exports.ListItem=ListItem;Object.defineProperty(exports,"__esModule",{value:true});exports.default=ListItem;},{"babel-runtime/helpers/classCallCheck":21,"babel-runtime/helpers/createClass":22}],200:[function(_dereq_,module,exports){"use strict";var _from=_dereq_("babel-runtime/core-js/array/from");var _from2=_interopRequireDefault(_from);function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj};}var log=_dereq_("loglevel");function prepareLine(prefix,args){return[prefix].concat((0,_from2.default)(args));}Object.defineProperty(exports,"__esModule",{value:true});exports.default={setLevel:function setLevel(level){log.setLevel(level);},trace:function trace(){for(var _len=arguments.length,args=Array(_len),_key=0;_key<_len;_key++){args[_key]=arguments[_key];}log.trace.apply(null,prepareLine('Sync T:',args));},debug:function debug(){for(var _len2=arguments.length,args=Array(_len2),_key2=0;_key2<_len2;_key2++){args[_key2]=arguments[_key2];}log.debug.apply(null,prepareLine('Sync D:',args));},info:function info(){for(var _len3=arguments.length,args=Array(_len3),_key3=0;_key3<_len3;_key3++){args[_key3]=arguments[_key3];}log.info.apply(null,prepareLine('Sync I:',args));},warn:function warn(){for(var _len4=arguments.length,args=Array(_len4),_key4=0;_key4<_len4;_key4++){args[_key4]=arguments[_key4];}log.warn.apply(null,prepareLine('Sync W:',args));},error:function error(){for(var _len5=arguments.length,args=Array(_len5),_key5=0;_key5<_len5;_key5++){args[_key5]=arguments[_key5];}log.error.apply(null,prepareLine('Sync E:',args));}};},{"babel-runtime/core-js/array/from":1,"loglevel":172}],201:[function(_dereq_,module,exports){"use strict";/**
 * @class
 * @classdesc Map item
 * Represents a data for each element in a collection
 * @alias MapItem
 * @property {String} key  - identifier of an item
 * @property {Object} value - value of an item
 */var _classCallCheck2=_dereq_("babel-runtime/helpers/classCallCheck");var _classCallCheck3=_interopRequireDefault(_classCallCheck2);var _createClass2=_dereq_("babel-runtime/helpers/createClass");var _createClass3=_interopRequireDefault(_createClass2);function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj};}var MapItem=function(){/**
   * @private
   * @constructor
   * @param {Object} data Item descriptor
   * @param {String} data.key Item identifier
   * @param {String} data.uri Item URI
   * @param {Object} data.value Item data
   */function MapItem(data){(0,_classCallCheck3.default)(this,MapItem);this.data=data;}(0,_createClass3.default)(MapItem,[{key:"update",/**
     * Update item data
     * @param {Number} EventId Update event id
     * @param {String} Revision Updated item revision
     * @param {Object} Value Updated item data
     * @private
     */value:function update(eventId,revision,value){this.data.lastEventId=eventId;this.data.revision=revision;this.data.value=value;return this;}},{key:"uri",get:function get(){return this.data.uri;}},{key:"revision",get:function get(){return this.data.revision;}},{key:"lastEventId",get:function get(){return this.data.lastEventId;}},{key:"key",get:function get(){return this.data.key;}},{key:"value",get:function get(){return this.data.value;}}]);return MapItem;}();exports.MapItem=MapItem;Object.defineProperty(exports,"__esModule",{value:true});exports.default=MapItem;},{"babel-runtime/helpers/classCallCheck":21,"babel-runtime/helpers/createClass":22}],202:[function(_dereq_,module,exports){"use strict";var _stringify=_dereq_("babel-runtime/core-js/json/stringify");var _stringify2=_interopRequireDefault(_stringify);var _classCallCheck2=_dereq_("babel-runtime/helpers/classCallCheck");var _classCallCheck3=_interopRequireDefault(_classCallCheck2);var _createClass2=_dereq_("babel-runtime/helpers/createClass");var _createClass3=_interopRequireDefault(_createClass2);function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj};}var uuid=_dereq_("uuid");var logger_1=_dereq_("./logger");var syncerror_1=_dereq_("./syncerror");function mapTransportError(transportError){if(transportError.status===429){throw new syncerror_1.SyncError(transportError.body.message,429);}else{throw transportError;}}/**
 * @classdesc Incapsulates network operations to make it possible to add some optimization/caching strategies
 */var Network=function(){function Network(productId,clientInfo,config,transport){(0,_classCallCheck3.default)(this,Network);this.productId=productId;this.clientInfo=clientInfo;this.config=config;this.transport=transport;}(0,_createClass3.default)(Network,[{key:"createHeaders",value:function createHeaders(){return{'Content-Type':'application/json','Twilio-Sync-Client-Info':(0,_stringify2.default)(this.clientInfo),'Twilio-Request-Id':'RQ'+uuid.v4().replace(/-/g,''),'X-Twilio-Product-Id':this.productId,'X-Twilio-Token':this.config.token};}/**
         * Make a GET request by given URI
         * @Returns Promise<Response> Result of successful get request
         */},{key:"get",value:function get(uri){var headers=this.createHeaders();logger_1.default.debug('GET',uri,'ID:',headers['Twilio-Request-Id']);return this.transport.get(uri,headers).catch(mapTransportError);}},{key:"post",value:function post(uri,body,revision,twilsockOnly){var headers=this.createHeaders();if(typeof revision!=='undefined'){headers['If-Match']=revision;}logger_1.default.debug('POST',uri,'ID:',headers['Twilio-Request-Id']);return this.transport.post(uri,headers,body,twilsockOnly).catch(mapTransportError);}},{key:"put",value:function put(uri,body,revision){var headers=this.createHeaders();if(typeof revision!=='undefined'){headers['If-Match']=revision;}logger_1.default.debug('PUT',uri,'ID:',headers['Twilio-Request-Id']);return this.transport.put(uri,headers,body).catch(mapTransportError);}},{key:"delete",value:function _delete(uri){var headers=this.createHeaders();logger_1.default.debug('DELETE',uri,'ID:',headers['Twilio-Request-Id']);return this.transport.delete(uri,headers).catch(mapTransportError);}}]);return Network;}();exports.Network=Network;Object.defineProperty(exports,"__esModule",{value:true});exports.default=Network;},{"./logger":200,"./syncerror":208,"babel-runtime/core-js/json/stringify":4,"babel-runtime/helpers/classCallCheck":21,"babel-runtime/helpers/createClass":22,"uuid":224}],203:[function(_dereq_,module,exports){"use strict";var _regenerator=_dereq_("babel-runtime/regenerator");var _regenerator2=_interopRequireDefault(_regenerator);var _classCallCheck2=_dereq_("babel-runtime/helpers/classCallCheck");var _classCallCheck3=_interopRequireDefault(_classCallCheck2);var _createClass2=_dereq_("babel-runtime/helpers/createClass");var _createClass3=_interopRequireDefault(_createClass2);var _promise=_dereq_("babel-runtime/core-js/promise");var _promise2=_interopRequireDefault(_promise);function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj};}var __awaiter=undefined&&undefined.__awaiter||function(thisArg,_arguments,P,generator){return new(P||(P=_promise2.default))(function(resolve,reject){function fulfilled(value){try{step(generator.next(value));}catch(e){reject(e);}}function rejected(value){try{step(generator["throw"](value));}catch(e){reject(e);}}function step(result){result.done?resolve(result.value):new P(function(resolve){resolve(result.value);}).then(fulfilled,rejected);}step((generator=generator.apply(thisArg,_arguments||[])).next());});};/**
 * @class Paginator
 * @classdesc Pagination helper class
 *
 * @property {Array} items Array of elements on current page
 * @property {boolean} hasNextPage Indicates the existence of next page
 * @property {boolean} hasPrevPage Indicates the existence of previous page
 */var Paginator=function(){/*
    * @constructor
    * @param {Array} items Array of element for current page
    * @param {Object} params
    * @private
    */function Paginator(items,source,prevToken,nextToken){(0,_classCallCheck3.default)(this,Paginator);this.prevToken=prevToken;this.nextToken=nextToken;this.items=items;this.source=source;}(0,_createClass3.default)(Paginator,[{key:"nextPage",/**
         * Request next page.
         * Does not modify existing object
         * @return {Promise<Paginator>}
         */value:function nextPage(){return __awaiter(this,void 0,void 0,_regenerator2.default.mark(function _callee(){return _regenerator2.default.wrap(function _callee$(_context){while(1){switch(_context.prev=_context.next){case 0:if(this.hasNextPage){_context.next=2;break;}throw new Error('No next page');case 2:return _context.abrupt("return",this.source(this.nextToken));case 3:case"end":return _context.stop();}}},_callee,this);}));}/**
         * Request previous page.
         * Does not modify existing object
         * @return {Promise<Paginator>}
         */},{key:"prevPage",value:function prevPage(){return __awaiter(this,void 0,void 0,_regenerator2.default.mark(function _callee2(){return _regenerator2.default.wrap(function _callee2$(_context2){while(1){switch(_context2.prev=_context2.next){case 0:if(this.hasPrevPage){_context2.next=2;break;}throw new Error('No previous page');case 2:return _context2.abrupt("return",this.source(this.prevToken));case 3:case"end":return _context2.stop();}}},_callee2,this);}));}},{key:"hasNextPage",get:function get(){return!!this.nextToken;}},{key:"hasPrevPage",get:function get(){return!!this.prevToken;}}]);return Paginator;}();exports.Paginator=Paginator;Object.defineProperty(exports,"__esModule",{value:true});exports.default=Paginator;},{"babel-runtime/core-js/promise":15,"babel-runtime/helpers/classCallCheck":21,"babel-runtime/helpers/createClass":22,"babel-runtime/regenerator":28}],204:[function(_dereq_,module,exports){"use strict";var _freeze=_dereq_("babel-runtime/core-js/object/freeze");var _freeze2=_interopRequireDefault(_freeze);var _promise=_dereq_("babel-runtime/core-js/promise");var _promise2=_interopRequireDefault(_promise);var _classCallCheck2=_dereq_("babel-runtime/helpers/classCallCheck");var _classCallCheck3=_interopRequireDefault(_classCallCheck2);var _createClass2=_dereq_("babel-runtime/helpers/createClass");var _createClass3=_interopRequireDefault(_createClass2);function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj};}var RetryingQueue=function(){function RetryingQueue(){(0,_classCallCheck3.default)(this,RetryingQueue);this.queue=new Array();this.isActive=false;}(0,_createClass3.default)(RetryingQueue,[{key:"wakeupQueue",value:function wakeupQueue(){var _this=this;if(!this.isActive&&this.queue.length>0){this.isActive=true;setTimeout(function(){return _this.executeTask(_this.queue[0]);},0);}}},{key:"pickNext",value:function pickNext(){var _this2=this;this.queue.shift();if(this.queue.length===0){this.isActive=false;return;}setTimeout(function(){return _this2.executeTask(_this2.queue[0]);},0);}},{key:"pickSame",value:function pickSame(arg){var _this3=this;this.queue[0].arg=arg;setTimeout(function(){return _this3.executeTask(_this3.queue[0]);},0);}},{key:"executeTask",value:function executeTask(task){var _this4=this;task.task(task.context,task.arg).then(function(result){_this4.pickNext();task.resolve(result);}).catch(function(error){try{if(task.handle){task.handle(error).then(function(result){return _this4.pickSame(result);}).catch(task.reject);}else{throw error;}}catch(e){task.reject(error);}});}},{key:"add",value:function add(task,context,arg,errorHandler){var _this5=this;return new _promise2.default(function(resolve,reject){_this5.queue.push({task:task,context:context,arg:arg,handle:errorHandler,resolve:resolve,reject:reject});_this5.wakeupQueue();});}}]);return RetryingQueue;}();exports.RetryingQueue=RetryingQueue;(0,_freeze2.default)(RetryingQueue);Object.defineProperty(exports,"__esModule",{value:true});exports.default=RetryingQueue;},{"babel-runtime/core-js/object/freeze":11,"babel-runtime/core-js/promise":15,"babel-runtime/helpers/classCallCheck":21,"babel-runtime/helpers/createClass":22}],205:[function(_dereq_,module,exports){"use strict";var _regenerator=_dereq_("babel-runtime/regenerator");var _regenerator2=_interopRequireDefault(_regenerator);var _classCallCheck2=_dereq_("babel-runtime/helpers/classCallCheck");var _classCallCheck3=_interopRequireDefault(_classCallCheck2);var _createClass2=_dereq_("babel-runtime/helpers/createClass");var _createClass3=_interopRequireDefault(_createClass2);var _promise=_dereq_("babel-runtime/core-js/promise");var _promise2=_interopRequireDefault(_promise);function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj};}var __awaiter=undefined&&undefined.__awaiter||function(thisArg,_arguments,P,generator){return new(P||(P=_promise2.default))(function(resolve,reject){function fulfilled(value){try{step(generator.next(value));}catch(e){reject(e);}}function rejected(value){try{step(generator["throw"](value));}catch(e){reject(e);}}function step(result){result.done?resolve(result.value):new P(function(resolve){resolve(result.value);}).then(fulfilled,rejected);}step((generator=generator.apply(thisArg,_arguments||[])).next());});};var logger_1=_dereq_("./logger");var SYNC_DOCUMENT_NOTIFICATION_TYPE='com.twilio.rtd.cds.document';var SYNC_LIST_NOTIFICATION_TYPE='com.twilio.rtd.cds.list';var SYNC_MAP_NOTIFICATION_TYPE='com.twilio.rtd.cds.map';var SYNC_NOTIFICATION_TYPE='twilio.sync.event';/**
 * @class Router
 * @classdesc Routes all incoming messages to the consumers
 */var Router=function(){function Router(params){var _this=this;(0,_classCallCheck3.default)(this,Router);this.config=params.config;this.subscriptions=params.subscriptions;this.notifications=params.notifications;this.notifications.subscribe(SYNC_NOTIFICATION_TYPE);this.notifications.subscribe(SYNC_DOCUMENT_NOTIFICATION_TYPE);this.notifications.subscribe(SYNC_LIST_NOTIFICATION_TYPE);this.notifications.subscribe(SYNC_MAP_NOTIFICATION_TYPE);this.notifications.on('message',function(messageType,payload){return _this.onMessage(messageType,payload);});this.notifications.on('transportReady',function(state){if(state){_this.onConnected();}});}/**
     * Entry point for all incoming messages
     * @param {String} type - Type of incoming message
     * @param {Object} message - Message to route
     */(0,_createClass3.default)(Router,[{key:"onMessage",value:function onMessage(type,message){switch(type){case SYNC_DOCUMENT_NOTIFICATION_TYPE:case SYNC_LIST_NOTIFICATION_TYPE:case SYNC_MAP_NOTIFICATION_TYPE:case SYNC_NOTIFICATION_TYPE:logger_1.default.trace('Notification type:',type,'content:',message);this.subscriptions.acceptMessage(message);}}/**
         * Subscribe for events
         */},{key:"subscribe",value:function subscribe(sid,entity){return __awaiter(this,void 0,void 0,_regenerator2.default.mark(function _callee(){return _regenerator2.default.wrap(function _callee$(_context){while(1){switch(_context.prev=_context.next){case 0:_context.next=2;return this.subscriptions.add(sid,entity);case 2:case"end":return _context.stop();}}},_callee,this);}));}/**
         * Unsubscribe from events
         */},{key:"unsubscribe",value:function unsubscribe(sid,entity){return __awaiter(this,void 0,void 0,_regenerator2.default.mark(function _callee2(){return _regenerator2.default.wrap(function _callee2$(_context2){while(1){switch(_context2.prev=_context2.next){case 0:_context2.next=2;return this.subscriptions.remove(sid);case 2:case"end":return _context2.stop();}}},_callee2,this);}));}/**
         * Handle transport establishing event
         * If we have any subscriptions - we should check object for modifications
         */},{key:"onConnected",value:function onConnected(){this.subscriptions.poke();}}]);return Router;}();exports.Router=Router;Object.defineProperty(exports,"__esModule",{value:true});exports.default=Router;},{"./logger":200,"babel-runtime/core-js/promise":15,"babel-runtime/helpers/classCallCheck":21,"babel-runtime/helpers/createClass":22,"babel-runtime/regenerator":28}],206:[function(_dereq_,module,exports){"use strict";var _regenerator=_dereq_("babel-runtime/regenerator");var _regenerator2=_interopRequireDefault(_regenerator);var _slicedToArray2=_dereq_("babel-runtime/helpers/slicedToArray");var _slicedToArray3=_interopRequireDefault(_slicedToArray2);var _getIterator2=_dereq_("babel-runtime/core-js/get-iterator");var _getIterator3=_interopRequireDefault(_getIterator2);var _extends2=_dereq_("babel-runtime/helpers/extends");var _extends3=_interopRequireDefault(_extends2);var _map=_dereq_("babel-runtime/core-js/map");var _map2=_interopRequireDefault(_map);var _classCallCheck2=_dereq_("babel-runtime/helpers/classCallCheck");var _classCallCheck3=_interopRequireDefault(_classCallCheck2);var _createClass2=_dereq_("babel-runtime/helpers/createClass");var _createClass3=_interopRequireDefault(_createClass2);var _promise=_dereq_("babel-runtime/core-js/promise");var _promise2=_interopRequireDefault(_promise);function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj};}var __awaiter=undefined&&undefined.__awaiter||function(thisArg,_arguments,P,generator){return new(P||(P=_promise2.default))(function(resolve,reject){function fulfilled(value){try{step(generator.next(value));}catch(e){reject(e);}}function rejected(value){try{step(generator["throw"](value));}catch(e){reject(e);}}function step(result){result.done?resolve(result.value):new P(function(resolve){resolve(result.value);}).then(fulfilled,rejected);}step((generator=generator.apply(thisArg,_arguments||[])).next());});};/* eslint-disable key-spacing */var Backoff=_dereq_("backoff");var logger_1=_dereq_("./logger");var syncerror_1=_dereq_("./syncerror");var twilio_transport_1=_dereq_("twilio-transport");var MAX_BATCH_SIZE=1000;/**
 * A data container used by the Subscriptions class to track subscribed entities' local
 * representations and their state.
 */var SubscribedEntity=function(){function SubscribedEntity(entity){(0,_classCallCheck3.default)(this,SubscribedEntity);this.localObject=entity;this.correlationId=null;}(0,_createClass3.default)(SubscribedEntity,[{key:"markAsFailed",value:function markAsFailed(error){if(this.pendingPokeTimer){clearTimeout(this.pendingPokeTimer);}this.rejectedWithError=error;}},{key:"sid",get:function get(){return this.localObject.sid;}},{key:"type",get:function get(){return this.localObject.type;}},{key:"lastEventId",get:function get(){return this.localObject.lastEventId;}},{key:"isInTransition",get:function get(){return this.correlationId!==null;}}]);return SubscribedEntity;}();/**
 * @class Subscriptions
 * @classdesc A manager which, in batches of varying size, continuously persists the
 *      subscription intent of the caller to the Sync backend until it achieves a
 *      converged state.
 */var Subscriptions=function(){/**
     * @constructor
     * Prepares a new Subscriptions manager object with zero subscribed or persisted subscriptions.
     *
     * @param {object} config may include a key 'backoffConfig', wherein any of the parameters
     *      of Backoff.exponential (from npm 'backoff') are valid and will override the defaults.
     *
     * @param {Network} must be a viable running Sync Network object, useful for routing requests.
     */function Subscriptions(services){var _this=this;(0,_classCallCheck3.default)(this,Subscriptions);this.services=services;this.subscriptions=new _map2.default();this.persisted=new _map2.default();var defaultBackoffConfig={randomisationFactor:0.2,initialDelay:100,maxDelay:2*60*1000};this.backoff=Backoff.exponential((0,_extends3.default)(defaultBackoffConfig,this.services.config.backoffConfig));// This block is triggered by #_persist. Every request is executed in a series of (ideally 1)
// backoff 'ready' event, at which point a new subscription set is calculated.
this.backoff.on('ready',function(){var _getSubscriptionUpdat=_this.getSubscriptionUpdateBatch(),action=_getSubscriptionUpdat.action,subscriptionRequests=_getSubscriptionUpdat.subscriptions;if(action){_this.applyNewSubscriptionUpdateBatch(action,subscriptionRequests);}else{_this.backoff.reset();logger_1.default.info('All subscriptions resolved.');}});}(0,_createClass3.default)(Subscriptions,[{key:"getSubscriptionUpdateBatch",value:function getSubscriptionUpdateBatch(){function substract(these,those,ignoreCurrentOp,limit){var result=[];var _iteratorNormalCompletion=true;var _didIteratorError=false;var _iteratorError=undefined;try{for(var _iterator=(0,_getIterator3.default)(these),_step;!(_iteratorNormalCompletion=(_step=_iterator.next()).done);_iteratorNormalCompletion=true){var _step$value=(0,_slicedToArray3.default)(_step.value,2),thisKey=_step$value[0],thisValue=_step$value[1];var otherValue=those.get(thisKey);if(!otherValue&&(ignoreCurrentOp||!thisValue.isInTransition)&&!thisValue.rejectedWithError){result.push(thisValue);if(limit&&result.length>=limit){break;}}}}catch(err){_didIteratorError=true;_iteratorError=err;}finally{try{if(!_iteratorNormalCompletion&&_iterator.return){_iterator.return();}}finally{if(_didIteratorError){throw _iteratorError;}}}return result;}var listToAdd=substract(this.subscriptions,this.persisted,false,MAX_BATCH_SIZE).map(function(x){return new SubscribedEntity(x);});if(listToAdd.length>0){return{action:'establish',subscriptions:listToAdd};}var listToRemove=substract(this.persisted,this.subscriptions,true,MAX_BATCH_SIZE);if(listToRemove.length>0){return{action:'cancel',subscriptions:listToRemove};}return{action:null,subscriptions:null};}},{key:"persist",value:function persist(){try{this.backoff.backoff();}catch(e){}// eslint-disable-line no-empty
}},{key:"applyNewSubscriptionUpdateBatch",value:function applyNewSubscriptionUpdateBatch(action,requests){return __awaiter(this,void 0,void 0,_regenerator2.default.mark(function _callee(){var correlationId,_iteratorNormalCompletion2,_didIteratorError2,_iteratorError2,_iterator2,_step2,_subscribed,response,_iteratorNormalCompletion3,_didIteratorError3,_iteratorError3,_iterator3,_step3,subscribed,_iteratorNormalCompletion4,_didIteratorError4,_iteratorError4,_iterator4,_step4,attemptedSubscription;return _regenerator2.default.wrap(function _callee$(_context){while(1){switch(_context.prev=_context.next){case 0:// Keeping in mind that events may begin flowing _before_ we receive the response
requests=this.processLocalActions(action,requests);correlationId=new Date().getTime();_iteratorNormalCompletion2=true;_didIteratorError2=false;_iteratorError2=undefined;_context.prev=5;for(_iterator2=(0,_getIterator3.default)(requests);!(_iteratorNormalCompletion2=(_step2=_iterator2.next()).done);_iteratorNormalCompletion2=true){_subscribed=_step2.value;this.recordActionAttemptOn(_subscribed,action,correlationId);}// Send this batch to the service
_context.next=13;break;case 9:_context.prev=9;_context.t0=_context["catch"](5);_didIteratorError2=true;_iteratorError2=_context.t0;case 13:_context.prev=13;_context.prev=14;if(!_iteratorNormalCompletion2&&_iterator2.return){_iterator2.return();}case 16:_context.prev=16;if(!_didIteratorError2){_context.next=19;break;}throw _iteratorError2;case 19:return _context.finish(16);case 20:return _context.finish(13);case 21:_context.prev=21;_context.next=24;return this.request(action,correlationId,requests.map(function(object){return{object_sid:object.sid,object_type:object.type,last_event_id:action==='establish'?object.lastEventId:undefined// eslint-disable-line no-undefined, camelcase
};}));case 24:response=_context.sent;if(!(action==='establish')){_context.next=45;break;}_iteratorNormalCompletion3=true;_didIteratorError3=false;_iteratorError3=undefined;_context.prev=29;for(_iterator3=(0,_getIterator3.default)(requests);!(_iteratorNormalCompletion3=(_step3=_iterator3.next()).done);_iteratorNormalCompletion3=true){subscribed=_step3.value;if(subscribed.correlationId===correlationId){this.beginReplayTimeout(response.body.estimated_delivery_in_ms,subscribed,action,correlationId);}}_context.next=37;break;case 33:_context.prev=33;_context.t1=_context["catch"](29);_didIteratorError3=true;_iteratorError3=_context.t1;case 37:_context.prev=37;_context.prev=38;if(!_iteratorNormalCompletion3&&_iterator3.return){_iterator3.return();}case 40:_context.prev=40;if(!_didIteratorError3){_context.next=43;break;}throw _iteratorError3;case 43:return _context.finish(40);case 44:return _context.finish(37);case 45:this.backoff.reset();_context.next=70;break;case 48:_context.prev=48;_context.t2=_context["catch"](21);_iteratorNormalCompletion4=true;_didIteratorError4=false;_iteratorError4=undefined;_context.prev=53;for(_iterator4=(0,_getIterator3.default)(requests);!(_iteratorNormalCompletion4=(_step4=_iterator4.next()).done);_iteratorNormalCompletion4=true){attemptedSubscription=_step4.value;this.recordActionFailureOn(attemptedSubscription,action);}_context.next=61;break;case 57:_context.prev=57;_context.t3=_context["catch"](53);_didIteratorError4=true;_iteratorError4=_context.t3;case 61:_context.prev=61;_context.prev=62;if(!_iteratorNormalCompletion4&&_iterator4.return){_iterator4.return();}case 64:_context.prev=64;if(!_didIteratorError4){_context.next=67;break;}throw _iteratorError4;case 67:return _context.finish(64);case 68:return _context.finish(61);case 69:if(_context.t2 instanceof twilio_transport_1.TwilsockUnavailableError){logger_1.default.debug("Twilsock connection (required for subscription) not ready (c:"+correlationId+"); waiting\u2026");this.backoff.reset();}else{logger_1.default.debug("Failed an attempt to "+action+" subscriptions (c:"+correlationId+"); retrying",_context.t2);this.persist();}case 70:case"end":return _context.stop();}}},_callee,this,[[5,9,13,21],[14,,16,20],[21,48],[29,33,37,45],[38,,40,44],[53,57,61,69],[62,,64,68]]);}));}},{key:"processLocalActions",value:function processLocalActions(action,requests){if(action==='cancel'){return requests.filter(function(request){return!request.rejectedWithError;});}return requests;}},{key:"recordActionAttemptOn",value:function recordActionAttemptOn(attemptedSubscription,action,correlationId){if(action==='establish'){this.persisted.set(attemptedSubscription.sid,attemptedSubscription);attemptedSubscription.correlationId=correlationId;}else{var persistedSubscription=this.persisted.get(attemptedSubscription.sid);if(persistedSubscription){persistedSubscription.correlationId=correlationId;}}}},{key:"recordActionFailureOn",value:function recordActionFailureOn(attemptedSubscription,action){attemptedSubscription.correlationId=null;if(action==='establish'){this.persisted.delete(attemptedSubscription.sid);}}},{key:"request",value:function request(action,correlationId,requests){logger_1.default.debug("Attempting '"+action+"' request (c:"+correlationId+"):",requests);/* eslint-disable camelcase */var requestBody={event_protocol_version:3,action:action,correlation_id:correlationId,requests:requests};/* eslint-enable camelcase */return this.services.network.post(this.services.config.subscriptionsUri,requestBody,null,true);}},{key:"beginReplayTimeout",value:function beginReplayTimeout(timeout,subscription,action,failingCorrelationId){var _this2=this;var isNumeric=!isNaN(parseFloat(timeout))&&isFinite(timeout);var isValidTimeout=isNumeric&&timeout>0;if(isValidTimeout){subscription.pendingPokeTimer=setTimeout(function(){if(subscription.correlationId===failingCorrelationId){logger_1.default.debug("Attempt to "+action+" "+subscription.sid+" (c:"+failingCorrelationId+") timed out without confirmation; trying again.");subscription.correlationId=null;_this2.persisted.delete(subscription.sid);_this2.persist();}},timeout);}}/**
         * Establishes intent to be subscribed to this entity. That subscription will be effected
         * asynchronously.
         * If subscription to the given sid already exists, it will be overwritten.
         *
         * @param {string} sid should be a well-formed SID, uniquely identifying a single instance of a Sync entity.
         * @param {object} entity should represent the (singular) local representation of this entity.
         *      Incoming events and modifications to the entity will be directed at the _update() function
         *      of this provided reference.
         *
         * @return undefined
         */},{key:"add",value:function add(sid,entity){logger_1.default.debug("Establishing intent to subscribe to "+sid);var existingSubscription=this.subscriptions.get(sid);if(existingSubscription&&existingSubscription.lastEventId===entity.lastEventId){// If last event id is the same as before - we're fine
return;}this.persisted.delete(sid);this.subscriptions.set(sid,entity);this.persist();}/**
         * Establishes the caller's intent to no longer be subscribed to this entity. Following this
         * call, no further events shall be routed to the local representation of the entity, even
         * though a server-side subscription may take more time to actually terminate.
         *
         * @param {string} sid should be any well-formed SID, uniquely identifying a Sync entity.
         *      This call only has meaningful effect if that entity is subscribed at the
         *      time of call. Otherwise does nothing.
         *
         * @return undefined
         */},{key:"remove",value:function remove(sid){logger_1.default.debug("Establishing intent to unsubscribe from "+sid);var removed=this.subscriptions.delete(sid);if(removed){this.persist();}}/**
         * The point of ingestion for remote incoming messages (e.g. new data was written to a map
         * to which we are subscribed).
         *
         * @param {object} message is the full, unaltered body of the incoming notification.
         *
         * @return undefined
         */},{key:"acceptMessage",value:function acceptMessage(message){logger_1.default.trace('Subscriptions received',message);switch(message.event_type){case'subscription_established':this.applySubscriptionEstablishedMessage(message.event,message.correlation_id);break;case'subscription_canceled':this.applySubscriptionCancelledMessage(message.event,message.correlation_id);break;case'subscription_failed':this.applySubscriptionFailedMessage(message.event,message.correlation_id);break;case(message.event_type.match(/^(?:map|list|document)_/)||{}).input:{var typedSid=function typedSid(){if(message.event_type.match(/^map_/))return message.event.map_sid;else if(message.event_type.match(/^list_/))return message.event.list_sid;else if(message.event_type.match(/^document_/))return message.event.document_sid;else return undefined;// eslint-disable-line no-undefined
};;this.applyEventToSubscribedEntity(typedSid(),message);}break;default:logger_1.default.debug("Dropping unknown message type "+message.event_type);break;}}},{key:"applySubscriptionEstablishedMessage",value:function applySubscriptionEstablishedMessage(message,correlationId){var sid=message.object_sid;var subscriptionIntent=this.persisted.get(message.object_sid);if(subscriptionIntent&&subscriptionIntent.correlationId===correlationId){if(message.replay_status==='interrupted'){logger_1.default.debug("Event Replay for subscription to "+sid+" (c:"+correlationId+") interrupted; continuing eagerly.");clearTimeout(subscriptionIntent.pendingPokeTimer);subscriptionIntent.pendingPokeTimer=null;subscriptionIntent.correlationId=null;this.persisted.delete(subscriptionIntent.sid);this.backoff.reset();}else if(message.replay_status==='completed'){logger_1.default.debug("Event Replay for subscription to "+sid+" (c:"+correlationId+") completed. Subscription is ready.");clearTimeout(subscriptionIntent.pendingPokeTimer);subscriptionIntent.pendingPokeTimer=null;subscriptionIntent.correlationId=null;this.persisted.set(message.object_sid,subscriptionIntent);this.backoff.reset();}}else{logger_1.default.debug("Late message for "+message.object_sid+" (c:"+correlationId+") dropped.");}this.persist();}},{key:"applySubscriptionCancelledMessage",value:function applySubscriptionCancelledMessage(message,correlationId){var persistedSubscription=this.persisted.get(message.object_sid);if(persistedSubscription&&persistedSubscription.correlationId===correlationId){clearTimeout(persistedSubscription.pendingPokeTimer);persistedSubscription.pendingPokeTimer=null;persistedSubscription.correlationId=null;this.persisted.delete(message.object_sid);}else{logger_1.default.debug("Late message for "+message.object_sid+" (c:"+correlationId+") dropped.");}this.persist();}},{key:"applySubscriptionFailedMessage",value:function applySubscriptionFailedMessage(message,correlationId){var sid=message.object_sid;var subscriptionIntent=this.subscriptions.get(sid);var subscription=this.persisted.get(sid);if(subscriptionIntent&&subscription){if(subscription.correlationId===correlationId){subscription.markAsFailed(message.error);logger_1.default.error("Failed to subscribe on "+subscription.sid,message.error);subscriptionIntent.reportFailure(new syncerror_1.SyncError('Failed to subscribe on service events: '+message.error.message,message.error.status));}}else if(!subscriptionIntent&&subscription){this.persisted.delete(sid);}this.persist();}},{key:"applyEventToSubscribedEntity",value:function applyEventToSubscribedEntity(sid,message){var subscriptionIntent=sid?this.subscriptions.get(sid):null;if(subscriptionIntent){message.event.type=message.event_type;subscriptionIntent._update(message.event);}else{logger_1.default.debug("Message dropped for SID '"+sid+"', for which there is no subscription.");}}/**
         * Prompts a playback of any missed changes made to any subscribed object. This method
         * should be invoked whenever the connectivity layer has experienced cross-cutting
         * delivery failures that would affect the entire local sync set. Any tangible result
         * of this operation will result in calls to the _update() function of subscribed
         * Sync entities.
         */},{key:"poke",value:function poke(){logger_1.default.info('Triggering event replay for all subscriptions.');var failedSubscriptions=[];var _iteratorNormalCompletion5=true;var _didIteratorError5=false;var _iteratorError5=undefined;try{for(var _iterator5=(0,_getIterator3.default)(this.persisted),_step5;!(_iteratorNormalCompletion5=(_step5=_iterator5.next()).done);_iteratorNormalCompletion5=true){var _step5$value=(0,_slicedToArray3.default)(_step5.value,2),_=_step5$value[0],it=_step5$value[1];clearTimeout(it.pendingPokeTimer);it.pendingPokeTimer=null;it.correlationId=null;if(it.rejectedWithError){failedSubscriptions.push(it);}}}catch(err){_didIteratorError5=true;_iteratorError5=err;}finally{try{if(!_iteratorNormalCompletion5&&_iterator5.return){_iterator5.return();}}finally{if(_didIteratorError5){throw _iteratorError5;}}}this.persisted.clear();var _iteratorNormalCompletion6=true;var _didIteratorError6=false;var _iteratorError6=undefined;try{for(var _iterator6=(0,_getIterator3.default)(failedSubscriptions),_step6;!(_iteratorNormalCompletion6=(_step6=_iterator6.next()).done);_iteratorNormalCompletion6=true){var it=_step6.value;this.persisted.set(it.sid,it);}}catch(err){_didIteratorError6=true;_iteratorError6=err;}finally{try{if(!_iteratorNormalCompletion6&&_iterator6.return){_iterator6.return();}}finally{if(_didIteratorError6){throw _iteratorError6;}}}this.persist();}/**
         * Stops all communication, clears any subscription intent, and returns.
         */},{key:"shutdown",value:function shutdown(){this.backoff.reset();this.subscriptions.clear();}}]);return Subscriptions;}();exports.Subscriptions=Subscriptions;Object.defineProperty(exports,"__esModule",{value:true});exports.default=Subscriptions;},{"./logger":200,"./syncerror":208,"babel-runtime/core-js/get-iterator":2,"babel-runtime/core-js/map":5,"babel-runtime/core-js/promise":15,"babel-runtime/helpers/classCallCheck":21,"babel-runtime/helpers/createClass":22,"babel-runtime/helpers/extends":23,"babel-runtime/helpers/slicedToArray":26,"babel-runtime/regenerator":28,"backoff":29,"twilio-transport":214}],207:[function(_dereq_,module,exports){"use strict";var _extends2=_dereq_("babel-runtime/helpers/extends");var _extends3=_interopRequireDefault(_extends2);var _regenerator=_dereq_("babel-runtime/regenerator");var _regenerator2=_interopRequireDefault(_regenerator);var _getPrototypeOf=_dereq_("babel-runtime/core-js/object/get-prototype-of");var _getPrototypeOf2=_interopRequireDefault(_getPrototypeOf);var _classCallCheck2=_dereq_("babel-runtime/helpers/classCallCheck");var _classCallCheck3=_interopRequireDefault(_classCallCheck2);var _createClass2=_dereq_("babel-runtime/helpers/createClass");var _createClass3=_interopRequireDefault(_createClass2);var _possibleConstructorReturn2=_dereq_("babel-runtime/helpers/possibleConstructorReturn");var _possibleConstructorReturn3=_interopRequireDefault(_possibleConstructorReturn2);var _inherits2=_dereq_("babel-runtime/helpers/inherits");var _inherits3=_interopRequireDefault(_inherits2);var _promise=_dereq_("babel-runtime/core-js/promise");var _promise2=_interopRequireDefault(_promise);function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj};}var __awaiter=undefined&&undefined.__awaiter||function(thisArg,_arguments,P,generator){return new(P||(P=_promise2.default))(function(resolve,reject){function fulfilled(value){try{step(generator.next(value));}catch(e){reject(e);}}function rejected(value){try{step(generator["throw"](value));}catch(e){reject(e);}}function step(result){result.done?resolve(result.value):new P(function(resolve){resolve(result.value);}).then(fulfilled,rejected);}step((generator=generator.apply(thisArg,_arguments||[])).next());});};var logger_1=_dereq_("./logger");var entity_1=_dereq_("./entity");var rfc6902_1=_dereq_("rfc6902");var retryingqueue_1=_dereq_("./retryingqueue");/**
 * @class
 * @alias Document
 * @classdesc
 * Primitive to store a single document in DataSync service
 * @property {String} sid SyncDocument unique id
 * @property {String} uniqueName Unique name of a document
 * @property {Object} value Value of a document
 *
 * @fires Document#updated
 * @fires Document#updatedRemotely
 * @fires Document#removed
 * @fires Document#removedRemotely
 */var SyncDocument=function(_entity_1$SyncEntity){(0,_inherits3.default)(SyncDocument,_entity_1$SyncEntity);/**
     * @constructor
     * @private
     */function SyncDocument(services,descriptor,onRemoveDocument){(0,_classCallCheck3.default)(this,SyncDocument);var _this=(0,_possibleConstructorReturn3.default)(this,(SyncDocument.__proto__||(0,_getPrototypeOf2.default)(SyncDocument)).call(this,services));_this.actionQueue=new retryingqueue_1.RetryingQueue();_this.descriptor=descriptor;_this.onRemoveDocument=onRemoveDocument;return _this;}(0,_createClass3.default)(SyncDocument,[{key:"_update",/**
         * Update data entity with new data
         * @private
         */value:function _update(update){switch(update.type){case'document_updated':if(update.id>this.lastEventId){var originalData=this.descriptor.data;this.descriptor.last_event_id=update.id;this.descriptor.revision=update.document_revision;this.descriptor.data=update.document_data;this.traverse(originalData,update.document_data,false);this.emit('updated',update.document_data,false);this.emit('updatedRemotely',update.document_data);}break;case'document_removed':this.onRemoved(false);}}/**
         * Calculate diff between old and new data
         * @private
         */},{key:"traverse",value:function traverse(originalData,updatedData,isLocalEvent){var _this2=this;var diff=rfc6902_1.createPatch(originalData,updatedData);diff.forEach(function(row){if(row.op==='add'){_this2.emit('keyAdded',row.path,row.value,isLocalEvent);if(!isLocalEvent){_this2.emit('keyAddedRemotely',row.path,row.value);}}else if(row.op==='replace'){_this2.emit('keyUpdated',row.path,row.value,isLocalEvent);if(!isLocalEvent){_this2.emit('keyUpdatedRemotely',row.path,row.value);}}else if(row.op==='remove'){_this2.emit('keyRemoved',row.path,isLocalEvent);if(!isLocalEvent){_this2.emit('keyRemovedRemotely',row.path);}}});}/**
         * @returns {Object} Internal data of entity
         * For now use a 'value' property instead
         * @private
         */},{key:"get",value:function get(path){// return !path ? this.value : this.value(path);
return this.value;}/**
         * Set new value for the document
         * @param {Object} value New value for the document
         * @param {Boolean} [conditional=false] Check for remote modification when updating.
         * If true, promise will be rejected if value was remotely modified
         * @returns {Promise}
         */},{key:"set",value:function set(value,conditional){return this._actualSet(value,conditional?function(){throw new Error('Revision mismatch');}:null);}/**
         * @private
         */},{key:"_actualSet",value:function _actualSet(data,conflictResolver){var _this3=this;var resolver=void 0;var arg={data:data,revision:conflictResolver?this.revision:undefined};if(conflictResolver){resolver=function resolver(err){return __awaiter(_this3,void 0,void 0,_regenerator2.default.mark(function _callee(){return _regenerator2.default.wrap(function _callee$(_context){while(1){switch(_context.prev=_context.next){case 0:if(!(err.status===412)){_context.next=4;break;}_context.next=3;return this.softSync();case 3:return _context.abrupt("return",{revision:this.revision,data:conflictResolver(this.value,data)});case 4:throw err;case 5:case"end":return _context.stop();}}},_callee,this);}));};}return this.actionQueue.add(this._set.bind(this),this.uri,arg,resolver).then(function(result){_this3.descriptor.revision=result.revision;_this3.descriptor.data=result.data;_this3.emit('updated',_this3.value,true);return _this3.value;});}/**
         * @param {Document~Mutator} mutator Function to apply to current data in order to modify it.
         * Can be called multiple times if same data modified remotely at the same time.
         * @return {Promise<Object>}
         */},{key:"mutate",value:function mutate(mutator){return __awaiter(this,void 0,void 0,_regenerator2.default.mark(function _callee2(){return _regenerator2.default.wrap(function _callee2$(_context2){while(1){switch(_context2.prev=_context2.next){case 0:return _context2.abrupt("return",this._actualSet(mutator(this.value),mutator));case 1:case"end":return _context2.stop();}}},_callee2,this);}));}/**
         * @param {Object} update Set of fields to update
         * @return {Promise<Object>} Result data
         */},{key:"update",value:function update(obj){return this.mutate(function(remote){return(0,_extends3.default)(remote,obj);});}},{key:"_set",value:function _set(context,param){return __awaiter(this,void 0,void 0,_regenerator2.default.mark(function _callee3(){var response;return _regenerator2.default.wrap(function _callee3$(_context3){while(1){switch(_context3.prev=_context3.next){case 0:_context3.next=2;return this.services.network.post(this.uri,{data:param.data},param.revision);case 2:response=_context3.sent;return _context3.abrupt("return",{revision:response.body.revision,data:param.data});case 4:case"end":return _context3.stop();}}},_callee3,this);}));}/**
         * Get new data from server
         * @private
         */},{key:"softSync",value:function softSync(){var _this4=this;return this.services.network.get(this.uri).then(function(response){_this4._update({type:'document_updated',id:response.body.last_event_id,document_revision:response.body.revision,document_data:response.body.data});// eslint-disable-line camelcase
return _this4;}).catch(function(err){if(err.status===404){_this4.onRemoved(false);}else{logger_1.default.error("Can't get updates for "+_this4.sid+":",err);}});}/**
         * Get value by given path
         * @param {string} path JSON path
         * @private
         *//*
        _value(path) {
          let result;
          try {
            let pathArr = path.replace(/^\/|\/$/gm, '').split('/');
            let obj = this.data;
            pathArr.forEach((el) => { obj = obj[el]; });
            result = obj;
          } catch (e) {
            log.warn('Failed to get value:', e);
          }
          return result;
        }
        */},{key:"onRemoved",value:function onRemoved(locally){this._unsubscribe();// Should also do some cleanup here
this.emit('removed',locally);if(!locally){this.emit('removedRemotely');}}/**
         * Removes document from service
         * @return {Promise}
         * @public
         */},{key:"removeDocument",value:function removeDocument(){return __awaiter(this,void 0,void 0,_regenerator2.default.mark(function _callee4(){return _regenerator2.default.wrap(function _callee4$(_context4){while(1){switch(_context4.prev=_context4.next){case 0:this.onRemoveDocument(this.sid);_context4.next=3;return this.services.network.delete(this.uri);case 3:this.onRemoved(true);case 4:case"end":return _context4.stop();}}},_callee4,this);}));}},{key:"uri",get:function get(){return this.descriptor.url;}},{key:"revision",get:function get(){return this.descriptor.revision;}},{key:"lastEventId",get:function get(){return this.descriptor.last_event_id;}},{key:"sid",get:function get(){return this.descriptor.sid;}},{key:"value",get:function get(){return this.descriptor.data;}},{key:"uniqueName",get:function get(){return this.descriptor.unique_name||null;}},{key:"type",get:function get(){return'document';}}],[{key:"type",get:function get(){return'document';}}]);return SyncDocument;}(entity_1.SyncEntity);exports.SyncDocument=SyncDocument;Object.defineProperty(exports,"__esModule",{value:true});exports.default=SyncDocument;/**
 * Applies a transformation to the document value
 * @callback Document~Mutator
 * @param {Object} data current value
 * @return {Object} Modified value
 *//**
* Fired when document value changed
* @event Document#updated
* @type {Object}
*//**
* Fired when document value changed remotely
* @event Document#updatedRemotely
* @type {Object}
*//**
* Fired when document removed from server
* @event Document#removed
*//**
* Fired when document removed from server remotely
* @event Document#removedRemotely
*/},{"./entity":197,"./logger":200,"./retryingqueue":204,"babel-runtime/core-js/object/get-prototype-of":12,"babel-runtime/core-js/promise":15,"babel-runtime/helpers/classCallCheck":21,"babel-runtime/helpers/createClass":22,"babel-runtime/helpers/extends":23,"babel-runtime/helpers/inherits":24,"babel-runtime/helpers/possibleConstructorReturn":25,"babel-runtime/regenerator":28,"rfc6902":181}],208:[function(_dereq_,module,exports){"use strict";/**
 * Generic SyncLibrary error class
 */var _getPrototypeOf=_dereq_("babel-runtime/core-js/object/get-prototype-of");var _getPrototypeOf2=_interopRequireDefault(_getPrototypeOf);var _classCallCheck2=_dereq_("babel-runtime/helpers/classCallCheck");var _classCallCheck3=_interopRequireDefault(_classCallCheck2);var _possibleConstructorReturn2=_dereq_("babel-runtime/helpers/possibleConstructorReturn");var _possibleConstructorReturn3=_interopRequireDefault(_possibleConstructorReturn2);var _inherits2=_dereq_("babel-runtime/helpers/inherits");var _inherits3=_interopRequireDefault(_inherits2);function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj};}var SyncError=function(_Error){(0,_inherits3.default)(SyncError,_Error);function SyncError(message){var status=arguments.length>1&&arguments[1]!==undefined?arguments[1]:0;(0,_classCallCheck3.default)(this,SyncError);var _this=(0,_possibleConstructorReturn3.default)(this,(SyncError.__proto__||(0,_getPrototypeOf2.default)(SyncError)).call(this));_this.name=_this.constructor.name;_this.message=message;_this.status=status;return _this;}return SyncError;}(Error);exports.SyncError=SyncError;Object.defineProperty(exports,"__esModule",{value:true});exports.default=SyncError;},{"babel-runtime/core-js/object/get-prototype-of":12,"babel-runtime/helpers/classCallCheck":21,"babel-runtime/helpers/inherits":24,"babel-runtime/helpers/possibleConstructorReturn":25}],209:[function(_dereq_,module,exports){"use strict";var _extends2=_dereq_("babel-runtime/helpers/extends");var _extends3=_interopRequireDefault(_extends2);var _regenerator=_dereq_("babel-runtime/regenerator");var _regenerator2=_interopRequireDefault(_regenerator);var _getPrototypeOf=_dereq_("babel-runtime/core-js/object/get-prototype-of");var _getPrototypeOf2=_interopRequireDefault(_getPrototypeOf);var _classCallCheck2=_dereq_("babel-runtime/helpers/classCallCheck");var _classCallCheck3=_interopRequireDefault(_classCallCheck2);var _createClass2=_dereq_("babel-runtime/helpers/createClass");var _createClass3=_interopRequireDefault(_createClass2);var _possibleConstructorReturn2=_dereq_("babel-runtime/helpers/possibleConstructorReturn");var _possibleConstructorReturn3=_interopRequireDefault(_possibleConstructorReturn2);var _inherits2=_dereq_("babel-runtime/helpers/inherits");var _inherits3=_interopRequireDefault(_inherits2);var _promise=_dereq_("babel-runtime/core-js/promise");var _promise2=_interopRequireDefault(_promise);function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj};}var __awaiter=undefined&&undefined.__awaiter||function(thisArg,_arguments,P,generator){return new(P||(P=_promise2.default))(function(resolve,reject){function fulfilled(value){try{step(generator.next(value));}catch(e){reject(e);}}function rejected(value){try{step(generator["throw"](value));}catch(e){reject(e);}}function step(result){result.done?resolve(result.value):new P(function(resolve){resolve(result.value);}).then(fulfilled,rejected);}step((generator=generator.apply(thisArg,_arguments||[])).next());});};var utils_1=_dereq_("./utils");var logger_1=_dereq_("./logger");var entity_1=_dereq_("./entity");var retryingqueue_1=_dereq_("./retryingqueue");var listitem_1=_dereq_("./listitem");var paginator_1=_dereq_("./paginator");var cache_1=_dereq_("./cache");/**
 * @alias List
 * @classdesc List collection to store an ordered list of values
 * @property {String} sid - List unique id
 * @property {String} uniqueName - List unique name
 *
 * @fires List#itemAdded
 * @fires List#itemAddedRemotely
 * @fires List#itemUpdated
 * @fires List#itemUpdatedRemotely
 * @fires List#itemRemoved
 * @fires List#itemRemovedRemotely
 * @fires List#collectionRemoved
 * @fires List#collectionRemovedRemotely
 */var SyncList=function(_entity_1$SyncEntity){(0,_inherits3.default)(SyncList,_entity_1$SyncEntity);/**
     * @private
     */function SyncList(services,descriptor,onRemoveList){(0,_classCallCheck3.default)(this,SyncList);var _this=(0,_possibleConstructorReturn3.default)(this,(SyncList.__proto__||(0,_getPrototypeOf2.default)(SyncList)).call(this,services));_this.actionQueue=new retryingqueue_1.RetryingQueue();_this.cache=new cache_1.Cache();_this.descriptor=descriptor;_this.onRemoveList=onRemoveList;return _this;}(0,_createClass3.default)(SyncList,[{key:"__set",value:function __set(location,param){return __awaiter(this,void 0,void 0,_regenerator2.default.mark(function _callee(){var response;return _regenerator2.default.wrap(function _callee$(_context){while(1){switch(_context.prev=_context.next){case 0:_context.next=2;return this.services.network.post(location,{data:param.data},param.revision);case 2:response=_context.sent;response.body.data=param.data;return _context.abrupt("return",response.body);case 5:case"end":return _context.stop();}}},_callee,this);}));}},{key:"_set",value:function _set(item,value,resolver){return __awaiter(this,void 0,void 0,_regenerator2.default.mark(function _callee2(){var _this2=this;var result,_resolver;return _regenerator2.default.wrap(function _callee2$(_context2){while(1){switch(_context2.prev=_context2.next){case 0:if(resolver){_context2.next=5;break;}_context2.next=3;return this.services.network.post(item.uri,{data:value});case 3:result=_context2.sent;return _context2.abrupt("return",item.update(result.body.last_event_id,result.body.revision,value));case 5:_resolver=function _resolver(err){if(err.status===412){return _this2.queryEvents().then(function(){return _this2.get(item.index);}).then(function(result){return{revision:result.revision,data:resolver(result.value,value)};});}throw err;};return _context2.abrupt("return",this.actionQueue.add(this.__set.bind(this),item.uri,{revision:item.revision,data:value},_resolver).then(function(result){return item.update(result.last_event_id,result.revision,result.data);}));case 7:case"end":return _context2.stop();}}},_callee2,this);}));}/**
         * Add element to the List
         * @param {Object} value - value to add
         * @returns {Promise<Item>} A new item
         */},{key:"push",value:function push(value){return __awaiter(this,void 0,void 0,_regenerator2.default.mark(function _callee3(){var response,index,item;return _regenerator2.default.wrap(function _callee3$(_context3){while(1){switch(_context3.prev=_context3.next){case 0:_context3.next=2;return this.services.network.post(this.links.items,{data:value});case 2:response=_context3.sent;index=Number(response.body.index);item=this.cache.store(index,new listitem_1.ListItem({index:index,revision:response.body.revision,lastEventId:response.body.last_event_id,uri:response.body.url,value:value}),response.body.last_event_id);this.emit('itemAdded',item,true);return _context3.abrupt("return",item);case 7:case"end":return _context3.stop();}}},_callee3,this);}));}/**
         * Update existing item in a List
         * @param {Number} index - index in the List
         * @param {Object} value - value to set
         * If true, promise will be rejected if value was remotely modified
         * @returns {Promise<Item>} - A new element
         */},{key:"set",value:function set(index,value){return this._actualSet(index,value);}/**
         * @private
         */},{key:"_actualSet",value:function _actualSet(index,value,resolver){return __awaiter(this,void 0,void 0,_regenerator2.default.mark(function _callee4(){var item;return _regenerator2.default.wrap(function _callee4$(_context4){while(1){switch(_context4.prev=_context4.next){case 0:_context4.next=2;return this.get(index);case 2:item=_context4.sent;_context4.next=5;return this._set(item,value,resolver);case 5:item=_context4.sent;this.emit('itemUpdated',item,true);return _context4.abrupt("return",item);case 8:case"end":return _context4.stop();}}},_callee4,this);}));}/**
         * Updates the existing item value
         *
         * @param {Number} Index Item key
         * @param {List~Mutator} Mutator Function performing value mutation
         * @returns {Promise}
         */},{key:"mutate",value:function mutate(index,mutator){return __awaiter(this,void 0,void 0,_regenerator2.default.mark(function _callee5(){var item;return _regenerator2.default.wrap(function _callee5$(_context5){while(1){switch(_context5.prev=_context5.next){case 0:_context5.next=2;return this.get(index);case 2:item=_context5.sent;return _context5.abrupt("return",this._actualSet(index,mutator(item.value),mutator));case 4:case"end":return _context5.stop();}}},_callee5,this);}));}/**
         * @param {Number} Index Item key
         * @param {Object} update Set of fields to update
         * @return {Promise<Item>} Result data
         */},{key:"update",value:function update(index,obj){return __awaiter(this,void 0,void 0,_regenerator2.default.mark(function _callee6(){return _regenerator2.default.wrap(function _callee6$(_context6){while(1){switch(_context6.prev=_context6.next){case 0:return _context6.abrupt("return",this.mutate(index,function(remote){return(0,_extends3.default)(remote,obj);}));case 1:case"end":return _context6.stop();}}},_callee6,this);}));}/**
         * Remove List item by index
         * @param {Number} index - item index
         * @returns Promise to remove, which may fail
         */},{key:"remove",value:function remove(index){return __awaiter(this,void 0,void 0,_regenerator2.default.mark(function _callee7(){var item;return _regenerator2.default.wrap(function _callee7$(_context7){while(1){switch(_context7.prev=_context7.next){case 0:_context7.next=2;return this.get(index);case 2:item=_context7.sent;_context7.next=5;return this.services.network.delete(item.uri);case 5:this.cache.delete(index,item.lastEventId);this.emit('itemRemoved',index,true);case 7:case"end":return _context7.stop();}}},_callee7,this);}));}/**
         * Retrieve item by index
         * @param {Number} index - item index
         * @returns {Promise<Item>}
         */},{key:"get",value:function get(index){return __awaiter(this,void 0,void 0,_regenerator2.default.mark(function _callee8(){var cachedItem,result;return _regenerator2.default.wrap(function _callee8$(_context8){while(1){switch(_context8.prev=_context8.next){case 0:cachedItem=this.cache.get(index);if(!cachedItem){_context8.next=3;break;}return _context8.abrupt("return",cachedItem);case 3:_context8.next=5;return this.queryItems({index:index});case 5:result=_context8.sent;if(!(result.items.length<1)){_context8.next=8;break;}throw new Error('No item with index '+index+' found');case 8:return _context8.abrupt("return",this.cache.store(index,result.items[0],result.items[0].lastEventId));case 9:case"end":return _context8.stop();}}},_callee8,this);}));}/**
         * Query events from servie and apply changes to the List
         * @private
         */},{key:"queryEvents",value:function queryEvents(){return __awaiter(this,void 0,void 0,_regenerator2.default.mark(function _callee9(){var _this3=this;var uri,response;return _regenerator2.default.wrap(function _callee9$(_context9){while(1){switch(_context9.prev=_context9.next){case 0:uri=this.links.events+"?From="+(this.lastEventId+1)+"&PageSize=100";_context9.next=3;return this.services.network.get(uri);case 3:response=_context9.sent;response.body.events.forEach(function(ev){return _this3._update(ev);});case 5:case"end":return _context9.stop();}}},_callee9,this);}));}/**
         * Query items from the List
         * @private
         */},{key:"queryItems",value:function queryItems(arg){return __awaiter(this,void 0,void 0,_regenerator2.default.mark(function _callee10(){var _this4=this;var url,response,items,meta;return _regenerator2.default.wrap(function _callee10$(_context10){while(1){switch(_context10.prev=_context10.next){case 0:arg=arg||{};url=new utils_1.UriBuilder(this.links.items).arg('From',arg.from).arg('PageSize',arg.limit).arg('Index',arg.index).arg('PageToken',arg.pageToken).arg('Order',arg.order).build();_context10.next=4;return this.services.network.get(url);case 4:response=_context10.sent;items=response.body.items.map(function(el){return _this4.cache.store(Number(el.index),new listitem_1.ListItem({index:Number(el.index),uri:el.url,revision:el.revision,lastEventId:el.last_event_id,value:el.data}),el.last_event_id);});meta=response.body.meta;return _context10.abrupt("return",new paginator_1.Paginator(items,function(pageToken){return _this4.queryItems({pageToken:pageToken});},meta.previous_token,meta.next_token));case 8:case"end":return _context10.stop();}}},_callee10,this);}));}/**
         * Query items from List
         * @param {Object} args Arguments for items query
         * @param {String} args.from Item, which should be used as an anchor. If undefined, starts from the beginning or end depending on args.order
         * @param {Number} args.pageSize Results page size
         * @param {String} args.order Order of results, should be 'asc' or 'desc'
         * @returns {Promise<Paginator>}
         * @public
         */},{key:"getItems",value:function getItems(args){return __awaiter(this,void 0,void 0,_regenerator2.default.mark(function _callee11(){return _regenerator2.default.wrap(function _callee11$(_context11){while(1){switch(_context11.prev=_context11.next){case 0:args=args||{};args.limit=args.pageSize||args.limit||50;args.order=args.order||'asc';return _context11.abrupt("return",this.queryItems(args));case 4:case"end":return _context11.stop();}}},_callee11,this);}));}/**
         * @return {Promise<Object>} Context of List
         * @private
         */},{key:"getContext",value:function getContext(){return __awaiter(this,void 0,void 0,_regenerator2.default.mark(function _callee12(){var response;return _regenerator2.default.wrap(function _callee12$(_context12){while(1){switch(_context12.prev=_context12.next){case 0:if(!this.context){_context12.next=2;break;}return _context12.abrupt("return",this.context);case 2:_context12.next=4;return this.services.network.get(this.links.context);case 4:response=_context12.sent;this.context=response.body.data;return _context12.abrupt("return",this.context);case 7:case"end":return _context12.stop();}}},_callee12,this);}));}/**
         * @private
         */},{key:"updateContext",value:function updateContext(context){return __awaiter(this,void 0,void 0,_regenerator2.default.mark(function _callee13(){return _regenerator2.default.wrap(function _callee13$(_context13){while(1){switch(_context13.prev=_context13.next){case 0:_context13.prev=0;_context13.next=3;return this.services.network.post(this.links.context,{data:context});case 3:this.context=context;this.emit('contextUpdated',context,true);return _context13.abrupt("return",this);case 8:_context13.prev=8;_context13.t0=_context13["catch"](0);logger_1.default.error('Failed to update context',_context13.t0);throw _context13.t0;case 12:case"end":return _context13.stop();}}},_callee13,this,[[0,8]]);}));}/**
         * Remove list from service. It will be impossible to restore it.
         * @return {Promise} Promise to delete the collection
         * @public
         */},{key:"removeList",value:function removeList(){return __awaiter(this,void 0,void 0,_regenerator2.default.mark(function _callee14(){return _regenerator2.default.wrap(function _callee14$(_context14){while(1){switch(_context14.prev=_context14.next){case 0:this.onRemoveList(this.sid);_context14.next=3;return this.services.network.delete(this.uri);case 3:this.onRemoved(true);case 4:case"end":return _context14.stop();}}},_callee14,this);}));}},{key:"onRemoved",value:function onRemoved(locally){this._unsubscribe();// Should also do some cleanup here
this.emit('collectionRemoved',locally);if(!locally){this.emit('collectionRemovedRemotely');}}/**
         * Force to check for modifications on server
         * If there are any modifications, object will fire all appropriate callbacks
         * @private
         */},{key:"softSync",value:function softSync(){return __awaiter(this,void 0,void 0,_regenerator2.default.mark(function _callee15(){return _regenerator2.default.wrap(function _callee15$(_context15){while(1){switch(_context15.prev=_context15.next){case 0:_context15.prev=0;_context15.next=3;return this.queryEvents();case 3:_context15.next=8;break;case 5:_context15.prev=5;_context15.t0=_context15["catch"](0);if(_context15.t0.status===404){this.onRemoved(false);}else{logger_1.default.error("Can't get updates for "+this.sid+":",_context15.t0);}case 8:case"end":return _context15.stop();}}},_callee15,this,[[0,5]]);}));}},{key:"shouldIgnoreEvent",value:function shouldIgnoreEvent(key,eventId){return this.cache.isKnown(key,eventId);}/**
         * Handle update, which came from the server
         * @private
         */},{key:"_update",value:function _update(update){var itemIndex=Number(update.item_index);switch(update.type){case'list_item_added':{this._handleItemAdded(itemIndex,update.item_url,update.id,update.item_revision,update.item_data);}break;case'list_item_updated':{this._handleItemUpdated(itemIndex,update.item_url,update.id,update.item_revision,update.item_data);}break;case'list_item_removed':{this._handleItemRemoved(itemIndex,update.id);}break;case'list_context_updated':{this._handleContextUpdate(update.context_data,update.id);}break;case'list_removed':{this.onRemoved(false);}break;}if(this.lastEventId<update.id){this.descriptor.revision=update.list_revision;this.descriptor.last_event_id=update.id;}}/**
         * Handle item insertion event, coming from server
         * @private
         */},{key:"_handleItemAdded",value:function _handleItemAdded(index,uri,eventId,revision,value){if(!this.cache.isKnown(index,eventId)){var item=new listitem_1.ListItem({index:index,uri:uri,lastEventId:eventId,revision:revision,value:value});this.cache.store(index,item,eventId);this.emit('itemAdded',item,false);this.emit('itemAddedRemotely',item);}}/**
         * Handle new value of item, coming from server
         * @private
         */},{key:"_handleItemUpdated",value:function _handleItemUpdated(index,uri,eventId,revision,value){var item=this.cache.get(index);if(!item&&!this.shouldIgnoreEvent(index,eventId)){item=this.cache.store(index,new listitem_1.ListItem({index:index,uri:uri,lastEventId:eventId,revision:revision,value:value}),eventId);this.emit('itemUpdated',item,false);this.emit('itemUpdatedRemotely',item);}else if(item&&eventId>item.lastEventId){item.update(eventId,revision,value);this.emit('itemUpdated',item,false);this.emit('itemUpdatedRemotely',item);}}},{key:"_handleItemRemoved",value:function _handleItemRemoved(index,eventId){this.cache.delete(index,eventId);this.emit('itemRemoved',index,false);this.emit('itemRemovedRemotely',index);}},{key:"_handleContextUpdate",value:function _handleContextUpdate(data,eventId){if(this.lastEventId<eventId){this.context=data;this.emit('contextUpdated',data,false);this.emit('contextUpdatedRemotely',data);}}},{key:"uri",get:function get(){return this.descriptor.url;}},{key:"revision",get:function get(){return this.descriptor.revision;}},{key:"lastEventId",get:function get(){return this.descriptor.last_event_id;}},{key:"links",get:function get(){return this.descriptor.links;}},{key:"sid",get:function get(){return this.descriptor.sid;}},{key:"uniqueName",get:function get(){return this.descriptor.unique_name||null;}},{key:"type",get:function get(){return'list';}}],[{key:"type",get:function get(){return'list';}}]);return SyncList;}(entity_1.SyncEntity);exports.SyncList=SyncList;Object.defineProperty(exports,"__esModule",{value:true});// export { SyncList, ListDescriptor, Mutator };
exports.default=SyncList;/**
 * Applies a transformation to the item value
 * @callback List~Mutator
 * @param {Object} data current value of an item
 * @return {Object} Modified data for an item
 *//**
 * Fired when item is added to the List
 * @event List#itemAdded
 * @type {Item} Added item
 *//**
 * Fired when item is added to List by remote actor
 * @event List#itemAddedRemotely
 * @type {Item} Added item
 *//**
 * Fired when item is updated
 * @event List#itemUpdated
 * @type {Item} Updated item
 *//**
 * Fired when item is updated by remote actor
 * @event List#itemUpdatedRemotely
 * @type {Item} Updated item
 *//**
 * Fired when item is removed from the List
 * @event List#itemRemoved
 * @type {String} item key
 *//**
 * Fired when item is removed from the List by remote actor
 * @event List#itemRemovedRemotely
 * @type {String} item key
 *//**
 * Fired when List is removed from server
 * @event List#collectionRemoved
 *//**
 * Fired when List is removed from server by remote actor
 * @event List#collectionRemovedRemotely
 */},{"./cache":192,"./entity":197,"./listitem":199,"./logger":200,"./paginator":203,"./retryingqueue":204,"./utils":211,"babel-runtime/core-js/object/get-prototype-of":12,"babel-runtime/core-js/promise":15,"babel-runtime/helpers/classCallCheck":21,"babel-runtime/helpers/createClass":22,"babel-runtime/helpers/extends":23,"babel-runtime/helpers/inherits":24,"babel-runtime/helpers/possibleConstructorReturn":25,"babel-runtime/regenerator":28}],210:[function(_dereq_,module,exports){"use strict";var _extends2=_dereq_("babel-runtime/helpers/extends");var _extends3=_interopRequireDefault(_extends2);var _regenerator=_dereq_("babel-runtime/regenerator");var _regenerator2=_interopRequireDefault(_regenerator);var _getPrototypeOf=_dereq_("babel-runtime/core-js/object/get-prototype-of");var _getPrototypeOf2=_interopRequireDefault(_getPrototypeOf);var _classCallCheck2=_dereq_("babel-runtime/helpers/classCallCheck");var _classCallCheck3=_interopRequireDefault(_classCallCheck2);var _createClass2=_dereq_("babel-runtime/helpers/createClass");var _createClass3=_interopRequireDefault(_createClass2);var _possibleConstructorReturn2=_dereq_("babel-runtime/helpers/possibleConstructorReturn");var _possibleConstructorReturn3=_interopRequireDefault(_possibleConstructorReturn2);var _inherits2=_dereq_("babel-runtime/helpers/inherits");var _inherits3=_interopRequireDefault(_inherits2);var _promise=_dereq_("babel-runtime/core-js/promise");var _promise2=_interopRequireDefault(_promise);function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj};}var __awaiter=undefined&&undefined.__awaiter||function(thisArg,_arguments,P,generator){return new(P||(P=_promise2.default))(function(resolve,reject){function fulfilled(value){try{step(generator.next(value));}catch(e){reject(e);}}function rejected(value){try{step(generator["throw"](value));}catch(e){reject(e);}}function step(result){result.done?resolve(result.value):new P(function(resolve){resolve(result.value);}).then(fulfilled,rejected);}step((generator=generator.apply(thisArg,_arguments||[])).next());});};var utils_1=_dereq_("./utils");var logger_1=_dereq_("./logger");var entity_1=_dereq_("./entity");var retryingqueue_1=_dereq_("./retryingqueue");var mapitem_1=_dereq_("./mapitem");var paginator_1=_dereq_("./paginator");var cache_1=_dereq_("./cache");/**
 * @class
 * @alias Map
 * @classdesc Map collection to store a set of Key:Value pairs
 * @property {String} sid - Map unique id
 * @property {String} uniqueName - Map unique name
 *
 * @fires Map#itemAdded
 * @fires Map#itemAddedRemotely
 * @fires Map#itemUpdated
 * @fires Map#itemUpdatedRemotely
 * @fires Map#itemRemoved
 * @fires Map#itemRemovedRemotely
 * @fires Map#collectionRemoved
 * @fires Map#collectionRemovedRemotely
 */var SyncMap=function(_entity_1$SyncEntity){(0,_inherits3.default)(SyncMap,_entity_1$SyncEntity);/**
     * @private
     */function SyncMap(services,descriptor,onRemoveMap){(0,_classCallCheck3.default)(this,SyncMap);var _this=(0,_possibleConstructorReturn3.default)(this,(SyncMap.__proto__||(0,_getPrototypeOf2.default)(SyncMap)).call(this,services));_this.actionQueue=new retryingqueue_1.RetryingQueue();_this.cache=new cache_1.Cache();_this.descriptor=descriptor;_this.onRemoveMap=onRemoveMap;return _this;}(0,_createClass3.default)(SyncMap,[{key:"_get",value:function _get(key){return this.queryItems({key:key}).then(function(result){if(result.items.length<1){throw new Error('No item with key '+key+' found');}return result.items[0];});}},{key:"__set",value:function __set(location,param){return this.services.network.post(location,{data:param.data},param.revision).then(function(response){response=response.body;response.data=param.data;return response;});}/**
         * Update known existing element
         * @private
         */},{key:"_set",value:function _set(location,keyValue,resolver){return __awaiter(this,void 0,void 0,_regenerator2.default.mark(function _callee2(){var _this2=this;var _resolver;return _regenerator2.default.wrap(function _callee2$(_context2){while(1){switch(_context2.prev=_context2.next){case 0:if(resolver){_context2.next=2;break;}return _context2.abrupt("return",this.__set(location,{data:keyValue.data}));case 2:_resolver=function _resolver(err){return __awaiter(_this2,void 0,void 0,_regenerator2.default.mark(function _callee(){var item;return _regenerator2.default.wrap(function _callee$(_context){while(1){switch(_context.prev=_context.next){case 0:if(!(err.status===412)){_context.next=7;break;}_context.next=3;return this.queryEvents();case 3:_context.next=5;return this.get(keyValue.key);case 5:item=_context.sent;return _context.abrupt("return",{revision:item.revision,data:resolver(item.value,keyValue.data)});case 7:throw err;case 8:case"end":return _context.stop();}}},_callee,this);}));};return _context2.abrupt("return",this.actionQueue.add(this.__set.bind(this),location,{revision:keyValue.revision,data:keyValue.data},_resolver));case 4:case"end":return _context2.stop();}}},_callee2,this);}));}/**
         * Create element or update if already existing
         * @private
         */},{key:"_tryAddOrUpdate",value:function _tryAddOrUpdate(uri,keyValue,resolver){return __awaiter(this,void 0,void 0,_regenerator2.default.mark(function _callee3(){var response,location,value,_response,_value;return _regenerator2.default.wrap(function _callee3$(_context3){while(1){switch(_context3.prev=_context3.next){case 0:_context3.prev=0;_context3.next=3;return this.services.network.post(uri,keyValue);case 3:response=_context3.sent;response.body.data=keyValue.data;return _context3.abrupt("return",{added:true,value:response.body});case 8:_context3.prev=8;_context3.t0=_context3["catch"](0);if(!(_context3.t0.status!==409)){_context3.next=12;break;}throw _context3.t0;case 12:location=_context3.t0.body.links.item;if(resolver){_context3.next=20;break;}_context3.next=16;return this._set(location,keyValue,resolver);case 16:value=_context3.sent;return _context3.abrupt("return",{added:false,value:value});case 20:_context3.next=22;return this.services.network.get(location);case 22:_response=_context3.sent;_context3.next=25;return this._set(location,{key:_response.key,revision:_response.revision,data:keyValue},resolver);case 25:_value=_context3.sent;return _context3.abrupt("return",{added:false,value:_value});case 27:case"end":return _context3.stop();}}},_callee3,this,[[0,8]]);}));}/**
         * Query events from servie and apply changes to the collection
         * @private
         */},{key:"queryEvents",value:function queryEvents(){return __awaiter(this,void 0,void 0,_regenerator2.default.mark(function _callee4(){var _this3=this;var uri,response;return _regenerator2.default.wrap(function _callee4$(_context4){while(1){switch(_context4.prev=_context4.next){case 0:_context4.prev=0;uri=this.descriptor.links.events+"?From="+(this.lastEventId+1)+"&PageSize=100";_context4.next=4;return this.services.network.get(uri);case 4:response=_context4.sent;response.body.events.forEach(function(ev){return _this3._update(ev);});_context4.next=12;break;case 8:_context4.prev=8;_context4.t0=_context4["catch"](0);logger_1.default.error('Failed to fetch events:',_context4.t0);throw _context4.t0;case 12:;case 13:case"end":return _context4.stop();}}},_callee4,this,[[0,8]]);}));}/**
         * @return Promise<Object> Context of collection
         * @private
         */},{key:"getContext",value:function getContext(){return __awaiter(this,void 0,void 0,_regenerator2.default.mark(function _callee5(){var response;return _regenerator2.default.wrap(function _callee5$(_context5){while(1){switch(_context5.prev=_context5.next){case 0:if(!(typeof this.context!=='undefined')){_context5.next=2;break;}return _context5.abrupt("return",this.context);case 2:_context5.next=4;return this.services.network.get(this.links.context);case 4:response=_context5.sent;this.context=response.body.data;return _context5.abrupt("return",this.context);case 7:case"end":return _context5.stop();}}},_callee5,this);}));}/**
         * @param context {Object} New context value
         * @returns {Promise}
         * @private
         */},{key:"updateContext",value:function updateContext(context){return __awaiter(this,void 0,void 0,_regenerator2.default.mark(function _callee6(){return _regenerator2.default.wrap(function _callee6$(_context6){while(1){switch(_context6.prev=_context6.next){case 0:_context6.next=2;return this.services.network.post(this.links.context,{data:context});case 2:this.context=context;this.emit('contextUpdated',context,true);case 4:case"end":return _context6.stop();}}},_callee6,this);}));}/**
         * Set key and value pair in map
         * @param {String} key  Key identifier
         * @param {Object} value Value to set
         * @returns {Promise<Item>}
         * @public
         */},{key:"set",value:function set(key,value){return this._actualSet(key,value);}/**
         * @private
         */},{key:"_actualSet",value:function _actualSet(key,value,resolver){return __awaiter(this,void 0,void 0,_regenerator2.default.mark(function _callee7(){var item,arg,response,_ref,added,result,descriptor;return _regenerator2.default.wrap(function _callee7$(_context7){while(1){switch(_context7.prev=_context7.next){case 0:item=this.cache.get(key);if(!item){_context7.next=9;break;}arg={key:key,data:value,revision:item.revision||undefined};_context7.next=5;return this._set(item.uri,arg,resolver);case 5:response=_context7.sent;item.update(response.last_event_id,response.revision,response.data);this.emit('itemUpdated',item,true);return _context7.abrupt("return",item);case 9:_context7.next=11;return this._tryAddOrUpdate(this.links.items,{key:key,data:value},resolver);case 11:_ref=_context7.sent;added=_ref.added;result=_ref.value;descriptor={key:result.key,revision:result.revision,lastEventId:result.last_event_id,uri:result.url,value:result.data};_context7.next=17;return this.cache.get(key);case 17:item=_context7.sent;if(item&&descriptor.lastEventId>item.lastEventId){item.update(descriptor.lastEventId,descriptor.revision,descriptor.value);}else if(!item){item=this.cache.store(key,new mapitem_1.MapItem(descriptor),descriptor.lastEventId);if(added){this.emit('itemAdded',item,true);}else{this.emit('itemUpdated',item,true);}}return _context7.abrupt("return",item);case 20:case"end":return _context7.stop();}}},_callee7,this);}));}/**
         * @param {String} key String identifier of entity in a map
         * @return {Promise<Item>}
         * @public
         */},{key:"get",value:function get(key){return __awaiter(this,void 0,void 0,_regenerator2.default.mark(function _callee8(){var result;return _regenerator2.default.wrap(function _callee8$(_context8){while(1){switch(_context8.prev=_context8.next){case 0:if(!this.cache.has(key)){_context8.next=2;break;}return _context8.abrupt("return",this.cache.get(key));case 2:_context8.next=4;return this.queryItems({key:key});case 4:result=_context8.sent;if(!(result.items.length<1)){_context8.next=7;break;}throw new Error('No item with key '+key+' found');case 7:return _context8.abrupt("return",result.items[0]);case 8:case"end":return _context8.stop();}}},_callee8,this);}));}/**
         * @param {String} Key Item key
         * @param {Map~Mutator} Mutator Function performing value mutation
         * @return {Promise<Item>}
         */},{key:"mutate",value:function mutate(key,mutator){return __awaiter(this,void 0,void 0,_regenerator2.default.mark(function _callee9(){var value;return _regenerator2.default.wrap(function _callee9$(_context9){while(1){switch(_context9.prev=_context9.next){case 0:_context9.next=2;return this.get(key).then(function(item){return item.value;}).catch(function(){return{};});case 2:value=_context9.sent;return _context9.abrupt("return",this._actualSet(key,mutator(value),mutator));case 4:case"end":return _context9.stop();}}},_callee9,this);}));}/**
         * @param {String} key Item key
         * @param {Object} update Set of fields to update
         * @return {Promise<Item>} Result data
         */},{key:"update",value:function update(key,obj){return __awaiter(this,void 0,void 0,_regenerator2.default.mark(function _callee10(){return _regenerator2.default.wrap(function _callee10$(_context10){while(1){switch(_context10.prev=_context10.next){case 0:return _context10.abrupt("return",this.mutate(key,function(remote){return(0,_extends3.default)(remote,obj);}));case 1:case"end":return _context10.stop();}}},_callee10,this);}));}/**
         * Delete an entity by given key
         * @return {Promise}
         */},{key:"remove",value:function remove(key){return __awaiter(this,void 0,void 0,_regenerator2.default.mark(function _callee11(){var item;return _regenerator2.default.wrap(function _callee11$(_context11){while(1){switch(_context11.prev=_context11.next){case 0:if(!(typeof key==='undefined')){_context11.next=2;break;}throw new Error('Key argument is invalid');case 2:_context11.next=4;return this.get(key);case 4:item=_context11.sent;_context11.next=7;return this.services.network.delete(item.uri);case 7:this.cache.delete(key,item.lastEventId);this.emit('itemRemoved',key,true);case 9:case"end":return _context11.stop();}}},_callee11,this);}));}/**
         * @private
         */},{key:"queryItems",value:function queryItems(args){return __awaiter(this,void 0,void 0,_regenerator2.default.mark(function _callee12(){var _this4=this;var uri,response,items,meta;return _regenerator2.default.wrap(function _callee12$(_context12){while(1){switch(_context12.prev=_context12.next){case 0:args=args||{};uri=new utils_1.UriBuilder(this.links.items).arg('From',args.from).arg('PageSize',args.limit).arg('Key',args.key).arg('PageToken',args.pageToken).arg('Order',args.order).build();_context12.next=4;return this.services.network.get(uri);case 4:response=_context12.sent;items=response.body.items.map(function(el){return _this4.cache.store(el.key,new mapitem_1.MapItem({key:el.key,uri:el.url,revision:el.revision,lastEventId:el.last_event_id,value:el.data}),el.last_event_id);});meta=response.body.meta;return _context12.abrupt("return",new paginator_1.Paginator(items,function(pageToken){return _this4.queryItems({pageToken:pageToken});},meta.previous_token,meta.next_token));case 8:case"end":return _context12.stop();}}},_callee12,this);}));}/**
         * Get a list of items from the Map
         * @param {Object} args Arguments for query
         * @param {String} args.from Item, which should be used as an anchor. If undefined, starts from the beginning or end depending on args.order
         * @param {Number} args.pageSize Result page size
         * @param {String} args.order Order of results, should be 'asc' or 'desc'
         * @return {Promise<Paginator>}
         * @public
         */},{key:"getItems",value:function getItems(args){return __awaiter(this,void 0,void 0,_regenerator2.default.mark(function _callee13(){return _regenerator2.default.wrap(function _callee13$(_context13){while(1){switch(_context13.prev=_context13.next){case 0:args=args||{};args.limit=args.pageSize||args.limit||50;args.order=args.order||'asc';return _context13.abrupt("return",this.queryItems(args));case 4:case"end":return _context13.stop();}}},_callee13,this);}));}/**
         * Synchronizes object with state on a server
         * Fires events about all changes
         *
         * SyncMap#entityAdded
         * SyncMap#entityRemoved
         * SyncMap#entityUpdated
         * SyncMap#contextUpdated
         *
         * @private
         */},{key:"softSync",value:function softSync(){return __awaiter(this,void 0,void 0,_regenerator2.default.mark(function _callee14(){return _regenerator2.default.wrap(function _callee14$(_context14){while(1){switch(_context14.prev=_context14.next){case 0:_context14.prev=0;_context14.next=3;return this.queryEvents();case 3:_context14.next=8;break;case 5:_context14.prev=5;_context14.t0=_context14["catch"](0);if(_context14.t0.status===404){this.onRemoved(false);}else{logger_1.default.error("Can't get updates for "+this.sid+":",_context14.t0);}case 8:case"end":return _context14.stop();}}},_callee14,this,[[0,5]]);}));}/**
         * Enumerate through all of maps items
         * It always triggers server interaction when being called for the first time for an object, so could be slow
         * This method not supported now and not meant to be used externally
         * @param {Function} handler Function to handle each argument
         * @private
         */},{key:"forEach",value:function forEach(handler){var _this5=this;return new _promise2.default(function(resolve,reject){function processPage(page){page.items.forEach(function(x){return handler(x);});if(page.hasNextPage){page.nextPage().then(processPage).catch(reject);}else{resolve();}}_this5.queryItems().then(processPage).catch(reject);});}},{key:"shouldIgnoreEvent",value:function shouldIgnoreEvent(key,eventId){return this.cache.isKnown(key,eventId);}/**
         * Handle update from the server
         * @private
         */},{key:"_update",value:function _update(update){switch(update.type){case'map_item_added':{this._handleItemAdded(update.item_key,update.item_url,update.id,update.item_revision,update.item_data);}break;case'map_item_updated':{this._handleItemUpdated(update.item_key,update.item_url,update.id,update.item_revision,update.item_data);}break;case'map_item_removed':{this._handleItemRemoved(update.item_key,update.id);}break;case'map_context_updated':{this._handleContextUpdate(update.context_data,update.id);}break;case'map_removed':{this.onRemoved(false);}break;}if(this.lastEventId<update.id){this.descriptor.revision=update.map_revision;this.descriptor.last_event_id=update.id;}}/**
         * Handle entity insertion event, coming from server
         * @private
         */},{key:"_handleItemAdded",value:function _handleItemAdded(key,uri,eventId,revision,value){if(!this.cache.has(key)&&!this.shouldIgnoreEvent(key,eventId)){var item=new mapitem_1.MapItem({key:key,uri:uri,lastEventId:eventId,revision:revision,value:value});this.cache.store(key,item,eventId);this.emit('itemAdded',item,false);this.emit('itemAddedRemotely',item);}}/**
         * Handle new value of entity, coming from server
         * @private
         */},{key:"_handleItemUpdated",value:function _handleItemUpdated(key,uri,eventId,revision,value){var item=this.cache.get(key);if(!item&&!this.shouldIgnoreEvent(key,eventId)){item=new mapitem_1.MapItem({key:key,uri:uri,lastEventId:eventId,revision:revision,value:value});this.cache.store(key,item,eventId);this.emit('itemUpdated',item,false);this.emit('itemUpdatedRemotely',item);}else if(item&&eventId>item.lastEventId){item.update(eventId,revision,value);this.emit('itemUpdated',item,false);this.emit('itemUpdatedRemotely',item);}}/**
         * @private
         */},{key:"_handleItemRemoved",value:function _handleItemRemoved(key,eventId){this.cache.delete(key,eventId);this.emit('itemRemoved',key,false);this.emit('itemRemovedRemotely',key,false);}},{key:"_handleContextUpdate",value:function _handleContextUpdate(data,eventId){if(this.lastEventId<eventId){this.context=data;this.emit('contextUpdated',data,false);this.emit('contextUpdatedRemotely',data);}}},{key:"onRemoved",value:function onRemoved(locally){this._unsubscribe();// Should also do some cleanup here
this.emit('collectionRemoved',locally);if(!locally){this.emit('collectionRemovedRemotely');}}/**
         * Delete map from server. It will be impossible to restore it.
         * @return {Promise} Promise to delete the collection
         * @public
         */},{key:"removeMap",value:function removeMap(){return __awaiter(this,void 0,void 0,_regenerator2.default.mark(function _callee15(){return _regenerator2.default.wrap(function _callee15$(_context15){while(1){switch(_context15.prev=_context15.next){case 0:this.onRemoveMap(this.sid);_context15.next=3;return this.services.network.delete(this.uri);case 3:this.onRemoved(true);case 4:case"end":return _context15.stop();}}},_callee15,this);}));}},{key:"uri",get:function get(){return this.descriptor.url;}},{key:"links",get:function get(){return this.descriptor.links;}},{key:"revision",get:function get(){return this.descriptor.revision;}},{key:"lastEventId",get:function get(){return this.descriptor.last_event_id;}},{key:"sid",get:function get(){return this.descriptor.sid;}},{key:"uniqueName",get:function get(){return this.descriptor.unique_name||null;}},{key:"type",get:function get(){return'map';}}],[{key:"type",get:function get(){return'map';}}]);return SyncMap;}(entity_1.SyncEntity);exports.SyncMap=SyncMap;Object.defineProperty(exports,"__esModule",{value:true});// export { SyncMap, MapDescriptor, Mutator };
exports.default=SyncMap;/**
 * Applies a transformation to the item value
 * @callback Map~Mutator
 * @param {Object} data current value of an item
 * @return {Object} Modified data for an item
 *//**
 * Fired when item is added to the Map
 * @event Map#itemAdded
 * @type {Item} Added item
 *//**
 * Fired when item is added to the Map by remote actor
 * @event Map#itemAddedRemotely
 * @type {Item} Added item
 *//**
 * Fired when item is updated
 * @event Map#itemUpdated
 * @type {Item} Updated item
 *//**
 * Fired when item is updated by remote actor
 * @event Map#itemUpdatedRemotely
 * @type {Item} Updated item
 *//**
 * Fired when item is removed from the Map
 * @event Map#itemRemoved
 * @type {String} item key
 *//**
 * Fired when item is removed from the Map by remote actor
 * @event Map#itemRemovedRemotely
 * @type {String} item key
 *//**
 * Fired when Map is removed from server
 * @event Map#collectionRemoved
 *//**
 * Fired when Map is removed from server by remote actor
 * @event Map#collectionRemovedRemotely
 */},{"./cache":192,"./entity":197,"./logger":200,"./mapitem":201,"./paginator":203,"./retryingqueue":204,"./utils":211,"babel-runtime/core-js/object/get-prototype-of":12,"babel-runtime/core-js/promise":15,"babel-runtime/helpers/classCallCheck":21,"babel-runtime/helpers/createClass":22,"babel-runtime/helpers/extends":23,"babel-runtime/helpers/inherits":24,"babel-runtime/helpers/possibleConstructorReturn":25,"babel-runtime/regenerator":28}],211:[function(_dereq_,module,exports){"use strict";/**
 * Deep-clone an object. Note that this does not work on object containing
 * functions.
 * @param {object} obj - the object to deep-clone
 * @returns {object}
 */var _classCallCheck2=_dereq_('babel-runtime/helpers/classCallCheck');var _classCallCheck3=_interopRequireDefault(_classCallCheck2);var _createClass2=_dereq_('babel-runtime/helpers/createClass');var _createClass3=_interopRequireDefault(_createClass2);var _stringify=_dereq_('babel-runtime/core-js/json/stringify');var _stringify2=_interopRequireDefault(_stringify);function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj};}function deepClone(obj){return JSON.parse((0,_stringify2.default)(obj));}exports.deepClone=deepClone;/**
 * Construct URI with query parameters
 */var UriBuilder=function(){function UriBuilder(base){(0,_classCallCheck3.default)(this,UriBuilder);this.base=base;this.args=new Array();this.paths=new Array();}(0,_createClass3.default)(UriBuilder,[{key:'path',value:function path(name){this.paths.push(name);return this;}},{key:'arg',value:function arg(name,value){if(typeof value!=='undefined'){this.args.push(name+'='+encodeURIComponent(value));}return this;}},{key:'build',value:function build(){var result=this.base;if(this.paths.length){result+='/'+this.paths.join('/');}if(this.args.length){result+='?'+this.args.join('&');}return result;}}]);return UriBuilder;}();exports.UriBuilder=UriBuilder;},{"babel-runtime/core-js/json/stringify":4,"babel-runtime/helpers/classCallCheck":21,"babel-runtime/helpers/createClass":22}],212:[function(_dereq_,module,exports){module.exports={"_args":[[{"raw":"twilio-sync@^0.4.2","scope":null,"escapedName":"twilio-sync","name":"twilio-sync","rawSpec":"^0.4.2","spec":">=0.4.2 <0.5.0","type":"range"},"/Users/schertkov/workspace/twilio/rtd/js/ipmessaging-js-lib"]],"_from":"twilio-sync@>=0.4.2 <0.5.0","_id":"twilio-sync@0.4.2","_inCache":true,"_location":"/twilio-sync","_nodeVersion":"7.5.0","_npmOperationalInternal":{"host":"packages-18-east.internal.npmjs.com","tmp":"tmp/twilio-sync-0.4.2.tgz_1487671857135_0.2178721190430224"},"_npmUser":{"name":"schertkov","email":"schertkov@twilio.com"},"_npmVersion":"4.1.2","_phantomChildren":{},"_requested":{"raw":"twilio-sync@^0.4.2","scope":null,"escapedName":"twilio-sync","name":"twilio-sync","rawSpec":"^0.4.2","spec":">=0.4.2 <0.5.0","type":"range"},"_requiredBy":["/"],"_resolved":"https://registry.npmjs.org/twilio-sync/-/twilio-sync-0.4.2.tgz","_shasum":"ef4f1137fa5f1575a4f090a4469498d2fa204856","_shrinkwrap":null,"_spec":"twilio-sync@^0.4.2","_where":"/Users/schertkov/workspace/twilio/rtd/js/ipmessaging-js-lib","author":{"name":"Twilio"},"browser":"browser/index.js","dependencies":{"babel-runtime":"^6.23.0","karibu":"^1.0.1","loglevel":"^1.4.1","platform":"^1.3.3","rfc6902":"^1.3.0","twilio-ems-client":"^0.1.5","twilio-notifications":"^0.3.0","twilio-transport":"^0.1.1","twilsock":"^0.2.2","uuid":"^3.0.1"},"description":"Twilio Sync client library","devDependencies":{"@types/chai":"^3.4.34","@types/chai-as-promised":"0.0.29","@types/loglevel":"^1.4.29","@types/mocha":"^2.2.39","@types/node":"^7.0.5","@types/sinon":"^1.16.35","@types/sinon-as-promised":"^4.0.5","@types/sinon-chai":"^2.7.27","async-test-tools":"^1.0.6","babel-cli":"^6.23.0","babel-plugin-add-module-exports":"^0.2.1","babel-plugin-transform-object-assign":"^6.22.0","babel-plugin-transform-runtime":"^6.23.0","babel-preset-es2015":"^6.22.0","babelify":"^7.3.0","backoff":"^2.5.0","browserify":"^14.1.0","chai":"^3.5.0","chai-as-promised":"^6.0.0","cheerio":"^0.22.0","del":"^2.2.2","event-to-promise":"^0.7.0","gulp":"^3.9.1","gulp-babel":"^6.1.2","gulp-derequire":"^2.1.0","gulp-exit":"0.0.2","gulp-insert":"^0.5.0","gulp-istanbul":"^1.1.1","gulp-mocha":"^3.0.1","gulp-rename":"^1.2.2","gulp-replace":"^0.5.4","gulp-tap":"^0.1.3","gulp-tslint":"^7.1.0","gulp-typescript":"^3.1.4","gulp-uglify":"^2.0.1","gulp-util":"^3.0.8","ink-docstrap":"^1.3.0","isparta":"^4.0.0","jsdoc":"^3.4.3","jsonwebtoken":"^7.3.0","karma":"^1.4.1","karma-browserify":"^5.1.1","karma-browserstack-launcher":"^1.2.0","karma-mocha":"^1.3.0","karma-mocha-reporter":"^2.2.2","run-sequence":"^1.2.2","sinon":"^1.17.7","sinon-as-promised":"^4.0.2","sinon-chai":"^2.8.0","ts-node":"^2.1.0","tslint":"^4.4.2","twilio":"^3.3.0-edge","typescript":"^2.1.6","underscore":"^1.8.3","vinyl-buffer":"^1.0.0","vinyl-source-stream":"^1.1.0","watchify":"^3.9.0"},"directories":{},"dist":{"shasum":"ef4f1137fa5f1575a4f090a4469498d2fa204856","tarball":"https://registry.npmjs.org/twilio-sync/-/twilio-sync-0.4.2.tgz"},"gitHead":"894388524f3fd61ed39162b4ceae3c8100348f1d","license":"MIT","main":"lib/index.js","maintainers":[{"name":"schertkov","email":"schertkov@twilio.com"},{"name":"twilio-ci","email":"mroberts+twilio-ci@twilio.com"}],"name":"twilio-sync","optionalDependencies":{},"readme":"ERROR: No README data found!","scripts":{"prepublish":"gulp build","test":"gulp unit-test"},"version":"0.4.2"};},{}],213:[function(_dereq_,module,exports){'use strict';var _stringify=_dereq_("babel-runtime/core-js/json/stringify");var _stringify2=_interopRequireDefault(_stringify);var _promise=_dereq_("babel-runtime/core-js/promise");var _promise2=_interopRequireDefault(_promise);var _defineProperty=_dereq_("babel-runtime/core-js/object/define-property");var _defineProperty2=_interopRequireDefault(_defineProperty);function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj};}Object.defineProperty(exports,"__esModule",{value:true});var _createClass=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||false;descriptor.configurable=true;if("value"in descriptor)descriptor.writable=true;(0,_defineProperty2.default)(target,descriptor.key,descriptor);}}return function(Constructor,protoProps,staticProps){if(protoProps)defineProperties(Constructor.prototype,protoProps);if(staticProps)defineProperties(Constructor,staticProps);return Constructor;};}();function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor)){throw new TypeError("Cannot call a class as a function");}}var XHR=typeof XMLHttpRequest==='undefined'?_dereq_('xmlhttprequest').XMLHttpRequest:XMLHttpRequest;function parseResponseHeaders(headerString){return headerString.split('\r\n').map(function(el){return el.split(': ');}).filter(function(el){return el.length===2&&el[1].length>0;}).reduce(function(prev,curr){prev[curr[0]]=curr[1];return prev;},{});}function extractBody(xhr){var contentType=xhr.getResponseHeader('Content-Type');if(!contentType||contentType.indexOf('application/json')!==0||xhr.responseText.length===0){return xhr.responseText;}try{return JSON.parse(xhr.responseText);}catch(e){return xhr.responseText;}}/**
 * Use XMLHttpRequest to get a network resource.
 * @param {String} method - HTTP Method
 * @param {Object} params - Request parameters
 * @param {String} params.url - URL of the resource
 * @param {Array}  params.headers - An array of headers to pass [{ headerName : headerBody }]
 * @param {Object} params.body - A JSON body to send to the resource
 * @returns {Promise}
 **/var Request=function(){function Request(){_classCallCheck(this,Request);}_createClass(Request,null,[{key:'request',value:function request(method,params){return new _promise2.default(function(resolve,reject){var xhr=new XHR();xhr.open(method,params.url,true);xhr.onreadystatechange=function onreadystatechange(){if(xhr.readyState!==4){return;}var headers=parseResponseHeaders(xhr.getAllResponseHeaders());var body=extractBody(xhr);if(200<=xhr.status&&xhr.status<300){resolve({status:xhr.status,headers:headers,body:body});}else{reject({status:xhr.status,description:xhr.statusText,headers:headers,body:body});}};for(var headerName in params.headers){xhr.setRequestHeader(headerName,params.headers[headerName]);if(headerName==='Content-Type'&&params.headers[headerName]==='application/json'){params.body=(0,_stringify2.default)(params.body);}}xhr.send(params.body);});}/**
     * Sugar function for request('GET', params);
     * @param {Object} params - Request parameters
     * @returns {Promise}
     */},{key:'get',value:function get(params){return this.request('GET',params);}/**
     * Sugar function for request('POST', params);
     * @param {Object} params - Request parameters
     * @returns {Promise}
     */},{key:'post',value:function post(params){return this.request('POST',params);}/**
     * Sugar function for request('PUT', params);
     * @param {Object} params - Request parameters
     * @returns {Promise}
     */},{key:'put',value:function put(params){return this.request('PUT',params);}/**
     * Sugar function for request('DELETE', params);
     * @param {Object} params - Request parameters
     * @returns {Promise}
     */},{key:'delete',value:function _delete(params){return this.request('DELETE',params);}}]);return Request;}();exports.default=Request;module.exports=Request;module.exports=exports['default'];},{"babel-runtime/core-js/json/stringify":4,"babel-runtime/core-js/object/define-property":10,"babel-runtime/core-js/promise":15,"xmlhttprequest":40}],214:[function(_dereq_,module,exports){'use strict';var _promise=_dereq_("babel-runtime/core-js/promise");var _promise2=_interopRequireDefault2(_promise);var _map=_dereq_("babel-runtime/core-js/map");var _map2=_interopRequireDefault2(_map);var _defineProperties=_dereq_("babel-runtime/core-js/object/define-properties");var _defineProperties2=_interopRequireDefault2(_defineProperties);var _keys=_dereq_("babel-runtime/core-js/object/keys");var _keys2=_interopRequireDefault2(_keys);var _getPrototypeOf=_dereq_("babel-runtime/core-js/object/get-prototype-of");var _getPrototypeOf2=_interopRequireDefault2(_getPrototypeOf);var _from=_dereq_("babel-runtime/core-js/array/from");var _from2=_interopRequireDefault2(_from);var _construct=_dereq_("babel-runtime/core-js/reflect/construct");var _construct2=_interopRequireDefault2(_construct);var _setPrototypeOf=_dereq_("babel-runtime/core-js/object/set-prototype-of");var _setPrototypeOf2=_interopRequireDefault2(_setPrototypeOf);var _create=_dereq_("babel-runtime/core-js/object/create");var _create2=_interopRequireDefault2(_create);var _typeof2=_dereq_("babel-runtime/helpers/typeof");var _typeof3=_interopRequireDefault2(_typeof2);var _defineProperty=_dereq_("babel-runtime/core-js/object/define-property");var _defineProperty2=_interopRequireDefault2(_defineProperty);function _interopRequireDefault2(obj){return obj&&obj.__esModule?obj:{default:obj};}Object.defineProperty(exports,"__esModule",{value:true});exports.TwilsockUnavailableError=exports.Transport=undefined;var _createClass=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||false;descriptor.configurable=true;if("value"in descriptor)descriptor.writable=true;(0,_defineProperty2.default)(target,descriptor.key,descriptor);}}return function(Constructor,protoProps,staticProps){if(protoProps)defineProperties(Constructor.prototype,protoProps);if(staticProps)defineProperties(Constructor,staticProps);return Constructor;};}();var _httprequest=_dereq_('./httprequest');var _httprequest2=_interopRequireDefault(_httprequest);function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj};}function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor)){throw new TypeError("Cannot call a class as a function");}}function _possibleConstructorReturn(self,call){if(!self){throw new ReferenceError("this hasn't been initialised - super() hasn't been called");}return call&&((typeof call==="undefined"?"undefined":(0,_typeof3.default)(call))==="object"||typeof call==="function")?call:self;}function _inherits(subClass,superClass){if(typeof superClass!=="function"&&superClass!==null){throw new TypeError("Super expression must either be null or a function, not "+(typeof superClass==="undefined"?"undefined":(0,_typeof3.default)(superClass)));}subClass.prototype=(0,_create2.default)(superClass&&superClass.prototype,{constructor:{value:subClass,enumerable:false,writable:true,configurable:true}});if(superClass)_setPrototypeOf2.default?(0,_setPrototypeOf2.default)(subClass,superClass):subClass.__proto__=superClass;}function _extendableBuiltin(cls){function ExtendableBuiltin(){var instance=(0,_construct2.default)(cls,(0,_from2.default)(arguments));(0,_setPrototypeOf2.default)(instance,(0,_getPrototypeOf2.default)(this));return instance;}ExtendableBuiltin.prototype=(0,_create2.default)(cls.prototype,{constructor:{value:cls,enumerable:false,writable:true,configurable:true}});if(_setPrototypeOf2.default){(0,_setPrototypeOf2.default)(ExtendableBuiltin,cls);}else{ExtendableBuiltin.__proto__=cls;}return ExtendableBuiltin;}function parseUri(uri){var match=uri.match(/^(https?\:)\/\/(([^:\/?#]*)(?:\:([0-9]+))?)(\/[^?#]*)(\?[^#]*|)(#.*|)$/);if(match){var uriStruct={protocol:match[1],host:match[2],hostname:match[3],port:match[4],pathname:match[5],search:match[6],hash:match[7]};if(uriStruct.search.length>0){var paramsString=uriStruct.search.substring(1);uriStruct.params=paramsString.split('&').map(function(el){return el.split('=');}).reduce(function(prev,curr){if(!prev.hasOwnProperty(curr[0])){prev[curr[0]]=curr[1];}else if(Array.isArray(prev[curr[0]])){prev[curr[0]].push(curr[1]);}else{prev[curr[0]]=[prev[curr[0]],curr[1]];}return prev;},{});}return uriStruct;}throw new Error('Incorrect URI: '+uri);}function twilsockAddress(method,uri){var parsedUri=parseUri(uri);var to={method:method,host:parsedUri.host,path:parsedUri.pathname};if(parsedUri.params){to.params=parsedUri.params;}return to;}function twilsockParams(type,uri,headers,body){return{to:twilsockAddress(type,uri),headers:headers,body:body};}function adaptTwilsockResponse(response){return{status:response.status,headers:response.header.http_headers,body:response.body};}function httpParams(uri,headers,body){return{url:uri,headers:headers,body:body};}function adaptHttpResponse(response){try{response.body=JSON.parse(response.body);}catch(e){}// eslint-disable-line no-empty
return response;}/**
 * By RFC header names are case-insensitive
 * though it is much easier to work with them in code
 * when they have any specific case.
 * So we forcefully lowercase all headers
 */function lowercaseHeaders(response){var keys=(0,_keys2.default)(response.headers);var n=keys.length;var headers={};while(n--){var key=keys[n];headers[key.toLowerCase()]=response.headers[key];}response.headers=headers;return response;}/**
 * Transport specific error.
 * Being fired when twilsock-only transmission requested but not available
 * @inherits Error
 */var TwilsockUnavailableError=function(_extendableBuiltin2){_inherits(TwilsockUnavailableError,_extendableBuiltin2);function TwilsockUnavailableError(){_classCallCheck(this,TwilsockUnavailableError);return _possibleConstructorReturn(this,(TwilsockUnavailableError.__proto__||(0,_getPrototypeOf2.default)(TwilsockUnavailableError)).call(this));}return TwilsockUnavailableError;}(_extendableBuiltin(Error));/**
 * Provides generic network interface
 */var Transport=function(){function Transport(twilsock){var _this2=this;_classCallCheck(this,Transport);(0,_defineProperties2.default)(this,{_activeGetRequests:{value:new _map2.default()},_twilsock:{value:twilsock},_http:{value:_httprequest2.default},_twilsockIsAvailable:{get:function get(){return _this2._twilsock&&_this2._twilsock.isConnected;}}});if(twilsock){twilsock.connect();}}/**
   * Make a GET request by given URI
   *
   * This function applies "multiplexing" optimization.
   * If several requests for the same URI happen on the same time,
   * only one will really happen, but all clients will see th result.
   *
   * @Returns Promise<Response> Result of successful get request
   */_createClass(Transport,[{key:'get',value:function get(uri,headers,forceTwilsock){var _this3=this;if(this._activeGetRequests.has(uri)){return this._activeGetRequests.get(uri);}var promise=this._get(uri,headers,forceTwilsock).then(function(response){_this3._activeGetRequests.delete(uri);return response;}).catch(function(error){_this3._activeGetRequests.delete(uri);throw error;});this._activeGetRequests.set(uri,promise);return promise;}/**
     * @private
     */},{key:'_oneOfBasedOnChannelAvailability',value:function _oneOfBasedOnChannelAvailability(sendingOptions,forceTwilsock){var _this4=this;var requestVia=function requestVia(paths){var sendViaTwilsock=paths.sendViaTwilsock,sendDirectHttp=paths.sendDirectHttp;if(_this4._twilsockIsAvailable){return sendViaTwilsock();}return!forceTwilsock?sendDirectHttp():_promise2.default.reject(new TwilsockUnavailableError());};return requestVia(sendingOptions).then(lowercaseHeaders);}/**
     * @private
     */},{key:'_get',value:function _get(uri,headers,forceTwilsock){var _this5=this;return this._oneOfBasedOnChannelAvailability({sendViaTwilsock:function sendViaTwilsock(){return _this5._twilsock.send(twilsockParams('GET',uri,headers)).then(adaptTwilsockResponse);},sendDirectHttp:function sendDirectHttp(){return _this5._http.get(httpParams(uri,headers)).then(adaptHttpResponse);}},forceTwilsock);}/**
     * Make a POST request by given URI
     * @returns {Promise<Response>} Result of successful request
     */},{key:'post',value:function post(uri,headers,body,forceTwilsock){var _this6=this;return this._oneOfBasedOnChannelAvailability({sendViaTwilsock:function sendViaTwilsock(){return _this6._twilsock.send(twilsockParams('POST',uri,headers,body)).then(adaptTwilsockResponse);},sendDirectHttp:function sendDirectHttp(){return _this6._http.post(httpParams(uri,headers,body)).then(adaptHttpResponse);}},forceTwilsock);}/**
     * Make a PUT request by given URI
     * @returns Promise<Response> Result of successful request
     */},{key:'put',value:function put(uri,headers,body,forceTwilsock){var _this7=this;return this._oneOfBasedOnChannelAvailability({sendViaTwilsock:function sendViaTwilsock(){return _this7._twilsock.send(twilsockParams('PUT',uri,headers,body)).then(adaptTwilsockResponse);},sendDirectHttp:function sendDirectHttp(){return _this7._http.put(httpParams(uri,headers,body)).then(adaptHttpResponse);}},forceTwilsock);}/**
     * Make a DELETE request by given URI
     * @returns {Promise<Response>} Result of successful request
     */},{key:'delete',value:function _delete(uri,headers,forceTwilsock){var _this8=this;return this._oneOfBasedOnChannelAvailability({sendViaTwilsock:function sendViaTwilsock(){return _this8._twilsock.send(twilsockParams('DELETE',uri,headers)).then(adaptTwilsockResponse);},sendDirectHttp:function sendDirectHttp(){return _this8._http.delete(httpParams(uri,headers)).then(adaptHttpResponse);}},forceTwilsock);}}]);return Transport;}();exports.default=Transport;exports.Transport=Transport;exports.TwilsockUnavailableError=TwilsockUnavailableError;},{"./httprequest":213,"babel-runtime/core-js/array/from":1,"babel-runtime/core-js/map":5,"babel-runtime/core-js/object/create":8,"babel-runtime/core-js/object/define-properties":9,"babel-runtime/core-js/object/define-property":10,"babel-runtime/core-js/object/get-prototype-of":12,"babel-runtime/core-js/object/keys":13,"babel-runtime/core-js/object/set-prototype-of":14,"babel-runtime/core-js/promise":15,"babel-runtime/core-js/reflect/construct":16,"babel-runtime/helpers/typeof":27}],215:[function(_dereq_,module,exports){'use strict';Object.defineProperty(exports,"__esModule",{value:true});var _freeze=_dereq_('babel-runtime/core-js/object/freeze');var _freeze2=_interopRequireDefault(_freeze);var _set=_dereq_('babel-runtime/core-js/set');var _set2=_interopRequireDefault(_set);var _promise=_dereq_('babel-runtime/core-js/promise');var _promise2=_interopRequireDefault(_promise);var _map=_dereq_('babel-runtime/core-js/map');var _map2=_interopRequireDefault(_map);var _defineProperties=_dereq_('babel-runtime/core-js/object/define-properties');var _defineProperties2=_interopRequireDefault(_defineProperties);var _getPrototypeOf=_dereq_('babel-runtime/core-js/object/get-prototype-of');var _getPrototypeOf2=_interopRequireDefault(_getPrototypeOf);var _classCallCheck2=_dereq_('babel-runtime/helpers/classCallCheck');var _classCallCheck3=_interopRequireDefault(_classCallCheck2);var _createClass2=_dereq_('babel-runtime/helpers/createClass');var _createClass3=_interopRequireDefault(_createClass2);var _possibleConstructorReturn2=_dereq_('babel-runtime/helpers/possibleConstructorReturn');var _possibleConstructorReturn3=_interopRequireDefault(_possibleConstructorReturn2);var _inherits2=_dereq_('babel-runtime/helpers/inherits');var _inherits3=_interopRequireDefault(_inherits2);var _events=_dereq_('events');var _events2=_interopRequireDefault(_events);var _logger=_dereq_('./logger');var _logger2=_interopRequireDefault(_logger);var _uuid=_dereq_('uuid');var _uuid2=_interopRequireDefault(_uuid);var _configuration=_dereq_('./configuration');var _configuration2=_interopRequireDefault(_configuration);var _twilsock=_dereq_('./twilsock');var _twilsock2=_interopRequireDefault(_twilsock);var _packetinterface=_dereq_('./packetinterface');var _packetinterface2=_interopRequireDefault(_packetinterface);function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj};}/**
 * @class
 * @alias Twilsock
 * @classdesc Client library for the Twilsock protocol
 * @property {Boolean} connected Indicates the twilsock connection state
 *
 * @constructor
 * @param {string} Token Twilio access token
 */var TwilsockClient=function(_EventEmitter){(0,_inherits3.default)(TwilsockClient,_EventEmitter);function TwilsockClient(token,options){(0,_classCallCheck3.default)(this,TwilsockClient);var _this=(0,_possibleConstructorReturn3.default)(this,(TwilsockClient.__proto__||(0,_getPrototypeOf2.default)(TwilsockClient)).call(this));options=options||{};options.logLevel=options.logLevel||'error';_logger2.default.setLevel(options.logLevel);var config=new _configuration2.default(token,options);var twilsock=new _twilsock2.default(config);var packetInterface=new _packetinterface2.default(twilsock);(0,_defineProperties2.default)(_this,{_config:{value:config},_socket:{value:twilsock},_packet:{value:packetInterface},_registrations:{value:new _map2.default()},_registrationsInProgress:{value:new _map2.default()},isConnected:{get:function get(){return _this._socket.isConnected;}},connected:{get:function get(){return _this._socket.isConnected;}},state:{get:function get(){return _this._socket.state;}}});_this._socket.on('message',function(type,message){return setTimeout(function(){_this.emit('message',type,message);},0);});_this._socket.on('connected',function(){return _this._updateRegistrations();});_this._socket.on('connected',function(uri){return _this.emit('connected',uri);});_this._socket.on('disconnected',function(){return _this.emit('disconnected');});_this._socket.on('stateChanged',function(state){return _this.emit('stateChanged',state);});return _this;}/**
   * Send a message
   * @param {Twilsock#Message} message Message structure with header, body and remote address
   * @public
   * @returns {Promise<Result>} Result from remote side
   */(0,_createClass3.default)(TwilsockClient,[{key:'send',value:function send(message){return this._packet.send(message.to,message.headers,message.body);}/**
     * Update token
     * @param {String} token
     * @public
     */},{key:'updateToken',value:function updateToken(token){var _this2=this;_logger2.default.info('updateToken');if(this._config.token===token){return _promise2.default.resolve();}this._config.updateToken(token);this._socket.disconnect().then(function(){return _this2._socket.connect();});return _promise2.default.resolve();}},{key:'_updateRegistration',value:function _updateRegistration(contextId,context){var _this3=this;_logger2.default.info('update registration for context',contextId);var registrationAttempts=this._registrationsInProgress.get(contextId);if(!registrationAttempts){registrationAttempts=new _set2.default();this._registrationsInProgress.set(contextId,registrationAttempts);}var attemptId=_uuid2.default.v4();registrationAttempts.add(attemptId);return this._packet.putNotificationContext(contextId,context).then(function(){_logger2.default.info('registration attempt succeeded for context',context);registrationAttempts.delete(attemptId);if(registrationAttempts.size===0){_this3._registrationsInProgress.delete(contextId);_this3.emit('registered',contextId);}}).catch(function(err){_logger2.default.info('registration attempt failed for context',context);_logger2.default.debug(err);registrationAttempts.delete(attemptId);if(registrationAttempts.size===0){_this3._registrationsInProgress.delete(contextId);_this3.emit('registrationFailed',contextId,err);}});}},{key:'_updateRegistrations',value:function _updateRegistrations(){var _this4=this;_logger2.default.info('refreshing all registrations');this._registrations.forEach(function(context,id){_this4._updateRegistration(id,context);});}},{key:'setNotificationsContext',value:function setNotificationsContext(contextId,context){if(!contextId||!context){throw new Error('Invalid arguments provided');}this._registrations.set(contextId,context);if(this._socket.isConnected){this._updateRegistration(contextId,context);}}},{key:'removeNotificationsContext',value:function removeNotificationsContext(contextId){if(!this._registrations.has(contextId)){return;}this._registrations.delete(contextId);if(this._socket.isConnected){this._packet.deleteNotificationContext(contextId);}}/**
     * Connect to the server
     * @fires TwilsockClient#connected
     * @public
     */},{key:'connect',value:function connect(){return this._socket.connect();}/**
     * Connect to the server
     * @fires TwilsockClient#disconnected
     * @public
     */},{key:'disconnect',value:function disconnect(){return this._socket.disconnect();}}]);return TwilsockClient;}(_events2.default);exports.default=TwilsockClient;(0,_freeze2.default)(TwilsockClient);/**
 * Twilsock destination address descriptor
 * @typedef {Object} Twilsock#Address
 * @property {String} method - HTTP method. (POST, PUT, etc)
 * @property {String} host - host name without path. (e.g. my.company.com)
 * @property {String} path - path on the host (e.g. /my/app/to/call.php)
 *//**
 * Twilsock upstream message
 * @typedef {Object} Twilsock#Message
 * @property {Twilsock#Address} to - destination address
 * @property {Object} headers - HTTP headers
 * @property {Object} body - Body
 *//**
 * Fired when new message received
 * @param {Object} message
 * @event TwilsockClient#message
 *//**
 * Fired when socket connected
 * @param {String} URI of endpoint
 * @event TwilsockClient#connected
 *//**
 * Fired when socket disconnected
 * @event TwilsockClient#disconnected
 */module.exports=exports['default'];},{"./configuration":216,"./logger":218,"./packetinterface":219,"./twilsock":220,"babel-runtime/core-js/map":5,"babel-runtime/core-js/object/define-properties":9,"babel-runtime/core-js/object/freeze":11,"babel-runtime/core-js/object/get-prototype-of":12,"babel-runtime/core-js/promise":15,"babel-runtime/core-js/set":17,"babel-runtime/helpers/classCallCheck":21,"babel-runtime/helpers/createClass":22,"babel-runtime/helpers/inherits":24,"babel-runtime/helpers/possibleConstructorReturn":25,"events":169,"uuid":224}],216:[function(_dereq_,module,exports){'use strict';Object.defineProperty(exports,"__esModule",{value:true});var _defineProperties=_dereq_('babel-runtime/core-js/object/define-properties');var _defineProperties2=_interopRequireDefault(_defineProperties);var _classCallCheck2=_dereq_('babel-runtime/helpers/classCallCheck');var _classCallCheck3=_interopRequireDefault(_classCallCheck2);var _createClass2=_dereq_('babel-runtime/helpers/createClass');var _createClass3=_interopRequireDefault(_createClass2);function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj};}var TWILSOCK_URI='wss://tsock.twilio.com';var TWILSOCK_PATH='/v2/wsconnect';/**
 * @param {String} token - authentication token
 * @param {Object} options - options to override defaults
 *
 * @class TwilsockConfig
 * @classdesc Settings container for the Twilsock client library
 */var TwilsockConfig=function(){function TwilsockConfig(token,options){var _this=this;(0,_classCallCheck3.default)(this,TwilsockConfig);options=options||{};var _options=options.Twilsock||{};var twilsockUri=_options.uri||options.wsServer||TWILSOCK_URI;(0,_defineProperties2.default)(this,{_twilsockWsHost:{value:twilsockUri+TWILSOCK_PATH},_token:{value:token,writable:true},twilsockUri:{get:function get(){return _this._twilsockWsHost;}},token:{get:function get(){return _this._token;}}});}(0,_createClass3.default)(TwilsockConfig,[{key:'updateToken',value:function updateToken(token){this._token=token;}}]);return TwilsockConfig;}();exports.default=TwilsockConfig;module.exports=exports['default'];},{"babel-runtime/core-js/object/define-properties":9,"babel-runtime/helpers/classCallCheck":21,"babel-runtime/helpers/createClass":22}],217:[function(_dereq_,module,exports){arguments[4][187][0].apply(exports,arguments);},{"./client":215,"dup":187}],218:[function(_dereq_,module,exports){'use strict';Object.defineProperty(exports,"__esModule",{value:true});var _from=_dereq_('babel-runtime/core-js/array/from');var _from2=_interopRequireDefault(_from);var _loglevel=_dereq_('loglevel');var _loglevel2=_interopRequireDefault(_loglevel);function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj};}function prepareLine(prefix,args){return[prefix].concat((0,_from2.default)(args));}exports.default={setLevel:function setLevel(level){_loglevel2.default.setLevel(level);},trace:function trace(){_loglevel2.default.trace.apply(null,prepareLine('Twilsock T:',arguments));},debug:function debug(){_loglevel2.default.debug.apply(null,prepareLine('Twilsock D:',arguments));},info:function info(){_loglevel2.default.info.apply(null,prepareLine('Twilsock I:',arguments));},warn:function warn(){_loglevel2.default.warn.apply(null,prepareLine('Twilsock W:',arguments));},error:function error(){_loglevel2.default.error.apply(null,prepareLine('Twilsock E:',arguments));}};module.exports=exports['default'];},{"babel-runtime/core-js/array/from":1,"loglevel":172}],219:[function(_dereq_,module,exports){'use strict';Object.defineProperty(exports,"__esModule",{value:true});var _promise=_dereq_('babel-runtime/core-js/promise');var _promise2=_interopRequireDefault(_promise);var _map=_dereq_('babel-runtime/core-js/map');var _map2=_interopRequireDefault(_map);var _defineProperties=_dereq_('babel-runtime/core-js/object/define-properties');var _defineProperties2=_interopRequireDefault(_defineProperties);var _classCallCheck2=_dereq_('babel-runtime/helpers/classCallCheck');var _classCallCheck3=_interopRequireDefault(_classCallCheck2);var _createClass2=_dereq_('babel-runtime/helpers/createClass');var _createClass3=_interopRequireDefault(_createClass2);var _logger=_dereq_('./logger');var _logger2=_interopRequireDefault(_logger);function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj};}var REQUEST_TIMEOUT=30000;function isHttpSuccess(code){return code>=200&&code<300;}function isHttpReply(packet){return packet&&packet.header&&packet.header.http_status;}var PacketInterface=function(){function PacketInterface(socket){var _this=this;(0,_classCallCheck3.default)(this,PacketInterface);(0,_defineProperties2.default)(this,{_activeRequests:{value:new _map2.default()},_socket:{value:socket}});this._socket.on('reply',this._processReply.bind(this));this._socket.on('disconnected',function(){_this._activeRequests.forEach(function(descriptor){clearTimeout(descriptor.timeout);descriptor.reject(new Error('Twilsock disconnected'));});_this._activeRequests.clear();});}(0,_createClass3.default)(PacketInterface,[{key:'_processReply',value:function _processReply(reply){var request=this._activeRequests.get(reply.id);if(request){clearTimeout(request.timeout);this._activeRequests.delete(reply.id);setTimeout(function(){// User shouldn't intercept connection handling, thus making it asynchronous
if(!isHttpSuccess(reply.status.code)){request.reject(new Error('Transport failure: '+reply.status.status));}else if(isHttpReply(reply)&&!isHttpSuccess(reply.header.http_status.code)){request.reject({status:reply.header.http_status.code,description:reply.header.http_status.status,body:reply.body});}else{request.resolve(reply);}},0);}}},{key:'_storeRequest',value:function _storeRequest(id,resolve,reject){var requestDescriptor={resolve:resolve,reject:reject,timeout:setTimeout(function(){_logger2.default.debug('request',id,'is timed out');reject(new Error('Twilsock: request timeout: '+id));},REQUEST_TIMEOUT)};this._activeRequests.set(id,requestDescriptor);}},{key:'send',value:function send(address,headers,body){var _this2=this;return new _promise2.default(function(resolve,reject){var id=_this2._socket.sendUpstreamMessage(address,headers,body);_logger2.default.trace('message sent: ',{id:id,address:address,headers:headers,body:body});_this2._storeRequest(id,resolve,reject);});}},{key:'putNotificationContext',value:function putNotificationContext(contextId,context){var _this3=this;return new _promise2.default(function(resolve,reject){var header={method:'put_notification_ctx',notification_ctx_id:contextId};// eslint-disable-line camelcase
var id=_this3._socket.send(header,context);_this3._storeRequest(id,resolve,reject);});}},{key:'deleteNotificationContext',value:function deleteNotificationContext(contextId){var _this4=this;return new _promise2.default(function(resolve,reject){var packet={method:'delete_notification_ctx',notification_ctx_id:contextId};// eslint-disable-line camelcase
var id=_this4._socket.send(packet);_this4._storeRequest(id,resolve,reject);});}},{key:'shutdown',value:function shutdown(){this._activeRequests.forEach(function(descriptor){clearTimeout(descriptor.timeout);descriptor.reject(new Error('Twilsock: request cancelled by user'));});this._activeRequests.clear();}}]);return PacketInterface;}();exports.default=PacketInterface;module.exports=exports['default'];},{"./logger":218,"babel-runtime/core-js/map":5,"babel-runtime/core-js/object/define-properties":9,"babel-runtime/core-js/promise":15,"babel-runtime/helpers/classCallCheck":21,"babel-runtime/helpers/createClass":22}],220:[function(_dereq_,module,exports){(function(global){'use strict';Object.defineProperty(exports,"__esModule",{value:true});var _freeze=_dereq_('babel-runtime/core-js/object/freeze');var _freeze2=_interopRequireDefault(_freeze);var _promise=_dereq_('babel-runtime/core-js/promise');var _promise2=_interopRequireDefault(_promise);var _defineProperties=_dereq_('babel-runtime/core-js/object/define-properties');var _defineProperties2=_interopRequireDefault(_defineProperties);var _getPrototypeOf=_dereq_('babel-runtime/core-js/object/get-prototype-of');var _getPrototypeOf2=_interopRequireDefault(_getPrototypeOf);var _classCallCheck2=_dereq_('babel-runtime/helpers/classCallCheck');var _classCallCheck3=_interopRequireDefault(_classCallCheck2);var _createClass2=_dereq_('babel-runtime/helpers/createClass');var _createClass3=_interopRequireDefault(_createClass2);var _possibleConstructorReturn2=_dereq_('babel-runtime/helpers/possibleConstructorReturn');var _possibleConstructorReturn3=_interopRequireDefault(_possibleConstructorReturn2);var _inherits2=_dereq_('babel-runtime/helpers/inherits');var _inherits3=_interopRequireDefault(_inherits2);var _stringify=_dereq_('babel-runtime/core-js/json/stringify');var _stringify2=_interopRequireDefault(_stringify);var _typeof2=_dereq_('babel-runtime/helpers/typeof');var _typeof3=_interopRequireDefault(_typeof2);var _events=_dereq_('events');var _events2=_interopRequireDefault(_events);var _logger=_dereq_('./logger');var _logger2=_interopRequireDefault(_logger);var _uuid=_dereq_('uuid');var _uuid2=_interopRequireDefault(_uuid);var _backoff=_dereq_('backoff');var _backoff2=_interopRequireDefault(_backoff);var _javascriptStateMachine=_dereq_('javascript-state-machine');var _javascriptStateMachine2=_interopRequireDefault(_javascriptStateMachine);function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj};}var WebSocket=global.WebSocket||global.MozWebSocket||_dereq_('ws');var ACTIVITY_CHECK_INTERVAL=5000;var ACTIVITY_TIMEOUT=43000;function byteLength(s){var escstr=encodeURIComponent(s);var binstr=escstr.replace(/%([0-9A-F]{2})/g,function(match,p1){return String.fromCharCode('0x'+p1);});return binstr.length;}function stringToUint8Array(s){var escstr=encodeURIComponent(s);var binstr=escstr.replace(/%([0-9A-F]{2})/g,function(match,p1){return String.fromCharCode('0x'+p1);});var ua=new Uint8Array(binstr.length);Array.prototype.forEach.call(binstr,function(ch,i){ua[i]=ch.charCodeAt(0);});return ua;}function uint8ArrayToString(ua){var binstr=Array.prototype.map.call(ua,function(ch){return String.fromCharCode(ch);}).join('');var escstr=binstr.replace(/(.)/g,function(m,p){var code=p.charCodeAt(0).toString(16).toUpperCase();if(code.length<2){code='0'+code;}return'%'+code;});return decodeURIComponent(escstr);}function getMagic(buffer){var strMagic='';var idx=0;for(;idx<buffer.length;++idx){var chr=String.fromCharCode(buffer[idx]);strMagic+=chr;if(chr==='\r'){idx+=2;break;}}var magics=strMagic.split(' ');return{size:idx,protocol:magics[0],version:magics[1],headerSize:Number(magics[2])};}/**
 * Makes sure that body is properly stringified
 */function preparePayload(payload){switch(typeof payload==='undefined'?'undefined':(0,_typeof3.default)(payload)){case'undefined':return'';case'object':return(0,_stringify2.default)(payload);default:return payload;}}/**
 * @param {Uint8Array} array
 * @returns {Object}
 */function getJsonObject(array){var str=uint8ArrayToString(array);try{return JSON.parse(str);}catch(e){_logger2.default.error('failed to parse input: ',str);throw e;}}/**
 * @class TwilsockChannel
 * @classdesc Twilsock connection
 *
 * @param config
 */var TwilsockChannel=function(_EventEmitter){(0,_inherits3.default)(TwilsockChannel,_EventEmitter);function TwilsockChannel(config){var _arguments=arguments;(0,_classCallCheck3.default)(this,TwilsockChannel);var _this=(0,_possibleConstructorReturn3.default)(this,(TwilsockChannel.__proto__||(0,_getPrototypeOf2.default)(TwilsockChannel)).call(this));var backoff=_backoff2.default.exponential({randomisationFactor:0.2,initialDelay:2*1000,maxDelay:2*60*1000});backoff.on('ready',function(){_this._retry();});(0,_defineProperties2.default)(_this,{_config:{value:config},_transportReady:{value:false,writable:true},_disconnectedPromiseResolve:{value:null,writable:true},_backoff:{value:backoff},_fsm:{value:null,writable:true},_watchTimer:{value:null,writable:true},_timestamp:{value:0,writable:true},_socket:{value:null,writable:true},_activeToken:{value:null,writable:true},activeToken:{enumerable:true,get:function get(){return _this._activeToken;}},state:{enumberable:true,get:function get(){return _this._getState();}},isConnected:{enumberable:true,get:function get(){return _this._isConnected();}}});_this._fsm=_javascriptStateMachine2.default.create({initial:'disconnected',events:[{name:'userConnect',from:['error','disconnected'],to:'connecting'},{name:'userDisconnect',from:['connecting','connected','retrying'],to:'disconnecting'},{name:'userDisconnect',from:['rejected'],to:'disconnected'},{name:'userRetry',from:['retrying'],to:'connecting'},{name:'socketConnected',from:['connecting'],to:'connected'},{name:'socketClosed',from:['connecting','connected','error'],to:'retrying'},{name:'socketError',from:['connected'],to:'retrying'},{name:'socketClosed',from:['disconnecting'],to:'disconnected'},{name:'socketRejected',from:['connecting','connected'],to:'disconnecting'},{name:'tokenRejected',from:['connecting','connected'],to:'rejected'},{name:'evUnsupported',from:['connecting'],to:'unsupported'},{name:'evUnsupported',from:['connected'],to:'error'},{name:'protocolError',from:['connecting','connected'],to:'error'}],callbacks:{onconnecting:function onconnecting(){_this._startWatchdogTimer();_this._setupSocket();_this.emit('connecting');},onretrying:function onretrying(){_this._initRetry();_this.emit('connecting');},onenterconnected:_this._onConnected.bind(_this),onuserDisconnect:function onuserDisconnect(){_this._closeSocket();},ondisconnected:function ondisconnected(){return _this._finalizeSocket();},onsocketRejected:function onsocketRejected(){var args=Array.prototype.slice.call(_arguments,3,_arguments.length);_this._onSocketRejected(args);},onunsupported:function onunsupported(){_this._closeSocket();_this._finalizeSocket();},onrejected:function onrejected(){_this._closeSocket();_this._finalizeSocket();},onerror:function onerror(){_this._closeSocket();_this._finalizeSocket();},onenterstate:function onenterstate(){_this.emit('stateChanged',_this.state);}},error:function error(){_logger2.default.trace('FSM: unexpected transition',arguments);}});return _this;}/**
   * Checks if connection established
   * @public
   */(0,_createClass3.default)(TwilsockChannel,[{key:'_isConnected',value:function _isConnected(){return this.state===TwilsockChannel.state.CONNECTED&&this._socket&&this._socket.readyState===1;}/**
     * @returns {Number} Connection state
     * @public
     */},{key:'_getState',value:function _getState(){if(!this._fsm){return TwilsockChannel.state.DISCONNECTED;}switch(this._fsm.current){case'connecting':case'retrying':return TwilsockChannel.state.CONNECTING;case'connected':return TwilsockChannel.state.CONNECTED;case'rejected':return TwilsockChannel.state.REJECTED;case'disconnecting':return TwilsockChannel.state.DISCONNECTING;case'disconnected':case'error':default:return TwilsockChannel.state.DISCONNECTED;}}},{key:'_initRetry',value:function _initRetry(){this._backoff.backoff();}},{key:'_retry',value:function _retry(){this._socket=null;this._activeToken=null;this._fsm.userRetry();}},{key:'_onConnected',value:function _onConnected(){this._backoff.reset();this.emit('connected',this._wschannelUrl);}},{key:'_finalizeSocket',value:function _finalizeSocket(){this._stopWatchdogTimer();this._onDisconnected();if(this._disconnectedPromiseResolve){var resolve=this._disconnectedPromiseResolve;this._disconnectedPromiseResolve=null;resolve();}}},{key:'_onDisconnected',value:function _onDisconnected(){this._backoff.reset();this._wschannelUrl=null;this._socket=null;this._activeToken=null;this.emit('disconnected');}},{key:'_setupSocket',value:function _setupSocket(){var self=this;var token=this._config.token;var uri=this._config.twilsockUri+'?token='+encodeURIComponent(token);var socket=new WebSocket(uri);socket.binaryType='arraybuffer';socket.onopen=function(){_logger2.default.info('socket opened');};socket.onclose=function(e){_logger2.default.info('socket closed',e);self._fsm.socketClosed();};socket.onerror=function(e){_logger2.default.error('error: ',e);// self._fsm.socketError();
};socket.onmessage=function(message){_logger2.default.trace('data: ',message.data);var fieldMargin=2;var dataView=new Uint8Array(message.data);var magic=getMagic(dataView);if(magic.protocol!=='TWILSOCK'||magic.version!=='V1.0'){_logger2.default.error('unsupported protocol: '+magic.protocol+' ver '+magic.version);self._fsm.evUnsupported('Unsupported protocol');return;}var header=null;try{header=getJsonObject(dataView.subarray(magic.size,magic.size+magic.headerSize));}catch(e){_logger2.default.error('failed to parse message header',e,message);self._fsm.protocolError();return;}_logger2.default.trace('message received: ',header);var payload=null;if(header.payload_size>0){var payloadOffset=fieldMargin+magic.size+magic.headerSize;var payloadSize=header.payload_size;if(!header.hasOwnProperty('payload_type')||header.payload_type.indexOf('application/json')===0){try{payload=getJsonObject(dataView.subarray(payloadOffset,payloadOffset+payloadSize));}catch(e){_logger2.default.error('failed to parse message body',e,message);self._fsm.protocolError();return;}}else if(header.payload_type.indexOf('text/plain')===0){payload=uint8ArrayToString(dataView.subarray(payloadOffset,payloadOffset+payloadSize));}}self._updateActivityTimestamp();if(header.method==='ready'){_logger2.default.trace('ready',payload);self._wschannelUrl=payload.wschannel_url;self._confirmReceiving(header);self._fsm.socketConnected();}else if(header.method==='notification'){self._confirmReceiving(header);self.emit('message',header.message_type,payload);}else if(header.method==='reply'){self.emit('reply',{id:header.id,status:header.status,header:header,body:payload});}else if(header.method==='ping'){self._confirmReceiving(header);}else if(header.method==='close'){_logger2.default.trace('connection close initated by server');self._confirmReceiving(header);if(payload&&(payload.code===401||payload.code===410)){self._fsm.tokenRejected(payload);}else{self._fsm.socketRejected(payload);}}};this._activeToken=token;this._socket=socket;}/**
     * Should be called for each message to confirm it received
     */},{key:'_confirmReceiving',value:function _confirmReceiving(messageHeader){var header={method:'reply',id:messageHeader.id,payload_type:'application/json',// eslint-disable-line camelcase
status:{code:200,status:'OK'}};try{this._sendPacket(header);}catch(e){_logger2.default.debug('failed to confirm packet receiving',e);}}/**
     * Prepare binary packet and send it over the network
     */},{key:'_sendPacket',value:function _sendPacket(header,payload){var payloadString=preparePayload(payload);header.payload_size=byteLength(payloadString);// eslint-disable-line camelcase
var headerString=(0,_stringify2.default)(header)+'\r\n';var magicString='TWILSOCK V1.0 '+(byteLength(headerString)-2)+'\r\n';var message=stringToUint8Array(magicString+headerString+payloadString);try{this._socket.send(message.buffer);}catch(e){_logger2.default.info('failed to send ',header,e);_logger2.default.info(e.stack);throw e;}}/**
     * Cancels pending retry attempt if it exists
     * @private
     */},{key:'_cancelRetryAttempt',value:function _cancelRetryAttempt(){this._backoff.reset();}/**
     * Shutdown connection
     * @private
     */},{key:'_closeSocket',value:function _closeSocket(){this._cancelRetryAttempt();if(this._socket){this._socket.onopen=null;this._socket.onclose=null;this._socket.onerror=null;this._socket.onmessage=null;this._socket.close();}this._fsm.socketClosed();}/**
     * Initiate the twilsock connection
     * If already connected, it does nothing
     */},{key:'connect',value:function connect(){this._fsm.userConnect();}/**
     * Close twilsock connection
     * If already disconnected, it does nothing
     */},{key:'disconnect',value:function disconnect(){var _this2=this;if(this._fsm.is('disconnected')){return _promise2.default.resolve();}return new _promise2.default(function(resolve){_this2._disconnectedPromiseResolve=resolve;_this2._fsm.userDisconnect();});}/**
     * Send upstream message
     * @returns {String} id of sent message
     */},{key:'sendUpstreamMessage',value:function sendUpstreamMessage(address,headers,body){var id=_uuid2.default.v4();var httpHeader={host:address.host,path:address.path,method:address.method};if(address.hasOwnProperty('params')){httpHeader.params=address.params;}/* eslint-disable camelcase */var twilsockHeader={method:'message',id:id,http_header:httpHeader};if(headers){twilsockHeader.http_header.headers=headers;}if(headers&&headers.hasOwnProperty('Content-Type')){twilsockHeader.payload_type=headers['Content-Type'];}this._sendPacket(twilsockHeader,body);return id;/* eslint-enable camelcase */}},{key:'send',value:function send(header,body){header.id=header.id||_uuid2.default.v4();this._sendPacket(header,body);return header.id;}/**
     * @private
     */},{key:'_onSocketRejected',value:function _onSocketRejected(reason){_logger2.default.error('connection closed by server',reason);this._closeSocket();}/**
     * @private
     */},{key:'_startWatchdogTimer',value:function _startWatchdogTimer(){var _this3=this;this._timestamp=Date.now();this._watchTimer=setInterval(function(){if(Date.now()-_this3._timestamp>ACTIVITY_TIMEOUT&&_this3._socket){_this3._socket.close();}},ACTIVITY_CHECK_INTERVAL);}/**
     * @private
     */},{key:'_stopWatchdogTimer',value:function _stopWatchdogTimer(){clearInterval(this._watchTimer);}/**
     * @private
     */},{key:'_updateActivityTimestamp',value:function _updateActivityTimestamp(){this._timestamp=Date.now();}}]);return TwilsockChannel;}(_events2.default);/**
 * Enum for connection state values.
 * @readonly
 * @enum {number}
 */exports.default=TwilsockChannel;TwilsockChannel.state={DISCONNECTED:'disconnected',CONNECTING:'connecting',CONNECTED:'connected',DISCONNECTING:'disconnecting',ERROR:'error',REJECTED:'rejected'};(0,_freeze2.default)(TwilsockChannel.state);(0,_freeze2.default)(TwilsockChannel);module.exports=exports['default'];}).call(this,typeof global!=="undefined"?global:typeof self!=="undefined"?self:typeof window!=="undefined"?window:{});},{"./logger":218,"babel-runtime/core-js/json/stringify":4,"babel-runtime/core-js/object/define-properties":9,"babel-runtime/core-js/object/freeze":11,"babel-runtime/core-js/object/get-prototype-of":12,"babel-runtime/core-js/promise":15,"babel-runtime/helpers/classCallCheck":21,"babel-runtime/helpers/createClass":22,"babel-runtime/helpers/inherits":24,"babel-runtime/helpers/possibleConstructorReturn":25,"babel-runtime/helpers/typeof":27,"backoff":29,"events":169,"javascript-state-machine":170,"uuid":224,"ws":40}],221:[function(_dereq_,module,exports){if(typeof Object.create==='function'){// implementation from standard node.js 'util' module
module.exports=function inherits(ctor,superCtor){ctor.super_=superCtor;ctor.prototype=Object.create(superCtor.prototype,{constructor:{value:ctor,enumerable:false,writable:true,configurable:true}});};}else{// old school shim for old browsers
module.exports=function inherits(ctor,superCtor){ctor.super_=superCtor;var TempCtor=function TempCtor(){};TempCtor.prototype=superCtor.prototype;ctor.prototype=new TempCtor();ctor.prototype.constructor=ctor;};}},{}],222:[function(_dereq_,module,exports){module.exports=function isBuffer(arg){return arg&&(typeof arg==="undefined"?"undefined":_typeof4(arg))==='object'&&typeof arg.copy==='function'&&typeof arg.fill==='function'&&typeof arg.readUInt8==='function';};},{}],223:[function(_dereq_,module,exports){(function(process,global){// Copyright Joyent, Inc. and other Node contributors.
//
// Permission is hereby granted, free of charge, to any person obtaining a
// copy of this software and associated documentation files (the
// "Software"), to deal in the Software without restriction, including
// without limitation the rights to use, copy, modify, merge, publish,
// distribute, sublicense, and/or sell copies of the Software, and to permit
// persons to whom the Software is furnished to do so, subject to the
// following conditions:
//
// The above copyright notice and this permission notice shall be included
// in all copies or substantial portions of the Software.
//
// THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS
// OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF
// MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN
// NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM,
// DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR
// OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE
// USE OR OTHER DEALINGS IN THE SOFTWARE.
var formatRegExp=/%[sdj%]/g;exports.format=function(f){if(!isString(f)){var objects=[];for(var i=0;i<arguments.length;i++){objects.push(inspect(arguments[i]));}return objects.join(' ');}var i=1;var args=arguments;var len=args.length;var str=String(f).replace(formatRegExp,function(x){if(x==='%%')return'%';if(i>=len)return x;switch(x){case'%s':return String(args[i++]);case'%d':return Number(args[i++]);case'%j':try{return JSON.stringify(args[i++]);}catch(_){return'[Circular]';}default:return x;}});for(var x=args[i];i<len;x=args[++i]){if(isNull(x)||!isObject(x)){str+=' '+x;}else{str+=' '+inspect(x);}}return str;};// Mark that a method should not be used.
// Returns a modified function which warns once by default.
// If --no-deprecation is set, then it is a no-op.
exports.deprecate=function(fn,msg){// Allow for deprecating things in the process of starting up.
if(isUndefined(global.process)){return function(){return exports.deprecate(fn,msg).apply(this,arguments);};}if(process.noDeprecation===true){return fn;}var warned=false;function deprecated(){if(!warned){if(process.throwDeprecation){throw new Error(msg);}else if(process.traceDeprecation){console.trace(msg);}else{console.error(msg);}warned=true;}return fn.apply(this,arguments);}return deprecated;};var debugs={};var debugEnviron;exports.debuglog=function(set){if(isUndefined(debugEnviron))debugEnviron=process.env.NODE_DEBUG||'';set=set.toUpperCase();if(!debugs[set]){if(new RegExp('\\b'+set+'\\b','i').test(debugEnviron)){var pid=process.pid;debugs[set]=function(){var msg=exports.format.apply(exports,arguments);console.error('%s %d: %s',set,pid,msg);};}else{debugs[set]=function(){};}}return debugs[set];};/**
 * Echos the value of a value. Trys to print the value out
 * in the best way possible given the different types.
 *
 * @param {Object} obj The object to print out.
 * @param {Object} opts Optional options object that alters the output.
 *//* legacy: obj, showHidden, depth, colors*/function inspect(obj,opts){// default options
var ctx={seen:[],stylize:stylizeNoColor};// legacy...
if(arguments.length>=3)ctx.depth=arguments[2];if(arguments.length>=4)ctx.colors=arguments[3];if(isBoolean(opts)){// legacy...
ctx.showHidden=opts;}else if(opts){// got an "options" object
exports._extend(ctx,opts);}// set default options
if(isUndefined(ctx.showHidden))ctx.showHidden=false;if(isUndefined(ctx.depth))ctx.depth=2;if(isUndefined(ctx.colors))ctx.colors=false;if(isUndefined(ctx.customInspect))ctx.customInspect=true;if(ctx.colors)ctx.stylize=stylizeWithColor;return formatValue(ctx,obj,ctx.depth);}exports.inspect=inspect;// http://en.wikipedia.org/wiki/ANSI_escape_code#graphics
inspect.colors={'bold':[1,22],'italic':[3,23],'underline':[4,24],'inverse':[7,27],'white':[37,39],'grey':[90,39],'black':[30,39],'blue':[34,39],'cyan':[36,39],'green':[32,39],'magenta':[35,39],'red':[31,39],'yellow':[33,39]};// Don't use 'blue' not visible on cmd.exe
inspect.styles={'special':'cyan','number':'yellow','boolean':'yellow','undefined':'grey','null':'bold','string':'green','date':'magenta',// "name": intentionally not styling
'regexp':'red'};function stylizeWithColor(str,styleType){var style=inspect.styles[styleType];if(style){return"\x1B["+inspect.colors[style][0]+'m'+str+"\x1B["+inspect.colors[style][1]+'m';}else{return str;}}function stylizeNoColor(str,styleType){return str;}function arrayToHash(array){var hash={};array.forEach(function(val,idx){hash[val]=true;});return hash;}function formatValue(ctx,value,recurseTimes){// Provide a hook for user-specified inspect functions.
// Check that value is an object with an inspect function on it
if(ctx.customInspect&&value&&isFunction(value.inspect)&&// Filter out the util module, it's inspect function is special
value.inspect!==exports.inspect&&// Also filter out any prototype objects using the circular check.
!(value.constructor&&value.constructor.prototype===value)){var ret=value.inspect(recurseTimes,ctx);if(!isString(ret)){ret=formatValue(ctx,ret,recurseTimes);}return ret;}// Primitive types cannot have properties
var primitive=formatPrimitive(ctx,value);if(primitive){return primitive;}// Look up the keys of the object.
var keys=Object.keys(value);var visibleKeys=arrayToHash(keys);if(ctx.showHidden){keys=Object.getOwnPropertyNames(value);}// IE doesn't make error fields non-enumerable
// http://msdn.microsoft.com/en-us/library/ie/dww52sbt(v=vs.94).aspx
if(isError(value)&&(keys.indexOf('message')>=0||keys.indexOf('description')>=0)){return formatError(value);}// Some type of object without properties can be shortcutted.
if(keys.length===0){if(isFunction(value)){var name=value.name?': '+value.name:'';return ctx.stylize('[Function'+name+']','special');}if(isRegExp(value)){return ctx.stylize(RegExp.prototype.toString.call(value),'regexp');}if(isDate(value)){return ctx.stylize(Date.prototype.toString.call(value),'date');}if(isError(value)){return formatError(value);}}var base='',array=false,braces=['{','}'];// Make Array say that they are Array
if(isArray(value)){array=true;braces=['[',']'];}// Make functions say that they are functions
if(isFunction(value)){var n=value.name?': '+value.name:'';base=' [Function'+n+']';}// Make RegExps say that they are RegExps
if(isRegExp(value)){base=' '+RegExp.prototype.toString.call(value);}// Make dates with properties first say the date
if(isDate(value)){base=' '+Date.prototype.toUTCString.call(value);}// Make error with message first say the error
if(isError(value)){base=' '+formatError(value);}if(keys.length===0&&(!array||value.length==0)){return braces[0]+base+braces[1];}if(recurseTimes<0){if(isRegExp(value)){return ctx.stylize(RegExp.prototype.toString.call(value),'regexp');}else{return ctx.stylize('[Object]','special');}}ctx.seen.push(value);var output;if(array){output=formatArray(ctx,value,recurseTimes,visibleKeys,keys);}else{output=keys.map(function(key){return formatProperty(ctx,value,recurseTimes,visibleKeys,key,array);});}ctx.seen.pop();return reduceToSingleString(output,base,braces);}function formatPrimitive(ctx,value){if(isUndefined(value))return ctx.stylize('undefined','undefined');if(isString(value)){var simple='\''+JSON.stringify(value).replace(/^"|"$/g,'').replace(/'/g,"\\'").replace(/\\"/g,'"')+'\'';return ctx.stylize(simple,'string');}if(isNumber(value))return ctx.stylize(''+value,'number');if(isBoolean(value))return ctx.stylize(''+value,'boolean');// For some reason typeof null is "object", so special case here.
if(isNull(value))return ctx.stylize('null','null');}function formatError(value){return'['+Error.prototype.toString.call(value)+']';}function formatArray(ctx,value,recurseTimes,visibleKeys,keys){var output=[];for(var i=0,l=value.length;i<l;++i){if(hasOwnProperty(value,String(i))){output.push(formatProperty(ctx,value,recurseTimes,visibleKeys,String(i),true));}else{output.push('');}}keys.forEach(function(key){if(!key.match(/^\d+$/)){output.push(formatProperty(ctx,value,recurseTimes,visibleKeys,key,true));}});return output;}function formatProperty(ctx,value,recurseTimes,visibleKeys,key,array){var name,str,desc;desc=Object.getOwnPropertyDescriptor(value,key)||{value:value[key]};if(desc.get){if(desc.set){str=ctx.stylize('[Getter/Setter]','special');}else{str=ctx.stylize('[Getter]','special');}}else{if(desc.set){str=ctx.stylize('[Setter]','special');}}if(!hasOwnProperty(visibleKeys,key)){name='['+key+']';}if(!str){if(ctx.seen.indexOf(desc.value)<0){if(isNull(recurseTimes)){str=formatValue(ctx,desc.value,null);}else{str=formatValue(ctx,desc.value,recurseTimes-1);}if(str.indexOf('\n')>-1){if(array){str=str.split('\n').map(function(line){return'  '+line;}).join('\n').substr(2);}else{str='\n'+str.split('\n').map(function(line){return'   '+line;}).join('\n');}}}else{str=ctx.stylize('[Circular]','special');}}if(isUndefined(name)){if(array&&key.match(/^\d+$/)){return str;}name=JSON.stringify(''+key);if(name.match(/^"([a-zA-Z_][a-zA-Z_0-9]*)"$/)){name=name.substr(1,name.length-2);name=ctx.stylize(name,'name');}else{name=name.replace(/'/g,"\\'").replace(/\\"/g,'"').replace(/(^"|"$)/g,"'");name=ctx.stylize(name,'string');}}return name+': '+str;}function reduceToSingleString(output,base,braces){var numLinesEst=0;var length=output.reduce(function(prev,cur){numLinesEst++;if(cur.indexOf('\n')>=0)numLinesEst++;return prev+cur.replace(/\u001b\[\d\d?m/g,'').length+1;},0);if(length>60){return braces[0]+(base===''?'':base+'\n ')+' '+output.join(',\n  ')+' '+braces[1];}return braces[0]+base+' '+output.join(', ')+' '+braces[1];}// NOTE: These type checking functions intentionally don't use `instanceof`
// because it is fragile and can be easily faked with `Object.create()`.
function isArray(ar){return Array.isArray(ar);}exports.isArray=isArray;function isBoolean(arg){return typeof arg==='boolean';}exports.isBoolean=isBoolean;function isNull(arg){return arg===null;}exports.isNull=isNull;function isNullOrUndefined(arg){return arg==null;}exports.isNullOrUndefined=isNullOrUndefined;function isNumber(arg){return typeof arg==='number';}exports.isNumber=isNumber;function isString(arg){return typeof arg==='string';}exports.isString=isString;function isSymbol(arg){return(typeof arg==="undefined"?"undefined":_typeof4(arg))==='symbol';}exports.isSymbol=isSymbol;function isUndefined(arg){return arg===void 0;}exports.isUndefined=isUndefined;function isRegExp(re){return isObject(re)&&objectToString(re)==='[object RegExp]';}exports.isRegExp=isRegExp;function isObject(arg){return(typeof arg==="undefined"?"undefined":_typeof4(arg))==='object'&&arg!==null;}exports.isObject=isObject;function isDate(d){return isObject(d)&&objectToString(d)==='[object Date]';}exports.isDate=isDate;function isError(e){return isObject(e)&&(objectToString(e)==='[object Error]'||e instanceof Error);}exports.isError=isError;function isFunction(arg){return typeof arg==='function';}exports.isFunction=isFunction;function isPrimitive(arg){return arg===null||typeof arg==='boolean'||typeof arg==='number'||typeof arg==='string'||(typeof arg==="undefined"?"undefined":_typeof4(arg))==='symbol'||// ES6 symbol
typeof arg==='undefined';}exports.isPrimitive=isPrimitive;exports.isBuffer=_dereq_('./support/isBuffer');function objectToString(o){return Object.prototype.toString.call(o);}function pad(n){return n<10?'0'+n.toString(10):n.toString(10);}var months=['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];// 26 Feb 16:19:34
function timestamp(){var d=new Date();var time=[pad(d.getHours()),pad(d.getMinutes()),pad(d.getSeconds())].join(':');return[d.getDate(),months[d.getMonth()],time].join(' ');}// log is just a thin wrapper to console.log that prepends a timestamp
exports.log=function(){console.log('%s - %s',timestamp(),exports.format.apply(exports,arguments));};/**
 * Inherit the prototype methods from one constructor into another.
 *
 * The Function.prototype.inherits from lang.js rewritten as a standalone
 * function (not on Function.prototype). NOTE: If this file is to be loaded
 * during bootstrapping this function needs to be rewritten using some native
 * functions as prototype setup using normal JavaScript does not work as
 * expected during bootstrapping (see mirror.js in r114903).
 *
 * @param {function} ctor Constructor function which needs to inherit the
 *     prototype.
 * @param {function} superCtor Constructor function to inherit prototype from.
 */exports.inherits=_dereq_('inherits');exports._extend=function(origin,add){// Don't do anything if add isn't an object
if(!add||!isObject(add))return origin;var keys=Object.keys(add);var i=keys.length;while(i--){origin[keys[i]]=add[keys[i]];}return origin;};function hasOwnProperty(obj,prop){return Object.prototype.hasOwnProperty.call(obj,prop);}}).call(this,_dereq_('_process'),typeof global!=="undefined"?global:typeof self!=="undefined"?self:typeof window!=="undefined"?window:{});},{"./support/isBuffer":222,"_process":178,"inherits":221}],224:[function(_dereq_,module,exports){var v1=_dereq_('./v1');var v4=_dereq_('./v4');var uuid=v4;uuid.v1=v1;uuid.v4=v4;module.exports=uuid;},{"./v1":227,"./v4":228}],225:[function(_dereq_,module,exports){/**
 * Convert array of 16 byte values to UUID string format of the form:
 * XXXXXXXX-XXXX-XXXX-XXXX-XXXX-XXXXXXXXXXXX
 */var byteToHex=[];for(var i=0;i<256;++i){byteToHex[i]=(i+0x100).toString(16).substr(1);}function bytesToUuid(buf,offset){var i=offset||0;var bth=byteToHex;return bth[buf[i++]]+bth[buf[i++]]+bth[buf[i++]]+bth[buf[i++]]+'-'+bth[buf[i++]]+bth[buf[i++]]+'-'+bth[buf[i++]]+bth[buf[i++]]+'-'+bth[buf[i++]]+bth[buf[i++]]+'-'+bth[buf[i++]]+bth[buf[i++]]+bth[buf[i++]]+bth[buf[i++]]+bth[buf[i++]]+bth[buf[i++]];}module.exports=bytesToUuid;},{}],226:[function(_dereq_,module,exports){(function(global){// Unique ID creation requires a high quality random # generator.  In the
// browser this is a little complicated due to unknown quality of Math.random()
// and inconsistent support for the `crypto` API.  We do the best we can via
// feature-detection
var rng;var crypto=global.crypto||global.msCrypto;// for IE 11
if(crypto&&crypto.getRandomValues){// WHATWG crypto RNG - http://wiki.whatwg.org/wiki/Crypto
var rnds8=new Uint8Array(16);rng=function whatwgRNG(){crypto.getRandomValues(rnds8);return rnds8;};}if(!rng){// Math.random()-based (RNG)
//
// If all else fails, use Math.random().  It's fast, but is of unspecified
// quality.
var rnds=new Array(16);rng=function rng(){for(var i=0,r;i<16;i++){if((i&0x03)===0)r=Math.random()*0x100000000;rnds[i]=r>>>((i&0x03)<<3)&0xff;}return rnds;};}module.exports=rng;}).call(this,typeof global!=="undefined"?global:typeof self!=="undefined"?self:typeof window!=="undefined"?window:{});},{}],227:[function(_dereq_,module,exports){// Unique ID creation requires a high quality random # generator.  We feature
// detect to determine the best RNG source, normalizing to a function that
// returns 128-bits of randomness, since that's what's usually required
var rng=_dereq_('./lib/rng');var bytesToUuid=_dereq_('./lib/bytesToUuid');// **`v1()` - Generate time-based UUID**
//
// Inspired by https://github.com/LiosK/UUID.js
// and http://docs.python.org/library/uuid.html
// random #'s we need to init node and clockseq
var _seedBytes=rng();// Per 4.5, create and 48-bit node id, (47 random bits + multicast bit = 1)
var _nodeId=[_seedBytes[0]|0x01,_seedBytes[1],_seedBytes[2],_seedBytes[3],_seedBytes[4],_seedBytes[5]];// Per 4.2.2, randomize (14 bit) clockseq
var _clockseq=(_seedBytes[6]<<8|_seedBytes[7])&0x3fff;// Previous uuid creation time
var _lastMSecs=0,_lastNSecs=0;// See https://github.com/broofa/node-uuid for API details
function v1(options,buf,offset){var i=buf&&offset||0;var b=buf||[];options=options||{};var clockseq=options.clockseq!==undefined?options.clockseq:_clockseq;// UUID timestamps are 100 nano-second units since the Gregorian epoch,
// (1582-10-15 00:00).  JSNumbers aren't precise enough for this, so
// time is handled internally as 'msecs' (integer milliseconds) and 'nsecs'
// (100-nanoseconds offset from msecs) since unix epoch, 1970-01-01 00:00.
var msecs=options.msecs!==undefined?options.msecs:new Date().getTime();// Per 4.2.1.2, use count of uuid's generated during the current clock
// cycle to simulate higher resolution clock
var nsecs=options.nsecs!==undefined?options.nsecs:_lastNSecs+1;// Time since last uuid creation (in msecs)
var dt=msecs-_lastMSecs+(nsecs-_lastNSecs)/10000;// Per 4.2.1.2, Bump clockseq on clock regression
if(dt<0&&options.clockseq===undefined){clockseq=clockseq+1&0x3fff;}// Reset nsecs if clock regresses (new clockseq) or we've moved onto a new
// time interval
if((dt<0||msecs>_lastMSecs)&&options.nsecs===undefined){nsecs=0;}// Per 4.2.1.2 Throw error if too many uuids are requested
if(nsecs>=10000){throw new Error('uuid.v1(): Can\'t create more than 10M uuids/sec');}_lastMSecs=msecs;_lastNSecs=nsecs;_clockseq=clockseq;// Per 4.1.4 - Convert from unix epoch to Gregorian epoch
msecs+=12219292800000;// `time_low`
var tl=((msecs&0xfffffff)*10000+nsecs)%0x100000000;b[i++]=tl>>>24&0xff;b[i++]=tl>>>16&0xff;b[i++]=tl>>>8&0xff;b[i++]=tl&0xff;// `time_mid`
var tmh=msecs/0x100000000*10000&0xfffffff;b[i++]=tmh>>>8&0xff;b[i++]=tmh&0xff;// `time_high_and_version`
b[i++]=tmh>>>24&0xf|0x10;// include version
b[i++]=tmh>>>16&0xff;// `clock_seq_hi_and_reserved` (Per 4.2.2 - include variant)
b[i++]=clockseq>>>8|0x80;// `clock_seq_low`
b[i++]=clockseq&0xff;// `node`
var node=options.node||_nodeId;for(var n=0;n<6;++n){b[i+n]=node[n];}return buf?buf:bytesToUuid(b);}module.exports=v1;},{"./lib/bytesToUuid":225,"./lib/rng":226}],228:[function(_dereq_,module,exports){var rng=_dereq_('./lib/rng');var bytesToUuid=_dereq_('./lib/bytesToUuid');function v4(options,buf,offset){var i=buf&&offset||0;if(typeof options=='string'){buf=options=='binary'?new Array(16):null;options=null;}options=options||{};var rnds=options.random||(options.rng||rng)();// Per 4.4, set bits for version and `clock_seq_hi_and_reserved`
rnds[6]=rnds[6]&0x0f|0x40;rnds[8]=rnds[8]&0x3f|0x80;// Copy bytes to buffer, if provided
if(buf){for(var ii=0;ii<16;++ii){buf[i+ii]=rnds[ii];}}return buf||bytesToUuid(rnds);}module.exports=v4;},{"./lib/bytesToUuid":225,"./lib/rng":226}],229:[function(_dereq_,module,exports){module.exports={"name":"twilio-chat","version":"0.12.0","description":"A library for Twilio IP messaging","main":"lib/index.js","author":"Twilio","license":"MIT","dependencies":{"babel-runtime":"^6.18.0","backoff":"^2.5.0","durational":"^1.1.0","loglevel":"^1.4.1","platform":"^1.3.3","rfc6902":"^1.3.0","twilio-ems-client":"^0.1.5","twilio-notifications":"^0.3.0","twilio-sync":"^0.4.2","twilio-transport":"^0.1.1","twilsock":"^0.2.2","uuid":"^3.0.1"},"devDependencies":{"async":"^2.1.4","async-test-tools":"^1.0.6","babel-eslint":"^7.1.1","babel-plugin-add-module-exports":"^0.2.1","babel-plugin-transform-async-to-generator":"^6.22.0","babel-plugin-transform-object-assign":"^6.22.0","babel-plugin-transform-runtime":"^6.22.0","babel-preset-es2015":"^6.22.0","babel-runtime":"^6.22.0","babelify":"^7.3.0","browserify":"^14.0.0","browserify-replace":"^0.9.0","chai":"^3.5.0","chai-as-promised":"^6.0.0","cheerio":"^0.22.0","del":"^2.2.2","event-to-promise":"^0.7.0","express":"^4.14.1","gulp":"^3.9.1","gulp-derequire":"^2.1.0","gulp-eslint":"^3.0.1","gulp-exit":"0.0.2","gulp-insert":"^0.5.0","gulp-istanbul":"^1.1.1","gulp-mocha":"^3.0.1","gulp-rename":"^1.2.2","gulp-replace":"^0.5.4","gulp-tap":"^0.1.3","gulp-uglify":"^2.0.1","ink-docstrap":"^1.3.0","isparta":"^4.0.0","jsdoc":"^3.4.3","jsdoc-strip-async-await":"^0.1.0","karma":"^1.4.1","karma-browserify":"^5.1.1","karma-browserstack-launcher":"^1.2.0","karma-mocha":"^1.3.0","karma-mocha-reporter":"^2.2.2","karma-sinon-ie":"^2.0.0","loglevel-message-prefix":"^2.0.1","mocha.parallel":"^0.14.0","proxyquire":"^1.7.11","run-sequence":"^1.2.2","sinon":"^1.17.7","sinon-as-promised":"^4.0.2","sinon-chai":"^2.8.0","twilio":"^2.11.1","vinyl-buffer":"^1.0.0","vinyl-source-stream":"^1.1.0","watchify":"^3.9.0"},"engines":{"node":">=6"}};},{}],230:[function(_dereq_,module,exports){'use strict';var _freeze=_dereq_('babel-runtime/core-js/object/freeze');var _freeze2=_interopRequireDefault(_freeze);var _getIterator2=_dereq_('babel-runtime/core-js/get-iterator');var _getIterator3=_interopRequireDefault(_getIterator2);var _promise=_dereq_('babel-runtime/core-js/promise');var _promise2=_interopRequireDefault(_promise);var _defineProperties=_dereq_('babel-runtime/core-js/object/define-properties');var _defineProperties2=_interopRequireDefault(_defineProperties);var _map=_dereq_('babel-runtime/core-js/map');var _map2=_interopRequireDefault(_map);var _stringify=_dereq_('babel-runtime/core-js/json/stringify');var _stringify2=_interopRequireDefault(_stringify);var _getPrototypeOf=_dereq_('babel-runtime/core-js/object/get-prototype-of');var _getPrototypeOf2=_interopRequireDefault(_getPrototypeOf);var _classCallCheck2=_dereq_('babel-runtime/helpers/classCallCheck');var _classCallCheck3=_interopRequireDefault(_classCallCheck2);var _createClass2=_dereq_('babel-runtime/helpers/createClass');var _createClass3=_interopRequireDefault(_createClass2);var _possibleConstructorReturn2=_dereq_('babel-runtime/helpers/possibleConstructorReturn');var _possibleConstructorReturn3=_interopRequireDefault(_possibleConstructorReturn2);var _inherits2=_dereq_('babel-runtime/helpers/inherits');var _inherits3=_interopRequireDefault(_inherits2);function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj};}var EventEmitter=_dereq_('events').EventEmitter;var MembersEntity=_dereq_('./data/members');var Member=_dereq_('./member');var MessagesEntity=_dereq_('./data/messages');var log=_dereq_('./logger');var isDeepEqual=_dereq_('./util').isDeepEqual;var UriBuilder=_dereq_('./util').UriBuilder;var fieldMappings={attributes:'attributes',createdBy:'createdBy',dateCreated:'dateCreated',dateUpdated:'dateUpdated',friendlyName:'friendlyName',lastConsumedMessageIndex:'lastConsumedMessageIndex',name:'friendlyName',sid:'sid',status:'status',type:'type',uniqueName:'uniqueName'};function parseTime(timeString){try{return new Date(timeString);}catch(e){return null;}}function filterStatus(status){switch(status){case'notParticipating':return'known';default:return status;}}/**
 * @classdesc A Channel represents a remote channel of communication between
 * multiple IP Messaging Clients.
 * @property {Object} attributes - The Channel's custom attributes.
 * @property {String} createdBy - The identity of the User that created this Channel.
 * @property {Date} dateCreated - The Date this Channel was created.
 * @property {Date} dateUpdated - The Date this Channel was last updated.
 * @property {String} friendlyName - The Channel's name.
 * @property {Boolean} isPrivate - Whether the channel is private (as opposed to public).
 * @property {Number} lastConsumedMessageIndex - Index of the last Message the User has consumed in this Channel.
 * @property {String} sid - The Channel's unique system identifier.
 * @property {Enumeration} status - Whether the Channel is 'known' to local Client, Client is 'invited' to or
 *   is 'joined' to this Channel.
 * @property {Enumeration} type - The Channel's type as a String: ['private', 'public']
 * @property {String} uniqueName - The Channel's unique name (tag).
 *
 * @fires Channel#memberJoined
 * @fires Channel#memberLeft
 * @fires Channel#memberUpdated
 * @fires Channel#memberInfoUpdated
 * @fires Channel#messageAdded
 * @fires Channel#messageRemoved
 * @fires Channel#messageUpdated
 * @fires Channel#typingEnded
 * @fires Channel#typingStarted
 * @fires Channel#updated
 */var Channel=function(_EventEmitter){(0,_inherits3.default)(Channel,_EventEmitter);function Channel(services,data,sid){(0,_classCallCheck3.default)(this,Channel);var _this=(0,_possibleConstructorReturn3.default)(this,(Channel.__proto__||(0,_getPrototypeOf2.default)(Channel)).call(this));var attributes=data.attributes||{};var createdBy=data.createdBy;var dateCreated=parseTime(data.dateCreated);var dateUpdated=parseTime(data.dateUpdated);var friendlyName=data.name||data.friendlyName||null;var lastConsumedMessageIndex=typeof data.lastConsumedMessageIndex!=='undefined'?data.lastConsumedMessageIndex:null;var status='known';var type=data.type||Channel.type.PUBLIC;var uniqueName=data.uniqueName||null;var entityName=data.channel;if(data.isPrivate){type=Channel.type.PRIVATE;}try{(0,_stringify2.default)(attributes);}catch(e){throw new Error('Attributes must be a valid JSON object.');}var members=new _map2.default();var membersEntity=new MembersEntity(_this,services.session,services.userInfos,members);membersEntity.on('memberJoined',_this.emit.bind(_this,'memberJoined'));membersEntity.on('memberLeft',_this.emit.bind(_this,'memberLeft'));membersEntity.on('memberUpdated',_this.emit.bind(_this,'memberUpdated'));membersEntity.on('memberInfoUpdated',_this.emit.bind(_this,'memberInfoUpdated'));var messages=[];var messagesEntity=new MessagesEntity(_this,services.session,messages);messagesEntity.on('messageAdded',function(message){return _this._onMessageAdded(message);});messagesEntity.on('messageUpdated',_this.emit.bind(_this,'messageUpdated'));messagesEntity.on('messageRemoved',_this.emit.bind(_this,'messageRemoved'));(0,_defineProperties2.default)(_this,{_attributes:{get:function get(){return attributes;},set:function set(_attributes){return attributes=_attributes;}},_createdBy:{get:function get(){return createdBy;},set:function set(_createdBy){return createdBy=_createdBy;}},_dateCreated:{get:function get(){return dateCreated;},set:function set(_dateCreated){return dateCreated=_dateCreated;}},_dateUpdated:{get:function get(){return dateUpdated;},set:function set(_dateUpdated){return dateUpdated=_dateUpdated;}},_friendlyName:{get:function get(){return friendlyName;},set:function set(_friendlyName){return friendlyName=_friendlyName;}},_lastConsumedMessageIndex:{get:function get(){return lastConsumedMessageIndex;},set:function set(_lastConsumedMessageIndex){return lastConsumedMessageIndex=_lastConsumedMessageIndex;}},_type:{get:function get(){return type;},set:function set(_type){return type=_type;}},_sid:{get:function get(){return sid;},set:function set(_sid){return sid=_sid;}},_status:{get:function get(){return status;},set:function set(_status){return status=_status;}},_uniqueName:{get:function get(){return uniqueName;},set:function set(_uniqueName){return uniqueName=_uniqueName;}},_entityPromise:{value:null,writable:true},_subscribePromise:{value:null,writable:true},_membersEntity:{value:membersEntity},_messagesEntity:{value:messagesEntity},_services:{value:services},_session:{value:services.session},_typingIndicator:{value:services.typingIndicator},_consumptionHorizon:{value:services.consumptionHorizon},_entityName:{value:entityName,writable:true},_members:{value:members},_messages:{value:messages},attributes:{enumerable:true,get:function get(){return attributes;}},createdBy:{enumerable:true,get:function get(){return createdBy;}},dateCreated:{enumerable:true,get:function get(){return dateCreated;}},dateUpdated:{enumerable:true,get:function get(){return dateUpdated;}},friendlyName:{enumerable:true,get:function get(){return friendlyName;}},isPrivate:{enumerable:true,get:function get(){return _this._type===Channel.type.PRIVATE;}},lastConsumedMessageIndex:{enumerable:true,get:function get(){return lastConsumedMessageIndex;}},sid:{enumerable:true,get:function get(){return sid;}},status:{enumerable:true,get:function get(){return status;}},type:{enumerable:true,get:function get(){return type;}},uniqueName:{enumerable:true,get:function get(){return uniqueName;}}});return _this;}/**
   * Load and Subscribe to this Channel and do not subscribe to its Members and Messages.
   * This or _subscribeStreams will need to be called before any events on Channel will fire.
   * @returns {Promise}
   * @private
   */(0,_createClass3.default)(Channel,[{key:'_subscribe',value:function _subscribe(){var _this2=this;if(this._entityPromise){return this._entityPromise;}this._entityPromise=this._session.datasync.document({uniqueName:this._entityName,mode:'open'}).then(function(doc){_this2._entity=doc;doc.on('updated',function(value){return _this2._update(value);});_this2._update(doc.value);return _this2._entity;}).catch(function(err){_this2._enityPromise=null;log.error('Failed to get channel object',err);throw err;});return this._entityPromise;}/**
     * Load the attributes of this Channel and instantiate its Members and Messages.
     * This or _subscribe will need to be called before any events on Channel will fire.
     * This will need to be called before any events on Members or Messages will fire
     * @returns {Promise}
     * @private
     */},{key:'_subscribeStreams',value:function _subscribeStreams(){var _this3=this;this._subscribePromise=this._subscribePromise||this._subscribe().then(function(entity){var messagesObjectName=entity.value.messages;var rosterObjectName=entity.value.roster;return _promise2.default.all([_this3._messagesEntity.subscribe(messagesObjectName),_this3._membersEntity.subscribe(rosterObjectName)]);}).then(function(){return _this3._entity;}).catch(function(err){_this3._subscribePromise=null;log.error('Failed to subscribe on channel objects',_this3.sid,err);throw err;});return this._subscribePromise;}/**
     * Load the Channel state.
     * @returns {Promise}
     * @private
     */},{key:'_fetch',value:function _fetch(){return this._session.datasync.document({uniqueName:this._entityName,mode:'open'}).then(function(doc){return doc.value;});}/**
     * Stop listening for and firing events on this Channel.
     * @returns {Promise}
     * @private
     */},{key:'_unsubscribe',value:function _unsubscribe(){var promises=[];if(this._entityPromise){promises.push(this._entity.close());}promises.push(this._membersEntity.unsubscribe());promises.push(this._messagesEntity.unsubscribe());this._entityPromise=null;this._subscribePromise=null;return _promise2.default.all(promises);}/**
     * Set channel status
     * @private
     */},{key:'_setStatus',value:function _setStatus(status){if(this._status===status){return;}this._status=status;if(status===Channel.status.JOINED){this._subscribeStreams();}else if(status===Channel.status.INVITED){this._subscribe();}else if(this._entityPromise){this._unsubscribe();}}},{key:'_update',/**
     * Updates local channel object with new values
     * @private
     */value:function _update(update){Channel._preprocessUpdate(update,this._sid);var updated=false;for(var key in update){var localKey=fieldMappings[key];if(!localKey){continue;}if(localKey===fieldMappings.status){this._status=filterStatus(update.status);}else if(localKey===fieldMappings.attributes){if(!isDeepEqual(this._attributes,update.attributes)){this._attributes=update.attributes;updated=true;}}else if(update[key]instanceof Date){if(!this[localKey]||this[localKey].getTime()!==update[key].getTime()){this['_'+localKey]=update[key];updated=true;}}else if(this[localKey]!==update[key]){this['_'+localKey]=update[key];updated=true;}}// if uniqueName is not present in the update - then we should set it to null on the client object
if(!update.status&&!update.uniqueName){if(this._uniqueName){this._uniqueName=null;updated=true;}}if(updated){this.emit('updated',this);}}/**
     * @private
     */},{key:'_onMessageAdded',value:function _onMessageAdded(message){var _iteratorNormalCompletion=true;var _didIteratorError=false;var _iteratorError=undefined;try{for(var _iterator=(0,_getIterator3.default)(this._members.values()),_step;!(_iteratorNormalCompletion=(_step=_iterator.next()).done);_iteratorNormalCompletion=true){var member=_step.value;if(member.identity===message.author){member._endTyping();break;}}}catch(err){_didIteratorError=true;_iteratorError=err;}finally{try{if(!_iteratorNormalCompletion&&_iterator.return){_iterator.return();}}finally{if(_didIteratorError){throw _iteratorError;}}}this.emit('messageAdded',message);}/**
     * Add a participant to the Channel by its Identity.
     * @param {String} identity - Identity of the Client to add.
     * @returns {Promise}
     */},{key:'add',value:function add(identity){if(!identity||typeof identity!=='string'){return _promise2.default.reject(new Error('Channel.add requires an <String>identity parameter'));}return this._membersEntity.add(identity);}/**
     * Advance last consumed Channel's Message index to current consumption horizon.
     * Last consumed Message index is updated only if new index value is higher than previous.
     * @param {Number} index - Message index to advance to as last read.
     * @returns {Promise}
     */},{key:'advanceLastConsumedMessageIndex',value:function advanceLastConsumedMessageIndex(index){var _this4=this;if(parseInt(index)!==index){var err='Channel.advanceLastConsumedMessageIndex requires an integral <Number>index parameter';return _promise2.default.reject(new Error(err));}if(this.lastConsumedMessageIndex!==null&&index<=this.lastConsumedMessageIndex||0){return _promise2.default.resolve();}return this._subscribeStreams().then(function(){_this4._consumptionHorizon.advanceLastConsumedMessageIndexForChannel(_this4.sid,index);}).then(function(){return _this4;});}/**
     * Decline an invitation to the Channel.
     * @returns {Promise<Channel|SessionError>}
     */},{key:'decline',value:function decline(){var _this5=this;return this._session.addCommand('declineInvitation',{channelSid:this._sid}).then(function(){return _this5;});}/**
     * Delete the Channel.
     * @returns {Promise<Channel|SessionError>}
     */},{key:'delete',value:function _delete(){var _this6=this;return this._session.addCommand('destroyChannel',{channelSid:this._sid}).then(function(){return _this6;});}/**
     * Get the custom attributes of this channel.
     * NOTE: Attributes will be empty in public channels until this is called.
     * However, private channels will already have this due to back-end limitation.
     * @returns {Promise<Object>}
     */},{key:'getAttributes',value:function getAttributes(){var _this7=this;if(this._entityPromise){return this._subscribe().then(function(){return _this7.attributes;});}return this._fetch().then(function(data){_this7._update(data);return _this7.attributes;});}/**
     * Returns messages from channel using paginator interface
     * @param {Number} [pageSize=30] Number of messages to return in single chunk.
     * @param {Number} [anchor] - Index of newest Message to fetch. From the end by default.
     * @param {String} [direction=backwards] - Query direction. By default it query backwards
     *                                         from newer to older. 'forward' will query in opposite direction.
     * @returns {Promise<Paginator<Message>>} page of messages
     */},{key:'getMessages',value:function getMessages(count,anchor,direction){var _this8=this;return this._subscribeStreams().then(function(){return _this8._messagesEntity.getMessages(count,anchor,direction);});}/**
     * Get a list of all Members joined to this Channel.
     * @returns {Promise<Array<Member>>}
     */},{key:'getMembers',value:function getMembers(){var _this9=this;return this._subscribeStreams().then(function(){return _this9._membersEntity.getMembers();});}/**
     * Get channel members count
     * @returns {Promise<integer>}
     */},{key:'getMembersCount',value:function getMembersCount(){var _this10=this;return this._session.getSessionLinks().then(function(links){return new UriBuilder(links.publicChannelsUrl).path(_this10.sid).build();}).then(function(url){return _this10._services.network.get(url);}).then(function(response){return response.body.members_count;});}/**
     * Get total message count in a channel
     * @returns {Promise<integer>}
     */},{key:'getMessagesCount',value:function getMessagesCount(){var _this11=this;return this._session.getSessionLinks().then(function(links){return new UriBuilder(links.publicChannelsUrl).path(_this11.sid).build();}).then(function(url){return _this11._services.network.get(url);}).then(function(response){return response.body.messages_count;});}/**
     * Get unconsumed messages count
     * @returns {Promise<integer>}
     */},{key:'getUnconsumedMessagesCount',value:function getUnconsumedMessagesCount(){var _this12=this;return this._session.getSessionLinks().then(function(links){return new UriBuilder(links.myChannelsUrl).arg('ChannelSid',_this12.sid).build();}).then(function(url){return _this12._services.network.get(url);}).then(function(response){if(response.body.channels.length){return response.body.channels[0].unread_messages_count||0;}var err='Channel is not in user channels list';return _promise2.default.reject(new Error(err));});}/**
     * Invite a user to the Channel by their Identity.
     * @param {String} identity - Identity of the user to invite.
     * @returns {Promise}
     */},{key:'invite',value:function invite(identity){if(typeof identity!=='string'||!identity.length){return _promise2.default.reject(new Error('Channel.invite requires an <String>identity parameter'));}return this._membersEntity.invite(identity);}/**
     * Join the Channel.
     * @returns {Promise<Channel|SessionError>}
     */},{key:'join',value:function join(){var _this13=this;return this._session.addCommand('joinChannel',{channelSid:this._sid}).then(function(){return _this13;});}/**
     * Leave the Channel.
     * @returns {Promise<Channel|SessionError>}
     */},{key:'leave',value:function leave(){var _this14=this;if(this._status!==Channel.status.JOINED){return _promise2.default.resolve(this);}return this._session.addCommand('leaveChannel',{channelSid:this._sid}).then(function(){return _this14;});}/**
     * Remove a Member from the Channel.
     * @param {Member|String} member - The Member (Or identity) to remove.
     * @returns {Promise<Member>}
     */},{key:'removeMember',value:function removeMember(member){if(!member||typeof member!=='string'&&!(member instanceof Member)){return _promise2.default.reject(new Error('Channel.removeMember requires a <String|Member>member parameter.'));}return this._membersEntity.remove(typeof member==='string'?member:member.identity);}/**
     * Send a Message on the Channel.
     * @param {String} messageBody - The message body.
     * @param {Object} messageAttributes - attributes for the message
     * @returns {Promise<String>} A Promise for the message ID
     */},{key:'sendMessage',value:function sendMessage(messageBody,messageAttributes){return this._messagesEntity.send(messageBody,messageAttributes).then(function(response){return response.messageId;});}/**
     * Set last consumed Channel's Message index to last known Message's index in this Channel.
     * @returns {Promise}
     */},{key:'setAllMessagesConsumed',value:function setAllMessagesConsumed(){var _this15=this;return this._subscribeStreams().then(function(){return _this15.getMessages(1);}).then(function(messagesPage){if(messagesPage.items.length>0){_this15.advanceLastConsumedMessageIndex(messagesPage.items[0].index);}}).then(function(){return _this15;});}/**
     * Set all messages in the channel unread
     */},{key:'setNoMessagesConsumed',value:function setNoMessagesConsumed(){return this.updateLastConsumedMessageIndex(null);}/**
     * Send a notification to the server indicating that this Client is currently typing in this Channel.
     * @returns {Promise}
     */},{key:'typing',value:function typing(){return this._typingIndicator.send(this._sid);}/**
     * Update the Channel's attributes.
     * @param {Object} attributes - The new attributes object.
     * @returns {Promise<Channel|SessionError>} A Promise for the Channel
     */},{key:'updateAttributes',value:function updateAttributes(attributes){var _this16=this;if(!attributes){var err='Attributes is a required parameter for updateAttributes and it should be valid JSON';return _promise2.default.reject(new Error(err));}else if(attributes.constructor!==Object){return _promise2.default.reject(new Error('Attributes must be a valid JSON object.'));}return this._session.addCommand('editAttributes',{channelSid:this._sid,attributes:(0,_stringify2.default)(attributes)}).then(function(){return _this16;});}/**
     * Update the Channel's friendlyName.
     * @param {String} name - The new Channel friendlyName.
     * @returns {Promise<Channel|SessionError>} A Promise for the Channel
     */},{key:'updateFriendlyName',value:function updateFriendlyName(name){var _this17=this;if(this._friendlyName===name){return _promise2.default.resolve(this);}return this._session.addCommand('editFriendlyName',{channelSid:this._sid,friendlyName:name}).then(function(){return _this17;});}/**
     * Set last consumed Channel's Message index to current consumption horizon.
     * @param {Number|null} index - Message index to set as last read. Null if no messages have been read
     * @returns {Promise}
     */},{key:'updateLastConsumedMessageIndex',value:function updateLastConsumedMessageIndex(index){var _this18=this;if(index!==null&&parseInt(index)!==index){var err='Channel.updateLastConsumedMessageIndex requires an integral <Number>index parameter';return _promise2.default.reject(new Error(err));}return this._subscribeStreams().then(function(){_this18._consumptionHorizon.updateLastConsumedMessageIndexForChannel(_this18.sid,index);}).then(function(){return _this18;});}/**
     * Update the Channel's unique name (tag).
     * @param {String} uniqueName - The new Channel uniqueName.
     * @returns {Promise<Channel|SessionError>} A Promise for the Channel
     */},{key:'updateUniqueName',value:function updateUniqueName(uniqueName){var _this19=this;if(this._uniqueName===uniqueName){return _promise2.default.resolve(this);}return this._session.addCommand('editUniqueName',{channelSid:this._sid,uniqueName:uniqueName}).then(function(){return _this19;});}}],[{key:'_preprocessUpdate',value:function _preprocessUpdate(update,channelSid){try{if(typeof update.attributes==='string'){update.attributes=JSON.parse(update.attributes);}else if(update.attributes){(0,_stringify2.default)(update.attributes);}}catch(e){log.warn('Retrieved malformed attributes from the server for channel: '+channelSid);update.attributes={};}try{if(update.dateCreated){update.dateCreated=new Date(update.dateCreated);}}catch(e){log.warn('Retrieved malformed attributes from the server for channel: '+channelSid);delete update.dateCreated;}try{if(update.dateUpdated){update.dateUpdated=new Date(update.dateUpdated);}}catch(e){log.warn('Retrieved malformed attributes from the server for channel: '+channelSid);delete update.dateUpdated;}}}]);return Channel;}(EventEmitter);/**
 * The type of Channel (Public or private).
 * @readonly
 * @enum {String}
 */Channel.type={/** 'public' | This channel is Public. */PUBLIC:'public',/** 'private' | This channel is Private. */PRIVATE:'private'};/**
 * The status of the Channel, relative to the Client.
 * @readonly
 * @enum {String}
 */Channel.status={/** 'known' | This Client knows about the Channel, but the User is neither joined nor invited to it. */KNOWN:'known',/** 'invited' | This Client's User is invited to the Channel. */INVITED:'invited',/** 'joined' | This Client's User is joined to the Channel. */JOINED:'joined',/** 'failed' | This Channel is malformed, or has failed to load. */FAILED:'failed'};(0,_freeze2.default)(Channel.type);(0,_freeze2.default)(Channel.status);/**
 * Fired when a Member has joined the Channel.
 * @param {Member} member
 * @event Channel#memberJoined
 *//**
 * Fired when a Member has left the Channel.
 * @param {Member} member
 * @event Channel#memberLeft
 *//**
 * Fired when a Member's fields has been updated.
 * @param {Member} member
 * @event Channel#memberUpdated
 *//**
 * Fired when a Member's UserInfo fields has been updated.
 * @param {Member} member
 * @event Channel#memberInfoUpdated
 *//**
 * Fired when a new Message has been added to the Channel on the server.
 * @param {Message} message
 * @event Channel#messageAdded
 *//**
 * Fired when Message is removed from Channel's message list.
 * @param {Message} message
 * @event Channel#messageRemoved
 *//**
 * Fired when an existing Message's fields are updated with new values.
 * @param {Message} message
 * @event Channel#messageUpdated
 *//**
 * Fired when a member has stopped typing.
 * @param {Member} member
 * @event Channel#typingEnded
 *//**
 * Fired when a member has begun typing.
 * @param {Member} member
 * @event Channel#typingStarted
 *//**
 * Fired when the Channel's fields have been updated.
 * @param {Channel} channel
 * @event Channel#updated
 */module.exports=Channel;},{"./data/members":235,"./data/messages":236,"./logger":240,"./member":241,"./util":251,"babel-runtime/core-js/get-iterator":2,"babel-runtime/core-js/json/stringify":4,"babel-runtime/core-js/map":5,"babel-runtime/core-js/object/define-properties":9,"babel-runtime/core-js/object/freeze":11,"babel-runtime/core-js/object/get-prototype-of":12,"babel-runtime/core-js/promise":15,"babel-runtime/helpers/classCallCheck":21,"babel-runtime/helpers/createClass":22,"babel-runtime/helpers/inherits":24,"babel-runtime/helpers/possibleConstructorReturn":25,"events":169}],231:[function(_dereq_,module,exports){'use strict';var _defineProperties=_dereq_('babel-runtime/core-js/object/define-properties');var _defineProperties2=_interopRequireDefault(_defineProperties);var _classCallCheck2=_dereq_('babel-runtime/helpers/classCallCheck');var _classCallCheck3=_interopRequireDefault(_classCallCheck2);var _createClass2=_dereq_('babel-runtime/helpers/createClass');var _createClass3=_interopRequireDefault(_createClass2);function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj};}var log=_dereq_('./logger');function parseAttributes(attrs){try{return JSON.parse(attrs);}catch(e){log.warning('Failed to parse channel attributes',e);}return{};}function parseTime(timeString){try{return new Date(timeString);}catch(e){return null;}}/**
 * Contains channel information.
 * Unlike {@link Channel}, this information won't be updated in realtime.
 * To have a fresh data, user should query channel descriptors again.
 *
 * @property {String} sid Channel sid
 * @property {String} uniqueName Channel unique name
 * @property {String} friendlyName - The Channel's name.
 * @property {String} createdBy Identity of the User that created this Channel.
 * @property {Date} dateCreated Date this Channel was created.
 * @property {Date} dateUpdated Date this Channel was last updated.
 * @property {Object} attributes Channel's custom attributes.
 * @property {Integer} messagesCount Number of messages in a channel
 * @property {Integer} membersCount Number of memembers in a channel
 */var ChannelDescriptor=function(){/**
   * @param {Client} chat client instance
   * @param {Object} channel descriptor data object
   * @private
   */function ChannelDescriptor(client,descriptor){(0,_classCallCheck3.default)(this,ChannelDescriptor);(0,_defineProperties2.default)(this,{_client:{value:client},_descriptor:{value:descriptor},sid:{value:descriptor.sid,enumerable:true},channel:{value:descriptor.sid+'.channel',enumerable:true},uniqueName:{value:descriptor.unique_name,enumerable:true},friendlyName:{value:descriptor.friendly_name,enumerable:true},attributes:{value:parseAttributes(descriptor.attributes)},createdBy:{value:descriptor.created_by,enumerable:true},dateCreated:{value:parseTime(descriptor.date_created),enumerable:true},dateUpdated:{value:parseTime(descriptor.date_updated),enumerable:true},messagesCount:{value:descriptor.messages_count,enumerable:true},membersCount:{value:descriptor.members_count,enumerable:true},type:{value:descriptor.type,enumerable:true}});}/**
   * Get channel object from descriptor
   * @returns Promise<Channel>
   */(0,_createClass3.default)(ChannelDescriptor,[{key:'getChannel',value:function getChannel(){return this._client.getChannelBySid(this.sid);}}]);return ChannelDescriptor;}();module.exports=ChannelDescriptor;},{"./logger":240,"babel-runtime/core-js/object/define-properties":9,"babel-runtime/helpers/classCallCheck":21,"babel-runtime/helpers/createClass":22}],232:[function(_dereq_,module,exports){'use strict';var _freeze=_dereq_('babel-runtime/core-js/object/freeze');var _freeze2=_interopRequireDefault(_freeze);var _promise=_dereq_('babel-runtime/core-js/promise');var _promise2=_interopRequireDefault(_promise);var _defineProperties=_dereq_('babel-runtime/core-js/object/define-properties');var _defineProperties2=_interopRequireDefault(_defineProperties);var _getPrototypeOf=_dereq_('babel-runtime/core-js/object/get-prototype-of');var _getPrototypeOf2=_interopRequireDefault(_getPrototypeOf);var _classCallCheck2=_dereq_('babel-runtime/helpers/classCallCheck');var _classCallCheck3=_interopRequireDefault(_classCallCheck2);var _createClass2=_dereq_('babel-runtime/helpers/createClass');var _createClass3=_interopRequireDefault(_createClass2);var _possibleConstructorReturn2=_dereq_('babel-runtime/helpers/possibleConstructorReturn');var _possibleConstructorReturn3=_interopRequireDefault(_possibleConstructorReturn2);var _inherits2=_dereq_('babel-runtime/helpers/inherits');var _inherits3=_interopRequireDefault(_inherits2);function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj};}var EventEmitter=_dereq_('events').EventEmitter;var log=_dereq_('./logger');var NotificationClient=_dereq_('twilio-notifications');var TwilsockClient=_dereq_('twilsock');var Transport=_dereq_('twilio-transport').Transport;var SyncClient=_dereq_('twilio-sync').SyncClient;var Configuration=_dereq_('./configuration');var Session=_dereq_('./session');var ChannelsEntity=_dereq_('./data/channels');var PublicChannels=_dereq_('./data/publicchannels');var UserInfos=_dereq_('./data/userinfos');var TypingIndicator=_dereq_('./services/typingindicator');var ConsumptionHorizon=_dereq_('./services/consumptionhorizon');var Network=_dereq_('./services/network');var EmsClient=_dereq_('twilio-ems-client').EmsClient;var SDK_VERSION=_dereq_('./../package.json').version;var MSG_NO_TOKEN='A valid Twilio token should be provided';/**
 * @classdesc A Client provides an interface for the local
 *   User to interact with Channels. The Client constructor will
 *   synchronously return an instance of Client, and will hold
 *   any outgoing methods until it has asynchronously finished
 *   syncing with the server.
 * @property {Boolean} reachabilityEnabled - State of reachability feature
 * @property {Map<sid, Channel>} channels - A Map containing all Channels known locally on
 *   the Client. To ensure the Channels have loaded before getting a response, use
 *   {@link Client#getChannels}.
 * @property {UserInfo} userInfo - User information for logged in user
 * @property {Client#connectionState} connectionState - Connection state info
 *
 * @fires Client#channelAdded
 * @fires Client#channelInvited
 * @fires Client#channelJoined
 * @fires Client#channelLeft
 * @fires Client#channelRemoved
 * @fires Client#channelUpdated
 * @fires Client#memberJoined
 * @fires Client#memberLeft
 * @fires Client#memberUpdated
 * @fires Client#messageAdded
 * @fires Client#messageRemoved
 * @fires Client#messageUpdated
 * @fires Client#typingEnded
 * @fires Client#typingStarted
 * @fires Client#userInfoUpdated
 * @fires Client#connectionStateChanged
 */var Client=function(_EventEmitter){(0,_inherits3.default)(Client,_EventEmitter);/**
   * @param {string} token - Access token
   * @param {Client#ClientOptions} options - Options to customize the Client
   */function Client(token,options){(0,_classCallCheck3.default)(this,Client);var _this=(0,_possibleConstructorReturn3.default)(this,(Client.__proto__||(0,_getPrototypeOf2.default)(Client)).call(this));options=options||{};options.logLevel=options.logLevel||'error';options.productId='ip_messaging';if(!token){throw new Error(MSG_NO_TOKEN);}log.setLevel(options.logLevel);var config=new Configuration(null,options);options.twilsockClient=options.twilsockClient||new TwilsockClient(token,options);options.transport=options.transport||new Transport(options.twilsockClient,options);var emsClient=options.emsClient=options.emsClient||new EmsClient(options);options.notificationsClient=options.notificationsClient||new NotificationClient(token,options);options.syncClient=options.syncClient||new SyncClient(token,options);var sync=options.syncClient;var transport=options.transport;var twilsock=options.twilsockClient;var notifications=options.notificationsClient;var session=new Session(sync,transport,config);var sessionPromise=session.initialize(token);var network=new Network(config,session,transport);var userInfos=new UserInfos(session,sync,null);userInfos.on('userInfoUpdated',_this.emit.bind(_this,'userInfoUpdated'));var consumptionHorizon=new ConsumptionHorizon(config,session);var typingIndicator=new TypingIndicator(config,transport,notifications,_this.getChannelBySid.bind(_this));var channelsEntity=new ChannelsEntity({session:session,userInfos:userInfos,typingIndicator:typingIndicator,consumptionHorizon:consumptionHorizon,network:network,config:config});var channelsPromise=sessionPromise.then(function(){channelsEntity.on('channelAdded',_this.emit.bind(_this,'channelAdded'));channelsEntity.on('channelRemoved',_this.emit.bind(_this,'channelRemoved'));channelsEntity.on('channelInvited',_this.emit.bind(_this,'channelInvited'));channelsEntity.on('channelJoined',_this.emit.bind(_this,'channelJoined'));channelsEntity.on('channelLeft',_this.emit.bind(_this,'channelLeft'));channelsEntity.on('channelUpdated',_this.emit.bind(_this,'channelUpdated'));channelsEntity.on('memberJoined',_this.emit.bind(_this,'memberJoined'));channelsEntity.on('memberLeft',_this.emit.bind(_this,'memberLeft'));channelsEntity.on('memberUpdated',_this.emit.bind(_this,'memberUpdated'));channelsEntity.on('messageAdded',_this.emit.bind(_this,'messageAdded'));channelsEntity.on('messageUpdated',_this.emit.bind(_this,'messageUpdated'));channelsEntity.on('messageRemoved',_this.emit.bind(_this,'messageRemoved'));channelsEntity.on('typingStarted',_this.emit.bind(_this,'typingStarted'));channelsEntity.on('typingEnded',_this.emit.bind(_this,'typingEnded'));return channelsEntity.fetchChannels();}).then(function(){return channelsEntity;});notifications.on('transportReady',function(state){if(state){_this._connectionState=Client.connectionState.CONNECTED;_this._session.syncToken().catch(function(err){log.error('Failed to sync session token',err);});}else{switch(_this._twilsock.state){case'rejected':_this._connectionState=Client.connectionState.DENIED;break;default:_this._connectionState=Client.connectionState.CONNECTING;}}_this.emit('connectionStateChanged',_this._connectionState);});(0,_defineProperties2.default)(_this,{_config:{value:config},_fpaToken:{value:token,writable:true},_emsClient:{value:emsClient},_channelsPromise:{value:channelsPromise},_channels:{value:channelsEntity},_transport:{value:network},_datasync:{value:sync},_notifications:{value:notifications},_session:{value:session},_sessionPromise:{value:sessionPromise},_initializePromise:{value:null,writable:true},_twilsock:{value:twilsock},_typingIndicator:{value:typingIndicator},_userInfos:{value:userInfos},_publicChannels:{value:null,writable:true},_connectionState:{value:Client.connectionState.CONNECTING,writable:true},userInfo:{enumerable:true,get:function get(){return _this._userInfos.myUserInfo;}},connectionState:{enumerable:true,get:function get(){return _this._connectionState;}},reachabilityEnabled:{enumerable:true,get:function get(){return _this._session.reachabilityEnabled;}}});_this._initializePromise=_this._initialize();return _this;}/**
   * @returns {Promise.<T>|Request}
   * @private
   */(0,_createClass3.default)(Client,[{key:'_initialize',value:function _initialize(){var _this2=this;return this._emsClient.setToken(this._fpaToken).then(function(res){return _this2._config.updateToken(res.token);}).then(function(){return _this2._sessionPromise;}).then(function(){_this2._notifications.subscribe('twilio.channel.new_message','gcm');_this2._notifications.subscribe('twilio.channel.added_to_channel','gcm');_this2._notifications.subscribe('twilio.channel.invited_to_channel','gcm');return _this2._session.getSessionLinks().then(function(links){return links.publicChannelsUrl;}).then(function(url){_this2._publicChannels=new PublicChannels(_this2._config,_this2,_this2._transport,url);return _this2._publicChannels;});}).then(function(){return _this2._typingIndicator.initialize();});}/**
     * Initializes library
     * Library will be eventually initialized even without this method called,
     * but client can use returned promise to track library initialization state.
     * It's safe to call this method multiple times. It won't reinitialize library in ready state.
     *
     * @public
     * @returns {Promise<Client>}
     */},{key:'initialize',value:function initialize(){var _this3=this;return this._initializePromise.then(function(){return _this3;});}/**
     * Gracefully shutting down library instance
     */},{key:'shutdown',value:function shutdown(){return this._twilsock.disconnect();}/**
     * Update the token used by the Client and re-register with IP Messaging services.
     * @param {String} token - The JWT string of the new token.
     * @public
     * @returns {Promise<Client>}
     */},{key:'updateToken',value:function updateToken(fpaToken){var _this4=this;log.info('updateToken');if(!fpaToken){var err=new Error(MSG_NO_TOKEN);return _promise2.default.reject(err);}if(fpaToken===this._fpaToken){return _promise2.default.resolve(this);}return this._emsClient.setToken(fpaToken).then(function(response){if(response.status==='NEW'){log.error('Can\'t extend token:',response.reason);throw new Error('Can\'t extend token:'+response.reason);}return response.token;}).then(function(rtdToken){return _this4._twilsock.updateToken(fpaToken).then(function(){return _this4._datasync.updateToken(fpaToken);}).then(function(){return _this4._notifications.updateToken(fpaToken);}).then(function(){return _this4._sessionPromise;}).then(function(){return _this4._session.updateToken(rtdToken);}).then(function(){return rtdToken;});}).then(function(rtdToken){_this4._config.updateToken(rtdToken);_this4._fpaToken=fpaToken;return _this4;});}/**
     * Get a Channel by its SID.
     * @param {String} channelSid - The sid of the Channel to get.
     * @returns {Promise<Channel>}
     */},{key:'getChannelBySid',value:function getChannelBySid(channelSid){var _this5=this;if(!channelSid||typeof channelSid!=='string'){var err=new Error('Client.getChannelBySid requires a <String>channelSid parameter');return _promise2.default.reject(err);}return this._channels.getChannel(channelSid).then(function(channel){return channel||_this5._publicChannels.getChannelBySid(channelSid).then(function(x){return _this5._channels.pushChannel(x);});});}/**
     * Get a Channel by its unique identifier name.
     * @param {String} uniqueName - The unique identifier name of the Channel to get.
     * @returns {Promise<Channel>}
     */},{key:'getChannelByUniqueName',value:function getChannelByUniqueName(uniqueName){var _this6=this;if(!uniqueName||typeof uniqueName!=='string'){var err=new Error('Client.getChannelByUniqueName requires a <String>uniqueName parameter');return _promise2.default.reject(err);}// Currently it's not cached on client, fix?
return this._publicChannels.getChannelByUniqueName(uniqueName).then(function(x){return _this6._channels.pushChannel(x);});}/**
     * Get the current list of all Channels the Client knows about.
     * @returns {Promise<Paginator<Channel>>}
     */},{key:'getUserChannels',value:function getUserChannels(args){return this._channelsPromise.then(function(channels){return channels.getChannels(args);});}/**
     * Get the public channels directory content
     * @returns {Promise<Paginator<ChannelDescriptor>>}
     */},{key:'getPublicChannels',value:function getPublicChannels(){return this._publicChannels.getChannels();}/**
     * Create a channel on the server.
     * @param {Client#CreateChannelOptions} [options] - Options for the Channel
     * @returns {Promise<Channel>}
     */},{key:'createChannel',value:function createChannel(options){options=options||{};return this._channelsPromise.then(function(channelsEntity){return channelsEntity.addChannel(options);});}/**
     * Registers for push notifications
     * @param {string} registrationId - Push notification id provided by platform
     * @param {string} channelType - 'gcm' or 'apn' for now
     * @private
     */},{key:'setPushRegistrationId',value:function setPushRegistrationId(registrationId,type){this._notification.setPushRegistrationId(registrationId,type||'gcm');}/**
     * Push notification payload handler
     * @private
     */},{key:'putPushNotificationPayload',value:function putPushNotificationPayload(notification){var data=notification.additionalData;switch(data.type){case'twilio.channel.new_message':{var channelId=data.data.channel_id;var messageSid=data.data.message_id;this.getChannelBySid(channelId).then(function(channel){return channel.getMessages(10,messageSid);});}}}}]);return Client;}(EventEmitter);/**
 * Current version of Chat client.
 * @name Client#version
 * @type String
 * @readonly
 */(0,_defineProperties2.default)(Client,{version:{enumerable:true,value:SDK_VERSION}});/**
 * Service connection state
 * @alias Client#connectionState
 * @readonly
 * @enum {String}
 */Client.connectionState={/** Client is offline and no connection attempt in process. */DISCONNECTED:'disconnected',/** Client is offline and connection attempt is in process. */CONNECTING:'connecting',/** Client is online and ready. */CONNECTED:'connected',/** Client connection is in the erroneous state. */ERROR:'error',/** Client connection is denied because of invalid token */DENIED:'denied'};(0,_freeze2.default)(Client.connectionState);/**
 * These options can be passed to Client.createChannel
 * @typedef {Object} Client#CreateChannelOptions
 * @property {Object} [attributes] - Any custom attributes to attach to the Channel.
 * @property {Boolean} [isPrivate] - Whether or not this Channel should be visible
 *  to uninvited Clients.
 * @property {String} [friendlyName] - The non-unique display name of the Channel.
 * @property {String} [uniqueName] - The unique identity name of the Channel.
 *//**
 * These options can be passed to Client constructor
 * @typedef {Object} Client#ClientOptions
 * @property {String} [logLevel='error'] - The level of logging to enable. Valid options
 *   (from strictest to broadest): ['silent', 'error', 'warn', 'info', 'debug', 'trace']
 *//**
 * Fired when a Channel becomes visible to the Client.
 * Only fired for private channels
 * @param {Channel} channel
 * @event Client#channelAdded
 *//**
 * Fired when the Client is invited to a Channel.
 * @param {Channel} channel
 * @event Client#channelInvited
 *//**
 * Fired when the Client joins a Channel.
 * @param {Channel} channel
 * @event Client#channelJoined
 *//**
 * Fired when the Client leaves a Channel.
 * @param {Channel} channel
 * @event Client#channelLeft
 *//**
 * Fired when a Channel is no longer visible to the Client.
 * Only fired for private channels
 * @param {Channel} channel
 * @event Client#channelRemoved
 *//**
 * Fired when a Channel's attributes or metadata have been updated.
 * @param {Channel} channel
 * @event Client#channelUpdated
 *//**
 * Fired when a Member has joined the Channel.
 * @param {Member} member
 * @event Client#memberJoined
 *//**
 * Fired when a Member has left the Channel.
 * @param {Member} member
 * @event Client#memberLeft
 *//**
 * Fired when a Member's fields has been updated.
 * @param {Member} member
 * @event Client#memberUpdated
 *//**
 * Fired when a new Message has been added to the Channel on the server.
 * @param {Message} message
 * @event Client#messageAdded
 *//**
 * Fired when Message is removed from Channel's message list.
 * @param {Message} message
 * @event Client#messageRemoved
 *//**
 * Fired when an existing Message's fields are updated with new values.
 * @param {Message} message
 * @event Client#messageUpdated
 *//**
 * Fired when a member has stopped typing.
 * @param {Member} member
 * @event Client#typingEnded
 *//**
 * Fired when a member has begun typing.
 * @param {Member} member
 * @event Client#typingStarted
 *//**
 * Fired when a userInfo has been updated.
 * @param {UserInfo} UserInfo
 * @event Client#userInfoUpdated
 *//**
 * Fired when connection state has been changed.
 * @param {Client#connectionState} ConnectionState
 * @event Client#connectionStateChanged
 */module.exports=Client;},{"./../package.json":229,"./configuration":233,"./data/channels":234,"./data/publicchannels":237,"./data/userinfos":238,"./logger":240,"./services/consumptionhorizon":244,"./services/network":245,"./services/typingindicator":246,"./session":247,"babel-runtime/core-js/object/define-properties":9,"babel-runtime/core-js/object/freeze":11,"babel-runtime/core-js/object/get-prototype-of":12,"babel-runtime/core-js/promise":15,"babel-runtime/helpers/classCallCheck":21,"babel-runtime/helpers/createClass":22,"babel-runtime/helpers/inherits":24,"babel-runtime/helpers/possibleConstructorReturn":25,"events":169,"twilio-ems-client":182,"twilio-notifications":187,"twilio-sync":198,"twilio-transport":214,"twilsock":217}],233:[function(_dereq_,module,exports){'use strict';var _defineProperties=_dereq_('babel-runtime/core-js/object/define-properties');var _defineProperties2=_interopRequireDefault(_defineProperties);var _classCallCheck2=_dereq_('babel-runtime/helpers/classCallCheck');var _classCallCheck3=_interopRequireDefault(_classCallCheck2);var _createClass2=_dereq_('babel-runtime/helpers/createClass');var _createClass3=_interopRequireDefault(_createClass2);function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj};}var BASE_CHAT_URI='https://aim.twilio.com';var TYPING_PATH='/v1/typing';var TYPING_TIMEOUT=5;var HTTP_CACHE_LIFETIME=10;var CONSUMPTION_HORIZON_SENDING_INTERVAL='PT5S';var ChatConfig=function(){function ChatConfig(token,options){var _this=this;(0,_classCallCheck3.default)(this,ChatConfig);options=options||{};var _options=options.Chat||options.IPMessaging||{};var baseUri=_options.apiUri||_options.typingUri||BASE_CHAT_URI;(0,_defineProperties2.default)(this,{_token:{value:token,writable:true},token:{get:function get(){return _this._token;},enumerable:true},baseUri:{value:baseUri},baseUrl:{value:baseUri},typingIndicatorUri:{enumerable:true,value:baseUri+TYPING_PATH},typingIndicatorTimeoutDefault:{enumerable:true,value:TYPING_TIMEOUT*1000},httpCacheLifetimeDefault:{enumerable:true,value:HTTP_CACHE_LIFETIME*1000},consumptionReportIntervalDefault:{enumerable:true,value:CONSUMPTION_HORIZON_SENDING_INTERVAL},typingIndicatorTimeoutOverride:{enumberable:true,value:options.typingIndicatorTimeoutOverride},httpCacheLifetimeOverride:{enumberable:true,value:options.httpCacheLifetimeOverride},consumptionReportIntervalOverride:{enumberable:true,value:options.consumptionReportIntervalOverride}});}(0,_createClass3.default)(ChatConfig,[{key:'updateToken',value:function updateToken(token){this._token=token;}}]);return ChatConfig;}();module.exports=ChatConfig;},{"babel-runtime/core-js/object/define-properties":9,"babel-runtime/helpers/classCallCheck":21,"babel-runtime/helpers/createClass":22}],234:[function(_dereq_,module,exports){'use strict';var _promise=_dereq_('babel-runtime/core-js/promise');var _promise2=_interopRequireDefault(_promise);var _stringify=_dereq_('babel-runtime/core-js/json/stringify');var _stringify2=_interopRequireDefault(_stringify);var _map=_dereq_('babel-runtime/core-js/map');var _map2=_interopRequireDefault(_map);var _defineProperties=_dereq_('babel-runtime/core-js/object/define-properties');var _defineProperties2=_interopRequireDefault(_defineProperties);var _getPrototypeOf=_dereq_('babel-runtime/core-js/object/get-prototype-of');var _getPrototypeOf2=_interopRequireDefault(_getPrototypeOf);var _classCallCheck2=_dereq_('babel-runtime/helpers/classCallCheck');var _classCallCheck3=_interopRequireDefault(_classCallCheck2);var _createClass2=_dereq_('babel-runtime/helpers/createClass');var _createClass3=_interopRequireDefault(_createClass2);var _possibleConstructorReturn2=_dereq_('babel-runtime/helpers/possibleConstructorReturn');var _possibleConstructorReturn3=_interopRequireDefault(_possibleConstructorReturn2);var _inherits2=_dereq_('babel-runtime/helpers/inherits');var _inherits3=_interopRequireDefault(_inherits2);function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj};}var EventEmitter=_dereq_('events').EventEmitter;var Channel=_dereq_('../channel');var log=_dereq_('../logger');/**
 * Represents channels collection
 * {@see Channel}
 */var Channels=function(_EventEmitter){(0,_inherits3.default)(Channels,_EventEmitter);function Channels(services){(0,_classCallCheck3.default)(this,Channels);var _this=(0,_possibleConstructorReturn3.default)(this,(Channels.__proto__||(0,_getPrototypeOf2.default)(Channels)).call(this));(0,_defineProperties2.default)(_this,{_services:{value:services},_userInfos:{value:services.userInfos},_typingIndicator:{value:services.typingIndicator},_session:{value:services.session},channels:{enumerable:true,value:new _map2.default()}});return _this;}(0,_createClass3.default)(Channels,[{key:'_getMap',value:function _getMap(){var _this2=this;return this._session.getMyChannelsId().then(function(name){return _this2._session.datasync.map({uniqueName:name,mode:'open'});});}/**
     * Add channel to server
     * @private
     * @returns {Promise<Channel|SessionError>} Channel
     */},{key:'addChannel',value:function addChannel(options){var _this3=this;return this._session.addCommand('createChannel',{friendlyName:options.friendlyName,uniqueName:options.uniqueName,type:options.isPrivate?'private':'public',attributes:(0,_stringify2.default)(options.attributes)}).then(function(response){var existingChannel=_this3.channels.get(response.channelSid);if(existingChannel){return existingChannel._subscribe().then(function(){return existingChannel;});}var channel=new Channel(_this3._services,{channel:response.channel,channelSid:response.channelSid},response.channelSid);_this3.channels.set(channel.sid,channel);_this3._registerForEvents(channel);return channel._subscribe().then(function(){_this3.emit('channelAdded',channel);return channel;});});}/**
     * Fetch channels list and instantiate all necessary objects
     */},{key:'fetchChannels',value:function fetchChannels(){var _this4=this;this._session.getMyChannelsId().then(function(name){return _this4._session.datasync.map({uniqueName:name,mode:'open'});}).then(function(map){map.on('itemAdded',function(item){_this4._upsertChannel(item.key,item.value);});map.on('itemRemoved',function(sid){var channel=_this4.channels.get(sid);if(channel){if(channel.status==='joined'||channel.status==='invited'){channel._setStatus('known');_this4.emit('channelLeft',channel);}// if (channel.isPrivate) {
_this4.channels.delete(sid);_this4.emit('channelRemoved',channel);// }
}});map.on('itemUpdated',function(item){_this4._upsertChannel(item.key,item.value);});var upserts=[];return map.forEach(function(item){upserts.push(_this4._upsertChannel(item.key,item.value));}).then(function(){return _promise2.default.all(upserts);});}).then(function(){log.debug('Channels list fetched');}).then(function(){return _this4;}).catch(function(e){log.error('Failed to get channels list',e);throw e;});}},{key:'_wrapPaginator',value:function _wrapPaginator(page,op){var _this5=this;return op(page.items).then(function(items){return{items:items,hasNextPage:page.hasNextPage,hasPrevPage:page.hasPrevPage,nextPage:function nextPage(){return page.nextPage().then(function(x){return _this5._wrapPaginator(x,op);});},prevPage:function prevPage(){return page.prevPage().then(function(x){return _this5._wrapPaginator(x,op);});}};});}},{key:'getChannels',value:function getChannels(args){var _this6=this;return this._getMap().then(function(channelsMap){return channelsMap.getItems(args);}).then(function(page){return _this6._wrapPaginator(page,function(items){return _promise2.default.all(items.map(function(item){return _this6._upsertChannel(item.key,item.value);}));});});}},{key:'getChannel',value:function getChannel(sid){var _this7=this;return this._getMap().then(function(channelsMap){return channelsMap.getItems({key:sid});}).then(function(page){return page.items.map(function(item){return _this7._upsertChannel(item.key,item.value);});}).then(function(items){return items.length>0?items[0]:null;});}},{key:'pushChannel',value:function pushChannel(descriptor){var sid=descriptor.sid;var data={status:'known',type:descriptor.type,friendlyName:descriptor.friendlyName,dateUpdated:descriptor.dateUpdated,dateCreated:descriptor.dateCreated,uniqueName:descriptor.uniqueName,createdBy:descriptor.createdBy,attributes:descriptor.attributes,channel:descriptor.channel,sid:sid};var channel=this.channels.get(descriptor.sid);if(!channel){channel=new Channel(this._services,data,sid);this.channels.set(sid,channel);}return channel;}},{key:'_upsertChannel',value:function _upsertChannel(sid,data){var _this8=this;var channel=this.channels.get(sid);// Update the Channel's status if we know about it
if(channel){if(data.status==='joined'&&channel.status!=='joined'){channel._setStatus('joined');if(typeof data.lastConsumedMessageIndex!=='undefined'){channel._lastConsumedMessageIndex=data.lastConsumedMessageIndex;}channel._subscribe().then(function(){_this8.emit('channelJoined',channel);});}else if(data.status==='invited'&&channel.status!=='invited'){channel._setStatus('invited');channel._subscribe().then(function(){_this8.emit('channelInvited',channel);});}else if(data.status==='known'&&(channel.status==='invited'||channel.status==='joined')){channel._setStatus('known');channel._update(data);channel._subscribe().then(function(){_this8.emit('channelLeft',channel);});}else if(data.status==='notParticipating'&&data.type==='private'){channel._subscribe();}else{channel._update(data);}return channel._subscribe().then(function(){return channel;});}// Fetch the Channel if we don't know about it
channel=new Channel(this._services,data,sid);this._registerForEvents(channel);this.channels.set(sid,channel);return channel._subscribe().then(function(){if(data.status==='joined'){channel._setStatus('joined');_this8.emit('channelJoined',channel);}else if(data.status==='invited'){channel._setStatus('invited');_this8.emit('channelInvited',channel);}if(channel.isPrivate){_this8.emit('channelAdded',channel);}return channel;});}},{key:'_registerForEvents',value:function _registerForEvents(channel){var _this9=this;channel.on('updated',function(){return _this9.emit('channelUpdated',channel);});channel.on('memberJoined',this.emit.bind(this,'memberJoined'));channel.on('memberLeft',this.emit.bind(this,'memberLeft'));channel.on('memberUpdated',this.emit.bind(this,'memberUpdated'));channel.on('messageAdded',this.emit.bind(this,'messageAdded'));channel.on('messageUpdated',this.emit.bind(this,'messageUpdated'));channel.on('messageRemoved',this.emit.bind(this,'messageRemoved'));channel.on('typingStarted',this.emit.bind(this,'typingStarted'));channel.on('typingEnded',this.emit.bind(this,'typingEnded'));}}]);return Channels;}(EventEmitter);module.exports=Channels;},{"../channel":230,"../logger":240,"babel-runtime/core-js/json/stringify":4,"babel-runtime/core-js/map":5,"babel-runtime/core-js/object/define-properties":9,"babel-runtime/core-js/object/get-prototype-of":12,"babel-runtime/core-js/promise":15,"babel-runtime/helpers/classCallCheck":21,"babel-runtime/helpers/createClass":22,"babel-runtime/helpers/inherits":24,"babel-runtime/helpers/possibleConstructorReturn":25,"events":169}],235:[function(_dereq_,module,exports){'use strict';var _promise=_dereq_('babel-runtime/core-js/promise');var _promise2=_interopRequireDefault(_promise);var _defineProperties=_dereq_('babel-runtime/core-js/object/define-properties');var _defineProperties2=_interopRequireDefault(_defineProperties);var _getPrototypeOf=_dereq_('babel-runtime/core-js/object/get-prototype-of');var _getPrototypeOf2=_interopRequireDefault(_getPrototypeOf);var _classCallCheck2=_dereq_('babel-runtime/helpers/classCallCheck');var _classCallCheck3=_interopRequireDefault(_classCallCheck2);var _createClass2=_dereq_('babel-runtime/helpers/createClass');var _createClass3=_interopRequireDefault(_createClass2);var _possibleConstructorReturn2=_dereq_('babel-runtime/helpers/possibleConstructorReturn');var _possibleConstructorReturn3=_interopRequireDefault(_possibleConstructorReturn2);var _inherits2=_dereq_('babel-runtime/helpers/inherits');var _inherits3=_interopRequireDefault(_inherits2);function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj};}var EventEmitter=_dereq_('events').EventEmitter;var log=_dereq_('../logger').scope('Members');var Member=_dereq_('../member');/**
 * @classdesc Represents the collection of members for the channel
 * @fires Members#memberJoined
 * @fires Members#memberLeft
 * @fires Members#memberUpdated
 * @fires Members#memberInfoUpdated
 */var Members=function(_EventEmitter){(0,_inherits3.default)(Members,_EventEmitter);function Members(channel,session,userInfos,members){(0,_classCallCheck3.default)(this,Members);var _this=(0,_possibleConstructorReturn3.default)(this,(Members.__proto__||(0,_getPrototypeOf2.default)(Members)).call(this));(0,_defineProperties2.default)(_this,{_datasync:{value:session.datasync},_userInfos:{value:userInfos},_session:{value:session},_rosterStreamPromise:{writable:true,value:null},channel:{enumerable:true,value:channel},members:{enumerable:true,value:members}});return _this;}(0,_createClass3.default)(Members,[{key:'unsubscribe',value:function unsubscribe(){return this._rosterStreamPromise?this._rosterStreamPromise.then(function(entity){return entity.close();}):_promise2.default.resolve();}},{key:'subscribe',value:function subscribe(rosterObjectName){var _this2=this;return this._rosterStreamPromise=this._rosterStreamPromise||this._datasync.map({uniqueName:rosterObjectName,mode:'open'}).then(function(rosterMap){rosterMap.on('itemAdded',function(item){_this2.upsertMember(item.key,item.value).then(function(member){_this2.emit('memberJoined',member);});});rosterMap.on('itemRemoved',function(memberSid){if(!_this2.members.has(memberSid)){return;}var leftMember=_this2.members.get(memberSid);_this2.members.delete(memberSid);_this2.emit('memberLeft',leftMember);});rosterMap.on('itemUpdated',function(item){_this2.upsertMember(item.key,item.value);});var membersPromises=[];return rosterMap.forEach(function(item){membersPromises.push(_this2.upsertMember(item.key,item.value));}).then(function(){return _promise2.default.all(membersPromises);}).then(function(){return rosterMap;});}).catch(function(err){_this2._rosterStreamPromise=null;log.error('Failed to get roster object for channel',_this2.channel.sid,err);throw err;});}},{key:'upsertMember',value:function upsertMember(memberSid,data){var _this3=this;var member=this.members.get(memberSid);if(member){member._update(data);return _promise2.default.resolve(member);}return this._userInfos.getUserInfo(data.identity,data.userInfo).then(function(userInfo){member=new Member(_this3.channel,data,memberSid,userInfo);_this3.members.set(memberSid,member);member.on('updated',function(){return _this3.emit('memberUpdated',member);});member.on('userInfoUpdated',function(){return _this3.emit('memberInfoUpdated',member);});return member;});}/**
     * @returns {Promise<Array<Member>>} returns list of members {@see Member}
     */},{key:'getMembers',value:function getMembers(){var _this4=this;return this._rosterStreamPromise.then(function(){var members=[];_this4.members.forEach(function(member){return members.push(member);});return members;});}/**
     * Add user to the channel
     * @returns {Promise<|SessionError>}
     */},{key:'add',value:function add(username){return this._session.addCommand('addMember',{channelSid:this.channel.sid,username:username});}/**
     * Invites user to the channel
     * User can choose either to join or not
     * @returns {Promise<|SessionError>}
     */},{key:'invite',value:function invite(username){return this._session.addCommand('inviteMember',{channelSid:this.channel.sid,username:username});}/**
     * Remove user from channel
     * @returns {Promise<|SessionError>}
     */},{key:'remove',value:function remove(username){return this._session.addCommand('removeMember',{channelSid:this.channel.sid,username:username});}}]);return Members;}(EventEmitter);module.exports=Members;/**
 * Fired when member joined channel
 * @event Members#memberJoined
 * @type {Member}
 *//**
 * Fired when member left channel
 * @event Members#memberLeft
 * @type {string}
 *//**
 * Fired when member info updated
 * Note that event won't be fired if user haven't requested any member data
 *
 * @event Members#memberUpdated
 * @type {Member}
 *//**
 * Fired when userInfo for member is updated
 * @event Members#memberInfoUpdated
 * @type {Member}
 */},{"../logger":240,"../member":241,"babel-runtime/core-js/object/define-properties":9,"babel-runtime/core-js/object/get-prototype-of":12,"babel-runtime/core-js/promise":15,"babel-runtime/helpers/classCallCheck":21,"babel-runtime/helpers/createClass":22,"babel-runtime/helpers/inherits":24,"babel-runtime/helpers/possibleConstructorReturn":25,"events":169}],236:[function(_dereq_,module,exports){'use strict';var _isInteger=_dereq_('babel-runtime/core-js/number/is-integer');var _isInteger2=_interopRequireDefault(_isInteger);var _stringify=_dereq_('babel-runtime/core-js/json/stringify');var _stringify2=_interopRequireDefault(_stringify);var _promise=_dereq_('babel-runtime/core-js/promise');var _promise2=_interopRequireDefault(_promise);var _map=_dereq_('babel-runtime/core-js/map');var _map2=_interopRequireDefault(_map);var _defineProperties=_dereq_('babel-runtime/core-js/object/define-properties');var _defineProperties2=_interopRequireDefault(_defineProperties);var _getPrototypeOf=_dereq_('babel-runtime/core-js/object/get-prototype-of');var _getPrototypeOf2=_interopRequireDefault(_getPrototypeOf);var _classCallCheck2=_dereq_('babel-runtime/helpers/classCallCheck');var _classCallCheck3=_interopRequireDefault(_classCallCheck2);var _createClass2=_dereq_('babel-runtime/helpers/createClass');var _createClass3=_interopRequireDefault(_createClass2);var _possibleConstructorReturn2=_dereq_('babel-runtime/helpers/possibleConstructorReturn');var _possibleConstructorReturn3=_interopRequireDefault(_possibleConstructorReturn2);var _inherits2=_dereq_('babel-runtime/helpers/inherits');var _inherits3=_interopRequireDefault(_inherits2);function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj};}var EventEmitter=_dereq_('events').EventEmitter;var log=_dereq_('loglevel');var Message=_dereq_('../message');/**
 * Represents the collection of messages in a channel
 */var Messages=function(_EventEmitter){(0,_inherits3.default)(Messages,_EventEmitter);function Messages(channel,session,messages){(0,_classCallCheck3.default)(this,Messages);var _this=(0,_possibleConstructorReturn3.default)(this,(Messages.__proto__||(0,_getPrototypeOf2.default)(Messages)).call(this));(0,_defineProperties2.default)(_this,{_datasync:{value:session.datasync},_eventStreamPromise:{value:null,writable:true},_sortedMessages:{value:messages},_messagesByIndex:{value:new _map2.default()},_session:{value:session},channel:{enumerable:true,value:channel}});return _this;}/**
   * Subscribe to the Messages Event Stream
   * @param {String} uri - The URI of the Messages resource.
   * @returns {Promise}
   */(0,_createClass3.default)(Messages,[{key:'subscribe',value:function subscribe(name){var _this2=this;return this._eventStreamPromise=this._eventStreamPromise||this._datasync.list({uniqueName:name,mode:'open'}).then(function(list){list.on('itemAdded',function(item){var message=new Message(_this2.channel,item.index,item.value);if(_this2._messagesByIndex.has(message.index)){log.debug('Message arrived, but already known and ignored',_this2.channel.sid,message.index);return;}_this2._sortedMessages.push(message);_this2._messagesByIndex.set(message.index,message);message.on('updated',function(){return _this2.emit('messageUpdated',message);});_this2.emit('messageAdded',message);});list.on('itemRemoved',function(index){var message=_this2._removeMessageById(index);if(message){_this2._messagesByIndex.delete(message.index);message.removeAllListeners('updated');_this2.emit('messageRemoved',message);}});list.on('itemUpdated',function(item){var message=_this2._messagesByIndex.get(item.index);if(message){message._update(item.value);}});return list;}).catch(function(err){_this2._eventStreamPromise=null;log.error('Failed to get messages object for channel',_this2.channel.sid,err);throw err;});}},{key:'unsubscribe',value:function unsubscribe(){return this._eventStreamPromise?this._eventStreamPromise.then(function(entity){return entity.close();}):_promise2.default.resolve();}/**
     * @param {Number} entityId Entity ID of Message to remove.
     * @returns {Message} removedMessage The message that was removed (or undefined).
     * @private
     */},{key:'_removeMessageById',value:function _removeMessageById(entityId){var removedMessage=void 0;for(var i=0;i<this._sortedMessages.length;i++){var message=this._sortedMessages[i];if(message.index===entityId){removedMessage=this._sortedMessages.splice(i,1)[0];break;}}return removedMessage;}/**
     * Send Message to the channel
     * @param {String} message - Message to post
     * @param {Object} attributes Message attributes
     * @returns Returns promise which can fail
     */},{key:'send',value:function send(message,attributes){if(typeof attributes==='undefined'){attributes={};}else if(attributes.constructor!==Object){return _promise2.default.reject(new Error('Attributes must be a valid JSON object'));}return this._session.addCommand('sendMessage',{channelSid:this.channel.sid,text:message,attributes:(0,_stringify2.default)(attributes)});}/**
     * Returns messages from channel using paginator interface
     * @param {Number} [pageSize] Number of messages to return in single chunk. By default it's 100.
     * @param {String} [anchor] Most early message id which is already known, or 'end' by default
     * @returns {Promise<Paginator<Message>>} last page of messages by default
     */},{key:'getMessages',value:function getMessages(pageSize,anchor,direction){anchor=(0,_isInteger2.default)(anchor)&&anchor>=0?anchor:'end';direction=direction||'backwards';return this._getMessages(pageSize,anchor,direction);}},{key:'_wrapPaginator',value:function _wrapPaginator(order,page,op){var _this3=this;// We should swap next and prev page here, because of misfit of Sync and Chat paging conceptions
var shouldReverse=order==='desc';var np=function np(){return page.nextPage().then(function(x){return _this3._wrapPaginator(order,x,op);});};var pp=function pp(){return page.prevPage().then(function(x){return _this3._wrapPaginator(order,x,op);});};return op(page.items).then(function(items){return{items:items.sort(function(x,y){return x.index-y.index;}),hasPrevPage:shouldReverse?page.hasNextPage:page.hasPrevPage||false,hasNextPage:shouldReverse?page.hasPrevPage:page.hasNextPage||false,prevPage:shouldReverse?np:pp,nextPage:shouldReverse?pp:np};});}},{key:'_upsertMessage',value:function _upsertMessage(index,value){var _this4=this;var cachedMessage=this._messagesByIndex.get(index);if(cachedMessage){return cachedMessage;}var message=new Message(this.channel,index,value);this._messagesByIndex.set(message.index,message);message.on('updated',function(){return _this4.emit('messageUpdated',message);});return message;}/**
     * Returns last messages from channel
     * @param {Number} [pageSize] Number of messages to return in single chunk. By default it's 100.
     * @param {String} [anchor] Most early message id which is already known, or 'end' by default
     * @returns {Promise<Paginator<Message>>} last page of messages by default
     * @private
     */},{key:'_getMessages',value:function _getMessages(pageSize,anchor,direction){var _this5=this;anchor=(0,_isInteger2.default)(anchor)&&anchor>=0?anchor:'end';pageSize=pageSize||30;var order=direction==='backwards'?'desc':'asc';return this.subscribe().then(function(messagesList){return messagesList.getItems({from:anchor!=='end'?anchor:void 0,pageSize:pageSize,order:order});}).then(function(page){return _this5._wrapPaginator(order,page,function(items){return _promise2.default.all(items.map(function(item){return _this5._upsertMessage(item.index,item.value);}));});});}}]);return Messages;}(EventEmitter);module.exports=Messages;},{"../message":242,"babel-runtime/core-js/json/stringify":4,"babel-runtime/core-js/map":5,"babel-runtime/core-js/number/is-integer":6,"babel-runtime/core-js/object/define-properties":9,"babel-runtime/core-js/object/get-prototype-of":12,"babel-runtime/core-js/promise":15,"babel-runtime/helpers/classCallCheck":21,"babel-runtime/helpers/createClass":22,"babel-runtime/helpers/inherits":24,"babel-runtime/helpers/possibleConstructorReturn":25,"events":169,"loglevel":172}],237:[function(_dereq_,module,exports){'use strict';var _defineProperties=_dereq_('babel-runtime/core-js/object/define-properties');var _defineProperties2=_interopRequireDefault(_defineProperties);var _classCallCheck2=_dereq_('babel-runtime/helpers/classCallCheck');var _classCallCheck3=_interopRequireDefault(_classCallCheck2);var _createClass2=_dereq_('babel-runtime/helpers/createClass');var _createClass3=_interopRequireDefault(_createClass2);function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj};}var UriBuilder=_dereq_('../util').UriBuilder;var Paginator=_dereq_('../restpaginator');var ChannelDescriptor=_dereq_('../channeldescriptor');/**
 * Public channels collection
 * It's a cassandra-backed pull-based collection
 */var PublicChannels=function(){function PublicChannels(config,client,transport,url){(0,_classCallCheck3.default)(this,PublicChannels);(0,_defineProperties2.default)(this,{_config:{value:config},_client:{value:client},_transport:{value:transport},_url:{value:url}});}(0,_createClass3.default)(PublicChannels,[{key:'getChannels',value:function getChannels(args){var _this=this;args=args||{};var url=new UriBuilder(this._url).arg('PageToken',args.pageToken).build();return this._transport.get(url).then(function(response){return response.body;}).then(function(body){return new Paginator(body.channels.map(function(x){return new ChannelDescriptor(_this._client,x);}),function(pageToken){return _this.getChannels({pageToken:pageToken});},body.meta.prev_token,body.meta.next_token);});}},{key:'getChannelBySid',value:function getChannelBySid(sid){var _this2=this;var url=new UriBuilder(this._url).path(sid).build();return this._transport.get(url).then(function(response){return response.body;}).then(function(body){return new ChannelDescriptor(_this2._client,body);});}},{key:'getChannelByUniqueName',value:function getChannelByUniqueName(sid){var _this3=this;var url=new UriBuilder(this._url).path(encodeURIComponent(sid)).build();return this._transport.get(url).then(function(response){return response.body;}).then(function(body){return new ChannelDescriptor(_this3._client,body);});}}]);return PublicChannels;}();module.exports=PublicChannels;},{"../channeldescriptor":231,"../restpaginator":243,"../util":251,"babel-runtime/core-js/object/define-properties":9,"babel-runtime/helpers/classCallCheck":21,"babel-runtime/helpers/createClass":22}],238:[function(_dereq_,module,exports){'use strict';var _map=_dereq_('babel-runtime/core-js/map');var _map2=_interopRequireDefault(_map);var _defineProperties=_dereq_('babel-runtime/core-js/object/define-properties');var _defineProperties2=_interopRequireDefault(_defineProperties);var _getPrototypeOf=_dereq_('babel-runtime/core-js/object/get-prototype-of');var _getPrototypeOf2=_interopRequireDefault(_getPrototypeOf);var _classCallCheck2=_dereq_('babel-runtime/helpers/classCallCheck');var _classCallCheck3=_interopRequireDefault(_classCallCheck2);var _createClass2=_dereq_('babel-runtime/helpers/createClass');var _createClass3=_interopRequireDefault(_createClass2);var _possibleConstructorReturn2=_dereq_('babel-runtime/helpers/possibleConstructorReturn');var _possibleConstructorReturn3=_interopRequireDefault(_possibleConstructorReturn2);var _inherits2=_dereq_('babel-runtime/helpers/inherits');var _inherits3=_interopRequireDefault(_inherits2);function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj};}var EventEmitter=_dereq_('events').EventEmitter;var UserInfo=_dereq_('../userinfo');/**
 * @classdesc Container for known user infos
 * @fires UserInfos#userInfoUpdated
 */var UserInfos=function(_EventEmitter){(0,_inherits3.default)(UserInfos,_EventEmitter);function UserInfos(session,datasync){(0,_classCallCheck3.default)(this,UserInfos);var _this=(0,_possibleConstructorReturn3.default)(this,(UserInfos.__proto__||(0,_getPrototypeOf2.default)(UserInfos)).call(this));var myUserInfo=new UserInfo(null,null,datasync,session);myUserInfo.on('updated',function(){return _this.emit('userInfoUpdated',myUserInfo);});(0,_defineProperties2.default)(_this,{_session:{value:session},_datasync:{value:datasync},_infos:{value:new _map2.default()},_identity:{value:null,writable:true},myUserInfo:{enumerable:true,get:function get(){return myUserInfo;}}});_this._session.getUserInfosData().then(function(data){_this._identity=data.identity;myUserInfo._identity=data.identity;myUserInfo._entityName=data.userInfo;_this._infos.set(data.identity,myUserInfo);return myUserInfo._ensureFetched();});return _this;}/**
   * @returns {Promise<UserInfo>} Fully initialized user info for logged in user
   */(0,_createClass3.default)(UserInfos,[{key:'getMyUserInfo',value:function getMyUserInfo(){var _this2=this;return this._session.getUserInfosData().then(function(data){return _this2.getUserInfo(data.identity,data.userInfo);});}/**
     * @returns {Promise<UserInfo>} Fully initialized user info
     */},{key:'getUserInfo',value:function getUserInfo(identity,id){var _this3=this;var userInfo=this._infos.get(identity);if(!userInfo){userInfo=new UserInfo(identity,id||null,this._datasync,this._session);this._infos.set(identity,userInfo);userInfo.on('updated',function(){return _this3.emit('userInfoUpdated',userInfo);});}return userInfo._ensureFetched();}}]);return UserInfos;}(EventEmitter);module.exports=UserInfos;},{"../userinfo":249,"babel-runtime/core-js/map":5,"babel-runtime/core-js/object/define-properties":9,"babel-runtime/core-js/object/get-prototype-of":12,"babel-runtime/helpers/classCallCheck":21,"babel-runtime/helpers/createClass":22,"babel-runtime/helpers/inherits":24,"babel-runtime/helpers/possibleConstructorReturn":25,"events":169}],239:[function(_dereq_,module,exports){'use strict';var chat=_dereq_('./client');module.exports=chat;},{"./client":232}],240:[function(_dereq_,module,exports){'use strict';var _defineProperties=_dereq_('babel-runtime/core-js/object/define-properties');var _defineProperties2=_interopRequireDefault(_defineProperties);var _classCallCheck2=_dereq_('babel-runtime/helpers/classCallCheck');var _classCallCheck3=_interopRequireDefault(_classCallCheck2);var _createClass2=_dereq_('babel-runtime/helpers/createClass');var _createClass3=_interopRequireDefault(_createClass2);var _from=_dereq_('babel-runtime/core-js/array/from');var _from2=_interopRequireDefault(_from);function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj};}var log=_dereq_('loglevel');function prepareLine(prefix,args){return[prefix].concat((0,_from2.default)(args));}var Logger=function(){function Logger(){(0,_classCallCheck3.default)(this,Logger);(0,_defineProperties2.default)(this,{_prefix:{value:'',writable:true}});}(0,_createClass3.default)(Logger,[{key:'setLevel',value:function setLevel(level){log.setLevel(level);}},{key:'trace',value:function trace(){log.trace.apply(null,prepareLine('Chat T:'+this._prefix,arguments));}},{key:'debug',value:function debug(){log.debug.apply(null,prepareLine('Chat D:'+this._prefix,arguments));}},{key:'info',value:function info(){log.info.apply(null,prepareLine('Chat I:'+this._prefix,arguments));}},{key:'warn',value:function warn(){log.warn.apply(null,prepareLine('Chat W:'+this._prefix,arguments));}},{key:'error',value:function error(){log.error.apply(null,prepareLine('Chat E:'+this._prefix,arguments));}}],[{key:'scope',value:function scope(prefix){this._prefix+=' '+prefix;return new Logger();}},{key:'setLevel',value:function setLevel(level){log.setLevel(level);}},{key:'trace',value:function trace(){log.trace.apply(null,prepareLine('Chat T:',arguments));}},{key:'debug',value:function debug(){log.debug.apply(null,prepareLine('Chat D:',arguments));}},{key:'info',value:function info(){log.info.apply(null,prepareLine('Chat I:',arguments));}},{key:'warn',value:function warn(){log.warn.apply(null,prepareLine('Chat W:',arguments));}},{key:'error',value:function error(){log.error.apply(null,prepareLine('Chat E:',arguments));}}]);return Logger;}();module.exports=Logger;},{"babel-runtime/core-js/array/from":1,"babel-runtime/core-js/object/define-properties":9,"babel-runtime/helpers/classCallCheck":21,"babel-runtime/helpers/createClass":22,"loglevel":172}],241:[function(_dereq_,module,exports){'use strict';var _defineProperties=_dereq_('babel-runtime/core-js/object/define-properties');var _defineProperties2=_interopRequireDefault(_defineProperties);var _getPrototypeOf=_dereq_('babel-runtime/core-js/object/get-prototype-of');var _getPrototypeOf2=_interopRequireDefault(_getPrototypeOf);var _classCallCheck2=_dereq_('babel-runtime/helpers/classCallCheck');var _classCallCheck3=_interopRequireDefault(_classCallCheck2);var _createClass2=_dereq_('babel-runtime/helpers/createClass');var _createClass3=_interopRequireDefault(_createClass2);var _possibleConstructorReturn2=_dereq_('babel-runtime/helpers/possibleConstructorReturn');var _possibleConstructorReturn3=_interopRequireDefault(_possibleConstructorReturn2);var _inherits2=_dereq_('babel-runtime/helpers/inherits');var _inherits3=_interopRequireDefault(_inherits2);function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj};}var EventEmitter=_dereq_('events').EventEmitter;/**
 * @classdesc A Member represents a remote Client in a Channel.
 * @property {Channel} channel - The Channel the remote Client is a Member of.
 * @property {String} identity - Deprecated: The identity of the remote Client.
 * @property {UserInfo} userInfo - UserInfo structure for member.
 * @property {Boolean} isTyping - Whether or not this Member is currently typing.
 * @property {Number} lastConsumedMessageIndex - Latest consumed Message index by this Member.
 * @property {Date} lastConsumptionTimestamp - Date when Member has updated his consumption horizon.
 * @property {String} sid - The server-assigned unique identifier for the Member.
 * @fires Member#typingEnded
 * @fires Member#typingStarted
 * @fires Member#updated
 * @fires Member#userInfoUpdated
 */var Member=function(_EventEmitter){(0,_inherits3.default)(Member,_EventEmitter);function Member(channel,data,sid,userInfo){(0,_classCallCheck3.default)(this,Member);var _this=(0,_possibleConstructorReturn3.default)(this,(Member.__proto__||(0,_getPrototypeOf2.default)(Member)).call(this));var isTyping=false;var typingTimeout=null;var identity=data.identity;var roleSid=data.roleSid||null;var lastConsumedMessageIndex=typeof data.lastConsumedMessageIndex!=='undefined'?data.lastConsumedMessageIndex:null;var lastConsumptionTimestamp=data.lastConsumptionTimestamp?new Date(data.lastConsumptionTimestamp):null;if(!data.identity){throw new Error('Received invalid Member object from server: Missing identity.');}(0,_defineProperties2.default)(_this,{_identity:{get:function get(){return identity;},set:function set(_identity){return identity=_identity;}},_isTyping:{get:function get(){return isTyping;},set:function set(_isTyping){return isTyping=_isTyping;}},_lastConsumedMessageIndex:{get:function get(){return lastConsumedMessageIndex;},set:function set(_lastConsumedMessageIndex){return lastConsumedMessageIndex=_lastConsumedMessageIndex;}},_lastConsumptionTimestamp:{get:function get(){return lastConsumptionTimestamp;},set:function set(_lastConsumptionTimestamp){return lastConsumptionTimestamp=_lastConsumptionTimestamp;}},_roleSid:{get:function get(){return roleSid;},set:function set(_roleSid){return roleSid=_roleSid;}},_typingTimeout:{writable:true,value:typingTimeout},channel:{enumerable:true,value:channel},identity:{enumerable:true,get:function get(){return identity;}},isTyping:{enumerable:true,get:function get(){return isTyping;}},lastConsumedMessageIndex:{enumerable:true,get:function get(){return lastConsumedMessageIndex;}},lastConsumptionTimestamp:{enumerable:true,get:function get(){return lastConsumptionTimestamp;}},roleSid:{enumerable:true,get:function get(){return roleSid;}},sid:{enumerable:true,value:sid},userInfo:{enumerable:true,get:function get(){return userInfo;}}});userInfo.on('updated',function(){return _this.emit('userInfoUpdated',_this);});return _this;}/**
   * Private method used to start or reset the typing indicator timeout (with event emitting)
   * @private
   */(0,_createClass3.default)(Member,[{key:'_startTyping',value:function _startTyping(timeout){var _this2=this;clearTimeout(this._typingTimeout);this._isTyping=true;this.emit('typingStarted',this);this.channel.emit('typingStarted',this);this._typingTimeout=setTimeout(function(){return _this2._endTyping();},timeout);return this;}/**
     * Private method function used to stop typing indicator (with event emitting)
     * @private
     */},{key:'_endTyping',value:function _endTyping(){if(!this._typingTimeout){return;}this._isTyping=false;this.emit('typingEnded',this);this.channel.emit('typingEnded',this);clearInterval(this._typingTimeout);this._typingTimeout=null;}/**
     * Private method function used update local object's property roleSid with new value
     * @private
     */},{key:'_update',value:function _update(data){var updated=false;if(data.roleSid&&this._roleSid!==data.roleSid){this._roleSid=data.roleSid;updated=true;}if(typeof data.lastConsumedMessageIndex!=='undefined'&&this._lastConsumedMessageIndex!==data.lastConsumedMessageIndex){this._lastConsumedMessageIndex=data.lastConsumedMessageIndex;updated=true;}if(data.lastConsumptionTimestamp){var lastConsumptionTimestamp=new Date(data.lastConsumptionTimestamp);if(!this._lastConsumptionTimestamp||this._lastConsumptionTimestamp.getTime()!==lastConsumptionTimestamp.getTime()){this._lastConsumptionTimestamp=lastConsumptionTimestamp;updated=true;}}if(updated){this.emit('updated',this);}}/**
     * Remove this Member from the Channel.
     * @returns Promise
     */},{key:'remove',value:function remove(){return this.channel.removeMember(this);}}]);return Member;}(EventEmitter);module.exports=Member;/**
* Fired when member started to type
* @event Member#typingStarted
* @type {Member}
*//**
* Fired when member ended to type
* @event Member#typingEnded
* @type {Member}
*//**
 * Fired when member is updated
 * @event Member#updated
 * @type {Member}
 *//**
 * Fired when member's user info is updated
 * @event Member#userInfoUpdated
 * @type {Member}
 */},{"babel-runtime/core-js/object/define-properties":9,"babel-runtime/core-js/object/get-prototype-of":12,"babel-runtime/helpers/classCallCheck":21,"babel-runtime/helpers/createClass":22,"babel-runtime/helpers/inherits":24,"babel-runtime/helpers/possibleConstructorReturn":25,"events":169}],242:[function(_dereq_,module,exports){'use strict';var _stringify=_dereq_('babel-runtime/core-js/json/stringify');var _stringify2=_interopRequireDefault(_stringify);var _promise=_dereq_('babel-runtime/core-js/promise');var _promise2=_interopRequireDefault(_promise);var _defineProperties=_dereq_('babel-runtime/core-js/object/define-properties');var _defineProperties2=_interopRequireDefault(_defineProperties);var _getPrototypeOf=_dereq_('babel-runtime/core-js/object/get-prototype-of');var _getPrototypeOf2=_interopRequireDefault(_getPrototypeOf);var _classCallCheck2=_dereq_('babel-runtime/helpers/classCallCheck');var _classCallCheck3=_interopRequireDefault(_classCallCheck2);var _createClass2=_dereq_('babel-runtime/helpers/createClass');var _createClass3=_interopRequireDefault(_createClass2);var _possibleConstructorReturn2=_dereq_('babel-runtime/helpers/possibleConstructorReturn');var _possibleConstructorReturn3=_interopRequireDefault(_possibleConstructorReturn2);var _inherits2=_dereq_('babel-runtime/helpers/inherits');var _inherits3=_interopRequireDefault(_inherits2);function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj};}var EventEmitter=_dereq_('events').EventEmitter;var log=_dereq_('./logger');var isDeepEqual=_dereq_('./util').isDeepEqual;function parseAttributes(msgSid,attributes){try{return attributes?JSON.parse(attributes):{};}catch(e){log.warn('Got malformed attributes for the message',msgSid);return{};}}/**
 * @classdesc A Message represents a Message in a Channel.
 * @property {String} author - The name of the user that authored this Message.
 * @property {String} body - The body of the Message.
 * @property {Object} attributes - Message custom attributes
 * @property {Channel} channel - The Channel the Message belongs to.
 * @property {Date} dateUpdated - When the Message was updated.
 * @property {Number} index - Index of Message in the Channel's messages stream.
 * @property {String} lastUpdatedBy - The name of the last user updated this Message.
 * @property {String} sid - The server-assigned unique identifier for
 *   the Message.
 * @property {Date} timestamp - When the Message was sent.
 * @fires Message#updated
 */var Message=function(_EventEmitter){(0,_inherits3.default)(Message,_EventEmitter);function Message(channel,entityId,data){(0,_classCallCheck3.default)(this,Message);var _this=(0,_possibleConstructorReturn3.default)(this,(Message.__proto__||(0,_getPrototypeOf2.default)(Message)).call(this));var body=data.text;var dateUpdated=data.dateUpdated?new Date(data.dateUpdated):null;var lastUpdatedBy=data.lastUpdatedBy?data.lastUpdatedBy:null;(0,_defineProperties2.default)(_this,{_body:{get:function get(){return body;},set:function set(_body){return body=_body;}},_dateUpdated:{get:function get(){return dateUpdated;},set:function set(_dateUpdated){return dateUpdated=_dateUpdated;}},_lastUpdatedBy:{get:function get(){return lastUpdatedBy;},set:function set(_lastUpdatedBy){return lastUpdatedBy=_lastUpdatedBy;}},_attributes:{value:parseAttributes(data.sid,data.attributes),writable:true},author:{enumerable:true,value:data.author},body:{enumerable:true,get:function get(){return body;}},channel:{enumerable:true,value:channel},dateUpdated:{enumerable:true,get:function get(){return dateUpdated;}},index:{enumerable:true,value:parseInt(entityId)},lastUpdatedBy:{enumerable:true,get:function get(){return lastUpdatedBy;}},sid:{enumerable:true,value:data.sid},timestamp:{enumerable:true,value:new Date(data.timestamp)},attributes:{enumerable:true,get:function get(){return _this._attributes;}}});return _this;}(0,_createClass3.default)(Message,[{key:'_update',value:function _update(data){var updated=false;if((data.text||typeof data.text==='string')&&data.text!==this._body){this._body=data.text;updated=true;}if(data.lastUpdatedBy&&data.lastUpdatedBy!==this._lastUpdatedBy){this._lastUpdatedBy=data.lastUpdatedBy;updated=true;}if(data.dateUpdated&&new Date(data.dateUpdated).getTime()!==(this._dateUpdated&&this._dateUpdated.getTime())){this._dateUpdated=new Date(data.dateUpdated);updated=true;}var updatedAttributes=parseAttributes(this.sid,data.attributes);if(!isDeepEqual(this._attributes,updatedAttributes)){this._attributes=updatedAttributes;updated=true;}if(updated){this.emit('updated',this);}}/**
     * Remove the Message.
     * @returns {Promise<Message|SessionError>}
     */},{key:'remove',value:function remove(){var _this2=this;return this.channel._session.addCommand('deleteMessage',{channelSid:this.channel.sid,messageIdx:this.index.toString()}).then(function(){return _this2;});}/**
     * Edit message body.
     * @param {String} body - new body of Message.
     * @returns {Promise<Message|SessionError>}
     */},{key:'updateBody',value:function updateBody(body){var _this3=this;if(typeof body!=='string'){throw new Error('Body <String> is a required parameter for updateBody');}return this.channel._session.addCommand('editMessage',{channelSid:this.channel.sid,messageIdx:this.index.toString(),text:body}).then(function(){return _this3;});}/**
     * Edit message attributes.
     * @param {Object} attributes new attributes for Message.
     * @returns {Promise<Message|SessionError|Error>}
     */},{key:'updateAttributes',value:function updateAttributes(attributes){var _this4=this;if(typeof attributes==='undefined'){return _promise2.default.reject(new Error('Attributes is a required parameter for updateAttributes'));}else if(attributes.constructor!==Object){return _promise2.default.reject(new Error('Attributes must be a valid JSON object'));}return this.channel._session.addCommand('editMessageAttributes',{channelSid:this.channel.sid,messageIdx:this.index,attributes:(0,_stringify2.default)(attributes)}).then(function(){return _this4;});}}]);return Message;}(EventEmitter);/**
 * Fired when the Message's fields have been updated.
 * @param {Message} message
 * @event Message#updated
 */module.exports=Message;},{"./logger":240,"./util":251,"babel-runtime/core-js/json/stringify":4,"babel-runtime/core-js/object/define-properties":9,"babel-runtime/core-js/object/get-prototype-of":12,"babel-runtime/core-js/promise":15,"babel-runtime/helpers/classCallCheck":21,"babel-runtime/helpers/createClass":22,"babel-runtime/helpers/inherits":24,"babel-runtime/helpers/possibleConstructorReturn":25,"events":169}],243:[function(_dereq_,module,exports){'use strict';/**
 * @class Paginator
 * @classdesc Pagination helper class
 *
 * @property {Array} items Array of elements on current page
 * @property {boolean} hasNextPage Indicates the existence of next page
 * @property {boolean} hasPrevPage Indicates the existence of previous page
 */var _promise=_dereq_('babel-runtime/core-js/promise');var _promise2=_interopRequireDefault(_promise);var _defineProperties=_dereq_('babel-runtime/core-js/object/define-properties');var _defineProperties2=_interopRequireDefault(_defineProperties);var _classCallCheck2=_dereq_('babel-runtime/helpers/classCallCheck');var _classCallCheck3=_interopRequireDefault(_classCallCheck2);var _createClass2=_dereq_('babel-runtime/helpers/createClass');var _createClass3=_interopRequireDefault(_createClass2);function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj};}var Paginator=function(){/*
  * @constructor
  * @param {Array} items Array of element for current page
  * @param {Object} params
  * @private
  */function Paginator(items,source,prevToken,nextToken){(0,_classCallCheck3.default)(this,Paginator);(0,_defineProperties2.default)(this,{prevToken:{value:prevToken},nextToken:{value:nextToken},source:{value:source},hasNextPage:{value:!!nextToken,enumerable:true},hasPrevPage:{value:!!prevToken,enumerable:true},items:{get:function get(){return items;},enumerable:true}});}/**
   * Request next page.
   * Does not modify existing object
   * @return {Promise<Paginator>}
   */(0,_createClass3.default)(Paginator,[{key:'nextPage',value:function nextPage(){return this.hasNextPage?this.source(this.nextToken):_promise2.default.reject(new Error('No next page'));}/**
     * Request previous page.
     * Does not modify existing object
     * @return {Promise<Paginator>}
     */},{key:'prevPage',value:function prevPage(){return this.hasPrevPage?this.source(this.prevToken):_promise2.default.reject(new Error('No previous page'));}}]);return Paginator;}();module.exports=Paginator;},{"babel-runtime/core-js/object/define-properties":9,"babel-runtime/core-js/promise":15,"babel-runtime/helpers/classCallCheck":21,"babel-runtime/helpers/createClass":22}],244:[function(_dereq_,module,exports){'use strict';/**
 * @classdesc Provides consumption horizon management functionality
 */var _map=_dereq_('babel-runtime/core-js/map');var _map2=_interopRequireDefault(_map);var _defineProperties=_dereq_('babel-runtime/core-js/object/define-properties');var _defineProperties2=_interopRequireDefault(_defineProperties);var _classCallCheck2=_dereq_('babel-runtime/helpers/classCallCheck');var _classCallCheck3=_interopRequireDefault(_classCallCheck2);var _createClass2=_dereq_('babel-runtime/helpers/createClass');var _createClass3=_interopRequireDefault(_createClass2);function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj};}var ConsumptionHorizon=function(){function ConsumptionHorizon(config,session){(0,_classCallCheck3.default)(this,ConsumptionHorizon);(0,_defineProperties2.default)(this,{_session:{value:session},_consumptionHorizonReports:{value:new _map2.default()},_consumptionHorizonUpdateTimer:{value:null,writable:true}});}(0,_createClass3.default)(ConsumptionHorizon,[{key:'_getReportInterval',value:function _getReportInterval(){return this._session.getConsumptionReportInterval().then(function(duration){return duration.seconds*1000;});}},{key:'_delayedSendConsumptionHorizon',value:function _delayedSendConsumptionHorizon(delay){var _this=this;if(this._consumptionHorizonUpdateTimer!==null){return;}this._consumptionHorizonUpdateTimer=setTimeout(function(){var reports=[];_this._consumptionHorizonReports.forEach(function(entry){return reports.push(entry);});if(reports.length>0){_this._session.addCommand('consumptionReport',{report:reports});}_this._consumptionHorizonUpdateTimer=null;_this._consumptionHorizonReports.clear();},delay);}/**
     * Updates consumption horizon value without any checks
     */},{key:'updateLastConsumedMessageIndexForChannel',value:function updateLastConsumedMessageIndexForChannel(channelSid,messageIdx){var _this2=this;this._consumptionHorizonReports.set(channelSid,{channelSid:channelSid,messageIdx:messageIdx});this._getReportInterval().then(function(delay){return _this2._delayedSendConsumptionHorizon(delay);});}/**
     * Move consumption horizon forward
     */},{key:'advanceLastConsumedMessageIndexForChannel',value:function advanceLastConsumedMessageIndexForChannel(channelSid,messageIdx){var _this3=this;var currentHorizon=this._consumptionHorizonReports.get(channelSid);if(currentHorizon&&currentHorizon.messageIdx>=messageIdx){return;}this._consumptionHorizonReports.set(channelSid,{channelSid:channelSid,messageIdx:messageIdx});this._getReportInterval().then(function(delay){return _this3._delayedSendConsumptionHorizon(delay);});}}]);return ConsumptionHorizon;}();module.exports=ConsumptionHorizon;},{"babel-runtime/core-js/map":5,"babel-runtime/core-js/object/define-properties":9,"babel-runtime/helpers/classCallCheck":21,"babel-runtime/helpers/createClass":22}],245:[function(_dereq_,module,exports){'use strict';var _promise=_dereq_('babel-runtime/core-js/promise');var _promise2=_interopRequireDefault(_promise);var _slicedToArray2=_dereq_('babel-runtime/helpers/slicedToArray');var _slicedToArray3=_interopRequireDefault(_slicedToArray2);var _getIterator2=_dereq_('babel-runtime/core-js/get-iterator');var _getIterator3=_interopRequireDefault(_getIterator2);var _map=_dereq_('babel-runtime/core-js/map');var _map2=_interopRequireDefault(_map);var _isInteger=_dereq_('babel-runtime/core-js/number/is-integer');var _isInteger2=_interopRequireDefault(_isInteger);var _defineProperties=_dereq_('babel-runtime/core-js/object/define-properties');var _defineProperties2=_interopRequireDefault(_defineProperties);var _classCallCheck2=_dereq_('babel-runtime/helpers/classCallCheck');var _classCallCheck3=_interopRequireDefault(_classCallCheck2);var _createClass2=_dereq_('babel-runtime/helpers/createClass');var _createClass3=_interopRequireDefault(_createClass2);function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj};}var Network=function(){function Network(config,session,transport){(0,_classCallCheck3.default)(this,Network);(0,_defineProperties2.default)(this,{_config:{value:config},_transport:{value:transport},_session:{value:session},_cacheLifetime:{value:(0,_isInteger2.default)(config.httpCacheLifetimeOverride)?config.httpCacheLifetimeOverride:config.httpCacheLifetimeDefault,writable:true},_cache:{value:new _map2.default()},_timer:{value:null,writable:true}});}(0,_createClass3.default)(Network,[{key:'_isExpired',value:function _isExpired(timestamp){return!this._cacheLifetime||Date.now()-timestamp>this._cacheLifetime;}},{key:'_cleanupCache',value:function _cleanupCache(){var _iteratorNormalCompletion=true;var _didIteratorError=false;var _iteratorError=undefined;try{for(var _iterator=(0,_getIterator3.default)(this._cache),_step;!(_iteratorNormalCompletion=(_step=_iterator.next()).done);_iteratorNormalCompletion=true){var _step$value=(0,_slicedToArray3.default)(_step.value,2),k=_step$value[0],v=_step$value[1];if(this._isExpired(v.timestamp)){this._cache.delete(k);}}}catch(err){_didIteratorError=true;_iteratorError=err;}finally{try{if(!_iteratorNormalCompletion&&_iterator.return){_iterator.return();}}finally{if(_didIteratorError){throw _iteratorError;}}}if(this._cache.size===0){clearTimeout(this._timer);}}},{key:'_pokeTimer',value:function _pokeTimer(){var _this=this;this._timer=this._timer||setInterval(function(){return _this._cleanupCache();},this._cacheLifetime*2);}},{key:'get',value:function get(url){var _this2=this;var cacheEntry=this._cache.get(url);if(cacheEntry&&!this._isExpired(cacheEntry.timestamp)){return _promise2.default.resolve(cacheEntry.response);}var headers={'X-Twilio-Token':this._config.token};return this._transport.get(url,headers).then(function(response){_this2._cache.set(url,{response:response,timestamp:Date.now()});_this2._pokeTimer();return response;});}}]);return Network;}();module.exports=Network;},{"babel-runtime/core-js/get-iterator":2,"babel-runtime/core-js/map":5,"babel-runtime/core-js/number/is-integer":6,"babel-runtime/core-js/object/define-properties":9,"babel-runtime/core-js/promise":15,"babel-runtime/helpers/classCallCheck":21,"babel-runtime/helpers/createClass":22,"babel-runtime/helpers/slicedToArray":26}],246:[function(_dereq_,module,exports){'use strict';var _promise=_dereq_('babel-runtime/core-js/promise');var _promise2=_interopRequireDefault(_promise);var _map=_dereq_('babel-runtime/core-js/map');var _map2=_interopRequireDefault(_map);var _defineProperties=_dereq_('babel-runtime/core-js/object/define-properties');var _defineProperties2=_interopRequireDefault(_defineProperties);var _classCallCheck2=_dereq_('babel-runtime/helpers/classCallCheck');var _classCallCheck3=_interopRequireDefault(_classCallCheck2);var _createClass2=_dereq_('babel-runtime/helpers/createClass');var _createClass3=_interopRequireDefault(_createClass2);function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj};}var log=_dereq_('../logger').scope('TypingIndicator');var TYPING_INDICATOR_MESSAGE_TYPE='twilio.ipmsg.typing_indicator';/**
 * @class TypingIndicator
 *
 * @constructor
 * @private
 */var TypingIndicator=function(){function TypingIndicator(config,transport,notifications,getChannel){var _this=this;(0,_classCallCheck3.default)(this,TypingIndicator);(0,_defineProperties2.default)(this,{_transport:{value:transport},_notifications:{value:notifications},_config:{value:config},_typingTimeout:{value:null,writable:true},_sentUpdates:{value:new _map2.default()},_getChannel:{value:getChannel},token:{get:function get(){return config.token;}},typingTimeout:{get:function get(){return config.typingIndicatorTimeoutOverride||_this._typingTimeout||config.typingIndicatorTimeoutDefault;}}});}/**
   * Initialize TypingIndicator controller
   * Registers for needed message types and sets listeners
   * @private
   */(0,_createClass3.default)(TypingIndicator,[{key:'initialize',value:function initialize(){var _this2=this;this._notifications.subscribe(TYPING_INDICATOR_MESSAGE_TYPE,'twilsock');this._notifications.on('message',function(type,message){if(type===TYPING_INDICATOR_MESSAGE_TYPE){_this2._handleRemoteTyping(message);}});}/**
     * Remote members typing events handler
     * @private
     */},{key:'_handleRemoteTyping',value:function _handleRemoteTyping(message){var _this3=this;log.trace('Got new typing indicator ',message);this._getChannel(message.channel_sid).then(function(channel){if(channel){channel._members.forEach(function(member){if(member.identity===message.identity){member._startTyping(_this3.typingTimeout);}});}}).catch(function(err){log.error(err);throw err;});}/**
     * Send typing event for the given channel sid
     * @param {String} channelSid
     */},{key:'send',value:function send(channelSid){var lastUpdate=this._sentUpdates.get(channelSid);if(lastUpdate&&lastUpdate>Date.now()-this.typingTimeout){return _promise2.default.resolve();}this._sentUpdates.set(channelSid,Date.now());return this._send(channelSid);}},{key:'_send',value:function _send(channelSid){var _this4=this;log.trace('Sending typing indicator');var url=this._config.typingIndicatorUri;var headers={'X-Twilio-Token':this.token,'Content-Type':'application/x-www-form-urlencoded'};var body='ChannelSid='+channelSid;return this._transport.post(url,headers,body).then(function(response){if(response.body.hasOwnProperty('typing_timeout')){_this4._typingTimeout=response.body.typing_timeout*1000;}}).catch(function(err){log.error('Failed to send typing indicator:',err);throw err;});}}]);return TypingIndicator;}();module.exports=TypingIndicator;},{"../logger":240,"babel-runtime/core-js/map":5,"babel-runtime/core-js/object/define-properties":9,"babel-runtime/core-js/promise":15,"babel-runtime/helpers/classCallCheck":21,"babel-runtime/helpers/createClass":22}],247:[function(_dereq_,module,exports){'use strict';var _promise=_dereq_('babel-runtime/core-js/promise');var _promise2=_interopRequireDefault(_promise);var _map=_dereq_('babel-runtime/core-js/map');var _map2=_interopRequireDefault(_map);var _defineProperties=_dereq_('babel-runtime/core-js/object/define-properties');var _defineProperties2=_interopRequireDefault(_defineProperties);var _classCallCheck2=_dereq_('babel-runtime/helpers/classCallCheck');var _classCallCheck3=_interopRequireDefault(_classCallCheck2);var _createClass2=_dereq_('babel-runtime/helpers/createClass');var _createClass3=_interopRequireDefault(_createClass2);function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj};}var uuid=_dereq_('uuid');var platform=_dereq_('platform');var log=_dereq_('./logger').scope('Session');var ChangeTracker=_dereq_('./util/changetracker');var SessionError=_dereq_('./sessionerror');var Durational=_dereq_('durational');var SDK_VERSION=_dereq_('./../package.json').version;var SESSION_PURPOSE='com.twilio.rtd.ipmsg';/**
*  Constructs the instance of Session
*
*  @classdesc Provides the interface to send the command to the server
*  It is reliable, which means that it tracks the command object state
*  and waits the answer from the server.
*/var Session=function(){function Session(sync,transport,config){var _this=this;(0,_classCallCheck3.default)(this,Session);var platformInfo=typeof navigator!=='undefined'?platform.parse(navigator.userAgent):platform;(0,_defineProperties2.default)(this,{_endpointPlatform:{value:['js',SDK_VERSION,platformInfo.os,platformInfo.name,platformInfo.version].join('|')},_pendingCommands:{value:new _map2.default()},_sessionContextChangeTracker:{value:new ChangeTracker()},_sessionStreamPromise:{value:null,writable:true},_config:{value:config},_token:{value:null,writable:true},_tokenSynced:{value:true,writable:true},identity:{enumerable:true,get:function get(){return _this._sessionContextChangeTracker._data.identity;}},userInfo:{enumerable:true,get:function get(){return _this._sessionContextChangeTracker._data.userInfo;}},reachabilityEnabled:{enumerable:true,get:function get(){return _this._sessionContextChangeTracker._data.reachabilityEnabled;}},datasync:{enumerable:true,value:sync},transport:{value:transport}});}(0,_createClass3.default)(Session,[{key:'initialize',value:function initialize(token){var _this2=this;this._token=token;this._tokenSynced=false;var context={type:'IpMsgSession',apiVersion:'3',endpointPlatform:this._endpointPlatform,token:token};this._sessionStreamPromise=this.datasync.list({purpose:SESSION_PURPOSE,context:context}).then(function(list){log.info('Session created',list.sid);_this2._tokenSynced=true;list.on('itemAdded',function(item){return _this2._processCommandResponse(item);});list.on('itemUpdated',function(item){return _this2._processCommandResponse(item);});list.on('contextUpdated',function(updatedContext){log.info('Session context updated');log.debug('new session context:',updatedContext);_this2._sessionContextChangeTracker.update(updatedContext);});return list;}).catch(function(err){log.error('Failed to create session',err);throw err;});return this._sessionStreamPromise;}/**
     * Sends the command to the server
     * @returns Promise the promise, which is being fulfilled only when service will reply
     */},{key:'addCommand',value:function addCommand(action,params){return this._processCommand(action,params);}/**
     * @private
     */},{key:'_processCommand',value:function _processCommand(action,params){var _this3=this;var command={request:params};command.request.action=action;command.commandId=uuid.v4();log.info('Adding command: ',action,command.commandId);log.debug('command arguments:',params);return new _promise2.default(function(resolve,reject){_this3._sessionStreamPromise.then(function(list){_this3._pendingCommands.set(command.commandId,{resolve:resolve,reject:reject});return list.push(command);}).then(function(){return log.debug('Command accepted by server',command.commandId);}).catch(function(err){_this3._pendingCommands.delete(command.commandId);log.error('Failed to add a command to the session',err);reject(new Error('Can\'t add command: '+err.description));});});}/**
     * @private
     */},{key:'_processCommandResponse',value:function _processCommandResponse(entity){if(entity.value.hasOwnProperty('response')&&entity.value.hasOwnProperty('commandId')&&this._pendingCommands.has(entity.value.commandId)){var value=entity.value;var commandId=entity.value.commandId;if(value.response.status===200){log.debug('Command succeeded: ',value);var resolve=this._pendingCommands.get(commandId).resolve;this._pendingCommands.delete(commandId);resolve(value.response);}else{log.error('Command failed: ',value);var reject=this._pendingCommands.get(commandId).reject;this._pendingCommands.delete(commandId);reject(new SessionError(value.response.statusText,value.response.status));}}}},{key:'updateToken',value:function updateToken(token){this._token=token;this._tokenSynced=false;return this.syncToken();}},{key:'syncToken',value:function syncToken(){var _this4=this;if(this._tokenSynced){return _promise2.default.resolve();}return this._sessionStreamPromise.then(function(list){return list.getContext().then(function(context){context.token=_this4._token;return list.updateContext(context);}).then(function(){_this4._tokenSynced=true;});}).catch(function(err){log.error('Couldn\'t update the token in session context',err);throw new Error(err);});}},{key:'onKeyUpdated',value:function onKeyUpdated(path,handler){this._sessionContextChangeTracker.addEventHandler('keyAdded',path,handler);this._sessionContextChangeTracker.addEventHandler('keyUpdated',path,handler);}},{key:'getSessionLinks',value:function getSessionLinks(){var _this5=this;return new _promise2.default(function(resolve){_this5._sessionStreamPromise.then(function(list){return list.getContext();}).then(function(context){if(context.hasOwnProperty('links')){resolve(context.links);}else{_this5.onKeyUpdated('/links',function(){_this5._sessionStreamPromise.then(function(list){return list.getContext();}).then(function(ctx){return resolve(ctx.links);});});}});}).then(function(links){return{publicChannelsUrl:_this5._config.baseUrl+links.publicChannelsUrl,myChannelsUrl:_this5._config.baseUrl+links.myChannelsUrl,typingUrl:_this5._config.baseUrl+links.typingUrl};});}},{key:'getChannelsId',value:function getChannelsId(){var _this6=this;return new _promise2.default(function(resolve){_this6._sessionStreamPromise.then(function(list){return list.getContext();}).then(function(context){if(context.hasOwnProperty('channelsUrl')){resolve(context.channels);}else{_this6.onKeyUpdated('/channels',resolve);}});});}},{key:'getMyChannelsId',value:function getMyChannelsId(){var _this7=this;return new _promise2.default(function(resolve){_this7._sessionStreamPromise.then(function(list){return list.getContext();}).then(function(context){if(context.hasOwnProperty('myChannels')){resolve(context.myChannels);}else{_this7.onKeyUpdated('/myChannels',resolve);}});});}},{key:'getUserInfosData',value:function getUserInfosData(){var _this8=this;return new _promise2.default(function(resolve){function resolveWithData(context){resolve({userInfo:context.userInfo,identity:context.identity});}_this8._sessionStreamPromise.then(function(stream){return stream.getContext();}).then(function(context){if(context.hasOwnProperty('userInfo')){resolveWithData(context);}else{_this8.onKeyUpdated('/userInfo',function(){_this8._sessionStreamPromise.then(function(stream){return stream.getContext();}).then(function(updatedContext){return resolveWithData(updatedContext);});});}});});}},{key:'getConsumptionReportInterval',value:function getConsumptionReportInterval(){var _this9=this;return this._sessionStreamPromise.then(function(stream){return stream.getContext();}).then(function(context){return Durational.fromString(_this9._config.consumptionReportIntervalOverride||context.consumptionReportInterval||_this9._config.consumptionReportIntervalDefault);});}}]);return Session;}();module.exports=Session;},{"./../package.json":229,"./logger":240,"./sessionerror":248,"./util/changetracker":250,"babel-runtime/core-js/map":5,"babel-runtime/core-js/object/define-properties":9,"babel-runtime/core-js/promise":15,"babel-runtime/helpers/classCallCheck":21,"babel-runtime/helpers/createClass":22,"durational":167,"platform":174,"uuid":224}],248:[function(_dereq_,module,exports){'use strict';/**
 * @class
 * @classdesc Exception type for service-side issues
 *
 * @property {Number} code - Error code
 * @property {String} message - Error description
 */var _getPrototypeOf=_dereq_('babel-runtime/core-js/object/get-prototype-of');var _getPrototypeOf2=_interopRequireDefault(_getPrototypeOf);var _classCallCheck2=_dereq_('babel-runtime/helpers/classCallCheck');var _classCallCheck3=_interopRequireDefault(_classCallCheck2);var _possibleConstructorReturn2=_dereq_('babel-runtime/helpers/possibleConstructorReturn');var _possibleConstructorReturn3=_interopRequireDefault(_possibleConstructorReturn2);var _inherits2=_dereq_('babel-runtime/helpers/inherits');var _inherits3=_interopRequireDefault(_inherits2);function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj};}var SessionError=function(_Error){(0,_inherits3.default)(SessionError,_Error);function SessionError(message,code){(0,_classCallCheck3.default)(this,SessionError);var _this=(0,_possibleConstructorReturn3.default)(this,(SessionError.__proto__||(0,_getPrototypeOf2.default)(SessionError)).call(this));_this.name=_this.constructor.name;_this.message=message;_this.code=code;if(Error.captureStackTrace){Error.captureStackTrace(_this,_this.constructor);}else{_this.stack=new Error().stack;}return _this;}return SessionError;}(Error);module.exports=SessionError;},{"babel-runtime/core-js/object/get-prototype-of":12,"babel-runtime/helpers/classCallCheck":21,"babel-runtime/helpers/inherits":24,"babel-runtime/helpers/possibleConstructorReturn":25}],249:[function(_dereq_,module,exports){'use strict';var _regenerator=_dereq_('babel-runtime/regenerator');var _regenerator2=_interopRequireDefault(_regenerator);var _stringify=_dereq_('babel-runtime/core-js/json/stringify');var _stringify2=_interopRequireDefault(_stringify);var _asyncToGenerator2=_dereq_('babel-runtime/helpers/asyncToGenerator');var _asyncToGenerator3=_interopRequireDefault(_asyncToGenerator2);var _promise=_dereq_('babel-runtime/core-js/promise');var _promise2=_interopRequireDefault(_promise);var _defineProperties=_dereq_('babel-runtime/core-js/object/define-properties');var _defineProperties2=_interopRequireDefault(_defineProperties);var _getPrototypeOf=_dereq_('babel-runtime/core-js/object/get-prototype-of');var _getPrototypeOf2=_interopRequireDefault(_getPrototypeOf);var _classCallCheck2=_dereq_('babel-runtime/helpers/classCallCheck');var _classCallCheck3=_interopRequireDefault(_classCallCheck2);var _createClass2=_dereq_('babel-runtime/helpers/createClass');var _createClass3=_interopRequireDefault(_createClass2);var _possibleConstructorReturn2=_dereq_('babel-runtime/helpers/possibleConstructorReturn');var _possibleConstructorReturn3=_interopRequireDefault(_possibleConstructorReturn2);var _inherits2=_dereq_('babel-runtime/helpers/inherits');var _inherits3=_interopRequireDefault(_inherits2);function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj};}var EventEmitter=_dereq_('events').EventEmitter;var log=_dereq_('./logger').scope('UserInfo');/**
 * @classdesc Extended user information
 * Note that {@link UserInfo#online} and {@link UserInfo#notifiable} properties are eligible to use only
 * if reachability function enabled.
 * You may check if it is enabled by reading value of {@link Client~reachabilityEnabled}
 *
 * @property {String} identity - User identity
 * @property {String} friendlyName - User friendly name. Null if not set
 * @property {Object} attributes - Object with custom attributes for user
 * @property {Boolean} online - User realtime channel connection status
 * @property {Boolean} notifiable - User push notification registration status
 * @fires UserInfo#updated
 *
 * @constructor
 * @param {String} identity - Identity of user
 * @param {String} entityId - id of user's info object
 * @param {Object} datasync - datasync service
 * @param {Object} session - session service
 */var UserInfo=function(_EventEmitter){(0,_inherits3.default)(UserInfo,_EventEmitter);function UserInfo(identity,entityName,datasync,session){(0,_classCallCheck3.default)(this,UserInfo);var _this=(0,_possibleConstructorReturn3.default)(this,(UserInfo.__proto__||(0,_getPrototypeOf2.default)(UserInfo)).call(this));_this.setMaxListeners(0);(0,_defineProperties2.default)(_this,{_datasync:{value:datasync},_session:{value:session},_identity:{value:identity,writable:true},_entityName:{value:entityName,writable:true},_attributes:{value:{},writable:true},_friendlyName:{value:null,writable:true},_online:{value:null,writable:true},_notifiable:{value:null,writable:true},_promiseToFetch:{writable:true},identity:{enumerable:true,get:function get(){return _this._identity;}},attributes:{enumerable:true,get:function get(){return _this._attributes;}},friendlyName:{enumerable:true,get:function get(){return _this._friendlyName;}},online:{enumerable:true,get:function get(){return _this._online;}},notifiable:{enumerable:true,get:function get(){return _this._notifiable;}}});return _this;}// Handles service updates
(0,_createClass3.default)(UserInfo,[{key:'_update',value:function _update(key,value){log.debug('UserInfo for',this._identity,'updated:',key,value);switch(key){case'friendlyName':this._friendlyName=value.value;break;case'attributes':try{this._attributes=JSON.parse(value.value);}catch(e){this._attributes={};}break;case'reachability':this._online=value.online;this._notifiable=value.notifiable;break;default:return;}this.emit('updated',key);}// Fetch reachability info
},{key:'_updateReachabilityInfo',value:function _updateReachabilityInfo(map,update){var _this2=this;if(!this._session.reachabilityEnabled){return _promise2.default.resolve();}return map.get('reachability').then(update).catch(function(err){log.warn('Failed to get reachability info for ',_this2._identity,err);});}// Fetch user info
},{key:'_fetch',value:function _fetch(){var _this3=this;if(!this._entityName){return _promise2.default.resolve(this);}var update=function update(item){return _this3._update(item.key,item.value);};this._promiseToFetch=this._datasync.map({uniqueName:this._entityName,mode:'open'}).then(function(map){map.on('itemUpdated',update);return _promise2.default.all([map.get('friendlyName').then(update),map.get('attributes').then(update),_this3._updateReachabilityInfo(map,update)]);}).then(function(){log.debug('Fetched for',_this3.identity);return _this3;}).catch(function(err){_this3._promiseToFetch=null;throw err;});return this._promiseToFetch;}},{key:'_ensureFetched',value:function _ensureFetched(){return this._promiseToFetch||this._fetch();}/**
     * Update the UserInfo's attributes.
     * @param {Object} attributes - The new attributes object.
     * @returns {Promise<UserInfo|SessionError>} A Promise for the UserInfo
     */},{key:'updateAttributes',value:function(){var _ref=(0,_asyncToGenerator3.default)(_regenerator2.default.mark(function _callee(attributes){return _regenerator2.default.wrap(function _callee$(_context){while(1){switch(_context.prev=_context.next){case 0:if(!(!attributes||attributes.constructor!==Object)){_context.next=2;break;}throw new Error('Attributes must be an object.');case 2:_context.next=4;return this._session.addCommand('editUserAttributes',{username:this._identity,attributes:(0,_stringify2.default)(attributes)});case 4:return _context.abrupt('return',this);case 5:case'end':return _context.stop();}}},_callee,this);}));function updateAttributes(_x){return _ref.apply(this,arguments);}return updateAttributes;}()/**
     * Update the Users's friendlyName.
     * @param {String} name - The new friendlyName.
     * @returns {Promise<UserInfo|SessionError>} A Promise for the UserInfo
     */},{key:'updateFriendlyName',value:function(){var _ref2=(0,_asyncToGenerator3.default)(_regenerator2.default.mark(function _callee2(friendlyName){return _regenerator2.default.wrap(function _callee2$(_context2){while(1){switch(_context2.prev=_context2.next){case 0:if(!(friendlyName&&typeof friendlyName!=='string')){_context2.next=2;break;}throw new Error('friendlyName must be string or empty.');case 2:_context2.next=4;return this._session.addCommand('editUserFriendlyName',{username:this._identity,friendlyName:friendlyName});case 4:return _context2.abrupt('return',this);case 5:case'end':return _context2.stop();}}},_callee2,this);}));function updateFriendlyName(_x2){return _ref2.apply(this,arguments);}return updateFriendlyName;}()}]);return UserInfo;}(EventEmitter);/**
 * Fired when the UserInfo's fields have been updated.
 * @param {String} reason - Name of the property which has changed
 * @event UserInfo#updated
 */module.exports=UserInfo;},{"./logger":240,"babel-runtime/core-js/json/stringify":4,"babel-runtime/core-js/object/define-properties":9,"babel-runtime/core-js/object/get-prototype-of":12,"babel-runtime/core-js/promise":15,"babel-runtime/helpers/asyncToGenerator":20,"babel-runtime/helpers/classCallCheck":21,"babel-runtime/helpers/createClass":22,"babel-runtime/helpers/inherits":24,"babel-runtime/helpers/possibleConstructorReturn":25,"babel-runtime/regenerator":28,"events":169}],250:[function(_dereq_,module,exports){'use strict';var _defineProperties=_dereq_('babel-runtime/core-js/object/define-properties');var _defineProperties2=_interopRequireDefault(_defineProperties);function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj};}var EventEmitter=_dereq_('events').EventEmitter;var inherits=_dereq_('util').inherits;var JsonDiff=_dereq_('rfc6902');/**
 * Tracks changes for JS objects and emits appropriate callbacks
 */function ChangeTracker(data){var _this=this;(0,_defineProperties2.default)(this,{_pendingListeners:{value:{}},_data:{value:data||{},writable:true}});EventEmitter.call(this);['keyAdded','keyRemoved','keyUpdated'].forEach(function(eventName){_this._pendingListeners[eventName]={};_this.on(eventName,function(path,value){var handlers=_this._pendingListeners[eventName][path]||[];handlers.forEach(function(handler){return handler(value);});_this._pendingListeners[eventName][path]=[];});});}inherits(ChangeTracker,EventEmitter);/**
 * Compare old and new data and fire events if difference found
 * @private
 */ChangeTracker.prototype._traverse=function(originalData,updatedData){var _this2=this;var diff=JsonDiff.createPatch(originalData,updatedData);diff.forEach(function(row){if(row.op==='add'){_this2.emit('keyAdded',row.path,row.value);}else if(row.op==='replace'){_this2.emit('keyUpdated',row.path,row.value);}else if(row.op==='remove'){_this2.emit('keyRemoved',row.path);}});};/**
 * Set new data to process
 * @param Object updatedData new data set
 * @public
 */ChangeTracker.prototype.update=function(updatedData){var originalData=this._data;this._data=updatedData;this._traverse(originalData,updatedData);};ChangeTracker.prototype.addEventHandler=function(eventName,path,handler){var handlers=this._pendingListeners[eventName][path]||[];handlers.push(handler);this._pendingListeners[eventName][path]=handlers;};module.exports=ChangeTracker;},{"babel-runtime/core-js/object/define-properties":9,"events":169,"rfc6902":181,"util":223}],251:[function(_dereq_,module,exports){'use strict';var _defineProperties=_dereq_('babel-runtime/core-js/object/define-properties');var _defineProperties2=_interopRequireDefault(_defineProperties);function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj};}var JsonDiff=_dereq_('rfc6902');/**
 * Checks if objects are equal
 */function isDeepEqual(o1,o2){return JsonDiff.createPatch(o1,o2).length===0;}/**
 * Construct URI with query parameters
 */function UriBuilder(base){(0,_defineProperties2.default)(this,{base:{value:base.replace(/\/$/,'')},paths:{value:[]},args:{value:[]}});this.arg=function(name,value){if(typeof value!=='undefined'){this.args.push(name+'='+value);}return this;};this.path=function(name){this.paths.push(name);return this;};this.build=function(){var result=this.base;if(this.paths.length){result+='/'+this.paths.join('/');}if(this.args.length){result+='?'+this.args.join('&');}return result;};}module.exports.isDeepEqual=isDeepEqual;module.exports.UriBuilder=UriBuilder;},{"babel-runtime/core-js/object/define-properties":9,"rfc6902":181}]},{},[239])(239);});
/* WEBPACK VAR INJECTION */}.call(exports, __webpack_require__(2), __webpack_require__(55).setImmediate))

/***/ }),
/* 54 */
/***/ (function(module, exports, __webpack_require__) {

/* WEBPACK VAR INJECTION */(function(global, process) {(function (global, undefined) {
    "use strict";

    if (global.setImmediate) {
        return;
    }

    var nextHandle = 1; // Spec says greater than zero
    var tasksByHandle = {};
    var currentlyRunningATask = false;
    var doc = global.document;
    var registerImmediate;

    function setImmediate(callback) {
      // Callback can either be a function or a string
      if (typeof callback !== "function") {
        callback = new Function("" + callback);
      }
      // Copy function arguments
      var args = new Array(arguments.length - 1);
      for (var i = 0; i < args.length; i++) {
          args[i] = arguments[i + 1];
      }
      // Store and register the task
      var task = { callback: callback, args: args };
      tasksByHandle[nextHandle] = task;
      registerImmediate(nextHandle);
      return nextHandle++;
    }

    function clearImmediate(handle) {
        delete tasksByHandle[handle];
    }

    function run(task) {
        var callback = task.callback;
        var args = task.args;
        switch (args.length) {
        case 0:
            callback();
            break;
        case 1:
            callback(args[0]);
            break;
        case 2:
            callback(args[0], args[1]);
            break;
        case 3:
            callback(args[0], args[1], args[2]);
            break;
        default:
            callback.apply(undefined, args);
            break;
        }
    }

    function runIfPresent(handle) {
        // From the spec: "Wait until any invocations of this algorithm started before this one have completed."
        // So if we're currently running a task, we'll need to delay this invocation.
        if (currentlyRunningATask) {
            // Delay by doing a setTimeout. setImmediate was tried instead, but in Firefox 7 it generated a
            // "too much recursion" error.
            setTimeout(runIfPresent, 0, handle);
        } else {
            var task = tasksByHandle[handle];
            if (task) {
                currentlyRunningATask = true;
                try {
                    run(task);
                } finally {
                    clearImmediate(handle);
                    currentlyRunningATask = false;
                }
            }
        }
    }

    function installNextTickImplementation() {
        registerImmediate = function(handle) {
            process.nextTick(function () { runIfPresent(handle); });
        };
    }

    function canUsePostMessage() {
        // The test against `importScripts` prevents this implementation from being installed inside a web worker,
        // where `global.postMessage` means something completely different and can't be used for this purpose.
        if (global.postMessage && !global.importScripts) {
            var postMessageIsAsynchronous = true;
            var oldOnMessage = global.onmessage;
            global.onmessage = function() {
                postMessageIsAsynchronous = false;
            };
            global.postMessage("", "*");
            global.onmessage = oldOnMessage;
            return postMessageIsAsynchronous;
        }
    }

    function installPostMessageImplementation() {
        // Installs an event handler on `global` for the `message` event: see
        // * https://developer.mozilla.org/en/DOM/window.postMessage
        // * http://www.whatwg.org/specs/web-apps/current-work/multipage/comms.html#crossDocumentMessages

        var messagePrefix = "setImmediate$" + Math.random() + "$";
        var onGlobalMessage = function(event) {
            if (event.source === global &&
                typeof event.data === "string" &&
                event.data.indexOf(messagePrefix) === 0) {
                runIfPresent(+event.data.slice(messagePrefix.length));
            }
        };

        if (global.addEventListener) {
            global.addEventListener("message", onGlobalMessage, false);
        } else {
            global.attachEvent("onmessage", onGlobalMessage);
        }

        registerImmediate = function(handle) {
            global.postMessage(messagePrefix + handle, "*");
        };
    }

    function installMessageChannelImplementation() {
        var channel = new MessageChannel();
        channel.port1.onmessage = function(event) {
            var handle = event.data;
            runIfPresent(handle);
        };

        registerImmediate = function(handle) {
            channel.port2.postMessage(handle);
        };
    }

    function installReadyStateChangeImplementation() {
        var html = doc.documentElement;
        registerImmediate = function(handle) {
            // Create a <script> element; its readystatechange event will be fired asynchronously once it is inserted
            // into the document. Do so, thus queuing up the task. Remember to clean up once it's been called.
            var script = doc.createElement("script");
            script.onreadystatechange = function () {
                runIfPresent(handle);
                script.onreadystatechange = null;
                html.removeChild(script);
                script = null;
            };
            html.appendChild(script);
        };
    }

    function installSetTimeoutImplementation() {
        registerImmediate = function(handle) {
            setTimeout(runIfPresent, 0, handle);
        };
    }

    // If supported, we should attach to the prototype of global, since that is where setTimeout et al. live.
    var attachTo = Object.getPrototypeOf && Object.getPrototypeOf(global);
    attachTo = attachTo && attachTo.setTimeout ? attachTo : global;

    // Don't get fooled by e.g. browserify environments.
    if ({}.toString.call(global.process) === "[object process]") {
        // For Node.js before 0.9
        installNextTickImplementation();

    } else if (canUsePostMessage()) {
        // For non-IE10 modern browsers
        installPostMessageImplementation();

    } else if (global.MessageChannel) {
        // For web workers, where supported
        installMessageChannelImplementation();

    } else if (doc && "onreadystatechange" in doc.createElement("script")) {
        // For IE 68
        installReadyStateChangeImplementation();

    } else {
        // For older browsers
        installSetTimeoutImplementation();
    }

    attachTo.setImmediate = setImmediate;
    attachTo.clearImmediate = clearImmediate;
}(typeof self === "undefined" ? typeof global === "undefined" ? this : global : self));

/* WEBPACK VAR INJECTION */}.call(exports, __webpack_require__(2), __webpack_require__(10)))

/***/ }),
/* 55 */
/***/ (function(module, exports, __webpack_require__) {

var apply = Function.prototype.apply;

// DOM APIs, for completeness

exports.setTimeout = function() {
  return new Timeout(apply.call(setTimeout, window, arguments), clearTimeout);
};
exports.setInterval = function() {
  return new Timeout(apply.call(setInterval, window, arguments), clearInterval);
};
exports.clearTimeout =
exports.clearInterval = function(timeout) {
  if (timeout) {
    timeout.close();
  }
};

function Timeout(id, clearFn) {
  this._id = id;
  this._clearFn = clearFn;
}
Timeout.prototype.unref = Timeout.prototype.ref = function() {};
Timeout.prototype.close = function() {
  this._clearFn.call(window, this._id);
};

// Does not start the time, just sets up the members needed.
exports.enroll = function(item, msecs) {
  clearTimeout(item._idleTimeoutId);
  item._idleTimeout = msecs;
};

exports.unenroll = function(item) {
  clearTimeout(item._idleTimeoutId);
  item._idleTimeout = -1;
};

exports._unrefActive = exports.active = function(item) {
  clearTimeout(item._idleTimeoutId);

  var msecs = item._idleTimeout;
  if (msecs >= 0) {
    item._idleTimeoutId = setTimeout(function onTimeout() {
      if (item._onTimeout)
        item._onTimeout();
    }, msecs);
  }
};

// setimmediate attaches itself to the global object
__webpack_require__(54);
exports.setImmediate = setImmediate;
exports.clearImmediate = clearImmediate;


/***/ })
/******/ ]);